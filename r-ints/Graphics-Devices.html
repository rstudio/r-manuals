<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>6&nbsp; Graphics ¶ – R Manuals :: R Internals ¶</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./GUI-consoles.html" rel="next">
<link href="./Files.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-c829ce05b6823b53f8936fe7d46e29b9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">R Manuals :: R Internals ¶</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-manuals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Manuals</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-manuals">    
        <li>
    <a class="dropdown-item" href="./../r-intro/index.html">
 <span class="dropdown-text">An Introduction to R ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-data/index.html">
 <span class="dropdown-text">R Data Import/Export ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-admin/index.html">
 <span class="dropdown-text">R Installation and Administration ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-exts/index.html">
 <span class="dropdown-text">Writing R Extensions ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-lang/index.html">
 <span class="dropdown-text">R Language Definition ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-ints/index.html">
 <span class="dropdown-text">R Internals ¶</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Graphics-Devices.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Graphics </span></a><a href="#graphics" class="copiable-link">¶</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Top (R Internals)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R-Internal-Structures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R Internal Structures </span></span></a><a href="#r-internal-structures-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./_002eInternal-vs-_002ePrimitive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title"><code class="code">.Internal</code> vs <code class="code">.Primitive</code> </span></span></a><a href="#g_t.internal-vs-.primitive-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Internationalization-in-the-R-sources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Internationalization in the R sources </span></span></a><a href="#internationalization-in-the-r-sources-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Package-Structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Structure of an Installed Package </span></span></a><a href="#structure-of-an-installed-package" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Files </span></span></a><a href="#files-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Graphics-Devices.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Graphics </span></span></a><a href="#graphics" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./GUI-consoles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">GUI consoles </span></span></a><a href="#gui-consoles-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Tools </span></span></a><a href="#tools-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R-coding-standards.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">R coding standards </span></span></a><a href="#r-coding-standards-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Testing-R-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Testing R code </span></span></a><a href="#testing-r-code-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Use-of-TeX-dialects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Use of TeX dialects </span></span></a><a href="#use-of-tex-dialects-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Current-and-future-directions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Current and future directions </span></span></a><a href="#current-and-future-directions-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Function-and-variable-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Function and variable index </span></a><a href="#function-and-variable-index-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Concept-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Concept index </span></a><a href="#concept-index-1" class="copiable-link">¶</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#graphics-devices" id="toc-graphics-devices" class="nav-link active" data-scroll-target="#graphics-devices"><span class="header-section-number">6.1</span> Graphics Devices ¶</a>
  <ul class="collapse">
  <li><a href="#device-structures" id="toc-device-structures" class="nav-link" data-scroll-target="#device-structures"><span class="header-section-number">6.1.1</span> Device structures ¶</a></li>
  <li><a href="#device-capabilities" id="toc-device-capabilities" class="nav-link" data-scroll-target="#device-capabilities"><span class="header-section-number">6.1.2</span> Device capabilities ¶</a></li>
  <li><a href="#handling-text" id="toc-handling-text" class="nav-link" data-scroll-target="#handling-text"><span class="header-section-number">6.1.3</span> Handling text ¶</a></li>
  <li><a href="#conventions" id="toc-conventions" class="nav-link" data-scroll-target="#conventions"><span class="header-section-number">6.1.4</span> Conventions ¶</a></li>
  <li><a href="#mode" id="toc-mode" class="nav-link" data-scroll-target="#mode"><span class="header-section-number">6.1.5</span> ‘Mode’ ¶</a></li>
  <li><a href="#graphics-events" id="toc-graphics-events" class="nav-link" data-scroll-target="#graphics-events"><span class="header-section-number">6.1.6</span> Graphics events ¶</a></li>
  <li><a href="#specific-devices" id="toc-specific-devices" class="nav-link" data-scroll-target="#specific-devices"><span class="header-section-number">6.1.7</span> Specific devices ¶</a></li>
  <li><a href="#x11" id="toc-x11" class="nav-link" data-scroll-target="#x11"><span class="header-section-number">6.1.8</span> X11() ¶</a></li>
  <li><a href="#windows" id="toc-windows" class="nav-link" data-scroll-target="#windows"><span class="header-section-number">6.1.9</span> windows() ¶</a></li>
  </ul></li>
  <li><a href="#colours" id="toc-colours" class="nav-link" data-scroll-target="#colours"><span class="header-section-number">6.2</span> Colours ¶</a></li>
  <li><a href="#base-graphics" id="toc-base-graphics" class="nav-link" data-scroll-target="#base-graphics"><span class="header-section-number">6.3</span> Base graphics ¶</a>
  <ul class="collapse">
  <li><a href="#arguments-and-parameters" id="toc-arguments-and-parameters" class="nav-link" data-scroll-target="#arguments-and-parameters"><span class="header-section-number">6.3.1</span> Arguments and parameters ¶</a></li>
  </ul></li>
  <li><a href="#grid-graphics" id="toc-grid-graphics" class="nav-link" data-scroll-target="#grid-graphics"><span class="header-section-number">6.4</span> Grid graphics ¶</a>
  <ul class="collapse">
  <li><a href="#footnotes" id="toc-footnotes" class="nav-link" data-scroll-target="#footnotes"><span class="header-section-number">6.4.1</span> Footnotes</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Graphics <a href="#graphics" class="copiable-link">¶</a></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Next: <a href="GUI-consoles.html#gui-consoles" accesskey="n" rel="next">GUI consoles</a>, Previous: <a href="Files.html" accesskey="p" rel="prev">Files</a>, Up: <a href="index.html" accesskey="u" rel="up">R Internals</a> &nbsp; [<a href="index.html#sec_contents" rel="contents" title="Table of contents">Contents</a>][<a href="Function-and-variable-index.html" rel="index" title="Index">Index</a>]</p>
<p>R’s graphics internals were re-designed to enable multiple graphics systems to be installed on top on the graphics ‘engine’ – currently there are two such systems, one supporting ‘base’ graphics (based on that in S and whose R code<a href="#FOOT15" id="DOCF15" class="footnote"><sup>15</sup></a> is in package <strong>graphics</strong>) and one implemented in package <strong>grid</strong>.</p>
<p>Some notes on the historical changes can be found at <a href="https://www.stat.auckland.ac.nz/~paul/R/basegraph.html" class="uref">https://www.stat.auckland.ac.nz/~paul/R/basegraph.html</a> and <a href="https://www.stat.auckland.ac.nz/~paul/R/graphicsChanges.html" class="uref">https://www.stat.auckland.ac.nz/~paul/R/graphicsChanges.html</a>.</p>
<p>At the lowest level is a graphics device, which manages a plotting surface (a screen window or a representation to be written to a file). This implements a set of graphics primitives, to ‘draw’</p>
<ul>
<li>a circle, optionally filled</li>
<li>a rectangle, optionally filled</li>
<li>a line</li>
<li>a set of connected lines</li>
<li>a polygon, optionally filled</li>
<li>a paths, optionally filled using a winding rule</li>
<li>text</li>
<li>a raster image (optional)</li>
<li>and to set a clipping rectangle</li>
</ul>
<p>as well as requests for information such as</p>
<ul>
<li>the width of a string if plotted</li>
<li>the metrics (width, ascent, descent) of a single character</li>
<li>the current size of the plotting surface</li>
</ul>
<p>and requests/opportunities to take action such as</p>
<ul>
<li>start a new ‘page’, possibly after responding to a request to ask the user for confirmation.</li>
<li>return the position of the device pointer (if any).</li>
<li>when a device become the current device or stops being the current device (this is usually used to change the window title on a screen device).</li>
<li>when drawing starts or finishes (e.g.&nbsp;used to flush graphics to the screen when drawing stops).</li>
<li>wait for an event, for example a mouse click or keypress.</li>
<li>an ‘onexit’ action, to clean up if plotting is interrupted (by an error or by the user).</li>
<li>capture the current contents of the device as a raster image.</li>
<li>close the device.</li>
</ul>
<p>The device also sets a number of variables, mainly Boolean flags indicating its capabilities. Devices work entirely in ‘device units’ which are up to its developer: they can be in pixels, big points (1/72 inch), twips, …, and can differ<a href="#FOOT16" id="DOCF16" class="footnote"><sup>16</sup></a> in the <samp class="samp">x</samp>’ and <samp class="samp">y</samp>’ directions.</p>
<p>The next layer up is the graphics ‘engine’ that is the main interface to the device (although the graphics subsystems do talk directly to devices). This is responsible for clipping lines, rectangles and polygons, converting the <code class="code">pch</code> values <code class="code">0...26</code> to sets of lines/circles, centring (and otherwise adjusting) text, rendering mathematical expressions (‘plotmath’) and mapping colour descriptions such as names to the internal representation.</p>
<p>Another function of the engine is to manage display lists and snapshots. Some but not all instances of graphics devices maintain display lists, a ‘list’ of operations that have been performed on the device to produce the current plot (since the device was opened or the plot was last cleared, e.g.&nbsp;by <code class="code">plot.new</code>). Screen devices generally maintain a display list to handle repaint and resize events whereas file-based formats do not—display lists are also used to implement <code class="code">dev.copy()</code> and friends. The display list is a pairlist of <code class="code">.Internal</code> (base graphics) or <code class="code">.Call.graphics</code> (grid graphics) calls, which means that the C code implementing a graphics operation will be re-called when the display list is replayed: apart from the part which records the operation if successful.</p>
<p>Snapshots of the current graphics state are taken by <code class="code">GEcreateSnapshot</code> and replayed later in the session by <code class="code">GEplaySnapshot</code>. These are used by <code class="code">recordPlot()</code>, <code class="code">replayPlot()</code> and the GUI menus of the <code class="code">windows()</code> device. The ‘state’ includes the display list.</p>
<p>The top layer comprises the graphics subsystems. Although there is provision for 24 subsystems since about 2001, currently still only two exist, ‘base’ and ‘grid’. The base subsystem is registered with the engine when R is initialized, and unregistered (via <code class="code">KillAllDevices</code>) when an R session is shut down. The grid subsystem is registered in its <code class="code">.onLoad</code> function and unregistered in the <code class="code">.onUnload</code> function. The graphics subsystem may also have ‘state’ information saved in a snapshot (currently base does and grid does not).</p>
<p>Package <strong>grDevices</strong> was originally created to contain the basic graphics devices (although <code class="code">X11</code> is in a separate load-on-demand module because of the volume of external libraries it brings in). Since then it has been used for other functionality that was thought desirable for use with <strong>grid</strong>, and hence has been transferred from package <strong>graphics</strong> to <strong>grDevices</strong>. This is principally concerned with the handling of colours and recording and replaying plots.</p>
<section id="graphics-devices" class="level2 section" data-number="6.1">
<h2 class="section anchored" data-number="6.1" data-anchor-id="graphics-devices"><span class="header-section-number">6.1</span> Graphics Devices <a href="#graphics-devices-1" class="copiable-link">¶</a></h2>
<p>R ships with several graphics devices, and there is support for third-party packages to provide additional devices—several packages now do. This section describes the device internals from the viewpoint of a would-be writer of a graphics device.</p>
<section id="device-structures" class="level3 subsection" data-number="6.1.1">
<h3 class="subsection anchored" data-number="6.1.1" data-anchor-id="device-structures"><span class="header-section-number">6.1.1</span> Device structures <a href="#device-structures-1" class="copiable-link">¶</a></h3>
<p>There are two types used internally which are pointers to structures related to graphics devices.</p>
<p>The <code class="code">DevDesc</code> type is a structure defined in the header file <samp class="file">R_ext/GraphicsDevice.h</samp> (which is included by <samp class="file">R_ext/GraphicsEngine.h</samp>). This describes the physical characteristics of a device, the capabilities of the device driver and contains a set of callback functions that will be used by the graphics engine to obtain information about the device and initiate actions (e.g. a new page, plotting a line or some text). Type <code class="code">pDevDesc</code> is a pointer to this type.</p>
<p>The following callbacks can be omitted (or set to the null pointer, their default value) when appropriate default behaviour will be taken by the graphics engine: <code class="code">activate</code>, <code class="code">cap</code>, <code class="code">deactivate</code>, <code class="code">locator</code>, <code class="code">holdflush</code> (API version 9), <code class="code">mode</code>, <code class="code">newFrameConfirm</code>, <code class="code">path</code>, <code class="code">raster</code> and <code class="code">size</code>.</p>
<p>The relationship of device units to physical dimensions is set by the element <code class="code">ipr</code> of the <code class="code">DevDesc</code> structure: a <samp class="samp">double</samp>’ array of length 2.</p>
<p>The <code class="code">GEDevDesc</code> type is a structure defined in <samp class="file">R_ext/GraphicsEngine.h</samp> (with comments in the file) as</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> _GEDevDesc GEDevDesc<span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> _GEDevDesc <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    pDevDesc dev<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    Rboolean displayListOn<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    SEXP displayList<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    SEXP DLlastElt<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    SEXP savedSnapshot<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    Rboolean dirty<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    Rboolean recordGraphics<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    GESystemDesc <span class="op">*</span>gesd<span class="op">[</span>MAX_GRAPHICS_SYSTEMS<span class="op">];</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    Rboolean ask<span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So this is essentially a device structure plus information about the device maintained by the graphics engine and normally<a href="#FOOT17" id="DOCF17" class="footnote"><sup>17</sup></a> visible to the engine and not to the device. Type <code class="code">pGEDevDesc</code> is a pointer to this type.</p>
<p>The graphics engine maintains an array of devices, as pointers to <code class="code">GEDevDesc</code> structures. The array is of size 64 but the first element is always occupied by the <code class="code">"null device"</code> and the final element is kept as NULL as a sentinel.<a href="#FOOT18" id="DOCF18" class="footnote"><sup>18</sup></a> This array is reflected in the R variable <samp class="samp">.Devices</samp>‘. Once a device is killed its element becomes available for reallocation (and its name will appear as <code class="code">""</code> in <samp class="samp">.Devices</samp>’). Exactly one of the devices is ‘active’: this is the the null device if no other device has been opened and not killed.</p>
<p>Each instance of a graphics device needs to set up a <code class="code">GEDevDesc</code> structure by code very similar to</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>    pGEDevDesc gdd;</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">R_GE_checkVersionOrDie</span>(R_GE_version);</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">R_CheckDeviceAvailable</span>();</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    BEGIN_SUSPEND_INTERRUPTS {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        pDevDesc dev;</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="sc">/</span><span class="er">*</span> Allocate and initialize the device driver data <span class="sc">*</span><span class="er">/</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span>(<span class="at">dev =</span> (pDevDesc) <span class="fu">calloc</span>(<span class="dv">1</span>, <span class="fu">sizeof</span>(DevDesc))))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>            return <span class="dv">0</span>; <span class="sc">/</span><span class="er">*</span> or <span class="fu">error</span>() <span class="sc">*</span><span class="er">/</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="er">/*</span> set up device driver or free <span class="st">'dev'</span> and <span class="fu">error</span>() <span class="sc">*</span><span class="er">/</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        gdd <span class="ot">=</span> <span class="fu">GEcreateDevDesc</span>(dev);</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GEaddDevice2</span>(gdd, <span class="st">"dev_name"</span>);</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    } END_SUSPEND_INTERRUPTS;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code class="code">DevDesc</code> structure contains a <code class="code">void *</code> pointer <samp class="samp">deviceSpecific</samp>’ which is used to store data specific to the device. Setting up the device driver includes initializing all the non-zero elements of the <code class="code">DevDesc</code> structure.</p>
<p>Note that the device structure is zeroed when allocated: this provides some protection against future expansion of the structure since the graphics engine can add elements that need to be non-NULL/non-zero to be ‘on’ (and the structure ends with 64 reserved bytes which will be zeroed and allow for future expansion).</p>
<p>Rather more protection is provided by the version number of the engine/device API, <code class="code">R_GE_version</code> defined in <samp class="file">R_ext/GraphicsEngine.h</samp> together with access functions</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> R_GE_getVersion<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_GE_checkVersionOrDie<span class="op">(</span><span class="dt">int</span> version<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If a graphics device calls <code class="code">R_GE_checkVersionOrDie(R_GE_version)</code> it can ensure it will only be used in versions of R which provide the API it was designed for and compiled against.</p>
<p>The <code class="code">DevDesc</code> structure also contains an <code class="code">int</code> <samp class="samp">deviceVersion</samp>’ to indicate which version of the engine/device API that the device supports. If the device driver sets this correctly, there is no need for a device driver to use <code class="code">R_GE_checkVersionOrDie(R_GE_version)</code> because the graphics engine will not make use of callbacks from an API version above the version that is supported by the device.</p>
</section>
<section id="device-capabilities" class="level3 subsection" data-number="6.1.2">
<h3 class="subsection anchored" data-number="6.1.2" data-anchor-id="device-capabilities"><span class="header-section-number">6.1.2</span> Device capabilities <a href="#device-capabilities-1" class="copiable-link">¶</a></h3>
<p>The following ‘capabilities’ can be defined for the device’s <code class="code">DevDesc</code> structure.</p>
<ul>
<li><code class="code">canChangeGamma</code> – <code class="code">Rboolean</code>: can the display gamma be adjusted? This is now ignored, as gamma support has been removed.</li>
<li><code class="code">canHadj</code> – <code class="code">integer</code>: can the device do horizontal adjustment of text <em>via</em> the <code class="code">text</code> callback, and if so, how precisely? 0 = no adjustment, 1 = {0, 0.5, 1} (left, centre, right justification) or 2 = continuously variable (in [0,1]) between left and right justification.</li>
<li><code class="code">canGenMouseDown</code> – <code class="code">Rboolean</code>: can the device handle mouse down events? This flag and the next three are not currently used by R, but are maintained for back compatibility.</li>
<li><code class="code">canGenMouseMove</code> – <code class="code">Rboolean</code>: ditto for mouse move events.</li>
<li><code class="code">canGenMouseUp</code> – <code class="code">Rboolean</code>: ditto for mouse up events.</li>
<li><code class="code">canGenKeybd</code> – <code class="code">Rboolean</code>: ditto for keyboard events.</li>
<li><code class="code">hasTextUTF8</code> – <code class="code">Rboolean</code>: should non-symbol text be sent (in UTF-8) to the <code class="code">textUTF8</code> and <code class="code">strWidthUTF8</code> callbacks, and sent as Unicode points (negative values) to the <code class="code">metricInfo</code> callback?</li>
<li><code class="code">wantSymbolUTF8</code> – <code class="code">Rboolean</code>: should symbol text be handled in UTF-8 in the same way as other text? Requires <code class="code">textUTF8 = TRUE</code>.</li>
<li><code class="code">haveTransparency</code>: does the device support semi-transparent colours?</li>
<li><code class="code">haveTransparentBg</code>: can the background be fully or semi-transparent?</li>
<li><code class="code">haveRaster</code>: is there support for rendering raster images?</li>
<li><code class="code">haveCapture</code>: is there support for <code class="code">grid::grid.cap</code>?</li>
<li><code class="code">haveLocator</code>: is there an interactive locator?</li>
<li><code class="code">deviceClip</code>: should the engine leave <em>all</em> clipping to the device?</li>
</ul>
<p><code class="code">haveRaster</code>, <code class="code">haveCapture</code>, and <code class="code">haveLocator</code> can often be deduced to be false from the presence of <code class="code">NULL</code> entries instead of the corresponding functions.</p>
<p>In addition, the <code class="code">capabilities</code> callback allows the device driver to provide more detailed information, especially related to callbacks in the engine/device API version 13 or higher.</p>
<p>The <code class="code">capabilities</code> callback is called with a list of integer vectors that represent the best guess that the graphics engine can make, based on the flags in the <code class="code">DevDesc</code> structure and the <samp class="samp">deviceVersion</samp>’. For some capabilities, the integer vector is length 1 with <code class="code">0</code> for no support, <code class="code">1</code> for support, or <code class="code">NA</code> for unknown support. For capabilities where support can be more nuanced, the integer vector may either take higher values or it may have length greater than 1, though length 1 and <code class="code">0</code> still means no support and <code class="code">NA</code> still means unknown support.</p>
<p>The following components of this list are likely to need modifying (for these, the graphics engine can only guess <code class="code">0</code> if <samp class="samp">deviceVersion</samp>’ is too low or <code class="code">NA</code> otherwise):</p>
<ul>
<li>The <code class="code">patterns</code> component reports what sort of pattern fills are supported. If the device supports one or more pattern types, this component should be replaced with an integer vector containing a value for each supported pattern type; the graphics engine provides constants <code class="code">R_GE_linearGradientPattern</code>, <code class="code">R_GE_radialGradientPattern</code>, and <code class="code">R_GE_tilingPattern</code>. If the device does not provide support, this component should be set to 0.</li>
<li>The <code class="code">clippingPaths</code> component reports whether arbitrary clipping paths are supported. If the device supports clipping paths, this component should be set to 1. If the device does not provide support, this component should be set to 0.</li>
<li>The <code class="code">masks</code> component reports what sort of masks are supported. If the device supports one or more mask types, this component should be replaced with an integer vector containing a value for each supported mask type; the graphics engine provides constants <code class="code">R_GE_alphaMask</code> and <code class="code">R_GE_luminanceMask</code>. If the device does not provide support, this component should be set to 0.</li>
<li>The <code class="code">compositing</code> component reports which compositing operators are supported. If the device supports one or more compositing operators, this component should be replaced with an integer vector containing a value for each supported operator; The list of possible operators is long, encompassing Porter-Duff operators and Adobe PDF Blend Modes; the graphics engine provides constants <code class="code">R_GE_compositeClear</code>, etc. If the device does not provide support, this component should be set to 0.</li>
<li>The <code class="code">transformations</code> component reports whether affine transformations are supported. If the device supports transformations, this component should be set to 1. If the device does not provide support, this component should be set to 0.</li>
<li>The <code class="code">paths</code> component reports whether stroking and filling of paths composed of multiple shapes is supported. If the device supports stroking and filling paths, this component should be set to 1. If the device does not provide support, this component should be set to 0.</li>
<li>The <code class="code">glyphs</code> component reports whether rendering glyphs (e.g., via <code class="code">grid::grid.glyph()</code>) is supported. If the device supports rendering glyphs, this component should be set to 1. If the device does not provide support, this component should be set to 0.</li>
</ul>
<p>The graphics engine provides constants like <code class="code">R_GE_capability_patterns</code> for selecting the appropriate component of the list of capabilities.</p>
<p>It is valid (if unhelpful) for the device driver to return the list of capabilities unaltered.</p>
</section>
<section id="handling-text" class="level3 subsection" data-number="6.1.3">
<h3 class="subsection anchored" data-number="6.1.3" data-anchor-id="handling-text"><span class="header-section-number">6.1.3</span> Handling text <a href="#handling-text-1" class="copiable-link">¶</a></h3>
<p>Handling text is probably the hardest task for a graphics device, and the design allows for the device to optionally indicate that it has additional capabilities. (If the device does not, these will if possible be handled in the graphics engine.)</p>
<p>The three callbacks for handling text that must be in all graphics devices are <code class="code">text</code>, <code class="code">strWidth</code> and <code class="code">metricInfo</code> with declarations</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> text<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> y<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>str<span class="op">,</span> <span class="dt">double</span> rot<span class="op">,</span> <span class="dt">double</span> hadj<span class="op">,</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>          pGgcontext gc<span class="op">,</span> pDevDesc dd<span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> strWidth<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>str<span class="op">,</span> pGEcontext gc<span class="op">,</span> pDevDesc dd<span class="op">);</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> metricInfo<span class="op">(</span><span class="dt">int</span> c<span class="op">,</span> pGEcontext gc<span class="op">,</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>               <span class="dt">double</span><span class="op">*</span> ascent<span class="op">,</span> <span class="dt">double</span><span class="op">*</span> descent<span class="op">,</span> <span class="dt">double</span><span class="op">*</span> width<span class="op">,</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>               pDevDesc dd<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <samp class="samp">gc</samp>’ parameter provides the graphics context, most importantly the current font and font size, and <samp class="samp">dd</samp>’ is a pointer to the active device’s structure.</p>
<p>The <code class="code">text</code> callback should plot <samp class="samp">str</samp>’ at <samp class="samp">(x, y)</samp>‘<a href="#FOOT19" id="DOCF19" class="footnote"><sup>19</sup></a> with an anti-clockwise rotation of <samp class="samp">rot</samp>’ degrees. (For <samp class="samp">hadj</samp>’ see below.) The interpretation for horizontal text is that the baseline is at <code class="code">y</code> and the start is a <code class="code">x</code>, so any left bearing for the first character will start at <code class="code">x</code>.</p>
<p>The <code class="code">strWidth</code> callback computes the width of the string which it would occupy if plotted horizontally in the current font. (Width here is expected to include both (preferably) or neither of left and right bearings.)</p>
<p>The <code class="code">metricInfo</code> callback computes the size of a single character: <code class="code">ascent</code> is the distance it extends above the baseline and <code class="code">descent</code> how far it extends below the baseline. <code class="code">width</code> is the amount by which the cursor should be advanced when the character is placed. For <code class="code">ascent</code> and <code class="code">descent</code> this is intended to be the bounding box of the ‘ink’ put down by the glyph and not the box which might be used when assembling a line of conventional text (it needs to be for e.g.&nbsp;<code class="code">hat(beta)</code> to work correctly). However, the <code class="code">width</code> is used in plotmath to advance to the next character, and so needs to include left and right bearings.</p>
<p>The <em>interpretation</em> of <samp class="samp">c</samp>’ depends on the locale. In a single-byte locale values <code class="code">32...255</code> indicate the corresponding character in the locale (if present). For the symbol font (as used by <samp class="samp">graphics::par(font=5)</samp>‘, <samp class="samp">grid::gpar(fontface=5</samp>’) and by ‘plotmath’), values <code class="code">32...126, 161...239, 241...254</code> indicate glyphs in the Adobe Symbol encoding. In a multibyte locale, <code class="code">c</code> represents a Unicode point (except in the symbol font). So the function needs to include code like</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>    Rboolean Unicode <span class="ot">=</span> mbcslocale <span class="sc">&amp;&amp;</span> (gc<span class="ot">-&gt;</span>fontface <span class="sc">!=</span> <span class="dv">5</span>);</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (c <span class="sc">&lt;</span> <span class="dv">0</span>) { Unicode <span class="ot">=</span> <span class="cn">TRUE</span>; c <span class="ot">=</span> <span class="sc">-</span>c; }</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(Unicode) <span class="fu">UniCharMetric</span>(c, ...); <span class="cf">else</span> <span class="fu">CharMetric</span>(c, ...);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In addition, if device capability <code class="code">hasTextUTF8</code> (see below) is true, Unicode points will be passed as negative values: the code snippet above shows how to handle this. (This applies to the symbol font only if device capability <code class="code">wantSymbolUTF8</code> is true.)</p>
<p>If possible, the graphics device should handle clipping of text. It indicates this by the structure element <code class="code">canClip</code> which if true will result in calls to the callback <code class="code">clip</code> to set the clipping region. If this is not done, the engine will clip very crudely (by omitting any text that does not appear to be wholly inside the clipping region).</p>
<p>The device structure has an integer element <code class="code">canHadj</code>, which indicates if the device can do horizontal alignment of text. If this is one, argument <samp class="samp">hadj</samp>’ to <code class="code">text</code> will be called as <code class="code">0 ,0.5, 1</code> to indicate left-, centre- and right-alignment at the indicated position. If it is two, continuous values in the range <code class="code">[0, 1]</code> are assumed to be supported.</p>
<p>Capability <code class="code">hasTextUTF8</code> if true, it has two consequences. First, there are callbacks <code class="code">textUTF8</code> and <code class="code">strWidthUTF8</code> that should behave identically to <code class="code">text</code> and <code class="code">strWidth</code> except that <samp class="samp">str</samp>’ is assumed to be in UTF-8 rather than the current locale’s encoding. The graphics engine will call these for all text except in the symbol font. Second, Unicode points will be passed to the <code class="code">metricInfo</code> callback as negative integers. If your device would prefer to have UTF-8-encoded symbols, define <code class="code">wantSymbolUTF8</code> as well as <code class="code">hasTextUTF8</code>. In that case text in the symbol font is sent to <code class="code">textUTF8</code> and <code class="code">strWidthUTF8</code>.</p>
<p>Some devices can produce high-quality rotated text, but those based on bitmaps often cannot. Those which can should set <code class="code">useRotatedTextInContour</code> to be true from graphics API version 4.</p>
<p>Several other elements relate to the precise placement of text by the graphics engine:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> xCharOffset<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> yCharOffset<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> yLineBias<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> cra<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These are more than a little mysterious. Element <code class="code">cra</code> provides an indication of the character size, <code class="code">par("cra")</code> in base graphics, in device units. The mystery is what is meant by ‘character size’: which character, which font at which size? Some help can be obtained by looking at what this is used for. The first element, ‘width’, is not used by R except to set the graphical parameters. The second, ‘height’, is use to set the line spacing, that is the relationship between <code class="code">par("mar")</code> and <code class="code">par("mai")</code> and so on. It is suggested that a good choice is</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dd<span class="ot">-&gt;</span>cra[<span class="dv">0</span>] <span class="ot">=</span> <span class="fl">0.9</span> <span class="sc">*</span> fnsize;</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>dd<span class="ot">-&gt;</span>cra[<span class="dv">1</span>] <span class="ot">=</span> <span class="fl">1.2</span> <span class="sc">*</span> fnsize;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <samp class="samp">fnsize</samp>’ is the ‘size’ of the standard font (<code class="code">cex=1</code>) on the device, in device units. So for a 12-point font (the usual default for graphics devices), <samp class="samp">fnsize</samp>’ should be 12 points in device units.</p>
<p>The remaining elements are yet more mysterious. The <code class="code">postscript()</code> device says</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Character Addressing Offsets */</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* These offsets should center a single */</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* plotting character over the plotting point. */</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Pure guesswork and eyeballing ... */</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    dd<span class="op">-&gt;</span>xCharOffset <span class="op">=</span>  <span class="fl">0.4900</span><span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    dd<span class="op">-&gt;</span>yCharOffset <span class="op">=</span>  <span class="fl">0.3333</span><span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    dd<span class="op">-&gt;</span>yLineBias <span class="op">=</span> <span class="fl">0.2</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It seems that <code class="code">xCharOffset</code> is not currently used, and <code class="code">yCharOffset</code> is used by the base graphics system to set vertical alignment in <code class="code">text()</code> when <code class="code">pos</code> is specified, and in <code class="code">identify()</code>. It is occasionally used by the graphic engine when attempting exact centring of text, such as character string values of <code class="code">pch</code> in <code class="code">points()</code> or <code class="code">grid.points()</code>—however, it is only used when precise character metric information is not available or for multi-line strings.</p>
<p><code class="code">yLineBias</code> is used in the base graphics system in <code class="code">axis()</code> and <code class="code">mtext()</code> to provide a default for their <samp class="samp">padj</samp>’ argument.</p>
<p>From <code class="code">R_GE_version</code> 16 (<code class="code">R_GE_glyphs</code>), there is also a <code class="code">glyph</code> callback.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> glyph<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>glyphs<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>y<span class="op">,</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>               SEXP font<span class="op">,</span> <span class="dt">double</span> size<span class="op">,</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>               <span class="dt">int</span> colour<span class="op">,</span> <span class="dt">double</span> rot<span class="op">,</span> pDevDesc dd<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This instructs the device to draw a specific glyph within a given font, where the font is specified by filename (and index), with font family, weight, and style also provided as fallbacks.</p>
</section>
<section id="conventions" class="level3 subsection" data-number="6.1.4">
<h3 class="subsection anchored" data-number="6.1.4" data-anchor-id="conventions"><span class="header-section-number">6.1.4</span> Conventions <a href="#conventions-1" class="copiable-link">¶</a></h3>
<p>The aim is to make the (default) output from graphics devices as similar as possible. Generally people follow the model of the <code class="code">postscript</code> and <code class="code">pdf</code> devices (which share most of their internal code).</p>
<p>The following conventions have become established:</p>
<ul>
<li>The default size of a device should be 7 inches square.</li>
<li>There should be a <samp class="samp">pointsize</samp>’ argument which defaults to 12, and it should give the pointsize in big points (1/72 inch). How exactly this is interpreted is font-specific, but it should use a font which works with lines packed 1/6 inch apart, and looks good with lines 1/5 inch apart (that is with 2pt leading).</li>
<li>The default font family should be a sans serif font, e.g Helvetica or similar (e.g.&nbsp;Arial on Windows).</li>
<li><code class="code">lwd = 1</code> should correspond to a line width of 1/96 inch. This will be a problem with pixel-based devices, and generally there is a minimum line width of 1 pixel (although this may not be appropriate where anti-aliasing of lines is used, and <code class="code">cairo</code> prefers a minimum of 2 pixels).</li>
<li>Even very small circles should be visible, e.g.&nbsp;by using a minimum radius of 1 pixel or replacing very small circles by a single filled pixel.</li>
<li>How RGB colour values will be interpreted should be documented, and preferably be sRGB.</li>
<li>The help page should describe its policy on these conventions.</li>
</ul>
<p>These conventions are less clear-cut for bitmap devices, especially where the bitmap format does not have a design resolution.</p>
<p>The interpretation of the line texture (<code class="code">par("lty"</code>) is described in the header <samp class="file">GraphicsEngine.h</samp> and in the help for <code class="code">par</code>: note that the ‘scale’ of the pattern should be proportional to the line width (at least for widths above the default).</p>
</section>
<section id="mode" class="level3 subsection" data-number="6.1.5">
<h3 class="subsection anchored" data-number="6.1.5" data-anchor-id="mode"><span class="header-section-number">6.1.5</span> ‘Mode’ <a href="#g_t_0060mode_0027" class="copiable-link">¶</a></h3>
<p>One of the device callbacks is a function <code class="code">mode</code>, documented in the header as</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>     <span class="sc">*</span> device_Mode is called whenever the graphics engine</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>     <span class="sc">*</span> starts <span class="fu">drawing</span> (<span class="at">mode=</span><span class="dv">1</span>) or stops <span class="fu">drawing</span> (<span class="at">mode=</span><span class="dv">0</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>     <span class="sc">*</span> <span class="fu">GMode</span> (<span class="cf">in</span> graphics.c) also says that</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>     <span class="sc">*</span> mode <span class="ot">=</span> <span class="dv">2</span> (graphical input on) exists.</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>     <span class="sc">*</span> The device is not required to do anything</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since <code class="code">mode = 2</code> has only recently been documented at device level. It could be used to change the graphics cursor, but devices currently do that in the <code class="code">locator</code> callback. (In base graphics the mode is set for the duration of a <code class="code">locator</code> call, but if <code class="code">type != "n"</code> is switched back for each point whilst annotation is being done.)</p>
<p>Many devices do indeed do nothing on this call, but some screen devices ensure that drawing is flushed to the screen when called with <code class="code">mode = 0</code>. It is tempting to use it for some sort of buffering, but note that ‘drawing’ is interpreted at quite a low level and a typical single figure will stop and start drawing many times. The buffering introduced in the <code class="code">X11()</code> device makes use of <code class="code">mode = 0</code> to indicate activity: it updates the screen after <em>ca</em> 100ms of inactivity.</p>
<p>This callback need not be supplied if it does nothing.</p>
</section>
<section id="graphics-events" class="level3 subsection" data-number="6.1.6">
<h3 class="subsection anchored" data-number="6.1.6" data-anchor-id="graphics-events"><span class="header-section-number">6.1.6</span> Graphics events <a href="#graphics-events-1" class="copiable-link">¶</a></h3>
<p>Graphics devices may be designed to handle user interaction: not all are.</p>
<p>Users may use <code class="code">grDevices::setGraphicsEventEnv</code> to set the <code class="code">eventEnv</code> environment in the device driver to hold event handlers. When the user calls <code class="code">grDevices::getGraphicsEvent</code>, R will take three steps. First, it sets the device driver member <code class="code">gettingEvent</code> to <code class="code">true</code> for each device with a non-<code class="code">NULL</code> <code class="code">eventEnv</code> entry, and calls <code class="code">initEvent(dd, true)</code> if the callback is defined. It then enters an event loop. Each time through the loop R will process events once, then check whether any device has set the <code class="code">result</code> member of <code class="code">eventEnv</code> to a non-<code class="code">NULL</code> value, and will save the first such value found to be returned. C functions <code class="code">doMouseEvent</code> and <code class="code">doKeybd</code> are provided to call the R event handlers <code class="code">onMouseDown</code>, <code class="code">onMouseMove</code>, <code class="code">onMouseUp</code>, and <code class="code">onKeybd</code> and set <code class="code">eventEnv$result</code> during this step. Finally, <code class="code">initEvent</code> is called again with <code class="code">init=false</code> to inform the devices that the loop is done, and the result is returned to the user.</p>
</section>
<section id="specific-devices" class="level3 subsection" data-number="6.1.7">
<h3 class="subsection anchored" data-number="6.1.7" data-anchor-id="specific-devices"><span class="header-section-number">6.1.7</span> Specific devices <a href="#specific-devices-1" class="copiable-link">¶</a></h3>
<p>Specific devices are mostly documented by comments in their sources, although for devices of many years’ standing those comments can be in need of updating. This subsection is a repository of notes on design decisions.</p>
</section>
<section id="x11" class="level3 subsubsection" data-number="6.1.8">
<h3 class="subsubsection anchored" data-number="6.1.8" data-anchor-id="x11"><span class="header-section-number">6.1.8</span> X11() <a href="#x11_0028_0029-1" class="copiable-link">¶</a></h3>
<p>The <code class="code">X11(type="Xlib")</code> device dates back to the mid 1990’s and was written then in <code class="code">Xlib</code>, the most basic X11 toolkit. It has since optionally made use of a few features from other toolkits: <code class="code">libXt</code> is used to read X11 resources, and <code class="code">libXmu</code> is used in the handling of clipboard selections.</p>
<p>Using basic <code class="code">Xlib</code> code makes drawing fast, but is limiting. There is no support of translucent colours (that came in the <code class="code">Xrender</code> toolkit of 2000) nor for rotated text (which R implements by rendering text to a bitmap and rotating the latter).</p>
<p>The hinting for the X11 window asks for backing store to be used, and some windows managers may use it to handle repaints, but it seems that most repainting is done by replaying the display list (and here the fast drawing is very helpful).</p>
<p>There are perennial problems with finding fonts. Many users fail to realize that fonts are a function of the X server and not of the machine that R is running on. After many difficulties, R tries first to find the nearest size match in the sizes provided for Adobe fonts in the standard 75dpi and 100dpi X11 font packages—even that will fail to work when users of near-100dpi screens have only the 75dpi set installed. The 75dpi set allows sizes down to 6 points on a 100dpi screen, but some users do try to use smaller sizes and even 6 and 8 point bitmapped fonts do not look good.</p>
<p>Introduction of UTF-8 locales has caused another wave of difficulties. X11 has very few genuine UTF-8 fonts, and produces composite fontsets for the <code class="code">iso10646-1</code> encoding. Unfortunately these seem to have low coverage apart from a few monospaced fonts in a few sizes (which are not suitable for graph annotation), and where glyphs are missing what is plotted is often quite unsatisfactory.</p>
<p>The current approach is to make use of more modern toolkits, namely <code class="code">cairo</code> for rendering and <code class="code">Pango</code> for font management—because these are associated with <code class="code">Gtk+2</code> they are widely available. Cairo supports translucent colours and alpha-blending (<em>via</em> <code class="code">Xrender</code>), and anti-aliasing for the display of lines and text. Pango’s font management is based on <code class="code">fontconfig</code> and somewhat mysterious, but it seems mainly to use Type 1 and TrueType fonts on the machine running R and send grayscale bitmaps to cairo.</p>
</section>
<section id="windows" class="level3 subsubsection" data-number="6.1.9">
<h3 class="subsubsection anchored" data-number="6.1.9" data-anchor-id="windows"><span class="header-section-number">6.1.9</span> windows() <a href="#windows_0028_0029-1" class="copiable-link">¶</a></h3>
<p>The <code class="code">windows()</code> device is a family of devices: it supports plotting to Windows (enhanced) metafiles, BMP, JPEG, PNG and TIFF files as well as to Windows printers.</p>
<p>In most of these cases the primary plotting is to a bitmap: this is used for the (default) buffering of the screen device, which also enables the current plot to be saved to BMP, JPEG, PNG or TIFF (it is the internal bitmap which is copied to the file in the appropriate format).</p>
<p>The device units are pixels (logical ones on a metafile device).</p>
<p>The code was originally written by Guido Masarotto with extensive use of macros, which can make it hard to disentangle.</p>
<p>For a screen device, <code class="code">xd-&gt;gawin</code> is the canvas of the screen, and <code class="code">xd-&gt;bm</code> is the off-screen bitmap. So macro <code class="code">DRAW</code> arranges to plot to <code class="code">xd-&gt;bm</code>, and if buffering is off, also to <code class="code">xd-&gt;gawin</code>. For all other device, <code class="code">xd-&gt;gawin</code> is the canvas, a bitmap for the <code class="code">jpeg()</code> and <code class="code">png()</code> device, and an internal representation of a Windows metafile for the <code class="code">win.metafile()</code> and <code class="code">win.print</code> device. Since ‘plotting’ is done by Windows GDI calls to the appropriate canvas, its precise nature is hidden by the GDI system.</p>
<p>Buffering on the screen device is achieved by running a timer, which when it fires copies the internal bitmap to the screen. This is set to fire every 500ms (by default) and is reset to 100ms after plotting activity.</p>
<p>Repaint events are handled by copying the internal bitmap to the screen canvas (and then reinitializing the timer), unless there has been a resize. Resizes are handled by replaying the display list: this might not be necessary if a fixed canvas with scrollbars is being used, but that is the least popular of the three forms of resizing.</p>
<p>Text on the device has moved to ‘Unicode’ (UCS-2) in recent years. UTF-8 is requested (<code class="code">hasTextUTF8 = TRUE</code>) for standard text, and converted to UCS-2 in the plotting functions in file <samp class="file">src/extra/graphapp/gdraw.c</samp>. However, GDI has no support for Unicode symbol fonts, and symbols are handled in Adobe Symbol encoding.</p>
<p>There is support for translucent colours (with alpha channel between 0 and 255) was introduced on the screen device and bitmap devices.<a href="#FOOT20" id="DOCF20" class="footnote"><sup>20</sup></a> This is done by drawing on a further internal bitmap, <code class="code">xd-&gt;bm2</code>, in the opaque version of the colour then alpha-blending that bitmap to <code class="code">xd-&gt;bm</code>. The alpha-blending routine is in a separate DLL, <samp class="file">msimg32.dll</samp>, which is loaded on first use. As small a rectangular region as reasonably possible is alpha-blended (this is rectangle <code class="code">r</code> in the code), but things like mitre joins make estimation of a tight bounding box too much work for lines and polygonal boundaries. Translucent-coloured lines are not common, and the performance seems acceptable.</p>
<p>The support for a transparent background in <code class="code">png()</code> predates full alpha-channel support in <code class="code">libpng</code> (let alone in PNG viewers), so makes use of the limited transparency support in earlier versions of PNG. Where 24-bit colour is used, this is done by marking a single colour to be rendered as transparent. R chose <samp class="samp">#fdfefd</samp>’, and uses this as the background colour (in <code class="code">GA_NewPage</code> if the specified background colour is transparent (and all non-opaque background colours are treated as transparent). So this works by marking that colour in the PNG file, and viewers without transparency support see a slightly-off-white background, as if there were a near-white canvas. Where a palette is used in the PNG file (if less than 256 colours were used) then this colour is recorded with full transparency and the remaining colours as opaque. If 32-bit colour were available then we could add a full alpha channel, but this is dependent on the graphics hardware and undocumented properties of GDI.</p>
</section>
</section>
<section id="colours" class="level2 section" data-number="6.2">
<h2 class="section anchored" data-number="6.2" data-anchor-id="colours"><span class="header-section-number">6.2</span> Colours <a href="#colours-1" class="copiable-link">¶</a></h2>
<p>Devices receive colours as a <code class="code">typedef</code> <code class="code">rcolor</code> (an <code class="code">unsigned int</code>) defined in the header <samp class="file">R_ext/GraphicsEngine.h</samp>). The 4 bytes are <em>R</em> ,<em>G</em>, <em>B</em> and <em>alpha</em> from least to most significant. So each of RGB has 256 levels of luminosity from 0 to 255. The alpha byte represents opacity, so value 255 is fully opaque and 0 fully transparent: many but not all devices handle semi-transparent colours.</p>
<p>Colors can be created in C via the macro <code class="code">R_RGBA</code>, and a set of macros are defined in <samp class="file">R_ext/GraphicsDevice.h</samp> to extract the various components.</p>
<p>Colours in the base graphics system were originally adopted from S (and before that the GRZ library from Bell Labs), with the concept of a (variable-sized) palette of colours referenced by numbers <samp class="samp">1...</samp><var class="var">N</var>’ plus <samp class="samp">0</samp>’ (the background colour of the current device). R introduced the idea of referring to colours by character strings, either in the forms <samp class="samp">#RRGGBB</samp>’ or <samp class="samp">#RRGGBBAA</samp>’ (representing the bytes in hex) as given by function <code class="code">rgb()</code> or via names: the 657 known names are given in the character vector <code class="code">colors</code> and in a table in file <samp class="file">colors.c</samp> in package <strong>grDevices</strong>. Note that semi-transparent colours are not ‘premultiplied’, so 50% transparent white is <samp class="samp">#ffffff80</samp>’.</p>
<p>Integer or character <code class="code">NA</code> colours are mapped internally to transparent white, as is the character string <code class="code">"NA"</code>.</p>
<p>Negative colour numbers are an error. Colours greater than <var class="var">N</var>’ are wrapped around, so that for example with the default palette of size 8, colour <samp class="samp">10</samp>’ is colour <samp class="samp">2</samp>’ in the palette.</p>
<p>Integer colours have been used more widely than the base graphics sub-system, as they are supported by package <strong>grid</strong> and hence by <a href="https://CRAN.R-project.org/package=lattice" class="url"><strong>lattice</strong></a> and <a href="https://CRAN.R-project.org/package=ggplot2" class="url"><strong>ggplot2</strong></a>. (They are also used by package <a href="https://CRAN.R-project.org/package=rgl" class="url"><strong>rgl</strong></a>.) <strong>grid</strong> did re-define colour <samp class="samp">0</samp>’ to be transparent white, but <a href="https://CRAN.R-project.org/package=rgl" class="url"><strong>rgl</strong></a> used <code class="code">col2rgb</code> and hence the background colour of base graphics.</p>
<p>Note that positive integer colours refer to the current palette and colour <samp class="samp">0</samp>’ to the current device (and a device is opened if needs be). These are mapped to type <code class="code">rcolor</code> at the time of use: this matters when re-playing the display list, e.g.&nbsp;when a device is resized or <code class="code">dev.copy</code> is used. The palette should be thought of as per-session: it is stored in package <strong>grDevices</strong>.</p>
<p>The convention is that devices use the colorspace ‘sRGB’. This is an industry standard: it is used by Web browsers and JPEGs from all but high-end digital cameras. The interpretation is a matter for graphics devices and for code that manipulates colours, but not for the graphics engine or subsystems.</p>
<p>R uses a painting model similar to PostScript and PDF. This means that where shapes (circles, rectangles and polygons) can both be filled and have a stroked border, the fill should be painted first and then the border (or otherwise only half the border will be visible). Where both the fill and the border are semi-transparent there is some room for interpretation of the intention. Most devices first paint the fill and then the border, alpha-blending at each step. However, PDF does some automatic grouping of objects, and <em>when the fill and the border have the same alpha</em>, they are painted onto the same layer and then alpha-blended in one step. (See p.&nbsp;569 of the PDF Reference Sixth Edition, version 1.7. Unfortunately, although this is what the PDF standard says should happen, it is not correctly implemented by some viewers.)</p>
<p>The mapping from colour numbers to type <code class="code">rcolor</code> is primarily done by function <code class="code">RGBpar3</code>: this is exported from the R binary but linked to code in package <strong>grDevices</strong>. The first argument is a <code class="code">SEXP</code> pointing to a character, integer or double vector, and the second is the <code class="code">rcolor</code> value for colour <code class="code">0</code> (or <code class="code">"0"</code>). C entry point <code class="code">RGBpar</code> is a wrapper that takes <code class="code">0</code> to be transparent white: it is often used to set colour defaults for devices. The R-level wrapper is <code class="code">col2rgb</code>.</p>
<p>There is also <code class="code">R_GE_str2col</code> which takes a C string and converts to type <code class="code">rcolor</code>: <code class="code">"0</code> is converted to transparent white.</p>
<p>There is a R-level conversion of colours to <samp class="samp">##RRGGBBAA</samp>’ by <code class="code">image.default(useRaster = TRUE)</code>.</p>
<p>The other color-conversion entry point in the API is <code class="code">name2col</code> which takes a colour name (a C string) and returns a value of type <code class="code">rcolor</code>. This handles <code class="code">"NA"</code>, <code class="code">"transparent"</code> and the 657 colours known to the R function <code class="code">colors()</code>.</p>
</section>
<section id="base-graphics" class="level2 section" data-number="6.3">
<h2 class="section anchored" data-number="6.3" data-anchor-id="base-graphics"><span class="header-section-number">6.3</span> Base graphics <a href="#base-graphics-1" class="copiable-link">¶</a></h2>
<p>The base graphics system was migrated to package <strong>graphics</strong> in R 3.0.0: it was previously implemented in files in <samp class="file">src/main</samp>.</p>
<p>For historical reasons it is largely implemented in two layers. Files <samp class="file">plot.c</samp>, <samp class="file">plot3d.c</samp> and <samp class="file">par.c</samp> contain the code for the around 30 <code class="code">.External</code> calls that implement the basic graphics operations. This code then calls functions with names starting with <code class="code">G</code> and declared in header <samp class="file">Rgraphics.h</samp> in file <samp class="file">graphics.c</samp>, which in turn call the graphics engine (whose functions almost all have names starting with <code class="code">GE</code>).</p>
<p>A large part of the infrastructure of the base graphics subsystem are the graphics parameters (as set/read by <code class="code">par()</code>). These are stored in a <code class="code">GPar</code> structure declared in the private header <samp class="file">Graphics.h</samp>. This structure has two variables (<code class="code">state</code> and <code class="code">valid</code>) tracking the state of the base subsystem on the device, and many variables recording the graphics parameters and functions of them.</p>
<p>The base system state is contained in <code class="code">baseSystemState</code> structure defined in the private header <samp class="file">GraphicsBase.h</samp>. This contains three <code class="code">GPar</code> structures and a Boolean variable used to record if <code class="code">plot.new()</code> (or <code class="code">persp</code>) has been used successfully on the device.</p>
<p>The three copies of the <code class="code">GPar</code> structure are used to store the current parameters (accessed via <code class="code">gpptr</code>), the ‘device copy’ (accessed via <code class="code">dpptr</code>) and space for a saved copy of the ‘device copy’ parameters. The current parameters are, clearly, those currently in use and are copied from the ‘device copy’ whenever <code class="code">plot.new()</code> is called (whether or not that advances to the next ‘page’). The saved copy keeps the state when the device was last completely cleared (e.g.&nbsp;when <code class="code">plot.new()</code> was called with <code class="code">par(new=TRUE)</code>), and is used to replay the display list.</p>
<p>The separation is not completely clean: the ‘device copy’ is altered if a plot with log scale(s) is set up via <code class="code">plot.window()</code>.</p>
<p>There is yet another copy of most of the graphics parameters in <code class="code">static</code> variables in <samp class="file">graphics.c</samp> which are used to preserve the current parameters across the processing of inline parameters in high-level graphics calls (handled by <code class="code">ProcessInlinePars</code>).</p>
<p>Snapshots of the base subsystem record the ‘saved device copy’ of the <code class="code">GPar</code> structure.</p>
<section id="arguments-and-parameters" class="level3 subsection" data-number="6.3.1">
<h3 class="subsection anchored" data-number="6.3.1" data-anchor-id="arguments-and-parameters"><span class="header-section-number">6.3.1</span> Arguments and parameters <a href="#arguments-and-parameters-1" class="copiable-link">¶</a></h3>
<p>There is an unfortunate confusion between some of the graphical parameters (as set by <code class="code">par</code>) and arguments to base graphic functions of the same name. This description may help set the record straight.</p>
<p>Most of the high-level plotting functions accept graphical parameters as additional arguments, which are then often passed to lower-level functions if not already named arguments (which is the main source of confusion).</p>
<p>Graphical parameter <code class="code">bg</code> is the background colour of the plot. Argument <code class="code">bg</code> refers to the fill colour for the filled symbols <code class="code">21</code> to <code class="code">25</code>. It is an argument to the function <code class="code">plot.xy</code>, but normally passed by the default method of <code class="code">points</code>, often from a <code class="code">plot</code> method.</p>
<p>Graphics parameters <code class="code">cex</code>, <code class="code">col</code>, <code class="code">lty</code>, <code class="code">lwd</code> and <code class="code">pch</code> also appear as arguments of <code class="code">plot.xy</code> and so are often passed as arguments from higher-level plot functions such as <code class="code">lines</code>, <code class="code">points</code> and <code class="code">plot</code> methods. They appear as arguments of <code class="code">legend</code>, <code class="code">col</code>, <code class="code">lty</code> and <code class="code">lwd</code> are arguments of <code class="code">arrows</code> and <code class="code">segments</code>. When used as arguments they can be vectors, recycled to control the various lines, points and segments. When set a graphical parameters they set the default rendering: in addition <code class="code">par(cex=)</code> sets the overall character expansion which subsequent calls (as arguments or on-line graphical parameters) multiply.</p>
<p>The handling of missing values differs in the two classes of uses. Generally these are errors when used in <code class="code">par</code> but cause the corresponding element of the plot to be omitted when used as an element of a vector argument. Originally the interpretation of arguments was mainly left to the device, but nowadays some of this is pre-empted in the graphics engine (but for example the handling of <code class="code">lwd = 0</code> remains device-specific, with some interpreting it as a ‘thinnest possible’ line).</p>
</section>
</section>
<section id="grid-graphics" class="level2 section" data-number="6.4">
<h2 class="section anchored" data-number="6.4" data-anchor-id="grid-graphics"><span class="header-section-number">6.4</span> Grid graphics <a href="#grid-graphics-1" class="copiable-link">¶</a></h2>
<p>[At least pointers to documentation.]</p>

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Files.html" class="pagination-link" aria-label="Files [¶](#files-1){.copiable-link}">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Files </span></span></a><a href="#files-1" class="copiable-link">¶</a>
                
  </div>
  <div class="nav-page nav-page-next">
      <a href="./GUI-consoles.html" class="pagination-link" aria-label="GUI consoles [¶](#gui-consoles-1){.copiable-link}">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">GUI consoles </span></span></a><a href="#gui-consoles-1" class="copiable-link">¶</a> <i class="bi bi-arrow-right-short"></i>
      
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>A re-styled version of the original R manuals at <a href="https://cran.r-project.org/manuals.html" class="uri">https://cran.r-project.org/manuals.html</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built using <a href="https://quarto.org">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>