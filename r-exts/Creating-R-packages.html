<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>1&nbsp; Creating R packages ¶ – R Manuals :: Writing R Extensions ¶</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Writing-R-documentation-files.html" rel="next">
<link href="./Acknowledgements.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-c829ce05b6823b53f8936fe7d46e29b9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">R Manuals :: Writing R Extensions ¶</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-manuals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Manuals</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-manuals">    
        <li>
    <a class="dropdown-item" href="./../r-intro/index.html">
 <span class="dropdown-text">An Introduction to R ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-data/index.html">
 <span class="dropdown-text">R Data Import/Export ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-admin/index.html">
 <span class="dropdown-text">R Installation and Administration ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-exts/index.html">
 <span class="dropdown-text">Writing R Extensions ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-lang/index.html">
 <span class="dropdown-text">R Language Definition ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-ints/index.html">
 <span class="dropdown-text">R Internals ¶</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Creating-R-packages.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Creating R packages </span></a><a href="#creating-r-packages-1" class="copiable-link">¶</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Top (Writing R Extensions)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements </span></a><a href="#acknowledgements-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Creating-R-packages.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Creating R packages </span></span></a><a href="#creating-r-packages-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Writing-R-documentation-files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Writing R documentation files </span></span></a><a href="#writing-r-documentation-files-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Tidying-and-profiling-R-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Tidying and profiling R code </span></span></a><a href="#tidying-and-profiling-r-code-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Debugging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Debugging </span></span></a><a href="#debugging-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./System-and-foreign-language-interfaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">System and foreign language interfaces </span></span></a><a href="#system-and-foreign-language-interfaces-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./The-R-API.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The R API: entry points for C code </span></span></a><a href="#the-r-api_003a-entry-points-for-c-code" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Generic-functions-and-methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Generic functions and methods </span></span></a><a href="#generic-functions-and-methods-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Linking-GUIs-and-other-front-ends-to-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Linking GUIs and other front-ends to R </span></span></a><a href="#linking-guis-and-other-front-ends-to-r-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Function-and-variable-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Function and variable index </span></a><a href="#function-and-variable-index-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Concept-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Concept index </span></a><a href="#concept-index-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">API index </span></a><a href="#api-index-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Fortran-API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fortran API index </span></a><a href="#fortran-api-index-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Experimental-API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Experimental API index </span></a><a href="#experimental-api-index-1" class="copiable-link">¶</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Embedding-API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Embedding API index </span></a><a href="#embedding-api-index-1" class="copiable-link">¶</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#package-structure" id="toc-package-structure" class="nav-link active" data-scroll-target="#package-structure"><span class="header-section-number">1.1</span> Package structure ¶</a>
  <ul class="collapse">
  <li><a href="#the-description-file" id="toc-the-description-file" class="nav-link" data-scroll-target="#the-description-file"><span class="header-section-number">1.1.1</span> The <samp class="file">DESCRIPTION</samp> file ¶</a></li>
  <li><a href="#licensing" id="toc-licensing" class="nav-link" data-scroll-target="#licensing"><span class="header-section-number">1.1.2</span> Licensing ¶</a></li>
  <li><a href="#package-dependencies" id="toc-package-dependencies" class="nav-link" data-scroll-target="#package-dependencies"><span class="header-section-number">1.1.3</span> Package Dependencies ¶</a></li>
  <li><a href="#suggested-packages" id="toc-suggested-packages" class="nav-link" data-scroll-target="#suggested-packages"><span class="header-section-number">1.1.4</span> Suggested packages ¶</a></li>
  <li><a href="#the-index-file" id="toc-the-index-file" class="nav-link" data-scroll-target="#the-index-file"><span class="header-section-number">1.1.5</span> The <samp class="file">INDEX</samp> file ¶</a></li>
  <li><a href="#package-subdirectories" id="toc-package-subdirectories" class="nav-link" data-scroll-target="#package-subdirectories"><span class="header-section-number">1.1.6</span> Package subdirectories ¶</a></li>
  <li><a href="#data-in-packages" id="toc-data-in-packages" class="nav-link" data-scroll-target="#data-in-packages"><span class="header-section-number">1.1.7</span> Data in packages ¶</a></li>
  <li><a href="#non-r-scripts-in-packages" id="toc-non-r-scripts-in-packages" class="nav-link" data-scroll-target="#non-r-scripts-in-packages"><span class="header-section-number">1.1.8</span> Non-R scripts in packages ¶</a></li>
  <li><a href="#specifying-urls" id="toc-specifying-urls" class="nav-link" data-scroll-target="#specifying-urls"><span class="header-section-number">1.1.9</span> Specifying URLs ¶</a></li>
  </ul></li>
  <li><a href="#configure-and-cleanup" id="toc-configure-and-cleanup" class="nav-link" data-scroll-target="#configure-and-cleanup"><span class="header-section-number">1.2</span> Configure and cleanup ¶</a>
  <ul class="collapse">
  <li><a href="#using-makevars" id="toc-using-makevars" class="nav-link" data-scroll-target="#using-makevars"><span class="header-section-number">1.2.1</span> Using <samp class="file">Makevars</samp> ¶</a></li>
  <li><a href="#openmp-support" id="toc-openmp-support" class="nav-link" data-scroll-target="#openmp-support"><span class="header-section-number">1.2.2</span> OpenMP support ¶</a></li>
  <li><a href="#using-pthreads" id="toc-using-pthreads" class="nav-link" data-scroll-target="#using-pthreads"><span class="header-section-number">1.2.3</span> Using pthreads ¶</a></li>
  <li><a href="#compiling-in-sub-directories" id="toc-compiling-in-sub-directories" class="nav-link" data-scroll-target="#compiling-in-sub-directories"><span class="header-section-number">1.2.4</span> Compiling in sub-directories ¶</a></li>
  <li><a href="#configure-example" id="toc-configure-example" class="nav-link" data-scroll-target="#configure-example"><span class="header-section-number">1.2.5</span> Configure example ¶</a></li>
  <li><a href="#using-modern-fortran-code" id="toc-using-modern-fortran-code" class="nav-link" data-scroll-target="#using-modern-fortran-code"><span class="header-section-number">1.2.6</span> Using modern Fortran code ¶</a></li>
  <li><a href="#using-c-code" id="toc-using-c-code" class="nav-link" data-scroll-target="#using-c-code"><span class="header-section-number">1.2.7</span> Using C++ code ¶</a></li>
  <li><a href="#c-standards" id="toc-c-standards" class="nav-link" data-scroll-target="#c-standards"><span class="header-section-number">1.2.8</span> C standards ¶</a></li>
  <li><a href="#using-cmake" id="toc-using-cmake" class="nav-link" data-scroll-target="#using-cmake"><span class="header-section-number">1.2.9</span> Using <code class="command">cmake</code> ¶</a></li>
  </ul></li>
  <li><a href="#checking-and-building-packages" id="toc-checking-and-building-packages" class="nav-link" data-scroll-target="#checking-and-building-packages"><span class="header-section-number">1.3</span> Checking and building packages ¶</a>
  <ul class="collapse">
  <li><a href="#checking-packages" id="toc-checking-packages" class="nav-link" data-scroll-target="#checking-packages"><span class="header-section-number">1.3.1</span> Checking packages ¶</a></li>
  <li><a href="#building-package-tarballs" id="toc-building-package-tarballs" class="nav-link" data-scroll-target="#building-package-tarballs"><span class="header-section-number">1.3.2</span> Building package tarballs ¶</a></li>
  <li><a href="#building-binary-packages" id="toc-building-binary-packages" class="nav-link" data-scroll-target="#building-binary-packages"><span class="header-section-number">1.3.3</span> Building binary packages ¶</a></li>
  </ul></li>
  <li><a href="#writing-package-vignettes" id="toc-writing-package-vignettes" class="nav-link" data-scroll-target="#writing-package-vignettes"><span class="header-section-number">1.4</span> Writing package vignettes ¶</a>
  <ul class="collapse">
  <li><a href="#encodings-and-vignettes" id="toc-encodings-and-vignettes" class="nav-link" data-scroll-target="#encodings-and-vignettes"><span class="header-section-number">1.4.1</span> Encodings and vignettes ¶</a></li>
  <li><a href="#non-sweave-vignettes" id="toc-non-sweave-vignettes" class="nav-link" data-scroll-target="#non-sweave-vignettes"><span class="header-section-number">1.4.2</span> Non-Sweave vignettes ¶</a></li>
  </ul></li>
  <li><a href="#package-namespaces" id="toc-package-namespaces" class="nav-link" data-scroll-target="#package-namespaces"><span class="header-section-number">1.5</span> Package namespaces ¶</a>
  <ul class="collapse">
  <li><a href="#specifying-imports-and-exports" id="toc-specifying-imports-and-exports" class="nav-link" data-scroll-target="#specifying-imports-and-exports"><span class="header-section-number">1.5.1</span> Specifying imports and exports ¶</a></li>
  <li><a href="#registering-s3-methods" id="toc-registering-s3-methods" class="nav-link" data-scroll-target="#registering-s3-methods"><span class="header-section-number">1.5.2</span> Registering S3 methods ¶</a></li>
  <li><a href="#load-hooks" id="toc-load-hooks" class="nav-link" data-scroll-target="#load-hooks"><span class="header-section-number">1.5.3</span> Load hooks ¶</a></li>
  <li><a href="#usedynlib" id="toc-usedynlib" class="nav-link" data-scroll-target="#usedynlib"><span class="header-section-number">1.5.4</span> <code class="code">useDynLib</code> ¶</a></li>
  <li><a href="#an-example" id="toc-an-example" class="nav-link" data-scroll-target="#an-example"><span class="header-section-number">1.5.5</span> An example ¶</a></li>
  <li><a href="#namespaces-with-s4-classes-and-methods" id="toc-namespaces-with-s4-classes-and-methods" class="nav-link" data-scroll-target="#namespaces-with-s4-classes-and-methods"><span class="header-section-number">1.5.6</span> Namespaces with S4 classes and methods ¶</a></li>
  </ul></li>
  <li><a href="#writing-portable-packages" id="toc-writing-portable-packages" class="nav-link" data-scroll-target="#writing-portable-packages"><span class="header-section-number">1.6</span> Writing portable packages ¶</a>
  <ul class="collapse">
  <li><a href="#pdf-size" id="toc-pdf-size" class="nav-link" data-scroll-target="#pdf-size"><span class="header-section-number">1.6.1</span> PDF size ¶</a></li>
  <li><a href="#check-timing" id="toc-check-timing" class="nav-link" data-scroll-target="#check-timing"><span class="header-section-number">1.6.2</span> Check timing ¶</a></li>
  <li><a href="#encoding-issues" id="toc-encoding-issues" class="nav-link" data-scroll-target="#encoding-issues"><span class="header-section-number">1.6.3</span> Encoding issues ¶</a></li>
  <li><a href="#portable-c-and-c-code" id="toc-portable-c-and-c-code" class="nav-link" data-scroll-target="#portable-c-and-c-code"><span class="header-section-number">1.6.4</span> Portable C and C++ code ¶</a></li>
  <li><a href="#common-symbols" id="toc-common-symbols" class="nav-link" data-scroll-target="#common-symbols"><span class="header-section-number">1.6.5</span> Common symbols ¶</a></li>
  <li><a href="#c17-issues" id="toc-c17-issues" class="nav-link" data-scroll-target="#c17-issues"><span class="header-section-number">1.6.6</span> C++17 issues ¶</a></li>
  <li><a href="#portable-fortran-code" id="toc-portable-fortran-code" class="nav-link" data-scroll-target="#portable-fortran-code"><span class="header-section-number">1.6.7</span> Portable Fortran code ¶</a></li>
  <li><a href="#binary-distribution" id="toc-binary-distribution" class="nav-link" data-scroll-target="#binary-distribution"><span class="header-section-number">1.6.8</span> Binary distribution ¶</a></li>
  </ul></li>
  <li><a href="#diagnostic-messages" id="toc-diagnostic-messages" class="nav-link" data-scroll-target="#diagnostic-messages"><span class="header-section-number">1.7</span> Diagnostic messages ¶</a></li>
  <li><a href="#internationalization" id="toc-internationalization" class="nav-link" data-scroll-target="#internationalization"><span class="header-section-number">1.8</span> Internationalization ¶</a>
  <ul class="collapse">
  <li><a href="#c-level-messages" id="toc-c-level-messages" class="nav-link" data-scroll-target="#c-level-messages"><span class="header-section-number">1.8.1</span> C-level messages ¶</a></li>
  <li><a href="#r-messages" id="toc-r-messages" class="nav-link" data-scroll-target="#r-messages"><span class="header-section-number">1.8.2</span> R messages ¶</a></li>
  <li><a href="#preparing-translations" id="toc-preparing-translations" class="nav-link" data-scroll-target="#preparing-translations"><span class="header-section-number">1.8.3</span> Preparing translations ¶</a></li>
  </ul></li>
  <li><a href="#citation-files" id="toc-citation-files" class="nav-link" data-scroll-target="#citation-files"><span class="header-section-number">1.9</span> CITATION files ¶</a></li>
  <li><a href="#package-types" id="toc-package-types" class="nav-link" data-scroll-target="#package-types"><span class="header-section-number">1.10</span> Package types ¶</a>
  <ul class="collapse">
  <li><a href="#frontend" id="toc-frontend" class="nav-link" data-scroll-target="#frontend"><span class="header-section-number">1.10.1</span> Frontend ¶</a></li>
  </ul></li>
  <li><a href="#services" id="toc-services" class="nav-link" data-scroll-target="#services"><span class="header-section-number">1.11</span> Services ¶</a>
  <ul class="collapse">
  <li><a href="#footnotes" id="toc-footnotes" class="nav-link" data-scroll-target="#footnotes"><span class="header-section-number">1.11.1</span> Footnotes</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Creating R packages <a href="#creating-r-packages-1" class="copiable-link">¶</a></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Next: <a href="Writing-R-documentation-files.html#writing-r-documentation-files" accesskey="n" rel="next">Writing R documentation files</a>, Previous: <a href="Acknowledgements.html" accesskey="p" rel="prev">Acknowledgements</a>, Up: <a href="index.html" accesskey="u" rel="up">Writing R Extensions</a> &nbsp; [<a href="index.html#sec_contents" rel="contents" title="Table of contents">Contents</a>][<a href="Function-and-variable-index.html" rel="index" title="Index">Index</a>]</p>
<p><span id="index-Packages" class="index-entry-id"></span> <span id="index-Creating-packages" class="index-entry-id"></span></p>
<p>Packages provide a mechanism for loading optional code, data and documentation as needed. The R distribution itself includes about 30 packages.</p>
<p>In the following, we assume that you know the <code class="code">library()</code> command, including its <code class="code">lib.loc</code> argument, and we also assume basic knowledge of the <code class="command">R CMD INSTALL</code> utility. Otherwise, please look at R’s help pages on</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>?library</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>?INSTALL</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>before reading on.</p>
<p>For packages which contain code to be compiled, a computing environment including a number of tools is assumed; the “R Installation and Administration” manual describes what is needed for each OS.</p>
<p>Once a source package is created, it must be installed by the command <code class="code">R CMD INSTALL</code>. See <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Add_002don-packages" data-manual="R-admin">Add-on packages</a> in R Installation and Administration.</p>
<p>Other types of extensions are supported (but rare): See <a href="#package-types" class="xref">Package types</a>.</p>
<p>Some notes on terminology complete this introduction. These will help with the reading of this manual, and also in describing concepts accurately when asking for help.</p>
<p>A <em>package</em> is a directory of files which extend R, a <em>source package</em> (the master files of a package), or a tarball containing the files of a source package, or an <em>installed</em> package, the result of running <code class="command">R CMD INSTALL</code> on a source package. On some platforms (notably macOS and <samp class="samp">x86_64</samp>’ Windows) there are also <em>binary packages</em>, a zip file or tarball containing the files of an installed package which can be unpacked rather than installing from sources.</p>
<p>A package is <strong>not</strong><a href="#FOOT1" id="DOCF1" class="footnote"><sup>1</sup></a> a <em>library</em>. The latter is used in two senses in R documentation.</p>
<ul>
<li>A directory into which packages are installed, e.g. <samp class="file">/usr/lib/R/library</samp>: in that sense it is sometimes referred to as a <em>library directory</em> or <em>library tree</em> (since the library is a directory which contains packages as directories, which themselves contain directories).</li>
<li>That used by the operating system, as a shared, dynamic or static library or (especially on Windows) a DLL, where the second L stands for ‘library’. Installed packages may contain compiled code in what is known on Unix-alikes as a <em>shared object</em> and on Windows as a DLL. The concept of a <em>shared library</em> (<em>dynamic library</em> on macOS) as a collection of compiled code to which a package might link is also used, especially for R itself on some platforms. On most platforms these concepts are interchangeable (shared objects and DLLs can both be loaded into the R process and be linked against), but macOS distinguishes between shared objects (extension <samp class="file">.so</samp>) and dynamic libraries (extension <samp class="file">.dylib</samp>).</li>
</ul>
<p>There are a number of well-defined operations on source packages.</p>
<ul>
<li>The most common is <em>installation</em> which takes a source package and installs it in a library using <code class="command">R CMD INSTALL</code> or <code class="code">install.packages</code>.</li>
<li>Source packages can be <em>built</em>. This involves taking a source directory and creating a tarball ready for distribution, including cleaning it up and creating PDF/HTML documentation from any <em>vignettes</em> it may contain. Source packages (and most often tarballs) can be <em>checked</em>, when a test installation is done and tested (including running its examples); also, the contents of the package are tested in various ways for consistency and portability.</li>
<li><em>Compilation</em> is not a correct term for a package. Installing a source package which contains C, C++ or Fortran code will involve compiling that code. There is also the possibility of ‘byte’ compiling the R code in a package (using the facilities of package <strong>compiler</strong>): nowadays this is enabled by default for all packages. So <em>compiling</em> a package may come to mean byte-compiling its R code.</li>
<li>It used to be unambiguous to talk about <em>loading</em> an installed package using <code class="code">library()</code>, but since the advent of package namespaces this has been less clear: people now often talk about <em>loading</em> the package’s namespace and then <em>attaching</em> the package so it becomes visible on the search path. Function <code class="code">library</code> performs both steps, but a package’s namespace can be loaded without the package being attached (for example by calls like <code class="code">splines::ns</code>).</li>
</ul>
<p>The concept of <em>lazy loading</em> of code or data is mentioned at several points. This is part of the installation, always selected for R code but optional for data. When used the R objects of the package are created at installation time and stored in a database in the <samp class="file">R</samp> directory of the installed package, being loaded into the session at first use. This makes the R session start up faster and use less (virtual) memory. (For technical details, see <a href="https://cran.r-project.org/doc/manuals/R-ints.html#Lazy-loading" data-manual="R-ints">Lazy loading</a> in R Internals.)</p>
<p>CRAN is a network of WWW sites holding the R distributions and contributed code, especially R packages. Users of R are encouraged to join in the collaborative project and to submit their own packages to CRAN: current instructions are linked from <a href="https://CRAN.R-project.org/banner.shtml#submitting" class="uref">https://CRAN.R-project.org/banner.shtml#submitting</a>.</p>
<section id="package-structure" class="level2 section" data-number="1.1">
<h2 class="section anchored" data-number="1.1" data-anchor-id="package-structure"><span class="header-section-number">1.1</span> Package structure <a href="#package-structure-1" class="copiable-link">¶</a></h2>
<p>The sources of an R package consist of a subdirectory containing the files <samp class="file">DESCRIPTION</samp> and <samp class="file">NAMESPACE</samp>, and the subdirectories <samp class="file">R</samp>, <samp class="file">data</samp>, <samp class="file">demo</samp>, <samp class="file">exec</samp>, <samp class="file">inst</samp>, <samp class="file">man</samp>, <samp class="file">po</samp>, <samp class="file">src</samp>, <samp class="file">tests</samp>, <samp class="file">tools</samp> and <samp class="file">vignettes</samp> (some of which can be missing, but which should not be empty). The package subdirectory may also contain files <samp class="file">INDEX</samp>, <samp class="file">configure</samp>, <samp class="file">cleanup</samp>, <samp class="file">LICENSE</samp>, <samp class="file">LICENCE</samp> and <samp class="file">NEWS</samp>. Other files such as <samp class="file">INSTALL</samp> (for non-standard installation instructions), <samp class="file">README</samp>/<samp class="file">README.md</samp><a href="#FOOT2" id="DOCF2" class="footnote"><sup>2</sup></a>, or <samp class="file">ChangeLog</samp> will be ignored by R, but may be useful to end users. The utility <code class="command">R CMD build</code> may add files in a <samp class="file">build</samp> directory (but this should not be used for other purposes).</p>
<p>Except where specifically mentioned,<a href="#FOOT3" id="DOCF3" class="footnote"><sup>3</sup></a> packages should not contain Unix-style ‘hidden’ files/directories (that is, those whose name starts with a dot).</p>
<p>The <samp class="file">DESCRIPTION</samp> and <samp class="file">INDEX</samp> files are described in the subsections below. The <samp class="file">NAMESPACE</samp> file is described in the section on <a href="#package-namespaces" class="ref">Package namespaces</a>.</p>
<p><span id="index-configure-file" class="index-entry-id"></span> <span id="index-cleanup-file" class="index-entry-id"></span></p>
<p>The optional files <samp class="file">configure</samp> and <samp class="file">cleanup</samp> are (Bourne) shell scripts which are, respectively, executed before and (if option <samp class="option">--clean</samp> was given) after installation on Unix-alikes, see <a href="#configure-and-cleanup" class="ref">Configure and cleanup</a>. The analogues on Windows are <samp class="file">configure.win</samp> and <samp class="file">cleanup.win</samp>. Since R 4.2.0 on Windows, <samp class="file">configure.ucrt</samp> and <samp class="file">cleanup.ucrt</samp> are supported and take precedence over <samp class="file">configure.win</samp> and <samp class="file">cleanup.win</samp>. They can hence be used to provide content specific to UCRT or Rtools42 and newer, if needed, but the support for <samp class="file">.ucrt</samp> files may be removed in future when building packages from source on the older versions of R will no longer be needed, and hence the files may be renamed back to <samp class="file">.win</samp>.</p>
<p>For the conventions for files <samp class="file">NEWS</samp> and <samp class="file">ChangeLog</samp> in the GNU project see <a href="https://www.gnu.org/prep/standards/standards.html#Documentation" class="uref">https://www.gnu.org/prep/standards/standards.html#Documentation</a>.</p>
<p>The package subdirectory should be given the same name as the package. Because some file systems (e.g., those on Windows and by default on macOS) are not case-sensitive, to maintain portability it is strongly recommended that case distinctions not be used to distinguish different packages. For example, if you have a package named <samp class="file">foo</samp>, do not also create a package named <samp class="file">Foo</samp>.</p>
<p>To ensure that file names are valid across file systems and supported operating systems, the ASCII control characters as well as the characters <samp class="samp">"</samp>‘, <samp class="samp">*</samp>’, <samp class="samp">:</samp>‘, <samp class="samp">/</samp>’, <samp class="samp">&lt;</samp>‘, <samp class="samp">&gt;</samp>’, <samp class="samp">?</samp>‘, <samp class="samp">\</samp>’, and <samp class="samp">|</samp>’ are not allowed in file names. In addition, files with names <samp class="samp">con</samp>‘, <samp class="samp">prn</samp>’, <samp class="samp">aux</samp>‘, <samp class="samp">clock$</samp>’, <samp class="samp">nul</samp>‘, <samp class="samp">com1</samp>’ to <samp class="samp">com9</samp>‘, and <samp class="samp">lpt1</samp>’ to <samp class="samp">lpt9</samp>’ after conversion to lower case and stripping possible “extensions” (e.g., <samp class="samp">lpt5.foo.bar</samp>‘), are disallowed. Also, file names in the same directory must not differ only by case (see the previous paragraph). In addition, the basenames of <samp class="samp">.Rd</samp>’ files may be used in URLs and so must be ASCII and not contain <code class="code">%</code>. For maximal portability filenames should only contain only ASCII characters not excluded already (that is <code class="code">A-Za-z0-9._!#$%&amp;+,;=@^(){}'[]</code> — we exclude space as many utilities do not accept spaces in file paths): non-English alphabetic characters cannot be guaranteed to be supported in all locales. It would be good practice to avoid the shell metacharacters <code class="code">(){}'[]$~</code>: <code class="code">~</code> is also used as part of ‘8.3’ filenames on Windows. In addition, some applications on Windows can only work with path names of certain length, following an earlier limit in the Windows operating system. Packages are normally distributed as tarballs, and these have a limit on path lengths. So, to be friendly to users who themselves may want to use a relatively long path where they extract the package, and for maximal portability, 100 bytes.</p>
<p>A source package if possible should not contain binary executable files: they are not portable, and a security risk if they are of the appropriate architecture. <code class="command">R CMD check</code> will warn about them<a href="#FOOT4" id="DOCF4" class="footnote"><sup>4</sup></a> unless they are listed (one filepath per line) in a file <samp class="file">BinaryFiles</samp> at the top level of the package. Note that CRAN will not accept submissions containing binary files even if they are listed.</p>
<p>The R function <code class="code">package.skeleton</code> can help to create the structure for a new package: see its help page for details.</p>
<section id="the-description-file" class="level3 subsection" data-number="1.1.1">
<h3 class="subsection anchored" data-number="1.1.1" data-anchor-id="the-description-file"><span class="header-section-number">1.1.1</span> The <samp class="file">DESCRIPTION</samp> file <a href="#the-description-file-1" class="copiable-link">¶</a></h3>
<p>The <samp class="file">DESCRIPTION</samp> file contains basic information about the package in the following format:</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Package<span class="op">:</span> pkgname</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Version<span class="op">:</span> <span class="fl">0.5</span><span class="op">-</span><span class="dv">1</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>Date<span class="op">:</span> <span class="dv">2015</span><span class="op">-</span><span class="bn">01</span><span class="op">-</span><span class="bn">01</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>Title<span class="op">:</span> My First Collection of Functions</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>Authors@R<span class="op">:</span> c<span class="op">(</span>person<span class="op">(</span><span class="st">"Joe"</span><span class="op">,</span> <span class="st">"Developer"</span><span class="op">,</span> role <span class="op">=</span> c<span class="op">(</span><span class="st">"aut"</span><span class="op">,</span> <span class="st">"cre"</span><span class="op">),</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                     email <span class="op">=</span> <span class="st">"Joe.Developer@some.domain.net"</span><span class="op">,</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                     comment <span class="op">=</span> c<span class="op">(</span>ORCID <span class="op">=</span> <span class="st">"nnnn-nnnn-nnnn-nnnn"</span><span class="op">)),</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>              person<span class="op">(</span><span class="st">"Pat"</span><span class="op">,</span> <span class="st">"Developer"</span><span class="op">,</span> role <span class="op">=</span> <span class="st">"aut"</span><span class="op">),</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>              person<span class="op">(</span><span class="st">"A."</span><span class="op">,</span> <span class="st">"User"</span><span class="op">,</span> role <span class="op">=</span> <span class="st">"ctb"</span><span class="op">,</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                     email <span class="op">=</span> <span class="st">"A.User@whereever.net"</span><span class="op">))</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>Author<span class="op">:</span> Joe Developer <span class="op">[</span>aut<span class="op">,</span> cre<span class="op">],</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  Pat Developer <span class="op">[</span>aut<span class="op">],</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  A<span class="op">.</span> User <span class="op">[</span>ctb<span class="op">]</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>Maintainer<span class="op">:</span> Joe Developer <span class="op">&lt;</span>Joe<span class="op">.</span>Developer@some<span class="op">.</span>domain<span class="op">.</span>net<span class="op">&gt;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>Depends<span class="op">:</span> R <span class="op">(&gt;=</span> <span class="fl">3.1</span><span class="er">.0</span><span class="op">),</span> nlme</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>Suggests<span class="op">:</span> MASS</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>Description<span class="op">:</span> A <span class="op">(</span>one paragraph<span class="op">)</span> description of what</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  the package does and why it may be useful<span class="op">.</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>License<span class="op">:</span> GPL <span class="op">(&gt;=</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>URL<span class="op">:</span> https<span class="op">:</span><span class="co">//www.r-project.org, http://www.another.url</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>BugReports<span class="op">:</span> https<span class="op">:</span><span class="co">//pkgname.bugtracker.url</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>The format is that of a version of a ‘Debian Control File’ (see the help for <samp class="samp">read.dcf</samp>’ and <a href="https://www.debian.org/doc/debian-policy/ch-controlfields.html" class="uref">https://www.debian.org/doc/debian-policy/ch-controlfields.html</a>: R does not require encoding in UTF-8 and does not support comments starting with <samp class="samp">#</samp>’). Fields start with an ASCII name immediately followed by a colon: the value starts after the colon and a space. Continuation lines (for example, for descriptions longer than one line) start with a space or tab. Field names are case-sensitive: all those used by R are capitalized.</p>
<p>For maximal portability, the <samp class="file">DESCRIPTION</samp> file should be written entirely in ASCII — if this is not possible it must contain an <samp class="samp">Encoding</samp>’ field (see below).</p>
<p>Several optional fields take <em>logical values</em>: these can be specified as <samp class="samp">yes</samp>‘, <samp class="samp">true</samp>’, <samp class="samp">no</samp>’ or <samp class="samp">false</samp>’: capitalized values are also accepted.</p>
<p>The <samp class="samp">Package</samp>‘, <samp class="samp">Version</samp>’, <samp class="samp">License</samp>‘, <samp class="samp">Description</samp>’, <samp class="samp">Title</samp>‘, <samp class="samp">Author</samp>’, and <samp class="samp">Maintainer</samp>’ fields are mandatory, all other fields are optional. Fields <samp class="samp">Author</samp>’ and <samp class="samp">Maintainer</samp>’ can be auto-generated from <samp class="samp">Authors@R</samp>’, and may be omitted if the latter is provided: however if they are not ASCII we recommend that they are provided.</p>
<p>The mandatory <samp class="samp">Package</samp>’ field gives the name of the package. This should contain only (ASCII) letters, numbers and dot, have at least two characters and start with a letter and not end in a dot. If it needs explaining, this should be done in the <samp class="samp">Description</samp>’ field (and not the <samp class="samp">Title</samp>’ field).</p>
<p>The mandatory <samp class="samp">Version</samp>’ field gives the version of the package. This is a sequence of at least <em>two</em> (and usually three) non-negative integers separated by single <samp class="samp">.</samp>’ or <samp class="samp">-</samp>’ characters. The canonical form is as shown in the example, and a version such as <samp class="samp">0.01</samp>’ or <samp class="samp">0.01.0</samp>’ will be handled as if it were <samp class="samp">0.1-0</samp>’. It is <strong>not</strong> a decimal number, so for example <code class="code">0.9 &lt; 0.75</code> since <code class="code">9 &lt; 75</code>.</p>
<p>The mandatory <samp class="samp">License</samp>’ field is discussed in the next subsection.</p>
<p>The mandatory <samp class="samp">Title</samp>’ field should give a <em>short</em> description of the package. Some package listings may truncate the title to 65 characters. It should use <em>title case</em> (that is, use capitals for the principal words: <code class="code">tools::toTitleCase</code> can help you with this), not use any markup, not have any continuation lines, and not end in a period (unless part of …). Do not repeat the package name: it is often used prefixed by the name. Refer to other packages and external software in single quotes, and to book titles (and similar) in double quotes.</p>
<p>The mandatory <samp class="samp">Description</samp>’ field should give a <em>comprehensive</em> description of what the package does. One can use several (complete) sentences, but only one paragraph. It should be intelligible to all the intended readership (e.g.&nbsp;for a CRAN package to all CRAN users). It is good practice not to start with the package name, ‘This package’ or similar. As with the <samp class="samp">Title</samp>’ field, double quotes should be used for quotations (including titles of books and articles), and single quotes for non-English usage, including names of other packages and external software. This field should also be used for explaining the package name if necessary. URLs should be enclosed in angle brackets, e.g.&nbsp;<samp class="samp">&lt;https://www.r-project.org&gt;</samp>’: see also <a href="#specifying-urls" class="ref">Specifying URLs</a>.</p>
<p>The mandatory <samp class="samp">Author</samp>’ field describes who wrote <em>the package</em>. It is a plain text field intended for human readers, but not for automatic processing (such as extracting the email addresses of all listed contributors: for that use <samp class="samp">Authors@R</samp>’). Note that all significant contributors must be included: if you wrote an R wrapper for the work of others included in the <samp class="file">src</samp> directory, you are not the sole (and maybe not even the main) author.</p>
<p>The mandatory <samp class="samp">Maintainer</samp>’ field should give a <em>single</em> name followed by a <em>valid</em> (RFC 2822) email address in angle brackets. It should not end in a period or comma. This field is what is reported by the <code class="code">maintainer</code> function and used by <code class="code">bug.report</code>. For a CRAN package it should be a <em>person</em>, not a mailing list and not a corporate entity: do ensure that it is valid and will remain valid for the lifetime of the package.</p>
<p>Note that the <em>display name</em> (the part before the address in angle brackets) should be enclosed in double quotes if it contains non-alphanumeric characters such as comma or period. (The current standard, RFC 5322, allows periods but RFC 2822 did not.)</p>
<p>Both <samp class="samp">Author</samp>’ and <samp class="samp">Maintainer</samp>’ fields can be omitted if a suitable <samp class="samp">Authors@R</samp>’ field is given. This field can be used to provide a refined and machine-readable description of the package “authors” (in particular specifying their precise <em>roles</em>), <em>via</em> suitable R code. It should create an object of class <code class="code">"person"</code>, by either a call to <code class="code">person</code> or a series of calls (one per “author”) concatenated by <code class="code">c()</code>: see the example <samp class="file">DESCRIPTION</samp> file above. The roles can include <samp class="samp">"aut"</samp>’ (author) for full authors, <samp class="samp">"cre"</samp>’ (creator) for the package maintainer, and <samp class="samp">"ctb"</samp>’ (contributor) for other contributors, <samp class="samp">"cph"</samp>’ (copyright holder, which should be the legal name for an institution or corporate body), among others. See <code class="code">?person</code> for more information. Note that no role is assumed by default. Auto-generated package citation information takes advantage of this specification. The <samp class="samp">Author</samp>’ and <samp class="samp">Maintainer</samp>’ fields are auto-generated from it if needed when building<a href="#FOOT5" id="DOCF5" class="footnote"><sup>5</sup></a> or installing. Note that for CRAN submissions, providing <samp class="samp">Authors@R</samp>’ is required, and providing ORCID identifiers (see <a href="https://orcid.org/" class="url">https://orcid.org/</a>) where possible is strongly encouraged.</p>
<p>An optional <samp class="samp">Copyright</samp>’ field can be used where the copyright holder(s) are not the authors. If necessary, this can refer to an installed file: the convention is to use file <samp class="file">inst/COPYRIGHTS</samp>.</p>
<p>The optional <samp class="samp">Date</samp>’ field gives the <em>release date</em> of the current version of the package. It is strongly recommended<a href="#FOOT6" id="DOCF6" class="footnote"><sup>6</sup></a> to use the <samp class="samp">yyyy-mm-dd</samp>’ format conforming to the ISO 8601 standard.</p>
<p>The <samp class="samp">Depends</samp>‘, <samp class="samp">Imports</samp>’, <samp class="samp">Suggests</samp>‘, <samp class="samp">Enhances</samp>’, <samp class="samp">LinkingTo</samp>’ and <samp class="samp">Additional_repositories</samp>’ fields are discussed in a later subsection.</p>
<p>Dependencies external to the R system should be listed in the <samp class="samp">SystemRequirements</samp>’ field, possibly amplified in a separate <samp class="file">README</samp> file. This includes specifying a non-default C++ standard and the need for GNU <code class="command">make</code>.</p>
<p>The <samp class="samp">URL</samp>’ field may give a list of URLs separated by commas or whitespace, for example the homepage of the author or a page where additional material describing the software can be found. These URLs are converted to active hyperlinks in CRAN package listings. See <a href="#specifying-urls" class="xref">Specifying URLs</a>.</p>
<p>The <samp class="samp">BugReports</samp>’ field may contain a single URL to which bug reports about the package should be submitted. This URL will be used by <code class="code">bug.report</code> instead of sending an email to the maintainer. A browser is opened for a <samp class="samp">http://</samp>’ or <samp class="samp">https://</samp>’ URL. To specify another email address for bug reports, use <samp class="samp">Contact</samp>’ instead: however <code class="code">bug.report</code> will try to extract an email address (preferably from a <samp class="samp">mailto:</samp>’ URL or enclosed in angle brackets) from <samp class="samp">BugReports</samp>’.</p>
<p>Base and recommended packages (i.e., packages contained in the R source distribution or available from CRAN and recommended to be included in every binary distribution of R) have a <samp class="samp">Priority</samp>’ field with value <samp class="samp">base</samp>’ or <samp class="samp">recommended</samp>’, respectively. These priorities must not be used by other packages.</p>
<p>A <samp class="samp">Collate</samp>’ field can be used for controlling the collation order for the R code files in a package when these are processed for package installation. The default is to collate according to the <samp class="samp">C</samp>’ locale. If present, the collate specification must list <em>all</em> R code files in the package (taking possible OS-specific subdirectories into account, see <a href="#package-subdirectories" class="ref">Package subdirectories</a>) as a whitespace separated list of file paths relative to the <samp class="file">R</samp> subdirectory. Paths containing white space or quotes need to be quoted. An OS-specific collation field (<samp class="samp">Collate.unix</samp>’ or <samp class="samp">Collate.windows</samp>‘) will be used in preference to <samp class="samp">Collate</samp>’.</p>
<p>The <samp class="samp">LazyData</samp>’ logical field controls whether the R datasets use lazy-loading. A <samp class="samp">LazyLoad</samp>’ field was used in versions prior to 2.14.0, but now is ignored.</p>
<p>The <samp class="samp">KeepSource</samp>’ logical field controls if the package code is sourced using <code class="code">keep.source = TRUE</code> or <code class="code">FALSE</code>: it might be needed exceptionally for a package designed to always be used with <code class="code">keep.source = TRUE</code>.</p>
<p>The <samp class="samp">ByteCompile</samp>’ logical field controls if the package R code is to be byte-compiled on installation: the default is to byte-compile. This can be overridden by installing with flag <samp class="option">--no-byte-compile</samp>.</p>
<p>The <samp class="samp">UseLTO</samp>’ logical field is used to indicate if source code in the package<a href="#FOOT7" id="DOCF7" class="footnote"><sup>7</sup></a> is to be compiled with Link-Time Optimization (see <a href="Debugging.html#using-link-time-optimization" class="pxref">Using Link-time Optimization</a>) if R was installed with <samp class="option">--enable-lto</samp> (default true) or <samp class="option">--enable-lto=R</samp> (default false) (or on Windows<a href="#FOOT8" id="DOCF8" class="footnote"><sup>8</sup></a> if <code class="code">LTO_OPT</code> is set in <samp class="file">MkRules</samp>). This can be overridden by the flags <samp class="option">--use-LTO</samp> and <samp class="option">--no-use-LTO</samp>. LTO is said to give most size and performance improvements for large and complex (heavily templated) C++ projects.</p>
<p>The <samp class="samp">StagedInstall</samp>’ logical field controls if package installation is ‘staged’, that is done to a temporary location and moved to the final location when successfully completed. This field was introduced in R 3.6.0 and is true by default: it is considered to be a temporary measure which may be withdrawn in future.</p>
<p>The <samp class="samp">ZipData</samp>’ logical field has been ignored since R 2.13.0.</p>
<p>The <samp class="samp">Biarch</samp>’ logical field is used on Windows to select the <code class="command">INSTALL</code> option <samp class="option">--force-biarch</samp> for this package. Not currently relevant.</p>
<p>The <samp class="samp">BuildVignettes</samp>’ logical field can be set to a false value to stop <code class="command">R CMD build</code> from attempting to build the vignettes, as well as preventing<a href="#FOOT9" id="DOCF9" class="footnote"><sup>9</sup></a> <code class="command">R CMD check</code> from testing this. This should only be used exceptionally, for example if the PDFs include large figures which are not part of the package sources (and hence only in packages which do not have an Open Source license).</p>
<p>The <samp class="samp">VignetteBuilder</samp>’ field names (in a comma-separated list) packages that provide an engine for building vignettes. These may include the current package, or ones listed in <samp class="samp">Depends</samp>‘, <samp class="samp">Suggests</samp>’ or <samp class="samp">Imports</samp>‘. The <strong>utils</strong> package is always implicitly appended. See <a href="#non-sweave-vignettes" class="ref">Non-Sweave vignettes</a> for details. Note that if, for example, a vignette has engine <samp class="samp">knitr::rmarkdown</samp>’, then <a href="https://CRAN.R-project.org/package=knitr" class="url"><strong>knitr</strong></a> provides the engine but both <strong>knitr</strong> and <a href="https://CRAN.R-project.org/package=rmarkdown" class="url"><strong>rmarkdown</strong></a> are needed for using it, so <em>both</em> these packages need to be in the <samp class="samp">VignetteBuilder</samp>’ field and at least suggested (as <strong>rmarkdown</strong> is only suggested by <strong>knitr</strong>, and hence not available automatically along with it). Many packages using <a href="https://CRAN.R-project.org/package=knitr" class="url"><strong>knitr</strong></a> also need the package <a href="https://CRAN.R-project.org/package=formatR" class="url"><strong>formatR</strong></a> which it suggests and so the user package needs to do so too and include this in <samp class="samp">VignetteBuilder</samp>’.</p>
<p>If the <samp class="file">DESCRIPTION</samp> file is not entirely in ASCII it should contain an <samp class="samp">Encoding</samp>’ field specifying an encoding. This is used as the encoding of the <samp class="file">DESCRIPTION</samp> file itself and of the <samp class="file">R</samp> and <samp class="file">NAMESPACE</samp> files, and as the default encoding of <samp class="file">.Rd</samp> files. The examples are assumed to be in this encoding when running <code class="command">R CMD check</code>, and it is used for the encoding of the <code class="code">CITATION</code> file. Only encoding names <code class="code">latin1</code> and and <code class="code">UTF-8</code> are known to be portable. (Do not specify an encoding unless one is actually needed: doing so makes the package <em>less</em> portable. If a package has a specified encoding, you should run <code class="command">R CMD build</code> etc in a locale using that encoding.)</p>
<p>The <samp class="samp">NeedsCompilation</samp>’ field should be set to <code class="code">"yes"</code> if the package contains native code which needs to be compiled, otherwise <code class="code">"no"</code> (when the package could be installed from source on any platform without additional tools). This is used by <code class="code">install.packages(type = "both")</code> in R &gt;= 2.15.2 on platforms where binary packages are the norm: it is normally set by <code class="command">R CMD build</code> or the repository assuming compilation is required if and only if the package has a <samp class="file">src</samp> directory.</p>
<p>The <samp class="samp">OS_type</samp>’ field specifies the OS(es) for which the package is intended. If present, it should be one of <code class="code">unix</code> or <code class="code">windows</code>, and indicates that the package can only be installed on a platform with <samp class="samp">.Platform$OS.type</samp>’ having that value.</p>
<p>The <samp class="samp">Type</samp>’ field specifies the type of the package: see <a href="#package-types" class="pxref">Package types</a>.</p>
<p>One can add subject classifications for the content of the package using the fields <samp class="samp">Classification/ACM</samp>’ or <samp class="samp">Classification/ACM-2012</samp>’ (using the Computing Classification System of the Association for Computing Machinery, <a href="https://www.acm.org/publications/class-2012" class="uref">https://www.acm.org/publications/class-2012</a>; the former refers to the 1998 version), <samp class="samp">Classification/JEL</samp>’ (the Journal of Economic Literature Classification System, <a href="https://www.aeaweb.org/econlit/jelCodes.php" class="uref">https://www.aeaweb.org/econlit/jelCodes.php</a>, or <samp class="samp">Classification/MSC</samp>’ or <samp class="samp">Classification/MSC-2010</samp>’ (the Mathematics Subject Classification of the American Mathematical Society, <a href="https://mathscinet.ams.org/msc/msc2010.html" class="uref">https://mathscinet.ams.org/msc/msc2010.html</a>; the former refers to the 2000 version). The subject classifications should be comma-separated lists of the respective classification codes, e.g., <samp class="samp">Classification/ACM: G.4, H.2.8, I.5.1</samp>’.</p>
<p>A <samp class="samp">Language</samp>’ field can be used to indicate if the package documentation is not in English: this should be a comma-separated list of standard (not private use or grandfathered) IETF language tags as currently defined by RFC 5646 (<a href="https://www.rfc-editor.org/rfc/rfc5646" class="uref">https://www.rfc-editor.org/rfc/rfc5646</a>, see also <a href="https://en.wikipedia.org/wiki/IETF_language_tag" class="uref">https://en.wikipedia.org/wiki/IETF_language_tag</a>), i.e., use language subtags which in essence are 2-letter ISO 639-1 (<a href="https://en.wikipedia.org/wiki/ISO_639-1" class="uref">https://en.wikipedia.org/wiki/ISO_639-1</a>) or 3-letter ISO 639-3 (<a href="https://en.wikipedia.org/wiki/ISO_639-3" class="uref">https://en.wikipedia.org/wiki/ISO_639-3</a>) language codes.</p>
<p>An <samp class="samp">RdMacros</samp>’ field can be used to hold a comma-separated list of packages from which the current package will import <samp class="file">Rd</samp> macro definitions. These package should also be listed in <samp class="samp">Imports</samp>’ (or <samp class="samp">Depends</samp>‘). The macros in these packages will be imported after the system macros, in the order listed in the <samp class="samp">RdMacros</samp>’ field, before any macro definitions in the current package are loaded. Macro definitions in individual <samp class="file">.Rd</samp> files in the <samp class="file">man</samp> directory are loaded last, and are local to later parts of that file. In case of duplicates, the last loaded definition will be used.<a href="#FOOT10" id="DOCF10" class="footnote"><sup>10</sup></a> Both <code class="command">R CMD Rd2pdf</code> and <code class="command">R CMD Rdconv</code> have an optional flag <samp class="option">--RdMacros=pkglist</samp>. The option is also a comma-separated list of package names, and has priority over the value given in <samp class="file">DESCRIPTION</samp>. Packages using <samp class="file">Rd</samp> macros should depend on R 3.2.0 or later.</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> There should be no <samp class="samp">Built</samp>’ or <samp class="samp">Packaged</samp>’ fields, as these are added by the package management tools.</p>
</blockquote>
<p>There is no restriction on the use of other fields not mentioned here (but using other capitalizations of these field names would cause confusion). Fields <code class="code">Note</code>, <code class="code">Contact</code> (for contacting the authors/developers<a href="#FOOT11" id="DOCF11" class="footnote"><sup>11</sup></a>) and <code class="code">MailingList</code> are in common use. Some repositories (including CRAN and R-forge) add their own fields.</p>
</section>
<section id="licensing" class="level3 subsection" data-number="1.1.2">
<h3 class="subsection anchored" data-number="1.1.2" data-anchor-id="licensing"><span class="header-section-number">1.1.2</span> Licensing <a href="#licensing-1" class="copiable-link">¶</a></h3>
<p>Licensing for a package which might be distributed is an important but potentially complex subject.</p>
<p>It is very important that you include license information! Otherwise, it may not even be legally correct for others to distribute copies of the package, let alone use it.</p>
<p>The package management tools use the concept of ‘free or open source software’ (FOSS, e.g., <a href="https://en.wikipedia.org/wiki/FOSS" class="uref">https://en.wikipedia.org/wiki/FOSS</a>) licenses: the idea being that some users of R and its packages want to restrict themselves to such software. Others need to ensure that there are no restrictions stopping them using a package, e.g.&nbsp;forbidding commercial or military use. It is a central tenet of FOSS software that there are no restrictions on users nor usage.</p>
<p>Do not use the <samp class="samp">License</samp>’ field for information on copyright holders: if needed, use a <samp class="samp">Copyright</samp>’ field.</p>
<p>The mandatory <samp class="samp">License</samp>’ field in the <samp class="file">DESCRIPTION</samp> file should specify the license of the package in a standardized form. Alternatives are indicated <em>via</em> vertical bars. Individual specifications must be one of</p>
<ul>
<li><p>One of the “standard” short specifications</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>GPL-2 GPL-3 LGPL-2 LGPL-2.1 LGPL-3 AGPL-3 Artistic-2.0</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>BSD_2_clause BSD_3_clause MIT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>as made available <em>via</em> <a href="https://www.R-project.org/Licenses/" class="uref">https://www.R-project.org/Licenses/</a> and contained in subdirectory <samp class="file">share/licenses</samp> of the R source or home directory.</p></li>
<li><p>The names or abbreviations of other licenses contained in the license data base in file <samp class="file">share/licenses/license.db</samp> in the R source or home directory, possibly (for versioned licenses) followed by a version restriction of the form <samp class="samp">(</samp><var class="var">op</var><samp class="samp"></samp><var class="var">v</var><samp class="samp">)</samp>’ with <var class="var">op</var>’ one of the comparison operators <samp class="samp">&lt;</samp>‘, <samp class="samp">&lt;=</samp>’, <samp class="samp">&gt;</samp>‘, <samp class="samp">&gt;=</samp>’, <samp class="samp">==</samp>‘, or <samp class="samp">!=</samp>’ and <var class="var">v</var>’ a numeric version specification (strings of non-negative integers separated by <samp class="samp">.</samp>‘), possibly combined <em>via</em> <samp class="samp">,</samp>’ (see below for an example). For versioned licenses, one can also specify the name followed by the version, or combine an existing abbreviation and the version with a <samp class="samp">-</samp>’.</p>
<p>Abbreviations <code class="code">GPL</code> and <code class="code">LGPL</code> are ambiguous and usually<a href="#FOOT12" id="DOCF12" class="footnote"><sup>12</sup></a> taken to mean any version of the license: but it is better not to use them.</p></li>
<li><p>One of the strings <samp class="samp">file LICENSE</samp>’ or <samp class="samp">file LICENCE</samp>’ referring to a file named <samp class="file">LICENSE</samp> or <samp class="file">LICENCE</samp> in the package (source and installation) top-level directory.</p></li>
<li><p>The string <samp class="samp">Unlimited</samp>’, meaning that there are no restrictions on distribution or use other than those imposed by relevant laws (including copyright laws).</p></li>
</ul>
<p>Multiple licences can be specified separated by <samp class="samp">|</samp>’ (surrounded by spaces) in which case the user can choose any of the alternatives.</p>
<p>If a package license <em>restricts</em> a base license (where permitted, e.g., using GPL-3 or AGPL-3 with an attribution clause), the additional terms should be placed in file <samp class="file">LICENSE</samp> (or <samp class="file">LICENCE</samp>), and the string <samp class="samp">+ file LICENSE</samp>’ (or <samp class="samp">+ file LICENCE</samp>‘, respectively) should be appended to the corresponding individual license specification (preferably with the <samp class="samp">+</samp>’ surrounded by spaces). Note that several commonly used licenses do not permit restrictions: this includes GPL-2 and hence any specification which includes it.</p>
<p>Examples of standardized specifications include</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>License: GPL-2</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>License: LGPL (&gt;= 2.0, &lt; 3) | Mozilla Public License</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>License: GPL-2 | file LICENCE</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>License: GPL (&gt;= 2) | BSD_3_clause + file LICENSE</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>License: Artistic-2.0 | AGPL-3 + file LICENSE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Please note in particular that “Public domain” is not a valid license, since it is not recognized in some jurisdictions.</p>
<p>Please ensure that the license you choose also covers any dependencies (including system dependencies) of your package: it is particularly important that any restrictions on the use of such dependencies are evident to people reading your <samp class="file">DESCRIPTION</samp> file.</p>
<p>Fields <samp class="samp">License_is_FOSS</samp>’ and <samp class="samp">License_restricts_use</samp>’ may be added by repositories where information cannot be computed from the name of the license. <samp class="samp">License_is_FOSS: yes</samp>’ is used for licenses which are known to be FOSS, and <samp class="samp">License_restricts_use</samp>’ can have values <samp class="samp">yes</samp>’ or <samp class="samp">no</samp>’ if the <samp class="file">LICENSE</samp> file is known to restrict users or usage, or known not to. These are used by, e.g., the <code class="code">available.packages</code> filters.</p>
<p><span id="index-LICENSE-file" class="index-entry-id"></span> <span id="index-LICENCE-file" class="index-entry-id"></span></p>
<p>The optional file <samp class="file">LICENSE</samp>/<samp class="file">LICENCE</samp> contains a copy of the license of the package. To avoid any confusion only include such a file if it is referred to in the <samp class="samp">License</samp>’ field of the <samp class="file">DESCRIPTION</samp> file.</p>
<p>Whereas you should feel free to include a license file in your <em>source</em> distribution, please do not arrange to <em>install</em> yet another copy of the GNU <samp class="file">COPYING</samp> or <samp class="file">COPYING.LIB</samp> files but refer to the copies on <a href="https://www.R-project.org/Licenses/" class="uref">https://www.R-project.org/Licenses/</a> and included in the R distribution (in directory <samp class="file">share/licenses</samp>). Since files named <samp class="file">LICENSE</samp> or <samp class="file">LICENCE</samp> <em>will</em> be installed, do not use these names for standard license files. To include comments about the licensing rather than the body of a license, use a file named something like <samp class="file">LICENSE.note</samp>.</p>
<p>A few “standard” licenses are rather license templates which need additional information to be completed <em>via</em> <samp class="samp">+ file LICENSE</samp>’ (with the <samp class="samp">+</samp>’ surrounded by spaces). Where the additional information is <samp class="samp">COPYRIGHT HOLDER</samp>‘, this must give the actual legal entities (not something vague like ’Name-of-package authors’): if more than one they should be listed in decreasing order of contribution.</p>
</section>
<section id="package-dependencies" class="level3 subsection" data-number="1.1.3">
<h3 class="subsection anchored" data-number="1.1.3" data-anchor-id="package-dependencies"><span class="header-section-number">1.1.3</span> Package Dependencies <a href="#package-dependencies-1" class="copiable-link">¶</a></h3>
<p>The <samp class="samp">Depends</samp>’ field gives a comma-separated list of package names which this package depends on. Those packages will be attached before the current package when <code class="code">library</code> or <code class="code">require</code> is called. Each package name may be optionally followed by a comment in parentheses specifying a version requirement. The comment should contain a comparison operator, whitespace and a valid version number, e.g.&nbsp;<samp class="samp">MASS (&gt;= 3.1-20)</samp>’.</p>
<p>The <samp class="samp">Depends</samp>’ field can also specify a dependence on a certain version of R — e.g., if the package works only with R version 4.0.0 or later, include <samp class="samp">R (&gt;= 4.0)</samp>’ in the <samp class="samp">Depends</samp>’ field. (As here, trailing zeroes can be dropped and it is recommended that they are.) You can also require a certain SVN revision for R-devel or R-patched, e.g. <samp class="samp">R (&gt;= 2.14.0), R (&gt;= r56550)</samp>’ requires a version later than R-devel of late July 2011 (including released versions of 2.14.0).</p>
<p>It makes no sense to declare a dependence on <code class="code">R</code> without a version specification, nor on the package <strong>base</strong>: this is an R package and package <strong>base</strong> is always available.</p>
<p>A package or <samp class="samp">R</samp>’ can appear more than once in the <samp class="samp">Depends</samp>’ field, for example to give upper and lower bounds on acceptable versions.</p>
<p>It is inadvisable to use a dependence on R with patch level (the third digit) other than zero. Doing so with packages which others depend on will cause the other packages to become unusable under earlier versions in the series, and e.g.&nbsp;versions 4.x.1 are widely used throughout the Northern Hemisphere academic year.</p>
<p>Both <code class="code">library</code> and the R package checking facilities use this field: hence it is an error to use improper syntax or misuse the <samp class="samp">Depends</samp>’ field for comments on other software that might be needed. The R <code class="command">INSTALL</code> facilities check if the version of R used is recent enough for the package being installed, and the list of packages which is specified will be attached (after checking version requirements) before the current package.</p>
<p>The <samp class="samp">Imports</samp>’ field lists packages whose namespaces are imported from (as specified in the <samp class="file">NAMESPACE</samp> file) but which do not need to be attached. Namespaces accessed by the <samp class="samp">::</samp>’ and <samp class="samp">:::</samp>’ operators must be listed here, or in <samp class="samp">Suggests</samp>’ or <samp class="samp">Enhances</samp>’ (see below). Ideally this field will include all the standard packages that are used, and it is important to include S4-using packages (as their class definitions can change and the <samp class="file">DESCRIPTION</samp> file is used to decide which packages to re-install when this happens). Packages declared in the <samp class="samp">Depends</samp>’ field should not also be in the <samp class="samp">Imports</samp>’ field. Version requirements can be specified and are checked when the namespace is loaded.</p>
<p>The <samp class="samp">Suggests</samp>’ field uses the same syntax as <samp class="samp">Depends</samp>’ and lists packages that are not necessarily needed. This includes packages used only in examples, tests or vignettes (see <a href="#writing-package-vignettes" class="pxref">Writing package vignettes</a>), and packages loaded in the body of functions. E.g., suppose an example<a href="#FOOT13" id="DOCF13" class="footnote"><sup>13</sup></a> from package <strong>foo</strong> uses a dataset from package <strong>bar</strong>. Then it is not necessary to have <strong>bar</strong> use <strong>foo</strong> unless one wants to execute all the examples/tests/vignettes: it is useful to have <strong>bar</strong>, but not necessary. Version requirements can be specified but should be checked by the code which uses the package.</p>
<p>Finally, the <samp class="samp">Enhances</samp>’ field lists packages “enhanced” by the package at hand, e.g., by providing methods for classes from these packages, or ways to handle objects from these packages (so several packages have <samp class="samp">Enhances: chron</samp>’ because they can handle datetime objects from <a href="https://CRAN.R-project.org/package=chron" class="url"><strong>chron</strong></a> even though they prefer R’s native datetime functions). Version requirements can be specified, but are currently not used. Such packages cannot be required to check the package: any tests which use them must be conditional on the presence of the package. (If your tests use e.g.&nbsp;a dataset from another package it should be in <samp class="samp">Suggests</samp>’ and not <samp class="samp">Enhances</samp>’.)</p>
<p>The general rules are</p>
<ul>
<li>A package should be listed in only one of these fields.</li>
<li>Packages whose namespace only is needed to load the package using <code class="code">library(</code><var class="var">pkgname</var><code class="code">)</code> should be listed in the <samp class="samp">Imports</samp>’ field and not in the <samp class="samp">Depends</samp>’ field. Packages listed in <code class="code">import</code> or <code class="code">importFrom</code> directives in the <samp class="file">NAMESPACE</samp> file should almost always be in <samp class="samp">Imports</samp>’ and not <samp class="samp">Depends</samp>’.</li>
<li>Packages that need to be attached to successfully load the package using <code class="code">library(</code><var class="var">pkgname</var><code class="code">)</code> must be listed in the <samp class="samp">Depends</samp>’ field.</li>
<li>All packages that are needed<a href="#FOOT14" id="DOCF14" class="footnote"><sup>14</sup></a> to successfully run <code class="code">R CMD check</code> on the package must be listed in one of <samp class="samp">Depends</samp>’ or <samp class="samp">Suggests</samp>’ or <samp class="samp">Imports</samp>‘. Packages used to run examples or tests conditionally (e.g.&nbsp;<em>via</em> <code class="code">if(require(</code><var class="var">pkgname</var><code class="code">))</code>) should be listed in <samp class="samp">Suggests</samp>’ or <samp class="samp">Enhances</samp>’. (This allows checkers to ensure that all the packages needed for a complete check are installed.)</li>
<li>Packages needed to use datasets from the package should be in <samp class="samp">Imports</samp>’: this includes those needed to define S4 classes used.</li>
</ul>
<p>In particular, packages providing “only” data for examples or vignettes should be listed in <samp class="samp">Suggests</samp>’ rather than <samp class="samp">Depends</samp>’ in order to make lean installations possible.</p>
<p>Version dependencies in the <samp class="samp">Depends</samp>’ and <samp class="samp">Imports</samp>’ fields are used by <code class="code">library</code> when it loads the package, and <code class="code">install.packages</code> checks versions for the <samp class="samp">Depends</samp>‘, <samp class="samp">Imports</samp>’ and (for <code class="code">dependencies = TRUE</code>) <samp class="samp">Suggests</samp>’ fields.</p>
<p>It is important that the information in these fields is complete and accurate: it is for example used to compute which packages depend on an updated package and which packages can safely be installed in parallel.</p>
<p>This scheme was developed before all packages had namespaces (R 2.14.0 in October 2011), and good practice changed once that was in place.</p>
<p>Field <samp class="samp">Depends</samp>’ should nowadays be used rarely, only for packages which are intended to be put on the search path to make their facilities available to the end user (and not to the package itself): for example it makes sense that a user of package <a href="https://CRAN.R-project.org/package=latticeExtra" class="url"><strong>latticeExtra</strong></a> would want the functions of package <a href="https://CRAN.R-project.org/package=lattice" class="url"><strong>lattice</strong></a> made available.</p>
<p>Almost always packages mentioned in <samp class="samp">Depends</samp>’ should also be imported from in the <samp class="file">NAMESPACE</samp> file: this ensures that any needed parts of those packages are available when some other package imports the current package.</p>
<p>The <samp class="samp">Imports</samp>’ field should not contain packages which are not imported from (<em>via</em> the <samp class="file">NAMESPACE</samp> file or <code class="code">::</code> or <code class="code">:::</code> operators), as all the packages listed in that field need to be installed for the current package to be installed. (This is checked by <code class="command">R CMD check</code>.)</p>
<p>R code in the package should call <code class="code">library</code> or <code class="code">require</code> only exceptionally. Such calls are never needed for packages listed in <samp class="samp">Depends</samp>’ as they will already be on the search path. It used to be common practice to use <code class="code">require</code> calls for packages listed in <samp class="samp">Suggests</samp>’ in functions which used their functionality, but nowadays it is better to access such functionality <em>via</em> <code class="code">::</code> calls.</p>
<p>A package that wishes to make use of header files in other packages to compile its C/C++ code needs to declare them as a comma-separated list in the field <samp class="samp">LinkingTo</samp>’ in the <samp class="file">DESCRIPTION</samp> file. For example</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>LinkingTo: link1, link2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <samp class="samp">LinkingTo</samp>’ field can have a version requirement which is checked at installation.</p>
<p>Specifying a package in <samp class="samp">LinkingTo</samp>’ suffices if these are C/C++ headers containing source code or static linking is done at installation: the packages do not need to be (and usually should not be) listed in the <samp class="samp">Depends</samp>’ or <samp class="samp">Imports</samp>’ fields. This includes CRAN package <a href="https://CRAN.R-project.org/package=BH" class="url"><strong>BH</strong></a> and almost all users of <a href="https://CRAN.R-project.org/package=RcppArmadillo" class="url"><strong>RcppArmadillo</strong></a> and <a href="https://CRAN.R-project.org/package=RcppEigen" class="url"><strong>RcppEigen</strong></a>. Note that <samp class="samp">LinkingTo</samp>’ applies only to installation: if a packages wishes to use headers to compile code in tests or vignettes the package providing them needs to be listed in <samp class="samp">Suggests</samp>’ or perhaps <samp class="samp">Depends</samp>’.</p>
<p>For another use of <samp class="samp">LinkingTo</samp>’ see <a href="System-and-foreign-language-interfaces.html#linking-to-native-routines-in-other-packages" class="ref">Linking to native routines in other packages</a>.</p>
<p>The <samp class="samp">Additional_repositories</samp>’ field is a comma-separated list of repository URLs where the packages named in the other fields may be found. It is currently used by <code class="command">R CMD check</code> to check that the packages can be found, at least as source packages (which can be installed on any platform).</p>
</section>
<section id="suggested-packages" class="level3 subsubsection" data-number="1.1.4">
<h3 class="subsubsection anchored" data-number="1.1.4" data-anchor-id="suggested-packages"><span class="header-section-number">1.1.4</span> Suggested packages <a href="#suggested-packages-1" class="copiable-link">¶</a></h3>
<p>Note that someone wanting to run the examples/tests/vignettes may not have a suggested package available (and it may not even be possible to install it for that platform). The recommendation used to be to make their use conditional <em>via</em> <code class="code">if(require("</code><var class="var">pkgname</var><code class="code">"))</code>: this is OK if that conditioning is done in examples/tests/vignettes, although using <code class="code">if(requireNamespace("</code><var class="var">pkgname</var><code class="code">"))</code> is preferred, if possible.</p>
<p>However, using <code class="code">require</code> for conditioning <em>in package code</em> is not good practice as it alters the search path for the rest of the session and relies on functions in that package not being masked by other <code class="code">require</code> or <code class="code">library</code> calls. It is better practice to use code like</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"rgl"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>      rgl<span class="sc">::</span><span class="fu">plot3d</span>(...)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>   } <span class="cf">else</span> {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>      <span class="do">## do something else not involving rgl.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note the use of <code class="code">rgl::</code> as that object would not necessarily be visible (and if it is, it need not be the one from that namespace: <code class="code">plot3d</code> occurs in several other packages). If the intention is to give an error if the suggested package is not available, simply use e.g.&nbsp;<code class="code">rgl::plot3d</code>.</p>
<p>If the conditional code produces <code class="code">print</code> output, function <code class="code">withAutoprint</code> can be useful.</p>
<p>Note that the recommendation to use suggested packages conditionally in tests does also apply to packages used to manage test suites: a notorious example was <a href="https://CRAN.R-project.org/package=testthat" class="url"><strong>testthat</strong></a> which in version 1.0.0 contained illegal C++ code and hence could not be installed on standards-compliant platforms.</p>
<p>Some people have assumed that a ‘recommended’ package in <samp class="samp">Suggests</samp>’ can safely be used unconditionally, but this is not so. (R can be installed without recommended packages, and which packages are ‘recommended’ may change.)</p>
<p>As noted above, packages in <samp class="samp">Enhances</samp>’ <em>must</em> be used conditionally and hence objects within them should always be accessed <em>via</em> <code class="code">::</code>.</p>
<p>On most systems, <code class="command">R CMD check</code> can be run with only those packages declared in <samp class="samp">Depends</samp>’ and <samp class="samp">Imports</samp>’ by setting environment variable <code class="env">_R_CHECK_DEPENDS_ONLY_=true</code>, whereas setting <code class="env">_R_CHECK_SUGGESTS_ONLY_=true</code> also allows suggested packages, but not those in <samp class="samp">Enhances</samp>’ nor those not mentioned in the <samp class="file">DESCRIPTION</samp> file. It is recommended that a package is checked with each of these set, as well as with neither.</p>
<p><strong>WARNING:</strong> Be extremely careful if you do things which would be run at installation time depending on whether suggested packages are available or not—this includes top-level code in R code files, <code class="code">.onLoad</code> functions and the definitions of S4 classes and methods. The problem is that once a namespace of a suggested package is loaded, references to it may be captured in the installed package (most commonly in S4 methods), but the suggested package may not be available when the installed package is used (which especially for binary packages might be on a different machine). Even worse, the problems might not be confined to your package, for the namespaces of your suggested packages will also be loaded whenever any package which imports yours is installed and so may be captured there.</p>
</section>
<section id="the-index-file" class="level3 subsection" data-number="1.1.5">
<h3 class="subsection anchored" data-number="1.1.5" data-anchor-id="the-index-file"><span class="header-section-number">1.1.5</span> The <samp class="file">INDEX</samp> file <a href="#the-index-file-1" class="copiable-link">¶</a></h3>
<p>The optional file <samp class="file">INDEX</samp> contains a line for each sufficiently interesting object in the package, giving its name and a description (functions such as print methods not usually called explicitly might not be included). Normally this file is missing and the corresponding information is automatically generated from the documentation sources (using <code class="code">tools::Rdindex()</code>) when installing from source.</p>
<p>The file is part of the information given by <code class="code">library(help =</code><var class="var">pkgname</var><code class="code">)</code>.</p>
<p>Rather than editing this file, it is preferable to put customized information about the package into an overview help page (see <a href="Writing-R-documentation-files.html#documenting-packages" class="pxref">Documenting packages</a>) and/or a vignette (see <a href="#writing-package-vignettes" class="pxref">Writing package vignettes</a>).</p>
</section>
<section id="package-subdirectories" class="level3 subsection" data-number="1.1.6">
<h3 class="subsection anchored" data-number="1.1.6" data-anchor-id="package-subdirectories"><span class="header-section-number">1.1.6</span> Package subdirectories <a href="#package-subdirectories-1" class="copiable-link">¶</a></h3>
<p>The <samp class="file">R</samp> subdirectory contains R code files, only. The code files to be installed must start with an ASCII (lower or upper case) letter or digit and have one of the extensions<a href="#FOOT15" id="DOCF15" class="footnote"><sup>15</sup></a> <samp class="file">.R</samp>, <samp class="file">.S</samp>, <samp class="file">.q</samp>, <samp class="file">.r</samp>, or <samp class="file">.s</samp>. We recommend using <samp class="file">.R</samp>, as this extension seems to be not used by any other software. It should be possible to read in the files using <code class="code">source()</code>, so R objects must be created by assignments. Note that there need be no connection between the name of the file and the R objects created by it. Ideally, the R code files should only directly assign R objects and definitely should not call functions with side effects such as <code class="code">require</code> and <code class="code">options</code>. If computations are required to create objects these can use code ‘earlier’ in the package (see the <samp class="samp">Collate</samp>’ field) plus functions in the <samp class="samp">Depends</samp>’ packages provided that the objects created do not depend on those packages except <em>via</em> namespace imports.</p>
<p>Extreme care is needed if top-level computations are made to depend on availability or not of other packages. In particular this applies to <code class="code">setMethods</code> and <code class="code">setClass</code> calls. Nor should they depend on the availability of external resources such as downloads.</p>
<p>Two exceptions are allowed: if the <samp class="file">R</samp> subdirectory contains a file <samp class="file">sysdata.rda</samp> (a saved image of one or more R objects: please use suitable compression as suggested by <code class="code">tools::resaveRdaFiles</code>, and see also the <samp class="samp">SysDataCompression</samp>’ <samp class="file">DESCRIPTION</samp> field.) this will be lazy-loaded into the namespace environment – this is intended for system datasets that are not intended to be user-accessible <em>via</em> <code class="code">data</code>. Also, files ending in <samp class="samp">.in</samp>’ will be allowed in the <samp class="file">R</samp> directory to allow a <samp class="file">configure</samp> script to generate suitable files.</p>
<p>Only ASCII characters (and the control characters tab, form feed, LF and CR) should be used in code files. Other characters are accepted in comments<a href="#FOOT16" id="DOCF16" class="footnote"><sup>16</sup></a>, but then the comments may not be readable in e.g.&nbsp;a UTF-8 locale. Non-ASCII characters in object names will normally<a href="#FOOT17" id="DOCF17" class="footnote"><sup>17</sup></a> fail when the package is installed. Any byte will be allowed in a quoted character string but <samp class="samp">\uxxxx</samp>’ escapes should be used for non-ASCII characters. However, non-ASCII character strings may not be usable in some locales and may display incorrectly in others.</p>
<p>Various R functions in a package can be used to initialize and clean up. See <a href="#load-hooks" class="xref">Load hooks</a>.</p>
<p>The <samp class="file">man</samp> subdirectory should contain (only) documentation files for the objects in the package in <em>R documentation</em> (Rd) format. The documentation filenames must start with an ASCII (lower or upper case) letter or digit and have the extension <samp class="file">.Rd</samp> (the default) or <samp class="file">.rd</samp>. Further, the names must be valid in <samp class="samp">file://</samp>’ URLs, which means<a href="#FOOT18" id="DOCF18" class="footnote"><sup>18</sup></a> they must be entirely ASCII and not contain <samp class="samp">%</samp>’. See <a href="Writing-R-documentation-files.html#writing-r-documentation-files" class="xref">Writing R documentation files</a>, for more information. Note that all user-level objects in a package should be documented; if a package <var class="var">pkg</var> contains user-level objects which are for “internal” use only, it should provide a file <var class="var">pkg</var><samp class="file">-internal.Rd</samp> which documents all such objects, and clearly states that these are not meant to be called by the user. See e.g.&nbsp;the sources for package <strong>grid</strong> in the R distribution. Note that packages which use internal objects extensively should not export those objects from their namespace, when they do not need to be documented (see <a href="#package-namespaces" class="pxref">Package namespaces</a>).</p>
<p>Having a <samp class="file">man</samp> directory containing no documentation files may give an installation error.</p>
<p>The <samp class="file">man</samp> subdirectory may contain a subdirectory named <samp class="file">macros</samp>; this will contain source for user-defined Rd macros. (See <a href="Writing-R-documentation-files.html#user-defined-macros" class="ref">User-defined macros</a>.) These use the Rd format, but may not contain anything but macro definitions, comments and whitespace.</p>
<p>The <samp class="file">R</samp> and <samp class="file">man</samp> subdirectories may contain OS-specific subdirectories named <samp class="file">unix</samp> or <samp class="file">windows</samp>.</p>
<p>The sources and headers for the compiled code are in <samp class="file">src</samp>, plus optionally a file <samp class="file">Makevars</samp> or <samp class="file">Makefile</samp> (or for use on Windows, with extension <samp class="file">.win</samp> or <samp class="file">.ucrt</samp>). When a package is installed using <code class="code">R CMD INSTALL</code>, <code class="command">make</code> is used to control compilation and linking into a shared object for loading into R. There are default <code class="command">make</code> variables and rules for this (determined when R is configured and recorded in <var class="var">R_HOME</var><samp class="file">/etc</samp><var class="var">R_ARCH</var><samp class="file">/Makeconf</samp>), providing support for C, C++, fixed- or free-form Fortran, Objective C and Objective C++<a href="#FOOT19" id="DOCF19" class="footnote"><sup>19</sup></a> with associated extensions <samp class="file">.c</samp>, <samp class="file">.cc</samp> or <samp class="file">.cpp</samp>, <samp class="file">.f</samp>, <samp class="file">.f90</samp> or <samp class="file">.f95</samp>,<a href="#FOOT20" id="DOCF20" class="footnote"><sup>20</sup></a> <samp class="file">.m</samp>, and <samp class="file">.mm</samp>, respectively. We recommend using <samp class="file">.h</samp> for headers, also for C++<a href="#FOOT21" id="DOCF21" class="footnote"><sup>21</sup></a> or Fortran include files. (Use of extension <samp class="file">.C</samp> for C++ is no longer supported.) Files in the <samp class="file">src</samp> directory should not be hidden (start with a dot), and hidden files will under some versions of R be ignored.</p>
<p>It is not portable (and may not be possible at all) to mix all these languages in a single package. Because R itself uses it, we know that C and fixed-form Fortran can be used together, and mixing C, C++ and Fortran usually work for the platform’s native compilers.</p>
<p>If your code needs to depend on the platform there are certain defines which can be used in C or C++. On all Windows builds (even 64-bit ones) <samp class="samp">_WIN32</samp>’ will be defined: on 64-bit Windows builds also <samp class="samp">_WIN64</samp>‘. For Windows on ARM, test for <samp class="samp">_M_ARM64</samp>’ or both <samp class="samp">_WIN32</samp>’ and <samp class="samp">__aarch64__</samp>‘. On macOS <samp class="samp">__APPLE__</samp>’ is defined<a href="#FOOT22" id="DOCF22" class="footnote"><sup>22</sup></a>; for an ‘Apple Silicon’ platform, test for both <samp class="samp">__APPLE__</samp>’ and <samp class="samp">__arm64__</samp>’.</p>
<p>The default rules can be tweaked by setting macros<a href="#FOOT23" id="DOCF23" class="footnote"><sup>23</sup></a> in a file <samp class="file">src/Makevars</samp> (see <a href="#using-makevars" class="pxref">Using <samp class="file">Makevars</samp></a>). Note that this mechanism should be general enough to eliminate the need for a package-specific <samp class="file">src/Makefile</samp>. If such a file is to be distributed, considerable care is needed to make it general enough to work on all R platforms. If it has any targets at all, it should have an appropriate first target named <samp class="samp">all</samp>’ and a (possibly empty) target <samp class="samp">clean</samp>’ which removes all files generated by running <code class="command">make</code> (to be used by <samp class="samp">R CMD INSTALL --clean</samp>’ and <samp class="samp">R CMD INSTALL --preclean</samp>’). There are platform-specific file names on Windows: <samp class="file">src/Makevars.win</samp> takes precedence over <samp class="file">src/Makevars</samp> and <samp class="file">src/Makefile.win</samp> must be used. Since R 4.2.0, <samp class="file">src/Makevars.ucrt</samp> takes precedence over <samp class="file">src/Makevars.win</samp> and <samp class="file">src/Makefile.ucrt</samp> takes precedence over <samp class="file">src/Makefile.win</samp>. <samp class="file">src/Makevars.ucrt</samp> and <samp class="file">src/Makefile.ucrt</samp> will be ignored by earlier versions of R, and hence can be used to provide content specific to UCRT or Rtools42 and newer, but the support for <samp class="file">.ucrt</samp> files may be removed in the future when building packages from source on the older versions of R will no longer be needed, and hence the files may be renamed back to <samp class="file">.win</samp>. Some <code class="command">make</code> programs require makefiles to have a complete final line, including a newline.</p>
<p>A few packages use the <samp class="file">src</samp> directory for purposes other than making a shared object (e.g.&nbsp;to create executables). Such packages should have files <samp class="file">src/Makefile</samp> and <samp class="file">src/Makefile.win</samp> or <samp class="file">src/Makefile.ucrt</samp> (unless intended for only Unix-alikes or only Windows). Note that on Unix such makefiles are included after <var class="var">R_HOME</var><samp class="file">/etc/</samp><var class="var">R_ARCH</var><samp class="file">/Makeconf</samp> so all the usual R macros and make rules are available – for example C compilation will by default use the C compiler and flags with which R was configured. This also applies on Windows as from R 4.3.0: packages intended to be used with earlier versions should include that file themselves.</p>
<p>The order of inclusion of makefiles for a package which does <strong>not</strong> have a <samp class="file">src/Makefile</samp> file is</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Unix-alike</th>
<th style="text-align: left;">Windows</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><samp class="file">src/Makevars</samp></td>
<td style="text-align: left;"><samp class="file">src/Makevars.ucrt</samp>, <samp class="file">src/Makevars.win</samp></td>
</tr>
<tr class="even">
<td style="text-align: left;"><var class="var">R_HOME</var><samp class="file">/etc/</samp><var class="var">R_ARCH</var><samp class="file">/Makeconf</samp></td>
<td style="text-align: left;"><var class="var">R_HOME</var><samp class="file">/etc/</samp><var class="var">R_ARCH</var><samp class="file">/Makeconf</samp></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="env">R_MAKEVARS_SITE</code>, <var class="var">R_HOME</var><samp class="file">/etc/</samp><var class="var">R_ARCH</var><samp class="file">/Makevars.site</samp></td>
<td style="text-align: left;"><code class="env">R_MAKEVARS_SITE</code>, <var class="var">R_HOME</var><samp class="file">/etc/</samp><var class="var">R_ARCH</var><samp class="file">/Makevars.site</samp></td>
</tr>
<tr class="even">
<td style="text-align: left;"><var class="var">R_HOME</var><samp class="file">/share/make/shlib.mk</samp></td>
<td style="text-align: left;"><var class="var">R_HOME</var><samp class="file">/share/make/winshlib.mk</samp></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="env">R_MAKEVARS_USER</code>, <samp class="file">~/.R/Makevars-</samp><var class="var">platform</var>, <samp class="file">~/.R/Makevars</samp></td>
<td style="text-align: left;"><code class="env">R_MAKEVARS_USER</code>, <samp class="file">~/.R/Makevars.ucrt</samp>, <samp class="file">~/.R/Makevars.win64</samp>, <samp class="file">~/.R/Makevars.win</samp></td>
</tr>
</tbody>
</table>
<p>For those which do, it is</p>
<table class="caption-top table">
<tbody>
<tr class="odd">
<td style="text-align: left;"><var class="var">R_HOME</var><samp class="file">/etc/</samp><var class="var">R_ARCH</var><samp class="file">/Makeconf</samp></td>
<td style="text-align: left;"><var class="var">R_HOME</var><samp class="file">/etc/</samp><var class="var">R_ARCH</var><samp class="file">/Makeconf</samp></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="env">R_MAKEVARS_SITE</code>, <var class="var">R_HOME</var><samp class="file">/etc/</samp><var class="var">R_ARCH</var><samp class="file">/Makevars.site</samp></td>
<td style="text-align: left;"><code class="env">R_MAKEVARS_SITE</code>, <var class="var">R_HOME</var><samp class="file">/etc/</samp><var class="var">R_ARCH</var><samp class="file">/Makevars.site</samp></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">src/Makefile</samp></td>
<td style="text-align: left;"><samp class="file">src/Makefile.ucrt</samp>, <samp class="file">src/Makefile.win</samp></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="env">R_MAKEVARS_USER</code>, <samp class="file">~/.R/Makevars-</samp><var class="var">platform</var>, <samp class="file">~/.R/Makevars</samp></td>
<td style="text-align: left;"><code class="env">R_MAKEVARS_USER</code>, <samp class="file">~/.R/Makevars.ucrt</samp>, <samp class="file">~/.R/Makevars.win64</samp>, <samp class="file">~/.R/Makevars.win</samp></td>
</tr>
</tbody>
</table>
<p>Items in capitals are environment variables: those separated by commas are alternatives looked for in the order shown.</p>
<p>In very special cases packages may create binary files other than the shared objects/DLLs in the <samp class="file">src</samp> directory. Such files will not be installed in a multi-architecture setting since <code class="code">R CMD INSTALL --libs-only</code> is used to merge multiple sub-architectures and it only copies shared objects/DLLs. If a package wants to install other binaries (for example executable programs), it should provide an R script <samp class="file">src/install.libs.R</samp> which will be run as part of the installation in the <code class="code">src</code> build directory <em>instead of</em> copying the shared objects/DLLs. The script is run in a separate R environment containing the following variables: <code class="code">R_PACKAGE_NAME</code> (the name of the package), <code class="code">R_PACKAGE_SOURCE</code> (the path to the source directory of the package), <code class="code">R_PACKAGE_DIR</code> (the path of the target installation directory of the package), <code class="code">R_ARCH</code> (the arch-dependent part of the path, often empty), <code class="code">SHLIB_EXT</code> (the extension of shared objects) and <code class="code">WINDOWS</code> (<code class="code">TRUE</code> on Windows, <code class="code">FALSE</code> elsewhere). Something close to the default behavior could be replicated with the following <samp class="file">src/install.libs.R</samp> file:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">Sys.glob</span>(<span class="fu">paste0</span>(<span class="st">"*"</span>, SHLIB_EXT))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>dest <span class="ot">&lt;-</span> <span class="fu">file.path</span>(R_PACKAGE_DIR, <span class="fu">paste0</span>(<span class="st">'libs'</span>, R_ARCH))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(dest, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">file.copy</span>(files, dest, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(<span class="st">"symbols.rds"</span>))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(<span class="st">"symbols.rds"</span>, dest, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On the other hand, executable programs could be installed along the lines of</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>execs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"one"</span>, <span class="st">"two"</span>, <span class="st">"three"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(WINDOWS) execs <span class="ot">&lt;-</span> <span class="fu">paste0</span>(execs, <span class="st">".exe"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ( <span class="fu">any</span>(<span class="fu">file.exists</span>(execs)) ) {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  dest <span class="ot">&lt;-</span> <span class="fu">file.path</span>(R_PACKAGE_DIR,  <span class="fu">paste0</span>(<span class="st">'bin'</span>, R_ARCH))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(dest, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.copy</span>(execs, dest, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note the use of architecture-specific subdirectories of <samp class="file">bin</samp> where needed. (Executables should installed under a <samp class="file">bin</samp> directory and not under <samp class="file">libs</samp>. It is good practice to check that they can be executed as part of the installation script, so a broken package is not installed.)</p>
<p>The <samp class="file">data</samp> subdirectory is for data files: See <a href="#data-in-packages" class="xref">Data in packages</a>.</p>
<p>The <samp class="file">demo</samp> subdirectory is for R scripts (for running <em>via</em> <code class="code">demo()</code>) that demonstrate some of the functionality of the package. Demos may be interactive and are not checked automatically, so if testing is desired use code in the <samp class="file">tests</samp> directory to achieve this. The script files must start with a (lower or upper case) letter and have one of the extensions <samp class="file">.R</samp> or <samp class="file">.r</samp>. If present, the <samp class="file">demo</samp> subdirectory should also have a <samp class="file">00Index</samp> file with one line for each demo, giving its name and a description separated by a tab or at least three spaces. (This index file is not generated automatically.) Note that a demo does not have a specified encoding and so should be an ASCII file (see <a href="#encoding-issues" class="pxref">Encoding issues</a>). Function <code class="code">demo()</code> will use the package encoding if there is one, but this is mainly useful for non-ASCII comments.</p>
<p>The contents of the <samp class="file">inst</samp> subdirectory will be copied recursively to the installation directory. Subdirectories of <samp class="file">inst</samp> should not interfere with those used by R (currently, <samp class="file">R</samp>, <samp class="file">data</samp>, <samp class="file">demo</samp>, <samp class="file">exec</samp>, <samp class="file">libs</samp>, <samp class="file">man</samp>, <samp class="file">help</samp>, <samp class="file">html</samp> and <samp class="file">Meta</samp>, and earlier versions used <samp class="file">latex</samp>, <samp class="file">R-ex</samp>). The copying of the <samp class="file">inst</samp> happens after <samp class="file">src</samp> is built so its <samp class="file">Makefile</samp> can create files to be installed. To exclude files from being installed, one can specify a list of exclude patterns in file <samp class="file">.Rinstignore</samp> in the top-level source directory. These patterns should be Perl-like regular expressions (see the help for <code class="code">regexp</code> in R for the precise details), one per line, to be matched case-insensitively against the file and directory paths, e.g.&nbsp;<samp class="file">doc/.*[.]png$</samp> will exclude all PNG files in <samp class="file">inst/doc</samp> based on the extension.</p>
<p>Note that with the exceptions of <samp class="file">INDEX</samp>, <samp class="file">LICENSE</samp>/<samp class="file">LICENCE</samp> and <samp class="file">NEWS</samp>, information files at the top level of the package will <em>not</em> be installed and so not be known to users of Windows and macOS compiled packages (and not seen by those who use <code class="command">R CMD INSTALL</code> or <code class="code">install.packages()</code> on the tarball). So any information files you wish an end user to see should be included in <samp class="file">inst</samp>. Note that if the named exceptions also occur in <samp class="file">inst</samp>, the version in <samp class="file">inst</samp> will be that seen in the installed package.</p>
<p><span id="index-CITATION-file" class="index-entry-id"></span> <span id="index-citation" class="index-entry-id"></span> <span id="index-NEWS_002eRd-file" class="index-entry-id"></span></p>
<p>Things you might like to add to <samp class="file">inst</samp> are a <samp class="file">CITATION</samp> file for use by the <code class="code">citation</code> function, and a <samp class="file">NEWS.Rd</samp> file for use by the <code class="code">news</code> function. See its help page for the specific format restrictions of the <samp class="file">NEWS.Rd</samp> file.</p>
<p><span id="index-AUTHORS" class="index-entry-id"></span> <span id="index-COPYRIGHTS-1" class="index-entry-id"></span></p>
<p>Another file sometimes needed in <samp class="file">inst</samp> is <samp class="file">AUTHORS</samp> or <samp class="file">COPYRIGHTS</samp> to specify the authors or copyright holders when this is too complex to put in the <samp class="file">DESCRIPTION</samp> file.</p>
<p>Subdirectory <samp class="file">tests</samp> is for additional package-specific test code, similar to the specific tests that come with the R distribution. Test code can either be provided directly in a <samp class="file">.R</samp> (or <samp class="file">.r</samp> as from R 3.4.0) file, or <em>via</em> a <samp class="file">.Rin</samp> file containing code which in turn creates the corresponding <samp class="file">.R</samp> file (e.g., by collecting all function objects in the package and then calling them with the strangest arguments). The results of running a <samp class="file">.R</samp> file are written to a <samp class="file">.Rout</samp> file. If there is a corresponding<a href="#FOOT24" id="DOCF24" class="footnote"><sup>24</sup></a> <samp class="file">.Rout.save</samp> file, these two are compared, with differences being reported but not causing an error. The directory <samp class="file">tests</samp> is copied to the check area, and the tests are run with the copy as the working directory and with <code class="code">R_LIBS</code> set to ensure that the copy of the package installed during testing will be found by <code class="code">library(</code><var class="var">pkg_name</var><code class="code">)</code>. Note that the package-specific tests are run in a vanilla R session without setting the random-number seed, so tests which use random numbers will need to set the seed to obtain reproducible results (and it can be helpful to do so in all cases, to avoid occasional failures when tests are run).</p>
<p>If directory <samp class="file">tests</samp> has a subdirectory <samp class="file">Examples</samp> containing a file <var class="var">pkg</var><code class="code">-Ex.Rout.save</code>, this is compared to the output file for running the examples when the latter are checked. Reference output should be produced without having the <samp class="option">--timings</samp> option set (and note that <samp class="option">--as-cran</samp> sets it).</p>
<p>If reference output is included for examples, tests or vignettes do make sure that it is fully reproducible, as it will be compared verbatim to that produced in a check run, unless the <samp class="samp">IGNORE_RDIFF</samp>’ markup is used. Things which trip up maintainers include displayed version numbers from loading other packages, printing numerical results to an unreproducibly high precision and printing timings. Another trap is small values which are in fact rounding error from zero: consider using <code class="code">zapsmall</code>.</p>
<p>Subdirectory <samp class="file">exec</samp> could contain additional executable scripts the package needs, typically scripts for interpreters such as the shell, Perl, or Tcl. NB: only files (and not directories) under <samp class="file">exec</samp> are installed (and those with names starting with a dot are ignored), and they are all marked as executable (mode <code class="code">755</code>, moderated by <samp class="samp">umask</samp>’) on POSIX platforms. Note too that this is not suitable for executable <em>programs</em> since some platforms support multiple architectures using the same installed package directory.</p>
<p>Subdirectory <samp class="file">po</samp> is used for files related to <em>localization</em>: see <a href="#internationalization" class="pxref">Internationalization</a>.</p>
<p>Subdirectory <samp class="file">tools</samp> is the preferred place for auxiliary files needed during configuration, and also for sources need to re-create scripts (e.g.&nbsp;M4 files for <code class="command">autoconf</code>: some prefer to put those in a subdirectory <samp class="file">m4</samp> of <samp class="file">tools</samp>).</p>
</section>
<section id="data-in-packages" class="level3 subsection" data-number="1.1.7">
<h3 class="subsection anchored" data-number="1.1.7" data-anchor-id="data-in-packages"><span class="header-section-number">1.1.7</span> Data in packages <a href="#data-in-packages-1" class="copiable-link">¶</a></h3>
<p>The <samp class="file">data</samp> subdirectory is for data files, either to be made available <em>via</em> lazy-loading or for loading using <code class="code">data()</code>. (The choice is made by the <samp class="samp">LazyData</samp>’ field in the <samp class="file">DESCRIPTION</samp> file: the default is not to do so.) It should not be used for other data files needed by the package, and the convention has grown up to use directory <samp class="file">inst/extdata</samp> for such files.</p>
<p>Data files can have one of three types as indicated by their extension: plain R code (<samp class="file">.R</samp> or <samp class="file">.r</samp>), tables (<samp class="file">.tab</samp>, <samp class="file">.txt</samp>, or <samp class="file">.csv</samp>, see <code class="code">?data</code> for the file formats, and note that <samp class="file">.csv</samp> is <strong>not</strong> the standard<a href="#FOOT25" id="DOCF25" class="footnote"><sup>25</sup></a> CSV format), or <code class="code">save()</code> images (<samp class="file">.RData</samp> or <samp class="file">.rda</samp>). The files should not be hidden (have names starting with a dot). Note that R code should be if possible “self-sufficient” and not make use of extra functionality provided by the package, so that the data file can also be used without having to load the package or its namespace: it should run as silently as possible and not change the <code class="code">search()</code> path by attaching packages or other environments.</p>
<p>Images (extensions <samp class="file">.RData</samp><a href="#FOOT26" id="DOCF26" class="footnote"><sup>26</sup></a> or <samp class="file">.rda</samp>) can contain references to the namespaces of packages that were used to create them. Preferably there should be no such references in data files, and in any case they should only be to packages listed in the <code class="code">Depends</code> and <code class="code">Imports</code> fields, as otherwise it may be impossible to install the package. To check for such references, load all the images into a vanilla R session, run <code class="code">str()</code> on all the datasets, and look at the output of <code class="code">loadedNamespaces()</code>.</p>
<p>Particular care is needed where a dataset or one of its components is of an S4 class, especially if the class is defined in a different package. First, the package containing the class definition has to be available to do useful things with the dataset, so that package must be listed in <code class="code">Imports</code> or <code class="code">Depends</code> (even if this gives a check warning about unused imports). Second, the definition of an S4 class can change, and often is unnoticed when in a package with a different author. So it may be wiser to use the <samp class="file">.R</samp> form and use that to create the dataset object when needed (loading package namespaces but not attaching them by using <code class="code">requireNamespace(</code><var class="var">pkg</var><code class="code">, quietly = TRUE)</code> and using <var class="var">pkg</var><code class="code">::</code> to refer to objects in the namespace).</p>
<p>If you are not using <samp class="samp">LazyData</samp>’ and either your data files are large or e.g., you use <samp class="file">data/foo.R</samp> scripts to produce your data, loading your namespace, you can speed up installation by providing a file <samp class="file">datalist</samp> in the <samp class="file">data</samp> subdirectory. This should have one line per topic that <code class="code">data()</code> will find, in the format <samp class="samp">foo</samp>’ if <code class="code">data(foo)</code> provides <samp class="samp">foo</samp>‘, or <samp class="samp">foo: bar bah</samp>’ if <code class="code">data(foo)</code> provides <samp class="samp">bar</samp>’ and <samp class="samp">bah</samp>’. <code class="command">R CMD build</code> will automatically add a <samp class="file">datalist</samp> file to <samp class="file">data</samp> directories of over 1Mb, using the function <code class="code">tools::add_datalist</code>.</p>
<p>Tables (<samp class="file">.tab</samp>, <samp class="file">.txt</samp>, or <samp class="file">.csv</samp> files) can be compressed by <code class="command">gzip</code>, <code class="command">bzip2</code> or <code class="command">xz</code>, optionally with additional extension <samp class="file">.gz</samp>, <samp class="file">.bz2</samp> or <samp class="file">.xz</samp>.</p>
<p>If your package is to be distributed, do consider the resource implications of large datasets for your users: they can make packages very slow to download and use up unwelcome amounts of storage space, as well as taking many seconds to load. It is normally best to distribute large datasets as <samp class="file">.rda</samp> images prepared by <code class="code">save(, compress = TRUE)</code> (the default). Using <code class="command">bzip2</code> or <code class="command">xz</code> compression will usually reduce the size of both the package tarball and the installed package, in some cases by a factor of two or more.</p>
<p>Package <strong>tools</strong> has a couple of functions to help with data images: <code class="code">checkRdaFiles</code> reports on the way the image was saved, and <code class="code">resaveRdaFiles</code> will re-save with a different type of compression, including choosing the best type for that particular image.</p>
<p>Many packages using <samp class="samp">LazyData</samp>’ will benefit from using a form of compression other than <code class="command">gzip</code> in the installed lazy-loading database. This can be selected by the <samp class="option">--data-compress</samp> option to <code class="command">R CMD INSTALL</code> or by using the <samp class="samp">LazyDataCompression</samp>’ field in the <samp class="file">DESCRIPTION</samp> file. Useful values are <code class="code">bzip2</code>, <code class="code">xz</code> and the default, <code class="code">gzip</code>: value <code class="code">none</code> is also accepted. The only way to discover which is best is to try them all and look at the size of the <var class="var">pkgname</var><samp class="file">/data/Rdata.rdb</samp> file. A function to do that (quoting sizes in KB) is</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>CheckLazyDataCompression <span class="op">&lt;-</span> function<span class="op">(</span>pkg<span class="op">)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    pkg_name <span class="op">&lt;-</span> sub<span class="op">(</span><span class="st">"_.*"</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> pkg<span class="op">)</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    lib <span class="op">&lt;-</span> tempfile<span class="op">();</span> dir<span class="op">.</span>create<span class="op">(</span>lib<span class="op">)</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    zs <span class="op">&lt;-</span> c<span class="op">(</span><span class="st">"gzip"</span><span class="op">,</span> <span class="st">"bzip2"</span><span class="op">,</span> <span class="st">"xz"</span><span class="op">)</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    res <span class="op">&lt;-</span> integer<span class="op">(</span><span class="dv">3</span><span class="op">);</span> names<span class="op">(</span>res<span class="op">)</span> <span class="op">&lt;-</span> zs</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>z in zs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        opts <span class="op">&lt;-</span> c<span class="op">(</span>paste0<span class="op">(</span><span class="st">"--data-compress="</span><span class="op">,</span> z<span class="op">),</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"--no-libs"</span><span class="op">,</span> <span class="st">"--no-help"</span><span class="op">,</span> <span class="st">"--no-demo"</span><span class="op">,</span> <span class="st">"--no-exec"</span><span class="op">,</span> <span class="st">"--no-test-load"</span><span class="op">)</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        install<span class="op">.</span>packages<span class="op">(</span>pkg<span class="op">,</span> lib<span class="op">,</span> INSTALL_opts <span class="op">=</span> opts<span class="op">,</span> repos <span class="op">=</span> NULL<span class="op">,</span> quiet <span class="op">=</span> TRUE<span class="op">)</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        res<span class="op">[</span>z<span class="op">]</span> <span class="op">&lt;-</span> file<span class="op">.</span>size<span class="op">(</span>file<span class="op">.</span>path<span class="op">(</span>lib<span class="op">,</span> pkg_name<span class="op">,</span> <span class="st">"data"</span><span class="op">,</span> <span class="st">"Rdata.rdb"</span><span class="op">))</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    ceiling<span class="op">(</span>res<span class="op">/</span><span class="dv">1024</span><span class="op">)</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(applied to a source package without any <samp class="samp">LazyDataCompression</samp>’ field). <code class="command">R CMD check</code> will warn if it finds a <var class="var">pkgname</var><samp class="file">/data/Rdata.rdb</samp> file of more than 5MB without <samp class="samp">LazyDataCompression</samp>’ being set. If you see that, run <code class="code">CheckLazyDataCompression()</code> and set the field – to <code class="code">gzip</code> in the unlikely event<a href="#FOOT27" id="DOCF27" class="footnote"><sup>27</sup></a> that is the best choice.</p>
<p>The analogue for <samp class="file">sysdata.rda</samp> is field <samp class="samp">SysDataCompression</samp>’: the default is <code class="code">xz</code> for files bigger than 1MB otherwise <code class="code">gzip</code>.</p>
<p>Lazy-loading is not supported for very large datasets (those which when serialized exceed 2GB, the limit for the format on 32-bit platforms).</p>
</section>
<section id="non-r-scripts-in-packages" class="level3 subsection" data-number="1.1.8">
<h3 class="subsection anchored" data-number="1.1.8" data-anchor-id="non-r-scripts-in-packages"><span class="header-section-number">1.1.8</span> Non-R scripts in packages <a href="#non-r-scripts-in-packages-1" class="copiable-link">¶</a></h3>
<p>Code which needs to be compiled (C, C++, Fortran …) is included in the <samp class="file">src</samp> subdirectory and discussed elsewhere in this document.</p>
<p>Subdirectory <samp class="file">exec</samp> could be used for scripts for interpreters such as the shell, BUGS, JavaScript, Matlab, Perl, PHP (<a href="https://CRAN.R-project.org/package=amap" class="url"><strong>amap</strong></a>), Python or Tcl (<a href="https://CRAN.R-project.org/package=Simile" class="url"><strong>Simile</strong></a>), or even R. However, it seems more common to use the <samp class="file">inst</samp> directory, for example <samp class="file">WriteXLS/inst/Perl</samp>, <samp class="file">NMF/inst/m-files</samp>, <samp class="file">RnavGraph/inst/tcl</samp>, <samp class="file">RProtoBuf/inst/python</samp> and <samp class="file">emdbook/inst/BUGS</samp> and <samp class="file">gridSVG/inst/js</samp>.</p>
<p>Java code is a special case: except for very small programs, <samp class="file">.java</samp> files should be byte-compiled (to a <samp class="file">.class</samp> file) and distributed as part of a <samp class="file">.jar</samp> file: the conventional location for the <samp class="file">.jar</samp> file(s) is <samp class="file">inst/java</samp>. It is desirable (and required under an Open Source license) to make the Java source files available: this is best done in a top-level <samp class="file">java</samp> directory in the package—the source files should not be installed.</p>
<p>If your package requires one of these interpreters or an extension then this should be declared in the <samp class="samp">SystemRequirements</samp>’ field of its <samp class="file">DESCRIPTION</samp> file. (Users of Java most often do so <em>via</em> <a href="https://CRAN.R-project.org/package=rJava" class="url"><strong>rJava</strong></a>, when depending on/importing that suffices unless there is a version requirement on Java code in the package.)</p>
<p>Windows and Mac users should be aware that the Tcl extensions <samp class="samp">BWidget</samp>’ and <samp class="samp">Tktable</samp>’ (which have sometimes been included in the Windows<a href="#FOOT28" id="DOCF28" class="footnote"><sup>28</sup></a> and macOS R installers) <em>are</em> extensions and do need to be declared (and that <samp class="samp">Tktable</samp>’ is less widely available than it used to be, including not in the main repositories for major Linux distributions). <samp class="samp">BWidget</samp>’ needs to be installed by the user on other OSes. This is fairly easy to do: first find the Tcl search path:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tcltk)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">strsplit</span>(<span class="fu">tclvalue</span>(<span class="st">'auto_path'</span>), <span class="st">" "</span>)[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>then download the sources from <a href="https://sourceforge.net/projects/tcllib/files/BWidget/" class="uref">https://sourceforge.net/projects/tcllib/files/BWidget/</a> and in a terminal run something like</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> xf bwidget-1.9.14.tar.gz</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv bwidget-1.9.14 /usr/local/lib</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>substituting a location on the Tcl search path for <samp class="file">/usr/local/lib</samp> if needed. (If no location on that search path is writeable, you will need to add one each time <samp class="samp">BWidget</samp>’ is to be used with <code class="code">tcltk::addTclPath()</code>.)</p>
<p>To (silently) test for the presence of <samp class="samp">Tktable</samp>’ one can use</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tcltk)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>have_tktable <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">isFALSE</span>(<span class="fu">suppressWarnings</span>(<span class="fu">tclRequire</span>(<span class="st">'Tktable'</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Installing <samp class="samp">Tktable</samp>’ needs a C compiler and the Tk headers (not necessarily installed with Tcl/Tk). At the time of writing the latest sources (from 2008) were available from <a href="https://sourceforge.net/projects/tktable/files/tktable/2.10/Tktable2.10.tar.gz/download" class="uref">https://sourceforge.net/projects/tktable/files/tktable/2.10/Tktable2.10.tar.gz/download</a>, but needed patching for current Tk (8.6.11, but not 8.6.10) – a patch can be found at <a href="https://www.stats.ox.ac.uk/pub/bdr/Tktable/" class="uref">https://www.stats.ox.ac.uk/pub/bdr/Tktable/</a>. For a system installation of Tk you may need to install <samp class="samp">Tktable</samp>’ as <samp class="samp">root</samp>’ as on e.g.&nbsp;Fedora all the locations on <code class="code">auto_path</code> are owned by <samp class="samp">root</samp>’.</p>
</section>
<section id="specifying-urls" class="level3 subsection" data-number="1.1.9">
<h3 class="subsection anchored" data-number="1.1.9" data-anchor-id="specifying-urls"><span class="header-section-number">1.1.9</span> Specifying URLs <a href="#specifying-urls-1" class="copiable-link">¶</a></h3>
<p>URLs in many places in the package documentation will be converted to clickable hyperlinks in at least some of their renderings. So care is needed that their forms are correct and portable.</p>
<p>The full URL should be given, including the scheme (often <samp class="samp">http://</samp>’ or <samp class="samp">https://</samp>‘) and a final <samp class="samp">/</samp>’ for references to directories.</p>
<p>Spaces in URLs are not portable and how they are handled does vary by HTTP server and by client. There should be no space in the host part of an <samp class="samp">http://</samp>’ URL, and spaces in the remainder should be encoded, with each space replaced by <samp class="samp">%20</samp>’.</p>
<p>Reserved characters should be encoded unless used in their reserved sense: see the help on <code class="code">URLencode()</code>.</p>
<p>The canonical URL for a CRAN package is</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>cran.r<span class="sc">-</span>project.org<span class="sc">/</span>package<span class="ot">=</span>pkgname</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and not a version starting <samp class="samp">https://cran.r-project.org/web/packages/</samp><var class="var">pkgname</var>’.</p>
</section>
</section>
<section id="configure-and-cleanup" class="level2 section" data-number="1.2">
<h2 class="section anchored" data-number="1.2" data-anchor-id="configure-and-cleanup"><span class="header-section-number">1.2</span> Configure and cleanup <a href="#configure-and-cleanup-1" class="copiable-link">¶</a></h2>
<p>Note that most of this section is specific to Unix-alikes: see the comments later on about the Windows port of R.</p>
<p>If your package needs some system-dependent configuration before installation you can include an executable (Bourne<a href="#FOOT29" id="DOCF29" class="footnote"><sup>29</sup></a> shell script <samp class="file">configure</samp> in your package which (if present) is executed by <code class="code">R CMD INSTALL</code> before any other action is performed. This can be a script created by the Autoconf mechanism, but may also be a script written by yourself. Use this to detect if any nonstandard libraries are present such that corresponding code in the package can be disabled at install time rather than giving error messages when the package is compiled or used. To summarize, the full power of Autoconf is available for your extension package (including variable substitution, searching for libraries, etc.). Background and useful tips on Autoconf and related tools (including <code class="command">pkg-config</code> described below) can be found at <a href="https://autotools.info/" class="uref">https://autotools.info/</a>.</p>
<p>A <code class="command">configure</code> script is run in an environment which has all the environment variables set for an R session (see <var class="var">R_HOME</var><samp class="file">/etc/Renviron</samp>) plus <code class="code">R_PACKAGE_NAME</code> (the name of the package), <code class="code">R_PACKAGE_DIR</code> (the path of the target installation directory of the package, a temporary location for staged installs) and <code class="code">R_ARCH</code> (the arch-dependent part of the path, often empty).</p>
<p>Under a Unix-alike only, an executable (Bourne shell) script <code class="command">cleanup</code> is executed as the last thing by <code class="code">R CMD INSTALL</code> if option <samp class="option">--clean</samp> was given, and by <code class="code">R CMD build</code> when preparing the package for building from its source.</p>
<p>As an example consider we want to use functionality provided by a (C or Fortran) library <code class="code">foo</code>. Using Autoconf, we can create a configure script which checks for the library, sets variable <code class="code">HAVE_FOO</code> to <code class="code">TRUE</code> if it was found and to <code class="code">FALSE</code> otherwise, and then substitutes this value into output files (by replacing instances of <samp class="samp">@HAVE_FOO@</samp>’ in input files with the value of <code class="code">HAVE_FOO</code>). For example, if a function named <code class="code">bar</code> is to be made available by linking against library <code class="code">foo</code> (i.e., using <samp class="option">-lfoo</samp>), one could use</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AC_CHECK_LIB</span>(foo, fun, [<span class="at">HAVE_FOO=</span><span class="cn">TRUE</span>], [<span class="at">HAVE_FOO=</span><span class="cn">FALSE</span>])</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">AC_SUBST</span>(HAVE_FOO)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>......</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">AC_CONFIG_FILES</span>([foo.R])</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>AC_OUTPUT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in <samp class="file">configure.ac</samp> (assuming Autoconf 2.50 or later).</p>
<p>The definition of the respective R function in <samp class="file">foo.R.in</samp> could be</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="er">@</span>HAVE_FOO<span class="sc">@</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Sorry, library 'foo' is not available"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>From this file <code class="command">configure</code> creates the actual R source file <samp class="file">foo.R</samp> looking like</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="cn">FALSE</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Sorry, library 'foo' is not available"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>if library <code class="code">foo</code> was not found (with the desired functionality). In this case, the above R code effectively disables the function.</p>
<p>One could also use different file fragments for available and missing functionality, respectively.</p>
<p>You will very likely need to ensure that the same C compiler and compiler flags are used in the <samp class="file">configure</samp> tests as when compiling R or your package. Under a Unix-alike, you can achieve this by including the following fragment early in <samp class="file">configure.ac</samp> (<em>before</em> calling <code class="code">AC_PROG_CC</code> or anything which calls it)</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>: <span class="ch">${</span><span class="dt">R_HOME</span><span class="er">=</span><span class="dt">`R</span><span class="er"> </span><span class="dt">RHOME`</span><span class="ch">}</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>if test -z <span class="st">"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">"</span>; then</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  echo <span class="st">"could not determine R_HOME"</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  exit 1</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>fi</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="dt">CC</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CC`</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CFLAGS`</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="dt">CPPFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CPPFLAGS`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(Using <samp class="samp">${R_HOME}/bin/R</samp>’ rather than just <samp class="samp">R</samp>’ is necessary in order to use the correct version of R when running the script as part of <code class="code">R CMD INSTALL</code>, and the quotes since <samp class="samp">${R_HOME}</samp>’ might contain spaces.)</p>
<p>If your code does load checks (for example, to check for an entry point in a library or to run code) then you will also need</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">LDFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config LDFLAGS`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Packages written with C++ need to pick up the details for the C++ compiler and switch the current language to C++ by something like</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX`</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>if test -z <span class="st">"</span><span class="ch">$C</span><span class="st">XX"</span>; then</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  AC_MSG_ERROR([No C++ compiler is available])</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>fi</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="dt">CXXFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXXFLAGS`</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="dt">CPPFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CPPFLAGS`</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>AC_LANG(C++)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The latter is important, as for example C headers may not be available to C++ programs or may not be written to avoid C++ name-mangling. Note that an R installation is not required to have a C++ compiler so <samp class="samp">CXX</samp>’ may be empty. If the package specifies a non-default C++ standard, use the <code class="command">config</code> variable names (such as <code class="code">CXX17</code>) appropriate to the standard, but still set <code class="code">CXX</code> and <code class="code">CXXFLAGS</code>.</p>
<p>You can use <code class="code">R CMD config</code> to get the value of the basic configuration variables, and also the header and library flags necessary for linking a front-end executable program against R, see <kbd><kbd>R CMD config --help</kbd></kbd> for details. If you do, it is essential that you use both the command and the appropriate flags, so that for example <samp class="samp">CC</samp>’ must always be used with <samp class="samp">CFLAGS</samp>’ and (for code to be linked into a shared library) <samp class="samp">CPICFLAGS</samp>‘. For Fortran, be careful to use <samp class="samp">FC FFLAGS FPICFLAGS</samp>’ for fixed-form Fortran and <samp class="samp">FC FCFLAGS FPICFLAGS</samp>’ for free-form Fortran.</p>
<p>As from R 4.3.0, variables</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>CC CFLAGS CXX CXXFLAGS CPPFLAGS LDFLAGS FC FCFLAGS</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>are set in the environment (if not already set) when <code class="command">configure</code> is called from <code class="command">R CMD INSTALL</code>, in case the script forgets to set them as described above. This includes making use of the selected C standard (but not the C++ standard as that is selected at a later stage by <code class="command">R CMD SHLIB</code>).</p>
<p>To check for an external BLAS library using the <code class="code">AX_BLAS</code> macro from the official Autoconf Macro Archive<a href="#FOOT30" id="DOCF30" class="footnote"><sup>30</sup></a>, one can use</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">FC</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config FC`</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="dt">FCLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config FFLAGS`</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>AC_PROG_FC</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="dt">FLIBS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config FLIBS`</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>AX_BLAS([], AC_MSG_ERROR([could not find your BLAS library], 1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that <code class="code">FLIBS</code> as determined by R must be used to ensure that Fortran code works on all R platforms.</p>
<p><strong>N.B.</strong>: If the <code class="command">configure</code> script creates files, e.g. <samp class="file">src/Makevars</samp>, you do need a <code class="command">cleanup</code> script to remove them. Otherwise <code class="command">R CMD build</code> may ship the files that are created. For example, package <a href="https://CRAN.R-project.org/package=RODBC" class="url"><strong>RODBC</strong></a> has</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-f</span> config.<span class="pp">*</span> src/Makevars src/config.h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As this example shows, <code class="command">configure</code> often creates working files such as <samp class="file">config.log</samp>. If you use a hand-crafted script rather than one created by <code class="command">autoconf</code>, it is highly recommended that you log its actions to file <samp class="file">config.log</samp>.</p>
<p>If your configure script needs auxiliary files, it is recommended that you ship them in a <samp class="file">tools</samp> directory (as R itself does).</p>
<p>You should bear in mind that the configure script will not be used on Windows systems. If your package is to be made publicly available, please give enough information for a user on a non-Unix-alike platform to configure it manually, or provide a <samp class="file">configure.win</samp> script (or <samp class="file">configure.ucrt</samp>) to be used on that platform. (Optionally, there can be a <samp class="file">cleanup.win</samp> script (or <samp class="file">cleanup.ucrt</samp>). Both should be shell scripts to be executed by <code class="command">ash</code>, which is a minimal version of Bourne-style <code class="command">sh</code>. As from R 4.2.0, <code class="command">bash</code> is used. When <samp class="file">configure.win</samp> (or <samp class="file">configure.ucrt</samp>) is run the environment variables <code class="env">R_HOME</code> (which uses <samp class="samp">/</samp>’ as the file separator), <code class="env">R_ARCH</code> and <code class="env">R_ARCH_BIN</code> will be set. Use <code class="env">R_ARCH</code> to decide if this is a 64-bit build for Intel (its value there is <samp class="samp">/x64</samp>’) and to install DLLs to the correct place (<samp class="file">${R_HOME}/libs${R_ARCH}</samp>). Use <code class="env">R_ARCH_BIN</code> to find the correct place under the <samp class="file">bin</samp> directory, e.g.&nbsp;<samp class="file">${R_HOME}/bin${R_ARCH_BIN}/Rscript.exe</samp>. If a <samp class="file">configure.win</samp> script does compilation (including calling <code class="command">R CMD SHLIB</code>), most of the considerations above apply.</p>
<p>As the scripts on Windows are executed as <code class="command">sh ./configure.win</code> and similar, any ‘shebang’ first line (such as <code class="code">#! /bin/bash</code>) is treated as a comment.</p>
<p>In some rare circumstances, the configuration and cleanup scripts need to know the location into which the package is being installed. An example of this is a package that uses C code and creates two shared object/DLLs. Usually, the object that is dynamically loaded by R is linked against the second, dependent, object. On some systems, we can add the location of this dependent object to the object that is dynamically loaded by R. This means that each user does not have to set the value of the <code class="env">LD_LIBRARY_PATH</code> (or equivalent) environment variable, but that the secondary object is automatically resolved. Another example is when a package installs support files that are required at run time, and their location is substituted into an R data structure at installation time. <span id="index-R_005fLIBRARY_005fDIR" class="index-entry-id"></span> <span id="index-R_005fPACKAGE_005fDIR-1" class="index-entry-id"></span> <span id="index-R_005fPACKAGE_005fNAME-1" class="index-entry-id"></span> The names of the top-level library directory (i.e., specifiable <em>via</em> the <samp class="samp">-l</samp>’ argument) and the directory of the package itself are made available to the installation scripts <em>via</em> the two shell/environment variables <code class="env">R_LIBRARY_DIR</code> and <code class="env">R_PACKAGE_DIR</code>. Additionally, the name of the package (e.g.&nbsp;<samp class="samp">survival</samp>’ or <samp class="samp">MASS</samp>’) being installed is available from the environment variable <code class="env">R_PACKAGE_NAME</code>. (Currently the value of <code class="env">R_PACKAGE_DIR</code> is always <code class="code">${R_LIBRARY_DIR}/${R_PACKAGE_NAME}</code>, but this used not to be the case when versioned installs were allowed. Its main use is in <samp class="file">configure.win</samp> (or <samp class="file">configure.ucrt</samp>) scripts for the installation path of external software’s DLLs.) Note that the value of <code class="env">R_PACKAGE_DIR</code> may contain spaces and other shell-unfriendly characters, and so should be quoted in makefiles and configure scripts.</p>
<p>One of the more tricky tasks can be to find the headers and libraries of external software. One tool which is increasingly available on Unix-alikes (but not by default<a href="#FOOT31" id="DOCF31" class="footnote"><sup>31</sup></a> on macOS) to do this is <code class="command">pkg-config</code>. The <samp class="file">configure</samp> script will need to test for the presence of the command itself<a href="#FOOT32" id="DOCF32" class="footnote"><sup>32</sup></a> (see for example package <a href="https://CRAN.R-project.org/package=tiff" class="url"><strong>tiff</strong></a>), and if present it can be asked if the software is installed, of a suitable version and for compilation/linking flags by e.g.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>$ pkg<span class="op">-</span>config <span class="op">--</span>exists <span class="ch">'l</span><span class="er">ibtiff-4 &gt;= 4.1.0</span><span class="ch">'</span> <span class="op">--</span>print<span class="op">-</span>errors # check the status</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>$ pkg<span class="op">-</span>config <span class="op">--</span>modversion libtiff<span class="op">-</span><span class="dv">4</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fl">4.3</span><span class="er">.0</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>$ pkg<span class="op">-</span>config <span class="op">--</span>cflags libtiff<span class="op">-</span><span class="dv">4</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>I<span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>include</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>$ pkg<span class="op">-</span>config <span class="op">--</span>libs libtiff<span class="op">-</span><span class="dv">4</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>L<span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>lib <span class="op">-</span>ltiff</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>$ pkg<span class="op">-</span>config <span class="op">--</span><span class="dt">static</span> <span class="op">--</span>libs libtiff<span class="op">-</span><span class="dv">4</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>L<span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>lib <span class="op">-</span>ltiff <span class="op">-</span>lwebp <span class="op">-</span>llzma <span class="op">-</span>ljpeg <span class="op">-</span>lz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that <code class="command">pkg-config --libs</code> gives the information required to link against the default version<a href="#FOOT33" id="DOCF33" class="footnote"><sup>33</sup></a> of that library (usually the dynamic one), and <code class="command">pkg-config --static --libs</code> may be needed if the static library is to be used.</p>
<p>Static libraries are commonly used on macOS and Windows to facilitate bundling external software with binary distributions of packages. This means that portable (source) packages need to allow for this. It is <em>not</em> safe to just use <code class="command">pkg-config --static --libs</code>, as that will often include further libraries that are not necessarily installed on the user’s system (or maybe only the versioned library such as <samp class="file">libjbig.so.2.1</samp> is installed and not <samp class="file">libjbig.so</samp> which would be needed to use <code class="code">-ljbig</code> sometimes included in <code class="command">pkg-config --static --libs libtiff-4</code>).</p>
<p>Another issue is that <code class="command">pkg-config --exists</code> may not be reliable. It checks not only that the ‘module’ is available but <em>all</em> of the dependencies, including those in principle needed for static linking. (XQuartz 2.8.x only distributed dynamic libraries and not some of the <samp class="file">.pc</samp> files needed for <code class="code">--exists</code>.)</p>
<p>Sometimes the name by which the software is known to <code class="command">pkg-config</code> is not what one might expect (e.g. <samp class="samp">libxml-2.0</samp>’ even for 2.9.x). To get a complete list use</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pkg<span class="sc">-</span>config <span class="sc">--</span>list<span class="sc">-</span>all <span class="sc">|</span> sort</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Some external software provides a <samp class="file">-config</samp> command to do a similar job to <code class="command">pkg-config</code>, including</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>curl<span class="sc">-</span>config   freetype<span class="sc">-</span>config  gdal<span class="sc">-</span>config    geos<span class="sc">-</span>config</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>gsl<span class="sc">-</span>config    iodbc<span class="sc">-</span>config     libpng<span class="sc">-</span>config  nc<span class="sc">-</span>config</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>pcre<span class="sc">-</span>config   pcre2<span class="sc">-</span>config     xml2<span class="sc">-</span>config    xslt<span class="sc">-</span>config</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(<code class="command">curl-config</code> is for <code class="code">libcurl</code> not <code class="command">curl</code>. <code class="command">nc-config</code> is for <code class="code">netcdf</code>.) Most have an option to use static libraries.</p>
<p><strong>N.B.</strong> These commands indicate what header paths and libraries are needed, but they do not obviate the need to check that the recipes they give actually work. (This is especially necessary for platforms which use static linking.)</p>
<p>If using Autoconf it is good practice to include all the Autoconf sources in the package (and required for an Open Source package and tested by <code class="command">R CMD check --as-cran</code>). This will include the file <samp class="file">configure.ac</samp><a href="#FOOT34" id="DOCF34" class="footnote"><sup>34</sup></a> in the top-level directory of the package. If extensions written in <code class="command">m4</code> are needed, these should be included under the directory <samp class="file">tools</samp> and included from <samp class="file">configure.ac</samp> <em>via</em> e.g.,</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">m4_include</span>([tools<span class="sc">/</span>ax_pthread.m4])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Alternatively, Autoconf can be asked to search all <samp class="file">.m4</samp> files in a directory by including something like<a href="#FOOT35" id="DOCF35" class="footnote"><sup>35</sup></a></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AC_CONFIG_MACRO_DIR</span>([tools<span class="sc">/</span>m4])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>One source of such extensions is the ‘Autoconf Archive’ (<a href="https://www.gnu.org/software/autoconf-archive/" class="uref">https://www.gnu.org/software/autoconf-archive/</a>. It is not safe to assume this is installed on users’ machines, so the extension should be shipped with the package (taking care to comply with its licence).</p>
<section id="using-makevars" class="level3 subsection" data-number="1.2.1">
<h3 class="subsection anchored" data-number="1.2.1" data-anchor-id="using-makevars"><span class="header-section-number">1.2.1</span> Using <samp class="file">Makevars</samp> <a href="#using-makevars-1" class="copiable-link">¶</a></h3>
<p>Sometimes writing your own <samp class="file">configure</samp> script can be avoided by supplying a file <samp class="file">Makevars</samp>: also one of the most common uses of a <samp class="file">configure</samp> script is to make <samp class="file">Makevars</samp> from <samp class="file">Makevars.in</samp>.</p>
<p>A <samp class="file">Makevars</samp> file is a makefile and is used as one of several makefiles by <code class="command">R CMD SHLIB</code> (which is called by <code class="command">R CMD INSTALL</code> to compile code in the <samp class="file">src</samp> directory). It should be written if at all possible in a portable style, in particular (except for <samp class="file">Makevars.win</samp> and <samp class="file">Makevars.ucrt</samp>) without the use of GNU extensions.</p>
<p>The most common use of a <samp class="file">Makevars</samp> file is to set additional preprocessor options (for example include paths and definitions) for C/C++ files <em>via</em> <code class="code">PKG_CPPFLAGS</code>, and additional compiler flags by setting <code class="code">PKG_CFLAGS</code>, <code class="code">PKG_CXXFLAGS</code> or <code class="code">PKG_FFLAGS</code>, for C, C++ or Fortran respectively (see <a href="System-and-foreign-language-interfaces.html#creating-shared-objects" class="pxref">Creating shared objects</a>).</p>
<p><strong>N.B.</strong>: Include paths are preprocessor options, not compiler options, and <strong>must</strong> be set in <code class="code">PKG_CPPFLAGS</code> as otherwise platform-specific paths (e.g.&nbsp;<samp class="samp">-I/usr/local/include</samp>‘) will take precedence. <code class="code">PKG_CPPFLAGS</code> should contain <samp class="samp">-I</samp>’, <samp class="samp">-D</samp>‘, <samp class="samp">-U</samp>’ and (where supported) <samp class="samp">-include</samp>’ and <samp class="samp">-pthread</samp>’ options: everything else should be a compiler flag. The order of flags matters, and using <samp class="samp">-I</samp>’ in <code class="code">PKG_CFLAGS</code> or <code class="code">PKG_CXXFLAGS</code> has led to hard-to-debug platform-specific errors.</p>
<p><samp class="file">Makevars</samp> can also be used to set flags for the linker, for example <samp class="samp">-L</samp>’ and <samp class="samp">-l</samp>’ options, <em>via</em> <code class="code">PKG_LIBS</code>.</p>
<p>When writing a <samp class="file">Makevars</samp> file for a package you intend to distribute, take care to ensure that it is not specific to your compiler: flags such as <samp class="option">-O2 -Wall -pedantic</samp> (and all other <samp class="option">-W</samp> flags: for the Oracle compilers these were used to pass arguments to compiler phases) are all specific to GCC (and compilers such as <code class="command">clang</code> which aim to be options-compatible with it).</p>
<p>Also, do not set variables such as <code class="code">CPPFLAGS</code>, <code class="code">CFLAGS</code> etc.: these should be settable by users (sites) through appropriate personal (site-wide) <samp class="file">Makevars</samp> files. See <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Customizing-package-compilation" data-manual="R-admin">Customizing package compilation</a> in R Installation and Administration for more information.</p>
<p>There are some macros<a href="#FOOT36" id="DOCF36" class="footnote"><sup>36</sup></a> which are set whilst configuring the building of R itself and are stored in <var class="var">R_HOME</var><samp class="file">/etc</samp><var class="var">R_ARCH</var><samp class="file">/Makeconf</samp>. That makefile is included as a <samp class="file">Makefile</samp> <em>after</em> <samp class="file">Makevars[.win]</samp>, and the macros it defines can be used in macro assignments and make command lines in the latter. These include</p>
<p>: A macro containing the set of libraries need to link Fortran code. This may need to be included in <code class="code">PKG_LIBS</code>: it will normally be included automatically if the package contains Fortran source files in the <samp class="file">src</samp> directory.</p>
<p>: A macro containing the BLAS libraries used when building R. This may need to be included in <code class="code">PKG_LIBS</code>. Beware that if it is empty then the R executable will contain all the double-precision and double-complex BLAS routines, but no single-precision nor complex routines. If <code class="code">BLAS_LIBS</code> is included, then <code class="code">FLIBS</code> also needs to be<a href="#FOOT37" id="DOCF37" class="footnote"><sup>37</sup></a> included following it, as most BLAS libraries are written at least partially in Fortran. However, it can be omitted if the package contains Fortran source code as that will add <code class="code">FLIBS</code> to the link line.</p>
<p>: A macro containing the LAPACK libraries (and paths where appropriate) used when building R. This may need to be included in <code class="code">PKG_LIBS</code>. It may point to a dynamic library <code class="code">libRlapack</code> which contains the main double-precision LAPACK routines as well as those double-complex LAPACK routines needed to build R, or it may point to an external LAPACK library, or may be empty if an external BLAS library also contains LAPACK.</p>
<pre><code>\[`libRlapack`{.code} includes all the double-precision LAPACK
routines which were current in 2003 and a few more recent ones: a
list of which routines are included is in file
`src/modules/lapack/README`{.sample .file}. Note that an external
LAPACK/BLAS library need not do so, as some were 'deprecated' (and
not compiled by default) in LAPACK 3.6.0 in late 2015.\]

For portability, the macros `BLAS_LIBS`{.code} and `FLIBS`{.code}
should always be included *after* `LAPACK_LIBS`{.code} (and in that
order).</code></pre>
<p>: A macro containing flags which are needed to circumvent over-optimization of FORTRAN code: it is might be <samp class="samp">-g -O2 -ffloat-store</samp>’ or <samp class="samp">-g -O2 -msse2 -mfpmath=sse</samp>’ on <samp class="samp">ix86</samp>’ platforms using <code class="command">gfortran</code>. Note that this is <strong>not</strong> an additional flag to be used as part of <code class="code">PKG_FFLAGS</code>, but a replacement for <code class="code">FFLAGS</code>. See the example later in this section.</p>
<p>Setting certain macros in <samp class="file">Makevars</samp> will prevent <code class="command">R CMD SHLIB</code> setting them: in particular if <samp class="file">Makevars</samp> sets <samp class="samp">OBJECTS</samp>’ it will not be set on the <code class="command">make</code> command line. This can be useful in conjunction with implicit rules to allow other types of source code to be compiled and included in the shared object. It can also be used to control the set of files which are compiled, either by excluding some files in <samp class="file">src</samp> or including some files in subdirectories. For example</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="dt">OBJECTS</span> <span class="ch">=</span><span class="st"> 4dfp/endianio.o 4dfp/Getifh.o R4dfp-object.o</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that <samp class="file">Makevars</samp> should not normally contain targets, as it is included before the default makefile and <code class="command">make</code> will call the first target, intended to be <code class="code">all</code> in the default makefile. If you really need to circumvent that, use a suitable (phony) target <code class="code">all</code> before any actual targets in <samp class="file">Makevars.[win]</samp>: for example package <a href="https://CRAN.R-project.org/package=fastICA" class="url"><strong>fastICA</strong></a> used to have</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> @BLAS_LIBS@</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>SLAMC_FFLAGS<span class="op">=</span>$<span class="op">(</span>R_XTRA_FFLAGS<span class="op">)</span> $<span class="op">(</span>FPICFLAGS<span class="op">)</span> $<span class="op">(</span>SHLIB_FFLAGS<span class="op">)</span> $<span class="op">(</span>SAFE_FFLAGS<span class="op">)</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>all<span class="op">:</span> $<span class="op">(</span>SHLIB<span class="op">)</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>slamc<span class="op">.</span>o<span class="op">:</span> slamc<span class="op">.</span>f</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        $<span class="op">(</span>FC<span class="op">)</span> $<span class="op">(</span>SLAMC_FFLAGS<span class="op">)</span> <span class="op">-</span>c <span class="op">-</span>o slamc<span class="op">.</span>o slamc<span class="op">.</span>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>needed to ensure that the LAPACK routines find some constants without infinite looping. The Windows equivalent was</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">SHLIB</span><span class="ch">)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="dv">slamc.o:</span><span class="dt"> slamc.f</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="er">        </span><span class="ch">$(</span><span class="dt">FC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">SAFE_FFLAGS</span><span class="ch">)</span> -c -o slamc.o slamc.f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(since the other macros are all empty on that platform, and R’s internal BLAS was not used). Note that the first target in <samp class="file">Makevars</samp> will be called, but for back-compatibility it is best named <code class="code">all</code>.</p>
<p>If you want to create and then link to a library, say using code in a subdirectory, use something like</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> all mylibs</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">SHLIB</span><span class="ch">)</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="dv">$(SHLIB):</span><span class="dt"> mylibs</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="dv">mylibs:</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="er">        </span>(cd subdir; <span class="ch">$(</span><span class="dt">MAKE</span><span class="ch">)</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Be careful to create all the necessary dependencies, as there is no guarantee that the dependencies of <code class="code">all</code> will be run in a particular order (and some of the CRAN build machines use multiple CPUs and parallel makes). In particular,</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> mylibs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>does <strong>not</strong> suffice. GNU make does allow the construct</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ot">.NOTPARALLEL:</span><span class="dt"> all</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> mylibs </span><span class="ch">$(</span><span class="dt">SHLIB</span><span class="ch">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>but that is not portable. <code class="command">dmake</code> and <code class="command">pmake</code> allow the similar <code class="code">.NO_PARALLEL</code>, also not portable: some variants of <code class="command">pmake</code> accept <code class="code">.NOTPARALLEL</code> as an alias for <code class="code">.NO_PARALLEL</code>.</p>
<p>Note that on Windows it is required that <samp class="file">Makevars[.win, .ucrt]</samp> does create a DLL: this is needed as it is the only reliable way to ensure that building a DLL succeeded. If you want to use the <samp class="file">src</samp> directory for some purpose other than building a DLL, use a <samp class="file">Makefile.win</samp> or <samp class="file">Makefile.ucrt</samp> file.</p>
<p>It is sometimes useful to have a target <samp class="samp">clean</samp>’ in <samp class="file">Makevars</samp>, <samp class="file">Makevars.win</samp> or <samp class="file">Makevars.ucrt</samp>: this will be used by <code class="command">R CMD build</code> to clean up (a copy of) the package sources. When it is run by <code class="command">build</code> it will have fewer macros set, in particular not <code class="code">$(SHLIB)</code>, nor <code class="code">$(OBJECTS)</code> unless set in the file itself. It would also be possible to add tasks to the target <samp class="samp">shlib-clean</samp>’ which is run by <code class="command">R CMD INSTALL</code> and <code class="command">R CMD SHLIB</code> with options <samp class="option">--clean</samp> and <samp class="option">--preclean</samp>.</p>
<p>Avoid the use of default (also known as ‘implicit’ rules) in makefiles, as these are <code class="command">make</code>-specific. Even when mandated by POSIX – GNU <code class="command">make</code> does not comply and this has broken package installation.</p>
<p>An unfortunately common error is to have</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">SHLIB</span><span class="ch">)</span><span class="dt"> clean</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which asks <code class="command">make</code> to clean in parallel with compiling the code. Not only does this lead to hard-to-debug installation errors, it wipes out all the evidence of any error (from a parallel make or not). It is much better to leave cleaning to the end user using the facilities in the previous paragraph.</p>
<p>If you want to run R code in <samp class="file">Makevars</samp>, e.g.&nbsp;to find configuration information, please do ensure that you use the correct copy of <code class="code">R</code> or <code class="code">Rscript</code>: there might not be one in the path at all, or it might be the wrong version or architecture. The correct way to do this is <em>via</em></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="st">"</span><span class="ch">$(</span><span class="dt">R_HOME</span><span class="ch">)</span><span class="st">/bin</span><span class="ch">$(</span><span class="dt">R_ARCH_BIN</span><span class="ch">)</span><span class="st">/Rscript"</span> filename</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="st">"</span><span class="ch">$(</span><span class="dt">R_HOME</span><span class="ch">)</span><span class="st">/bin</span><span class="ch">$(</span><span class="dt">R_ARCH_BIN</span><span class="ch">)</span><span class="st">/Rscript"</span> -e <span class="st">'R expression'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code class="code">$(R_ARCH_BIN)</code> is only needed currently on Windows.</p>
<p>Environment or make variables can be used to select different macros for Intel 64-bit code or code for other architectures, for example (GNU <code class="command">make</code> syntax, allowed on Windows)</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>ifeq <span class="st">"$(WIN)"</span> <span class="st">"64"</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> value <span class="cf">for</span> <span class="dv">64</span><span class="op">-</span>bit Intel Windows</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> value <span class="cf">for</span> unknown Windows architectures</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>endif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On Windows there is normally a choice between linking to an import library or directly to a DLL. Where possible, the latter is much more reliable: import libraries are tied to a specific toolchain, and in particular on 64-bit Windows two different conventions have been commonly used. So for example instead of</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> <span class="op">-</span>L$<span class="op">(</span>XML_DIR<span class="op">)/</span>lib <span class="op">-</span>lxml2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>one can use</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> <span class="op">-</span>L$<span class="op">(</span>XML_DIR<span class="op">)/</span>bin <span class="op">-</span>lxml2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>since on Windows <code class="code">-lxxx</code> will look in turn for</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>libxxx.dll.a</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>xxx.dll.a</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>libxxx.a</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>xxx.lib</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>libxxx.dll</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>xxx.dll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the first and second are conventionally import libraries, the third and fourth often static libraries (with <code class="code">.lib</code> intended for Visual C++), but might be import libraries. See for example <a href="https://sourceware.org/binutils/docs-2.20/ld/WIN32.html#WIN32" class="uref">https://sourceware.org/binutils/docs-2.20/ld/WIN32.html#WIN32</a>.</p>
<p>The fly in the ointment is that the DLL might not be named <samp class="file">libxxx.dll</samp>, and in fact on 32-bit Windows there was a <samp class="file">libxml2.dll</samp> whereas on one build for 64-bit Windows the DLL is called <samp class="file">libxml2-2.dll</samp>. Using import libraries can cover over these differences but can cause equal difficulties.</p>
<p>If static libraries are available they can save a lot of problems with run-time finding of DLLs, especially when binary packages are to be distributed and even more when these support both architectures. Where using DLLs is unavoidable we normally arrange (<em>via</em> <samp class="file">configure.win</samp> or <samp class="file">configure.ucrt</samp>) to ship them in the same directory as the package DLL.</p>
</section>
<section id="openmp-support" class="level3 subsubsection" data-number="1.2.2">
<h3 class="subsubsection anchored" data-number="1.2.2" data-anchor-id="openmp-support"><span class="header-section-number">1.2.2</span> OpenMP support <a href="#openmp-support-1" class="copiable-link">¶</a></h3>
<p>There is some support for packages which wish to use OpenMP<a href="#FOOT38" id="DOCF38" class="footnote"><sup>38</sup></a>. The <code class="command">make</code> macros</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>SHLIB_OPENMP_CFLAGS</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>SHLIB_OPENMP_CXXFLAGS</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>SHLIB_OPENMP_FFLAGS</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>are available for use in <samp class="file">src/Makevars</samp>, <samp class="file">src/Makevars.win</samp> or <samp class="file">Makevars.ucrt</samp>. Include the appropriate macro in <code class="code">PKG_CFLAGS</code>, <code class="code">PKG_CXXFLAGS</code> and so on, and also in <code class="code">PKG_LIBS</code> (but see below for Fortran). C/C++ code that needs to be conditioned on the use of OpenMP can be used inside <code class="code">#ifdef _OPENMP</code>: note that some toolchains used for R (including Apple’s for macOS<a href="#FOOT39" id="DOCF39" class="footnote"><sup>39</sup></a> and some others using <code class="command">clang</code><a href="#FOOT40" id="DOCF40" class="footnote"><sup>40</sup></a>) have no OpenMP support at all, not even <samp class="file">omp.h</samp>.</p>
<p>For example, a package with C code written for OpenMP should have in <samp class="file">src/Makevars</samp> the lines</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>PKG_CFLAGS <span class="op">=</span> $<span class="op">(</span>SHLIB_OPENMP_CFLAGS<span class="op">)</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> $<span class="op">(</span>SHLIB_OPENMP_CFLAGS<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that the macro <code class="code">SHLIB_OPENMP_CXXFLAGS</code> applies to the default C++ compiler and not necessarily to the C++17/20/23 compiler: users of the latter should do their own <code class="command">configure</code> checks. If you do use your own checks, make sure that OpenMP support is complete by compiling and linking an OpenMP-using program: on some platforms the runtime library is optional and on others that library depends on other optional libraries.</p>
<p>Some care is needed when compilers are from different families which may use different OpenMP runtimes (e.g.&nbsp;<code class="command">clang</code> <em>vs</em> GCC including <code class="command">gfortran</code>, although it is often possible to use the <code class="command">clang</code> runtime with GCC but not <em>vice versa</em>: however <code class="command">gfortran</code> &gt;= 9 may generate calls not in the <code class="command">clang</code> runtime). For a package with Fortran code using OpenMP the appropriate lines are</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>PKG_FFLAGS <span class="op">=</span> $<span class="op">(</span>SHLIB_OPENMP_FFLAGS<span class="op">)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> $<span class="op">(</span>SHLIB_OPENMP_CFLAGS<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>as the C compiler will be used to link the package code. There are platforms on which this does not work <em>for some OpenMP-using code</em> and installation will fail. Since R &gt;= 3.6.2 the best alternative for a package with only Fortran sources using OpenMP is to use</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>USE_FC_TO_LINK <span class="op">=</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>PKG_FFLAGS <span class="op">=</span> $<span class="op">(</span>SHLIB_OPENMP_FFLAGS<span class="op">)</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> $<span class="op">(</span>SHLIB_OPENMP_FFLAGS<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in <samp class="file">src/Makevars</samp>, <samp class="file">src/Makevars.win</samp> or <samp class="file">Makevars.ucrt</samp>. Note however, that when this is used <code class="code">$(FLIBS)</code> should not be included in <code class="code">PKG_LIBS</code> since it is for linking Fortran-compiled code by the C compiler.</p>
<p>Common platforms may inline all OpenMP calls and so tolerate the omission of the OpenMP flag from <code class="code">PKG_LIBS</code>, but this usually results in an installation failure with a different compiler or compilation flags. So cross-check that e.g.&nbsp;<code class="code">-fopenmp</code> appears in the linking line in the installation logs.</p>
<p>It is not portable to use OpenMP with more than one of C, C++ and Fortran in a single package since it is not uncommon that the compilers are of different families.</p>
<p>For portability, any C/C++ code using the <code class="code">omp_*</code> functions should include the <samp class="file">omp.h</samp> header: some compilers (but not all) include it when OpenMP mode is switched on (e.g.&nbsp;<em>via</em> flag <samp class="option">-fopenmp</samp>).</p>
<p>There is nothing<a href="#FOOT41" id="DOCF41" class="footnote"><sup>41</sup></a> to say what version of OpenMP is supported: version 4.0 (and much of 4.5 or 5.0) is supported by recent versions of the Linux and Windows platforms, but portable packages cannot assume that end users have recent versions. Apple <code class="command">clang</code> on macOS has no OpenMP support. <a href="https://www.openmp.org/resources/openmp-compilers-tools/" class="uref">https://www.openmp.org/resources/openmp-compilers-tools/</a> gives some idea of what compilers support what versions. Note that support for Fortran compilers is often less up-to-date and that page suggests it is unwise to rely on a version later than 3.1. Which introduced a Fortran OpenMP module, so Fortran users of OpenMP should include</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>use omp_lib</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Rarely, using OpenMP with <code class="command">clang</code> on Linux generates calls in <code class="code">libatomic</code>, resulting in loading messages like</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>  undefined symbol<span class="sc">:</span> __atomic_compare_exchange</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  undefined symbol<span class="sc">:</span> __atomic_load</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The workaround is to link with <code class="code">-latomic</code> (having checked it exists).</p>
<p>The performance of OpenMP varies substantially between platforms. The Windows implementation has substantial overheads, so is only beneficial if quite substantial tasks are run in parallel. Also, on Windows new threads are started with the default<a href="#FOOT42" id="DOCF42" class="footnote"><sup>42</sup></a> FPU control word, so computations done on OpenMP threads will not make use of extended-precision arithmetic which is the default for the main process.</p>
<p>Do not include these macros unless your code does make use of OpenMP (possibly for C++ via included external headers): this can result in the OpenMP runtime being linked in, threads being started, ….</p>
<p>Calling any of the R API from threaded code is ‘for experts only’ and strongly discouraged. Many functions in the R API modify internal R data structures and might corrupt these data structures if called simultaneously from multiple threads. Most R API functions can signal errors, which must only happen on the R main thread. Also, external libraries (e.g.&nbsp;LAPACK) may not be thread-safe.</p>
<p>Packages are not standard-alone programs, and an R process could contain more than one OpenMP-enabled package as well as other components (for example, an optimized BLAS) making use of OpenMP. So careful consideration needs to be given to resource usage. OpenMP works with parallel regions, and for most implementations the default is to use as many threads as ‘CPUs’ for such regions. Parallel regions can be nested, although it is common to use only a single thread below the first level. The correctness of the detected number of ‘CPUs’ and the assumption that the R process is entitled to use them all are both dubious assumptions. One way to limit resources is to limit the overall number of threads available to OpenMP in the R process: this can be done <em>via</em> environment variable <code class="env">OMP_THREAD_LIMIT</code>, where implemented.<a href="#FOOT43" id="DOCF43" class="footnote"><sup>43</sup></a> Alternatively, the number of threads per region can be limited by the environment variable <code class="env">OMP_NUM_THREADS</code> or API call <code class="code">omp_set_num_threads</code>, or, better, for the regions in your code as part of their specification. E.g. R uses<a href="#FOOT44" id="DOCF44" class="footnote"><sup>44</sup></a></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#pragma omp parallel for num_threads(nthreads) ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That way you only control your own code and not that of other OpenMP users.</p>
<p>Note that setting environment variables to control OpenMP is implementation-dependent and may need to be done outside the R process or before any use of OpenMP (which might be by another process or R itself). Also, implementation-specific variables such as <code class="env">KMP_THREAD_LIMIT</code> might take precedence.</p>
</section>
<section id="using-pthreads" class="level3 subsubsection" data-number="1.2.3">
<h3 class="subsubsection anchored" data-number="1.2.3" data-anchor-id="using-pthreads"><span class="header-section-number">1.2.3</span> Using pthreads <a href="#using-pthreads-1" class="copiable-link">¶</a></h3>
<p>There is no direct support for the POSIX threads (more commonly known as <code class="code">pthreads</code>): by the time we considered adding it several packages were using it unconditionally so it seems that nowadays it is universally available on POSIX operating systems.</p>
<p>For reasonably recent versions of <code class="command">gcc</code> and <code class="command">clang</code> the correct specification is</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>PKG_CPPFLAGS <span class="op">=</span> <span class="op">-</span>pthread</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> <span class="op">-</span>pthread</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(and the plural version is also accepted on some systems/versions). For other platforms the specification is</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>PKG_CPPFLAGS <span class="op">=</span> <span class="op">-</span>D_REENTRANT</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> <span class="op">-</span>lpthread</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(and note that the library name is singular). This is what <samp class="option">-pthread</samp> does on all known current platforms (although earlier versions of OpenBSD used a different library name).</p>
<p>For a tutorial see <a href="https://hpc-tutorials.llnl.gov/posix/" class="uref">https://hpc-tutorials.llnl.gov/posix/</a>.</p>
<p>POSIX threads are not normally used on Windows which has its own native concepts of threads: however, recent toolchains do provide the <code class="code">pthreads</code> header and library.</p>
<p>The presence of a working <code class="code">pthreads</code> implementation cannot be unambiguously determined without testing for yourself: however, that <samp class="samp">_REENTRANT</samp>’ is defined in C/C++ code is a good indication.</p>
<p>Note that not all <code class="code">pthreads</code> implementations are equivalent as parts are optional (see <a href="https://pubs.opengroup.org/onlinepubs/009695399/basedefs/pthread.h.html" class="uref">https://pubs.opengroup.org/onlinepubs/009695399/basedefs/pthread.h.html</a>): for example, macOS lacks the ‘Barriers’ option.</p>
<p>See also the comments on thread-safety and performance under OpenMP: on all known R platforms OpenMP is implemented <em>via</em> <code class="code">pthreads</code> and the known performance issues are in the latter.</p>
</section>
<section id="compiling-in-sub-directories" class="level3 subsubsection" data-number="1.2.4">
<h3 class="subsubsection anchored" data-number="1.2.4" data-anchor-id="compiling-in-sub-directories"><span class="header-section-number">1.2.4</span> Compiling in sub-directories <a href="#compiling-in-sub-directories-1" class="copiable-link">¶</a></h3>
<p>Package authors fairly often want to organize code in sub-directories of <samp class="file">src</samp>, for example if they are including a separate piece of external software to which this is an R interface.</p>
<p>One simple way is simply to set <code class="code">OBJECTS</code> to be all the objects that need to be compiled, including in sub-directories. For example, CRAN package <a href="https://CRAN.R-project.org/package=RSiena" class="url"><strong>RSiena</strong></a> has</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>SOURCES <span class="op">=</span> $<span class="op">(</span>wildcard data<span class="co">/*.cpp network/*.cpp utils/*.cpp model/*.cpp model/*/</span><span class="op">*.</span>cpp model<span class="co">/*/*/</span><span class="op">*.</span>cpp<span class="op">)</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>OBJECTS <span class="op">=</span> siena07utilities<span class="op">.</span>o siena07internals<span class="op">.</span>o siena07setup<span class="op">.</span>o siena07models<span class="op">.</span>o $<span class="op">(</span>SOURCES<span class="op">:.</span>cpp<span class="op">=.</span>o<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>One problem with that approach is that unless GNU make extensions are used, the source files need to be listed and kept up-to-date. As in the following from CRAN package <a href="https://CRAN.R-project.org/package=lossDev" class="url"><strong>lossDev</strong></a>:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="dt">OBJECTS.samplers</span> <span class="ch">=</span><span class="st"> samplers/ExpandableArray.o samplers/Knots.o </span><span class="ch">\</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="st">  samplers/RJumpSpline.o samplers/RJumpSplineFactory.o </span><span class="ch">\</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="st">  samplers/RealSlicerOV.o samplers/SliceFactoryOV.o samplers/MNorm.o</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="dt">OBJECTS.distributions</span> <span class="ch">=</span><span class="st"> distributions/DSpline.o </span><span class="ch">\</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="st">  distributions/DChisqrOV.o distributions/DTOV.o </span><span class="ch">\</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="st">  distributions/DNormOV.o distributions/DUnifOV.o distributions/RScalarDist.o</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="dt">OBJECTS.root</span> <span class="ch">=</span><span class="st"> RJump.o</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="dt">OBJECTS</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">OBJECTS.samplers</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">OBJECTS.distributions</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">OBJECTS.root</span><span class="ch">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Where the subdirectory is self-contained code with a suitable makefile, the best approach is something like</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> <span class="op">-</span>LCsdp<span class="op">/</span>lib <span class="op">-</span>lsdp $<span class="op">(</span>LAPACK_LIBS<span class="op">)</span> $<span class="op">(</span>BLAS_LIBS<span class="op">)</span> $<span class="op">(</span>FLIBS<span class="op">)</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>$<span class="op">(</span>SHLIB<span class="op">):</span> Csdp<span class="op">/</span>lib<span class="op">/</span>libsdp<span class="op">.</span>a</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>Csdp<span class="op">/</span>lib<span class="op">/</span>libsdp<span class="op">.</span>a<span class="op">:</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        @<span class="op">(</span>cd Csdp<span class="op">/</span>lib <span class="op">&amp;&amp;</span> $<span class="op">(</span>MAKE<span class="op">)</span> libsdp<span class="op">.</span>a \</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>          CC<span class="op">=</span><span class="st">"$(CC)"</span> CFLAGS<span class="op">=</span><span class="st">"$(CFLAGS) $(CPICFLAGS)"</span> AR<span class="op">=</span><span class="st">"$(AR)"</span> RANLIB<span class="op">=</span><span class="st">"$(RANLIB)"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note the quotes: the macros can contain spaces, e.g. <code class="code">CC = "gcc -m64 -std=gnu99"</code>. Several authors have forgotten about parallel makes: the static library in the subdirectory must be made before the shared object (<code class="code">$(SHLIB)</code>) and so the latter must depend on the former. Others forget the need<a href="#FOOT45" id="DOCF45" class="footnote"><sup>45</sup></a> for position-independent code.</p>
<p>We really do not recommend using <samp class="file">src/Makefile</samp> instead of <samp class="file">src/Makevars</samp>, and as the example above shows, it is not necessary.</p>
</section>
<section id="configure-example" class="level3 subsection" data-number="1.2.5">
<h3 class="subsection anchored" data-number="1.2.5" data-anchor-id="configure-example"><span class="header-section-number">1.2.5</span> Configure example <a href="#configure-example-1" class="copiable-link">¶</a></h3>
<p>It may be helpful to give an extended example of using a <samp class="file">configure</samp> script to create a <samp class="file">src/Makevars</samp> file: this is based on that in the <a href="https://CRAN.R-project.org/package=RODBC" class="url"><strong>RODBC</strong></a> package.</p>
<p>The <samp class="file">configure.ac</samp> file follows: <samp class="file">configure</samp> is created from this by running <code class="command">autoconf</code> in the top-level package directory (containing <samp class="file">configure.ac</samp>).</p>
<blockquote class="blockquote">
<div class="sourceCode" id="cb53"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_INIT</span><span class="er">(</span><span class="ex">[RODBC],</span> 1.1.8<span class="kw">)</span> <span class="ex">dnl</span> package name, version</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> A user-specifiable option</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="va">odbc_mgr</span><span class="op">=</span><span class="st">""</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_ARG_WITH</span><span class="er">(</span><span class="ex">[odbc-manager],</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>            <span class="ex">AC_HELP_STRING</span><span class="er">(</span><span class="ex">[--with-odbc-manager=MGR],</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                           <span class="ex">[specify</span> the ODBC manager, e.g. odbc or iodbc]<span class="kw">)</span><span class="ex">,</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>            <span class="ex">[odbc_mgr=</span><span class="va">$withval</span><span class="ex">]</span><span class="kw">)</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">test</span> <span class="st">"</span><span class="va">$odbc_mgr</span><span class="st">"</span> = <span class="st">"odbc"</span> <span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">AC_PATH_PROGS</span><span class="er">(</span><span class="ex">ODBC_CONFIG,</span> odbc_config<span class="kw">)</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> Select an optional include path, from a configure option</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> or from an environment variable.</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_ARG_WITH</span><span class="er">(</span><span class="ex">[odbc-include],</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>            <span class="ex">AC_HELP_STRING</span><span class="er">(</span><span class="ex">[--with-odbc-include=INCLUDE_PATH],</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>                           <span class="ex">[the</span> location of ODBC header files]<span class="kw">)</span><span class="ex">,</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>            <span class="ex">[odbc_include_path=</span><span class="va">$withval</span><span class="ex">]</span><span class="kw">)</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="va">RODBC_CPPFLAGS</span><span class="op">=</span><span class="st">"-I."</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">test</span> [ <span class="at">-n</span> <span class="st">"</span><span class="va">$odbc_include_path</span><span class="st">"</span> ] <span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>   <span class="va">RODBC_CPPFLAGS</span><span class="op">=</span><span class="st">"-I. -I</span><span class="va">${odbc_include_path}</span><span class="st">"</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">test</span> [ <span class="at">-n</span> <span class="st">"</span><span class="va">${ODBC_INCLUDE}</span><span class="st">"</span> ] <span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>     <span class="va">RODBC_CPPFLAGS</span><span class="op">=</span><span class="st">"-I. -I</span><span class="va">${ODBC_INCLUDE}</span><span class="st">"</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> ditto for a library path</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_ARG_WITH</span><span class="er">(</span><span class="ex">[odbc-lib],</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>            <span class="ex">AC_HELP_STRING</span><span class="er">(</span><span class="ex">[--with-odbc-lib=LIB_PATH],</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>                           <span class="ex">[the</span> location of ODBC libraries]<span class="kw">)</span><span class="ex">,</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>            <span class="ex">[odbc_lib_path=</span><span class="va">$withval</span><span class="ex">]</span><span class="kw">)</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">test</span> [ <span class="at">-n</span> <span class="st">"</span><span class="va">$odbc_lib_path</span><span class="st">"</span> ] <span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>   <span class="va">LIBS</span><span class="op">=</span><span class="st">"-L</span><span class="va">$odbc_lib_path</span><span class="st"> </span><span class="va">${LIBS}</span><span class="st">"</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">test</span> [ <span class="at">-n</span> <span class="st">"</span><span class="va">${ODBC_LIBS}</span><span class="st">"</span> ] <span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>     <span class="va">LIBS</span><span class="op">=</span><span class="st">"-L</span><span class="va">${ODBC_LIBS}</span><span class="st"> </span><span class="va">${LIBS}</span><span class="st">"</span></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">test</span> <span class="at">-n</span> <span class="st">"</span><span class="va">${ODBC_CONFIG}</span><span class="st">"</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>      <span class="va">odbc_lib_path</span><span class="op">=</span><span class="kw">`</span><span class="ex">odbc_config</span> <span class="at">--libs</span> <span class="kw">|</span> <span class="fu">sed</span> s/-lodbc//<span class="kw">`</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>      <span class="va">LIBS</span><span class="op">=</span><span class="st">"</span><span class="va">${odbc_lib_path}</span><span class="st"> </span><span class="va">${LIBS}</span><span class="st">"</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> Now find the compiler and compiler flags to use</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a><span class="bu">:</span> <span class="va">${R_HOME</span><span class="op">=</span><span class="kw">`</span><span class="ex">R</span> RHOME<span class="kw">`</span><span class="va">}</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">test</span> <span class="at">-z</span> <span class="st">"</span><span class="va">${R_HOME}</span><span class="st">"</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"could not determine R_HOME"</span></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>  <span class="bu">exit</span> 1</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a><span class="va">CC</span><span class="op">=</span><span class="kw">`</span><span class="st">"</span><span class="va">${R_HOME}</span><span class="st">/bin/R"</span> CMD config CC<span class="kw">`</span></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a><span class="va">CFLAGS</span><span class="op">=</span><span class="kw">`</span><span class="st">"</span><span class="va">${R_HOME}</span><span class="st">/bin/R"</span> CMD config CFLAGS<span class="kw">`</span></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a><span class="va">CPPFLAGS</span><span class="op">=</span><span class="kw">`</span><span class="st">"</span><span class="va">${R_HOME}</span><span class="st">/bin/R"</span> CMD config CPPFLAGS<span class="kw">`</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">test</span> <span class="at">-n</span> <span class="st">"</span><span class="va">${ODBC_CONFIG}</span><span class="st">"</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>  <span class="va">RODBC_CPPFLAGS</span><span class="op">=</span><span class="kw">`</span><span class="ex">odbc_config</span> <span class="at">--cflags</span><span class="kw">`</span></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a><span class="va">CPPFLAGS</span><span class="op">=</span><span class="st">"</span><span class="va">${CPPFLAGS}</span><span class="st"> </span><span class="va">${RODBC_CPPFLAGS}</span><span class="st">"</span></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> Check the headers can be found</span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_CHECK_HEADERS</span><span class="er">(</span><span class="ex">sql.h</span> sqlext.h<span class="kw">)</span></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">test</span> <span class="st">"</span><span class="va">${ac_cv_header_sql_h}</span><span class="st">"</span> = no <span class="kw">||</span></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>   <span class="bu">test</span> <span class="st">"</span><span class="va">${ac_cv_header_sqlext_h}</span><span class="st">"</span> = no<span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>   <span class="ex">AC_MSG_ERROR</span><span class="er">(</span><span class="st">"ODBC headers sql.h and sqlext.h not found"</span><span class="kw">)</span></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> search for a library containing an ODBC function</span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">test</span> [ <span class="at">-n</span> <span class="st">"</span><span class="va">${odbc_mgr}</span><span class="st">"</span> ] <span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>  <span class="ex">AC_SEARCH_LIBS</span><span class="er">(</span><span class="ex">SQLTables,</span> <span class="va">${odbc_mgr}</span>, ,</span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>      <span class="ex">AC_MSG_ERROR</span><span class="er">(</span><span class="st">"ODBC driver manager </span><span class="va">${odbc_mgr}</span><span class="st"> not found"</span><span class="kw">))</span></span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a>  <span class="ex">AC_SEARCH_LIBS</span><span class="er">(</span><span class="ex">SQLTables,</span> odbc odbc32 iodbc, ,</span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a>      <span class="ex">AC_MSG_ERROR</span><span class="er">(</span><span class="st">"no ODBC driver manager found"</span><span class="kw">))</span></span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> for 64-bit ODBC need SQL<span class="pp">[</span><span class="ss">U</span><span class="pp">]</span>LEN, and it is unclear where they are defined.</span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_CHECK_TYPES</span><span class="er">(</span><span class="ex">[SQLLEN,</span> SQLULEN], , , [# include <span class="op">&lt;</span>sql.h<span class="op">&gt;</span>]<span class="kw">)</span></span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> for unixODBC header</span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_CHECK_SIZEOF</span><span class="er">(</span><span class="ex">long,</span> 4<span class="kw">)</span></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> substitute RODBC_CPPFLAGS and LIBS</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_SUBST</span><span class="er">(</span><span class="ex">RODBC_CPPFLAGS</span><span class="kw">)</span></span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_SUBST</span><span class="er">(</span><span class="ex">LIBS</span><span class="kw">)</span></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_CONFIG_HEADERS</span><span class="er">(</span><span class="ex">[src/config.h]</span><span class="kw">)</span></span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a><span class="ex">dnl</span> and do substitution in the src/Makevars.in and src/config.h</span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_CONFIG_FILES</span><span class="er">(</span><span class="ex">[src/Makevars]</span><span class="kw">)</span></span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a><span class="ex">AC_OUTPUT</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</blockquote>
<p>where <samp class="file">src/Makevars.in</samp> would be simply</p>
<blockquote class="blockquote">
<div class="sourceCode" id="cb54"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>PKG_CPPFLAGS <span class="op">=</span> @RODBC_CPPFLAGS@</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> @LIBS@</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</blockquote>
<p>A user can then be advised to specify the location of the ODBC driver manager files by options like (lines broken for easier reading)</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD INSTALL <span class="dt">\</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--configure-args</span><span class="op">=</span><span class="st">'--with-odbc-include=/opt/local/include \</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="st">  --with-odbc-lib=/opt/local/lib --with-odbc-manager=iodbc'</span> <span class="dt">\</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  RODBC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or by setting the environment variables <code class="code">ODBC_INCLUDE</code> and <code class="code">ODBC_LIBS</code>.</p>
</section>
<section id="using-modern-fortran-code" class="level3 subsection" data-number="1.2.6">
<h3 class="subsection anchored" data-number="1.2.6" data-anchor-id="using-modern-fortran-code"><span class="header-section-number">1.2.6</span> Using modern Fortran code <a href="#using-modern-fortran-code-1" class="copiable-link">¶</a></h3>
<p>R assumes that source files with extension <samp class="file">.f</samp> are fixed-form Fortran 90 (which includes Fortran 77), and passes them to the compiler specified by macro <samp class="samp">FC</samp>’. The Fortran compiler will also accept free-form Fortran 90/95 code with extension <samp class="file">.f90</samp> or (most<a href="#FOOT46" id="DOCF46" class="footnote"><sup>46</sup></a>) <samp class="file">.f95</samp>.</p>
<p>The same compiler is used for both fixed-form and free-form Fortran code (with different file extensions and possibly different flags). Macro <code class="code">PKG_FFLAGS</code> can be used for package-specific flags: for the un-encountered case that both are included in a single package and that different flags are needed for the two forms, macro <code class="code">PKG_FCFLAGS</code> is also available for free-form Fortran.</p>
<p>The code used to build R allows a ‘Fortran 90’ compiler to be selected as <samp class="samp">FC</samp>’, so platforms might be encountered which only support Fortran 90. However, Fortran 95 is supported on all known platforms.</p>
<p>Most compilers specified by <samp class="samp">FC</samp>’ will accept most Fortran 2003, 2008 or 2018 code: such code should still use file extension <samp class="file">.f90</samp>. Most current platforms use <code class="command">gfortran</code> where you might need to include <samp class="option">-std=f2003</samp>, <samp class="option">-std=f2008</samp> or (from version 8) <samp class="option">-std=f2018</samp> in <code class="code">PKG_FFLAGS</code> or <code class="code">PKG_FCFLAGS</code>: the default is ‘GNU Fortran’, currently Fortran 2018 (but Fortran 95 prior to <code class="command">gfortran</code>&nbsp;8) with non-standard extensions. The other compilers in current use (LLVM’s <code class="command">flang-new</code> and Intel’s <code class="command">ifx</code>) default to Fortran 2018<a href="#FOOT47" id="DOCF47" class="footnote"><sup>47</sup></a>.</p>
<p>It is good practice to describe a Fortran version requirement in <samp class="file">DESCRIPTION</samp>‘s <samp class="samp">SystemRequirements</samp>’ field. Note that this is purely for information: the package also needs a <code class="command">configure</code> script to determine the compiler and set appropriate option(s) and test that the features needed from the standard are actually supported.</p>
<p>The Fortran 2023 released in Nov 2023: as usual compiler vendors are introducing support incrementally. For Intel’s <code class="command">ifx</code> see <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/fortran-language-and-openmp-features-in-ifx.html#Fortran%20Standards" class="uref">https://www.intel.com/content/www/us/en/developer/articles/technical/fortran-language-and-openmp-features-in-ifx.html#Fortran%20Standards</a>. For LLVM’s <code class="command">flang-new</code> see <a href="https://flang.llvm.org/docs/F202X.html" class="uref">https://flang.llvm.org/docs/F202X.html</a>. <code class="code">gfortran</code> does not have complete support even for the 2008 and 2018 standards, but the option <samp class="option">-std=f2023</samp> is supported from version 14.1.</p>
<p>Modern versions of Fortran support modules, whereby compiling one source file creates a module file which is then included in others. (Module files typically have a <samp class="file">.mod</samp> extension: they do depend on the compiler used and so should never be included in a package.) This creates a dependence which <code class="command">make</code> will not know about and often causes installation with a parallel make to fail. Thus it is necessary to add explicit dependencies to <samp class="file">src/Makevars</samp> to tell <code class="command">make</code> the constraints on the order of compilation. For example, if file <samp class="file">iface.f90</samp> creates a module <samp class="samp">iface</samp>’ used by files <samp class="file">cmi.f90</samp> and <samp class="file">dmi.f90</samp> then <samp class="file">src/Makevars</samp> needs to contain something like</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="dv">cmi.o dmi.o:</span><span class="dt"> iface.o</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Some maintainers have found it difficult to find <em>all</em> the module dependencies which leads to hard-to-reproduce installation failures. There are tools available to find these, including the Intel compiler’s flag <samp class="option">-gen-dep</samp> and <code class="code">makedepf90</code>.</p>
<p>Note that it is not portable (although some platforms do accept it) to define a module of the same name in multiple source files.</p>
</section>
<section id="using-c-code" class="level3 subsection" data-number="1.2.7">
<h3 class="subsection anchored" data-number="1.2.7" data-anchor-id="using-c-code"><span class="header-section-number">1.2.7</span> Using C++ code <a href="#using-c-code-1" class="copiable-link">¶</a></h3>
<p>R can be built without a C++ compiler although one is available (but not necessarily installed) on all known R platforms. As from R 4.0.0 a C++ compiler will be selected only if it conforms to the 2011 standard (‘C++11’). A minor update<a href="#FOOT48" id="DOCF48" class="footnote"><sup>48</sup></a> (‘C++14’) was published in December 2014 and was used by default as from R 4.1.0 if supported. Further revisions ‘C++17’ (in December 2017) and ‘C++20’ (with many new features in December 2020) have been published since. The next revision, ‘C++23’, is expected in 2024 and several compilers already have extensive partial support for the final draft.</p>
<p>The default standard for compiling R packages was changed to C++17 in R 4.3.0 if supported, and from R 4.4.0 only a C++17 compiler will be selected as the default C++ compiler.</p>
<p>What standard a C++ compiler aims to support can be hard to determine: the value<a href="#FOOT49" id="DOCF49" class="footnote"><sup>49</sup></a> of <code class="code">__cplusplus</code> may help but some compilers use it to denote a standard which is partially supported and some the latest standard which is (almost) fully supported. On a Unix-alike <code class="command">configure</code> will try to identify a compiler and flags for each of the standards: this relies heavily on the reported values of <code class="code">__cplusplus</code>.</p>
<p>The webpage <a href="https://en.cppreference.com/w/cpp/compiler_support" class="uref">https://en.cppreference.com/w/cpp/compiler_support</a> gives some information on which compilers are known to support recent C++ features.</p>
<p>C++ standards have deprecated and later removed features. Be aware that some current compilers still accept removed features in C++17 mode, such as <code class="code">std::unary_function</code> (deprecated in C++11, removed in C++17).</p>
<p>Different versions of R have used different default C++ standards, so for maximal portability a package should specify the standard it requires. In order to specify C++14 code in a package with a <samp class="file">Makevars</samp> file (or <samp class="file">Makevars.win</samp> or <samp class="file">Makevars.ucrt</samp> on Windows) should include the line</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX_STD</span> <span class="ch">=</span><span class="st"> CXX14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Compilation and linking will then be done with the C++14 compiler (if any). Analogously for other standards (details below). On the other hand, specifying C++11<a href="#FOOT50" id="DOCF50" class="footnote"><sup>50</sup></a> when the code is valid under C++14 or C++17 reduces future portability.</p>
<p>Packages without a <samp class="file">src/Makevars</samp> or <samp class="file">src/Makefile</samp> file may specify a C++ standard for code in the <samp class="file">src</samp> directory by including something like <samp class="samp">C++14</samp>’ in the <samp class="samp">SystemRequirements</samp>’ field of the <samp class="file">DESCRIPTION</samp> file, e.g.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>SystemRequirements: C++14</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If a package does have a <samp class="file">src/Makevars[.win]</samp> file then also setting the make variable <samp class="samp">CXX_STD</samp>’ there is recommended, as it allows <code class="command">R CMD SHLIB</code> to work correctly in the package’s <samp class="file">src</samp> directory.</p>
<p>A requirement of C++17 or later should always be declared in the <samp class="samp">SystemRequirements</samp>’ field (as well as in <samp class="file">src/Makevars</samp> or <samp class="file">src/Makefile</samp>) so this is shown on the package’s summary pages on CRAN or similar. This is also good practice for a requirement of C++14. Note that support of C++14 or C++17 is only available from R 3.4.0, so if the package has an R version requirement it needs to take that into account.</p>
<p>Essentially complete C++14 support is available from GCC 5, LLVM <code class="command">clang</code> 3.4 and currently-used versions of Apple <code class="command">clang</code>.</p>
<p>Code needing C++14 features can check for their presence <em>via</em> ‘SD-6 feature tests’<a href="#FOOT51" id="DOCF51" class="footnote"><sup>51</sup></a>. Such a check could be</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;memory&gt;</span><span class="pp"> </span><span class="co">// header where this is defined</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined(__cpp_lib_make_unique) &amp;&amp; (__cpp_lib_make_unique &gt;= 201304)</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>using std<span class="op">::</span>make_unique<span class="op">;</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co">// your emulation</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>C++17 (as from R 3.4.0), C++20 (as from R 4.0.0) and C++23 (as from R 4.3.0) can be specified in an analogous way (replacing <code class="code">14</code> by <code class="code">17</code>, <code class="code">20</code> or <code class="code">23</code>) but compiler/OS support is platform-dependent. Some C++17 and C++20 support is available with the default builds of R on macOS and Windows as from R 4.0.0. Much of <code class="command">g++</code>‘s support for C++17 needs version 7 or later: that is more recent than some still-current Linux distributions but often packages for later compilers are available: for RHEL/Centos 7 look for ’devtoolset’.</p>
<p>Note that C++17 or later ‘support’ does not mean complete support: use feature tests as well as resources such as <a href="https://en.cppreference.com/w/cpp/compiler_support" class="uref">https://en.cppreference.com/w/cpp/compiler_support</a>, <a href="https://gcc.gnu.org/projects/cxx-status.html" class="uref">https://gcc.gnu.org/projects/cxx-status.html</a> and <a href="https://clang.llvm.org/cxx_status.html" class="uref">https://clang.llvm.org/cxx_status.html</a> to see if the features you want to use are widely implemented. In particular, for C++23 R’s <code class="command">configure</code> script only checks for a compiler claiming to be later than C++20.<a href="#FOOT52" id="DOCF52" class="footnote"><sup>52</sup></a></p>
<p>Attempts to specify an unknown C++ standard are silently ignored: recent versions of R throw an error for C++98 and for known standards for which no compiler+flags has been detected.</p>
<p>If a package using C++ has a <code class="command">configure</code> script it is essential that the script selects the correct C++ compiler and standard, <em>via</em> something like</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX17</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX17`</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>if test -z <span class="st">"</span><span class="ch">$C</span><span class="st">XX17"</span>; then</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  AC_MSG_ERROR([No C++17 compiler is available])</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>fi</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX17STD</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX17STD`</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX</span><span class="ch">=</span><span class="st">"</span><span class="ch">${</span><span class="dt">CXX17</span><span class="ch">}</span><span class="st"> </span><span class="ch">${</span><span class="dt">CXX17STD</span><span class="ch">}</span><span class="st">"</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="dt">CXXFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX17FLAGS`</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="co">## for an configure.ac file</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>AC_LANG(C++)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>if C++17 was specified, but using</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX`</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="dt">CXXFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXXFLAGS`</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co">## for an configure.ac file</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>AC_LANG(C++)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>if no standard was specified.</p>
<p>If you want to compile C++ code in a subdirectory, make sure you pass down the macros to specify the appropriate compiler, e.g.&nbsp;in <samp class="file">src/Makevars</samp></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="dv">sublibs:</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="er">         </span><span class="ch">@</span><span class="fu">(cd libs &amp;&amp; </span><span class="ch">$(</span><span class="dt">MAKE</span><span class="ch">)</span><span class="fu"> </span><span class="ch">\</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">            CXX=</span><span class="st">"</span><span class="ch">$(</span><span class="dt">CXX17</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">CXX17STD</span><span class="ch">)</span><span class="st">"</span><span class="fu"> CXXFLAGS=</span><span class="st">"</span><span class="ch">$(</span><span class="dt">CXX17FLAGS</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">CXX17PICFLAGS</span><span class="ch">)</span><span class="st">"</span><span class="fu">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The discussion above is about the standard R ways of compiling C++: it will not apply to packages using <samp class="file">src/Makefile</samp> or building in a subdirectory that do not set the C++ standard. And compilers’ default C++ standards varies widely and gets changed frequently by vendors – for example Apple clang up to at least 16 defaults to C++98, LLVM clang 14–15 to C++14, LLVM clang 16–18 to C++17 and <code class="command">g++</code> 11–14 to C++17.</p>
<p>For a package with a <samp class="file">src/Makefile</samp> (or a Windows analogue), a non-default C++ compiler can be selected by including something like</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX14</span> <span class="ch">=</span><span class="st"> `"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX14`</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX14STD</span> <span class="ch">=</span><span class="st"> `"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX14STD`</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX</span> <span class="ch">=</span><span class="st"> </span><span class="ch">${</span><span class="dt">CXX14</span><span class="ch">}</span><span class="st"> </span><span class="ch">${</span><span class="dt">CXX14STD</span><span class="ch">}</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="dt">CXXFLAGS</span> <span class="ch">=</span><span class="st"> `"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX14FLAGS`</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="dt">CXXPICFLAGS</span> <span class="ch">=</span><span class="st"> `"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX14PICFLAGS`</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="dt">SHLIB_LD</span> <span class="ch">=</span><span class="st"> "</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config SHLIB_CXX14LD`</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="dt">SHLIB_LDFLAGS</span> <span class="ch">=</span><span class="st"> "</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config SHLIB_CXX14LDFLAGS`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and ensuring these values are used in relevant compilations, after checking they are non-empty. A common use of <samp class="file">src/Makefile</samp> is to compile an executable, when likely something like (for example for C++14)</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX14</span> <span class="ch">=</span><span class="st"> `"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX14`</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX14STD</span> <span class="ch">=</span><span class="st"> `"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX14STD`</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX</span> <span class="ch">=</span><span class="st"> </span><span class="ch">${</span><span class="dt">CXX14</span><span class="ch">}</span><span class="st"> </span><span class="ch">${</span><span class="dt">CXX14STD</span><span class="ch">}</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="dt">CXXFLAGS</span> <span class="ch">=</span><span class="st"> `"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CXX14FLAGS`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>suffices. On Unix (and on Windows from R 4.3.0) this can be simplified to</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX</span> <span class="ch">=</span><span class="st"> </span><span class="ch">${</span><span class="dt">CXX14</span><span class="ch">}</span><span class="st"> </span><span class="ch">${</span><span class="dt">CXX14STD</span><span class="ch">}</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="dt">CXXFLAGS</span> <span class="ch">=</span><span class="st"> </span><span class="ch">${</span><span class="dt">CXX14FLAGS</span><span class="ch">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On a Unix-alike C++ compilation defaulted to C++11 from R 3.6.0, to C++14 from R 4.1.0 and to C++17 from R 4.3.0. However, only ‘if available’, so platforms using very old OSes might have used the previous default. Even older versions of R defaulted to the compiler’s default, almost certainly C++98 for compilers of comparable vintage.</p>
<p>On Windows the default was changed from C++98 to C++11 in R 3.6.2, to C++14 in R 4.2.3 and to C++17 in R 4.3.0.</p>
<p>The C++11 standard could be specified as from R 3.1.0 and C++14 or C++17 as from R 3.4.0, for C++20 from R 4.0.0 and for C++23 from R 4.3.0 (although they may not be supported by the compilers in use). C++11 support became mandatory in R 4.0.0 and C++17 support in R 4.4.0.</p>
<p>The <samp class="file">.so</samp>/<samp class="file">.dll</samp> in a package may need to be linked by the C++ compiler if it or any library it links to contains compiled C++ code. Dynamic linking usually brings in the C++ runtime library (commonly <code class="code">libstdc++</code> but can be, for example, <code class="code">libc++</code>) but static linking (as used for external libraries on Windows and macOS) will not. <code class="command">R CMD INSTALL</code> will link with the C++ compiler if there are any top-level C++ files in <samp class="file">src</samp>, but not if these are all in subdirectories. The simplest way to force linking by the C++ compiler is to include an empty C++ file in <samp class="file">src</samp>..</p>
</section>
<section id="c-standards" class="level3 subsection" data-number="1.2.8">
<h3 class="subsection anchored" data-number="1.2.8" data-anchor-id="c-standards"><span class="header-section-number">1.2.8</span> C standards <a href="#c-standards-1" class="copiable-link">¶</a></h3>
<p>C has had standards C89/C90, C99, C11, C17 (also known as C18), and C23 (published in 2024). C11 was a minor change to C99 which introduced some new features and made others optional, and C17 is a ‘bug-fix’ update to C11. On the other hand, C23 makes extensive changes, including making <code class="code">bool</code>, <code class="code">true</code> and <code class="code">false</code> reserved words, finally disallowing K&amp;R-style function declarations and clarifying the formerly deprecated meaning of function declarations with an empty parameter list to mean zero parameters. (There are many other additions: see for example <a href="https://en.cppreference.com/w/c/23" class="uref">https://en.cppreference.com/w/c/23</a>.)</p>
<p>The <code class="command">configure</code> script in recent versions of R aims to choose a C compiler which supports C11: as the default in recent versions of <code class="command">gcc</code>, LLVM <code class="command">clang</code> and Apple <code class="command">clang</code> is C17, that is what is likely to be chosen. On the other hand, until R 4.3.0 the makefiles for the Windows build specified C99. They now use the compiler default which for the recommended compiler is C17.</p>
<p>Packages may want to either avoid or embrace the changes in C23, and can do so <em>via</em> specifying <samp class="samp">USE_Cnn</samp>’ for 17, 23, 90 or 99 in the <samp class="samp">SystemRequirements</samp>’ field of their <samp class="file">DESCRIPTION</samp> file of a package depending on <samp class="samp">R (&gt;= 4.3.0)</samp>’. Those using a <code class="command">configure</code> script should set the corresponding compiler and flags, for example using</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CC</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CC23`</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config C23FLAGS`</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="dt">CPPFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CPPFLAGS`</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="dt">LDFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config LDFLAGS`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The (claimed) C standard in use can be checked by the macro <code class="code">__STDC_VERSION__</code>. This is undefined in C89/C90 and should have values <code class="code">199901L</code>, <code class="code">201112L</code> and <code class="code">201710L</code> for C99, C11 and C17. The definitive value for C23 is <code class="code">202311L</code> but some compilers<a href="#FOOT53" id="DOCF53" class="footnote"><sup>53</sup></a> are currently using <code class="code">202000L</code> and requiring the standard to be specified as <code class="code">c2x</code>. C23 has macros similar to C++ ‘feature tests’ for many of its changes, for example <code class="code">__STDC_VERSION_LIMITS_H__</code>.</p>
<p>However, note the ‘claimed’ as no compiler had 100% conformance, and it is better to use <code class="command">configure</code> to test for the feature you want to use than to condition on the value of <code class="code">__STDC_VERSION__</code>. In particular, C11 alignment functionality such as <code class="code">_Alignas</code> and <code class="code">aligned_alloc</code> is not implemented on Windows.</p>
<p>End users can specify a standard by something like <code class="command">R CMD INSTALL --use-C17</code>. This overrides the <samp class="samp">SystemRequirements</samp>’ field, but not for any <code class="command">configure</code> file.</p>
</section>
<section id="using-cmake" class="level3 subsection" data-number="1.2.9">
<h3 class="subsection anchored" data-number="1.2.9" data-anchor-id="using-cmake"><span class="header-section-number">1.2.9</span> Using <code class="command">cmake</code> <a href="#using-cmake-1" class="copiable-link">¶</a></h3>
<p>Packages often wish to include the sources of other software and compile that for inclusion in their <samp class="file">.so</samp> or <samp class="file">.dll</samp>, which is normally done by including (or unpacking) the sources in a subdirectory of <samp class="file">src</samp>, as considered above.</p>
<p>Further issues arise when the external software uses another build system such as <code class="command">cmake</code>, principally to ensure that <em>all</em> the settings for compilers, include and load paths <em>etc</em> are made. This section has already mentioned the need to set at least some of</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>CC CFLAGS CXX CXXFLAGS CPPFLAGS LDFLAGS</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code class="code">CFLAGS</code> and <code class="code">CXXFLAGS</code> will need to include <code class="code">CPICFLAGS</code> and <code class="code">CXXPICFLAGS</code> respectively unless (as below) <code class="command">cmake</code> is asked to generate PIC code.</p>
<p>Setting these (and more) as environment variables controls the behaviour of <code class="command">cmake</code> (<a href="https://cmake.org/cmake/help/latest/manual/cmake-env-variables.7.html#manual:cmake-env-variables(7)" class="uref">https://cmake.org/cmake/help/latest/manual/cmake-env-variables.7.html#manual:cmake-env-variables(7)</a>), but it may be desirable to translate these into native settings such as</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>CMAKE_C_COMPILER</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>CMAKE_C_FLAGS</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>CMAKE_CXX_COMPILER</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>CMAKE_CXX_FLAGS</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>CMAKE_INCLUDE_PATH</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>CMAKE_LIBRARY_PATH</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>CMAKE_SHARED_LINKER_FLAGS_INIT</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>CMAKE_OSX_DEPLOYMENT_TARGET</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and it is often necessary to ensure a static library of PIC code is built by</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span>DBUILD_SHARED_LIBS<span class="sc">:</span>bool<span class="ot">=</span>OFF</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span>DCMAKE_POSITION_INDEPENDENT_CODE<span class="sc">:</span>bool<span class="ot">=</span>ON</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If R is to be detected or used, this must be the build being used for package installation – <code class="command">"${R_HOME}"/bin/R</code>.</p>
<p>To fix ideas, consider a package with sources for a library <samp class="file">myLib</samp> under <samp class="file">src/libs</samp>. Two approaches have been used. It is often most convenient to build the external software in a directory other than its sources (particularly during development when the build directory can be removed between builds rather than attempting to clean the sources) – this is illustrated in the first approach.</p>
<ol type="1">
<li><p>Use the package’s <samp class="file">configure</samp> script to create a static library <samp class="file">src/build/libmyLib.a</samp>. This can then be treated in the same way as external software, for example having in <samp class="file">src/Makevars</samp></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>PKG_CPPFLAGS <span class="op">=</span> <span class="op">-</span>Ilibs<span class="op">/</span>include</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> build<span class="op">/</span>libmyLib<span class="op">.</span>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(<code class="code">-Lbuild -lmyLib</code> could also be used but this explicit specification avoids any confusion with dynamic libraries of the same name.)</p>
<p>The <samp class="file">configure</samp> script will need to contain something like (for C code)</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>: <span class="ch">${</span><span class="dt">R_HOME</span><span class="er">=</span><span class="dt">`R</span><span class="er"> </span><span class="dt">RHOME`</span><span class="ch">}</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>if test -z <span class="st">"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">"</span>; then</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  echo <span class="st">"could not determine R_HOME"</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  exit 1</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>fi</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="dt">CC</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CC`</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CFLAGS`</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="dt">CPPFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config CPPFLAGS`</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="dt">LDFLAGS</span><span class="ch">=</span><span class="st">`"</span><span class="ch">${</span><span class="dt">R_HOME</span><span class="ch">}</span><span class="st">/bin/R" CMD config LDFLAGS`</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>cd src</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>mkdir build &amp;&amp; cd build</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="dv">cmake -S ../libs </span><span class="ch">\</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>  -DCMAKE_BUILD_TYPE=Release \</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>  <span class="ch">-</span><span class="fu">DBUILD_SHARED_LIBS:bool=OFF </span><span class="ch">\</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="fu">  -DCMAKE_POSITION_INDEPENDENT_CODE:bool=ON</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="ch">${</span><span class="dt">MAKE</span><span class="ch">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Use <samp class="file">src/Makevars</samp> (or <samp class="file">src/Makevars.win</samp> or <samp class="file">Makevars.ucrt</samp>) to build within the subdirectory. This could be something like (for C code)</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>PKG_CPPFLAGS <span class="op">=</span> <span class="op">-</span>Ilibs<span class="op">/</span>include</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>PKG_LIBS <span class="op">=</span> libs<span class="op">/</span>libmyLib<span class="op">.</span>a</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>$<span class="op">(</span>SHLIB<span class="op">):</span> mylibs</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>mylibs<span class="op">:</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>cd libs<span class="op">;</span> \</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>          CC<span class="op">=</span><span class="st">"$(CC)"</span> CFLAGS<span class="op">=</span><span class="st">"$(CFLAGS)"</span> \</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>          CPPFLAGS<span class="op">=</span><span class="st">"$(CPPFLAGS)"</span> LDFLAGS<span class="op">=</span><span class="st">"$(LDFLAGS)"</span> \</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>          cmake <span class="op">.</span> \</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span>DCMAKE_BUILD_TYPE<span class="op">=</span>Release \</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span>DBUILD_SHARED_LIBS<span class="op">:</span><span class="dt">bool</span><span class="op">=</span>OFF \</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span>DCMAKE_POSITION_INDEPENDENT_CODE<span class="op">:</span><span class="dt">bool</span><span class="op">=</span>ON<span class="op">;</span> \</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>          $<span class="op">(</span>MAKE<span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>the compiler and other settings having been set as Make variables by an R makefile included by <code class="command">INSTALL</code> before <samp class="file">src/Makevars</samp>.</p></li>
</ol>
<p>A complication is that on macOS <code class="command">cmake</code> (where installed) is commonly not on the path but at <samp class="file">/Applications/CMake.app/Contents/bin/cmake</samp>. One way to work around this is for the package’s <samp class="file">configure</samp> script to include</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> test <span class="sc">-</span>z <span class="st">"$CMAKE"</span>; then CMAKE<span class="ot">=</span><span class="st">"`which cmake`"</span>; fi</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> test <span class="sc">-</span>z <span class="st">"$CMAKE"</span>; then CMAKE<span class="ot">=</span><span class="er">/</span>Applications<span class="sc">/</span>CMake.app<span class="sc">/</span>Contents<span class="sc">/</span>bin<span class="sc">/</span>cmake; fi</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> test <span class="sc">-</span>f <span class="st">"$CMAKE"</span>; then echo <span class="st">"no 'cmake' command found"</span>; exit <span class="dv">1</span>; fi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and for the second approach to substitute <code class="env">CMAKE</code> into <samp class="file">src/Makevars</samp>. This also applies to the ancillary command <code class="command">ctest</code>, if used.</p>
</section>
</section>
<section id="checking-and-building-packages" class="level2 section" data-number="1.3">
<h2 class="section anchored" data-number="1.3" data-anchor-id="checking-and-building-packages"><span class="header-section-number">1.3</span> Checking and building packages <a href="#checking-and-building-packages-1" class="copiable-link">¶</a></h2>
<p>Before using these tools, please check that your package can be installed. <code class="code">R CMD check</code> will <em>inter alia</em> do this, but you may get more detailed error messages doing the install directly.</p>
<p>If your package specifies an encoding in its <samp class="file">DESCRIPTION</samp> file, you should run these tools in a locale which makes use of that encoding: they may not work at all or may work incorrectly in other locales (although UTF-8 locales will most likely work).</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> <code class="code">R CMD check</code> and <code class="code">R CMD build</code> run R processes with <samp class="option">--vanilla</samp> in which none of the user’s startup files are read. If you need <code class="env">R_LIBS</code> set (to find packages in a non-standard library) you can set it in the environment: also you can use the check and build environment files (as specified by the environment variables <code class="env">R_CHECK_ENVIRON</code> and <code class="env">R_BUILD_ENVIRON</code>; if unset, files<a href="#FOOT54" id="DOCF54" class="footnote"><sup>54</sup></a> <samp class="file">~/.R/check.Renviron</samp> and <samp class="file">~/.R/build.Renviron</samp> are used) to set environment variables when using these utilities.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Note to Windows users:</strong> <code class="code">R CMD build</code> may make use of the Windows toolset (see <a href="https://cran.r-project.org/doc/manuals/R-admin.html#The-Windows-toolset" data-manual="R-admin">The Windows toolset</a> in R Installation and Administration) if present and in your path, and it is required for packages which need it to install (including those with <samp class="file">configure.win</samp>, <samp class="file">cleanup.win</samp>, <samp class="file">configure.ucrt</samp> or <samp class="file">cleanup.ucrt</samp> scripts or a <samp class="file">src</samp> directory) and e.g.&nbsp;need vignettes built.</p>
<p>You may need to set the environment variable <code class="env">TMPDIR</code> to point to a suitable writable directory with a path not containing spaces – use forward slashes for the separators. Also, the directory needs to be on a case-honouring file system (some network-mounted file systems are not).</p>
</blockquote>
<section id="checking-packages" class="level3 subsection" data-number="1.3.1">
<h3 class="subsection anchored" data-number="1.3.1" data-anchor-id="checking-packages"><span class="header-section-number">1.3.1</span> Checking packages <a href="#checking-packages-1" class="copiable-link">¶</a></h3>
<p><span id="index-Checking-packages" class="index-entry-id"></span> <span id="index-R-CMD-check" class="index-entry-id"></span></p>
<p>Using <code class="code">R CMD check</code>, the R package checker, one can test whether <em>source</em> R packages work correctly. It can be run on one or more directories, or compressed package <code class="command">tar</code> archives with extension <samp class="file">.tar.gz</samp>, <samp class="file">.tgz</samp>, <samp class="file">.tar.bz2</samp> or <samp class="file">.tar.xz</samp>.</p>
<p>It is strongly recommended that the final checks are run on a <code class="command">tar</code> archive prepared by <code class="command">R CMD build</code>.</p>
<p>This runs a series of checks, including</p>
<ol type="1">
<li><p>The package is installed. This will warn about missing cross-references and duplicate aliases in help files.</p></li>
<li><p>The file names are checked to be valid across file systems and supported operating system platforms.</p></li>
<li><p>The files and directories are checked for sufficient permissions (Unix-alikes only).</p></li>
<li><p>The files are checked for binary executables, using a suitable version of <code class="command">file</code> if available<a href="#FOOT55" id="DOCF55" class="footnote"><sup>55</sup></a>. (There may be rare false positives.)</p></li>
<li><p>The <samp class="file">DESCRIPTION</samp> file is checked for completeness, and some of its entries for correctness. Unless installation tests are skipped, checking is aborted if the package dependencies cannot be resolved at run time. (You may need to set <code class="env">R_LIBS</code> in the environment if dependent packages are in a separate library tree.) One check is that the package name is not that of a standard package, nor one of the defunct standard packages (<samp class="samp">ctest</samp>‘, <samp class="samp">eda</samp>’, <samp class="samp">lqs</samp>‘, <samp class="samp">mle</samp>’, <samp class="samp">modreg</samp>‘, <samp class="samp">mva</samp>’, <samp class="samp">nls</samp>‘, <samp class="samp">stepfun</samp>’ and <samp class="samp">ts</samp>‘). Another check is that all packages mentioned in <code class="code">library</code> or <code class="code">require</code>s or from which the <samp class="file">NAMESPACE</samp> file imports or are called <em>via</em> <code class="code">::</code> or <code class="code">:::</code> are listed (in <samp class="samp">Depends</samp>’, <samp class="samp">Imports</samp>‘, <samp class="samp">Suggests</samp>’): this is not an exhaustive check of the actual imports.</p></li>
<li><p>Available index information (in particular, for demos and vignettes) is checked for completeness.</p></li>
<li><p>The package subdirectories are checked for suitable file names and for not being empty. The checks on file names are controlled by the option <samp class="option">--check-subdirs=</samp><var class="var">value</var>. This defaults to <samp class="samp">default</samp>‘, which runs the checks only if checking a tarball: the default can be overridden by specifying the value as <samp class="samp">yes</samp>’ or <samp class="samp">no</samp>‘. Further, the check on the <samp class="file">src</samp> directory is only run if the package does not contain a <samp class="file">configure</samp> script (which corresponds to the value <samp class="samp">yes-maybe</samp>’) and there is no <samp class="file">src/Makefile</samp> or <samp class="file">src/Makefile.in</samp>.</p>
<p>To allow a <samp class="file">configure</samp> script to generate suitable files, files ending in <samp class="samp">.in</samp>’ will be allowed in the <samp class="file">R</samp> directory.</p>
<p>A warning is given for directory names that look like R package check directories – many packages have been submitted to CRAN containing these.</p></li>
<li><p>The R files are checked for syntax errors. Bytes which are non-ASCII are reported as warnings, but these should be regarded as errors unless it is known that the package will always be used in the same locale.</p></li>
<li><p>It is checked that the package can be loaded, first with the usual default packages and then only with package <strong>base</strong> already loaded. It is checked that the namespace can be loaded in an empty session with only the <strong>base</strong> namespace loaded. (Namespaces and packages can be loaded very early in the session, before the default packages are available, so packages should work then.)</p></li>
<li><p>The R files are checked for correct calls to <code class="code">library.dynam</code>. Package startup functions are checked for correct argument lists and (incorrect) calls to functions which modify the search path or inappropriately generate messages. The R code is checked for possible problems using <a href="https://CRAN.R-project.org/package=codetools" class="url"><strong>codetools</strong></a>. In addition, it is checked whether S3 methods have all the arguments of the corresponding generic, and whether the final argument of replacement functions is called <samp class="samp">value</samp>’. All foreign function calls (<code class="code">.C</code>, <code class="code">.Fortran</code>, <code class="code">.Call</code> and <code class="code">.External</code> calls) are tested to see if they have a <code class="code">PACKAGE</code> argument, and if not, whether the appropriate DLL might be deduced from the namespace of the package. Any other calls are reported. (The check is generous, and users may want to supplement this by examining the output of <code class="code">tools::checkFF("mypkg", verbose=TRUE)</code>, especially if the intention were to always use a <code class="code">PACKAGE</code> argument)</p></li>
<li><p>The <samp class="file">Rd</samp> files are checked for correct syntax and metadata, including the presence of the mandatory fields (<code class="code">\name</code>, <code class="code">\alias</code>, <code class="code">\title</code> and <code class="code">\description</code>). The <samp class="file">Rd</samp> name and title are checked for being non-empty, and there is a check for missing cross-references (links).</p></li>
<li><p>A check is made for missing documentation entries, such as undocumented user-level objects in the package.</p></li>
<li><p>Documentation for functions, data sets, and S4 classes is checked for consistency with the corresponding code.</p></li>
<li><p>It is checked whether all function arguments given in <code class="code">\usage</code> sections of <samp class="file">Rd</samp> files are documented in the corresponding <code class="code">\arguments</code> section.</p></li>
<li><p>The <samp class="file">data</samp> directory is checked for non-ASCII characters and for the use of reasonable levels of compression.</p></li>
<li><p>C, C++ and Fortran source and header files<a href="#FOOT56" id="DOCF56" class="footnote"><sup>56</sup></a> are tested for portable (LF-only) line endings. If there is a <samp class="file">Makefile</samp> or <samp class="file">Makefile.in</samp> or <samp class="file">Makevars</samp> or <samp class="file">Makevars.in</samp> file under the <samp class="file">src</samp> directory, it is checked for portable line endings and the correct use of <samp class="samp">$(BLAS_LIBS)</samp>’ and <samp class="samp">$(LAPACK_LIBS)</samp>’</p>
<p>Compiled code is checked for symbols corresponding to functions which might terminate R or write to <samp class="file">stdout</samp>/<samp class="file">stderr</samp> instead of the console. Note that the latter might give false positives in that the symbols might be pulled in with external libraries and could never be called. Windows<a href="#FOOT57" id="DOCF57" class="footnote"><sup>57</sup></a> users should note that the Fortran and C++ runtime libraries are examples of such external libraries.</p></li>
<li><p>Some checks are made of the contents of the <samp class="file">inst/doc</samp> directory. These always include checking for files that look like leftovers, and if suitable tools (such as <code class="command">qpdf</code>) are available, checking that the PDF documentation is of minimal size.</p></li>
<li><p>The examples provided by the package’s documentation are run. (see <a href="Writing-R-documentation-files.html#writing-r-documentation-files" class="pxref">Writing R documentation files</a>, for information on using <code class="code">\examples</code> to create executable example code.) If there is a file <samp class="file">tests/Examples/</samp><var class="var">pkg</var><samp class="file">-Ex.Rout.save</samp>, the output of running the examples is compared to that file.</p>
<p>Of course, released packages should be able to run at least their own examples. Each example is run in a ‘clean’ environment (so earlier examples cannot be assumed to have been run), and with the variables <code class="code">T</code> and <code class="code">F</code> redefined to generate an error unless they are set in the example: See <a href="https://cran.r-project.org/doc/manuals/R-intro.html#Logical-vectors" data-manual="R-intro">Logical vectors</a> in An Introduction to R.</p></li>
<li><p>If the package sources contain a <samp class="file">tests</samp> directory then the tests specified in that directory are run. (Typically they will consist of a set of <samp class="file">.R</samp> source files and target output files <samp class="file">.Rout.save</samp>.) Please note that the comparison will be done in the end user’s locale, so the target output files should be ASCII if at all possible. (The command line option <code class="code">--test-dir=foo</code> may be used to specify tests in a non-standard location. For example, unusually slow tests could be placed in <samp class="file">inst/slowTests</samp> and then <code class="code">R CMD check --test-dir=inst/slowTests</code> would be used to run them. Other names that have been suggested are, for example, <samp class="file">inst/testWithOracle</samp> for tests that require Oracle to be installed, <samp class="file">inst/randomTests</samp> for tests which use random values and may occasionally fail by chance, etc.)</p></li>
<li><p>The R code in package vignettes (see <a href="#writing-package-vignettes" class="pxref">Writing package vignettes</a>) is executed, and the vignettes re-made from their sources as a check of completeness of the sources (unless there is a <samp class="samp">BuildVignettes</samp>’ field in the package’s <samp class="file">DESCRIPTION</samp> file with a false value). If there is a target output file <samp class="file">.Rout.save</samp> in the vignette source directory, the output from running the code in that vignette is compared with the target output file and any differences are reported (but not recorded in the log file). (If the vignette sources are in the deprecated location <samp class="file">inst/doc</samp>, do mark such target output files to not be installed in <samp class="file">.Rinstignore</samp>.)</p>
<p>If there is an error<a href="#FOOT58" id="DOCF58" class="footnote"><sup>58</sup></a> in executing the R code in vignette <var class="var">foo.ext</var>, a log file <var class="var">foo.ext</var><samp class="file">.log</samp> is created in the check directory. The vignettes are re-made in a copy of the package sources in the <samp class="file">vign_test</samp> subdirectory of the check directory, so for further information on errors look in directory <var class="var">pkgname</var><samp class="file">/vign_test/vignettes</samp>. (It is only retained if there are errors or if environment variable <code class="env">_R_CHECK_CLEAN_VIGN_TEST_</code> is set to a false value.)</p></li>
<li><p>The PDF version of the package’s manual is created (to check that the <samp class="file">Rd</samp> files can be converted successfully). This needs LaTeX and suitable fonts and LaTeX packages to be installed. See <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Making-the-manuals" data-manual="R-admin">Making the manuals</a> in R Installation and Administration for further details.</p></li>
<li><p>Optionally (including by <code class="command">R CMD check --as-cran</code>) the HTML version of the manual is created and checked for compliance with the HTML5 standard. This requires a recent version<a href="#FOOT59" id="DOCF59" class="footnote"><sup>59</sup></a> of ‘HTML Tidy’, either on the path or at a location specified by environment variable <code class="env">R_TIDYCMD</code>. Up-to-date versions can be installed from <a href="http://binaries.html-tidy.org/" class="uref">http://binaries.html-tidy.org/</a>.</p></li>
</ol>
<p>All these tests are run with collation set to the <code class="code">C</code> locale, and for the examples and tests with environment variable <code class="env">LANGUAGE=en</code>: this is to minimize differences between platforms.</p>
<p>Use <kbd><kbd>R CMD check --help</kbd></kbd> to obtain more information about the usage of the R package checker. A subset of the checking steps can be selected by adding command-line options. It also allows customization by setting environment variables <code class="env">_R_CHECK_*_</code> as described in <a href="https://cran.r-project.org/doc/manuals/R-ints.html#Tools" data-manual="R-ints">Tools</a> in R Internals: a set of these customizations similar to those used by CRAN can be selected by the option <samp class="option">--as-cran</samp> (which works best if Internet access is available). Some Windows users may need to set environment variable <code class="env">R_WIN_NO_JUNCTIONS</code> to a non-empty value. The test of cyclic declarations<a href="#FOOT60" id="DOCF60" class="footnote"><sup>60</sup></a>in <samp class="file">DESCRIPTION</samp> files needs repositories (including CRAN) set: do this in <samp class="file">~/.Rprofile</samp>, by e.g.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">c</span>(<span class="at">CRAN=</span><span class="st">"https://cran.r-project.org"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>One check customization which can be revealing is</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>_R_CHECK_CODETOOLS_PROFILE_<span class="ot">=</span><span class="st">"suppressLocalUnused=FALSE"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which reports unused local assignments. Not only does this point out computations which are unnecessary because their results are unused, it also can uncover errors. (Two such are to intend to update an object by assigning a value but mistype its name or assign in the wrong scope, for example using <code class="code">&lt;-</code> where <code class="code">&lt;&lt;-</code> was intended.) This can give false positives, most commonly because of non-standard evaluation for formulae and because the intention is to return objects in the environment of a function for later use.</p>
<p>Complete checking of a package which contains a file <samp class="file">README.md</samp> needs a reasonably current version of <code class="command">pandoc</code> installed: see <a href="https://pandoc.org/installing.html" class="uref">https://pandoc.org/installing.html</a>.</p>
<p>You do need to ensure that the package is checked in a suitable locale if it contains non-ASCII characters. Such packages are likely to fail some of the checks in a <code class="code">C</code> locale, and <code class="command">R CMD check</code> will warn if it spots the problem. You should be able to check any package in a UTF-8 locale (if one is available). Beware that although a <code class="code">C</code> locale is rarely used at a console, it may be the default if logging in remotely or for batch jobs.</p>
<p>Often <code class="command">R CMD check</code> will need to consult a CRAN repository to check details of uninstalled packages. Normally this defaults to the CRAN main site, but a mirror can be specified by setting environment variables <code class="env">R_CRAN_WEB</code> and (rarely needed) <code class="env">R_CRAN_SRC</code> to the URL of a CRAN mirror.</p>
<p>It is possible to install a package and then check the installed package. To do so first install the package and keep a log of the installation:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD INSTALL <span class="at">-l</span> libdir pkg <span class="op">&gt;</span> pkg.log <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and then use</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>Rdev CMD check <span class="sc">-</span>l libdir <span class="sc">--</span>install<span class="ot">=</span>check<span class="sc">:</span>pkg.log pkg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(Specifying the library is required: it ensures that the just-installed package is the one checked. If you know for sure only one copy is installed you can use <samp class="option">--install=skip</samp>: this is used for R installation’s <code class="command">make check-recommended</code>.)</p>
</section>
<section id="building-package-tarballs" class="level3 subsection" data-number="1.3.2">
<h3 class="subsection anchored" data-number="1.3.2" data-anchor-id="building-package-tarballs"><span class="header-section-number">1.3.2</span> Building package tarballs <a href="#building-package-tarballs-1" class="copiable-link">¶</a></h3>
<p><span id="index-R-CMD-build" class="index-entry-id"></span> <span id="index-Package-builder" class="index-entry-id"></span> <span id="index-tarballs" class="index-entry-id"></span></p>
<p>Packages may be distributed in source form as “tarballs” (<samp class="file">.tar.gz</samp> files) or in binary form. The source form can be installed on all platforms with suitable tools and is the usual form for Unix-like systems; the binary form is platform-specific, and is the more common distribution form for the macOS and <samp class="samp">x86_64</samp>’ Windows platforms.</p>
<p>Using <code class="command">R CMD build</code>, the R package builder, one can build R package tarballs from their sources (for example, for subsequent release). It is recommended that packages are built for release by the current release version of R or <samp class="samp">r-patched</samp>’, to avoid inadvertently picking up new features of a development version of R.</p>
<p>Prior to actually building the package in the standard gzipped tar file format, a few diagnostic checks and cleanups are performed. In particular, it is tested whether object indices exist and can be assumed to be up-to-date, and C, C++ and Fortran source files and relevant makefiles in a <samp class="file">src</samp> directory are tested and converted to LF line-endings if necessary.</p>
<p>Run-time checks whether the package works correctly should be performed using <code class="command">R CMD check</code> prior to invoking the final build procedure.</p>
<p>To exclude files from being put into the package, one can specify a list of exclude patterns in file <samp class="file">.Rbuildignore</samp> in the top-level source directory. These patterns should be Perl-like regular expressions (see the help for <code class="code">regexp</code> in R for the precise details), one per line, to be matched case-insensitively against the file and directory names relative to the top-level package source directory. In addition, directories from source control systems<a href="#FOOT61" id="DOCF61" class="footnote"><sup>61</sup></a> or from <code class="command">eclipse</code><a href="#FOOT62" id="DOCF62" class="footnote"><sup>62</sup></a>, directories with names <samp class="file">check</samp>, <samp class="file">chm</samp>, or ending <samp class="file">.Rcheck</samp> or <samp class="file">Old</samp> or <samp class="file">old</samp> and files <samp class="file">GNUMakefile</samp><a href="#FOOT63" id="DOCF63" class="footnote"><sup>63</sup></a>, <samp class="file">Read-and-delete-me</samp> or with base names starting with <samp class="samp">.#</samp>‘, or starting and ending with <samp class="samp">#</samp>’, or ending in <samp class="samp">~</samp>‘, <samp class="samp">.bak</samp>’ or <samp class="samp">.swp</samp>’, are excluded by default<a href="#FOOT64" id="DOCF64" class="footnote"><sup>64</sup></a>. In addition, same-package tarballs (from previous builds) and their binary forms will be excluded from the top-level directory, as well as those files in the <samp class="file">R</samp>, <samp class="file">demo</samp> and <samp class="file">man</samp> directories which are flagged by <code class="command">R CMD check</code> as having invalid names.</p>
<p>Use <kbd><kbd>R CMD build --help</kbd></kbd> to obtain more information about the usage of the R package builder.</p>
<p>Unless <kbd><kbd>R CMD build</kbd></kbd> is invoked with the <samp class="option">--no-build-vignettes</samp> option (or the package’s <samp class="file">DESCRIPTION</samp> contains <samp class="samp">BuildVignettes: no</samp>’ or similar), it will attempt to (re)build the vignettes (see <a href="#writing-package-vignettes" class="pxref">Writing package vignettes</a>) in the package. To do so it installs the current package into a temporary library tree, but any dependent packages need to be installed in an available library tree (see the Note: at the top of this section).</p>
<p>Similarly, if the <samp class="file">.Rd</samp> documentation files contain any <code class="code">\Sexpr</code> macros (see <a href="Writing-R-documentation-files.html#dynamic-pages" class="pxref">Dynamic pages</a>), the package will be temporarily installed to execute them. Post-execution binary copies of those pages containing build-time macros will be saved in <samp class="file">build/partial.rdb</samp>. If there are any install-time or render-time macros, a <samp class="file">.pdf</samp> version of the package manual will be built and installed in the <samp class="file">build</samp> subdirectory. (This allows CRAN or other repositories to display the manual even if they are unable to install the package.) This can be suppressed by the option <samp class="option">--no-manual</samp> or if package’s <samp class="file">DESCRIPTION</samp> contains <samp class="samp">BuildManual: no</samp>’ or similar.</p>
<p>One of the checks that <code class="command">R CMD build</code> runs is for empty source directories. These are in most (but not all) cases unintentional, if they are intentional use the option <samp class="option">--keep-empty-dirs</samp> (or set the environment variable <code class="env">_R_BUILD_KEEP_EMPTY_DIRS_</code> to <samp class="samp">TRUE</samp>‘, or have a <samp class="samp">BuildKeepEmpty</samp>’ field with a true value in the <samp class="file">DESCRIPTION</samp> file).</p>
<p>The <samp class="option">--resave-data</samp> option allows saved images (<samp class="file">.rda</samp> and <samp class="file">.RData</samp> files) in the <samp class="file">data</samp> directory to be optimized for size. It will also compress tabular files and convert <samp class="file">.R</samp> files to saved images. It can take values <code class="code">no</code>, <code class="code">gzip</code> (the default if this option is not supplied, which can be changed by setting the environment variable <code class="env">_R_BUILD_RESAVE_DATA_</code>) and <code class="code">best</code> (equivalent to giving it without a value), which chooses the most effective compression. Using <code class="code">best</code> adds a dependence on <code class="code">R (&gt;= 2.10)</code> to the <samp class="file">DESCRIPTION</samp> file if <code class="command">bzip2</code> or <code class="command">xz</code> compression is selected for any of the files. If this is thought undesirable, <samp class="option">--resave-data=gzip</samp> (which is the default if that option is not supplied) will do what compression it can with <code class="command">gzip</code>. A package can control how its data is resaved by supplying a <samp class="samp">BuildResaveData</samp>’ field (with one of the values given earlier in this paragraph) in its <samp class="file">DESCRIPTION</samp> file.</p>
<p>The <samp class="option">--compact-vignettes</samp> option will run <code class="code">tools::compactPDF</code> over the PDF files in <samp class="file">inst/doc</samp> (and its subdirectories) to losslessly compress them. This is not enabled by default (it can be selected by environment variable <code class="env">_R_BUILD_COMPACT_VIGNETTES_</code>) and needs <code class="command">qpdf</code> (<a href="https://qpdf.sourceforge.io/" class="uref">https://qpdf.sourceforge.io/</a>) to be available.</p>
<p>It can be useful to run <code class="command">R CMD check --check-subdirs=yes</code> on the built tarball as a final check on the contents.</p>
<p>Where a non-POSIX file system is in use which does not utilize execute permissions, some care is needed with permissions. This applies on Windows and to e.g.&nbsp;FAT-formatted drives and SMB-mounted file systems on other OSes. The ‘mode’ of the file recorded in the tarball will be whatever <code class="code">file.info()</code> returns. On Windows this will record only directories as having execute permission and on other OSes it is likely that all files have reported ‘mode’ <code class="code">0777</code>. A particular issue is packages being built on Windows which are intended to contain executable scripts such as <samp class="file">configure</samp> and <samp class="file">cleanup</samp>: <code class="command">R CMD build</code> ensures those two are recorded with execute permission.</p>
<p>Directory <samp class="file">build</samp> of the package sources is reserved for use by <code class="command">R CMD build</code>: it contains information which may not easily be created when the package is installed, including index information on the vignettes and, rarely, information on the help pages and perhaps a copy of the PDF reference manual (see above).</p>
</section>
<section id="building-binary-packages" class="level3 subsection" data-number="1.3.3">
<h3 class="subsection anchored" data-number="1.3.3" data-anchor-id="building-binary-packages"><span class="header-section-number">1.3.3</span> Building binary packages <a href="#building-binary-packages-1" class="copiable-link">¶</a></h3>
<p>Binary packages are compressed copies of installed versions of packages. They contain compiled shared libraries rather than C, C++ or Fortran source code, and the R functions are included in their installed form. The format and filename are platform-specific; for example, a binary package for Windows is usually supplied as a <samp class="file">.zip</samp> file, and for the macOS platform the default binary package file extension is <samp class="file">.tgz</samp>.</p>
<p>The recommended method of building binary packages is to use</p>
<p><code class="command">R CMD INSTALL --build pkg</code></p>
<p>where <samp class="file">pkg</samp> is either the name of a source tarball (in the usual <samp class="file">.tar.gz</samp> format) or the location of the directory of the package source to be built. This operates by first installing the package and then packing the installed binaries into the appropriate binary package file for the particular platform.</p>
<p>By default, <code class="command">R CMD INSTALL --build</code> will attempt to install the package into the default library tree for the local installation of R. This has two implications:</p>
<ul>
<li>If the installation is successful, it will overwrite any existing installation of the same package.</li>
<li>The default library tree must have write permission; if not, the package will not install and the binary will not be created.</li>
</ul>
<p>To prevent changes to the present working installation or to provide an install location with write access, create a suitably located directory with write access and use the <code class="command">-l</code> option to build the package in the chosen location. The usage is then</p>
<p><code class="command">R CMD INSTALL -l location --build pkg</code></p>
<p>where <samp class="file">location</samp> is the chosen directory with write access. The package will be installed as a subdirectory of <samp class="file">location</samp>, and the package binary will be created in the current directory.</p>
<p>Other options for <code class="command">R CMD INSTALL</code> can be found using <code class="command">R CMD INSTALL --help</code>, and platform-specific details for special cases are discussed in the platform-specific FAQs.</p>
<p>Finally, at least one web-based service is available for building binary packages from (checked) source code: WinBuilder (see <a href="https://win-builder.R-project.org/" class="uref">https://win-builder.R-project.org/</a>) is able to build <samp class="samp">x86_64</samp>’ Windows binaries. Note that this is intended for developers on other platforms who do not have access to Windows but wish to provide binaries for the Windows platform.</p>
</section>
</section>
<section id="writing-package-vignettes" class="level2 section" data-number="1.4">
<h2 class="section anchored" data-number="1.4" data-anchor-id="writing-package-vignettes"><span class="header-section-number">1.4</span> Writing package vignettes <a href="#writing-package-vignettes-1" class="copiable-link">¶</a></h2>
<p>In addition to the help files in <samp class="file">Rd</samp> format, R packages allow the inclusion of documents in arbitrary other formats. The standard location for these is subdirectory <samp class="file">inst/doc</samp> of a source package, the contents will be copied to subdirectory <samp class="file">doc</samp> when the package is installed. Pointers from package help indices to the installed documents are automatically created. Documents in <samp class="file">inst/doc</samp> can be in arbitrary format, however we strongly recommend providing them in PDF format, so users on almost all platforms can easily read them. To ensure that they can be accessed from a browser (as an HTML index is provided), the file names should start with an ASCII letter and be comprised entirely of ASCII letters or digits or hyphen or underscore.</p>
<p>A special case is <em>package vignettes</em>. Vignettes are documents in PDF or HTML format obtained from plain-text literate source files from which R knows how to extract R code and create output (in PDF/HTML or intermediate LaTeX). Vignette engines do this work, using “tangle” and “weave” functions respectively. Sweave, provided by the R distribution, is the default engine. Other vignette engines besides Sweave are supported; see <a href="#non-sweave-vignettes" class="ref">Non-Sweave vignettes</a>.</p>
<p>Package vignettes have their sources in subdirectory <samp class="file">vignettes</samp> of the package sources. Note that the location of the vignette sources only affects <code class="command">R CMD build</code> and <code class="command">R CMD check</code>: the tarball built by <code class="command">R CMD build</code> includes in <samp class="file">inst/doc</samp> the components intended to be installed.</p>
<p>Sweave vignette sources are normally given the file extension <samp class="file">.Rnw</samp> or <samp class="file">.Rtex</samp>, but for historical reasons extensions<a href="#FOOT65" id="DOCF65" class="footnote"><sup>65</sup></a> <samp class="file">.Snw</samp> and <samp class="file">.Stex</samp> are also recognized. Sweave allows the integration of LaTeX documents: see the <code class="code">Sweave</code> help page in R and the <code class="code">Sweave</code> vignette in package <strong>utils</strong> for details on the source document format.</p>
<p>Package vignettes are tested by <code class="code">R CMD check</code> by executing all R code chunks they contain (except those marked for non-evaluation, e.g., with option <code class="code">eval=FALSE</code> for Sweave). The R working directory for all vignette tests in <code class="code">R CMD check</code> is a <em>copy</em> of the vignette source directory. Make sure all files needed to run the R code in the vignette (data sets, …) are accessible by either placing them in the <samp class="file">inst/doc</samp> hierarchy of the source package or by using calls to <code class="code">system.file()</code>. All other files needed to re-make the vignettes (such as LaTeX style files, BibTeX input files and files for any figures not created by running the code in the vignette) must be in the vignette source directory. <code class="code">R CMD check</code> will check that vignette production has succeeded by comparing modification times of output files in <samp class="file">inst/doc</samp> with the source in <samp class="file">vignettes</samp>.</p>
<p><code class="code">R CMD build</code> will automatically<a href="#FOOT66" id="DOCF66" class="footnote"><sup>66</sup></a> create the (PDF or HTML versions of the) vignettes in <samp class="file">inst/doc</samp> for distribution with the package sources. By including the vignette outputs in the package sources it is not necessary that these can be re-built at install time, i.e., the package author can use private R packages, screen snapshots and LaTeX extensions which are only available on their machine.<a href="#FOOT67" id="DOCF67" class="footnote"><sup>67</sup></a></p>
<p>By default <code class="code">R CMD build</code> will run <code class="code">Sweave</code> on all Sweave vignette source files in <samp class="file">vignettes</samp>. If <samp class="file">Makefile</samp> is found in the vignette source directory, then <code class="code">R CMD build</code> will try to run <code class="command">make</code> after the <code class="code">Sweave</code> runs, otherwise <code class="code">texi2pdf</code> is run on each <samp class="file">.tex</samp> file produced.</p>
<p>The first target in the <samp class="file">Makefile</samp> should take care of both creation of PDF/HTML files and cleaning up afterwards (including after <code class="code">Sweave</code>), i.e., delete all files that shall not appear in the final package archive. Note that if the <code class="code">make</code> step runs R it needs to be careful to respect the environment values of <code class="env">R_LIBS</code> and <code class="env">R_HOME</code><a href="#FOOT68" id="DOCF68" class="footnote"><sup>68</sup></a>. Finally, if there is a <samp class="file">Makefile</samp> and it has a <samp class="samp">clean:</samp>’ target, <code class="command">make clean</code> is run.</p>
<p>All the usual <em>caveats</em> about including a <samp class="file">Makefile</samp> apply. It must be portable (no GNU extensions), use LF line endings and must work correctly with a parallel <code class="command">make</code>: too many authors have written things like</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># BAD EXAMPLE</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>all<span class="op">:</span> pdf clean</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>pdf<span class="op">:</span> ABC<span class="op">-</span>intro<span class="op">.</span>pdf ABC<span class="op">-</span>details<span class="op">.</span>pdf</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="op">%.</span>pdf<span class="op">:</span>  <span class="op">%.</span>tex</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>        texi2dvi <span class="op">--</span>pdf $<span class="op">*</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>clean<span class="op">:</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>        rm <span class="op">*.</span>tex ABC<span class="op">-</span>details<span class="op">-*.</span>pdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which will start removing the source files whilst <code class="command">pdflatex</code> is working.</p>
<p>Metadata lines can be placed in the source file, preferably in LaTeX comments in the preamble. One such is a <code class="code">\VignetteIndexEntry</code> of the form</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode latex code-with-copy"><code class="sourceCode latex"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">%\VignetteIndexEntry{Using Animal}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Others you may see are <code class="code">\VignettePackage</code> (currently ignored), <code class="code">\VignetteDepends</code> (a comma-separated list of package names) and <code class="code">\VignetteKeyword</code> (which replaced <code class="code">\VignetteKeywords</code>). These are processed at package installation time to create the saved data frame <samp class="file">Meta/vignette.rds</samp>. The <code class="code">\VignetteEngine</code> statement is described in <a href="#non-sweave-vignettes" class="ref">Non-Sweave vignettes</a>. Vignette metadata can be extracted from a source file using <code class="code">tools::vignetteInfo</code>.</p>
<p>At install time an HTML index for all vignettes in the package is automatically created from the <code class="code">\VignetteIndexEntry</code> statements unless a file <samp class="file">index.html</samp> exists in directory <samp class="file">inst/doc</samp>. This index is linked from the HTML help index for the package. If you do supply a <samp class="file">inst/doc/index.html</samp> file it should contain relative links only to files under the installed <samp class="file">doc</samp> directory, or perhaps (not really an index) to HTML help files or to the <samp class="file">DESCRIPTION</samp> file, and be valid HTML as confirmed <em>via</em> the <a href="https://validator.w3.org" class="uref">W3C Markup Validation Service</a> or <a href="https://validator.nu/" class="uref">Validator.nu</a>.</p>
<p>Sweave/Stangle allows the document to specify the <code class="code">split=TRUE</code> option to create a single R file for each code chunk: this will not work for vignettes where it is assumed that each vignette source generates a single file with the vignette extension replaced by <samp class="file">.R</samp>.</p>
<p>Do watch that PDFs are not too large – one in a CRAN package was 72MB! This is usually caused by the inclusion of overly detailed figures, which will not render well in PDF viewers. Sometimes it is much better to generate fairly high resolution bitmap (PNG, JPEG) figures and include those in the PDF document.</p>
<p>When <code class="command">R CMD build</code> builds the vignettes, it copies these and the vignette sources from directory <samp class="file">vignettes</samp> to <samp class="file">inst/doc</samp>. To install any other files from the <samp class="file">vignettes</samp> directory, include a file <samp class="file">vignettes/.install_extras</samp> which specifies these as Perl-like regular expressions on one or more lines. (See the description of the <samp class="file">.Rinstignore</samp> file for full details.)</p>
<section id="encodings-and-vignettes" class="level3 subsection" data-number="1.4.1">
<h3 class="subsection anchored" data-number="1.4.1" data-anchor-id="encodings-and-vignettes"><span class="header-section-number">1.4.1</span> Encodings and vignettes <a href="#encodings-and-vignettes-1" class="copiable-link">¶</a></h3>
<p>Vignettes will in general include descriptive text, R input, R output and figures, LaTeX include files and bibliographic references. As any of these may contain non-ASCII characters, the handling of encodings can become very complicated.</p>
<p>The vignette source file should be written in ASCII or contain a declaration of the encoding (see below). This applies even to comments within the source file, since vignette engines process comments to look for options and metadata lines. When an engine’s weave and tangle functions are called on the vignette source, it will be converted to the encoding of the current R session.</p>
<p><code class="code">Stangle()</code> will produce an R code file in the current locale’s encoding: for a non-ASCII vignette what that is is recorded in a comment at the top of the file.</p>
<p><code class="code">Sweave()</code> will produce a <samp class="file">.tex</samp> file in the current encoding, or in UTF-8 if that is declared. Non-ASCII encodings need to be declared to LaTeX via a line like</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode latex code-with-copy"><code class="sourceCode latex"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="bu">\usepackage</span>[utf8]{<span class="ex">inputenc</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(It is also possible to use the more recent <samp class="samp">inputenx</samp>’ LaTeX package.) For files where this line is not needed (e.g.&nbsp;chapters included within the body of a larger document, or non-Sweave vignettes), the encoding may be declared using a comment like</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode latex code-with-copy"><code class="sourceCode latex"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">%\VignetteEncoding{UTF-8}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If the encoding is UTF-8, this can also be declared using the declaration</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode latex code-with-copy"><code class="sourceCode latex"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">%\SweaveUTF8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If no declaration is given in the vignette, it will be assumed to be in the encoding declared for the package. If there is no encoding declared in either place, then it is an error to use non-ASCII characters in the vignette.</p>
<p>In any case, be aware that LaTeX may require the <samp class="samp">usepackage</samp>’ declaration.</p>
<p><code class="code">Sweave()</code> will also parse and evaluate the R code in each chunk. The R output will also be in the current locale (or UTF-8 if so declared), and should be covered by the <samp class="samp">inputenc</samp>’ declaration. One thing people often forget is that the R output may not be ASCII even for ASCII R sources, for many possible reasons. One common one is the use of ‘fancy’ quotes: see the R help on <code class="code">sQuote</code>: note carefully that it is not portable to declare UTF-8 or CP1252 to cover such quotes, as their encoding will depend on the locale used to run <code class="code">Sweave()</code>: this can be circumvented by setting <code class="code">options(useFancyQuotes="UTF-8")</code> in the vignette.</p>
<p>The final issue is the encoding of figures – this applies only to PDF figures and not PNG etc. The PDF figures will contain declarations for their encoding, but the Sweave option <code class="code">pdf.encoding</code> may need to be set appropriately: see the help for the <code class="code">pdf()</code> graphics device.</p>
<p>As a real example of the complexities, consider the <a href="https://CRAN.R-project.org/package=fortunes" class="url"><strong>fortunes</strong></a> package version <samp class="samp">1.4-0</samp>’. That package did not have a declared encoding, and its vignette was in ASCII. However, the data it displays are read from a UTF-8 CSV file and will be assumed to be in the current encoding, so <samp class="file">fortunes.tex</samp> will be in UTF-8 in any locale. Had <code class="code">read.table</code> been told the data were UTF-8, <samp class="file">fortunes.tex</samp> would have been in the locale’s encoding.</p>
</section>
<section id="non-sweave-vignettes" class="level3 subsection" data-number="1.4.2">
<h3 class="subsection anchored" data-number="1.4.2" data-anchor-id="non-sweave-vignettes"><span class="header-section-number">1.4.2</span> Non-Sweave vignettes <a href="#non-sweave-vignettes-1" class="copiable-link">¶</a></h3>
<p>Vignettes in formats other than Sweave are supported <em>via</em> “vignette engines”. For example <a href="https://CRAN.R-project.org/package=knitr" class="url"><strong>knitr</strong></a> version 1.1 or later can create <samp class="file">.tex</samp> files from a variation on Sweave format, and <samp class="file">.html</samp> files from a variation on “markdown” format. These engines replace the <code class="code">Sweave()</code> function with other functions to convert vignette source files into LaTeX files for processing into <samp class="file">.pdf</samp>, or directly into <samp class="file">.pdf</samp> or <samp class="file">.html</samp> files. The <code class="code">Stangle()</code> function is replaced with a function that extracts the R source from a vignette.</p>
<p>R recognizes non-Sweave vignettes using filename extensions specified by the engine. For example, the <a href="https://CRAN.R-project.org/package=knitr" class="url"><strong>knitr</strong></a> package supports the extension <samp class="file">.Rmd</samp> (standing for “R markdown”). The user indicates the vignette engine within the vignette source using a <code class="code">\VignetteEngine</code> line, for example</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode latex code-with-copy"><code class="sourceCode latex"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">%\VignetteEngine{knitr::knitr}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This specifies the name of a package and an engine to use in place of Sweave in processing the vignette. As <code class="code">Sweave</code> is the only engine supplied with the R distribution, the package providing any other engine must be specified in the <samp class="samp">VignetteBuilder</samp>’ field of the package <samp class="file">DESCRIPTION</samp> file, and also specified in the <samp class="samp">Suggests</samp>‘, <samp class="samp">Imports</samp>’ or <samp class="samp">Depends</samp>’ field (since its namespace must be available to build or check your package). If more than one package is specified as a builder, they will be searched in the order given there. The <strong>utils</strong> package is always implicitly appended to the list of builder packages, but may be included earlier to change the search order.</p>
<p>Note that a package with non-Sweave vignettes should always have a <samp class="samp">VignetteBuilder</samp>’ field in the <samp class="file">DESCRIPTION</samp> file, since this is how <code class="command">R CMD check</code> recognizes that there are vignettes to be checked: packages listed there are required when the package is checked.</p>
<p>The vignette engine can produce <samp class="file">.tex</samp>, <samp class="file">.pdf</samp>, or <samp class="file">.html</samp> files as output. If it produces <samp class="file">.tex</samp> files, R will call <code class="code">texi2pdf</code> to convert them to <samp class="file">.pdf</samp> for display to the user (unless there is a <samp class="file">Makefile</samp> in the <samp class="file">vignettes</samp> directory).</p>
<p>Package writers who would like to supply vignette engines need to register those engines in the package <code class="code">.onLoad</code> function. For example, that function could make the call</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>tools::vignetteEngine("knitr", weave = vweave, tangle = vtangle,</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>                      pattern = "[.]Rmd$", package = "knitr")</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(The actual registration in <a href="https://CRAN.R-project.org/package=knitr" class="url"><strong>knitr</strong></a> is more complicated, because it supports other input formats.) See the <code class="code">?tools::vignetteEngine</code> help topic for details on engine registration.</p>
</section>
</section>
<section id="package-namespaces" class="level2 section" data-number="1.5">
<h2 class="section anchored" data-number="1.5" data-anchor-id="package-namespaces"><span class="header-section-number">1.5</span> Package namespaces <a href="#package-namespaces-1" class="copiable-link">¶</a></h2>
<p>R has a namespace management system for code in packages. This system allows the package writer to specify which variables in the package should be <em>exported</em> to make them available to package users, and which variables should be <em>imported</em> from other packages.</p>
<p>The namespace for a package is specified by the <samp class="file">NAMESPACE</samp> file in the top level package directory. This file contains <em>namespace directives</em> describing the imports and exports of the namespace. Additional directives register any shared objects to be loaded and any S3-style methods that are provided. Note that although the file looks like R code (and often has R-style comments) it is not processed as R code. Only very simple conditional processing of <code class="code">if</code> statements is implemented.</p>
<p>Packages are loaded and attached to the search path by calling <code class="code">library</code> or <code class="code">require</code>. Only the exported variables are placed in the attached frame. Loading a package that imports variables from other packages will cause these other packages to be loaded as well (unless they have already been loaded), but they will <em>not</em> be placed on the search path by these implicit loads. Thus code in the package can only depend on objects in its own namespace and its imports (including the <strong>base</strong> namespace) being visible<a href="#FOOT69" id="DOCF69" class="footnote"><sup>69</sup></a>.</p>
<p>Namespaces are <em>sealed</em> once they are loaded. Sealing means that imports and exports cannot be changed and that internal variable bindings cannot be changed. Sealing allows a simpler implementation strategy for the namespace mechanism and allows code analysis and compilation tools to accurately identify the definition corresponding to a global variable reference in a function body.</p>
<p>The namespace controls the search strategy for variables used by functions in the package. If not found locally, R searches the package namespace first, then the imports, then the base namespace and then the normal search path (so the base namespace precedes the normal search rather than being at the end of it).</p>
<section id="specifying-imports-and-exports" class="level3 subsection" data-number="1.5.1">
<h3 class="subsection anchored" data-number="1.5.1" data-anchor-id="specifying-imports-and-exports"><span class="header-section-number">1.5.1</span> Specifying imports and exports <a href="#specifying-imports-and-exports-1" class="copiable-link">¶</a></h3>
<p>Exports are specified using the <code class="code">export</code> directive in the <samp class="file">NAMESPACE</samp> file. A directive of the form</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">export</span>(f, g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>specifies that the variables <code class="code">f</code> and <code class="code">g</code> are to be exported. (Note that variable names may be quoted, and reserved words and non-standard names such as <code class="code">[&lt;-.fractions</code> must be.)</p>
<p>For packages with many variables to export it may be more convenient to specify the names to export with a regular expression using <code class="code">exportPattern</code>. The directive</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exportPattern</span>(<span class="st">"^[^.]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>exports all variables that do not start with a period. However, such broad patterns are not recommended for production code: it is better to list all exports or use narrowly-defined groups. (This pattern applies to S4 classes.) Beware of patterns which include names starting with a period: some of these are internal-only variables and should never be exported, e.g.&nbsp;<samp class="samp">.__S3MethodsTable__.</samp>’ (and loading excludes known cases).</p>
<p>Packages implicitly import the base namespace. Variables exported from other packages with namespaces need to be imported explicitly using the directives <code class="code">import</code> and <code class="code">importFrom</code>. The <code class="code">import</code> directive imports all exported variables from the specified package(s). Thus the directives</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">import</span>(foo, bar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>specifies that all exported variables in the packages <strong>foo</strong> and <strong>bar</strong> are to be imported. If only some of the exported variables from a package are needed, then they can be imported using <code class="code">importFrom</code>. The directive</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">importFrom</span>(foo, f, g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>specifies that the exported variables <code class="code">f</code> and <code class="code">g</code> of the package <strong>foo</strong> are to be imported. Using <code class="code">importFrom</code> selectively rather than <code class="code">import</code> is good practice and recommended notably when importing from packages with more than a dozen exports and especially from those written by others (so what they export can change in future).</p>
<p>To import every symbol from a package but for a few exceptions, pass the <code class="code">except</code> argument to <code class="code">import</code>. The directive</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">import</span>(foo, <span class="at">except=</span><span class="fu">c</span>(bar, baz))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>imports every symbol from <strong>foo</strong> except <code class="code">bar</code> and <code class="code">baz</code>. The value of <code class="code">except</code> should evaluate to something coercible to a character vector, after substituting each symbol for its corresponding string.</p>
<p>It is possible to export variables from a namespace which it has imported from other namespaces: this has to be done explicitly and not <em>via</em> <code class="code">exportPattern</code>.</p>
<p>If a package only needs a few objects from another package it can use a fully qualified variable reference in the code instead of a formal import. A fully-qualified reference to the function <code class="code">f</code> in package <strong>foo</strong> is of the form <code class="code">foo::f</code>. This is slightly less efficient than a formal import and also loses the advantage of recording all dependencies in the <samp class="file">NAMESPACE</samp> file (but they still need to be recorded in the <samp class="file">DESCRIPTION</samp> file). Evaluating <code class="code">foo::f</code> will cause package <strong>foo</strong> to be loaded, but not attached, if it was not loaded already—this can be an advantage in delaying the loading of a rarely used package. However, if <strong>foo</strong> is listed only in <samp class="samp">Suggests</samp>’ or <samp class="samp">Enhances</samp>’ this also delays the check that it is installed: it is good practice to use such imports conditionally (e.g.&nbsp;<em>via</em> <code class="code">requireNamespace("</code><var class="var">foo</var><code class="code">", quietly = TRUE)</code>).</p>
<p>Using the <code class="code">foo::f</code> form will be necessary when a package needs to use a function of the same name from more than one namespace.</p>
<p>Using <code class="code">foo:::f</code> instead of <code class="code">foo::f</code> allows access to unexported objects. This is generally not recommended, as the existence or semantics of unexported objects may be changed by the package author in routine maintenance.</p>
</section>
<section id="registering-s3-methods" class="level3 subsection" data-number="1.5.2">
<h3 class="subsection anchored" data-number="1.5.2" data-anchor-id="registering-s3-methods"><span class="header-section-number">1.5.2</span> Registering S3 methods <a href="#registering-s3-methods-1" class="copiable-link">¶</a></h3>
<p>The standard method for S3-style <code class="code">UseMethod</code> dispatching might fail to locate methods defined in a package that is imported but not attached to the search path. To ensure that these methods are available the packages defining the methods should ensure that the generics are imported and register the methods using <code class="code">S3method</code> directives. If a package defines a function <code class="code">print.foo</code> intended to be used as a <code class="code">print</code> method for class <code class="code">foo</code>, then the directive</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>S3method<span class="op">(</span>print<span class="op">,</span> foo<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ensures that the method is registered and available for <code class="code">UseMethod</code> dispatch, and the function <code class="code">print.foo</code> does not need to be exported. Since the generic <code class="code">print</code> is defined in <strong>base</strong> it does not need to be imported explicitly.</p>
<p>(Note that function and class names may be quoted, and reserved words and non-standard names such as <code class="code">[&lt;-</code> and <code class="code">function</code> must be.)</p>
<p>It is possible to specify a third argument to S3method, the function to be used as the method, for example</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>S3method<span class="op">(</span>print<span class="op">,</span> check_so_symbols<span class="op">,</span> <span class="op">.</span>print<span class="op">.</span>via<span class="op">.</span>format<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>when <code class="code">print.check_so_symbols</code> is not needed.</p>
<p>As from R 3.6.0 one can also use <code class="code">S3method()</code> directives to perform <em>delayed</em> registration. With</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">getRversion</span>() <span class="sc">&gt;=</span> <span class="st">"3.6.0"</span>) {</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">S3method</span>(pkg<span class="sc">::</span>gen, cls)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>function <code class="code">gen.cls</code> will get registered as an S3 method for class <code class="code">cls</code> and generic <code class="code">gen</code> from package <code class="code">pkg</code> only when the namespace of <code class="code">pkg</code> is loaded. This can be employed to deal with situations where the method is not “immediately” needed, and having to pre-load the namespace of <code class="code">pkg</code> (and all its strong dependencies) in order to perform immediate registration is considered too onerous.</p>
</section>
<section id="load-hooks" class="level3 subsection" data-number="1.5.3">
<h3 class="subsection anchored" data-number="1.5.3" data-anchor-id="load-hooks"><span class="header-section-number">1.5.3</span> Load hooks <a href="#load-hooks-1" class="copiable-link">¶</a></h3>
<p><span id="index-_002eonLoad" class="index-entry-id"></span> <span id="index-_002eonAttach" class="index-entry-id"></span></p>
<p>There are a number of hooks called as packages are loaded, attached, detached, and unloaded. See <code class="code">help(".onLoad")</code> for more details.</p>
<p>Since loading and attaching are distinct operations, separate hooks are provided for each. These hook functions are called <code class="code">.onLoad</code> and <code class="code">.onAttach</code>. They both take arguments<a href="#FOOT70" id="DOCF70" class="footnote"><sup>70</sup></a> <code class="code">libname</code> and <code class="code">pkgname</code>; they should be defined in the namespace but not exported.</p>
<p><span id="index-_002eonUnload" class="index-entry-id"></span> <span id="index-_002eonDetach" class="index-entry-id"></span> <span id="index-_002eLast_002elib" class="index-entry-id"></span></p>
<p>Packages can use a <code class="code">.onDetach</code> or <code class="code">.Last.lib</code> function (provided the latter is exported from the namespace) when <code class="code">detach</code> is called on the package. It is called with a single argument, the full path to the installed package. There is also a hook <code class="code">.onUnload</code> which is called when the namespace is unloaded (<em>via</em> a call to <code class="code">unloadNamespace</code>, perhaps called by <code class="code">detach(unload = TRUE)</code>) with argument the full path to the installed package’s directory. Functions <code class="code">.onUnload</code> and <code class="code">.onDetach</code> should be defined in the namespace and not exported, but <code class="code">.Last.lib</code> does need to be exported.</p>
<p>Packages are not likely to need <code class="code">.onAttach</code> (except perhaps for a start-up banner); code to set options and load shared objects should be placed in a <code class="code">.onLoad</code> function, or use made of the <code class="code">useDynLib</code> directive described next.</p>
<p>User-level hooks are also available: see the help on function <code class="code">setHook</code>.</p>
<p>These hooks are often used incorrectly. People forget to export <code class="code">.Last.lib</code>. Compiled code should be loaded in <code class="code">.onLoad</code> (or <em>via</em> a <code class="code">useDynLb</code> directive: see below) and unloaded in <code class="code">.onUnload</code>. Do remember that a package’s namespace can be loaded without the namespace being attached (e.g.&nbsp;by <code class="code">pkgname::fun</code>) and that a package can be detached and re-attached whilst its namespace remains loaded.</p>
<p>It is good practice for these functions to be quiet. Any messages should use <code class="code">packageStartupMessage</code> so users (include check scripts) can suppress them if desired.</p>
</section>
<section id="usedynlib" class="level3 subsection" data-number="1.5.4">
<h3 class="subsection anchored" data-number="1.5.4" data-anchor-id="usedynlib"><span class="header-section-number">1.5.4</span> <code class="code">useDynLib</code> <a href="#usedynlib-1" class="copiable-link">¶</a></h3>
<p>A <samp class="file">NAMESPACE</samp> file can contain one or more <code class="code">useDynLib</code> directives which allows shared objects that need to be loaded.<a href="#FOOT71" id="DOCF71" class="footnote"><sup>71</sup></a> The directive</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">useDynLib</span>(foo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>registers the shared object <code class="code">foo</code><a href="#FOOT72" id="DOCF72" class="footnote"><sup>72</sup></a> for loading with <code class="code">library.dynam</code>. Loading of registered object(s) occurs after the package code has been loaded and before running the load hook function. Packages that would only need a load hook function to load a shared object can use the <code class="code">useDynLib</code> directive instead.</p>
<p>The <code class="code">useDynLib</code> directive also accepts the names of the native routines that are to be used in R <em>via</em> the <code class="code">.C</code>, <code class="code">.Call</code>, <code class="code">.Fortran</code> and <code class="code">.External</code> interface functions. These are given as additional arguments to the directive, for example,</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">useDynLib</span>(foo, myRoutine, myOtherRoutine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>By specifying these names in the <code class="code">useDynLib</code> directive, the native symbols are resolved when the package is loaded and R variables identifying these symbols are added to the package’s namespace with these names. These can be used in the <code class="code">.C</code>, <code class="code">.Call</code>, <code class="code">.Fortran</code> and <code class="code">.External</code> calls in place of the name of the routine and the <code class="code">PACKAGE</code> argument. For instance, we can call the routine <code class="code">myRoutine</code> from R with the code</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">.Call</span>(myRoutine, x, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>rather than</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">.Call</span>(<span class="st">"myRoutine"</span>, x, y, <span class="at">PACKAGE =</span> <span class="st">"foo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are at least two benefits to this approach. Firstly, the symbol lookup is done just once for each symbol rather than each time the routine is invoked. Secondly, this removes any ambiguity in resolving symbols that might be present in more than one DLL. However, this approach is nowadays deprecated in favour of supplying registration information (see below).</p>
<p>In some circumstances, there will already be an R variable in the package with the same name as a native symbol. For example, we may have an R function in the package named <code class="code">myRoutine</code>. In this case, it is necessary to map the native symbol to a different R variable name. This can be done in the <code class="code">useDynLib</code> directive by using named arguments. For instance, to map the native symbol name <code class="code">myRoutine</code> to the R variable <code class="code">myRoutine_sym</code>, we would use</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">useDynLib</span>(foo, <span class="at">myRoutine_sym =</span> myRoutine, myOtherRoutine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We could then call that routine from R using the command</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">.Call</span>(myRoutine_sym, x, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Symbols without explicit names are assigned to the R variable with that name.</p>
<p>In some cases, it may be preferable not to create R variables in the package’s namespace that identify the native routines. It may be too costly to compute these for many routines when the package is loaded if many of these routines are not likely to be used. In this case, one can still perform the symbol resolution correctly using the DLL, but do this each time the routine is called. Given a reference to the DLL as an R variable, say <code class="code">dll</code>, we can call the routine <code class="code">myRoutine</code> using the expression</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">.Call</span>(dll<span class="sc">$</span>myRoutine, x, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code class="code">$</code> operator resolves the routine with the given name in the DLL using a call to <code class="code">getNativeSymbol</code>. This is the same computation as above where we resolve the symbol when the package is loaded. The only difference is that this is done each time in the case of <code class="code">dll$myRoutine</code>.</p>
<p>In order to use this dynamic approach (e.g., <code class="code">dll$myRoutine</code>), one needs the reference to the DLL as an R variable in the package. The DLL can be assigned to a variable by using the <code class="code">variable = dllName</code> format used above for mapping symbols to R variables. For example, if we wanted to assign the DLL reference for the DLL <code class="code">foo</code> in the example above to the variable <code class="code">myDLL</code>, we would use the following directive in the <samp class="file">NAMESPACE</samp> file:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>myDLL <span class="ot">=</span> <span class="fu">useDynLib</span>(foo, <span class="at">myRoutine_sym =</span> myRoutine, myOtherRoutine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, the R variable <code class="code">myDLL</code> is in the package’s namespace and available for calls such as <code class="code">myDLL$dynRoutine</code> to access routines that are not explicitly resolved at load time.</p>
<p>If the package has registration information (see <a href="System-and-foreign-language-interfaces.html#registering-native-routines" class="ref">Registering native routines</a>), then we can use that directly rather than specifying the list of symbols again in the <code class="code">useDynLib</code> directive in the <samp class="file">NAMESPACE</samp> file. Each routine in the registration information is specified by giving a name by which the routine is to be specified along with the address of the routine and any information about the number and type of the parameters. Using the <code class="code">.registration</code> argument of <code class="code">useDynLib</code>, we can instruct the namespace mechanism to create R variables for these symbols. For example, suppose we have the following registration information for a DLL named <code class="code">myDLL</code>:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> R_NativePrimitiveArgType foo_t<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    REALSXP<span class="op">,</span> INTSXP<span class="op">,</span> STRSXP<span class="op">,</span> LGLSXP</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> R_CMethodDef cMethods<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span><span class="st">"foo"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>foo<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> foo_t<span class="op">},</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span><span class="st">"bar_sym"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>bar<span class="op">,</span> <span class="dv">0</span><span class="op">},</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span>NULL<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> NULL<span class="op">}</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> R_CallMethodDef callMethods<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span><span class="st">"R_call_sym"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>R_call<span class="op">,</span> <span class="dv">4</span><span class="op">},</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span><span class="st">"R_version_sym"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>R_version<span class="op">,</span> <span class="dv">0</span><span class="op">},</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span>NULL<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">}</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, the directive in the <samp class="file">NAMESPACE</samp> file</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">useDynLib</span>(myDLL, <span class="at">.registration =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>causes the DLL to be loaded and also for the R variables <code class="code">foo</code>, <code class="code">bar_sym</code>, <code class="code">R_call_sym</code> and <code class="code">R_version_sym</code> to be defined in the package’s namespace.</p>
<p>Note that the names for the R variables are taken from the entry in the registration information and do not need to be the same as the name of the native routine. This allows the creator of the registration information to map the native symbols to non-conflicting variable names in R, e.g.&nbsp;<code class="code">R_version</code> to <code class="code">R_version_sym</code> for use in an R function such as</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>R_version <span class="ot">&lt;-</span> <span class="cf">function</span>()</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(R_version_sym)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using argument <code class="code">.fixes</code> allows an automatic prefix to be added to the registered symbols, which can be useful when working with an existing package. For example, package <a href="https://CRAN.R-project.org/package=KernSmooth" class="url"><strong>KernSmooth</strong></a> has</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">useDynLib</span>(KernSmooth, <span class="at">.registration =</span> <span class="cn">TRUE</span>, <span class="at">.fixes =</span> <span class="st">"F_"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which makes the R variables corresponding to the Fortran symbols <code class="code">F_bkde</code> and so on, and so avoid clashes with R code in the namespace.</p>
<p><strong>NB</strong>: Using these arguments for a package which does not register native symbols merely slows down the package loading (although many CRAN packages have done so). Once symbols are registered, check that the corresponding R variables are not accidentally exported by a pattern in the <samp class="file">NAMESPACE</samp> file.</p>
</section>
<section id="an-example" class="level3 subsection" data-number="1.5.5">
<h3 class="subsection anchored" data-number="1.5.5" data-anchor-id="an-example"><span class="header-section-number">1.5.5</span> An example <a href="#an-example-1" class="copiable-link">¶</a></h3>
<p>As an example consider two packages named <strong>foo</strong> and <strong>bar</strong>. The R code for package <strong>foo</strong> in file <samp class="file">foo.R</samp> is</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb105"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>f <span class="op">&lt;-</span> function<span class="op">(</span>y<span class="op">)</span> c<span class="op">(</span>x<span class="op">,</span>y<span class="op">)</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>foo <span class="op">&lt;-</span> function<span class="op">(</span>x<span class="op">)</span> <span class="op">.</span>Call<span class="op">(</span><span class="st">"foo"</span><span class="op">,</span> x<span class="op">,</span> PACKAGE<span class="op">=</span><span class="st">"foo"</span><span class="op">)</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>print<span class="op">.</span>foo <span class="op">&lt;-</span> function<span class="op">(</span>x<span class="op">,</span> <span class="op">...)</span> cat<span class="op">(</span><span class="st">"&lt;a foo&gt;</span><span class="sc">\n</span><span class="st">"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>Some C code defines a C function compiled into DLL <code class="code">foo</code> (with an appropriate extension). The <samp class="file">NAMESPACE</samp> file for this package is</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb106"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>useDynLib<span class="op">(</span>foo<span class="op">)</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>export<span class="op">(</span>f<span class="op">,</span> foo<span class="op">)</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>S3method<span class="op">(</span>print<span class="op">,</span> foo<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>The second package <strong>bar</strong> has code file <samp class="file">bar.R</samp></p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>c <span class="ot">&lt;-</span> <span class="cf">function</span>(...) <span class="fu">sum</span>(...)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="cf">function</span>(y) <span class="fu">f</span>(<span class="fu">c</span>(y, <span class="dv">7</span>))</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="cf">function</span>(y) y<span class="sc">+</span><span class="dv">9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>and <samp class="file">NAMESPACE</samp> file</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">import</span>(foo)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="fu">export</span>(g, h)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>Calling <code class="code">library(bar)</code> loads <strong>bar</strong> and attaches its exports to the search path. Package <strong>foo</strong> is also loaded but not attached to the search path. A call to <code class="code">g</code> produces</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">g</span>(<span class="dv">6</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>]  <span class="dv">1</span> <span class="dv">13</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is consistent with the definitions of <code class="code">c</code> in the two settings: in <strong>bar</strong> the function <code class="code">c</code> is defined to be equivalent to <code class="code">sum</code>, but in <strong>foo</strong> the variable <code class="code">c</code> refers to the standard function <code class="code">c</code> in <strong>base</strong>.</p>
</section>
<section id="namespaces-with-s4-classes-and-methods" class="level3 subsection" data-number="1.5.6">
<h3 class="subsection anchored" data-number="1.5.6" data-anchor-id="namespaces-with-s4-classes-and-methods"><span class="header-section-number">1.5.6</span> Namespaces with S4 classes and methods <a href="#namespaces-with-s4-classes-and-methods-1" class="copiable-link">¶</a></h3>
<p>Some additional steps are needed for packages which make use of formal (S4-style) classes and methods (unless these are purely used internally). The package should have <code class="code">Depends: methods</code><a href="#FOOT73" id="DOCF73" class="footnote"><sup>73</sup></a> in its <samp class="file">DESCRIPTION</samp> and <code class="code">import(methods)</code> or <code class="code">importFrom(methods, ...)</code> plus any classes and methods which are to be exported need to be declared in the <samp class="file">NAMESPACE</samp> file. For example, the <strong>stats4</strong> package has</p>
<p><span id="index-exportClasses" class="index-entry-id"></span> <span id="index-exportMethods" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb110"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>export<span class="op">(</span>mle<span class="op">)</span> # exporting methods implicitly exports the generic</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>importFrom<span class="op">(</span><span class="st">"stats"</span><span class="op">,</span> approx<span class="op">,</span> optim<span class="op">,</span> pchisq<span class="op">,</span> predict<span class="op">,</span> qchisq<span class="op">,</span> qnorm<span class="op">,</span> spline<span class="op">)</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># For these, we define methods or (AIC, BIC, nobs) an implicit generic:</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>importFrom<span class="op">(</span><span class="st">"stats"</span><span class="op">,</span> AIC<span class="op">,</span> BIC<span class="op">,</span> coef<span class="op">,</span> confint<span class="op">,</span> logLik<span class="op">,</span> nobs<span class="op">,</span> profile<span class="op">,</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>           update<span class="op">,</span> vcov<span class="op">)</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>exportClasses<span class="op">(</span>mle<span class="op">,</span> profile<span class="op">.</span>mle<span class="op">,</span> summary<span class="op">.</span>mle<span class="op">)</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># All methods for imported generics:</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>exportMethods<span class="op">(</span>coef<span class="op">,</span> confint<span class="op">,</span> logLik<span class="op">,</span> plot<span class="op">,</span> profile<span class="op">,</span> summary<span class="op">,</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>              show<span class="op">,</span> update<span class="op">,</span> vcov<span class="op">)</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># implicit generics which do not have any methods here</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>export<span class="op">(</span>AIC<span class="op">,</span> BIC<span class="op">,</span> nobs<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span id="index-exportPattern-1" class="index-entry-id"></span> <span id="index-exportClassPattern" class="index-entry-id"></span></p>
<p>All S4 classes to be used outside the package need to be listed in an <code class="code">exportClasses</code> directive. Alternatively, they can be specified using <code class="code">exportClassPattern</code><a href="#FOOT74" id="DOCF74" class="footnote"><sup>74</sup></a> in the same style as for <code class="code">exportPattern</code>. To export methods for generics from other packages an <code class="code">exportMethods</code> directive can be used.</p>
<p>Note that exporting methods on a generic in the namespace will also export the generic, and exporting a generic in the namespace will also export its methods. If the generic function is not local to this package, either because it was imported as a generic function or because the non-generic version has been made generic solely to add S4 methods to it (as for functions such as <code class="code">coef</code> in the example above), it can be declared <em>via</em> either or both of <code class="code">export</code> or <code class="code">exportMethods</code>, but the latter is clearer (and is used in the <strong>stats4</strong> example above). In particular, for primitive functions there is no generic function, so <code class="code">export</code> would export the primitive, which makes no sense. On the other hand, if the generic is local to this package, it is more natural to export the function itself using <code class="code">export()</code>, and this <em>must</em> be done if an implicit generic is created without setting any methods for it (as is the case for <code class="code">AIC</code> in <strong>stats4</strong>).</p>
<p>A non-local generic function is only exported to ensure that calls to the function will dispatch the methods from this package (and that is not done or required when the methods are for primitive functions). For this reason, you do not need to document such implicitly created generic functions, and <code class="code">undoc</code> in package <strong>tools</strong> will not report them.</p>
<p>If a package uses S4 classes and methods exported from another package, but does not import the entire namespace of the other package<a href="#FOOT75" id="DOCF75" class="footnote"><sup>75</sup></a>, it needs to import the classes and methods explicitly, with directives</p>
<p><span id="index-importClassesFrom" class="index-entry-id"></span> <span id="index-importMethodsFrom" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">importClassesFrom</span>(package, ...)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">importMethodsFrom</span>(package, ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>listing the classes and functions with methods respectively. Suppose we had two small packages <strong>A</strong> and <strong>B</strong> with <strong>B</strong> using <strong>A</strong>. Then they could have <code class="code">NAMESPACE</code> files</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">export</span>(f1, ng1)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="fu">exportMethods</span>(<span class="st">"["</span>)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="fu">exportClasses</span>(c1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>and</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">importFrom</span>(A, ng1)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="fu">importClassesFrom</span>(A, c1)</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="fu">importMethodsFrom</span>(A, f1)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="fu">export</span>(f4, f5)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="fu">exportMethods</span>(f6, <span class="st">"["</span>)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="fu">exportClasses</span>(c1, c2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>respectively.</p>
<p>Note that <code class="code">importMethodsFrom</code> will also import any generics defined in the namespace on those methods.</p>
<p>It is important if you export S4 methods that the corresponding generics are available. You may for example need to import <code class="code">coef</code> from <strong>stats</strong> to make visible a function to be converted into its implicit generic. But it is better practice to make use of the generics exported by <strong>stats4</strong> as this enables multiple packages to unambiguously set methods on those generics.</p>
</section>
</section>
<section id="writing-portable-packages" class="level2 section" data-number="1.6">
<h2 class="section anchored" data-number="1.6" data-anchor-id="writing-portable-packages"><span class="header-section-number">1.6</span> Writing portable packages <a href="#writing-portable-packages-1" class="copiable-link">¶</a></h2>
<p>This section contains advice on writing packages to be used on multiple platforms or for distribution (for example to be submitted to a package repository such as CRAN).</p>
<p>Portable packages should have simple file names: use only alphanumeric ASCII characters and period (<code class="code">.</code>), and avoid those names not allowed under Windows (see <a href="#package-structure" class="pxref">Package structure</a>).</p>
<p>Many of the graphics devices are platform-specific: even <code class="code">X11()</code> (aka <code class="code">x11()</code>) which although emulated on Windows may not be available on a Unix-alike (and is not the preferred screen device on OS X). It is rarely necessary for package code or examples to open a new device, but if essential,<a href="#FOOT76" id="DOCF76" class="footnote"><sup>76</sup></a> use <code class="code">dev.new()</code>.</p>
<p>Use <code class="command">R CMD build</code> to make the release <samp class="file">.tar.gz</samp> file.</p>
<p><code class="command">R CMD check</code> provides a basic set of checks, but often further problems emerge when people try to install and use packages submitted to CRAN – many of these involve compiled code. Here are some further checks that you can do to make your package more portable.</p>
<ul>
<li><p>If your package has a <samp class="file">configure</samp> script, provide a <samp class="file">configure.win</samp> or <samp class="file">configure.ucrt</samp> script to be used on Windows (an empty <samp class="file">configure.win</samp> file if no actions are needed).</p></li>
<li><p>If your package has a <samp class="file">Makevars</samp> or <samp class="file">Makefile</samp> file, make sure that you use only portable make features. Such files should be LF-terminated<a href="#FOOT77" id="DOCF77" class="footnote"><sup>77</sup></a> (including the final line of the file) and not make use of GNU extensions. (The POSIX specification is available at <a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/make.html" class="uref">https://pubs.opengroup.org/onlinepubs/9699919799/utilities/make.html</a>; anything not documented there should be regarded as an extension to be avoided. Further advice can be found at <a href="https://www.gnu.org/software/autoconf/manual/autoconf.html#Portable-Make" class="uref">https://www.gnu.org/software/autoconf/manual/autoconf.html#Portable-Make</a>. ) Commonly misused GNU extensions are conditional inclusions (<code class="code">ifeq</code> and the like), <code class="code">${shell ...}</code>, <code class="code">${wildcard ...}</code> and similar, and the use of <code class="code">+=</code><a href="#FOOT78" id="DOCF78" class="footnote"><sup>78</sup></a> and <code class="code">:=</code>. Also, the use of <code class="code">$&lt;</code> other than in implicit rules is a GNU extension, as is the <code class="code">$^</code> macro. As is the use of <code class="code">.PHONY</code> (some other makes ignore it). Unfortunately makefiles which use GNU extensions often run on other platforms but do not have the intended results.</p>
<p>Note that the <samp class="option">-C</samp> flag for <code class="command">make</code> is not included in the POSIX specification and is not implemented by some of the <code class="command">make</code>s which have been used with R. However, it is more commonly implemented (e.g.&nbsp;by FreeBSD <code class="command">make</code>) than the GNU-specific <samp class="option">--directory=</samp>.</p>
<p>You should not rely on built-in/default <code class="command">make</code> rules, even when specified by POSIX, as some <code class="command">make</code>s do not have the POSIX ones and others have altered them.</p>
<p>The use of <code class="code">${shell ...}</code> can be avoided by using backticks, e.g.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>PKG_CPPFLAGS <span class="op">=</span> `gsl<span class="op">-</span>config <span class="op">--</span>cflags`</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which works in all versions of <code class="command">make</code> known<a href="#FOOT79" id="DOCF79" class="footnote"><sup>79</sup></a> to be used with R.</p>
<p>If you really must require GNU make, declare it in the <samp class="file">DESCRIPTION</samp> file by</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>SystemRequirements: GNU make</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and ensure that you use the value of environment variable <code class="env">MAKE</code> (and not just <code class="command">make</code>) in your scripts. (On some platforms GNU make is available under a name such as <code class="command">gmake</code>, and there <code class="code">SystemRequirements</code> is used to set <code class="env">MAKE</code>.) Your <code class="code">configure</code> script (or similar) does need to check that the executable pointed to by <code class="env">MAKE</code> is indeed GNU make.</p>
<p>If you only need GNU make for parts of the package which are rarely needed (for example to create bibliography files under <samp class="file">vignettes</samp>), use a file called <samp class="file">GNUmakefile</samp> rather than <samp class="file">Makefile</samp> as GNU make (only) will use the former.</p>
<p>macOS has used GNU make for many years (it previously used BSD make), but the version has been frozen at 3.81 (from 2006).</p>
<p>Since the only viable make for Windows is GNU make, it is permissible to use GNU extensions in files <samp class="file">Makevars.win</samp>, <samp class="file">Makevars.ucrt</samp>, <samp class="file">Makefile.win</samp> or <samp class="file">Makefile.ucrt</samp>.</p></li>
<li><p>If you use <samp class="file">src/Makevars</samp> to compile code in a subdirectory, ensure that you have followed all the advice above. In particular</p>
<ul>
<li>Anticipate a parallel <code class="command">make</code>. See <a href="#using-makevars" class="xref">Using <samp class="file">Makevars</samp></a>.</li>
<li>Pass macros down to the makefile in the subdirectory, including <strong>all</strong> the needed compiler flags (including PIC and visibility flags). If they are used (even by a default rule) in the subdirectory’s Makefile, this includes macros <samp class="samp">AR</samp>’ and <samp class="samp">RANLIB</samp>’. See <a href="#compiling-in-sub-directories" class="xref">Compiling in sub-directories</a>, which has a C example. A C++ example: <code>makefile     pkg/libpkg.a:             (cd pkg &amp;&amp; $(MAKE) -f make_pkg libpkg.a \              CXX="$(CXX)" CXXFLAGS="$(CXXFLAGS) $(CXXPICFLAGS) $(C_VISIBILITY)" \              AR="$(AR)" RANLIB="$(RANLIB)")</code></li>
<li>Ensure that cleanup will be performed by <code class="command">R CMD build</code>, for example in a <code class="code">cleanup</code> script or a <samp class="samp">clean</samp>’ target.</li>
</ul></li>
<li><p>If your package uses a <samp class="file">src/Makefile</samp> file to compile code to be linked into R, ensure that it uses exactly the same compiler and flag settings that R uses when compiling such code: people often forget <samp class="samp">PIC</samp>’ flags. If <code class="code">R CMD config</code> is used, this needs something like (for C++) <code>makefile     RBIN = `"${R_HOME}/bin/R"`     CXX = `"${RBIN}" CMD config CXX`     CXXFLAGS = `"${RBIN}" CMD config CXXFLAGS` `"${RBIN}" CMD config CXXPICFLAGS`</code></p></li>
<li><p>Names of source files including <samp class="file">=</samp> (such as <samp class="file">src/complex_Sig=gen.c</samp>) will confuse some <code class="command">make</code> programs and should be avoided.</p></li>
<li><p>Bash extensions also need to be avoided in shell scripts, including expressions in Makefiles (which are passed to the shell for processing). Some R platforms use strict<a href="#FOOT80" id="DOCF80" class="footnote"><sup>80</sup></a> Bourne shells: an earlier R toolset on Windows<a href="#FOOT81" id="DOCF81" class="footnote"><sup>81</sup></a> and some Unix-alike OSes use <code class="command">ash</code> (<a href="https://en.wikipedia.org/wiki/Almquist_shell" class="uref">https://en.wikipedia.org/wiki/Almquist_shell</a>, a ’lightweight shell with few builtins) or derivatives such as <code class="command">dash</code>. Beware of assuming that all the POSIX command-line utilities are available, especially on Windows where only a subset (which has changed by version of <samp class="file">Rtools</samp>) is provided for use with R. One particular issue is the use of <code class="command">echo</code>, for which two behaviours are allowed (<a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/echo.html" class="uref">https://pubs.opengroup.org/onlinepubs/9699919799/utilities/echo.html</a>) and both have occurred as defaults on R platforms: portable applications should use neither <samp class="option">-n</samp> (as the first argument) nor escape sequences. The recommended replacement for <code class="command">echo -n</code> is the command <code class="command">printf</code>. Another common issue is the construction</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>export FOO<span class="ot">=</span>value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which is <code class="command">bash</code>-specific (first set the variable then export it by name).</p>
<p>Using <code class="code">test -e</code> (or <code class="code">[ -e ]</code>) in shell scripts is not fully portable<a href="#FOOT82" id="DOCF82" class="footnote"><sup>82</sup></a>: <code class="code">-f</code> is normally what is intended. Flags <samp class="option">-a</samp> and <samp class="option">-o</samp> are nowadays declared obsolescent by POSIX and should not be used.</p>
<p>Use of ‘brace expansion’, e.g.,</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>rm <span class="sc">-</span>f src<span class="sc">/</span><span class="er">*</span>.{o,so,d}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>is not portable.</p>
<p>The <samp class="option">-o</samp> flag for <code class="command">set</code> in shell scripts is optional in POSIX and not supported on all the platforms R is used on.</p>
<p>The variable <samp class="samp">OSTYPE</samp>’ is shell-specific and its values are rather unpredictable and may include a version such as <samp class="samp">darwin19.0</samp>‘: <code>uname</code> {.command} is often what is intended (with common values <samp class="samp">Darwin</samp>’ and <samp class="samp">Linux</samp>’).</p>
<p>On macOS which shell <samp class="file">/bin/sh</samp> invokes is user- and platform-dependent: it might be <code class="command">bash</code> version 3.2, <code class="command">dash</code> or <code class="command">zsh</code> (for new accounts it is <code class="command">zsh</code>, for accounts ported from Mojave or earlier it is usually <code class="command">bash</code>).</p>
<p>It is not portable to specify <code class="command">bash</code> as the shell let alone a specific path such as <samp class="file">/bin/bash</samp>.</p></li>
<li><p>R is not built by default as a shared library on non-Windows platforms (although it commonly is on macOS to support the GUI), so there need not be a file <samp class="file">libR.so</samp> nor <samp class="file">libR.dylib</samp>. Users of <code class="command">cmake</code> or <code class="command">rust</code> have all too frequently assumed otherwise, so do ensure your package is checked under a vanilla R build. See <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Configuration-options" data-manual="R-admin">Configuration options</a> in R Installation and Administration for more information.</p></li>
<li><p>Make use of the abilities of your compilers to check the standards-conformance of your code. For example, <code class="command">gcc</code>, <code class="command">clang</code> and <code class="command">gfortran</code><a href="#FOOT83" id="DOCF83" class="footnote"><sup>83</sup></a> can be used with options <samp class="option">-Wall -pedantic</samp> to alert you to potential problems. This is particularly important for C++, where <code class="code">g++ -Wall -pedantic</code> will alert you to the use of some of the GNU extensions which fail to compile on most other C++ compilers. If R was not configured accordingly, one can achieve this <em>via</em> personal <samp class="file">Makevars</samp> files. See <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Customizing-package-compilation" data-manual="R-admin">Customizing package compilation</a> in R Installation and Administration for more information.</p>
<p>Portable C++ code needs to follow all of the 2011, 2014 and 2017 standards (including not using deprecated/removed features) or to specify C+11/14/17/20/23 where available (which is not the case on all R platforms). Currently C++20 support is patchy across R platforms.</p>
<p>If using Fortran with the GNU compiler, use the flags <samp class="option">-std=f95 -Wall -pedantic</samp> which reject most GNU extensions and features from later standards. (Although R only requires Fortran 90, <code class="command">gfortran</code> does not have a way to specify that standard.) Also consider <samp class="option">-std=f2008</samp> as some recent compilers have Fortran 2008 or even 2018 as the minimum supported standard.</p>
<p>As from macOS 11 (late 2020), its C compiler sets the flag <samp class="option">-Werror=implicit-function-declaration</samp> by default which forces stricter conformance to C99. This can be used on other platforms with <code class="command">gcc</code> or <code class="command">clang</code>. If your package has a (<code class="command">autoconf</code>-generated) <code class="command">configure script</code>, try installing it whilst using this flag, and read through the <samp class="file">config.log</samp> file — compilation warnings and errors can lead to features which are present not being detected. (If possible do this on several platforms.)</p></li>
<li><p><code class="command">R CMD check</code> performs some checks for non-portable compiler/linker flags in <samp class="file">src/Makevars</samp>. However, it cannot check the meaning of such flags, and some are commonly accepted but with compiler-specific meanings. There are other non-portable flags which are not checked, nor are <samp class="file">src/Makefile</samp> files and makefiles in sub-directories. As a comment in the code says</p>
<blockquote class="blockquote">
<p>It is hard to think of anything apart from <samp class="option">-I*</samp> and <samp class="option">-D*</samp> that is safe for general use …</p>
</blockquote>
<p>although <samp class="option">-pthread</samp> is pretty close to portable. (Option <samp class="option">-U</samp> is portable but little use on the command line as it will only cancel built-in defines (not portable) and those defined earlier on the command line (R does not use any).)</p>
<p>The GNU option <samp class="option">-pipe</samp> used to be widely accepted by C/C++/Fortran compilers, but has been removed in <code class="command">flang-new</code>&nbsp;18. In any case, it should not be used in distributed code as it may lead to excessive memory use.</p>
<p>People have used <code class="command">configure</code> to customize <samp class="file">src/Makevars</samp>, including for specific compilers. This is unsafe for several reasons. First, unintended compilers might meet the check—for example, several compilers other than GCC identify themselves as ‘GCC’ whilst being only partially conformant. Second, future versions of compilers may behave differently (including updates to quite old series) so for example <samp class="option">-Werror</samp> (and specializations) can make a package non-installable under a future version. Third, using flags to suppress diagnostic messages can hide important information for debugging on a platform not tested by the package maintainer. (<code class="command">R CMD check</code> can optionally report on unsafe flags which were used.)</p>
<p>Avoid the use of <samp class="option">-march</samp> and especially <samp class="option">-march=native</samp>. This allows the compiler to generate code that will only run on a particular class of CPUs (that of the compiling machine for <samp class="samp">native</samp>‘). People assume this is a ’minimum’ CPU specification, but that is not how it is documented for <code class="command">gcc</code> (it is accepted by <code class="command">clang</code> but apparently it is undocumented what precisely it does, and it can be accepted and may be ignored for other compilers). (For personal use <samp class="option">-mtune</samp> is safer, but still not portable enough to be used in a public package.) Not even <code class="command">gcc</code> supports <samp class="samp">native</samp>’ for all CPUs, and it can do surprising things if it finds a CPU released later than its version.</p></li>
<li><p>Do be very careful with passing arguments between R, C and Fortran code. In particular, <code class="code">long</code> in C will be 32-bit on some R platforms (including 64-bit Windows), but 64-bit on most modern Unix and Linux platforms. It is rather unlikely that the use of <code class="code">long</code> in C code has been thought through: if you need a longer type than <code class="code">int</code> you should use a configure test for a C99/C++11 type such as <code class="code">int_fast64_t</code> (and failing that, <code class="code">long long</code>) and typedef your own type, or use another suitable type (such as <code class="code">size_t</code>, but beware that is unsigned and <code class="code">ssize_t</code> is not portable).</p>
<p>It is not safe to assume that <code class="code">long</code> and pointer types are the same size, and they are not on 64-bit Windows. If you need to convert pointers to and from integers use the C99/C++11 integer types <code class="code">intptr_t</code> and <code class="code">uintptr_t</code> (in the headers <code class="code">&lt;stdint.h&gt;</code> and <code class="code">&lt;cstdint&gt;</code>: they are not required to be implemented by the standards but are used in C code by R itself).</p>
<p>Note that <code class="code">integer</code> in Fortran corresponds to <code class="code">int</code> in C on all R platforms. There is no such guarantee for Fortran <code class="code">logical</code>, and recent <code class="command">gfortran</code> maps it to <code class="code">int_least32_t</code> on most platforms.</p></li>
<li><p>Under no circumstances should your compiled code ever call <code class="code">abort</code> or <code class="code">exit</code><a href="#FOOT84" id="DOCF84" class="footnote"><sup>84</sup></a>: these terminate the user’s R process, quite possibly losing all unsaved work. One usage that could call <code class="code">abort</code> is the <code class="code">assert</code> macro in C or C++ functions, which should never be active in production code. The normal way to ensure that is to define the macro <code class="code">NDEBUG</code>, and <code class="command">R CMD INSTALL</code> does so as part of the compilation flags. Beware of including headers (including from other packages) which could undefine it, now or in future versions. If you wish to use <code class="code">assert</code> during development, you can include <code class="code">-UNDEBUG</code> in <code class="code">PKG_CPPFLAGS</code> or <code class="code">#undef</code> it in your headers or code files. Note that your own <samp class="file">src/Makefile</samp> or makefiles in sub-directories may also need to define <code class="code">NDEBUG</code>.</p>
<p>This applies not only to your own code but to any external software you compile in or link to.</p>
<p>Nor should Fortran code call <code class="code">STOP</code> nor <code class="code">EXIT</code> (a GNU extension).</p></li>
<li><p>Compiled code should not write to <samp class="file">stdout</samp> or <samp class="file">stderr</samp> and C++ and Fortran I/O should not be used. As with the previous item such calls may come from external software and may never be called, but package authors are often mistaken about that.</p></li>
<li><p>Compiled code should not call the system random number generators such as <code class="code">rand</code>, <code class="code">drand48</code> and <code class="code">random</code><a href="#FOOT85" id="DOCF85" class="footnote"><sup>85</sup></a>, but rather use the interfaces to R’s RNGs described in <a href="The-R-API.html#random-numbers" class="ref">Random number generation</a>. In particular, if more than one package initializes a system RNG (e.g.&nbsp;<em>via</em> <code class="code">srand</code>), they will interfere with each other. This applies also to Fortran 90’s <code class="code">random_number</code> and <code class="code">random_seed</code>, and Fortran 2018’s <code class="code">random_init</code>. And to GNU Fortran’s <code class="code">rand</code>, <code class="code">irand</code> and <code class="code">srand</code>. Except for <code class="code">drand48</code>, what PRNG these functions use is implementation-dependent.</p>
<p>Nor should the C++11 random number library be used nor any other third-party random number generators such as those in GSL.</p></li>
<li><p>Use of <code class="code">sprintf</code> and <code class="code">vsprintf</code> is regarded as a potential security risk and warned about on some platforms.<a href="#FOOT86" id="DOCF86" class="footnote"><sup>86</sup></a> <code class="command">R CMD check</code> reports if any calls are found.</p></li>
<li><p>Errors in memory allocation and reading/writing outside arrays are very common causes of crashes (e.g., segfaults) on some machines. See <a href="Debugging.html#checking-memory-access" class="ref">Checking memory access</a> for tools which can be used to look for this.</p></li>
<li><p>Many platforms will allow unsatisfied entry points in compiled code, but will crash the application (here R) if they are ever used. Some (notably Windows) will not. Looking at the output of</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>nm <span class="sc">-</span>pg mypkg.so</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and checking if any of the symbols marked <code class="code">U</code> is unexpected is a good way to avoid this.</p></li>
<li><p>Linkers have a lot of freedom in how to resolve entry points in dynamically-loaded code, so the results may differ by platform. One area that has caused grief is packages including copies of standard system software such as <code class="code">libz</code> (especially those already linked into R). In the case in point, entry point <code class="code">gzgets</code> was sometimes resolved against the old version compiled into the package, sometimes against the copy compiled into R and sometimes against the system dynamic library. The only safe solution is to rename the entry points in the copy in the package. We have even seen problems with entry point name <code class="code">myprintf</code>, which is a system entry point<a href="#FOOT87" id="DOCF87" class="footnote"><sup>87</sup></a> on some Linux systems.</p>
<p>A related issue is the naming of libraries built as part of the package installation. macOS and Windows have case-insensitive file systems, so using</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span>L. <span class="sc">-</span>lLZ4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in <code class="code">PKG_LIBS</code> will match <code class="code">liblz4</code>. And <code class="code">-L.</code> only appends to the list of searched locations, and <code class="code">liblz4</code> might be found in an earlier-searched location (and has been). The only safe way is to give an explicit path, for example</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>.<span class="sc">/</span>libLZ4.a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Conflicts between symbols in DLLs are handled in very platform-specific ways. Good ways to avoid trouble are to make as many symbols as possible static (check with <code class="code">nm -pg</code>), and to use names which are clearly tied to your package (which also helps users if anything does go wrong). Note that symbol names starting with <code class="code">R_</code> are regarded as part of R’s namespace and should not be used in packages.</p></li>
<li><p>It is good practice for DLLs to register their symbols (see <a href="System-and-foreign-language-interfaces.html#registering-native-routines" class="pxref">Registering native routines</a>), restrict visibility (see <a href="The-R-API.html#controlling-visibility" class="pxref">Controlling visibility</a>) and not allow symbol search (see <a href="System-and-foreign-language-interfaces.html#registering-native-routines" class="pxref">Registering native routines</a>). It should be possible for a DLL to have only one visible symbol, <code class="code">R_init_</code><var class="var">pkgname</var>, on suitable platforms<a href="#FOOT88" id="DOCF88" class="footnote"><sup>88</sup></a>, which would completely avoid symbol conflicts.</p></li>
<li><p>It is not portable to call compiled code in R or other packages <em>via</em> <code class="code">.Internal</code>, <code class="code">.C</code>, <code class="code">.Fortran</code>, <code class="code">.Call</code> or <code class="code">.External</code>, since such interfaces are subject to change without notice and will probably result in your code terminating the R process.</p></li>
<li><p>Do not use (hard or symbolic) file links in your package sources. Where possible <code class="command">R CMD build</code> will replace them by copies.</p></li>
<li><p>If you do not yourself have a Windows system, consider submitting your source package to WinBuilder (<a href="https://win-builder.r-project.org/" class="uref">https://win-builder.r-project.org/</a>) before distribution. If you need to check on an M1 Mac, there is a check service at <a href="https://mac.r-project.org/macbuilder/submit.html" class="uref">https://mac.r-project.org/macbuilder/submit.html</a>.</p></li>
<li><p>It is bad practice for package code to alter the search path using <code class="code">library</code>, <code class="code">require</code> or <code class="code">attach</code> and this often does not work as intended. For alternatives, see <a href="#suggested-packages" class="ref">Suggested packages</a> and <code class="code">with()</code>.</p></li>
<li><p>Examples can be run interactively <em>via</em> <code class="code">example</code> as well as in batch mode when checking. So they should behave appropriately in both scenarios, conditioning by <code class="code">interactive()</code> the parts which need an operator or observer. For instance, progress bars<a href="#FOOT89" id="DOCF89" class="footnote"><sup>89</sup></a> are only appropriate in interactive use, as is displaying help pages or calling <code class="code">View()</code> (see below).</p></li>
<li><p>Be careful with the order of entries in macros such as <code class="code">PKG_LIBS</code>. Some linkers will re-order the entries, and behaviour can differ between dynamic and static libraries. Generally <samp class="option">-L</samp> options should precede<a href="#FOOT90" id="DOCF90" class="footnote"><sup>90</sup></a> the libraries (typically specified by <samp class="option">-l</samp> options) to be found from those directories, and libraries are searched once in the order they are specified. Not all linkers allow a space after <samp class="option">-L</samp> .</p></li>
<li><p>Care is needed with the use of <code class="code">LinkingTo</code>. This puts one or more directories on the include search path ahead of system headers but (prior to R 3.4.0) after those specified in the <code class="code">CPPFLAGS</code> macro of the R build (which normally includes <code class="code">-I/usr/local/include</code>, but most platforms ignore that and include it with the system headers).</p>
<p>Any confusion would be avoided by having <code class="code">LinkingTo</code> headers in a directory named after the package. In any case, name conflicts of headers and directories under package <samp class="file">include</samp> directories should be avoided, both between packages and between a package and system and third-party software.</p></li>
<li><p>The <code class="command">ar</code> utility is often used in makefiles to make static libraries. Its modifier <code class="code">u</code> is defined by POSIX but is disabled in GNU <code class="command">ar</code> on some Linux distributions which use ‘deterministic mode’. The safest way to make a static library is to first remove any existing file of that name then use <code class="command">$(AR) -cr</code> and then <code class="command">$(RANLIB)</code> if needed (which is system-dependent: on most systems<a href="#FOOT91" id="DOCF91" class="footnote"><sup>91</sup></a> <code class="command">ar</code> always maintains a symbol table). The POSIX standard says options should be preceded by a hyphen (as in <samp class="option">-cr</samp>), although most OSes accept them without. Note that on some systems <code class="command">ar -cr</code> must have at least one file specified.</p>
<p>The <code class="code">s</code> modifier (to replace a separate call to <code class="command">ranlib</code>) is required by X/OPEN but not POSIX, so <code class="command">ar -crs</code> is not portable.</p>
<p>For portability the <code class="code">AR</code> and <code class="code">RANLIB</code> macros should always be used – some builds require wrappers such as <code class="command">gcc-ar</code> or extra arguments to specify plugins.</p></li>
<li><p>The <code class="command">strip</code> utility is platform-specific (and CRAN prohibits removing debug symbols). For example the options <samp class="option">--strip-debug</samp> and <samp class="option">--strip-unneeded</samp> of the GNU version are not supported on macOS: the POSIX standard for <code class="command">strip</code> does not mention any options, and what calling it without options does is platform-dependent. Stripping a <samp class="file">.so</samp> file could even prevent it being dynamically loaded into R on an untested platform.</p>
<p><code class="command">ld -S</code> invokes <code class="command">strip --strip-debug</code> for GNU <code class="command">ld</code> (and similarly on macOS) but is not portable: in particular on Solaris it did something completely different and took an argument.</p></li>
<li><p>Some people have a need to set a locale. Locale names are not portable, and e.g.&nbsp;<samp class="samp">fr_FR.utf8</samp>’ is commonly used on Linux but not accepted on macOS. <samp class="samp">fr_FR.UTF-8</samp>’ is more portable, being accepted on recent Linux, AIX, FreeBSD, macOS and Solaris (at least). However, some Linux distributions micro-package, so locales defined by <strong>glibc</strong> (including these examples) may not be installed.</p></li>
<li><p>Avoid spaces in file names, not least as they can cause difficulties for external tools. An example was a package with a <a href="https://CRAN.R-project.org/package=knitr" class="url"><strong>knitr</strong></a> vignette that used spaces in plot names: this caused some older versions of <code class="command">pandoc</code> to fail with a baffling error message.</p>
<p>Non-ASCII filenames can also cause problems (particularly in non-UTF-8 locales).</p></li>
<li><p>Take care in naming LaTeX macros (also known as ‘commands’) in vignette sources: if these are also defined in a future version of one of the LaTeX packages used there will be a fatal error. One instance in 2021 was package <samp class="samp">hyperref</samp>’ newly defining <samp class="samp">\C</samp>‘, <samp class="samp">\F</samp>’, <samp class="samp">\G</samp>‘, <samp class="samp">\U</samp>’ and <samp class="samp">\textapprox</samp>‘. If you are confident that your definitions will be the only ones relevant you can use <samp class="samp">\renewcommand</samp>’ but it is better to use names clearly associated with your package.</p></li>
<li><p>Make sure that any version requirement for Java code is both declared in the <samp class="samp">SystemRequirements</samp>’ field<a href="#FOOT92" id="DOCF92" class="footnote"><sup>92</sup></a> and tested at runtime (not least as the Java installation when the package is installed might not be the same as when the package is run and will not be for binary packages).</p>
<p>When specifying a minimum Java version please use the official version names, which are (confusingly)</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1.1</span> <span class="fl">1.2</span> <span class="fl">1.3</span> <span class="fl">1.4</span> <span class="fl">5.0</span> <span class="dv">6</span> <span class="dv">7</span> <span class="dv">8</span> <span class="dv">9</span> <span class="dv">10</span> <span class="dv">11</span> <span class="dv">12</span> <span class="dv">13</span> <span class="dv">14</span> <span class="dv">15</span> <span class="dv">16</span> <span class="dv">17</span> <span class="dv">18</span> <span class="dv">19</span> <span class="dv">20</span> <span class="dv">21</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and as from 2018 a year.month scheme such as <samp class="samp">18.9</samp>’ is also in use. Fortunately only the integer values are likely to be relevant. If at all possible, use one of the LTS versions (8, 11, 17, 21 …) as the minimum version. The preferred form of version specification is</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>SystemRequirements: Java (&gt;= 11)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A suitable test for Java at least version 8 for packages using <a href="https://CRAN.R-project.org/package=rJava" class="url"><strong>rJava</strong></a> would be something like</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.jinit</span>()</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>jv <span class="ot">&lt;-</span> <span class="fu">.jcall</span>(<span class="st">"java/lang/System"</span>, <span class="st">"S"</span>, <span class="st">"getProperty"</span>, <span class="st">"java.runtime.version"</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">substr</span>(jv, <span class="dv">1</span>L, <span class="dv">2</span>L) <span class="sc">==</span> <span class="st">"1."</span>) {</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  jvn <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">paste0</span>(<span class="fu">strsplit</span>(jv, <span class="st">"[.]"</span>)[[<span class="dv">1</span>L]][<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">collapse =</span> <span class="st">"."</span>))</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(jvn <span class="sc">&lt;</span> <span class="fl">1.8</span>) <span class="fu">stop</span>(<span class="st">"Java &gt;= 8 is needed for this package but not available"</span>)</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Java 9 changed the format of this string (which used to be something like <samp class="samp">1.8.0_292-b10</samp>‘); Java 11 gave <code class="code">jv</code> as <samp class="samp">11+28</samp>’ whereas Java 11.0.11 gave <samp class="samp">11.0.11+9</samp>‘. (<a href="https://openjdk.org:443/jeps/322" class="uref">https://openjdk.org:443/jeps/322</a> details the current scheme. Note that it is necessary to allow for pre-releases like <samp class="samp">11-ea+22</samp>’.)</p>
<p>Note too that the compiler used to produce a <code class="code">jar</code> can impose a minimum Java version, often resulting in an arcane message like</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>java.lang.UnsupportedClassVersionError<span class="sc">:</span> ... Unsupported major.minor version <span class="fl">52.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(Where <a href="https://en.wikipedia.org/wiki/Java_class_file" class="uref">https://en.wikipedia.org/wiki/Java_class_file</a> maps class-file version numbers to Java versions.) Compile with something like <code class="command">javac -target 11</code> to ensure this is avoided. Note this also applies to packages distributing (or even downloading) compiled Java code produced by others, so their requirements need to be checked (they are often not documented accurately) and accounted for. It should be possible to check the class-file version <em>via</em> command-line utility <code class="command">javap</code>, if necessary after extracting the <samp class="file">.class</samp> files from a <samp class="file">.jar</samp> archive. For example,</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>jar xvf some.jar</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>javap <span class="sc">-</span>verbose path<span class="sc">/</span>to<span class="sc">/</span>some.class <span class="sc">|</span> grep major</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Some packages have stated a requirement on a particular JDK, but a package should only be requiring a JRE unless providing its own Java interface.</p>
<p>Java 8 is still in widespread use (and may remain so because of licence changes and support on older OSes: OpenJDK has security support until March 2026). On the other hand, newer platforms may only have support for recent versions of Java: for <samp class="samp">arm64</samp>’ macOS the first officially supported version was 17.</p></li>
<li><p>A package with a hard-to-satisfy system requirement is by definition not portable, annoyingly so if this is not declared in the <samp class="samp">SystemRequirements</samp>’ field. The most common example is the use of <code class="command">pandoc</code>, which is only available for a very limited range of platforms (and has onerous requirements to install from source) and has capabilities<a href="#FOOT93" id="DOCF93" class="footnote"><sup>93</sup></a> that vary by build but are not documented. Several recent versions of <code class="command">pandoc</code> for macOS did not work on R’s then target of High Sierra (and this too was undocumented). Another example is the Rust compilation system (<code class="command">cargo</code> and <code class="command">rustc</code>).</p>
<p>Usage of external commands should always be conditional on a test for presence (perhaps using <code class="code">Sys.which</code>), as well as declared in the <samp class="samp">SystemRequirements</samp>’ field. A package should pass its checks without warnings nor errors without the external command being present.</p>
<p>An external command can be a (possibly optional) requirement for an imported or suggested package but needed for examples, tests or vignettes in the package itself. Such usages should always be declared and conditional.</p>
<p>Interpreters for scripting languages such as Perl, Python and Ruby need to be declared as system requirements and used conditionally: for example macOS 10.16 was announced not to have them (but released as macOS 11 with them); later it was announced that macOS 12.3 does not have Python 2 and only a minimal install of Python 3 is included. Python 2 has passed end-of-life and been removed from many major distributions. Support for Rust or Go cannot be assumed.</p>
<p>Command <code class="command">cmake</code> is not commonly installed, and where it is, it might not be on the path. In particular, the most common location on macOS is <samp class="file">/Applications/CMake.app/Contents/bin/cmake</samp> and that should be looked for if <code class="command">cmake</code> is not found on the path.</p></li>
<li><p>Be sure to use portable encoding names: none of <code class="code">utf8</code>, <code class="code">mac</code> and <code class="code">macroman</code> is portable. See the help for <code class="code">file</code> for more details.</p></li>
<li><p>Do not invoke R by plain <code class="command">R</code>, <code class="command">Rscript</code> or (on Windows) <code class="command">Rterm</code> in your examples, tests, vignettes, makefiles or other scripts. As pointed out in several places earlier in this manual, use something like</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="st">"</span><span class="ch">$(</span><span class="dt">R_HOME</span><span class="ch">)</span><span class="st">/bin/Rscript"</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="st">"</span><span class="ch">$(</span><span class="dt">R_HOME</span><span class="ch">)</span><span class="st">/bin</span><span class="ch">$(</span><span class="dt">R_ARCH_BIN</span><span class="ch">)</span><span class="st">/Rterm"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>with appropriate quotes (as, although not recommended, <code class="env">R_HOME</code> can contain spaces).</p></li>
<li><p>Do not use <code class="env">R_HOME</code> in makefiles except when passing them to the shell. Specifically, do not use <code class="env">R_HOME</code> in the argument to <code class="code">include</code>, as <code class="env">R_HOME</code> can contain spaces. Quoting the argument to <code class="code">include</code> does not help. A portable and the recommended way to avoid the problem of spaces in <code class="code">${R_HOME}</code> is using option <code class="code">-f</code> of <code class="command">make</code>. This is easy to do with recursive invocation of <code class="command">make</code>, which is also the only usual situation when <code class="env">R_HOME</code> is needed in the argument for <code class="code">include</code>. <code>makefile     $(MAKE) -f "${R_HOME}/etc${R_ARCH}/Makeconf" -f Makefile.inner</code></p></li>
<li><p>If distributing datasets involving date-times, consider if a time zone needs to be specified. The most portable way to distribute date-times is as objects of class <code class="code">"POSIXct"</code> and as these record the time in UTC, the time represented is independent of the time zone: but how it is printed may not be. Objects of class <code class="code">"POSIXlt"</code> should have a <code class="code">"tzone"</code> attribute. Dates (e.g, birthdays) are conventionally considered independently of time zone.</p></li>
<li><p>If at all possible avoid any Internet access during package installation. Installation and use may well be on different machines/accounts and those allowed to install software may have no Internet access, and being self-contained helps ensure long-term reproducibility.</p></li>
</ul>
<p>Do be careful in what your tests (and examples) actually test. Bad practice seen in distributed packages include:</p>
<ul>
<li><p>It is not reasonable to test the time taken by a command: you cannot know how fast or how heavily loaded an R platform might be. At best you can test a ratio of times, and even that is fraught with difficulties and not advisable: for example, the garbage collector may trigger at unpredictable times following heuristics that may change without notice.</p></li>
<li><p>Do not test the exact format of R messages (from R itself or from other packages): They change, and they can be translated.</p>
<p>Packages have even tested the exact format of system error messages, which are platform-dependent and perhaps locale-dependent. For example, in late 2021 <code class="code">libcurl</code> changed its warning/error messages, including when URLs are not found.</p></li>
<li><p>Do not test for the absence of warnings (something users of <a href="https://CRAN.R-project.org/package=testthat" class="url"><strong>testthat</strong></a> are fond of). Future changes in either R or packages you make use of can create new warnings, and your tests should not make these into errors. (Some deprecation notices may be intended to remain as warnings for a long time.)</p></li>
<li><p>If you use functions such as <code class="code">View</code>, remember that in testing there is no one to look at the output. It is better to use something like one of</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>interactive<span class="op">())</span> View<span class="op">(</span>obj<span class="op">)</span> <span class="cf">else</span> print<span class="op">(</span>head<span class="op">(</span>obj<span class="op">))</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>interactive<span class="op">())</span> View<span class="op">(</span>obj<span class="op">)</span> <span class="cf">else</span> str<span class="op">(</span>obj<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Be careful when comparing file paths. There can be multiple paths to a single file, and some of these can be very long character strings. If possible canonicalize paths before comparisons, but study <code class="code">?normalizePath</code> to be aware of the pitfalls.</p></li>
<li><p>Only test the accuracy of results if you have done a formal error analysis. Things such as checking that probabilities numerically sum to one are silly: numerical tests should always have a tolerance. That the tests on your platform achieve a particular tolerance says little about other platforms. R is configured by default to make use of long doubles where available, but they may not be available or be too slow for routine use. Most R platforms use <samp class="samp">ix86</samp>’ or <samp class="samp">x86_64</samp>’ CPUs: these may use extended precision registers on some but not all of their FPU instructions. Thus the achieved precision can depend on the compiler version and optimization flags—our experience is that 32-bit builds tend to be less precise than 64-bit ones. But not all platforms use those CPUs, and not all<a href="#FOOT94" id="DOCF94" class="footnote"><sup>94</sup></a> which use them configure them to allow the use of extended precision. In particular, current ARM CPUs do not have extended precision nor long doubles, and <code class="command">clang</code> currently has long double the same as double on all ARM CPUs. On the other hand some CPUs have higher-precision modes which may be used for <code class="code">long double</code>, notably 64-bit PowerPC and Sparc.</p>
<p>If you must try to establish a tolerance empirically, configure and build R with <samp class="option">--disable-long-double</samp> and use appropriate compiler flags (such as <samp class="option">-ffloat-store</samp> and <samp class="option">-fexcess-precision=standard</samp> for <code class="command">gcc</code>, depending on the CPU type<a href="#FOOT95" id="DOCF95" class="footnote"><sup>95</sup></a>) to mitigate the effects of extended-precision calculations. The platform most often seen to give different numerical results is <samp class="samp">arm64</samp>’ macOS, so be sure to include that in any empirical determination.</p>
<p>Tests which involve random inputs or non-deterministic algorithms should normally set a seed or be tested for many seeds.</p></li>
<li><p>Tests should use <code class="code">options(warn = 1)</code> as reporting</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>There were <span class="dv">22</span> <span class="fu">warnings</span> (use <span class="fu">warnings</span>() to see them)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>is pointless, especially for automated checking systems.</p></li>
<li><p>If your package uses dates/times, ensure that it works in all timezones, especially those near boundaries (problems have most often be seen in <samp class="samp">Europe/London</samp>’ (zero offset in Winter) and <samp class="samp">Pacific/Auckland</samp>‘, near enough the International Date line) and with offsets not in whole hours (Adelaide, Chatham Islands, …). More extreme examples are <samp class="samp">Africa/Conakry</samp>’ (permanent UTC), <samp class="samp">Asia/Calcutta</samp>’ (no DST, permanent half-hour offset) and <samp class="samp">Pacific/Kiritimati</samp>’(no DST, more than 12 hours ahead of UTC).</p></li>
</ul>
<section id="pdf-size" class="level3 subsection" data-number="1.6.1">
<h3 class="subsection anchored" data-number="1.6.1" data-anchor-id="pdf-size"><span class="header-section-number">1.6.1</span> PDF size <a href="#pdf-size-1" class="copiable-link">¶</a></h3>
<p>There are a several tools available to reduce the size of PDF files: often the size can be reduced substantially with no or minimal loss in quality. Not only do large files take up space: they can stress the PDF viewer and take many minutes to print (if they can be printed at all).</p>
<p><code class="command">qpdf</code> (<a href="https://qpdf.sourceforge.io/" class="uref">https://qpdf.sourceforge.io/</a>) can compress losslessly. It is fairly readily available (e.g.&nbsp;it is included in <code class="code">rtools</code>, has packages in Debian/Ubuntu/Fedora, and is installed as part of the CRAN macOS distribution of R). <code class="command">R CMD build</code> has an option to run <code class="command">qpdf</code> over PDF files under <samp class="file">inst/doc</samp> and replace them if at least 10Kb and 10% is saved. The full path to the <code class="command">qpdf</code> command can be supplied as environment variable <code class="env">R_QPDF</code> (and is on the CRAN binary of R for macOS). It seems MiKTeX does not use PDF object compression and so <code class="command">qpdf</code> can reduce considerably the sizes of files it outputs: MiKTeX’s defaults can be overridden by code in the preamble of an Sweave or LaTeX file — see how this is done for the R reference manual at <a href="https://svn.r-project.org/R/trunk/doc/manual/refman.top" class="uref">https://svn.r-project.org/R/trunk/doc/manual/refman.top</a>.</p>
<p>Other tools can reduce the size of PDFs containing bitmap images at excessively high resolution. These are often best re-generated (for example <code class="code">Sweave</code> defaults to 300&nbsp;ppi, and 100–150 is more appropriate for a package manual). These tools include Adobe Acrobat (not Reader), Apple’s Preview<a href="#FOOT96" id="DOCF96" class="footnote"><sup>96</sup></a> and Ghostscript (which converts PDF to PDF by</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>ps2pdf options <span class="op">-</span>dAutoRotatePages<span class="op">=/</span>None <span class="op">-</span>dPrinted<span class="op">=</span><span class="kw">false</span> in<span class="op">.</span>pdf out<span class="op">.</span>pdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and suitable options might be</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="dt">-dPDFSETTINGS</span><span class="ch">=</span><span class="st">/ebook</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="dt">-dPDFSETTINGS</span><span class="ch">=</span><span class="st">/screen</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>See <a href="https://ghostscript.readthedocs.io/en/latest/VectorDevices.html" class="uref">https://ghostscript.readthedocs.io/en/latest/VectorDevices.html</a> for more such and consider all the options for image downsampling). There have been examples in CRAN packages for which current versions of Ghostscript produced much bigger reductions than earlier ones (e.g.&nbsp;at the upgrades from <code class="code">9.50</code> to <code class="code">9.52</code>, from <code class="code">9.55</code> to <code class="code">9.56</code> and then to <code class="code">10.00.0</code>).</p>
<p>We come across occasionally large PDF files containing excessively complicated figures using PDF vector graphics: such figures are often best redesigned or failing that, output as PNG files.</p>
<p>Option <samp class="option">--compact-vignettes</samp> to <code class="command">R CMD build</code> defaults to value <samp class="samp">qpdf</samp>‘: use <samp class="samp">both</samp>’ to try harder to reduce the size, provided you have Ghostscript available (see the help for <code class="code">tools::compactPDF</code>).</p>
</section>
<section id="check-timing" class="level3 subsection" data-number="1.6.2">
<h3 class="subsection anchored" data-number="1.6.2" data-anchor-id="check-timing"><span class="header-section-number">1.6.2</span> Check timing <a href="#check-timing-1" class="copiable-link">¶</a></h3>
<p>There are several ways to find out where time is being spent in the check process. Start by setting the environment variable <code class="env">_R_CHECK_TIMINGS_</code> to <samp class="samp">0</samp>’. This will report the total CPU times (not Windows) and elapsed times for installation and running examples, tests and vignettes, under each sub-architecture if appropriate. For tests and vignettes, it reports the time for each as well as the total.</p>
<p>Setting <code class="env">_R_CHECK_TIMINGS_</code> to a positive value sets a threshold (in seconds elapsed time) for reporting timings.</p>
<p>If you need to look in more detail at the timings for examples, use option <samp class="option">--timings</samp> to <code class="command">R CMD check</code> (this is set by <samp class="option">--as-cran</samp>). This adds a summary to the check output for all the examples with CPU or elapsed time of more than 5 seconds. It produces a file <var class="var">mypkg</var><samp class="file">.Rcheck/</samp><var class="var">mypkg</var><samp class="file">-Ex.timings</samp> containing timings for each help file: it is a tab-delimited file which can be read into R for further analysis.</p>
<p>Timings for the tests and vignette runs are given at the bottom of the corresponding log file: note that log files for successful vignette runs are only retained if environment variable <code class="env">_R_CHECK_ALWAYS_LOG_VIGNETTE_OUTPUT_</code> is set to a true value.</p>
</section>
<section id="encoding-issues" class="level3 subsection" data-number="1.6.3">
<h3 class="subsection anchored" data-number="1.6.3" data-anchor-id="encoding-issues"><span class="header-section-number">1.6.3</span> Encoding issues <a href="#encoding-issues-1" class="copiable-link">¶</a></h3>
<p>The issues in this subsection have been much alleviated by the change in R 4.2.0 to running the Windows port of R in a UTF-8 locale where available. However, Windows users might be running an earlier version of R on an earlier version of Windows which does not support UTF-8 locales.</p>
<p>Care is needed if your package contains non-ASCII text, and in particular if it is intended to be used in more than one locale. It is possible to mark the encoding used in the <samp class="file">DESCRIPTION</samp> file and in <samp class="file">.Rd</samp> files, as discussed elsewhere in this manual.</p>
<p>First, consider carefully if you really need non-ASCII text. Some users of R will only be able to view correctly text in their native language group (e.g.&nbsp;Western European, Eastern European, Simplified Chinese) and ASCII.<a href="#FOOT97" id="DOCF97" class="footnote"><sup>97</sup></a>. Other characters may not be rendered at all, rendered incorrectly, or cause your R code to give an error. For <samp class="file">.Rd</samp> documentation, marking the encoding and including ASCII transliterations is likely to do a reasonable job. The set of characters which is commonly supported is wider than it used to be around 2000, but non-Latin alphabets (Greek, Russian, Georgian, …) are still often problematic and those with double-width characters (Chinese, Japanese, Korean, emoji) often need specialist fonts to render correctly.</p>
<p>Several CRAN packages have messages in their R code in French (and a few in German). A better way to tackle this is to use the internationalization facilities discussed elsewhere in this manual.</p>
<p>Function <code class="code">showNonASCIIfile</code> in package <strong>tools</strong> can help in finding non-ASCII bytes in files.</p>
<p>There is a portable way to have arbitrary text in character strings (only) in your R code, which is to supply them in Unicode as <samp class="samp">\uxxxx</samp>’ escapes (or, rarely needed except for emojis, <samp class="samp">\Uxxxxxxxx</samp>’ escapes). If there are any characters not in the current encoding the parser will encode the character string as UTF-8 and mark it as such. This applies also to character strings in datasets: they can be prepared using <samp class="samp">\uxxxx</samp>’ escapes or encoded in UTF-8 in a UTF-8 locale, or even converted to UTF-8 <em>via</em> <code class="code">iconv()</code>. If you do this, make sure you have <samp class="samp">R (&gt;= 2.10)</samp>’ (or later) in the <samp class="samp">Depends</samp>’ field of the <samp class="file">DESCRIPTION</samp> file.</p>
<p>R sessions running in non-UTF-8 locales will if possible re-encode such strings for display (and this is done by <code class="command">RGui</code> on older versions of Windows, for example). Suitable fonts will need to be selected or made available<a href="#FOOT98" id="DOCF98" class="footnote"><sup>98</sup></a> both for the console/terminal and graphics devices such as <samp class="samp">X11()</samp>’ and <samp class="samp">windows()</samp>‘. Using <samp class="samp">postscript</samp>’ or <samp class="samp">pdf</samp>’ will choose a default 8-bit encoding depending on the language of the UTF-8 locale, and your users would need to be told how to select the <samp class="samp">encoding</samp>’ argument.</p>
<p>Note that the previous two paragraphs only apply to character strings in R code. Non-ASCII characters are particularly prevalent in comments (in the R code of the package, in examples, tests, vignettes and even in the <samp class="file">NAMESPACE</samp> file) but should be avoided there. Most commonly people use the Windows extensions to Latin-1 (often directional single and double quotes, ellipsis, bullet and en and em dashes) which are not supported in strict Latin-1 locales nor in CJK locales on Windows. A surprisingly common misuse is to use a right quote in <samp class="samp">don't</samp>’ instead of the correct apostrophe.</p>
<p>Datasets can include marked UTF-8 or Latin-1 character strings. As R is nowadays unlikely to be run in a Latin-1 or Windows’ CP1252 locale, for performance reasons these should be converted to UTF-8.</p>
<p>If you want to run <code class="command">R CMD check</code> on a Unix-alike over a package that sets a package encoding in its <samp class="file">DESCRIPTION</samp> file <em>and do not use a UTF-8 locale</em> you may need to specify a suitable locale <em>via</em> environment variable <code class="env">R_ENCODING_LOCALES</code>. The default is equivalent to the value</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="st">"latin1=en_US:latin2=pl_PL:UTF-8=en_US.UTF-8:latin9=fr_FR.iso885915@euro"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(which is appropriate for a system based on <code class="code">glibc</code>: macOS requires <code class="code">latin9=fr_FR.ISO8859-15</code>) except that if the current locale is UTF-8 then the package code is translated to UTF-8 for syntax checking, so it is strongly recommended to check in a UTF-8 locale.</p>
</section>
<section id="portable-c-and-c-code" class="level3 subsection" data-number="1.6.4">
<h3 class="subsection anchored" data-number="1.6.4" data-anchor-id="portable-c-and-c-code"><span class="header-section-number">1.6.4</span> Portable C and C++ code <a href="#portable-c-and-c-code-1" class="copiable-link">¶</a></h3>
<p>Writing portable C and C++ code is mainly a matter of observing the standards (C99, C++14 or where declared C++11/17/20) and testing that extensions (such as POSIX functions) are supported. Do make maximal use of your compiler diagnostics — this typically means using flags <samp class="option">-Wall</samp> and <samp class="option">-pedantic</samp> for both C and C++ and additionally <samp class="option">-Werror=implicit-function-declaration</samp> and <samp class="option">-Wstrict-prototypes</samp> for C (on some platforms and compiler versions) these are part of <samp class="option">-Wall</samp> or <samp class="option">-pedantic</samp>).</p>
<p><strong>C++ standards</strong>: From version 3.6.0 (3.6.2 on Windows), R defaulted to C++11 where available<a href="#FOOT99" id="DOCF99" class="footnote"><sup>99</sup></a>; from R 4.1.0 to C++14 and from R 4.3.0 to C++17 (where available). However, in earlier versions the default standard was that of the compiler used, often C++98 or C++14, and the default is likely to change in future. For maximal portability a package should either specify a standard (see <a href="#using-c-code" class="pxref">Using C++ code</a>) or be tested under all of C++11, C++98, C++14 and C++17. (Specifying C++14 or later will limit portability.)</p>
<p>Note that the ‘TR1’ C++ extensions are not part of any of these standards and the <code class="code">&lt;tr1/</code><var class="var">name</var><code class="code">&gt;</code> headers are not supplied by some of the compilers used for R, including on macOS. (Use the C++11 versions instead.)</p>
<p>A common error is to assume recent versions of compilers or OSes. In production environments ‘long term support’ versions of OSes may be in use for many years,<a href="#FOOT100" id="DOCF100" class="footnote"><sup>100</sup></a> and their compilers may not be updated during that time. For example, GCC 4.8 was still in use in 2022 and could be (in RHEL 7) until 2028: that supports neither C++14 nor C++17.</p>
<p>The POSIX standards only require recently-defined functions to be declared if certain macros are defined with large enough values, and on some compiler/OS combinations<a href="#FOOT101" id="DOCF101" class="footnote"><sup>101</sup></a> they are not declared otherwise. So you may need to include something like one of</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _XOPEN_SOURCE </span><span class="dv">600</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef __GLIBC__</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="pp"># define _POSIX_C_SOURCE </span><span class="dv">200809</span><span class="bu">L</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>before <em>any</em> headers. (<code class="code">strdup</code>, <code class="code">strncasecmp</code> and <code class="code">strnlen</code> are such functions – there were several older platforms which did not have the POSIX 2008 function <code class="code">strnlen</code>.)</p>
<p>‘Linux’ is not a well-defined operating system: it is a kernel plus a collection of components. Most distributions use <code class="code">glibc</code> to provide most of the C headers and run-time library, but others, notably Alpine Linux, use other implementations such as <code class="code">musl</code> — see <a href="https://wiki.musl-libc.org/functional-differences-from-glibc.html" class="uref">https://wiki.musl-libc.org/functional-differences-from-glibc.html</a>.</p>
<p>However, some common errors are worth pointing out here. It can be helpful to look up functions at <a href="https://cplusplus.com/reference/" class="uref">https://cplusplus.com/reference/</a> or <a href="https://en.cppreference.com/w/" class="uref">https://en.cppreference.com/w/</a> and compare what is defined in the various standards.</p>
<p>More care is needed for functions such as <code class="code">mallinfo</code> which are not specified by any of these standards—hopefully the <code class="command">man</code> page on your system will tell you so. Searching online for such pages for various OSes (preferably at least Linux and macOS, and the FreeBSD manual pages at <a href="https://man.freebsd.org/cgi/man.cgi" class="uref">https://man.freebsd.org/cgi/man.cgi</a> allow you to select many OSes) should reveal useful information but a <samp class="file">configure</samp> script is likely to be needed to check availability and functionality.</p>
<p>Both the compiler and OS (<em>via</em> system header files, which may differ by architecture even for nominally the same OS) affect the compilability of C/C++ code. Compilers from the GCC, LLVM (<code class="command">clang</code> and <code class="command">flang-new</code>) Intel and Oracle Developer Studio suites have been used with R, and both LLVM <code class="command">clang</code> and Oracle have more than one implementation of C++ headers and library. The range of possibilities makes comprehensive empirical checking impossible, and regrettably compilers are patchy at best on warning about non-standard code.</p>
<ul>
<li><p>Mathematical functions such as <code class="code">sqrt</code> are defined in C++11 for floating-point arguments: <code class="code">float</code>, <code class="code">double</code>, <code class="code">long double</code> and possibly more. The standard specifies what happens with an argument of integer type but this is not always implemented, resulting in a report of ‘overloading ambiguity’: this was commonly seen on Solaris, but for <code class="code">pow</code> also seen on macOS and other platforms using <code class="command">clang++</code>.</p>
<p>A not-uncommonly-seen problem is to mistakenly call <code class="code">floor(x/y)</code> or <code class="code">ceil(x/y)</code> for <code class="code">int</code> arguments <code class="code">x</code> and <code class="code">y</code>. Since <code class="code">x/y</code> does integer division, the result is of type <code class="code">int</code> and ‘overloading ambiguity’ may be reported. Some people have (pointlessly) called <code class="code">floor</code> and <code class="code">ceil</code> on arguments of integer type, which may have an ‘overloading ambiguity’.</p>
<p>A surprising common misuse is things like <code class="code">pow(10, -3)</code>: this should be the constant <code class="code">1e-3</code>. Note that there are constants such as <code class="code">M_SQRT2</code> defined <em>via</em> <samp class="file">Rmath.h</samp><a href="#FOOT102" id="DOCF102" class="footnote"><sup>102</sup></a> for <code class="code">sqrt(2.0)</code>, frequently mis-coded as <code class="code">sqrt(2)</code>.</p></li>
<li><p>Function <code class="code">fabs</code> is defined only for floating-point types, except in C++11 and later which have overloads for <code class="code">std::fabs</code> in <samp class="file">&lt;cmath&gt;</samp> for integer types. Function <code class="code">abs</code> is defined in C99’s <samp class="file">&lt;stdlib.h&gt;</samp> for <code class="code">int</code> and in C++’s <samp class="file">&lt;cstdlib&gt;</samp> for integer types, overloaded in <samp class="file">&lt;cmath&gt;</samp> for floating-point types. C++11 has additional overloads for <code class="code">std::abs</code> in <samp class="file">&lt;cmath&gt;</samp> for integer types. The effect of calling <code class="code">abs</code> with a floating-point type is implementation-specific: it may truncate to an integer. For clarity and to avoid compiler warnings, use <code class="code">abs</code> for integer types and <code class="code">fabs</code> for double values, and when using C++ include <samp class="file">&lt;cmath&gt;</samp> and use the <code class="code">std::</code> prefix.</p></li>
<li><p>It is an error (and make little sense, although has been seen) to call macros/functions <code class="code">isnan</code>, <code class="code">isinf</code> and <code class="code">isfinite</code> for integer arguments: a few compilers give a compilation error. Function <code class="code">finite</code> is obsolete, and some compilers will warn about its use<a href="#FOOT103" id="DOCF103" class="footnote"><sup>103</sup></a>.</p></li>
<li><p>The GNU C/C++ compilers support a large number of non-portable extensions. For example, <code class="code">INFINITY</code> (which is a <em>float</em> value in C99 and C++11), for which R provides the portable double value <code class="code">R_PosInf</code> (and <code class="code">R_NegInf</code> for <code class="code">-INFINITY</code>). And <code class="code">NAN</code><a href="#FOOT104" id="DOCF104" class="footnote"><sup>104</sup></a> is just one NaN <em>float</em> value: for use with R, <code class="code">NA_REAL</code> is often what is intended, but <code class="code">R_NaN</code> is also available.</p>
<p>Some (but not all) extensions are listed at <a href="https://gcc.gnu.org/onlinedocs/gcc/C-Extensions.html" class="uref">https://gcc.gnu.org/onlinedocs/gcc/C-Extensions.html</a> and <a href="https://gcc.gnu.org/onlinedocs/gcc/C_002b_002b-Extensions.html" class="uref">https://gcc.gnu.org/onlinedocs/gcc/C_002b_002b-Extensions.html</a>.</p>
<p>Other GNU extensions which have bitten package writers are the use of non-portable characters such as <samp class="samp">$</samp>’ in identifiers and use of C++ headers under <samp class="file">ext</samp>.</p></li>
<li><p>Including C-style headers in C++ code is not portable. Including the legacy header<a href="#FOOT105" id="DOCF105" class="footnote"><sup>105</sup></a> <samp class="file">math.h</samp> in C++ code may conflict with <samp class="file">cmath</samp> which may be included by other headers. In C++11, functions like <code class="code">sqrt</code> and <code class="code">isnan</code> are defined for <code class="code">double</code> arguments in <samp class="file">math.h</samp> and for a range of types including <code class="code">double</code> in <samp class="file">cmath</samp>. Similar issues have been seen for <samp class="file">stdlib.h</samp> and <samp class="file">cstdlib</samp>. Including the C++ header first used to be a sufficient workaround but for some 2016 compilers only one could be included.</p></li>
<li><p>Be careful to include the headers which define the functions you use. Some compilers/OSes include other system headers in their headers which are not required by the standards, and so code may compile on such systems and not on others. (A prominent example is the C++ header <code class="code">&lt;random&gt;</code> which is indirectly included by <code class="code">&lt;algorithm&gt;</code> by <code class="command">g++</code>. Another issue is the C header <code class="code">&lt;time.h&gt;</code> which is included by other headers on Linux and Windows but not macOS.) <code class="command">g++</code>&nbsp;11 often needs explicit inclusion of the C++ headers <code class="code">&lt;limits&gt;</code> (for <code class="code">numeric_limits</code>) or <code class="code">&lt;exception&gt;</code> (for <code class="code">set_terminate</code> and similar), whereas earlier versions included these in other headers. <code class="command">g++</code>&nbsp;13 requires the explicit inclusion of <code class="code">&lt;cstdint&gt;</code> for types such as <code class="code">uint32_t</code> which was previously included implicitly. (For more such, see <a href="https://gcc.gnu.org/gcc-13/porting_to.html" class="uref">https://gcc.gnu.org/gcc-13/porting_to.html</a>.) There are further instances of this in <code class="command">g++</code>&nbsp;15: see <a href="https://gcc.gnu.org/gcc-13/porting_to.html" class="uref">https://gcc.gnu.org/gcc-13/porting_to.html</a>.</p>
<p>Note that <code class="code">malloc</code>, <code class="code">calloc</code>, <code class="code">realloc</code> and <code class="code">free</code> are defined by C99 in the header <samp class="file">stdlib.h</samp> and (in the <code class="code">std::</code> namespace) by C++ header <samp class="file">cstdlib</samp>. Some earlier implementations used a header <samp class="file">malloc.h</samp>, but that is not portable and does not exist on macOS.</p>
<p>This also applies to types such as <code class="code">ssize_t</code>. The POSIX standards say that is declared in headers <code class="code">unistd.h</code> and <code class="code">sys/types.h</code>, and the latter is often included indirectly by other headers on some but not all systems.</p>
<p>POSIX mandates the header <code class="code">unistd.h</code>: most but not all OSes supply header <code class="code">sys/unistd.h</code> as a wrapper, so this should not be used.</p>
<p>Similarly for constants: for example <code class="code">SIZE_MAX</code> is defined in <code class="code">stdint.h</code> alongside <code class="code">size_t</code>.</p></li>
<li><p>Some headers are not portable: we have just mentioned <samp class="file">malloc.h</samp> and often CRAN submissions attempt to use <samp class="file">endian.h</samp>. The latter is a <code class="code">glibc</code> extension: some OSes have <samp class="file">machine/endian.h</samp> or <samp class="file">sys/endian.h</samp> but some have neither. Header <samp class="file">execinfo.h</samp> is only available on a few OSes: formerly nor in MacOS nor Solaris, and currently not on Linux systems (such as Alpine Linux) using <code class="code">musl</code>. Nor is header <samp class="file">fpu_control.h</samp> available on macOS nor <code class="code">musl</code>.</p></li>
<li><p>Use <code class="code">#include "my.h"</code> not <code class="code">#include &lt;my.h&gt;</code> for headers in your package. The second form is intended for system headers and the search order for such headers is platform-dependent (and may not include the current directory). For extra safety, name headers in a way that cannot be confused with a system header so not, for example, <samp class="file">types.h</samp>.</p></li>
<li><p>For C++ code, be careful to specify namespaces where needed. Many functions are defined by the standards to be in the <code class="code">std</code> namespace, but <code class="command">g++</code> puts many such also in the C++ main namespace. One way to do so is to use declarations such as</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>using std<span class="sc">::</span>floor;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>but it is usually preferable to use explicit namespace prefixes in the code.</p>
<p>Examples seen in CRAN packages include</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>abs acos atan bind calloc ceil div exp fabs floor fmod free log malloc</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>memcpy memset pow printf qsort round sin sprintf sqrt strcmp strcpy</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>strerror strlen strncmp strtol tan trunc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This problem is less common than it used to be, but in 2019 LLVM <code class="command">clang</code> did not have <code class="code">bind</code> in the main namespace. Also seen has been type <code class="code">size_t</code> defined only in the <code class="code">std</code> namespace.</p>
<p><strong>NB:</strong> These functions are only guaranteed to be in the <code class="code">std</code> namespace if the correct C++ header is included, e.g. <code class="code">&lt;cmath&gt;</code> rather than <code class="code">&lt;math.h&gt;</code>.</p>
<p>If you define functions in C++ which are inspired by later standards, put them in a namespace and refer to them using the namespace. We have seen conflicts with <code class="code">std::make_unique</code> from C++14 and <code class="code">std::byte</code>, <code class="code">std::data</code>, <code class="code">std::sample</code> and <code class="code">std::size</code> from C++17.</p></li>
<li><p>In C++ code</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>using namespace std;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>is not good practice, and has caused platform-dependent errors if included before headers, especially system headers (which may be included by other headers). The best practice is to use explicit <code class="code">std::</code> prefixes for all functions declared by the C++ standard to be in that namespace. It is an error to use <code class="code">using namespace std</code> before including any C++ headers, and some recent compilers will warn if this is done.</p></li>
<li><p>Some C++ compilers refuse to compile constructs such as</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(ptr <span class="sc">&gt;</span> <span class="dv">0</span>) { ....}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which compares a pointer to the integer <code class="code">0</code>. This could just use <code class="code">if(ptr)</code> (pointer addresses cannot be negative) but if needed pointers can be tested against <code class="code">nullptr</code> (C++11) or <code class="code">NULL</code>.</p></li>
<li><p>Macros defined by the compiler/OS can cause problems. Identifiers starting with an underscore followed by an upper-case letter or another underscore are reserved for system macros and should not be used in portable code (including not as guards in C/C++ headers). Other macros, typically upper-case, may be defined by the compiler or system headers and can cause problems. Some of these can be avoided by defining <code class="code">_POSIX_C_SOURCE</code> before including any system headers, but it is better to only use all-upper-case names which have a unique prefix such as the package name.</p></li>
<li><p><code class="code">typedef</code>s in OS headers can conflict with those in the package: examples have included <code class="code">ulong</code>, <code class="code">index_t</code>, <code class="code">single</code> and <code class="code">thread</code>. (Note that these may conflict with other uses as identifiers, e.g.&nbsp;defining a C++ function called <code class="code">single</code>.) The POSIX standard reserves (in §2.2.2) all identifiers ending in <code class="code">_t</code>.</p></li>
<li><p>Some compilers do not allow a space between <code class="code">-D</code> and the macro to be defined. Similarly for <code class="code">-U</code>.</p></li>
<li><p>If you use OpenMP, check carefully that you have followed the advice in the subsection on <a href="#openmp-support" class="ref">OpenMP support</a>. In particular, any use of OpenMP in C/C++ code will need to use</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef _OPENMP</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="pp"># include </span><span class="im">&lt;omp.h&gt;</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Any use of OpenMP functions, e.g.&nbsp;<code class="code">omp_set_num_threads</code>, also needs to be conditioned. To avoid incessant warnings such as</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>warning<span class="op">:</span> ignoring #pragma omp parallel <span class="op">[-</span>Wunknown<span class="op">-</span>pragmas<span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>uses of such pragmas should also be conditioned (or commented out if they are used in code in a package not enabling OpenMP on any platform).</p>
<p>Do not hardcode <samp class="option">-lgomp</samp>: not only is that specific to the GCC family of compilers, using the correct linker flag often sets up the run-time path to the library.</p></li>
<li><p>Package authors commonly assume things are part of C/C++ when they are not: the most common example is POSIX<a href="#FOOT106" id="DOCF106" class="footnote"><sup>106</sup></a> function <code class="code">strdup</code>. The most common C library on Linux, <code class="code">glibc</code>, will hide the declarations of such extensions unless a ‘feature-test macro’ is defined <strong>before</strong> (almost) any system header is included. So for <code class="code">strdup</code> you need</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _POSIX_C_SOURCE </span><span class="dv">200809</span><span class="bu">L</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>strdup call<span class="op">(</span>s<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the appropriate value can be found by <code class="command">man strdup</code> on Linux. (Use of <code class="code">strncasecmp</code> is similar.)</p>
<p>However, modes of <code class="command">gcc</code> with ‘GNU EXTENSIONS’ (which are the default, either <samp class="option">-std=gnu99</samp> or <samp class="option">-std=gnu11</samp>) declare enough macros to ensure that missing declarations are rarely seen.</p>
<p>This applies also to constants such as <code class="code">M_PI</code> and <code class="code">M_LN2</code>, which are part of the X/Open standard: to use these define <code class="code">_XOPEN_SOURCE</code> before including any headers, or include the R header <samp class="file">Rmath.h</samp>.</p></li>
<li><p>Using <code class="code">alloca</code> portably is tricky: it is neither an ISO C/C++ nor a POSIX function. An adequately portable preamble is</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef __GNUC__</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="co">/* Includes GCC, clang and Intel compilers */</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="pp"># undef alloca</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="pp"># define alloca</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> __builtin_alloca</span><span class="op">((</span><span class="pp">x</span><span class="op">))</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__sun) || defined(_AIX)</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="co">/* this was necessary (and sufficient) for Solaris 10 and AIX 6: */</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="pp"># include </span><span class="im">&lt;alloca.h&gt;</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Compiler writers feel free to implement features from later standards than the one specified, so for example they may implement or warn on C++14/17/20 features when C++11 is specified. Portable code will not use such features – it can be hard to know what they are but the most common warnings are</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="ch">'r</span><span class="er">egister</span><span class="ch">'</span> storage class specifier is deprecated and incompatible with C<span class="op">++</span><span class="dv">17</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>ISO C<span class="op">++</span><span class="dv">11</span> does not allow conversion from string literal to <span class="ch">'c</span><span class="er">har *</span><span class="ch">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(where conversion should be to <code class="code">const char *</code>). Keyword <code class="code">register</code> was not mentioned in C++98, deprecated in C++11 and removed in C++17.</p>
<p>There are quite a lot of other C++98 features deprecated in C++11 and removed in C++17, and LLVM <code class="command">clang</code> 9 and later warn about them (and as from version 16 they have been removed). Examples include <code class="code">bind1st</code>/<code class="code">bind2nd</code> (use <code class="code">std::bind</code> or lambdas<a href="#FOOT107" id="DOCF107" class="footnote"><sup>107</sup></a>) <code class="code">std::auto_ptr</code> (replaced by <code class="code">std::unique_ptr</code>), <code class="code">std::mem_fun_ref</code> and <code class="code">std::ptr_fun</code>.</p></li>
<li><p>Later versions of standards may add reserved words: for example <code class="code">bool</code>, <code class="code">false</code> and <code class="code">true</code> became keywords in C23 and are no longer available as variable names. As noted above, C++17 uses <code class="code">byte</code>, <code class="code">data</code>, <code class="code">sample</code> and <code class="code">size</code>.</p>
<p>So avoid common words and keywords from other programming languages.</p></li>
<li><p>Be careful about including C headers in C++ code. Issues include</p>
<ul>
<li>Use of the <code class="code">register</code> storage class specifier (see the previous but one item).</li>
<li>The C99 keyword <code class="code">restrict</code> is not part of<a href="#FOOT108" id="DOCF108" class="footnote"><sup>108</sup></a> any C++ standard and is rejected by some C++ compilers.</li>
<li>Inclusion by such headers of C-style headers such as <samp class="file">math.h</samp> (see above).</li>
</ul>
<p>The most portable way to interface to other software with a C API is to use C code (which can normally be mixed with C++ code in a package).</p></li>
<li><p>Include only what is essential in <code class="code">extern "C" {}</code> blocks in C++ code. In particular it is not portable to include R headers in such blocks (although they are themselves C code, they may include C++ system headers and the public ones already enclose their declarations in such a block). And maintainers have include R headers from other headers included in such a block.</p></li>
<li><p><code class="code">reinterpret_cast</code> in C++ is not safe for pointers: for example the types may have different alignment requirements. Use <code class="code">memcpy</code> to copy the contents to a fresh variable of the destination type.</p></li>
<li><p>Avoid platform-specific code if at all possible, but if you need to test for a platform ensure that all platforms are covered. For example, <code class="code">__unix__</code> is not defined on all Unix-alikes, in particular not on macOS. A reasonably portable way to condition code for a Unix-alike is</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined (__unix__) || (defined (__APPLE__) &amp;&amp; defined (__MACH__))</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>but</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef _WIN32</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Windows-specific code</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="pp"># if defined(_M_ARM64) || defined(__aarch64__)</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a><span class="co">// for ARM</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="pp"># else</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a><span class="co">// for Intel</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="pp"># endif</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Unix-alike code</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>would be better. For a Unix-alike it is much better to use <code class="command">configure</code> to test for the functionality needed than make assumptions about OSes (and people all too frequently forget R is used on platforms other than Linux, Windows and macOS — and some forget macOS).</p></li>
<li><p>Headers in subdirectories are often not portable. For C++, this includes <samp class="file">bits/</samp>, <samp class="file">tr1/</samp> and <samp class="file">tr2/</samp>, none of which exist on macOS (and <samp class="file">ext/</samp> exists there but with different content from <code class="command">g++</code>-based platforms). Header <samp class="file">bits/stdc++.h</samp> is both not portable and not recommended for end-user code even on platforms which include it.</p></li>
<li><p>Be careful if using <code class="code">malloc</code> or <code class="code">calloc</code>. First, their return value must always be checked to see if the allocation succeeded – it is almost always easier to use R’s <code class="code">R_Calloc</code>, which does check. Second, the first argument is of type <code class="code">size_t</code><a href="#FOOT109" id="DOCF109" class="footnote"><sup>109</sup></a> and some recent compilers warn about passing <code class="code">int</code> (signed) arguments (which could get promoted to ridiculously large values).</p></li>
<li><p>For C code, consider using the flag <samp class="option">-Wstrict-prototypes</samp> which is supported by <code class="command">gcc</code> and LLVM and Apple <code class="command">clang</code>. This has found quite a number of errors where functions have been declared without arguments and is likely to become the default in future compilers. (It already is for Apple <code class="command">clang</code> and for LLVM <code class="command">clang</code> in C23 mode.) Note that using <code class="code">f()</code> for a function without any parameters was deprecated in C99 and C11, but it became non-deprecated in C23. However, <code class="code">f(void)</code> is supported by all standards and avoids any uncertainty.</p>
<p>LLVM <code class="command">clang</code> has a separate warning <samp class="option">-Wdeprecated-non-prototype</samp> which is enabled by <samp class="option">-Wstrict-prototypes</samp>. This warns on K&amp;R-style usage, which will not be accepted in C23.</p></li>
<li><p>Several C entry points are warned against in their <code class="command">man</code> pages on most systems, often in very strong terms such as ‘<strong>Do not use these functions</strong>’. macOS has started to warn<a href="#FOOT110" id="DOCF110" class="footnote"><sup>110</sup></a> if these are used for <code class="code">sprintf</code>, <code class="code">vsprintf</code>, <code class="code">gets</code>, <code class="code">mktemp</code>, <code class="code">tempmam</code> and <code class="code">tmpnam</code>. It is highly recommended that you use safer alternatives (on any platform) but the warning can be avoided by defining <samp class="samp">_POSIX_C_SOURCE</samp>’ to for example <samp class="samp">200809L</samp>’ before including the (C or C++) header which defines them. (However, this may hide other extensions.)</p></li>
<li><p>Compilers may interpret comments in source code, so it is necessary to remove any intended for a compiler to interpret. The main example has been comments for Visual Fortran (as the Intel Fortran compiler has been known on Windows<a href="#FOOT111" id="DOCF111" class="footnote"><sup>111</sup></a>) like</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="sc">!</span>DEC<span class="sc">$</span> ATTRIBUTES DLLEXPORT,C,REFERENCE,ALIAS<span class="sc">:</span><span class="st">'kdenestmlcvb'</span> <span class="sc">::</span> kdenestmlcvb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which are interpreted by Intel Fortran on all platforms (and are inappropriate for use with R on Windows). <code class="command">gfortran</code> has similar forms starting with <code class="code">!GCC$</code>.</p></li>
<li><p>The C++ <code class="code">new</code> operator takes argument <code class="code">std::size_t size</code>, which is unsigned. Using a signed integer type such as <code class="code">int</code> may lead to compiler warnings such as</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>warning<span class="sc">:</span> argument <span class="dv">1</span> value <span class="st">'18446744073709551615'</span> exceeds maximum object</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  size <span class="dv">9223372036854775807</span>  [<span class="sc">-</span>Walloc<span class="sc">-</span>size<span class="sc">-</span>larger<span class="sc">-</span>than<span class="ot">=</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(especially if LTO is used). So don’t do that!</p></li>
<li><p>Some authors feel the need to print (using <code class="code">Rprintf</code> or similar) vector lengths or indices which are of type <code class="code">R_xlen_t</code>. That may be a 32-bit or (most commonly) 64-bit type but which integer type it is mapped to is platform-specific. The safest way is to cast the length to double and use a double format. So one could use something like</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>    SEXP Robj<span class="op">;</span> R_xlen_t nelem<span class="op">;</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>    Rf_error<span class="op">(</span><span class="st">"Actual: %0.f; Expected %0.f</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span> XLENGTH<span class="op">(</span>Robj<span class="op">),</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span> nelem<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(This could print to full precision, lengths well beyond the address space limits of current OSes, let alone practical limits.) <span id="index-XLENGTH" class="index-entry-id"></span> <span id="index-XLENGTH-1" class="index-entry-id"></span> <span id="index-Rf_005fxlength" class="index-entry-id"></span> <span id="index-Rf_005fxlength-1" class="index-entry-id"></span></p>
<p>If you do want to use an integer format, be aware that <code class="code">R_xlen_t</code> is implemented by the <code class="code">int</code>, <code class="code">long</code> or <code class="code">long long</code> type on current platforms and even on 64-bit ones need not be the same type as <code class="code">int64_t</code>. So the values will need to be cast to the type assumed by the format (and <code class="code">%lld</code> was not supported on Windows until R&nbsp;4.2.0).</p></li>
<li><p>Variadic macros in C or C++ only portably allow a non-zero number of arguments, although some compilers have allowed zero, often with a warning. The latter was standardized in C++20 using the <code class="code">__VA_OPT__</code> macro. C23 also allows zero arguments in a similar way.</p></li>
</ul>
<p>Some additional information for C++ is available at <a href="https://journal.r-project.org/archive/2011-2/RJournal_2011-2_Plummer.pdf" class="uref">https://journal.r-project.org/archive/2011-2/RJournal_2011-2_Plummer.pdf</a> by Martyn Plummer.</p>
</section>
<section id="common-symbols" class="level3 subsubsection" data-number="1.6.5">
<h3 class="subsubsection anchored" data-number="1.6.5" data-anchor-id="common-symbols"><span class="header-section-number">1.6.5</span> Common symbols <a href="#common-symbols-1" class="copiable-link">¶</a></h3>
<p>Most OSes (including all those commonly used for R) have the concept of ‘tentative definitions’ where global C variables are defined without an initializer. Traditionally the linker resolves all tentative definitions of the same variable in different object files to the same object, or to a non-tentative definition. However, <code class="command">gcc</code>&nbsp;10<a href="#FOOT112" id="DOCF112" class="footnote"><sup>112</sup></a> and LLVM <code class="command">clang</code>&nbsp;11<a href="#FOOT113" id="DOCF113" class="footnote"><sup>113</sup></a> changed their default so that tentative definitions cannot be merged and the linker will give an error if the same variable is defined in more than one object file. To avoid this, all but one of the C source files should declare the variable <code class="code">extern</code> — which means that any such variables included in header files need to be declared <code class="code">extern</code>. A commonly used idiom (including by R itself) is to define all global variables as <code class="code">extern</code> in a header, say <samp class="file">globals.h</samp> (and nowhere else), and then in one (and one only) source file use</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define extern</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="pp"># include </span><span class="im">"globals.h"</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#undef extern</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A cleaner approach is not to have global variables at all, but to place in a single file common variables (declared <code class="code">static</code>) followed by all the functions which make use of them: this may result in more efficient code.</p>
<p>The ‘modern’ behaviour can be seen<a href="#FOOT114" id="DOCF114" class="footnote"><sup>114</sup></a> by using compiler flag <samp class="option">-fno-common</samp> as part of <samp class="samp">CFLAGS</samp>’ in earlier versions of <code class="command">gcc</code> and <code class="command">clang</code>.</p>
<p><samp class="option">-fno-common</samp> is said to be particularly beneficial for ARM CPUs.</p>
<p>This is not pertinent to C++ which does not permit tentative definitions.</p>
</section>
<section id="c17-issues" class="level3 subsubsection" data-number="1.6.6">
<h3 class="subsubsection anchored" data-number="1.6.6" data-anchor-id="c17-issues"><span class="header-section-number">1.6.6</span> C++17 issues <a href="#c17-issues-1" class="copiable-link">¶</a></h3>
<p>R 4.3.0 and later default to C++17 when compiling C++, and that finally removed many C++98 features which were deprecated as long ago as C++11. Compiler/runtime authors have been slow to remove these, but LLVM <code class="command">clang</code> with its <code class="code">libc++</code> runtime library finally started to do so in 2023 – some others warn but some do not.</p>
<p>The principal offender is the ‘Boost’ collection of C++ headers and libraries. There are two little-documented ways to work around aspects of its outdated code. One is to add</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span>D_HAS_AUTO_PTR_ETC<span class="ot">=</span><span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to <code class="code">PKG_CPPLAGS</code> in <samp class="file">src/Makevars</samp>, <samp class="file">src/Makevars.win</samp> and <samp class="file">src/Makevars.ucrt</samp>. This covers the removal of</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>std<span class="sc">::</span>auto_ptr</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>std<span class="sc">::</span>unary_function</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>std<span class="sc">::</span>binary_function</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>std<span class="sc">::</span>random_shuffle</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>std<span class="sc">::</span>binder1st</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>std<span class="sc">::</span>binder2nd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>with most issues seen with code that includes <samp class="file">boost/functional.hpp</samp>, usually indirectly.</p>
<p>A rarer issue is the use of illegal values for <code class="code">enum</code> types, usually negative ones such as</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BOOST_MPL_AUX_STATIC_CAST</span>(AUX_WRAPPER_VALUE_TYPE, (value <span class="sc">-</span> <span class="dv">1</span>));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in <samp class="file">boost/mpl/aux_/integral_wrapper.hpp</samp>. Adding</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a> <span class="sc">-</span>Wno<span class="sc">-</span>error<span class="ot">=</span>enum<span class="sc">-</span>constexpr<span class="sc">-</span>conversion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to <code class="code">PKG_CXXFLAGS</code> will allow this, but that flag is only accepted by recent versions of LLVM <code class="command">clang</code> (and will not be in future) so needs a <code class="command">configure</code> test.</p>
<p>Pre=built versions of current <code class="command">clang</code>/<code class="code">libc++</code> are usually available from <a href="https://github.com/llvm/llvm-project/releases" class="uref">https://github.com/llvm/llvm-project/releases</a> for a wide range of platforms (but the Windows builds there are not compatible with <code class="code">Rtools</code> and the macOS ones are unsigned). To select <code class="code">libc++</code> add <samp class="option">-stdlib=libc++</samp> to <code class="code">CXX</code>, for example by having</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CXX</span><span class="ch">=</span><span class="st">"/path/to/clang/clang++ -std=gnu++17 -stdlib=libc++"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in <samp class="file">~/.R/Makevars</samp>.</p>
<p>Another build for Windows which may be sufficiently compatible with <code class="code">Rtools</code> can be found at <a href="https://github.com/mstorsjo/llvm-mingw" class="uref">https://github.com/mstorsjo/llvm-mingw</a>: this uses <code class="code">libc++</code>.</p>
</section>
<section id="portable-fortran-code" class="level3 subsection" data-number="1.6.7">
<h3 class="subsection anchored" data-number="1.6.7" data-anchor-id="portable-fortran-code"><span class="header-section-number">1.6.7</span> Portable Fortran code <a href="#portable-fortran-code-1" class="copiable-link">¶</a></h3>
<p>For many years almost all known R platforms used <code class="command">gfortran</code> as their Fortran compiler, but now there are LLVM and ‘classic’ <code class="command">flang</code> and the Intel compilers <code class="command">ifort</code><a href="#FOOT115" id="DOCF115" class="footnote"><sup>115</sup></a> and <code class="command">ifx</code> are now free-of-change.</p>
<p>There is still a lot of Fortran code in CRAN packages which predates Fortran 77. Modern Fortran compilers are being written to target a minimum standard of Fortran 2018. and it is desirable that Fortran code in packages complies with that standard. For <code class="command">gfortran</code> this can be checked by adding <samp class="option">-std=f2018</samp> to <code class="code">FFLAGS</code>. The most commonly seen issues are</p>
<ul>
<li><p>The use of <code class="code">DFLOAT</code>, which was superseded by <code class="code">DBLE</code> in Fortran 77. Also, use of <code class="code">DCMPLX</code>, <code class="code">DCONJG</code>, <code class="code">DIMAG</code> and similar.</p></li>
<li><p>Use of what <code class="command">gfortran</code> calls ‘Fortran 2018 deleted features’, although most were ‘deleted’ in earlier standards: those itemized here were deleted in Fortran 2008. (In the Fortran standards ‘deleted’ means features that compilers are not required to implement.) These include</p>
<ul>
<li>Arithmetic <code class="code">IF</code> statements.</li>
<li><code class="code">DO</code> loops which are not terminated with a <code class="code">END DO</code> or <code class="code">CONTINUE</code> statement. (Unlabelled <code class="code">DO</code> loops terminated by <code class="code">END DO</code> are preferred for readability.)</li>
<li>Labelled <code class="code">DO</code> loops sharing a terminating <code class="code">CONTINUE</code> statement.</li>
</ul></li>
<li><p>The use of GNU Fortran extensions. Some are listed at <a href="https://gcc.gnu.org/onlinedocs/gfortran/Extensions-implemented-in-GNU-Fortran.html" class="uref">https://gcc.gnu.org/onlinedocs/gfortran/Extensions-implemented-in-GNU-Fortran.html</a>. Others which have caused problems include <code class="code">etime</code>, <code class="code">getpid</code>, <code class="code">isnan</code><a href="#FOOT116" id="DOCF116" class="footnote"><sup>116</sup></a> and <code class="code">sizeof</code>.</p>
<p>One that frequently catches package writers is that it allows out-of-order declarations: in standard-conformant Fortran variables must be declared (explicitly or implicitly) before use in other declarations such as dimensions.</p></li>
</ul>
<p>Unfortunately this flags extensions such as <code class="code">DOUBLE COMPLEX</code> and <code class="code">COMPLEX*16</code>. R has tested that <code class="code">DOUBLE COMPLEX</code> works and so is preferred to <code class="code">COMPLEX*16</code>. (One can also use something like <code class="code">COMPLEX(KIND=KIND(0.0D0))</code>.)</p>
<p>GNU Fortran 10 and later give a compilation error for the previously widespread practice of passing a Fortran array element where an array is expected, or a scalar instead of a length-one array. See <a href="https://gcc.gnu.org/gcc-10/porting_to.html" class="uref">https://gcc.gnu.org/gcc-10/porting_to.html</a>. As do the Intel Fortran compilers, and they can be stricter.</p>
<p>The use of <code class="code">IMPLICIT NONE</code> is highly recommended – Intel compilers with <samp class="option">-warn</samp> will warn on variables without an explicit type.</p>
<p>Common non-portable constructions include</p>
<ul>
<li><p>The use of Fortran types such as <code class="code">REAL(KIND=8)</code> is very far from portable. According to the standards this merely enumerates different supported types, so <code class="code">DOUBLE PRECISION</code> might be <code class="code">REAL(KIND=3)</code> (and is on an actual compiler). Even if for a particular compiler the value indicates the size in bytes, which values are supported is platform-specific — for example <code class="command">gfortran</code> supports values of 4 and 8 on all current platforms and 10 and 16 on a few (but not for example on all <samp class="samp">arm</samp>’ CPUs).</p>
<p>The same applies to <code class="code">INTEGER(KIND=4)</code> and <code class="code">COMPLEX(KIND=16)</code>.</p>
<p>Many uses of integer and real variable in Fortran code in packages will interwork with C (for example <code class="code">.Fortran</code> is written in C), and R has checked that <code class="code">INTEGER</code> and <code class="code">DOUBLE PRECISION</code> correspond to the C types <code class="code">int</code> and <code class="code">double</code>. To make this explicit, from Fortran 2003 one can use the named constants <code class="code">c_int</code>, <code class="code">c_double</code> and <code class="code">c_double_complex</code> from module <code class="code">iso_c_binding</code>.</p></li>
<li><p>The Intel compilers only recognize the extensions <samp class="file">.f</samp> (fixed-form) and <samp class="file">.f90</samp> (free-form) and not <samp class="file">.f95</samp>. <code class="command">R CMD INSTALL</code> works around this for packages without a <samp class="file">src/Makefile</samp>.</p></li>
<li><p>Use of extensions <samp class="file">.F</samp> and <code class="code">.F90</code> to indicate source code to be preprocessed: the preprocessor used is compiler-specific and may or may not be <code class="command">cpp</code>. Compilers may even preprocess files with extension <samp class="file">.f</samp> or <samp class="file">.f90</samp> (Intel does).</p></li>
<li><p>Fixed form Fortran (with extension <samp class="file">.f</samp>) should only use 72 columns, and free-form at most 132 columns. This includes trailing comments. Over-long lines may be silently truncated or give a warning.</p></li>
<li><p>Tabs are not part of the Fortran character set: compilers tend to accept them but how they are interpreted is compiler-specific.</p></li>
<li><p>Fortran-66-style Hollerith constants.</p></li>
</ul>
<p>As well as ‘deleted features’, Fortran standards have ‘obsolescent features’. These are similar to ‘deprecated’ in other languages, but the Fortran standards committee has said it will only move them to ‘deleted’ status when they are no longer much used. These include</p>
<ul>
<li><code class="code">ENTTRY</code> statements.</li>
<li><code class="code">FORALL</code> statements.</li>
<li>Labelled <code class="code">DO</code> statements.</li>
<li><code class="code">COMMON</code> and <code class="code">EQUIVALENCE</code> statements, and <code class="code">BLOCK DATA</code> units.</li>
<li>Computed <code class="code">GOTO</code> statements, replaced by <code class="code">SELECT CASE</code>.</li>
<li>Statement functions.</li>
<li><code class="code">DATA</code> statements after executable statements.</li>
<li>Specific (rather than generic) names for intrinsic functions.</li>
</ul>
<p><code class="code">gfortran</code> with option <samp class="option">-std=f2018</samp> will warn about these: R will report only in the installation log.</p>
</section>
<section id="binary-distribution" class="level3 subsection" data-number="1.6.8">
<h3 class="subsection anchored" data-number="1.6.8" data-anchor-id="binary-distribution"><span class="header-section-number">1.6.8</span> Binary distribution <a href="#binary-distribution-1" class="copiable-link">¶</a></h3>
<p>If you want to distribute a binary version of a package on Windows or macOS, there are further checks you need to do to check it is portable: it is all too easy to depend on external software on your own machine that other users will not have.</p>
<p>For Windows, check what other DLLs your package’s DLL depends on (‘imports’ from in the DLL tools’ parlance). A convenient GUI-based tool to do so is ‘Dependency Walker’ (<a href="https://www.dependencywalker.com/" class="uref">https://www.dependencywalker.com/</a>) for both 32-bit and 64-bit DLLs – note that this will report as missing links to R’s own DLLs such as <samp class="file">R.dll</samp> and <samp class="file">Rblas.dll</samp>. The command-line tool <code class="command">objdump</code> in the appropriate toolchain will also reveal what DLLs are imported from. If you use a toolchain other than one provided by the R developers or use your own makefiles, watch out in particular for dependencies on the toolchain’s runtime DLLs such as <samp class="file">libgfortran</samp>, <samp class="file">libstdc++</samp> and <samp class="file">libgcc_s</samp>.</p>
<p>For macOS, using <code class="code">R CMD otool -L</code> on the package’s shared object(s) in the <samp class="file">libs</samp> directory will show what they depend on: watch for any dependencies in <samp class="file">/usr/local/lib</samp> or <samp class="file">/usr/local/gfortran/lib</samp>, notably <samp class="file">libgfortran.?.dylib</samp> and <samp class="file">libquadmath.0.dylib</samp>. (For ways to fix these, see <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Building-binary-packages" data-manual="R-admin">Building binary packages</a> in R Installation and Administration.)</p>
<p>Many people (including the CRAN package repository) will not accept source packages containing binary files as the latter are a security risk. If you want to distribute a source package which needs external software on Windows or macOS, options include</p>
<ul>
<li>To arrange for installation of the package to download the additional software from a URL, as e.g.&nbsp;package <a href="https://CRAN.R-project.org/package=Cairo" class="url"><strong>Cairo</strong></a> used to.</li>
<li>To negotiate with Tomas Kalibera to include Windows software in <code class="code">Rtools</code> or with Simon Urbanek to include macOS software in his ‘recipes’ system.</li>
<li>(For CRAN.) To negotiate with Uwe Ligges to host the additional components on WinBuilder, and write a <samp class="file">configure.win</samp> file to install them.</li>
</ul>
<p>Be aware that license requirements you may require you to supply the sources for the additional components (and will if your package has a GPL-like license).</p>
</section>
</section>
<section id="diagnostic-messages" class="level2 section" data-number="1.7">
<h2 class="section anchored" data-number="1.7" data-anchor-id="diagnostic-messages"><span class="header-section-number">1.7</span> Diagnostic messages <a href="#diagnostic-messages-1" class="copiable-link">¶</a></h2>
<p>Diagnostic messages can be made available for translation, so it is important to write them in a consistent style. Using the tools described in the next section to extract all the messages can give a useful overview of your consistency (or lack of it). Some guidelines follow.</p>
<ul>
<li><p>Messages are sentence fragments, and not viewed in isolation. So it is conventional not to capitalize the first word and not to end with a period (or other punctuation).</p></li>
<li><p>Try not to split up messages into small pieces. In C error messages use a single format string containing all English words in the messages.</p>
<p>In R error messages do not construct a message with <code class="code">paste</code> (such messages will not be translated) but <em>via</em> multiple arguments to <code class="code">stop</code> or <code class="code">warning</code>, or <em>via</em> <code class="code">gettextf</code>.</p></li>
<li><p>Do not use colloquialisms such as “can’t” and “don’t”.</p></li>
<li><p>Conventionally single quotation marks are used for quotations such as</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="ch">'o</span><span class="er">rd</span><span class="ch">'</span> must be a positive integer<span class="op">,</span> at most the number of knots</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and double quotation marks when referring to an R character string or a class, such as</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="st">'format'</span> must be <span class="st">"normal"</span> or <span class="st">"short"</span> <span class="sc">-</span> using <span class="st">"normal"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since ASCII does not contain directional quotation marks, it is best to use {.sample .samp}’ and let the translator (including automatic translation) use directional quotations where available. The range of quotation styles is immense: unfortunately we cannot reproduce them in a portable <code class="code">texinfo</code> document. But as a taster, some languages use ‘up’ and ‘down’ (comma) quotes rather than left or right quotes, and some use guillemets (and some use what Adobe calls ‘guillemotleft’ to start and others use it to end).</p>
<p>In R messages it is also possible to use <code class="code">sQuote</code> or <code class="code">dQuote</code> as in</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="fu">gettextf</span>(<span class="st">"object must be of class %s or %s"</span>,</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">dQuote</span>(<span class="st">"manova"</span>), <span class="fu">dQuote</span>(<span class="st">"maov"</span>)),</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">domain =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Occasionally messages need to be singular or plural (and in other languages there may be no such concept or several plural forms – Slovenian has four). So avoid constructions such as was once used in <code class="code">library</code></p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>((<span class="fu">length</span>(nopkgs) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">missing</span>(lib.loc)) {</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(nopkgs) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">"libraries "</span>,</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste</span>(<span class="fu">sQuote</span>(nopkgs), <span class="at">collapse =</span> <span class="st">", "</span>),</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">" contain no packages"</span>)</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">"library "</span>, <span class="fu">paste</span>(<span class="fu">sQuote</span>(nopkgs)),</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">" contains no package"</span>)</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and was replaced by</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">((</span>length<span class="op">(</span>nopkgs<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>missing<span class="op">(</span>lib<span class="op">.</span>loc<span class="op">))</span> <span class="op">{</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>    pkglist <span class="op">&lt;-</span> paste<span class="op">(</span>sQuote<span class="op">(</span>nopkgs<span class="op">),</span> collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    msg <span class="op">&lt;-</span> sprintf<span class="op">(</span>ngettext<span class="op">(</span>length<span class="op">(</span>nopkgs<span class="op">),</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"library </span><span class="sc">%s</span><span class="st"> contains no packages"</span><span class="op">,</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"libraries </span><span class="sc">%s</span><span class="st"> contain no packages"</span><span class="op">,</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>                            domain <span class="op">=</span> <span class="st">"R-base"</span><span class="op">),</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>                   pkglist<span class="op">)</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>    warning<span class="op">(</span>msg<span class="op">,</span> domain<span class="op">=</span>NA<span class="op">)</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that it is much better to have complete clauses as here, since in another language one might need to say ‘There is no package in library %s’ or ‘There are no packages in libraries %s’.</p></li>
</ul>
</section>
<section id="internationalization" class="level2 section" data-number="1.8">
<h2 class="section anchored" data-number="1.8" data-anchor-id="internationalization"><span class="header-section-number">1.8</span> Internationalization <a href="#internationalization-1" class="copiable-link">¶</a></h2>
<p>There are mechanisms to translate the R- and C-level error and warning messages. There are only available if R is compiled with NLS support (which is requested by <code class="command">configure</code> option <samp class="option">--enable-nls</samp>, the default).</p>
<p>The procedures make use of <code class="code">msgfmt</code> and <code class="code">xgettext</code> which are part of GNU <code class="code">gettext</code> and this will need to be installed: <samp class="samp">x86_64</samp>’ Windows users can find pre-compiled binaries at <a href="https://www.stats.ox.ac.uk/pub/Rtools/goodies/gettext-tools.zip" class="uref">https://www.stats.ox.ac.uk/pub/Rtools/goodies/gettext-tools.zip</a>.</p>
<section id="c-level-messages" class="level3 subsection" data-number="1.8.1">
<h3 class="subsection anchored" data-number="1.8.1" data-anchor-id="c-level-messages"><span class="header-section-number">1.8.1</span> C-level messages <a href="#c-level-messages-1" class="copiable-link">¶</a></h3>
<p>The process of enabling translations is</p>
<ul>
<li><p>In a header file that will be included in all the C (or C++ or Objective C/C++) files containing messages that should be translated, declare</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span><span class="pp">  </span><span class="co">/* to include Rconfig.h */</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef ENABLE_NLS</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;libintl.h&gt;</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _</span><span class="op">(</span><span class="pp">String</span><span class="op">)</span><span class="pp"> dgettext </span><span class="op">(</span><span class="st">"pkg"</span><span class="op">,</span><span class="pp"> String</span><span class="op">)</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a><span class="co">/* replace pkg as appropriate */</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _</span><span class="op">(</span><span class="pp">String</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">String</span><span class="op">)</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>For each message that should be translated, wrap it in <code class="code">_(...)</code>, for example</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>error<span class="op">(</span>_<span class="op">(</span><span class="st">"'ord' must be a positive integer"</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you want to use different messages for singular and plural forms, you need to add</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef ENABLE_NLS</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define dngettext</span><span class="op">(</span><span class="pp">pkg</span><span class="op">,</span><span class="pp"> String</span><span class="op">,</span><span class="pp"> StringP</span><span class="op">,</span><span class="pp"> N</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">N </span><span class="op">==</span><span class="pp"> </span><span class="dv">1</span><span class="pp"> </span><span class="op">?</span><span class="pp"> String </span><span class="op">:</span><span class="pp"> StringP</span><span class="op">)</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and mark strings by</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dngettext</span>(<span class="st">"pkg"</span>, <span class="sc">&lt;</span>singular string<span class="sc">&gt;</span>, <span class="sc">&lt;</span>plural string<span class="sc">&gt;</span>, n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>In the package’s <samp class="file">src</samp> directory run <code>r     xgettext --keyword=_ -o pkg.pot *.c</code></p></li>
</ul>
<p>The file <samp class="file">src/</samp><var class="var">pkg</var><samp class="file">.pot</samp> is the template file, and conventionally this is shipped as <samp class="file">po/</samp><var class="var">pkg</var><samp class="file">.pot</samp>.</p>
</section>
<section id="r-messages" class="level3 subsection" data-number="1.8.2">
<h3 class="subsection anchored" data-number="1.8.2" data-anchor-id="r-messages"><span class="header-section-number">1.8.2</span> R messages <a href="#r-messages-1" class="copiable-link">¶</a></h3>
<p>Mechanisms are also available to support the automatic translation of R <code class="code">stop</code>, <code class="code">warning</code> and <code class="code">message</code> messages. They make use of message catalogs in the same way as C-level messages, but using domain <code class="code">R-</code><var class="var">pkg</var> rather than <var class="var">pkg</var>. Translation of character strings inside <code class="code">stop</code>, <code class="code">warning</code> and <code class="code">message</code> calls is automatically enabled, as well as other messages enclosed in calls to <code class="code">gettext</code> or <code class="code">gettextf</code>. (To suppress this, use argument <code class="code">domain=NA</code>.)</p>
<p>Tools to prepare the <samp class="file">R-</samp><var class="var">pkg</var><samp class="file">.pot</samp> file are provided in package <strong>tools</strong>: <code class="code">xgettext2pot</code> will prepare a file from all strings occurring inside <code class="code">gettext</code>/<code class="code">gettextf</code>, <code class="code">stop</code>, <code class="code">warning</code> and <code class="code">message</code> calls. Some of these are likely to be spurious and so the file is likely to need manual editing. <code class="code">xgettext</code> extracts the actual calls and so is more useful when tidying up error messages.</p>
<p>The R function <code class="code">ngettext</code> provides an interface to the C function of the same name: see example in the previous section. It is safest to use <code class="code">domain="R-</code><var class="var">pkg</var><code class="code">"</code> explicitly in calls to <code class="code">ngettext</code>, and necessary for earlier versions of R unless they are calls directly from a function in the package.</p>
</section>
<section id="preparing-translations" class="level3 subsection" data-number="1.8.3">
<h3 class="subsection anchored" data-number="1.8.3" data-anchor-id="preparing-translations"><span class="header-section-number">1.8.3</span> Preparing translations <a href="#preparing-translations-1" class="copiable-link">¶</a></h3>
<p>Once the template files have been created, translations can be made. Conventional translations have file extension <samp class="file">.po</samp> and are placed in the <samp class="file">po</samp> subdirectory of the package with a name that is either <var class="var">ll</var><samp class="samp">.po</samp>’ or <samp class="samp">R-</samp><var class="var">ll</var><samp class="samp">.po</samp>’ for translations of the C and R messages respectively to language with code <var class="var">ll</var>’.</p>
<p>See <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Localization-of-messages" data-manual="R-admin">Localization of messages</a> in R Installation and Administration for details of language codes.</p>
<p>There is an R function, <code class="code">update_pkg_po</code> in package <strong>tools</strong>, to automate much of the maintenance of message translations. See its help for what it does in detail.</p>
<p>If this is called on a package with no existing translations, it creates the directory <var class="var">pkgdir</var><samp class="file">/po</samp>, creates a template file of R messages, <var class="var">pkgdir</var><samp class="file">/po/R-</samp><var class="var">pkg</var><samp class="file">.pot</samp>, within it, creates the <samp class="samp">en@quot</samp>’ translation and installs that. (The <samp class="samp">en@quot</samp>’ pseudo-language interprets quotes in their directional forms in suitable (e.g.&nbsp;UTF-8) locales.)</p>
<p>If the package has C source files in its <samp class="file">src</samp> directory that are marked for translation, use</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> pkgdir/po/pkg.pot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to create a dummy template file, then call <code class="code">update_pkg_po</code> again (this can also be done before it is called for the first time).</p>
<p>When translations to new languages are added in the <var class="var">pkgdir</var><samp class="file">/po</samp> directory, running the same command will check and then install the translations.</p>
<p>If the package sources are updated, the same command will update the template files, merge the changes into the translation <samp class="file">.po</samp> files and then installed the updated translations. You will often see that merging marks translations as ‘fuzzy’ and this is reported in the coverage statistics. As fuzzy translations are <em>not</em> used, this is an indication that the translation files need human attention.</p>
<p>The merged translations are run through <code class="code">tools::checkPofile</code> to check that C-style formats are used correctly: if not the mismatches are reported and the broken translations are not installed.</p>
<p>This function needs the GNU <code class="command">gettext-tools</code> installed and on the path: see its help page.</p>
</section>
</section>
<section id="citation-files" class="level2 section" data-number="1.9">
<h2 class="section anchored" data-number="1.9" data-anchor-id="citation-files"><span class="header-section-number">1.9</span> CITATION files <a href="#citation-files-1" class="copiable-link">¶</a></h2>
<p><span id="index-citation-1" class="index-entry-id"></span> <span id="index-CITATION-file-1" class="index-entry-id"></span></p>
<p>An installed file named <samp class="file">CITATION</samp> will be used by the <code class="code">citation()</code> function. (It should be in the <samp class="file">inst</samp> subdirectory of the package sources.)</p>
<p>The <samp class="file">CITATION</samp> file is parsed as R code (in the package’s declared encoding, or in ASCII if none is declared). It will contain calls to function <code class="code">bibentry</code>. Here is that for <a href="https://CRAN.R-project.org/package=nlme" class="url"><strong>nlme</strong></a>:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="do">## R package reference generated from DESCRIPTION metadata</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="fu">citation</span>(<span class="at">auto =</span> meta)</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="do">## NLME book</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bibentry</span>(<span class="at">bibtype =</span> <span class="st">"Book"</span>,</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">title =</span> <span class="st">"Mixed-Effects Models in S and S-PLUS"</span>,</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">author =</span> <span class="fu">c</span>(<span class="fu">person</span>(<span class="fu">c</span>(<span class="st">"José"</span>, <span class="st">"C."</span>), <span class="st">"Pinheiro"</span>),</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">person</span>(<span class="fu">c</span>(<span class="st">"Douglas"</span>, <span class="st">"M."</span>), <span class="st">"Bates"</span>)),</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="st">"2000"</span>, <span class="at">publisher =</span> <span class="st">"Springer"</span>, <span class="at">address =</span> <span class="st">"New York"</span>,</span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">doi =</span> <span class="st">"10.1007/b98882"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note how the first call auto-generates citation information from object <code class="code">meta</code>, a parsed version of the <samp class="file">DESCRIPTION</samp> file – it is tempting to hardcode such information, but it normally then gets outdated. How the first entry would look like as a <code class="code">bibentry</code> call can be seen from <code class="code">print(citation("</code><var class="var">pkgname</var><code class="code">", auto = TRUE), style = "R")</code> for any installed package. Auto-generated information is returned by default if no <samp class="file">CITATION</samp> file is present.</p>
<p>See <code class="code">?bibentry</code> for further details of the information which can be provided. In case a bibentry contains LaTeX markup (e.g., for accented characters or mathematical symbols), it may be necessary to provide a text representation to be used for printing <em>via</em> the <code class="code">textVersion</code> argument to <code class="code">bibentry</code>. E.g., earlier versions of <a href="https://CRAN.R-project.org/package=nlme" class="url"><strong>nlme</strong></a> additionally used something like</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>         textVersion <span class="op">=</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>         paste0<span class="op">(</span><span class="st">"Jose Pinheiro, Douglas Bates, Saikat DebRoy, "</span><span class="op">,</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Deepayan Sarkar and the R Core Team ("</span><span class="op">,</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>                sub<span class="op">(</span><span class="st">"-.*"</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> meta$Date<span class="op">),</span></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"). nlme: Linear and Nonlinear Mixed Effects Models. "</span><span class="op">,</span></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>                sprintf<span class="op">(</span><span class="st">"R package version </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> meta$Version<span class="op">),</span> <span class="st">"."</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <samp class="file">CITATION</samp> file should itself produce no output when <code class="code">source</code>-d.</p>
<p>It is desirable (and essential for CRAN) that the <samp class="file">CITATION</samp> file does not contain calls to functions such as <code class="code">packageDescription</code> which assume the package is installed in a library tree on the package search path.</p>
</section>
<section id="package-types" class="level2 section" data-number="1.10">
<h2 class="section anchored" data-number="1.10" data-anchor-id="package-types"><span class="header-section-number">1.10</span> Package types <a href="#package-types-1" class="copiable-link">¶</a></h2>
<p>The <samp class="file">DESCRIPTION</samp> file has an optional field <code class="code">Type</code> which if missing is assumed to be <samp class="samp">Package</samp>‘, the sort of extension discussed so far in this chapter. Currently one other type is recognized; there used also to be a <samp class="samp">Translation</samp>’ type.</p>
<section id="frontend" class="level3 subsection" data-number="1.10.1">
<h3 class="subsection anchored" data-number="1.10.1" data-anchor-id="frontend"><span class="header-section-number">1.10.1</span> Frontend <a href="#frontend-1" class="copiable-link">¶</a></h3>
<p>This is a rather general mechanism, designed for adding new front-ends such as the former <strong>gnomeGUI</strong> package (see the <samp class="file">Archive</samp> area on CRAN). If a <samp class="file">configure</samp> file is found in the top-level directory of the package it is executed, and then if a <samp class="file">Makefile</samp> is found (often generated by <samp class="file">configure</samp>), <code class="code">make</code> is called. If <code class="code">R CMD INSTALL --clean</code> is used <code class="code">make clean</code> is called. No other action is taken.</p>
<p><code class="code">R CMD build</code> can package up this type of extension, but <code class="code">R CMD check</code> will check the type and skip it.</p>
<p>Many packages of this type need write permission for the R installation directory.</p>
</section>
</section>
<section id="services" class="level2 section" data-number="1.11">
<h2 class="section anchored" data-number="1.11" data-anchor-id="services"><span class="header-section-number">1.11</span> Services <a href="#services-1" class="copiable-link">¶</a></h2>
<p>Several members of the R project have set up services to assist those writing R packages, particularly those intended for public distribution.</p>
<p><a href="https://win-builder.r-project.org" class="uref">win-builder.r-project.org</a> offers the automated preparation of (<samp class="samp">x86_64</samp>’) Windows binaries from well-tested source packages.</p>
<p>R-Forge (<a href="https://R-Forge.r-project.org" class="uref">R-Forge.r-project.org</a>) and RForge (<a href="https://www.rforge.net" class="uref">www.rforge.net</a>) are similar services with similar names. Both provide source-code management through SVN, daily building and checking, mailing lists and a repository that can be accessed <em>via</em> <code class="code">install.packages</code> (they can be selected by <code class="code">setRepositories</code> and the GUI menus that use it). Package developers have the opportunity to present their work on the basis of project websites or news announcements. Mailing lists, forums or wikis provide useRs with convenient instruments for discussions and for exchanging information between developers and/or interested useRs.</p>

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Acknowledgements.html" class="pagination-link" aria-label="Acknowledgements [¶](#acknowledgements-1){.copiable-link}">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Acknowledgements </span></a><a href="#acknowledgements-1" class="copiable-link">¶</a>
                
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Writing-R-documentation-files.html" class="pagination-link" aria-label="Writing R documentation files [¶](#writing-r-documentation-files-1){.copiable-link}">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Writing R documentation files </span></span></a><a href="#writing-r-documentation-files-1" class="copiable-link">¶</a> <i class="bi bi-arrow-right-short"></i>
      
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>A re-styled version of the original R manuals at <a href="https://cran.r-project.org/manuals.html" class="uri">https://cran.r-project.org/manuals.html</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built using <a href="https://quarto.org">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>