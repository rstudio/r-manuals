<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>6&nbsp; The R API: entry points for C code – R Manuals :: Writing R Extensions ¶</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Generic-functions-and-methods.html" rel="next">
<link href="./System-and-foreign-language-interfaces.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-550cd6ffca0d0790fc8e00be81a4e47f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">R Manuals :: Writing R Extensions ¶</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-manuals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Manuals</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-manuals">    
        <li>
    <a class="dropdown-item" href="./../r-intro/index.html">
 <span class="dropdown-text">An Introduction to R ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-data/index.html">
 <span class="dropdown-text">R Data Import/Export ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-admin/index.html">
 <span class="dropdown-text">R Installation and Administration ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-exts/index.html">
 <span class="dropdown-text">Writing R Extensions ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-lang/index.html">
 <span class="dropdown-text">R Language Definition ¶</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-ints/index.html">
 <span class="dropdown-text">R Internals ¶</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./The-R-API.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The R API: entry points for C code</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Top (Writing R Extensions)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Creating-R-packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Creating R packages</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Writing-R-documentation-files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Writing R documentation files</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Tidying-and-profiling-R-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Tidying and profiling R code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Debugging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Debugging</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./System-and-foreign-language-interfaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">System and foreign language interfaces</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./The-R-API.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The R API: entry points for C code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Generic-functions-and-methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Generic functions and methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Linking-GUIs-and-other-front-ends-to-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Linking GUIs and other front-ends to R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Function-and-variable-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Function and variable index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">API index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Fortran-API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fortran API index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Experimental-API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Experimental API index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Embedding-API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Embedding API index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Concept-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Concept index</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#memory-allocation" id="toc-memory-allocation" class="nav-link active" data-scroll-target="#memory-allocation"><span class="header-section-number">6.1</span> Memory allocation</a>
  <ul class="collapse">
  <li><a href="#transient-storage-allocation" id="toc-transient-storage-allocation" class="nav-link" data-scroll-target="#transient-storage-allocation"><span class="header-section-number">6.1.1</span> Transient storage allocation</a></li>
  <li><a href="#user-controlled-memory" id="toc-user-controlled-memory" class="nav-link" data-scroll-target="#user-controlled-memory"><span class="header-section-number">6.1.2</span> User-controlled memory</a></li>
  </ul></li>
  <li><a href="#error-signaling" id="toc-error-signaling" class="nav-link" data-scroll-target="#error-signaling"><span class="header-section-number">6.2</span> Error signaling</a>
  <ul class="collapse">
  <li><a href="#error-signaling-from-fortran" id="toc-error-signaling-from-fortran" class="nav-link" data-scroll-target="#error-signaling-from-fortran"><span class="header-section-number">6.2.1</span> Error signaling from Fortran</a></li>
  </ul></li>
  <li><a href="#random-number-generation" id="toc-random-number-generation" class="nav-link" data-scroll-target="#random-number-generation"><span class="header-section-number">6.3</span> Random number generation</a>
  <ul class="collapse">
  <li><a href="#random-number-generation-from-fortran" id="toc-random-number-generation-from-fortran" class="nav-link" data-scroll-target="#random-number-generation-from-fortran"><span class="header-section-number">6.3.1</span> Random-number generation from Fortran</a></li>
  </ul></li>
  <li><a href="#missing-and-ieee-special-values" id="toc-missing-and-ieee-special-values" class="nav-link" data-scroll-target="#missing-and-ieee-special-values"><span class="header-section-number">6.4</span> Missing and IEEE special values</a></li>
  <li><a href="#printing" id="toc-printing" class="nav-link" data-scroll-target="#printing"><span class="header-section-number">6.5</span> Printing</a>
  <ul class="collapse">
  <li><a href="#printing-from-fortran" id="toc-printing-from-fortran" class="nav-link" data-scroll-target="#printing-from-fortran"><span class="header-section-number">6.5.1</span> Printing from Fortran</a></li>
  </ul></li>
  <li><a href="#calling-c-from-fortran-and-vice-versa" id="toc-calling-c-from-fortran-and-vice-versa" class="nav-link" data-scroll-target="#calling-c-from-fortran-and-vice-versa"><span class="header-section-number">6.6</span> Calling C from Fortran and vice versa</a>
  <ul class="collapse">
  <li><a href="#fortran-character-strings" id="toc-fortran-character-strings" class="nav-link" data-scroll-target="#fortran-character-strings"><span class="header-section-number">6.6.1</span> Fortran character strings</a></li>
  <li><a href="#fortran-logical" id="toc-fortran-logical" class="nav-link" data-scroll-target="#fortran-logical"><span class="header-section-number">6.6.2</span> Fortran LOGICAL</a></li>
  <li><a href="#passing-functions" id="toc-passing-functions" class="nav-link" data-scroll-target="#passing-functions"><span class="header-section-number">6.6.3</span> Passing functions</a></li>
  </ul></li>
  <li><a href="#numerical-analysis-subroutines" id="toc-numerical-analysis-subroutines" class="nav-link" data-scroll-target="#numerical-analysis-subroutines"><span class="header-section-number">6.7</span> Numerical analysis subroutines</a>
  <ul class="collapse">
  <li><a href="#distribution-functions" id="toc-distribution-functions" class="nav-link" data-scroll-target="#distribution-functions"><span class="header-section-number">6.7.1</span> Distribution functions</a></li>
  <li><a href="#mathematical-functions" id="toc-mathematical-functions" class="nav-link" data-scroll-target="#mathematical-functions"><span class="header-section-number">6.7.2</span> Mathematical functions</a></li>
  <li><a href="#numerical-utilities" id="toc-numerical-utilities" class="nav-link" data-scroll-target="#numerical-utilities"><span class="header-section-number">6.7.3</span> Numerical Utilities</a></li>
  <li><a href="#mathematical-constants" id="toc-mathematical-constants" class="nav-link" data-scroll-target="#mathematical-constants"><span class="header-section-number">6.7.4</span> Mathematical constants</a></li>
  </ul></li>
  <li><a href="#optimization" id="toc-optimization" class="nav-link" data-scroll-target="#optimization"><span class="header-section-number">6.8</span> Optimization</a></li>
  <li><a href="#integration" id="toc-integration" class="nav-link" data-scroll-target="#integration"><span class="header-section-number">6.9</span> Integration</a></li>
  <li><a href="#utility-functions" id="toc-utility-functions" class="nav-link" data-scroll-target="#utility-functions"><span class="header-section-number">6.10</span> Utility functions</a></li>
  <li><a href="#linear-algebra" id="toc-linear-algebra" class="nav-link" data-scroll-target="#linear-algebra"><span class="header-section-number">6.11</span> Linear algebra</a></li>
  <li><a href="#re-encoding" id="toc-re-encoding" class="nav-link" data-scroll-target="#re-encoding"><span class="header-section-number">6.12</span> Re-encoding</a></li>
  <li><a href="#condition-handling-and-cleanup-code" id="toc-condition-handling-and-cleanup-code" class="nav-link" data-scroll-target="#condition-handling-and-cleanup-code"><span class="header-section-number">6.13</span> Condition handling and cleanup code</a></li>
  <li><a href="#allowing-interrupts" id="toc-allowing-interrupts" class="nav-link" data-scroll-target="#allowing-interrupts"><span class="header-section-number">6.14</span> Allowing interrupts</a></li>
  <li><a href="#c-stack-checking" id="toc-c-stack-checking" class="nav-link" data-scroll-target="#c-stack-checking"><span class="header-section-number">6.15</span> C stack checking</a></li>
  <li><a href="#custom-serialization-input-and-output" id="toc-custom-serialization-input-and-output" class="nav-link" data-scroll-target="#custom-serialization-input-and-output"><span class="header-section-number">6.16</span> Custom serialization input and output</a></li>
  <li><a href="#platform-and-version-information" id="toc-platform-and-version-information" class="nav-link" data-scroll-target="#platform-and-version-information"><span class="header-section-number">6.17</span> Platform and version information</a></li>
  <li><a href="#inlining-c-functions" id="toc-inlining-c-functions" class="nav-link" data-scroll-target="#inlining-c-functions"><span class="header-section-number">6.18</span> Inlining C functions</a></li>
  <li><a href="#controlling-visibility" id="toc-controlling-visibility" class="nav-link" data-scroll-target="#controlling-visibility"><span class="header-section-number">6.19</span> Controlling visibility</a></li>
  <li><a href="#using-these-functions-in-your-own-c-code" id="toc-using-these-functions-in-your-own-c-code" class="nav-link" data-scroll-target="#using-these-functions-in-your-own-c-code"><span class="header-section-number">6.20</span> Using these functions in your own C code</a></li>
  <li><a href="#organization-of-header-files" id="toc-organization-of-header-files" class="nav-link" data-scroll-target="#organization-of-header-files"><span class="header-section-number">6.21</span> Organization of header files</a></li>
  <li><a href="#moving-into-c-api-compliance" id="toc-moving-into-c-api-compliance" class="nav-link" data-scroll-target="#moving-into-c-api-compliance"><span class="header-section-number">6.22</span> Moving into C API compliance</a>
  <ul class="collapse">
  <li><a href="#some-api-replacements-for-non-api-entry-points" id="toc-some-api-replacements-for-non-api-entry-points" class="nav-link" data-scroll-target="#some-api-replacements-for-non-api-entry-points"><span class="header-section-number">6.22.1</span> Some API replacements for non-API entry points</a></li>
  <li><a href="#creating-environments" id="toc-creating-environments" class="nav-link" data-scroll-target="#creating-environments"><span class="header-section-number">6.22.2</span> Creating environments</a></li>
  <li><a href="#creating-call-expressions" id="toc-creating-call-expressions" class="nav-link" data-scroll-target="#creating-call-expressions"><span class="header-section-number">6.22.3</span> Creating call expressions</a></li>
  <li><a href="#creating-closures" id="toc-creating-closures" class="nav-link" data-scroll-target="#creating-closures"><span class="header-section-number">6.22.4</span> Creating closures</a></li>
  <li><a href="#querying-charsxp-encoding" id="toc-querying-charsxp-encoding" class="nav-link" data-scroll-target="#querying-charsxp-encoding"><span class="header-section-number">6.22.5</span> Querying <code class="code">CHARSXP</code> encoding</a></li>
  <li><a href="#working-with-attributes" id="toc-working-with-attributes" class="nav-link" data-scroll-target="#working-with-attributes"><span class="header-section-number">6.22.6</span> Working with attributes</a></li>
  <li><a href="#working-variable-bindings" id="toc-working-variable-bindings" class="nav-link" data-scroll-target="#working-variable-bindings"><span class="header-section-number">6.22.7</span> Working variable bindings</a></li>
  <li><a href="#some-backports" id="toc-some-backports" class="nav-link" data-scroll-target="#some-backports"><span class="header-section-number">6.22.8</span> Some backports</a></li>
  <li><a href="#footnotes" id="toc-footnotes" class="nav-link" data-scroll-target="#footnotes"><span class="header-section-number">6.22.9</span> Footnotes</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The R API: entry points for C code</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Next: <a href="Generic-functions-and-methods.html#generic-functions-and-methods" accesskey="n" rel="next">Generic functions and methods</a>, Previous: <a href="System-and-foreign-language-interfaces.html#system-and-foreign-language-interfaces" accesskey="p" rel="prev">System and foreign language interfaces</a>, Up: <a href="index.html" accesskey="u" rel="up">Writing R Extensions</a> &nbsp; [<a href="index.html#sec_contents" rel="contents" title="Table of contents">Contents</a>][<a href="Function-and-variable-index.html" rel="index" title="Index">Index</a>]</p>
<p>There are a large number of entry points in the R executable/DLL that can be called from C code (and a few that can be called from Fortran code). Only those documented here are stable enough that they will only be changed with considerable notice.</p>
<p>As explained elsewhere in this manual, these functions should only be called from the main thread of the R process. (Doing otherwise can result in memory corruption and very hard-to-debug segfaults.)</p>
<p>The recommended procedure to use these is to include the header file <samp class="file">R.h</samp> in your C code by</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will include several other header files from the directory <var class="var">R_INCLUDE_DIR</var><samp class="file">/R_ext</samp>, and there are other header files there that can be included too, but many of the features they contain should be regarded as undocumented and unstable.</p>
<p>Most of these header files, including all those included by <samp class="file">R.h</samp>, can be used from C++ code. (However, they cannot safely be included in a <code class="code">extern "C" { }</code> block as they may include C++ headers when included from C++ code—and whether this succeeds is system-specific).</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> Because R re-maps many of its external names to avoid clashes with system or user code, it is <em>essential</em> to include the appropriate header files when using these entry points.</p>
</blockquote>
<p>This remapping can cause problems<a href="#FOOT166" id="DOCF166" class="footnote"><sup>166</sup></a>, and can be eliminated by defining <code class="code">R_NO_REMAP</code> (before including any R headers) and prepending <samp class="samp">Rf_</samp>’ to <em>all</em> the function names used from <samp class="file">Rinternals.h</samp> and <samp class="file">R_ext/Error.h</samp>. These problems can usually be avoided by including other headers (such as system headers and those for external software used by the package) before any R headers. (Headers from other packages may include R headers directly or <em>via</em> inclusion from further packages, and may define <code class="code">R_NO_REMAP</code> with or without including <samp class="file">Rinternals.h</samp>.) <span id="index-R_005fext_002fError_002eh" class="index-entry-id"></span></p>
<p>As from R 4.5.0, <code class="code">R_NO_REMAP</code> is always defined when the R headers are included from C++ code.</p>
<p>If you decide to define <code class="code">R_NO_REMAP</code> in your code, do use something like</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef R_NO_REMAP</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="pp"># define R_NO_REMAP</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to avoid distracting compiler warnings.</p>
<p>Some of these entry points are declared in header <samp class="file">Rmath.h</samp>, most of which are remapped there. That remapping can be eliminated by defining <code class="code">R_NO_REMAP_RMATH</code> (before including any R headers) and prepending <samp class="samp">Rf_</samp>’ to the function names used from that header except</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>exp_rand norm_rand unif_rand signrank_free wilcox_free</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can classify the entry points as</p>
<dl>
<dt><em>API</em></dt>
<dd>
<p>Entry points which are documented in this manual and declared in an installed header file. These can be used in distributed packages and ideally will only be changed after deprecation. See <a href="API-index.html" class="xref">API index</a>.</p>
</dd>
<dt><em>public</em></dt>
<dd>
<p>Entry points declared in an installed header file that are exported on all R platforms but are not documented and subject to change without notice. Do not use these in distributed code. Their declarations will eventually be moved out of installed header files.</p>
</dd>
<dt><em>private</em></dt>
<dd>
<p>Entry points that are used when building R and exported on all R platforms but are not declared in the installed header files. Do not use these in distributed code.</p>
</dd>
<dt><em>hidden</em></dt>
<dd>
<p>Entry points that are where possible (Windows and some modern Unix-alike compilers/loaders when using R as a shared library) not exported.</p>
</dd>
<dt><em>experimental</em></dt>
<dd>
<p>Entry points declared in an installed header file that are part of an experimental API, such as <samp class="file">R_ext/Altrep.h</samp>. These are subject to change, so package authors wishing to use these should be prepared to adapt. See <a href="Experimental-API-index.html" class="xref">Experimental API index</a>.</p>
</dd>
<dt><em>embedding</em></dt>
<dd>
<p>Entry points intended primarily for embedding and creating new front-ends. It is not clear that this needs to be a separate category but it may be useful to keep it separate for now. See <a href="Embedding-API-index.html" class="xref">Embedding API index</a>.</p>
</dd>
</dl>
<p>If you would like to use an entry point or variable that is not identified as part of the API in this document, or is currently hidden, you can make a request for it to be made available. Entry points or variables not identified as in the API may be changed or removed with no notice as part of efforts to improve aspects of R.</p>
<p><strong>Work in progress:</strong> Currently Entry points in the API are identified in the source for this document with <code class="code">@apifun</code>, <code class="code">@eapifun</code>, and <code class="code">@embfun</code> entries. Similarly, <code class="code">@apivar</code>, <code class="code">@eapivar</code>, and <code class="code">@embvar</code> identify variables, and <code class="code">@apihdr</code>, <code class="code">@eapihdr</code>, and <code class="code">@embhdr</code> identify headers in the API. <code class="code">@forfun</code> identifies entry points to be called as Fortran subroutines. This could be used for programmatic extraction, but the specific format is work in progress and even the way this document is produced is subject to change.</p>
<section id="memory-allocation" class="level2 section" data-number="6.1">
<h2 class="section anchored" data-number="6.1" data-anchor-id="memory-allocation"><span class="header-section-number">6.1</span> Memory allocation</h2>
<p>There are two types of memory allocation available to the C programmer, one in which R manages the clean-up and the other in which users have full control (and responsibility).</p>
<p>These functions are declared in header <samp class="file">R_ext/RS.h</samp> which is included by <samp class="file">R.h</samp>.</p>
<section id="transient-storage-allocation" class="level3 subsection" data-number="6.1.1">
<h3 class="subsection anchored" data-number="6.1.1" data-anchor-id="transient-storage-allocation"><span class="header-section-number">6.1.1</span> Transient storage allocation</h3>
<p><span id="index-R_005falloc-1" class="index-entry-id"></span> <span id="index-R_005falloc-3" class="index-entry-id"></span> <span id="index-R_005fallocLD" class="index-entry-id"></span> <span id="index-R_005fallocLD-1" class="index-entry-id"></span> <span id="index-S_005falloc" class="index-entry-id"></span> <span id="index-S_005falloc-1" class="index-entry-id"></span> <span id="index-S_005frealloc" class="index-entry-id"></span> <span id="index-S_005frealloc-1" class="index-entry-id"></span> <span id="index-vmaxget" class="index-entry-id"></span> <span id="index-vmaxget-1" class="index-entry-id"></span> <span id="index-vmaxset" class="index-entry-id"></span> <span id="index-vmaxset-1" class="index-entry-id"></span> <span id="index-Rf_005fnrows" class="index-entry-id"></span> <span id="index-Rf_005fnrows-1" class="index-entry-id"></span> <span id="index-Rf_005fncols" class="index-entry-id"></span> <span id="index-Rf_005fncols-1" class="index-entry-id"></span></p>
<p>Here R will reclaim the memory at the end of the call to <code class="code">.C</code>, <code class="code">.Call</code> or <code class="code">.External</code>. Use</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>R_alloc<span class="op">(</span><span class="dt">size_t</span> n<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which allocates <var class="var">n</var> units of <var class="var">size</var> bytes each. A typical usage (from package <strong>stats</strong>) is</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="op">(</span><span class="dt">int</span> <span class="op">*)</span> R_alloc<span class="op">(</span>nrows<span class="op">(</span>merge<span class="op">)+</span><span class="dv">2</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(<code class="code">size_t</code> is defined in <samp class="file">stddef.h</samp> which the header defining <code class="code">R_alloc</code> includes.)</p>
<p>There is a similar call, <code class="code">S_alloc</code> (named for compatibility with older versions of S) which zeroes the memory allocated,</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>S_alloc<span class="op">(</span><span class="dt">long</span> n<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>S_realloc<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>p<span class="op">,</span> <span class="dt">long</span> new<span class="op">,</span> <span class="dt">long</span> old<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which (for <var class="var">new</var><code class="code">&gt;</code><var class="var">old</var>) changes the allocation size from <var class="var">old</var> to <var class="var">new</var> units, and zeroes the additional units. NB: these calls are best avoided as <code class="code">long</code> is insufficient for large memory allocations on 64-bit Windows (where it is limited to 2^31-1 bytes).</p>
<p>This memory is taken from the heap, and released at the end of the <code class="code">.C</code>, <code class="code">.Call</code> or <code class="code">.External</code> call. Users can also manage it, by noting the current position with a call to <code class="code">vmaxget</code> and subsequently clearing memory allocated by a call to <code class="code">vmaxset</code>. An example might be</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>vmax <span class="op">=</span> vmaxget<span class="op">()</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// a loop involving the use of R_alloc at each iteration</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>vmaxset<span class="op">(</span>vmax<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is only recommended for experts.</p>
<p>Note that this memory will be freed on error or user interrupt (if allowed: see <a href="#allowing-interrupts" class="pxref">Allowing interrupts</a>).</p>
<p>The memory returned is only guaranteed to be aligned as required for <code class="code">double</code> pointers: take precautions if casting to a pointer which needs more. There is also</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> <span class="dt">double</span> <span class="op">*</span>R_allocLD<span class="op">(</span><span class="dt">size_t</span> n<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which is guaranteed to have the 16-byte alignment needed for <code class="code">long double</code> pointers on some platforms.</p>
<p>These functions should only be used in code called by <code class="code">.C</code> etc, never from front-ends. They are not thread-safe.</p>
</section>
<section id="user-controlled-memory" class="level3 subsection" data-number="6.1.2">
<h3 class="subsection anchored" data-number="6.1.2" data-anchor-id="user-controlled-memory"><span class="header-section-number">6.1.2</span> User-controlled memory</h3>
<p>The other form of memory allocation is an interface to <code class="code">malloc</code>, the interface providing R error signaling. This memory lasts until freed by the user and is additional to the memory allocated for the R workspace.</p>
<p>The interface macros are</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>type<span class="op">*</span> R_Calloc<span class="op">(</span><span class="dt">size_t</span> n<span class="op">,</span> type<span class="op">)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>type<span class="op">*</span> R_Realloc<span class="op">(</span>any <span class="op">*</span>p<span class="op">,</span> <span class="dt">size_t</span> n<span class="op">,</span> type<span class="op">)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_Free<span class="op">(</span>any <span class="op">*</span>p<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span id="index-R_005fCalloc" class="index-entry-id"></span> <span id="index-R_005fCalloc-1" class="index-entry-id"></span> <span id="index-R_005fRealloc" class="index-entry-id"></span> <span id="index-R_005fRealloc-1" class="index-entry-id"></span> <span id="index-R_005fFree" class="index-entry-id"></span> <span id="index-R_005fFree-1" class="index-entry-id"></span></p>
<p>providing analogues of <code class="code">calloc</code>, <code class="code">realloc</code> and <code class="code">free</code>. If there is an error during allocation it is handled by R, so if these return the memory has been successfully allocated or freed. <code class="code">R_Free</code> will set the pointer <var class="var">p</var> to <code class="code">NULL</code>.</p>
<p>Users should arrange to <code class="code">R_Free</code> this memory when no longer needed, including on error or user interrupt. This can often be done most conveniently from an <code class="code">on.exit</code> action in the calling R function – see <code class="code">pwilcox</code> for an example.</p>
<p>Do not assume that memory allocated by <code class="code">R_Calloc</code>/<code class="code">R_Realloc</code> comes from the same pool as used by <code class="code">malloc</code>:<a href="#FOOT167" id="DOCF167" class="footnote"><sup>167</sup></a> in particular do not use <code class="code">free</code> or <code class="code">strdup</code> with it.</p>
<p>Memory obtained by these macros should be aligned in the same way as <code class="code">malloc</code>, that is ‘suitably aligned for any kind of variable’.</p>
<p>Historically the macros <code class="code">Calloc</code>, <code class="code">Free</code> and <code class="code">Realloc</code> were used but have been removed in \R 4.5.0.</p>
<p><code class="code">R_Calloc</code>, <code class="code">R_Realloc</code>, and <code class="code">R_Free</code> are currently implemented as macros expanding to calls to <code class="code">R_chk_calloc</code>, <code class="code">R_chk_realloc</code>, and <code class="code">R_chk_free</code>, respectively. These should not be called directly as they may be removed in the future.</p>
<p><span id="index-CallocCharBuf" class="index-entry-id"></span> <span id="index-Memcpy" class="index-entry-id"></span> <span id="index-Memzero" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span> CallocCharBuf<span class="op">(</span><span class="dt">size_t</span> n<span class="op">)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span> Memcpy<span class="op">(</span>q<span class="op">,</span> p<span class="op">,</span> n<span class="op">)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span> Memzero<span class="op">(</span>p<span class="op">,</span> n<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code class="code">CallocCharBuf(n)</code> is shorthand for <code class="code">R_Calloc(n+1, char)</code> to allow for the <code class="code">nul</code> terminator. <code class="code">Memcpy</code> and <code class="code">Memzero</code> take <code class="code">n</code> items from array <code class="code">p</code> and copy them to array <code class="code">q</code> or zero them respectively.</p>
</section>
</section>
<section id="error-signaling" class="level2 section" data-number="6.2">
<h2 class="section anchored" data-number="6.2" data-anchor-id="error-signaling"><span class="header-section-number">6.2</span> Error signaling</h2>
<p>The basic error signaling routines are the equivalents of <code class="code">stop</code> and <code class="code">warning</code> in R code, and use the same interface.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rf_error<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rf_warning<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rf_errorcall<span class="op">(</span>SEXP call<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rf_warningcall<span class="op">(</span>SEXP call<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rf_warningcall_immediate<span class="op">(</span>SEXP call<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span id="index-Rf_005ferror" class="index-entry-id"></span> <span id="index-Rf_005ferror-1" class="index-entry-id"></span> <span id="index-Rf_005fwarning" class="index-entry-id"></span> <span id="index-Rf_005fwarning-1" class="index-entry-id"></span> <span id="index-Rf_005ferrorcall" class="index-entry-id"></span> <span id="index-Rf_005ferrorcall-1" class="index-entry-id"></span></p>
<p>These have the same call sequences as calls to <code class="code">printf</code>, but in the simplest case can be called with a single character string argument giving the error message. (Don’t do this if the string contains <samp class="samp">%</samp>’ or might otherwise be interpreted as a format.)</p>
<p>These are defined in header <samp class="file">R_ext/Error.h</samp> included by <samp class="file">R.h</samp>. <strong>NB</strong>: when <code class="code">R_NO_REMAP</code> is defined (as is done for C++ code), <code class="code">Rf_error</code> etc must be used.</p>
<p>Header <samp class="file">R_ext/Error.h</samp> defines a macro <code class="code">NORET</code> intended to be used only from C code (C++ code can use the <code class="code">[[noreturn]]</code> attribute). This covers various ways to signal to the compiler that the function never returns. Because the usages of those ways differ by C standard, it should always be used at the beginning of a function declaration, including before <code class="code">static</code> and attributes such as <code class="code">attribute_hidden</code>.</p>
<section id="error-signaling-from-fortran" class="level3 subsection" data-number="6.2.1">
<h3 class="subsection anchored" data-number="6.2.1" data-anchor-id="error-signaling-from-fortran"><span class="header-section-number">6.2.1</span> Error signaling from Fortran</h3>
<p>There are two interface function provided to call <code class="code">Rf_error</code> and <code class="code">Rf_warning</code> from Fortran code, in each case with a simple character string argument. They are defined as</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>subroutine <span class="fu">rexit</span>(message)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>subroutine <span class="fu">rwarn</span>(message)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Messages of more than 255 characters are truncated, with a warning.</p>
</section>
</section>
<section id="random-number-generation" class="level2 section" data-number="6.3">
<h2 class="section anchored" data-number="6.3" data-anchor-id="random-number-generation"><span class="header-section-number">6.3</span> Random number generation</h2>
<p><span id="index-Random-numbers-in-C" class="index-entry-id"></span> <span id="index-unif_005frand" class="index-entry-id"></span> <span id="index-unif_005frand-1" class="index-entry-id"></span> <span id="index-norm_005frand" class="index-entry-id"></span> <span id="index-norm_005frand-1" class="index-entry-id"></span> <span id="index-exp_005frand" class="index-entry-id"></span> <span id="index-exp_005frand-1" class="index-entry-id"></span> <span id="index-R_005funif_005findex" class="index-entry-id"></span> <span id="index-R_005funif_005findex-1" class="index-entry-id"></span> <span id="index-GetRNGstate" class="index-entry-id"></span> <span id="index-GetRNGstate-1" class="index-entry-id"></span> <span id="index-PutRNGstate" class="index-entry-id"></span> <span id="index-PutRNGstate-1" class="index-entry-id"></span> <span id="index-_002eRandom_002eseed" class="index-entry-id"></span></p>
<p>The interface to R’s internal random number generation routines is</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> unif_rand<span class="op">();</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> norm_rand<span class="op">();</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> exp_rand<span class="op">();</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> R_unif_index<span class="op">(</span><span class="dt">double</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>giving one uniform, normal or exponential pseudo-random variate. However, before these are used, the user must call</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>GetRNGstate<span class="op">();</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and after all the required variates have been generated, call</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>PutRNGstate<span class="op">();</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These essentially read in (or create) <code class="code">.Random.seed</code> and write it out after use.</p>
<p>These are defined in header <samp class="file">R_ext/Random.h</samp>. These functions are never remapped.</p>
<p>The random number generator is private to R; there is no way to select the kind of RNG nor set the seed except by evaluating calls to the R functions which do so.</p>
<p>The C code behind R’s <code class="code">r</code><var class="var">xxx</var> functions can be accessed by including the header file <samp class="file">Rmath.h</samp>; See <a href="#distribution-functions" class="xref">Distribution functions</a>. Those calls should also be preceded and followed by calls to <code class="code">GetRNGstate</code> and <code class="code">PutRNGstate</code>.</p>
<section id="random-number-generation-from-fortran" class="level3 subsection" data-number="6.3.1">
<h3 class="subsection anchored" data-number="6.3.1" data-anchor-id="random-number-generation-from-fortran"><span class="header-section-number">6.3.1</span> Random-number generation from Fortran</h3>
<p>It was explained earlier that Fortran random-number generators should not be used in R packages, not least as packages cannot safely initialize them. Rather a package should call R’s built-in generators: one way to do so is to use C wrappers like</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/RS.h&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Random.h&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_SUB<span class="op">(</span>getRNGseed<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    GetRNGstate<span class="op">();</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_SUB<span class="op">(</span>putRNGseed<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    PutRNGstate<span class="op">();</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> F77_SUB<span class="op">(</span>unifRand<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">(</span>unif_rand<span class="op">());</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>called from Fortran code like</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> precision X</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>      call getRNGseed<span class="op">()</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>      X <span class="op">=</span> unifRand<span class="op">()</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>      call putRNGseed<span class="op">()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Alternatively one could use Fortran 2003’s <code class="code">iso_c_binding</code> module by something like (fixed-form Fortran 90 code):</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>      module rngfuncs</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>        use iso_c_binding</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        interface</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>          <span class="dt">double</span> precision</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">*</span>      function unifRand<span class="op">()</span> bind<span class="op">(</span>C<span class="op">,</span> name <span class="op">=</span> <span class="st">"unif_rand"</span><span class="op">)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>          end function unifRand</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>          subroutine getRNGseed<span class="op">()</span> bind<span class="op">(</span>C<span class="op">,</span> name <span class="op">=</span> <span class="st">"GetRNGstate"</span><span class="op">)</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>          end subroutine getRNGseed</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>          subroutine putRNGseed<span class="op">()</span> bind<span class="op">(</span>C<span class="op">,</span> name <span class="op">=</span> <span class="st">"PutRNGstate"</span><span class="op">)</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>          end subroutine putRNGseed</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        end interface</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>      end module rngfuncs</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>      subroutine testit</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>      use rngfuncs</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> precision X</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>      call getRNGseed<span class="op">()</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>      X <span class="op">=</span> unifRand<span class="op">()</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>      print <span class="op">*,</span> X</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>      call putRNGSeed<span class="op">()</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>      end subroutine testit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="missing-and-ieee-special-values" class="level2 section" data-number="6.4">
<h2 class="section anchored" data-number="6.4" data-anchor-id="missing-and-ieee-special-values"><span class="header-section-number">6.4</span> Missing and IEEE special values</h2>
<p><span id="index-IEEE-special-values-1" class="index-entry-id"></span> <span id="index-ISNA-1" class="index-entry-id"></span> <span id="index-ISNA-3" class="index-entry-id"></span> <span id="index-ISNAN-1" class="index-entry-id"></span> <span id="index-ISNAN-3" class="index-entry-id"></span> <span id="index-R_005fFINITE" class="index-entry-id"></span> <span id="index-R_005fFINITE-1" class="index-entry-id"></span> <span id="index-R_005fIsNaN" class="index-entry-id"></span> <span id="index-R_005fIsNaN-1" class="index-entry-id"></span> <span id="index-R_005fPosInf" class="index-entry-id"></span> <span id="index-R_005fPosInf-1" class="index-entry-id"></span> <span id="index-R_005fNegInf" class="index-entry-id"></span> <span id="index-R_005fNegInf-1" class="index-entry-id"></span> <span id="index-NA_005fREAL-1" class="index-entry-id"></span></p>
<p>A set of functions is provided to test for <code class="code">NA</code>, <code class="code">Inf</code>, <code class="code">-Inf</code> and <code class="code">NaN</code>. These functions are accessed <em>via</em> macros:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ISNA<span class="op">(</span>x<span class="op">)</span>        True <span class="cf">for</span> R’s NA only</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>ISNAN<span class="op">(</span>x<span class="op">)</span>       True <span class="cf">for</span> R’s NA and IEEE NaN</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>R_FINITE<span class="op">(</span>x<span class="op">)</span>    False <span class="cf">for</span> Inf<span class="op">,</span> <span class="op">-</span>Inf<span class="op">,</span> NA<span class="op">,</span> NaN</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and <em>via</em> function <code class="code">R_IsNaN</code> which is true for <code class="code">NaN</code> but not <code class="code">NA</code>.</p>
<p>Do use <code class="code">R_FINITE</code> rather than <code class="code">isfinite</code> or <code class="code">finite</code>; the latter is often mendacious and <code class="code">isfinite</code> is only available on a some platforms, on which <code class="code">R_FINITE</code> is a macro expanding to <code class="code">isfinite</code>.</p>
<p>Currently in C code <code class="code">ISNAN</code> is a macro calling <code class="code">isnan</code>. (Since this gives problems on some C++ systems, if the R headers are called from C++ code a function call is used.)</p>
<p>You can check for <code class="code">Inf</code> or <code class="code">-Inf</code> by testing equality to <code class="code">R_PosInf</code> or <code class="code">R_NegInf</code>, and set (but not test) an <code class="code">NA</code> as <code class="code">NA_REAL</code>.</p>
<p>All of the above apply to <em>double</em> variables only. For integer variables there is a variable accessed by the macro <code class="code">NA_INTEGER</code> which can used to set or test for missingness.</p>
<p>These are defined in header <samp class="file">R_ext/Arith.h</samp> included by <samp class="file">R.h</samp>.</p>
</section>
<section id="printing" class="level2 section" data-number="6.5">
<h2 class="section anchored" data-number="6.5" data-anchor-id="printing"><span class="header-section-number">6.5</span> Printing</h2>
<p><span id="index-Printing-from-C" class="index-entry-id"></span> <span id="index-Rprintf" class="index-entry-id"></span> <span id="index-Rprintf-1" class="index-entry-id"></span> <span id="index-REprintf" class="index-entry-id"></span> <span id="index-REprintf-1" class="index-entry-id"></span> <span id="index-Rvprintf" class="index-entry-id"></span> <span id="index-Rvprintf-1" class="index-entry-id"></span> <span id="index-REvprintf" class="index-entry-id"></span></p>
<p>The most useful function for printing from a C routine compiled into R is <code class="code">Rprintf</code>. This is used in exactly the same way as <code class="code">printf</code>, but is guaranteed to write to R’s output (which might be a GUI console rather than a file, and can be re-directed by <code class="code">sink</code>). It is wise to write complete lines (including the <code class="code">"\n"</code>) before returning to R. It is defined in <samp class="file">R_ext/Print.h</samp>.</p>
<p>The function <code class="code">REprintf</code> is similar but writes on the error stream (<code class="code">stderr</code>) which may or may not be different from the standard output stream.</p>
<p>Functions <code class="code">Rvprintf</code> and <code class="code">REvprintf</code> are analogues using the <code class="code">vprintf</code> interface. Because that is a C99<a href="#FOOT168" id="DOCF168" class="footnote"><sup>168</sup></a> interface, they are only defined by <samp class="file">R_ext/Print.h</samp> in C++ code if the macro <code class="code">R_USE_C99_IN_CXX</code> is defined before it is included or (as from R 4.0.0) a C++11 compiler is used.</p>
<p>Another circumstance when it may be important to use these functions is when using parallel computation on a cluster of computational nodes, as their output will be re-directed/logged appropriately.</p>
<section id="printing-from-fortran" class="level3 subsection" data-number="6.5.1">
<h3 class="subsection anchored" data-number="6.5.1" data-anchor-id="printing-from-fortran"><span class="header-section-number">6.5.1</span> Printing from Fortran</h3>
<p>On many systems Fortran <code class="code">write</code> and <code class="code">print</code> statements can be used, but the output may not interleave well with that of C, and may be invisible on GUI interfaces. They are not portable and best avoided.</p>
<p>Some subroutines are provided to ease the output of information from Fortran code.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>subroutine dblepr<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> data<span class="op">,</span> ndata<span class="op">)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>subroutine realpr<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> data<span class="op">,</span> ndata<span class="op">)</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>subroutine intpr <span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> data<span class="op">,</span> ndata<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and from R&nbsp;4.0.0, <span id="index-labelpr-1" class="index-entry-id"></span> <span id="index-labelpr" class="index-entry-id"></span> <span id="index-dblepr1-1" class="index-entry-id"></span> <span id="index-dblepr1" class="index-entry-id"></span> <span id="index-realpr1-1" class="index-entry-id"></span> <span id="index-realpr1" class="index-entry-id"></span> <span id="index-intpr1-1" class="index-entry-id"></span> <span id="index-intpr1" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>subroutine labelpr<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>subroutine dblepr1<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> var<span class="op">)</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>subroutine realpr1<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> var<span class="op">)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>subroutine intpr1 <span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> var<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here <var class="var">label</var> is a character label of up to 255 characters, <var class="var">nchar</var> is its length (which can be <code class="code">-1</code> if the whole label is to be used), <var class="var">data</var> is an array of length at least <var class="var">ndata</var> of the appropriate type (<code class="code">double precision</code>, <code class="code">real</code> and <code class="code">integer</code> respectively) and <var class="var">var</var> is a (scalar) variable. These routines print the label on one line and then print <var class="var">data</var> or <var class="var">var</var> as if it were an R vector on subsequent line(s). Note that some compilers will give an error or warning unless <var class="var">data</var> is an array: others will accept a scalar when <var class="var">ndata</var> has value one or zero. <strong>NB:</strong> There is no check on the type of <var class="var">data</var> or <var class="var">var</var>, so using <code class="code">real</code> (including a real constant) instead of <code class="code">double precision</code> will give incorrect answers.</p>
<p><code class="code">intpr</code> works with zero <var class="var">ndata</var> so can be used to print a label in earlier versions of R.</p>
</section>
</section>
<section id="calling-c-from-fortran-and-vice-versa" class="level2 section" data-number="6.6">
<h2 class="section anchored" data-number="6.6" data-anchor-id="calling-c-from-fortran-and-vice-versa"><span class="header-section-number">6.6</span> Calling C from Fortran and vice versa</h2>
<p>Naming conventions for symbols generated by Fortran differ by platform: it is not safe to assume that Fortran names appear to C with a trailing underscore. To help cover up the platform-specific differences there is a set of macros<a href="#FOOT169" id="DOCF169" class="footnote"><sup>169</sup></a> that should be used.</p>
<dl>
<dt><code class="code">F77_SUB(</code><var class="var">name</var><code class="code">)</code></dt>
<dd>
<p>to define a function in C to be called from Fortran</p>
</dd>
<dt><code class="code">F77_NAME(</code><var class="var">name</var><code class="code">)</code></dt>
<dd>
<p>to declare a Fortran routine in C before use</p>
</dd>
<dt><code class="code">F77_CALL(</code><var class="var">name</var><code class="code">)</code></dt>
<dd>
<p>to call a Fortran routine from C</p>
</dd>
</dl>
<p>On current platforms these are the same, but it is unwise to rely on this. Note that names containing underscores were not legal in Fortran 77, and are not portably handled by the above macros. (Also, all Fortran names for use by R are lower case, but this is not enforced by the macros.)</p>
<p>For example, suppose we want to call R’s normal random numbers from Fortran. We need a C wrapper along the lines of</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_SUB<span class="op">(</span>rndstart<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> GetRNGstate<span class="op">();</span> <span class="op">}</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_SUB<span class="op">(</span>rndend<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> PutRNGstate<span class="op">();</span> <span class="op">}</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> F77_SUB<span class="op">(</span>normrnd<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> norm_rand<span class="op">();</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to be called from Fortran as in</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>      subroutine testit<span class="op">()</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> precision normrnd<span class="op">,</span> x</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>      call rndstart<span class="op">()</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>      x <span class="op">=</span> normrnd<span class="op">()</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>      call dblepr<span class="op">(</span><span class="st">"X was"</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> x<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>      call rndend<span class="op">()</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>      end</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that this is not guaranteed to be portable, for the return conventions might not be compatible between the C and Fortran compilers used. (Passing values <em>via</em> arguments is safer.)</p>
<p>The standard packages, for example <strong>stats</strong>, are a rich source of further examples.</p>
<p>Where supported, <em>link time optimization</em> provides a reliable way to check the consistency of calls to C from Fortran or <em>vice versa</em>. See <a href="Debugging.html#using-link-time-optimization" class="xref">Using Link-time Optimization</a>. One place where this occurs is the registration of <code class="code">.Fortran</code> calls in C code (see <a href="System-and-foreign-language-interfaces.html#registering-native-routines" class="pxref">Registering native routines</a>). For example</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>init<span class="op">.</span>c<span class="op">:</span><span class="dv">10</span><span class="op">:</span><span class="dv">13</span><span class="op">:</span> warning<span class="op">:</span> type of <span class="ch">'v</span><span class="er">som_</span><span class="ch">'</span> does not match original</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a> declaration <span class="op">[-</span>Wlto<span class="op">-</span>type<span class="op">-</span>mismatch<span class="op">]</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">extern</span> <span class="dt">void</span> F77_NAME<span class="op">(</span>vsom<span class="op">)(</span><span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*);</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>vsom<span class="op">.</span>f90<span class="op">:</span><span class="dv">20</span><span class="op">:</span><span class="dv">33</span><span class="op">:</span> note<span class="op">:</span> type mismatch in parameter <span class="dv">9</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>   subroutine vsom<span class="op">(</span>neurons<span class="op">,</span>dt<span class="op">,</span>dtrows<span class="op">,</span>dtcols<span class="op">,</span>xdim<span class="op">,</span>ydim<span class="op">,</span>alpha<span class="op">,</span>train<span class="op">)</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>vsom<span class="op">.</span>f90<span class="op">:</span><span class="dv">20</span><span class="op">:</span><span class="dv">33</span><span class="op">:</span> note<span class="op">:</span> <span class="ch">'v</span><span class="er">som</span><span class="ch">'</span> was previously declared here</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>shows that a subroutine has been registered with 9 arguments (as that is what the <code class="code">.Fortran</code> call used) but only has 8.</p>
<section id="fortran-character-strings" class="level3 subsection" data-number="6.6.1">
<h3 class="subsection anchored" data-number="6.6.1" data-anchor-id="fortran-character-strings"><span class="header-section-number">6.6.1</span> Fortran character strings</h3>
<p>Passing character strings from C to Fortran or <em>vice versa</em> is not portable, but can be done with care. The internal representations are different: a character array in C (or C++) is NUL-terminated so its length can be computed by <code class="code">strlen</code>. Fortran character arrays are typically stored as an array of bytes and a length. This matters when passing strings from C to Fortran or <em>vice versa</em>: in many cases one has been able to get away with passing the string but not the length. However, in 2019 this changed for <code class="command">gfortran</code>, starting with version 9 but backported to versions 7 and 8. Several months later, <code class="command">gfortran</code> 9.2 introduced an option</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span>ftail<span class="sc">-</span>call<span class="sc">-</span>workaround</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and made it the current default but said it might be withdrawn in future.</p>
<p>Suppose we want a function to report a message from Fortran to R’s console (one could use <code class="code">labelpr</code>, or <code class="code">intpr</code> with dummy data, but this might be the basis of a custom reporting function). Suppose the equivalent in Fortran would be</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>      subroutine rmsg<span class="op">(</span>msg<span class="op">)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>      character<span class="op">*(*)</span> msg</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>      print <span class="op">*.</span>msg</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>      end</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in file <samp class="file">rmsg.f</samp>. Using <code class="command">gfortran</code> 9.2 and later we can extract the C view by</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>gfortran <span class="sc">-</span>c <span class="sc">-</span>fc<span class="sc">-</span>prototypes<span class="sc">-</span>external rmsg.f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which gives</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> rmsg_ <span class="op">(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">,</span> <span class="dt">size_t</span> msg_len<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(where <code class="code">size_t</code> applies to version 8 and later). We could re-write that portably in C as</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef USE_FC_LEN_T</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="pp"># define USE_FC_LEN_T</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rconfig.h&gt;</span><span class="pp"> </span><span class="co">// included by R.h, so define USE_FC_LEN_T early</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>rmsg<span class="op">)(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">,</span> FC_LEN_T msg_len<span class="op">)</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> cmsg<span class="op">[</span>msg_len<span class="op">+</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    strncpy<span class="op">(</span>cmsg<span class="op">,</span> msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    cmsg<span class="op">[</span>msg_len<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span> <span class="co">// nul-terminate the string, to be sure</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// do something with 'cmsg'</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in code depending on <code class="code">R(&gt;= 3.6.2)</code>. For earlier versions of R we could just assume that <code class="code">msg</code> is NUL-terminated (not guaranteed, but people have been getting away with it for many years), so the complete C side might be</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef USE_FC_LEN_T</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="pp"># define USE_FC_LEN_T</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rconfig.h&gt;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef FC_LEN_T</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>rmsg<span class="op">)(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">,</span> FC_LEN_T msg_len<span class="op">)</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> cmsg<span class="op">[</span>msg_len<span class="op">+</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    strncpy<span class="op">(</span>cmsg<span class="op">,</span> msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    cmsg<span class="op">[</span>msg_len<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// do something with 'cmsg'</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>rmsg<span class="op">)(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">)</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// do something with 'msg'</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(<code class="code">USE_FC_LEN_T</code> is the default as from R 4.3.0.)</p>
<p>An alternative is to use Fortran 2003 features to set up the Fortran routine to pass a C-compatible character string. We could use something like</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>      module cfuncs</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>        use iso_c_binding<span class="op">,</span> only<span class="op">:</span> c_char<span class="op">,</span> c_null_char</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>        interface</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>          subroutine cmsg<span class="op">(</span>msg<span class="op">)</span> bind<span class="op">(</span>C<span class="op">,</span> name <span class="op">=</span> <span class="ch">'c</span><span class="er">msg</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>            use iso_c_binding<span class="op">,</span> only<span class="op">:</span> c_char</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>            character<span class="op">(</span>kind <span class="op">=</span> c_char<span class="op">)::</span> msg<span class="op">(*)</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>          end subroutine cmsg</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        end interface</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>      end module</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>      subroutine rmsg<span class="op">(</span>msg<span class="op">)</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        use cfuncs</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        character<span class="op">(*)</span> msg</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        call cmsg<span class="op">(</span>msg<span class="co">//c_null_char) ! need to concatenate a nul terminator</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>      end subroutine rmsg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the C side is simply</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cmsg<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>msg<span class="op">)</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// do something with nul-terminated string 'msg'</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you use <code class="code">bind</code> to a C function as here, the only way to check that the bound definition is correct is to compile the package with LTO (which requires compatible C and Fortran compilers, usually <code class="command">gcc</code> and <code class="command">gfortran</code>).</p>
<p>Passing a variable-length string from C to Fortran is trickier, but <a href="https://www.intel.com/content/www/us/en/docs/fortran-compiler/developer-guide-reference/2023-0/bind-c.html" class="uref">https://www.intel.com/content/www/us/en/docs/fortran-compiler/developer-guide-reference/2023-0/bind-c.html</a> provides a recipe. However, all the uses in BLAS and LAPACK are of a single character, and for these we can write a wrapper in Fortran along the lines of</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>      subroutine c_dgemm<span class="op">(</span>transa<span class="op">,</span> transb<span class="op">,</span> m<span class="op">,</span> n<span class="op">,</span> k<span class="op">,</span> alpha<span class="op">,</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">+</span>     a<span class="op">,</span> lda<span class="op">,</span> b<span class="op">,</span> ldb<span class="op">,</span> beta<span class="op">,</span> c<span class="op">,</span> ldc<span class="op">)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">+</span>     bind<span class="op">(</span>C<span class="op">,</span> name <span class="op">=</span> <span class="ch">'C</span><span class="er">dgemm</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        use iso_c_binding<span class="op">,</span> only <span class="op">:</span> c_char<span class="op">,</span> c_int<span class="op">,</span> c_double</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        character<span class="op">(</span>c_char<span class="op">),</span> intent<span class="op">(</span>in<span class="op">)</span> <span class="op">::</span> transa<span class="op">,</span> transb</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        integer<span class="op">(</span>c_int<span class="op">),</span> intent<span class="op">(</span>in<span class="op">)</span> <span class="op">::</span> m<span class="op">,</span> n<span class="op">,</span> k<span class="op">,</span> lda<span class="op">,</span> ldb<span class="op">,</span> ldc</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        real<span class="op">(</span>c_double<span class="op">),</span> intent<span class="op">(</span>in<span class="op">)</span> <span class="op">::</span> alpha<span class="op">,</span> beta<span class="op">,</span> a<span class="op">(</span>lda<span class="op">,</span> <span class="op">*),</span> b<span class="op">(</span>ldb<span class="op">,</span> <span class="op">*)</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>        real<span class="op">(</span>c_double<span class="op">),</span> intent<span class="op">(</span>out<span class="op">)</span> <span class="op">::</span>  c<span class="op">(</span>ldc<span class="op">,</span> <span class="op">*)</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        call dgemm<span class="op">(</span>transa<span class="op">,</span> transb<span class="op">,</span> m<span class="op">,</span> n<span class="op">,</span> k<span class="op">,</span> alpha<span class="op">,</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>     <span class="op">+</span>             a<span class="op">,</span> lda<span class="op">,</span> b<span class="op">,</span> ldb<span class="op">,</span> beta<span class="op">,</span> c<span class="op">,</span> ldc<span class="op">)</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>      end subroutine c_dgemm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which is then called from C with declaration</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>Cdgemm<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>transa<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>transb<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>m<span class="op">,</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>       <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>k<span class="op">,</span> <span class="dt">const</span> <span class="dt">double</span> <span class="op">*</span>alpha<span class="op">,</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>       <span class="dt">const</span> <span class="dt">double</span> <span class="op">*</span>a<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>lda<span class="op">,</span> <span class="dt">const</span> <span class="dt">double</span> <span class="op">*</span>b<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>ldb<span class="op">,</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>       <span class="dt">const</span> <span class="dt">double</span> <span class="op">*</span>beta<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>c<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>ldc<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Alternatively, do as R does and pass the character length(s) from C to Fortran. A portable way to do this is</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">// before any R headers, or define in PKG_CPPFLAGS</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef  USE_FC_LEN_T</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="pp"># define USE_FC_LEN_T</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rconfig.h&gt;</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/BLAS.h&gt;</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef FCONE</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="pp"># define FCONE</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        F77_CALL<span class="op">(</span>dgemm<span class="op">)(</span><span class="st">"N"</span><span class="op">,</span> <span class="st">"T"</span><span class="op">,</span> <span class="op">&amp;</span>nrx<span class="op">,</span> <span class="op">&amp;</span>ncy<span class="op">,</span> <span class="op">&amp;</span>ncx<span class="op">,</span> <span class="op">&amp;</span>one<span class="op">,</span> x<span class="op">,</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>                        <span class="op">&amp;</span>nrx<span class="op">,</span> y<span class="op">,</span> <span class="op">&amp;</span>nry<span class="op">,</span> <span class="op">&amp;</span>zero<span class="op">,</span> z<span class="op">,</span> <span class="op">&amp;</span>nrx FCONE FCONE<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(Note there is no comma before or between the <code class="code">FCONE</code> invocations.) Packages which call from C/C++ BLAS/LAPACK routines with character arguments must adopt this approach: packages not using it will now fail to install.</p>
</section>
<section id="fortran-logical" class="level3 subsection" data-number="6.6.2">
<h3 class="subsection anchored" data-number="6.6.2" data-anchor-id="fortran-logical"><span class="header-section-number">6.6.2</span> Fortran LOGICAL</h3>
<p>Passing Fortran LOGICAL variables to/from C/C++ is potentially compiler-dependent. Fortran compilers have long used a 32-bit integer type so it is pretty portable to use <code class="code">int *</code> on the C/C++ side. However, recent versions of <code class="command">gfortran</code> <em>via</em> the option <samp class="option">-fc-prototypes-external</samp> say the C equivalent is <code class="code">int_least32_t *</code>: ‘Link-Time Optimization’ will report <code class="code">int *</code> as a mismatch. It is possible to use <code class="code">iso_c_binding</code> in Fortran 2003 to map LOGICAL variables to the C99 type <code class="code">_Bool</code>, but it is usually simpler to pass integers.</p>
</section>
<section id="passing-functions" class="level3 subsection" data-number="6.6.3">
<h3 class="subsection anchored" data-number="6.6.3" data-anchor-id="passing-functions"><span class="header-section-number">6.6.3</span> Passing functions</h3>
<p>A number of packages call C functions passed as arguments to Fortran code along the lines of</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>c         subroutine fcn<span class="op">(</span>m<span class="op">,</span>n<span class="op">,</span>x<span class="op">,</span>fvec<span class="op">,</span>iflag<span class="op">)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>c         integer m<span class="op">,</span>n<span class="op">,</span>iflag</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>c         <span class="dt">double</span> precision x<span class="op">(</span>n<span class="op">),</span>fvec<span class="op">(</span>m<span class="op">)</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>      subroutine lmdif<span class="op">(</span>fcn<span class="op">,</span> <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the C declaration and call are</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> fcn_lmdif<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>m<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>par<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>fvec<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>iflag<span class="op">);</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>lmdif<span class="op">)(</span><span class="dt">void</span> <span class="op">(*</span>fcn_lmdif<span class="op">)(</span><span class="dt">int</span> <span class="op">*</span>m<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>par<span class="op">,</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="dt">double</span> <span class="op">*</span>fvec<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>iflag<span class="op">),</span> <span class="op">...</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>F77_CALL<span class="op">(</span>lmdif<span class="op">)(&amp;</span>fcn_lmdif<span class="op">,</span> <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This works on most platforms but depends on the C and Fortran compilers agreeing on calling conventions: this have been seen to fail. The most portable solution seems to be to convert the Fortran code to C, perhaps using <code class="command">f2c</code>.</p>
</section>
</section>
<section id="numerical-analysis-subroutines" class="level2 section" data-number="6.7">
<h2 class="section anchored" data-number="6.7" data-anchor-id="numerical-analysis-subroutines"><span class="header-section-number">6.7</span> Numerical analysis subroutines</h2>
<p>R contains a large number of mathematical functions for its own use, for example numerical linear algebra computations and special functions.</p>
<p>The header files <samp class="file">R_ext/BLAS.h</samp>, <samp class="file">R_ext/Lapack.h</samp> and <samp class="file">R_ext/Linpack.h</samp> contain declarations of the BLAS, LAPACK and LINPACK linear algebra functions included in R. These are expressed as calls to Fortran subroutines, and they will also be usable from users’ Fortran code. Although not part of the official API, this set of subroutines is unlikely to change (but might be supplemented).</p>
<p>The header file <samp class="file">Rmath.h</samp> lists many other functions that are available and documented in the following subsections. Many of these are C interfaces to the code behind R functions, so the R function documentation may give further details. <span id="index-Rmath_002eh" class="index-entry-id"></span></p>
<p>If <code class="code">R_NO_REMAP_RMATH</code> most of these will need to be prefixed by <code class="code">Rf_</code>: see the header file for which ones.</p>
<section id="distribution-functions" class="level3 subsection" data-number="6.7.1">
<h3 class="subsection anchored" data-number="6.7.1" data-anchor-id="distribution-functions"><span class="header-section-number">6.7.1</span> Distribution functions</h3>
<p>The routines used to calculate densities, cumulative distribution functions and quantile functions for the standard statistical distributions are available as entry points.</p>
<p>The arguments for the entry points follow the pattern of those for the normal distribution:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> dnorm<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> mu<span class="op">,</span> <span class="dt">double</span> sigma<span class="op">,</span> <span class="dt">int</span> give_log<span class="op">);</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> pnorm<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> mu<span class="op">,</span> <span class="dt">double</span> sigma<span class="op">,</span> <span class="dt">int</span> lower_tail<span class="op">,</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>             <span class="dt">int</span> give_log<span class="op">);</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> qnorm<span class="op">(</span><span class="dt">double</span> p<span class="op">,</span> <span class="dt">double</span> mu<span class="op">,</span> <span class="dt">double</span> sigma<span class="op">,</span> <span class="dt">int</span> lower_tail<span class="op">,</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>             <span class="dt">int</span> log_p<span class="op">);</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> rnorm<span class="op">(</span><span class="dt">double</span> mu<span class="op">,</span> <span class="dt">double</span> sigma<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That is, the first argument gives the position for the density and CDF and probability for the quantile function, followed by the distribution’s parameters. Argument <var class="var">lower_tail</var> should be <code class="code">TRUE</code> (or <code class="code">1</code>) for normal use, but can be <code class="code">FALSE</code> (or <code class="code">0</code>) if the probability of the upper tail is desired or specified.</p>
<p>Finally, <var class="var">give_log</var> should be non-zero if the result is required on log scale, and <var class="var">log_p</var> should be non-zero if <var class="var">p</var> has been specified on log scale.</p>
<p>Note that you directly get the cumulative (or “integrated”) <em>hazard</em> function, H(t) = - log(1 - F(t)), by using</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> <span class="fu">pdist</span>(t, ..., <span class="sc">/</span><span class="er">*</span><span class="at">lower_tail =</span> <span class="sc">*</span><span class="er">/</span> <span class="cn">FALSE</span>, <span class="sc">/</span><span class="er">*</span> <span class="at">give_log =</span> <span class="sc">*</span><span class="er">/</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or shorter (and more cryptic) <code class="code">- p</code><var class="var">dist</var><code class="code">(t, ..., 0, 1)</code>. <span id="index-cumulative-hazard" class="index-entry-id"></span></p>
<p>The random-variate generation routine <code class="code">rnorm</code> returns one normal variate. See <a href="#random-numbers" class="xref">Random number generation</a>, for the protocol in using the random-variate routines.</p>
<p>Note that these argument sequences are (apart from the names and that <code class="code">rnorm</code> has no <var class="var">n</var>) mainly the same as the corresponding R functions of the same name, so the documentation of the R functions can be used. Note that the exponential and gamma distributions are parametrized by <code class="code">scale</code> rather than <code class="code">rate</code>.</p>
<p>For reference, the following table gives the basic name (to be prefixed by <samp class="samp">d</samp>‘, <samp class="samp">p</samp>’, <samp class="samp">q</samp>’ or <samp class="samp">r</samp>’ apart from the exceptions noted) and distribution-specific arguments for the complete set of distributions.</p>
<blockquote class="blockquote">
<table class="caption-top table">
<tbody>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: left;"><code class="code">beta</code></td>
<td style="text-align: left;"><code class="code">a</code>, <code class="code">b</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">non-central beta</td>
<td style="text-align: left;"><code class="code">nbeta</code></td>
<td style="text-align: left;"><code class="code">a</code>, <code class="code">b</code>, <code class="code">ncp</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">binomial</td>
<td style="text-align: left;"><code class="code">binom</code></td>
<td style="text-align: left;"><code class="code">n</code>, <code class="code">p</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Cauchy</td>
<td style="text-align: left;"><code class="code">cauchy</code></td>
<td style="text-align: left;"><code class="code">location</code>, <code class="code">scale</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">chi-squared</td>
<td style="text-align: left;"><code class="code">chisq</code></td>
<td style="text-align: left;"><code class="code">df</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">non-central chi-squared</td>
<td style="text-align: left;"><code class="code">nchisq</code></td>
<td style="text-align: left;"><code class="code">df</code>, <code class="code">ncp</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">exponential</td>
<td style="text-align: left;"><code class="code">exp</code></td>
<td style="text-align: left;"><code class="code">scale</code> (and <strong>not</strong> <code class="code">rate</code>)</td>
</tr>
<tr class="even">
<td style="text-align: left;">F</td>
<td style="text-align: left;"><code class="code">f</code></td>
<td style="text-align: left;"><code class="code">n1</code>, <code class="code">n2</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">non-central F</td>
<td style="text-align: left;"><code class="code">nf</code></td>
<td style="text-align: left;"><code class="code">n1</code>, <code class="code">n2</code>, <code class="code">ncp</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: left;"><code class="code">gamma</code></td>
<td style="text-align: left;"><code class="code">shape</code>, <code class="code">scale</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">geometric</td>
<td style="text-align: left;"><code class="code">geom</code></td>
<td style="text-align: left;"><code class="code">p</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">hypergeometric</td>
<td style="text-align: left;"><code class="code">hyper</code></td>
<td style="text-align: left;"><code class="code">NR</code>, <code class="code">NB</code>, <code class="code">n</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">logistic</td>
<td style="text-align: left;"><code class="code">logis</code></td>
<td style="text-align: left;"><code class="code">location</code>, <code class="code">scale</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">lognormal</td>
<td style="text-align: left;"><code class="code">lnorm</code></td>
<td style="text-align: left;"><code class="code">logmean</code>, <code class="code">logsd</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">negative binomial</td>
<td style="text-align: left;"><code class="code">nbinom</code></td>
<td style="text-align: left;"><code class="code">size</code>, <code class="code">prob</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">normal</td>
<td style="text-align: left;"><code class="code">norm</code></td>
<td style="text-align: left;"><code class="code">mu</code>, <code class="code">sigma</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Poisson</td>
<td style="text-align: left;"><code class="code">pois</code></td>
<td style="text-align: left;"><code class="code">lambda</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Student’s t</td>
<td style="text-align: left;"><code class="code">t</code></td>
<td style="text-align: left;"><code class="code">n</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">non-central t</td>
<td style="text-align: left;"><code class="code">nt</code></td>
<td style="text-align: left;"><code class="code">df</code>, <code class="code">delta</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Studentized range</td>
<td style="text-align: left;"><code class="code">tukey</code> (*)</td>
<td style="text-align: left;"><code class="code">rr</code>, <code class="code">cc</code>, <code class="code">df</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">uniform</td>
<td style="text-align: left;"><code class="code">unif</code></td>
<td style="text-align: left;"><code class="code">a</code>, <code class="code">b</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Weibull</td>
<td style="text-align: left;"><code class="code">weibull</code></td>
<td style="text-align: left;"><code class="code">shape</code>, <code class="code">scale</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wilcoxon rank sum</td>
<td style="text-align: left;"><code class="code">wilcox</code></td>
<td style="text-align: left;"><code class="code">m</code>, <code class="code">n</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Wilcoxon signed rank</td>
<td style="text-align: left;"><code class="code">signrank</code></td>
<td style="text-align: left;"><code class="code">n</code></td>
</tr>
</tbody>
</table>
</blockquote>
<p>Entries marked with an asterisk only have <samp class="samp">p</samp>’ and <samp class="samp">q</samp>’ functions available, and none of the non-central distributions have <samp class="samp">r</samp>’ functions.</p>
<p>(If remapping is suppressed, the Normal distribution names are <code class="code">Rf_dnorm4</code>, <code class="code">Rf_pnorm5</code> and <code class="code">Rf_qnorm5</code>.)</p>
<p>Additionally, a <em>multivariate</em> RNG for the multinomial distribution is</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rf_rmultinom<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span><span class="op">*</span> prob<span class="op">,</span> <span class="dt">int</span> K<span class="op">,</span> <span class="dt">int</span><span class="op">*</span> rN<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code class="code">K = length(prob)</code>, sum(prob[.]) == 1 and <code class="code">rN</code> must point to a length-<code class="code">K</code> integer vector n1 n2 .. nK where each entry nj=<code class="code">rN[j]</code> is “filled” by a random binomial from Bin(n; prob[j]), constrained to sum(rN[.]) == n.&nbsp;<span id="index-rmultinom" class="index-entry-id"></span> <span id="index-rmultinom-1" class="index-entry-id"></span></p>
<p>After calls to <code class="code">dwilcox</code>, <code class="code">pwilcox</code> or <code class="code">qwilcox</code> the function <code class="code">wilcox_free()</code> should be called, and similarly <code class="code">signrank_free()</code> for the signed rank functions. <span id="index-wilcox_005ffree" class="index-entry-id"></span> <span id="index-wilcox_005ffree-1" class="index-entry-id"></span> <span id="index-signrank_005ffree" class="index-entry-id"></span> <span id="index-signrank_005ffree-1" class="index-entry-id"></span> Since <code class="code">wilcox_free()</code> and <code class="code">signrank_free()</code> were only added to <samp class="file">Rmath.h</samp> in R&nbsp; 4.2.0, their use requires something like</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"Rmath.h"</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"Rversion.h"</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#if R_VERSION &lt; R_Version(4, 2, 0)</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">void</span> wilcox_free<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">void</span> signrank_free<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For the negative binomial distribution (<samp class="samp">nbinom</samp>‘), in addition to the <code class="code">(size, prob)</code> parametrization, the alternative <code class="code">(size, mu)</code> parametrization is provided as well by functions <samp class="samp">[dpqr]nbinom_mu()</samp>’, see <kbd><kbd>?NegBinomial</kbd></kbd> in R.</p>
<p>Functions <code class="code">dpois_raw(x, *)</code> and <code class="code">dbinom_raw(x, *)</code> are versions of the Poisson and binomial probability mass functions which work continuously in <code class="code">x</code>, whereas <code class="code">dbinom(x,*)</code> and <code class="code">dpois(x,*)</code> only return non zero values for integer <code class="code">x</code>.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> dbinom_raw<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> n<span class="op">,</span> <span class="dt">double</span> p<span class="op">,</span> <span class="dt">double</span> q<span class="op">,</span> <span class="dt">int</span> give_log<span class="op">)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> dpois_raw <span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> lambda<span class="op">,</span> <span class="dt">int</span> give_log<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that <code class="code">dbinom_raw()</code> returns both p and q = 1-p which may be advantageous when one of them is close to 1.</p>
</section>
<section id="mathematical-functions" class="level3 subsection" data-number="6.7.2">
<h3 class="subsection anchored" data-number="6.7.2" data-anchor-id="mathematical-functions"><span class="header-section-number">6.7.2</span> Mathematical functions</h3>
<p><span id="index-Gamma-function" class="index-entry-id"></span> <span id="index-Polygamma-functions" class="index-entry-id"></span> <span id="index-gammafn" class="index-entry-id"></span> <span id="index-gammafn-1" class="index-entry-id"></span> <span id="index-lgammafn" class="index-entry-id"></span></p>
<p><span id="index-trigamma-1" class="index-entry-id"></span> <span id="index-tetragamma" class="index-entry-id"></span> <span id="index-tetragamma-1" class="index-entry-id"></span> <span id="index-pentagamma" class="index-entry-id"></span> <span id="index-pentagamma-1" class="index-entry-id"></span> <span id="index-psigamma" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">double</code> <strong>gammafn</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>lgammafn</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>digamma</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>trigamma</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>tetragamma</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>pentagamma</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>psigamma</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">deriv</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>dpsifn</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">, int</code><var class="var">kode</var><code class="def-code-arguments">, int</code><var class="var">m</var><code class="def-code-arguments">, double*</code><var class="var">ans</var><code class="def-code-arguments">, int*</code><var class="var">nz</var><code class="def-code-arguments">, int*</code><var class="var">ierr</var><code class="def-code-arguments">)</code></p>
<p>: The Gamma function, the natural logarithm of its absolute value and first four derivatives and the n-th derivative of Psi, the digamma function, which is the derivative of <code class="code">lgammafn</code>. In other words, <code class="code">digamma(x)</code> is the same as <code class="code">psigamma(x,0)</code>, <code class="code">trigamma(x) == psigamma(x,1)</code>, etc. The underlying workhorse, <code class="code">dpsifn()</code>, is useful, e.g., when several derivatives of log Gamma=<code class="code">lgammafn</code> are desired. It computes and returns in <code class="code">ans[]</code> the length-<var class="var">m</var> sequence (-1)^(k+1) / gamma(k+1) * psi(k;x) for k = n ... n+m-1, where psi(k;x) is the k-th derivative of Psi(x), i.e., <code class="code">psigamma(x,k)</code>. For more details, see the comments in <samp class="file">src/nmath/polygamma.c</samp>.</p>
<p><span class="category-def">Function:</span><code class="def-type">double</code> <strong>beta</strong> <code class="def-code-arguments">(double</code><var class="var">a</var><code class="def-code-arguments">, double</code><var class="var">b</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>lbeta</strong> <code class="def-code-arguments">(double</code><var class="var">a</var><code class="def-code-arguments">, double</code><var class="var">b</var><code class="def-code-arguments">)</code></p>
<p>: The (complete) Beta function and its natural logarithm.</p>
<p><span class="category-def">Function:</span><code class="def-type">double</code> <strong>choose</strong> <code class="def-code-arguments">(double</code><var class="var">n</var><code class="def-code-arguments">, double</code><var class="var">k</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>lchoose</strong> <code class="def-code-arguments">(double</code><var class="var">n</var><code class="def-code-arguments">, double</code><var class="var">k</var><code class="def-code-arguments">)</code></p>
<p>: The number of combinations of <var class="var">k</var> items chosen from <var class="var">n</var> and the natural logarithm of its absolute value, generalized to arbitrary real <var class="var">n</var>. <var class="var">k</var> is rounded to the nearest integer (with a warning if needed).</p>
<p><span id="index-Bessel-functions" class="index-entry-id"></span> <span id="index-bessel_005fi" class="index-entry-id"></span> <span id="index-bessel_005fi-1" class="index-entry-id"></span> <span id="index-bessel_005fj" class="index-entry-id"></span> <span id="index-bessel_005fj-1" class="index-entry-id"></span> <span id="index-bessel_005fk" class="index-entry-id"></span> <span id="index-bessel_005fk-1" class="index-entry-id"></span> <span id="index-bessel_005fy" class="index-entry-id"></span> <span id="index-bessel_005fy-1" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">double</code> <strong>bessel_i</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">nu</var><code class="def-code-arguments">, double</code><var class="var">expo</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>bessel_j</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">nu</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>bessel_k</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">nu</var><code class="def-code-arguments">, double</code><var class="var">expo</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>bessel_y</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">nu</var><code class="def-code-arguments">)</code></p>
<p>: Bessel functions of types I, J, K and Y with index <var class="var">nu</var>. For <code class="code">bessel_i</code> and <code class="code">bessel_k</code> there is the option to return exp(-<var class="var">x</var>)&nbsp;I(<var class="var">x</var>;&nbsp;<var class="var">nu</var>) or exp(<var class="var">x</var>)&nbsp;K(<var class="var">x</var>;&nbsp;<var class="var">nu</var>) if <var class="var">expo</var> is 2. (Use <var class="var">expo</var><code class="code">== 1</code> for unscaled values.)</p>
</section>
<section id="numerical-utilities" class="level3 subsection" data-number="6.7.3">
<h3 class="subsection anchored" data-number="6.7.3" data-anchor-id="numerical-utilities"><span class="header-section-number">6.7.3</span> Numerical Utilities</h3>
<p>There are a few other numerical utility functions available as entry points.</p>
<p><span id="index-R_005fpow" class="index-entry-id"></span> <span id="index-R_005fpow-1" class="index-entry-id"></span> <span id="index-R_005fpow_005fdi" class="index-entry-id"></span> <span id="index-R_005fpow_005fdi-1" class="index-entry-id"></span> <span id="index-pow1p" class="index-entry-id"></span> <span id="index-pow1p-1" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">double</code> <strong>R_pow</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">y</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>R_pow_di</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">i</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>pow1p</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">y</var><code class="def-code-arguments">)</code></p>
<p>: <code class="code">R_pow(</code><var class="var">x</var><code class="code">,</code><var class="var">y</var><code class="code">)</code> and <code class="code">R_pow_di(</code><var class="var">x</var><code class="code">,</code><var class="var">i</var><code class="code">)</code> compute <var class="var">x</var><code class="code">^</code><var class="var">y</var> and <var class="var">x</var><code class="code">^</code><var class="var">i</var>, respectively using <code class="code">R_FINITE</code> checks and returning the proper result (the same as R) for the cases where <var class="var">x</var>, <var class="var">y</var> or <var class="var">i</var> are 0 or missing or infinite or <code class="code">NaN</code>.</p>
<pre><code>`pow1p(`{.code}`x`{.variable .var}`, `{.code}`y`{.variable
.var}`)`{.code} computes `(1 + `{.code}`x`{.variable
.var}`)^`{.code}`y`{.variable .var}, accurately even for small
`x`{.variable .var}, i.e., \|x\| \&lt;\&lt; 1.</code></pre>
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>log1p</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">log(1 +</code><var class="var">x</var><code class="code">)</code> (<em>log 1 <strong>p</strong>lus x</em>), accurately even for small <var class="var">x</var>, i.e., |x| &lt;&lt; 1.</p>
<p>This should be provided by your platform, in which case it is not included in <samp class="file">Rmath.h</samp>, but is (probably) in <samp class="file">math.h</samp> which <samp class="file">Rmath.h</samp> includes (except under C++, so it may not be declared for C++98).</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>log1pmx</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">log(1 +</code><var class="var">x</var><code class="code">) -</code><var class="var">x</var> (<em>log 1 <strong>p</strong>lus x <strong>m</strong>inus <strong>x</strong></em>), accurately even for small <var class="var">x</var>, i.e., |x| &lt;&lt; 1.</p>
</dd>
</dl>
<p><span id="index-log1pexp" class="index-entry-id"></span> <span id="index-log1pexp-1" class="index-entry-id"></span></p>
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>log1pexp</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">log(1 + exp(</code><var class="var">x</var><code class="code">))</code> (<em>log 1 <strong>p</strong>lus <strong>exp</strong></em>), accurately, notably for large <var class="var">x</var>, e.g., x &gt; 720.</p>
</dd>
</dl>
<p><span id="index-log1mexp" class="index-entry-id"></span> <span id="index-log1mexp-1" class="index-entry-id"></span></p>
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>log1mexp</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">log(1 - exp(</code><var class="var">-x</var><code class="code">))</code> (<em>log 1 <strong>m</strong>inus <strong>exp</strong></em>), accurately, carefully for two regions of <var class="var">x</var>, optimally cutting off at log 2 (= 0.693147..), using <code class="code">((-x) &gt; -M_LN2 ? log(-expm1(-x)) : log1p(-exp(-x)))</code>.</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>expm1</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">exp(</code><var class="var">x</var><code class="code">) - 1</code> (<em>exp x <strong>m</strong>inus 1</em>), accurately even for small <var class="var">x</var>, i.e., |x| &lt;&lt; 1.</p>
<p>This should be provided by your platform, in which case it is not included in <samp class="file">Rmath.h</samp>, but is (probably) in <samp class="file">math.h</samp> which <samp class="file">Rmath.h</samp> includes (except under C++, so it may not be declared for C++98).</p>
</dd>
</dl>
<p><span id="index-lgamma1p" class="index-entry-id"></span> <span id="index-lgamma1p-1" class="index-entry-id"></span></p>
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>lgamma1p</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">log(gamma(</code><var class="var">x</var><code class="code">+ 1))</code> (<em>log(gamma(1 <strong>p</strong>lus x))</em>), accurately even for small <var class="var">x</var>, i.e., 0 &lt; x &lt; 0.5.</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>cospi</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">cos(pi * x)</code> (where <code class="code">pi</code> is 3.14159...), accurately, notably for half integer <var class="var">x</var>.</p>
<p>This might be provided by your platform<a href="#FOOT170" id="DOCF170" class="footnote"><sup>170</sup></a>, in which case it is not included in <samp class="file">Rmath.h</samp>, but is in <samp class="file">math.h</samp> which <samp class="file">Rmath.h</samp> includes. (Ensure that neither <samp class="file">math.h</samp> nor <samp class="file">cmath</samp> is included before <samp class="file">Rmath.h</samp> or define</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define __STDC_WANT_IEC_60559_FUNCS_EXT__ </span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>before the first inclusion.)</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>sinpi</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">sin(pi * x)</code> accurately, notably for (half) integer <var class="var">x</var>.</p>
<p>This might be provided by your platform, in which case it is not included in <samp class="file">Rmath.h</samp>, but is in <samp class="file">math.h</samp> which <samp class="file">Rmath.h</samp> includes (but see the comments for <code class="code">cospi</code>).</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>Rtanpi</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">tan(pi * x)</code> accurately, notably for integer <var class="var">x</var>, giving <var class="var">NaN</var> for half integer <var class="var">x</var> and exactly +1 or -1 for (non half) quarter integers.</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>tanpi</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Computes <code class="code">tan(pi * x)</code> accurately for integer <var class="var">x</var> with possibly platform dependent behavior for half (and quarter) integers. This might be provided by your platform, in which case it is not included in <samp class="file">Rmath.h</samp>, but is in <samp class="file">math.h</samp> which <samp class="file">Rmath.h</samp> includes (but see the comments for <code class="code">cospi</code>).</p>
</dd>
</dl>
<p><span id="index-logspace_005fadd" class="index-entry-id"></span> <span id="index-logspace_005fadd-1" class="index-entry-id"></span> <span id="index-logspace_005fsub" class="index-entry-id"></span> <span id="index-logspace_005fsub-1" class="index-entry-id"></span> <span id="index-logspace_005fsum" class="index-entry-id"></span> <span id="index-logspace_005fsum-1" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">double</code> <strong>logspace_add</strong> <code class="def-code-arguments">(double</code><var class="var">logx</var><code class="def-code-arguments">, double</code><var class="var">logy</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>logspace_sub</strong> <code class="def-code-arguments">(double</code><var class="var">logx</var><code class="def-code-arguments">, double</code><var class="var">logy</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>logspace_sum</strong> <code class="def-code-arguments">(const double*</code><var class="var">logx</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">)</code></p>
<p>: Compute the log of a sum or difference from logs of terms, i.e., “x + y” as <code class="code">log (exp(</code><var class="var">logx</var><code class="code">) + exp(</code><var class="var">logy</var><code class="code">))</code> and “x - y” as <code class="code">log (exp(</code><var class="var">logx</var><code class="code">) - exp(</code><var class="var">logy</var><code class="code">))</code>, and “sum_i x[i]” as <code class="code">log (sum[i = 1:</code><var class="var">n</var><code class="code">exp(</code><var class="var">logx</var><code class="code">[i])] )</code> without causing unnecessary overflows or throwing away too much accuracy.</p>
<p><span class="category-def">Function:</span><code class="def-type">int</code> <strong>imax2</strong> <code class="def-code-arguments">(int</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">y</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">int</code> <strong>imin2</strong> <code class="def-code-arguments">(int</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">y</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>fmax2</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">y</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>fmin2</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">y</var><code class="def-code-arguments">)</code></p>
<p>: Return the larger (<code class="code">max</code>) or smaller (<code class="code">min</code>) of two integer or double numbers, respectively. Note that <code class="code">fmax2</code> and <code class="code">fmin2</code> differ from C99/C++11’s <code class="code">fmax</code> and <code class="code">fmin</code> when one of the arguments is a <code class="code">NaN</code>: these versions return <code class="code">NaN</code>.</p>
<!-- -->
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>sign</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p><span id="index-sign" class="index-entry-id"></span> <span id="index-sign-2" class="index-entry-id"></span></p>
<p>Compute the <em>signum</em> function, where sign(<var class="var">x</var>) is 1, 0, or <em>-1</em>, when <var class="var">x</var> is positive, 0, or negative, respectively, and <code class="code">NaN</code> if <code class="code">x</code> is a <code class="code">NaN</code>.</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>fsign</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">y</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Performs “transfer of sign” and is defined as |x| * sign(y).</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>fprec</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">digits</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Returns the value of <var class="var">x</var> rounded to <var class="var">digits</var> <em>significant</em> decimal digits.</p>
<p>This is the function used by R’s <code class="code">signif()</code>.</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>fround</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">, double</code><var class="var">digits</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Returns the value of <var class="var">x</var> rounded to <var class="var">digits</var> decimal digits (after the decimal point).</p>
<p>This is the function used by R’s <code class="code">round()</code>. (Note that C99/C++11 provide a <code class="code">round</code> function but C++98 need not.)</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">double</code> <strong>ftrunc</strong> <code class="def-code-arguments">(double</code><var class="var">x</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Returns the value of <var class="var">x</var> truncated (to an integer value) towards zero.</p>
</dd>
</dl>
</section>
<section id="mathematical-constants" class="level3 subsection" data-number="6.7.4">
<h3 class="subsection anchored" data-number="6.7.4" data-anchor-id="mathematical-constants"><span class="header-section-number">6.7.4</span> Mathematical constants</h3>
<p><span id="index-M_005fPI" class="index-entry-id"></span> <span id="index-M_005fPI-1" class="index-entry-id"></span></p>
<p>R has a set of commonly used mathematical constants encompassing constants defined by POSIX and usually found in headers <samp class="file">math.h</samp> and <samp class="file">cmath</samp>, as well as further ones that are used in statistical computations. These are defined to (at least) 30 digits accuracy in <samp class="file">Rmath.h</samp>. The following definitions use <code class="code">ln(x)</code> for the natural logarithm (<code class="code">log(x)</code> in R).</p>
<blockquote class="blockquote">
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Definition (<code class="code">ln = log</code>)</th>
<th style="text-align: left;">round(<em>value</em>, 7)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_E</code></td>
<td style="text-align: left;"><em>e</em></td>
<td style="text-align: left;">2.7182818</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_LOG2E</code></td>
<td style="text-align: left;">log2(<em>e</em>)</td>
<td style="text-align: left;">1.4426950</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_LOG10E</code></td>
<td style="text-align: left;">log10(<em>e</em>)</td>
<td style="text-align: left;">0.4342945</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_LN2</code></td>
<td style="text-align: left;">ln(2)</td>
<td style="text-align: left;">0.6931472</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_LN10</code></td>
<td style="text-align: left;">ln(10)</td>
<td style="text-align: left;">2.3025851</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_PI</code></td>
<td style="text-align: left;">pi</td>
<td style="text-align: left;">3.1415927</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_PI_2</code></td>
<td style="text-align: left;">pi/2</td>
<td style="text-align: left;">1.5707963</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_PI_4</code></td>
<td style="text-align: left;">pi/4</td>
<td style="text-align: left;">0.7853982</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_1_PI</code></td>
<td style="text-align: left;">1/pi</td>
<td style="text-align: left;">0.3183099</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_2_PI</code></td>
<td style="text-align: left;">2/pi</td>
<td style="text-align: left;">0.6366198</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_2_SQRTPI</code></td>
<td style="text-align: left;">2/sqrt(pi)</td>
<td style="text-align: left;">1.1283792</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_SQRT2</code></td>
<td style="text-align: left;">sqrt(2)</td>
<td style="text-align: left;">1.4142136</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_SQRT1_2</code></td>
<td style="text-align: left;">1/sqrt(2)</td>
<td style="text-align: left;">0.7071068</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_SQRT_3</code></td>
<td style="text-align: left;">sqrt(3)</td>
<td style="text-align: left;">1.7320508</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_SQRT_32</code></td>
<td style="text-align: left;">sqrt(32)</td>
<td style="text-align: left;">5.6568542</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_LOG10_2</code></td>
<td style="text-align: left;">log10(2)</td>
<td style="text-align: left;">0.3010300</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_2PI</code></td>
<td style="text-align: left;">2*pi</td>
<td style="text-align: left;">6.2831853</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_SQRT_PI</code></td>
<td style="text-align: left;">sqrt(pi)</td>
<td style="text-align: left;">1.7724539</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_1_SQRT_2PI</code></td>
<td style="text-align: left;">1/sqrt(2*pi)</td>
<td style="text-align: left;">0.3989423</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_SQRT_2dPI</code></td>
<td style="text-align: left;">sqrt(2/pi)</td>
<td style="text-align: left;">0.7978846</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_LN_SQRT_PI</code></td>
<td style="text-align: left;">ln(sqrt(pi))</td>
<td style="text-align: left;">0.5723649</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code class="code">M_LN_SQRT_2PI</code></td>
<td style="text-align: left;">ln(sqrt(2*pi))</td>
<td style="text-align: left;">0.9189385</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code class="code">M_LN_SQRT_PId2</code></td>
<td style="text-align: left;">ln(sqrt(pi/2))</td>
<td style="text-align: left;">0.2257914</td>
</tr>
</tbody>
</table>
</blockquote>
<p>For compatibility with S this file used to define the constant <code class="code">PI</code> this is defunct and should be replaced by <code class="code">M_PI</code>. Header <samp class="file">Constants.h</samp> includes either C header <samp class="file">float.h</samp> or C++ header <samp class="file">cfloat</samp>, which provide constants such as <code class="code">DBL_MAX</code>.</p>
<p>The included header <samp class="file">R_ext/Boolean.h</samp> has enumeration constants <code class="code">TRUE</code> and <code class="code">FALSE</code> of type <code class="code">Rboolean</code> in order to provide a way of using “logical” variables in C consistently. This can conflict with other software: for example it conflicts with the headers in IJG’s <code class="code">jpeg-9</code> (but not earlier versions). <code class="code">Rboolean</code> cannot represent <code class="code">NA</code><a href="#FOOT171" id="DOCF171" class="footnote"><sup>171</sup></a> and hence cannot be used for elements of R logical vectors.</p>
<p>Type <code class="code">Rboolean</code> is being phased out: as from R&nbsp;4.5.0 the header also makes available the type <code class="code">bool</code> and values <code class="code">true</code> and <code class="code">false</code>. These are reserved words in C23 and C++11 and available <em>via</em> header <samp class="file">stdbool.h</samp> as from C99. (Type <code class="code">bool</code> is not a drop-in replacement for <code class="code">Rboolean</code> as it is usually stored in a byte and <code class="code">Rboolean</code> in an <code class="code">int</code>, hence 4 bytes.)</p>
<p>Some package maintainers may want to exclude the provision of <code class="code">TRUE</code>, <code class="code">FALSE</code>, <code class="code">true</code>, <code class="code">false</code> and <code class="code">bool</code> to avoid clashes with other headers such as the IJG ones mentioned above. This cannot be done entirely (the last three are keywords in C23 and C++11) but as from R&nbsp;4.5.0 defining <code class="code">R_INCLUDE_BOOLEAN_H</code> to <code class="code">0</code> before including any header which includes this one (such as <samp class="file">R.h</samp> and <samp class="file">Rinternals.h</samp>) skips its body.</p>
</section>
</section>
<section id="optimization" class="level2 section" data-number="6.8">
<h2 class="section anchored" data-number="6.8" data-anchor-id="optimization"><span class="header-section-number">6.8</span> Optimization</h2>
<p>The C code underlying <code class="code">optim</code> can be accessed directly. The user needs to supply a function to compute the function to be minimized, of the type</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">double</span> optimfn<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>par<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the first argument is the number of parameters in the second argument. The third argument is a pointer passed down from the calling routine, normally used to carry auxiliary information.</p>
<p>Some of the methods also require a gradient function</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> optimgr<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>par<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>gr<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which passes back the gradient in the <code class="code">gr</code> argument. No function is provided for finite-differencing, nor for approximating the Hessian at the result.</p>
<p>The interfaces (defined in header <samp class="file">R_ext/Applic.h</samp>) are</p>
<ul>
<li><p>Nelder Mead: <span id="index-nmmin" class="index-entry-id"></span> <span id="index-nmmin-1" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> nmmin<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>xin<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span> optimfn fn<span class="op">,</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> <span class="op">*</span>fail<span class="op">,</span> <span class="dt">double</span> abstol<span class="op">,</span> <span class="dt">double</span> intol<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>           <span class="dt">double</span> alpha<span class="op">,</span> <span class="dt">double</span> beta<span class="op">,</span> <span class="dt">double</span> gamma<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> <span class="op">*</span>fncount<span class="op">,</span> <span class="dt">int</span> maxit<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>BFGS: <span id="index-vmmin" class="index-entry-id"></span> <span id="index-vmmin-1" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vmmin<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>           optimfn fn<span class="op">,</span> optimgr gr<span class="op">,</span> <span class="dt">int</span> maxit<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> <span class="op">*</span>mask<span class="op">,</span> <span class="dt">double</span> abstol<span class="op">,</span> <span class="dt">double</span> reltol<span class="op">,</span> <span class="dt">int</span> nREPORT<span class="op">,</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fncount<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>grcount<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fail<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Conjugate gradients: <span id="index-cgmin" class="index-entry-id"></span> <span id="index-cgmin-1" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cgmin<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>xin<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>           optimfn fn<span class="op">,</span> optimgr gr<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fail<span class="op">,</span> <span class="dt">double</span> abstol<span class="op">,</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>           <span class="dt">double</span> intol<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">int</span> type<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> <span class="op">*</span>fncount<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>grcount<span class="op">,</span> <span class="dt">int</span> maxit<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Limited-memory BFGS with bounds: <span id="index-lbfgsb" class="index-entry-id"></span> <span id="index-lbfgsb-1" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> lbfgsb<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">int</span> lmm<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>lower<span class="op">,</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>upper<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>nbd<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span> optimfn fn<span class="op">,</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>            optimgr gr<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fail<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">double</span> factr<span class="op">,</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> pgtol<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fncount<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>grcount<span class="op">,</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> maxit<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>msg<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span> <span class="dt">int</span> nREPORT<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Simulated annealing: <span id="index-samin" class="index-entry-id"></span> <span id="index-samin-1" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> samin<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span> optimfn fn<span class="op">,</span> <span class="dt">int</span> maxit<span class="op">,</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> tmax<span class="op">,</span> <span class="dt">double</span> temp<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<p>Many of the arguments are common to the various methods. <code class="code">n</code> is the number of parameters, <code class="code">x</code> or <code class="code">xin</code> is the starting parameters on entry and <code class="code">x</code> the final parameters on exit, with final value returned in <code class="code">Fmin</code>. Most of the other parameters can be found from the help page for <code class="code">optim</code>: see the source code <samp class="file">src/appl/lbfgsb.c</samp> for the values of <code class="code">nbd</code>, which specifies which bounds are to be used.</p>
</section>
<section id="integration" class="level2 section" data-number="6.9">
<h2 class="section anchored" data-number="6.9" data-anchor-id="integration"><span class="header-section-number">6.9</span> Integration</h2>
<p>The C code underlying <code class="code">integrate</code> can be accessed directly. The user needs to supply a <em>vectorizing</em> C function to compute the function to be integrated, of the type</p>
<p><span id="index-integr_005ffn" class="index-entry-id"></span> <span id="index-integr_005ffn-1" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> integr_fn<span class="op">(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> n<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code class="code">x[]</code> is both input and output and has length <code class="code">n</code>, i.e., a C function, say <code class="code">fn</code>, of type <code class="code">integr_fn</code> must basically do <code class="code">for(i in 1:n) x[i] := f(x[i], ex)</code>. The vectorization requirement can be used to speed up the integrand instead of calling it <code class="code">n</code> times. Note that in the current implementation built on QUADPACK, <code class="code">n</code> will be either 15 or 21. The <code class="code">ex</code> argument is a pointer passed down from the calling routine, normally used to carry auxiliary information.</p>
<p>There are interfaces (defined in header <samp class="file">R_ext/Applic.h</samp>) for integrals over finite and infinite intervals (or “ranges” or “integration boundaries”).</p>
<ul>
<li><p>Finite: <span id="index-Rdqags" class="index-entry-id"></span> <span id="index-Rdqags-1" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rdqags<span class="op">(</span>integr_fn f<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>a<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>b<span class="op">,</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>epsabs<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>epsrel<span class="op">,</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>result<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>abserr<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>neval<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ier<span class="op">,</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> <span class="op">*</span>limit<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>lenw<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>last<span class="op">,</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> <span class="op">*</span>iwork<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>work<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Infinite: <span id="index-Rdqagi" class="index-entry-id"></span> <span id="index-Rdqagi-1" class="index-entry-id"></span></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rdqagi<span class="op">(</span>integr_fn f<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>bound<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>inf<span class="op">,</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>epsabs<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>epsrel<span class="op">,</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>result<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>abserr<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>neval<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ier<span class="op">,</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> <span class="op">*</span>limit<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>lenw<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>last<span class="op">,</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> <span class="op">*</span>iwork<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>work<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<p>Only the 3rd and 4th argument differ for the two integrators; for the finite range integral using <code class="code">Rdqags</code>, <code class="code">a</code> and <code class="code">b</code> are the integration interval bounds, whereas for an infinite range integral using <code class="code">Rdqagi</code>, <code class="code">bound</code> is the finite bound of the integration (if the integral is not doubly-infinite) and <code class="code">inf</code> is a code indicating the kind of integration range,</p>
<dl>
<dt><code class="code">inf = 1</code></dt>
<dd>
<p>corresponds to (bound, +Inf),</p>
</dd>
<dt><code class="code">inf = -1</code></dt>
<dd>
<p>corresponds to (-Inf, bound),</p>
</dd>
<dt><code class="code">inf = 2</code></dt>
<dd>
<p>corresponds to (-Inf, +Inf),</p>
</dd>
</dl>
<p><code class="code">f</code> and <code class="code">ex</code> define the integrand function, see above; <code class="code">epsabs</code> and <code class="code">epsrel</code> specify the absolute and relative accuracy requested, <code class="code">result</code>, <code class="code">abserr</code> and <code class="code">last</code> are the output components <code class="code">value</code>, <code class="code">abs.err</code> and <code class="code">subdivisions</code> of the R function integrate, where <code class="code">neval</code> gives the number of integrand function evaluations, and the error code <code class="code">ier</code> is translated to R’s <code class="code">integrate() $ message</code>, look at that function definition. <code class="code">limit</code> corresponds to <code class="code">integrate(..., subdivisions = *)</code>. It seems you should always define the two work arrays and the length of the second one as</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>    lenw <span class="op">=</span> <span class="dv">4</span> <span class="op">*</span> limit<span class="op">;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    iwork <span class="op">=</span>   <span class="op">(</span><span class="dt">int</span> <span class="op">*)</span> R_alloc<span class="op">(</span>limit<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    work <span class="op">=</span> <span class="op">(</span><span class="dt">double</span> <span class="op">*)</span> R_alloc<span class="op">(</span>lenw<span class="op">,</span>  <span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The comments in the source code in <samp class="file">src/appl/integrate.c</samp> give more details, particularly about reasons for failure (<code class="code">ier &gt;= 1</code>).</p>
</section>
<section id="utility-functions" class="level2 section" data-number="6.10">
<h2 class="section anchored" data-number="6.10" data-anchor-id="utility-functions"><span class="header-section-number">6.10</span> Utility functions</h2>
<p>R has a fairly comprehensive set of sort routines which are made available to users’ C code. The following is declared in header file <samp class="file">Rinternals.h</samp>.</p>
<p><span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_orderVector</strong> <code class="def-code-arguments">(int*</code><var class="var">indx</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">, SEXP</code><var class="var">arglist</var><code class="def-code-arguments">, Rboolean</code><var class="var">nalast</var><code class="def-code-arguments">, Rboolean</code><var class="var">decreasing</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_orderVector1</strong> <code class="def-code-arguments">(int*</code><var class="var">indx</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">, SEXP</code><var class="var">x</var><code class="def-code-arguments">, Rboolean</code><var class="var">nalast</var><code class="def-code-arguments">, Rboolean</code><var class="var">decreasing</var><code class="def-code-arguments">)</code></p>
<p>: <code class="code">R_orderVector()</code> corresponds to R’s <code class="code">order(..., na.last, decreasing)</code>. More specifically, <code class="code">indx &lt;- order(x, y, na.last, decreasing)</code> corresponds to <code class="code">R_orderVector(indx, n, Rf_lang2(x, y), nalast, decreasing)</code> and for three vectors, <code class="code">Rf_lang3(x,y,z)</code> is used as <var class="var">arglist</var>.</p>
<pre><code>Both `R_orderVector`{.code} and `R_orderVector1`{.code} assume the
vector `indx`{.code} to be allocated to length \&gt;= n. On return,
`indx[]`{.code} contains a permutation of `0:(n-1)`{.code}, i.e.,
0-based C indices (and not 1-based R indices, as R's
`order()`{.code}).

When ordering only one vector, `R_orderVector1`{.code} is faster and
corresponds (but is 0-based) to R's
`indx &lt;- order(x, na.last, decreasing)`{.code}. It was added in R
3.3.0.</code></pre>
<p>All other sort routines are declared in header file <samp class="file">R_ext/Utils.h</samp> (included by <samp class="file">R.h</samp>) and include the following.</p>
<p><span id="index-R_005fisort" class="index-entry-id"></span> <span id="index-R_005fisort-1" class="index-entry-id"></span> <span id="index-R_005frsort" class="index-entry-id"></span> <span id="index-R_005frsort-1" class="index-entry-id"></span> <span id="index-R_005fcsort" class="index-entry-id"></span> <span id="index-R_005fcsort-1" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_isort</strong> <code class="def-code-arguments">(int*</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_rsort</strong> <code class="def-code-arguments">(double*</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_csort</strong> <code class="def-code-arguments">(Rcomplex*</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>rsort_with_index</strong> <code class="def-code-arguments">(double*</code><var class="var">x</var><code class="def-code-arguments">, int*</code><var class="var">index</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">)</code></p>
<p>: The first three sort integer, real (double) and complex data respectively. (Complex numbers are sorted by the real part first then the imaginary part.) <code class="code">NA</code>s are sorted last.</p>
<pre><code>`rsort_with_index`{.code} sorts on `x`{.variable .var}, and applies
the same permutation to `index`{.variable .var}. `NA`{.code}s are
sorted last.</code></pre>
<p><span id="index-Rf_005frevsort" class="index-entry-id"></span> <span id="index-Rf_005frevsort-1" class="index-entry-id"></span></p>
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">void</code> <strong>Rf_revsort</strong> <code class="def-code-arguments">(double*</code><var class="var">x</var><code class="def-code-arguments">, int*</code><var class="var">index</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Is similar to <code class="code">rsort_with_index</code> but sorts into decreasing order, and <code class="code">NA</code>s are not handled.</p>
</dd>
</dl>
<p><span id="index-Rf_005fiPsort" class="index-entry-id"></span> <span id="index-Rf_005fiPsort-1" class="index-entry-id"></span> <span id="index-Rf_005frPsort" class="index-entry-id"></span> <span id="index-Rf_005frPsort-1" class="index-entry-id"></span> <span id="index-Rf_005fcPsort" class="index-entry-id"></span> <span id="index-Rf_005fcPsort-1" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">void</code> <strong>Rf_iPsort</strong> <code class="def-code-arguments">(int*</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">, int</code><var class="var">k</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>Rf_rPsort</strong> <code class="def-code-arguments">(double*</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">, int</code><var class="var">k</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>Rf_cPsort</strong> <code class="def-code-arguments">(Rcomplex*</code><var class="var">x</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">, int</code><var class="var">k</var><code class="def-code-arguments">)</code></p>
<p>: These all provide (very) partial sorting: they permute <var class="var">x</var> so that <var class="var">x</var><code class="code">[</code><var class="var">k</var><code class="code">]</code> is in the correct place with smaller values to the left, larger ones to the right.</p>
<p><span id="index-R_005fqsort" class="index-entry-id"></span> <span id="index-R_005fqsort-1" class="index-entry-id"></span> <span id="index-R_005fqsort_005fI" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_qsort</strong> <code class="def-code-arguments">(double *</code><var class="var">v</var><code class="def-code-arguments">, size_t</code><var class="var">i</var><code class="def-code-arguments">, size_t</code><var class="var">j</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_qsort_I</strong> <code class="def-code-arguments">(double *</code><var class="var">v</var><code class="def-code-arguments">, int *</code><var class="var">I</var><code class="def-code-arguments">, int</code><var class="var">i</var><code class="def-code-arguments">, int</code><var class="var">j</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_qsort_int</strong> <code class="def-code-arguments">(int *</code><var class="var">iv</var><code class="def-code-arguments">, size_t</code><var class="var">i</var><code class="def-code-arguments">, size_t</code><var class="var">j</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_qsort_int_I</strong> <code class="def-code-arguments">(int *</code><var class="var">iv</var><code class="def-code-arguments">, int *</code><var class="var">I</var><code class="def-code-arguments">, int</code><var class="var">i</var><code class="def-code-arguments">, int</code><var class="var">j</var><code class="def-code-arguments">)</code></p>
<p>: These routines sort <var class="var">v</var><code class="code">[</code><var class="var">i</var><code class="code">:</code><var class="var">j</var><code class="code">]</code> or <var class="var">iv</var><code class="code">[</code><var class="var">i</var><code class="code">:</code><var class="var">j</var><code class="code">]</code> (using 1-indexing, i.e., <var class="var">v</var><code class="code">[1]</code> is the first element) calling the quicksort algorithm as used by R’s <code class="code">sort(v, method = "quick")</code> and documented on the help page for the R function <code class="code">sort</code>. The <code class="code">..._I()</code> versions also return the <code class="code">sort.index()</code> vector in <code class="code">I</code>. Note that the ordering is <em>not</em> stable, so tied values may be permuted.</p>
<pre><code>Note that `NA`{.code}s are not handled (explicitly) and you should
use different sorting functions if `NA`{.code}s can be present.</code></pre>
<p><span class="category-def">Function:</span><code class="def-type">subroutine</code> <strong>qsort4</strong> <code class="def-code-arguments">(double precision</code><var class="var">v</var><code class="def-code-arguments">, integer</code><var class="var">indx</var><code class="def-code-arguments">, integer</code><var class="var">ii</var><code class="def-code-arguments">, integer</code><var class="var">jj</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">subroutine</code> <strong>qsort3</strong> <code class="def-code-arguments">(double precision</code><var class="var">v</var><code class="def-code-arguments">, integer</code><var class="var">ii</var><code class="def-code-arguments">, integer</code><var class="var">jj</var><code class="def-code-arguments">)</code></p>
<p>: The Fortran interface routines for sorting double precision vectors are <code class="code">qsort3</code> and <code class="code">qsort4</code>, equivalent to <code class="code">R_qsort</code> and <code class="code">R_qsort_I</code>, respectively.</p>
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_max_col</strong> <code class="def-code-arguments">(double*</code><var class="var">matrix</var><code class="def-code-arguments">, int*</code><var class="var">nr</var><code class="def-code-arguments">, int*</code><var class="var">nc</var><code class="def-code-arguments">, int*</code><var class="var">maxes</var><code class="def-code-arguments">, int*</code><var class="var">ties_meth</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Given the <var class="var">nr</var> by <var class="var">nc</var> matrix <code class="code">matrix</code> in column-major (“Fortran”) order, <code class="code">R_max_col()</code> returns in <var class="var">maxes</var><code class="code">[</code><var class="var">i</var><code class="code">-1]</code> the column number of the maximal element in the <var class="var">i</var>-th row (the same as R’s <code class="code">max.col()</code> function). In the case of ties (multiple maxima), <code class="code">*ties_meth</code> is an integer code in <code class="code">1:3</code> determining the method: 1 = “random”, 2 = “first” and 3 = “last”. See R’s help page <code class="code">?max.col</code>.</p>
</dd>
</dl>
<p><span id="index-findInterval" class="index-entry-id"></span> <span id="index-findInterval-1" class="index-entry-id"></span> <span id="index-findInterval2" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">int</code> <strong>findInterval</strong> <code class="def-code-arguments">(double*</code><var class="var">xt</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">, double</code><var class="var">x</var><code class="def-code-arguments">, Rboolean</code><var class="var">rightmost_closed</var><code class="def-code-arguments">, Rboolean</code><var class="var">all_inside</var><code class="def-code-arguments">, int</code><var class="var">ilo</var><code class="def-code-arguments">, int*</code><var class="var">mflag</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">int</code> <strong>findInterval2</strong> <code class="def-code-arguments">(double*</code><var class="var">xt</var><code class="def-code-arguments">, int</code><var class="var">n</var><code class="def-code-arguments">, double</code><var class="var">x</var><code class="def-code-arguments">, Rboolean</code><var class="var">rightmost_closed</var><code class="def-code-arguments">, Rboolean</code><var class="var">all_inside</var><code class="def-code-arguments">, Rboolean</code><var class="var">left_open</var><code class="def-code-arguments">, int</code><var class="var">ilo</var><code class="def-code-arguments">, int*</code><var class="var">mflag</var><code class="def-code-arguments">)</code></p>
<p>: Given the ordered vector <var class="var">xt</var> of length <var class="var">n</var>, return the interval or index of <var class="var">x</var> in <var class="var">xt</var><code class="code">[]</code>, typically max(<em>i</em>; 1 &lt;= i &lt;= <var class="var">n</var> &amp; <em><var class="var">xt</var>[i]</em> &lt;= <var class="var">x</var>) where we use 1-indexing as in R and Fortran (but not C). If <var class="var">rightmost_closed</var> is true, also returns <em><var class="var">n</var>-1</em> if <var class="var">x</var> equals <em><var class="var">xt</var>[<var class="var">n</var>]</em>. If <var class="var">all_inside</var> is not 0, the result is coerced to lie in <code class="code">1:(</code><var class="var">n</var><code class="code">-1)</code> even when <var class="var">x</var> is outside the <var class="var">xt</var>[] range. On return, <code class="code">*</code><var class="var">mflag</var> equals <em>-1</em> if <var class="var">x</var> &lt; <var class="var">xt</var>[1], <em>+1</em> if <var class="var">x</var> &gt;= <var class="var">xt</var>[<var class="var">n</var>], and 0 otherwise.</p>
<pre><code>The algorithm is particularly fast when `ilo`{.variable .var} is set
to the last result of `findInterval()`{.code} and `x`{.variable
.var} is a value of a sequence which is increasing or decreasing for
subsequent calls.

`findInterval2()`{.code} is a generalization of
`findInterval()`{.code}, with an extra `Rboolean`{.code} argument
`left_open`{.variable .var}. Setting `left_open = TRUE`{.code}
basically replaces all left-closed right-open intervals t) by
left-open ones t\], see the help page of R function
`findInterval`{.code} for details.

There is also an `F77_CALL(interv)()`{.code} version of
`findInterval()`{.code} with the same arguments, but all pointers.</code></pre>
<p>A system-independent interface to produce the name of a temporary file is provided as</p>
<p><span id="index-R_005ftmpnam" class="index-entry-id"></span> <span id="index-R_005ftmpnam-1" class="index-entry-id"></span> <span id="index-R_005ftmpnam2" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">char *</code> <strong>R_tmpnam</strong> <code class="def-code-arguments">(const char *</code><var class="var">prefix</var><code class="def-code-arguments">, const char *</code><var class="var">tmpdir</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">char *</code> <strong>R_tmpnam2</strong> <code class="def-code-arguments">(const char *</code><var class="var">prefix</var><code class="def-code-arguments">, const char *</code><var class="var">tmpdir</var><code class="def-code-arguments">, const char *</code><var class="var">fileext</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">void</code> <strong>R_free_tmpnam</strong> <code class="def-code-arguments">(char *</code><var class="var">name</var><code class="def-code-arguments">)</code></p>
<p>: Return a pathname for a temporary file with name beginning with <var class="var">prefix</var> and ending with <var class="var">fileext</var> in directory <var class="var">tmpdir</var>. A <code class="code">NULL</code> prefix or extension is replaced by <code class="code">""</code>. Note that the return value is dynamically allocated and should be freed using <code class="code">R_free_tmpnam</code> when no longer needed (unlike the system call <code class="code">tmpnam</code>). Freeing the result using <code class="code">free</code> is no longer recommended.</p>
<p><span id="index-R_005fatof" class="index-entry-id"></span> <span id="index-R_005fatof-1" class="index-entry-id"></span> <span id="index-R_005fstrtod" class="index-entry-id"></span></p>
<p><span class="category-def">Function:</span><code class="def-type">double</code> <strong>R_atof</strong> <code class="def-code-arguments">(const char*</code><var class="var">str</var><code class="def-code-arguments">)</code><br>
<span class="category-def">Function:</span><code class="def-type">double</code> <strong>R_strtod</strong> <code class="def-code-arguments">(const char*</code><var class="var">str</var><code class="def-code-arguments">, char **</code><var class="var">end</var><code class="def-code-arguments">)</code></p>
<p>: Implementations of the C99/POSIX functions <code class="code">atof</code> and <code class="code">strtod</code> which guarantee platform- and locale-independent behaviour, including always using the period as the decimal point <em>aka</em> ‘radix character’ and returning R’s <code class="code">NA_REAL_</code> for all unconverted strings, including <code class="code">"NA"</code>.</p>
<p>There is also the internal function used to expand file names in several R functions, and called directly by <code class="code">path.expand</code>.</p>
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">const char *</code> <strong>R_ExpandFileName</strong> <code class="def-code-arguments">(const char *</code><var class="var">fn</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Expand a path name <var class="var">fn</var> by replacing a leading tilde by the user’s home directory (if defined). The precise meaning is platform-specific; it will usually be taken from the environment variable <code class="env">HOME</code> if this is defined.</p>
</dd>
</dl>
<p>For historical reasons there are Fortran interfaces to functions <code class="code">D1MACH</code> and <code class="code">I1MACH</code>. These can be called from C code as e.g.&nbsp;<code class="code">F77_CALL(d1mach)(4)</code>. Note that these are emulations of the original functions by Fox, Hall and Schryer on Netlib at <a href="https://netlib.org/slatec/src/" class="uref">https://netlib.org/slatec/src/</a> for IEC&nbsp;60559 arithmetic (required by R). <span id="index-d1mach" class="index-entry-id"></span> <span id="index-d1mach-1" class="index-entry-id"></span> <span id="index-i1mach" class="index-entry-id"></span> <span id="index-i1mach-1" class="index-entry-id"></span></p>
</section>
<section id="linear-algebra" class="level2 section" data-number="6.11">
<h2 class="section anchored" data-number="6.11" data-anchor-id="linear-algebra"><span class="header-section-number">6.11</span> Linear algebra</h2>
<p>The preferred way to do numerical linear algebra from C/Fortran code is to use BLAS/LAPACK<a href="#FOOT172" id="DOCF172" class="footnote"><sup>172</sup></a> Declarations callable from C/C++ are provided in headers <samp class="file">R_ext/BLAS.h</samp> and <samp class="file">R_ext/LAPACK.h</samp>.</p>
<p>However, a number of Fortran routines are included in R and underlie <code class="code">lm.fit()</code>, <code class="code">lm.wfit()</code> and <code class="code">qr(LAPACK = FALSE)</code> and its helper functions. These remain available to packages which wish to emulate what R does, and are declared as a C/C++ interface in header <samp class="file">R_ext/Applic.h</samp>. But they are also often called <em>via</em> <code class="code">.Fortran()</code> and from Fortran code.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>dqrqty<span class="op">)(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>k<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>qraux<span class="op">,</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">double</span> <span class="op">*</span>y<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ny<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>qty<span class="op">);</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>dqrqy<span class="op">)(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>k<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>qraux<span class="op">,</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">double</span> <span class="op">*</span>y<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ny<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>qy<span class="op">);</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>dqrcf<span class="op">)(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>k<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>qraux<span class="op">,</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">double</span> <span class="op">*</span>y<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ny<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>b<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>info<span class="op">);</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>dqrrsd<span class="op">)(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>k<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>qraux<span class="op">,</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">double</span> <span class="op">*</span>y<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ny<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>rsd<span class="op">);</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>dqrxb<span class="op">)(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>k<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>qraux<span class="op">,</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">double</span> <span class="op">*</span>y<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ny<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>xb<span class="op">);</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>dqrls<span class="op">)(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>p<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>y<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ny<span class="op">,</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">double</span> <span class="op">*</span>tol<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>b<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>rsd<span class="op">,</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">double</span> <span class="op">*</span>qty<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>k<span class="op">,</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">int</span> <span class="op">*</span>jpvt<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>qraux<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>work<span class="op">);</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>dqrdc2<span class="op">)(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ldx<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>p<span class="op">,</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">double</span> <span class="op">*</span>tol<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>rank<span class="op">,</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">double</span> <span class="op">*</span>qraux<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>pivot<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>work<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For further details see their source files in directory <samp class="file">src/Appl</samp> in the R sources or <a href="https://netlib.org/linpack/" class="uref">https://netlib.org/linpack/</a>. <code class="code">dqrdc2</code> is an extensive R modification to LINPACK’s <code class="code">dqrdc</code> which uses column pivoting and computes the (numerical) rank.</p>
<p>These are for the time being regarded as part of the API but may in future be supplemented or replaced by interfaces using Fortran 2003’s <code class="code">bind(C)</code>.</p>
</section>
<section id="re-encoding" class="level2 section" data-number="6.12">
<h2 class="section anchored" data-number="6.12" data-anchor-id="re-encoding"><span class="header-section-number">6.12</span> Re-encoding</h2>
<p>R has its own C-level interface to the encoding conversion capabilities provided by <code class="code">iconv</code> because there are incompatibilities between the declarations in different implementations of <code class="code">iconv</code>.</p>
<p>These are declared in header file <samp class="file">R_ext/Riconv.h</samp>.</p>
<p><span id="index-Riconv_005fopen" class="index-entry-id"></span> <span id="index-Riconv_005fopen-1" class="index-entry-id"></span></p>
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">void *</code> <strong>Riconv_open</strong> <code class="def-code-arguments">(const char *</code><var class="var">to</var><code class="def-code-arguments">, const char *</code><var class="var">from</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Set up a pointer to an encoding object to be used to convert between two encodings: <code class="code">""</code> indicates the current locale.</p>
</dd>
<dt><span class="category-def">Function:</span><code class="def-type">size_t</code> <strong>Riconv</strong> <code class="def-code-arguments">(void *</code><var class="var">cd</var><code class="def-code-arguments">, const char **</code><var class="var">inbuf</var><code class="def-code-arguments">, size_t *</code><var class="var">inbytesleft</var><code class="def-code-arguments">, char **</code><var class="var">outbuf</var><code class="def-code-arguments">, size_t *</code><var class="var">outbytesleft</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Convert as much as possible of <code class="code">inbuf</code> to <code class="code">outbuf</code>. Initially the <code class="code">size_t</code> variables indicate the number of bytes available in the buffers, and they are updated (and the <code class="code">char</code> pointers are updated to point to the next free byte in the buffer). The return value is the number of characters converted, or <code class="code">(size_t)-1</code> (beware: <code class="code">size_t</code> is usually an unsigned type). It should be safe to assume that an error condition sets <code class="code">errno</code> to one of <code class="code">E2BIG</code> (the output buffer is full), <code class="code">EILSEQ</code> (the input cannot be converted, and might be invalid in the encoding specified) or <code class="code">EINVAL</code> (the input does not end with a complete multi-byte character).</p>
</dd>
</dl>
<p><span id="index-Riconv_005fclose" class="index-entry-id"></span> <span id="index-Riconv_005fclose-1" class="index-entry-id"></span></p>
<dl>
<dt><span class="category-def">Function:</span><code class="def-type">int</code> <strong>Riconv_close</strong> <code class="def-code-arguments">(void *</code><var class="var">cd</var><code class="def-code-arguments">)</code></dt>
<dd>
<p>Free the resources of an encoding object.</p>
</dd>
</dl>
</section>
<section id="condition-handling-and-cleanup-code" class="level2 section" data-number="6.13">
<h2 class="section anchored" data-number="6.13" data-anchor-id="condition-handling-and-cleanup-code"><span class="header-section-number">6.13</span> Condition handling and cleanup code</h2>
<p><span id="index-Condition-handling" class="index-entry-id"></span> <span id="index-Cleanup-code" class="index-entry-id"></span> <span id="index-Error-handling" class="index-entry-id"></span></p>
<p>Three functions are available for establishing condition handlers from within C code:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>SEXP R_tryCatchError<span class="op">(</span>SEXP <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>                     SEXP <span class="op">(*</span>hndlr<span class="op">)(</span>SEXP cond<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">);</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>SEXP R_tryCatch<span class="op">(</span>SEXP <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>                SEXP<span class="op">,</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>                SEXP <span class="op">(*</span>hndlr<span class="op">)(</span>SEXP cond<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">,</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>                <span class="dt">void</span> <span class="op">(*</span>clean<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>cdata<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>cdata<span class="op">);</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>SEXP R_withCallingErrorHandler<span class="op">(</span>SEXP <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                               SEXP <span class="op">(*</span>hndlr<span class="op">)(</span>SEXP cond<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span id="index-R_005ftryCatch" class="index-entry-id"></span> <span id="index-R_005ftryCatch-1" class="index-entry-id"></span> <span id="index-R_005fwithCallingErrorHandler" class="index-entry-id"></span> <span id="index-R_005fwithCallingErrorHandler-1" class="index-entry-id"></span></p>
<p><code class="code">R_tryCatchError</code> establishes an exiting handler for conditions inheriting form class <code class="code">error</code>.</p>
<p><code class="code">R_tryCatch</code> can be used to establish a handler for other conditions and to register a cleanup action. The conditions to be handled are specified as a character vector (<code class="code">STRSXP</code>). A <code class="code">NULL</code> pointer can be passed as <code class="code">fun</code> or <code class="code">clean</code> if condition handling or cleanup are not needed.</p>
<p>These are currently implemented using the R-level <code class="code">tryCatch</code> mechanism so are subject to some overhead.</p>
<p><code class="code">R_withCallingErrorHandler</code> establishes a calling handler for conditions inheriting from class <code class="code">error</code>. It establishes the handler without calling back into R and will therefore be more efficient.</p>
<p>The function <code class="code">R_UnwindProtect</code> can be used to ensure that a cleanup action takes place on ordinary return as well as on a non-local transfer of control, which R implements as a <code class="code">longjmp</code>.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>SEXP R_UnwindProtect<span class="op">(</span>SEXP <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">void</span> <span class="op">(*</span>clean<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span> Rboolean jump<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>cdata<span class="op">,</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>                     SEXP cont<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code class="code">R_UnwindProtect</code> can be used in two ways. The simper usage, suitable for use in C code, passes <code class="code">NULL</code> for the <code class="code">cont</code> argument. <code class="code">R_UnwindProtect</code> will call <code class="code">fun(data)</code>. If <code class="code">fun</code> returns a value, then <code class="code">R_UnwindProtect</code> calls <code class="code">clean(cleandata, FALSE)</code> before returning the value returned by <code class="code">fun</code>. If <code class="code">fun</code> executes a non-local transfer of control, then <code class="code">clean(cleandata, TRUE)</code> is called, and the non-local transfer of control is resumed.</p>
<p>The second use pattern, suitable to support C++ stack unwinding, uses two additional functions:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>SEXP R_MakeUnwindCont<span class="op">();</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>NORET <span class="dt">void</span> R_ContinueUnwind<span class="op">(</span>SEXP cont<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code class="code">R_MakeUnwindCont</code> allocates a <em>continuation token</em> <code class="code">cont</code> to pass to <code class="code">R_UnwindProtect</code>. This token should be protected with <code class="code">PROTECT</code> before calling <code class="code">R_UnwindProtect</code>. When the <code class="code">clean</code> function is called with <code class="code">jump == TRUE</code>, indicating that R is executing a non-local transfer of control, it can throw a C++ exception to a C++ <code class="code">catch</code> outside the C++ code to be unwound, and then use the continuation token in the a call <code class="code">R_ContinueUnwind(cont)</code> to resume the non-local transfer of control within R.</p>
<p>An older interface for the simpler <code class="code">R_MakeUnwindCont</code> usage remains available:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>SEXP R_ExecWithCleanup<span class="op">(</span>SEXP <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>                       <span class="dt">void</span> <span class="op">(*</span>cleanfun<span class="op">)(</span><span class="dt">void</span> <span class="op">*),</span> <span class="dt">void</span> <span class="op">*</span>cleandata<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code class="code">cleanfun</code> is called on both regular returns and non-local transfers of control, but without an indication of which form of exit is occurring.</p>
<p>The function <code class="code">R_ToplevelExec</code> can be used to execute code without allowing any non-local transfers of control, including by user interrupts or invoking <code class="code">abort</code> restarts.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>Rboolean R_ToplevelExec<span class="op">(</span><span class="dt">void</span> <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The return value is <code class="code">TRUE</code> if <code class="code">fun</code> returns normally and <code class="code">FALSE</code> if <code class="code">fun</code> exits with a jump to top level. <code class="code">fun</code> is called with a new top-level context. Condition handlers and other features of the current top level context when <code class="code">R_ToplevelExec</code> is called will not be seen by the code in <code class="code">fun</code>. Two convenience functions built on <code class="code">R_ToplevelExec</code> are <code class="code">R_tryEval</code> and <code class="code">R_tryEvalSilent</code>.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>SEXP R_tryEval<span class="op">(</span>SEXP e<span class="op">,</span> SEXP env<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ErrorOccurred<span class="op">);</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>SEXP R_tryEvalSilent<span class="op">(</span>SEXP e<span class="op">,</span> SEXP env<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ErrorOccurred<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span id="index-R_005ftryEvalSilent-1" class="index-entry-id"></span> <span id="index-R_005ftryEval" class="index-entry-id"></span> <span id="index-R_005ftryEval-1" class="index-entry-id"></span></p>
<p>These return a <code class="code">NULL</code> pointer if evaluating the expression results in a jump to top level.</p>
<p>Using <code class="code">R_ToplevelExec</code> is usually only appropriate in situations where one might want to run code in a separate thread if that was an option. For example, finalizers are run in a separate top level context. The other functions mentioned in this section will usually be more appropriate choices.</p>
</section>
<section id="allowing-interrupts" class="level2 section" data-number="6.14">
<h2 class="section anchored" data-number="6.14" data-anchor-id="allowing-interrupts"><span class="header-section-number">6.14</span> Allowing interrupts</h2>
<p>No part of R can be interrupted whilst running long computations in compiled code, so programmers should make provision for the code to be interrupted at suitable points by calling from C</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Utils.h&gt;</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_CheckUserInterrupt<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and from Fortran</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>subroutine <span class="fu">rchkusr</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These check if the user has requested an interrupt, and if so branch to R’s error signaling functions.</p>
<p>Note that it is possible that the code behind one of the entry points defined here if called from your C or Fortran code could be interruptible or generate an error and so not return to your code.</p>
</section>
<section id="c-stack-checking" class="level2 section" data-number="6.15">
<h2 class="section anchored" data-number="6.15" data-anchor-id="c-stack-checking"><span class="header-section-number">6.15</span> C stack checking</h2>
<p>R provides a framework for detecting when the amount of C stack is too low. Two functions are available:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>void <span class="fu">R_CheckStack</span>(void)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>void <span class="fu">R_CheckStack2</span>(size_t extra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span id="index-R_005fCheckStack" class="index-entry-id"></span> <span id="index-R_005fCheckStack-1" class="index-entry-id"></span> <span id="index-R_005fCheckStack2" class="index-entry-id"></span></p>
<p>These functions signal an error when a low stack condition is detected. <code class="code">R_CheckStack2</code> does so when <code class="code">extra</code> bytes are more than is available on the stack.</p>
<p>This mechanism is not always available (See <a href="Linking-GUIs-and-other-front-ends-to-R.html#threading-issues" class="xref">Threading issues</a>) and it is best to avoid deep recursions in C and to track recursion depth when using recursion is unavoidable. C compilers will often optimize tail recursions to avoid consuming C stack, so it is best to write code in a tail-recursive form when possible.</p>
</section>
<section id="custom-serialization-input-and-output" class="level2 section" data-number="6.16">
<h2 class="section anchored" data-number="6.16" data-anchor-id="custom-serialization-input-and-output"><span class="header-section-number">6.16</span> Custom serialization input and output</h2>
<p>The internal serialization code uses a framework for serializing from and to different output media. This framework has been in use internally for some time, but its use in packages is highly experimental and may need to be changed or dropped once some experience is gained. Package authors considering using this framework should keep this in mind.</p>
<p>Client code will define a persistent stream structure with declarations like</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>struct R_outpstream_st out;</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>struct R_inpstream_st <span class="cf">in</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These are filled in by calling these functions with appropriate arguments:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_InitInPStream<span class="op">(</span>R_inpstream_t stream<span class="op">,</span> R_pstream_data_t data<span class="op">,</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>                     R_pstream_format_t type<span class="op">,</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">int</span> <span class="op">(*</span>inchar<span class="op">)(</span>R_inpstream_t<span class="op">),</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">void</span> <span class="op">(*</span>inbytes<span class="op">)(</span>R_inpstream_t<span class="op">,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">int</span><span class="op">),</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>                     SEXP <span class="op">(*</span>phook<span class="op">)(</span>SEXP<span class="op">,</span> SEXP<span class="op">),</span> SEXP pdata<span class="op">);</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_InitOutPStream<span class="op">(</span>R_outpstream_t stream<span class="op">,</span> R_pstream_data_t data<span class="op">,</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>                      R_pstream_format_t type<span class="op">,</span> <span class="dt">int</span> version<span class="op">,</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">void</span> <span class="op">(*</span>outchar<span class="op">)(</span>R_outpstream_t<span class="op">,</span> <span class="dt">int</span><span class="op">),</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">void</span> <span class="op">(*</span>outbytes<span class="op">)(</span>R_outpstream_t<span class="op">,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">int</span><span class="op">),</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>                      SEXP <span class="op">(*</span>phook<span class="op">)(</span>SEXP<span class="op">,</span> SEXP<span class="op">),</span> SEXP pdata<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Code should not depend on the fields of the stream structures. Simpler initializers are available for serializing to or from a file pointer:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_InitFileOutPStream<span class="op">(</span>R_outpstream_t stream<span class="op">,</span> <span class="dt">FILE</span> <span class="op">*</span>fp<span class="op">,</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>                          R_pstream_format_t type<span class="op">,</span> <span class="dt">int</span> version<span class="op">,</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>                          SEXP <span class="op">(*</span>phook<span class="op">)(</span>SEXP<span class="op">,</span> SEXP<span class="op">),</span> SEXP pdata<span class="op">);</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_InitFileInPStream<span class="op">(</span>R_inpstream_t stream<span class="op">,</span> <span class="dt">FILE</span> <span class="op">*</span>fp<span class="op">,</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>                         R_pstream_format_t type<span class="op">,</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>                         SEXP <span class="op">(*</span>phook<span class="op">)(</span>SEXP<span class="op">,</span> SEXP<span class="op">),</span> SEXP pdata<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once the stream structures are set up they can be used by calling</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_Serialize<span class="op">(</span>SEXP s<span class="op">,</span> R_outpstream_t stream<span class="op">)</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>SEXP R_Unserialize<span class="op">(</span>R_inpstream_t stream<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Examples can be found in the R sources in <samp class="file">src/main/serialize.c</samp>. <span id="index-R_005fInitFileOutPStream" class="index-entry-id"></span></p>
<p><span id="index-R_005fSerialize" class="index-entry-id"></span> <span id="index-R_005fSerialize-1" class="index-entry-id"></span></p>
</section>
<section id="platform-and-version-information" class="level2 section" data-number="6.17">
<h2 class="section anchored" data-number="6.17" data-anchor-id="platform-and-version-information"><span class="header-section-number">6.17</span> Platform and version information</h2>
<p><span id="index-Version-information-from-C" class="index-entry-id"></span> <span id="index-OpenMP-1" class="index-entry-id"></span> <span id="index-R_005fVersion" class="index-entry-id"></span></p>
<p>The header files define <code class="code">USING_R</code>, which can be used to test if the code is indeed being used with R.</p>
<p>Header file <samp class="file">Rconfig.h</samp> (included by <samp class="file">R.h</samp>) is used to define platform-specific macros that are mainly for use in other header files. The macro <code class="code">WORDS_BIGENDIAN</code> is defined on big-endian<a href="#FOOT173" id="DOCF173" class="footnote"><sup>173</sup></a> systems (e.g.&nbsp;most OSes on Sparc and PowerPC hardware) and not on little-endian systems (nowadays all the commoner R platforms). It can be useful when manipulating binary files. NB: these macros apply only to the C compiler used to build R, not necessarily to another C or C++ compiler.</p>
<p>Header file <samp class="file">Rversion.h</samp> (<strong>not</strong> included by <samp class="file">R.h</samp>) defines a macro <code class="code">R_VERSION</code> giving the version number encoded as an integer, plus a macro <code class="code">R_Version</code> to do the encoding. This can be used to test if the version of R is late enough, or to include back-compatibility features. For protection against very old versions of R which did not have this macro, use a construction such as</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined(R_VERSION) &amp;&amp; R_VERSION &gt;= R_Version(3, 1, 0)</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>More detailed information is available in the macros <code class="code">R_MAJOR</code>, <code class="code">R_MINOR</code>, <code class="code">R_YEAR</code>, <code class="code">R_MONTH</code> and <code class="code">R_DAY</code>: see the header file <samp class="file">Rversion.h</samp> for their format. Note that the minor version includes the patch level (as in <samp class="samp">2.2</samp>’).</p>
<p>Packages which use <code class="code">alloca</code> need to ensure it is defined: as it is part of neither C nor POSIX there is no standard way to do so. One can use</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rconfig.h&gt;</span><span class="pp"> </span><span class="co">// for HAVE_ALLOCA_H</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef __GNUC__</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co">// this covers gcc, clang, icc</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="pp"># undef alloca</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="pp"># define alloca</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> __builtin_alloca</span><span class="op">((</span><span class="pp">x</span><span class="op">))</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(HAVE_ALLOCA_H)</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="co">// needed for native compilers on Solaris and AIX</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="pp"># include </span><span class="im">&lt;alloca.h&gt;</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(and this should be included before standard C headers such as <samp class="file">stdlib.h</samp>, since on some platforms these include <samp class="file">malloc.h</samp> which may have a conflicting definition), which suffices for known R platforms.</p>
</section>
<section id="inlining-c-functions" class="level2 section" data-number="6.18">
<h2 class="section anchored" data-number="6.18" data-anchor-id="inlining-c-functions"><span class="header-section-number">6.18</span> Inlining C functions</h2>
<p><span id="index-R_005fINLINE" class="index-entry-id"></span> <span id="index-R_005fINLINE-1" class="index-entry-id"></span></p>
<p>The C99 keyword <code class="code">inline</code> should be recognized by all compilers nowadays used to build R. Portable code which might be used with earlier versions of R can be written using the macro <code class="code">R_INLINE</code> (defined in file <samp class="file">Rconfig.h</samp> included by <samp class="file">R.h</samp>), as for example from package <a href="https://CRAN.R-project.org/package=cluster" class="url"><strong>cluster</strong></a></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> R_INLINE <span class="dt">int</span> ind_2<span class="op">(</span><span class="dt">int</span> l<span class="op">,</span> <span class="dt">int</span> j<span class="op">)</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Be aware that using inlining with functions in more than one compilation unit is almost impossible to do portably, see <a href="https://www.greenend.org.uk/rjk/tech/inline.html" class="uref">https://www.greenend.org.uk/rjk/tech/inline.html</a>, so this usage is for <code class="code">static</code> functions as in the example. All the R configure code has checked is that <code class="code">R_INLINE</code> can be used in a single C file with the compiler used to build R. We recommend that packages making extensive use of inlining include their own configure code.</p>
</section>
<section id="controlling-visibility" class="level2 section" data-number="6.19">
<h2 class="section anchored" data-number="6.19" data-anchor-id="controlling-visibility"><span class="header-section-number">6.19</span> Controlling visibility</h2>
<p>Header <samp class="file">R_ext/Visibility.h</samp> has some definitions for controlling the visibility of entry points. These are only effective when <samp class="samp">HAVE_VISIBILITY_ATTRIBUTE</samp>’ is defined – this is checked when R is configured and recorded in header <samp class="file">Rconfig.h</samp> (included by <samp class="file">R_ext/Visibility.h</samp>). It is often defined on modern Unix-alikes with a recent compiler<a href="#FOOT174" id="DOCF174" class="footnote"><sup>174</sup></a> but not supported on Windows. Minimizing the visibility of symbols in a shared library will both speed up its loading (unlikely to be significant) and reduce the possibility of linking to other entry points of the same name.</p>
<p>C/C++ entry points prefixed by <code class="code">attribute_hidden</code> will not be visible in the shared object. There is no comparable mechanism for Fortran entry points, but there is a more comprehensive scheme used by, for example package <strong>stats</strong>. Most compilers which allow control of visibility will allow control of visibility for all symbols <em>via</em> a flag, and where known the flag is encapsulated in the macros <samp class="samp">C_VISIBILITY</samp>‘, <samp class="samp">CXX_VISIBILITY</samp>’<a href="#FOOT175" id="DOCF175" class="footnote"><sup>175</sup></a> and <samp class="samp">F_VISIBILITY</samp>’ for C, C++ and Fortran compilers.<a href="#FOOT176" id="DOCF176" class="footnote"><sup>176</sup></a> These are defined in <samp class="file">etc/Makeconf</samp> and so available for normal compilation of package code. For example, <samp class="file">src/Makevars</samp> could include some of</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>PKG_CFLAGS<span class="op">=</span>$<span class="op">(</span>C_VISIBILITY<span class="op">)</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>PKG_CXXFLAGS<span class="op">=</span>$<span class="op">(</span>CXX_VISIBILITY<span class="op">)</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>PKG_FFLAGS<span class="op">=</span>$<span class="op">(</span>F_VISIBILITY<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This would end up with <strong>no</strong> visible entry points, which would be pointless. However, the effect of the flags can be overridden by using the <code class="code">attribute_visible</code> prefix. A shared object which registers its entry points needs only for have one visible entry point, its initializer, so for example package <strong>stats</strong> has</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> attribute_visible R_init_stats<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    R_registerRoutines<span class="op">(</span>dll<span class="op">,</span> CEntries<span class="op">,</span> CallEntries<span class="op">,</span> FortEntries<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    R_useDynamicSymbols<span class="op">(</span>dll<span class="op">,</span> FALSE<span class="op">);</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Because the <samp class="samp">C_VISIBILITY</samp>’ mechanism is only useful in conjunction with <code class="code">attribute_visible</code>, it is not enabled unless <samp class="samp">HAVE_VISIBILITY_ATTRIBUTE</samp>’ is defined. The usual visibility flag is <samp class="option">-fvisibility=hidden</samp>: some compilers also support <samp class="option">-fvisibility-inlines-hidden</samp> which can be used by overriding <samp class="samp">C_VISIBILITY</samp>’ and <samp class="samp">CXX_VISIBILITY</samp>’ in <samp class="file">config.site</samp> when building R, or editing <samp class="file">etc/Makeconf</samp> in the R installation.</p>
<p>Note that <code class="command">configure</code> only checks that visibility attributes and flags are accepted, not that they actually hide symbols.</p>
<p>The visibility mechanism is not available on Windows, but there is an equally effective way to control which entry points are visible, by supplying a definitions file <var class="var">pkgname</var><samp class="file">/src/</samp><var class="var">pkgname</var><samp class="file">-win.def</samp>: only entry points listed in that file will be visible. Again using <strong>stats</strong> as an example, it has</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>LIBRARY stats<span class="op">.</span>dll</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>EXPORTS</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a> R_init_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="using-these-functions-in-your-own-c-code" class="level2 section" data-number="6.20">
<h2 class="section anchored" data-number="6.20" data-anchor-id="using-these-functions-in-your-own-c-code"><span class="header-section-number">6.20</span> Using these functions in your own C code</h2>
<p>It is possible to build <code class="code">Mathlib</code>, the R set of mathematical functions documented in <samp class="file">Rmath.h</samp>, as a standalone library <samp class="file">libRmath</samp> under both Unix-alikes and Windows. (This includes the functions documented in <a href="#numerical-analysis-subroutines" class="ref">Numerical analysis subroutines</a> as from that header file.)</p>
<p>The library is not built automatically when R is installed. For further details see <a href="https://cran.r-project.org/doc/manuals/R-admin.html#The-standalone-Rmath-library" data-manual="R-admin">The standalone Rmath library</a> in R Installation and Administration.</p>
</section>
<section id="organization-of-header-files" class="level2 section" data-number="6.21">
<h2 class="section anchored" data-number="6.21" data-anchor-id="organization-of-header-files"><span class="header-section-number">6.21</span> Organization of header files</h2>
<p>The header files which R installs are in directory <var class="var">R_INCLUDE_DIR</var> (default <var class="var">R_HOME</var><samp class="file">/include</samp>). This currently includes</p>
<blockquote class="blockquote">
<table class="caption-top table">
<tbody>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R.h</samp></td>
<td style="text-align: left;">includes many other files</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">Rinternals.h</samp></td>
<td style="text-align: left;">definitions for using R’s internal structures</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">Rdefines.h</samp></td>
<td style="text-align: left;">macros for an S-like interface to the above (no longer maintained)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">Rmath.h</samp></td>
<td style="text-align: left;">standalone math library</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">Rversion.h</samp></td>
<td style="text-align: left;">R version information</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">Rinterface.h</samp></td>
<td style="text-align: left;">for add-on front-ends (Unix-alikes only)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">Rembedded.h</samp></td>
<td style="text-align: left;">for add-on front-ends</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Applic.h</samp></td>
<td style="text-align: left;">optimization, integration and some LAPACK ones)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/BLAS.h</samp></td>
<td style="text-align: left;">C definitions for BLAS routines</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Callbacks.h</samp></td>
<td style="text-align: left;">C (and R function) top-level task handlers</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/GetX11Image.h</samp></td>
<td style="text-align: left;">X11Image interface used by package <strong>trkplot</strong></td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Lapack.h</samp></td>
<td style="text-align: left;">C definitions for some LAPACK routines</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/Linpack.h</samp></td>
<td style="text-align: left;">C definitions for some LINPACK routines, not all of which are included in R</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Parse.h</samp></td>
<td style="text-align: left;">a small part of R’s parse interface: not part of the stable API.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/RStartup.h</samp></td>
<td style="text-align: left;">for add-on front-ends</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Rdynload.h</samp></td>
<td style="text-align: left;">needed to register compiled code in packages</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/Riconv.h</samp></td>
<td style="text-align: left;">interface to <code class="code">iconv</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Visibility.h</samp></td>
<td style="text-align: left;">definitions controlling visibility</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/eventloop.h</samp></td>
<td style="text-align: left;">for add-on front-ends and for packages that need to share in the R event loops (not Windows)</td>
</tr>
</tbody>
</table>
</blockquote>
<p>The following headers are included by <samp class="file">R.h</samp>:</p>
<blockquote class="blockquote">
<table class="caption-top table">
<tbody>
<tr class="odd">
<td style="text-align: left;"><samp class="file">Rconfig.h</samp></td>
<td style="text-align: left;">configuration info that is made available</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Arith.h</samp></td>
<td style="text-align: left;">handling for <code class="code">NA</code>s, <code class="code">NaN</code>s, <code class="code">Inf</code>/<code class="code">-Inf</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/Boolean.h</samp></td>
<td style="text-align: left;"><code class="code">TRUE</code>/<code class="code">FALSE</code> type</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Complex.h</samp></td>
<td style="text-align: left;">C typedefs for R’s <code class="code">complex</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/Constants.h</samp></td>
<td style="text-align: left;">constants</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Error.h</samp></td>
<td style="text-align: left;">error signaling</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/Memory.h</samp></td>
<td style="text-align: left;">memory allocation</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Print.h</samp></td>
<td style="text-align: left;"><code class="code">Rprintf</code> and variations.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/RS.h</samp></td>
<td style="text-align: left;">definitions common to <samp class="file">R.h</samp> and the former <samp class="file">S.h</samp>, including <code class="code">F77_CALL</code> etc.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/Random.h</samp></td>
<td style="text-align: left;">random number generation</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><samp class="file">R_ext/Utils.h</samp></td>
<td style="text-align: left;">sorting and other utilities</td>
</tr>
<tr class="even">
<td style="text-align: left;"><samp class="file">R_ext/libextern.h</samp></td>
<td style="text-align: left;">definitions for exports from <samp class="file">R.dll</samp> on Windows.</td>
</tr>
</tbody>
</table>
</blockquote>
<p>The graphics systems are exposed in headers <samp class="file">R_ext/GraphicsEngine.h</samp>, <samp class="file">R_ext/GraphicsDevice.h</samp> (which it includes) and <samp class="file">R_ext/QuartzDevice.h</samp>. Facilities for defining custom connection implementations are provided in <samp class="file">R_ext/Connections.h</samp>, but make sure you consult the file before use.</p>
<p>Let us re-iterate the advice to include in C++ code system headers before the R header files, especially <samp class="file">Rinternals.h</samp> (included by <samp class="file">Rdefines.h</samp>) and <samp class="file">Rmath.h</samp>, which redefine names which may be used in system headers, or (preferably and the default since R 4.5.0) to define <code class="code">R_NO_REMAP</code>.</p>
</section>
<section id="moving-into-c-api-compliance" class="level2 section" data-number="6.22">
<h2 class="section anchored" data-number="6.22" data-anchor-id="moving-into-c-api-compliance"><span class="header-section-number">6.22</span> Moving into C API compliance</h2>
<p>Work is in progress to clarify and tighten the C API for extending R code. This will help make package C code more robust, and will facilitate maintaining and improving the R source code without impacting package space. In the process a number of entry points intended for internal use will be removed from installed header files or hidden, and others will be replaced by more robust versions better suited for use in package C code. This section describes how packages can move from using non-API entry points to using ones available and supported in the API.</p>
<p><strong>Work in progress:</strong> This section is a work in progress and will be adjusted as changes are made to the API.</p>
<section id="some-api-replacements-for-non-api-entry-points" class="level3 subsection" data-number="6.22.1">
<h3 class="subsection anchored" data-number="6.22.1" data-anchor-id="some-api-replacements-for-non-api-entry-points"><span class="header-section-number">6.22.1</span> Some API replacements for non-API entry points</h3>
<p>Some non-API entry points intended for internal use have long had entry points in the API that can be used instead. In other cases new entry point have been added that are more appropriate for use in packages; typically these include more extensive error checking on arguments.</p>
<p>This table lists some non-API functions used in packages and the API functions that should be used instead:</p>
<p><code class="code">EXTPTR_PROT</code><br>
<code class="code">EXTPTR_TAG</code><br>
<code class="code">EXTPTR_PTR</code></p>
<p>: Use <code class="code">R_ExternalPtrProtected</code>, <code class="code">R_ExternalPtrTag</code>, and <code class="code">R_ExternalPtrAddr</code>.</p>
<p><code class="code">OBJECT</code><br>
<code class="code">IS_S4_OBJECT</code></p>
<p>: Use <code class="code">Rf_isObject</code> and <code class="code">Rf_isS4</code>.</p>
<dl>
<dt><code class="code">GetOption</code></dt>
<dd>
<p>Use <code class="code">Rf_GetOption1</code>.</p>
</dd>
<dt><code class="code">R_lsInternal</code></dt>
<dd>
<p>Use <code class="code">R_lsInternal3</code>.</p>
</dd>
</dl>
<p><code class="code">REAL0</code><br>
<code class="code">COMPLEX0</code></p>
<p>: Use <code class="code">REAL</code> and <code class="code">COMPLEX</code>.</p>
<p><code class="code">STRING_PTR</code><br>
<code class="code">DATAPTR</code><br>
<code class="code">STDVEC_DATAPTR</code></p>
<p>: Use <code class="code">STRING_PTR_RO</code> and <code class="code">DATAPTR_RO</code>. Obtaining writable pointers to these data can violate the memory manager’s integrity assumptions and is not supported.</p>
<dl>
<dt><code class="code">isFrame</code></dt>
<dd>
<p>Use <code class="code">Rf_isDataFrame</code>, added in R 4.5.0.</p>
</dd>
</dl>
<p><code class="code">BODY</code><br>
<code class="code">FORMALS</code><br>
<code class="code">CLOENV</code></p>
<p>: Use <code class="code">R_ClosureBody</code>, <code class="code">R_ClosureFormals</code>, and <code class="code">R_ClosureEnv</code>; these were added in R 4.5.0.</p>
<dl>
<dt><code class="code">ENCLOS</code></dt>
<dd>
<p>Use <code class="code">R_ParentEnv</code>, added in R 4.5.0.</p>
</dd>
<dt><code class="code">IS_ASCII</code></dt>
<dd>
<p>Use <code class="code">Rf_charIsASCII</code>, added in R 4.5.0.</p>
</dd>
<dt><code class="code">IS_UTF8</code></dt>
<dd>
<p>Use <code class="code">charIsUTF8</code>, added in R 4.5.0, or avoid completely.</p>
</dd>
<dt><code class="code">Rf_allocSExp</code></dt>
<dd>
<p>Use an appropriate constructor.</p>
</dd>
<dt><code class="code">Rf_findVarInFrame3</code></dt>
<dd>
<p>Use <code class="code">R_existsVarInFrame</code> to test for existence.</p>
</dd>
</dl>
<p><code class="code">Rf_findVar</code><br>
<code class="code">Rf_findVarInFrame</code></p>
<p>: Use <code class="code">R_getVar</code> or <code class="code">R_getVarEx</code>, added in R 4.5.0. In some cases using <code class="code">eval</code> may suffice.</p>
<dl>
<dt><code class="code">ATTRIB</code></dt>
<dd>
<p>Use <code class="code">Rf_getAttrib</code> for individual attributes. To test whether there are any attributes use <code class="code">ANY_ATTRIB</code>, added in R 4.5.0.</p>
</dd>
</dl>
<p><code class="code">SET_ATTRIB</code><br>
<code class="code">SET_OBJECT</code></p>
<p>: Use <code class="code">Rf_setAttrib</code> for individual attributes, <code class="code">DUPLICATE_ATTRIB</code> or <code class="code">SHALLOW_DUPLICATE_ATTRIB</code> for copying attributes from one object to another. Use <code class="code">CLEAR_ATTRIB</code> for removing all attributes, added in R 4.5.0.</p>
<dl>
<dt><code class="code">R_GetCurrentEnv</code></dt>
<dd>
<p>Use <code class="code">environment()</code> at the R level and pass the result as an argument to your C function.</p>
</dd>
</dl>
<p>For recently added entry points packages that need to be compiled under older versions that do not yet contain these entry points can use back-ported versions defined conditionally. See <a href="#some-backports" class="xref">Some backports</a>.</p>
</section>
<section id="creating-environments" class="level3 subsection" data-number="6.22.2">
<h3 class="subsection anchored" data-number="6.22.2" data-anchor-id="creating-environments"><span class="header-section-number">6.22.2</span> Creating environments</h3>
<p>An idiom appearing in a number of packages is to create an environment as</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>SEXP env <span class="op">=</span> Rf_allocSExp<span class="op">(</span>ENVSXP<span class="op">);</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>SET_ENCLOS<span class="op">(</span>env<span class="op">,</span> parent<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The function <code class="code">Rf_allocSExp</code> and mutation functions like <code class="code">SET_ENCLOS</code>, <code class="code">SET_FRAME</code>, and <code class="code">SET_HASHTAB</code> are not part of the API as they expose internal structure that might need to change in the future. A proper constructor function should be used instead. The constructor function for environments is <code class="code">R_NewEnv</code>, so the new environment should be created as</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>SEXP env <span class="op">=</span> R_NewEnv<span class="op">(</span>parent<span class="op">,</span> FALSE<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="creating-call-expressions" class="level3 subsection" data-number="6.22.3">
<h3 class="subsection anchored" data-number="6.22.3" data-anchor-id="creating-call-expressions"><span class="header-section-number">6.22.3</span> Creating call expressions</h3>
<p>Another idiom used in some packages is to create a call expression with space for two arguments as</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>SEXP expr <span class="op">=</span> Rf_allocList<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>SET_TYPEOF<span class="op">(</span>expr<span class="op">,</span> <span class="st">"LANGSXP"</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and then fill in the function and argument expressions. <code class="code">SET_TYPEOF</code> will also not be available to packages in the future. An alternative way to construct the expression that will work in any R version is</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>SEXP expr <span class="op">=</span> LCONS<span class="op">(</span>R_NilValue<span class="op">,</span> allocList<span class="op">(</span><span class="dv">2</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>R 4.4.1 added the constructor <code class="code">Rf_allocLang</code>, so the expression can be created as</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>SEXP env <span class="op">=</span> Rf_allocLang<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="creating-closures" class="level3 subsection" data-number="6.22.4">
<h3 class="subsection anchored" data-number="6.22.4" data-anchor-id="creating-closures"><span class="header-section-number">6.22.4</span> Creating closures</h3>
<p>Yet another common idiom is to create a new closure as</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>SEXP fun <span class="op">=</span> Rf_allocSExp<span class="op">(</span>CLOSXP<span class="op">);</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>SET_FORMALS<span class="op">(</span>fun<span class="op">,</span> formals<span class="op">);</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>SET_BODY<span class="op">(</span>fun<span class="op">,</span> body<span class="op">);</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>SET_CLOENV<span class="op">(</span>fun<span class="op">,</span> env<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>R 4.5.0 adds the constructor <code class="code">R_mkClosure</code>; this can be used as</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>SEXP fun <span class="op">=</span> R_mkClosure<span class="op">(</span>formals<span class="op">,</span> body<span class="op">,</span> env<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="querying-charsxp-encoding" class="level3 subsection" data-number="6.22.5">
<h3 class="subsection anchored" data-number="6.22.5" data-anchor-id="querying-charsxp-encoding"><span class="header-section-number">6.22.5</span> Querying <code class="code">CHARSXP</code> encoding</h3>
<p>A number of packages query encoding bits set on <code class="code">CHARSXP</code> objects via macros <code class="code">IS_ASCII</code> and <code class="code">IS_UTF8</code>, some packages also via <code class="code">IS_BYTES</code> and <code class="code">IS_LATIN1</code>. These macros are not part of the API and packages have been copying their definition and directly accessing the bits in memory. The structure of the object header is, however, internal to R and may have to change in the future.</p>
<p><code class="code">IS_ASCII</code> can be replaced by <code class="code">Rf_charIsASCII</code>, added in R 4.5.0. It can also be replaced by code that checks individual characters (bytes).</p>
<p>Information provided by the other macros is available via function <code class="code">Rf_getCharCE</code>, which has been part of the API since R 2.7.0. Before switching to <code class="code">Rf_getCharCE</code>, packages are, however, advised to check whether the encoding information is really needed and whether it is used correctly.</p>
<p>Most code should be able to work with complete <code class="code">CHARSXP</code>s and never look at the individual bytes. When access to characters and bytes (of strings other than <code class="code">CE_BYTES</code>) is needed, one would use <code class="code">Rf_translateChar</code> or <code class="code">Rf_translateCharUTF8</code>. These functions internally already check the encoding and whether the string is ASCII and only translate when needed, which should be rarely since R &gt;= 4.2.0 (UTF-8 is used as native encoding on most systems running R).</p>
<p>Several packages use the encoding information to find out whether an internal string representation visible via <code class="code">CHAR</code> is UTF-8 or latin1. R 4.5.0 provides functions <code class="code">Rf_charIsUTF8</code> and <code class="code">Rf_charIsLatin1</code> for this purpose, which are safer against future changes and handle also native strings when running in the corresponding locale. Note that both will be true for ASCII strings.</p>
<p>A pattern used in several packages is</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>asutf8<span class="op">(</span>SEXP c<span class="op">)</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>IS_UTF8<span class="op">(</span>s<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>IS_ASCII<span class="op">(</span>s<span class="op">))</span>  <span class="co">// not compliant</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Rf_translateCharUTF8<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>   <span class="cf">else</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> CHAR<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to make this code compliant, simply call</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>asutf8<span class="op">(</span>SEXP c<span class="op">)</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Rf_translateCharUTF8<span class="op">(</span>s<span class="op">);</span> <span class="co">// compliant</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>as the encoding flags are already checked in <code class="code">Rf_translateCharUTF8</code>. Also note the non-compliant check does not handle native encoding.</p>
</section>
<section id="working-with-attributes" class="level3 subsection" data-number="6.22.6">
<h3 class="subsection anchored" data-number="6.22.6" data-anchor-id="working-with-attributes"><span class="header-section-number">6.22.6</span> Working with attributes</h3>
<p>The current implementation (R 4.5.0) represents attributes internally as a linked list. It may be useful to change this at some point, so external code should not rely on this representation. The low-level functions <code class="code">ATTRIB</code> and <code class="code">SET_ATTRIB</code> reveal this representation and are therefore not part of the API. Individual attributes can be accessed and set with <code class="code">Rf_getAttrib</code> and <code class="code">Rf_setAttrib</code>. Attributes can be copied from one object to another with <code class="code">DUPLICATE_ATTRIB</code> and <code class="code">SHALLOW_DUPLICATE_ATTRIB</code>. The <code class="code">CLEAR_ATTRIB</code> function added in R 4.5.0 can be used to remove all attributes. These functions ensure can that certain consistency requirements are maintained, such as setting the object bit according to whether a class attribute is present.</p>
<p>Some additional functions may be added for working with attributes.</p>
</section>
<section id="working-variable-bindings" class="level3 subsection" data-number="6.22.7">
<h3 class="subsection anchored" data-number="6.22.7" data-anchor-id="working-variable-bindings"><span class="header-section-number">6.22.7</span> Working variable bindings</h3>
<p>The functions <code class="code">Rf_findVar</code> and <code class="code">Rf_findVarInFrame</code> have been used in a number of packages but are too low level to be part of the API. For most uses the functions <code class="code">R_getVar</code> and <code class="code">R_getVarEx</code> added in R 4.5.0 will be sufficient. These are analogous to the R functions <code class="code">get</code> and <code class="code">get0</code>.</p>
<p>In rare cases package R or C code may want to obtain more detailed information on a binding, such as whether the binding is delayed or not. This is currently not possible within the API, but is under consideration.</p>
</section>
<section id="some-backports" class="level3 subsection" data-number="6.22.8">
<h3 class="subsection anchored" data-number="6.22.8" data-anchor-id="some-backports"><span class="header-section-number">6.22.8</span> Some backports</h3>
<p>This section lists backports of recently added definitions that can be used in packages that need to be compiled under older versions of R that do not yet contain these entry points.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if R_VERSION &lt; R_Version(4, 4, 1)</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define allocLang </span>Rf_allocLang</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>SEXP Rf_allocLang<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> LCONS<span class="op">(</span>R_NilValue<span class="op">,</span> Rf_allocList<span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> R_NilValue<span class="op">;</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#if R_VERSION &lt; R_Version(4, 5, 0)</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a><span class="pp"># define isDataFrame</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> </span>Rf_isFrame<span class="op">(</span><span class="pp">x</span><span class="op">)</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a><span class="pp"># define R_ClosureFormals</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> FORMALS</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="pp"># define R_ClosureEnv</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> CLOENV</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a><span class="pp"># define R_ParentEnv</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> ENCLOS</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>SEXP R_mkClosure<span class="op">(</span>SEXP formals<span class="op">,</span> SEXP body<span class="op">,</span> SEXP env<span class="op">)</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    SEXP fun <span class="op">=</span> Rf_allocSExp<span class="op">(</span>CLOSXP<span class="op">);</span></span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    SET_FORMALS<span class="op">(</span>fun<span class="op">,</span> formals<span class="op">);</span></span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>    SET_BODY<span class="op">(</span>fun<span class="op">,</span> body<span class="op">);</span></span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>    SET_CLOENV<span class="op">(</span>fun<span class="op">,</span> env<span class="op">);</span></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fun<span class="op">;</span></span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> CLEAR_ATTRIB<span class="op">(</span>SEXP x<span class="op">)</span></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>    SET_ATTRIB<span class="op">(</span>x<span class="op">,</span> R_NilValue<span class="op">);</span></span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>    SET_OBJECT<span class="op">(</span>x<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>    UNSET_S4_OBJECT<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./System-and-foreign-language-interfaces.html" class="pagination-link" aria-label="System and foreign language interfaces">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">System and foreign language interfaces</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Generic-functions-and-methods.html" class="pagination-link" aria-label="Generic functions and methods">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Generic functions and methods</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>A re-styled version of the original R manuals at <a href="https://cran.r-project.org/manuals.html" class="uri">https://cran.r-project.org/manuals.html</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built using <a href="https://quarto.org">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>