<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>R Manuals :: Writing R Extensions - 6&nbsp; The R API: entry points for C code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Generic-functions-and-methods.html" rel="next">
<link href="./System-and-foreign-language-interfaces.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">R Manuals :: Writing R Extensions</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-manuals" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Manuals</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-manuals">    
        <li>
    <a class="dropdown-item" href="./../r-intro/index.html" rel="" target="">
 <span class="dropdown-text">An Introduction to R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-data/index.html" rel="" target="">
 <span class="dropdown-text">R Data Import/Export</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-admin/index.html" rel="" target="">
 <span class="dropdown-text">R Installation and Administration</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-exts/index.html" rel="" target="">
 <span class="dropdown-text">Writing R Extensions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-lang/index.html" rel="" target="">
 <span class="dropdown-text">R Language Definition</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-ints/index.html" rel="" target="">
 <span class="dropdown-text">R Internals</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./The-R-API.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The R API: entry points for C code</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Writing R Extensions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Creating-R-packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Creating R packages</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Writing-R-documentation-files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Writing R documentation files</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Tidying-and-profiling-R-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Tidying and profiling R code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Debugging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Debugging</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./System-and-foreign-language-interfaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">System and foreign language interfaces</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./The-R-API.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The R API: entry points for C code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Generic-functions-and-methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Generic functions and methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Linking-GUIs-and-other-front-ends-to-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Linking GUIs and other front-ends to R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Function-and-variable-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Function and variable index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Concept-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Concept index</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#memory-allocation" id="toc-memory-allocation" class="nav-link active" data-scroll-target="#memory-allocation"><span class="header-section-number">6.1</span> Memory allocation</a>
  <ul class="collapse">
  <li><a href="#transient-storage-allocation" id="toc-transient-storage-allocation" class="nav-link" data-scroll-target="#transient-storage-allocation"><span class="header-section-number">6.1.1</span> Transient storage allocation</a></li>
  <li><a href="#user-controlled-memory" id="toc-user-controlled-memory" class="nav-link" data-scroll-target="#user-controlled-memory"><span class="header-section-number">6.1.2</span> User-controlled memory</a></li>
  </ul></li>
  <li><a href="#error-signaling" id="toc-error-signaling" class="nav-link" data-scroll-target="#error-signaling"><span class="header-section-number">6.2</span> Error signaling</a>
  <ul class="collapse">
  <li><a href="#error-signaling-from-fortran" id="toc-error-signaling-from-fortran" class="nav-link" data-scroll-target="#error-signaling-from-fortran"><span class="header-section-number">6.2.1</span> Error signaling from Fortran</a></li>
  </ul></li>
  <li><a href="#random-number-generation" id="toc-random-number-generation" class="nav-link" data-scroll-target="#random-number-generation"><span class="header-section-number">6.3</span> Random number generation</a></li>
  <li><a href="#missing-and-ieee-special-values" id="toc-missing-and-ieee-special-values" class="nav-link" data-scroll-target="#missing-and-ieee-special-values"><span class="header-section-number">6.4</span> Missing and IEEE special values</a></li>
  <li><a href="#printing" id="toc-printing" class="nav-link" data-scroll-target="#printing"><span class="header-section-number">6.5</span> Printing</a>
  <ul class="collapse">
  <li><a href="#printing-from-fortran" id="toc-printing-from-fortran" class="nav-link" data-scroll-target="#printing-from-fortran"><span class="header-section-number">6.5.1</span> Printing from Fortran</a></li>
  </ul></li>
  <li><a href="#calling-c-from-fortran-and-vice-versa" id="toc-calling-c-from-fortran-and-vice-versa" class="nav-link" data-scroll-target="#calling-c-from-fortran-and-vice-versa"><span class="header-section-number">6.6</span> Calling C from Fortran and vice versa</a>
  <ul class="collapse">
  <li><a href="#fortran-character-strings" id="toc-fortran-character-strings" class="nav-link" data-scroll-target="#fortran-character-strings"><span class="header-section-number">6.6.1</span> Fortran character strings</a></li>
  <li><a href="#fortran-logical" id="toc-fortran-logical" class="nav-link" data-scroll-target="#fortran-logical"><span class="header-section-number">6.6.2</span> Fortran LOGICAL</a></li>
  <li><a href="#passing-functions" id="toc-passing-functions" class="nav-link" data-scroll-target="#passing-functions"><span class="header-section-number">6.6.3</span> Passing functions</a></li>
  </ul></li>
  <li><a href="#numerical-analysis-subroutines" id="toc-numerical-analysis-subroutines" class="nav-link" data-scroll-target="#numerical-analysis-subroutines"><span class="header-section-number">6.7</span> Numerical analysis subroutines</a>
  <ul class="collapse">
  <li><a href="#distribution-functions" id="toc-distribution-functions" class="nav-link" data-scroll-target="#distribution-functions"><span class="header-section-number">6.7.1</span> Distribution functions</a></li>
  <li><a href="#mathematical-functions" id="toc-mathematical-functions" class="nav-link" data-scroll-target="#mathematical-functions"><span class="header-section-number">6.7.2</span> Mathematical functions</a></li>
  <li><a href="#numerical-utilities" id="toc-numerical-utilities" class="nav-link" data-scroll-target="#numerical-utilities"><span class="header-section-number">6.7.3</span> Numerical Utilities</a></li>
  <li><a href="#mathematical-constants" id="toc-mathematical-constants" class="nav-link" data-scroll-target="#mathematical-constants"><span class="header-section-number">6.7.4</span> Mathematical constants</a></li>
  </ul></li>
  <li><a href="#optimization" id="toc-optimization" class="nav-link" data-scroll-target="#optimization"><span class="header-section-number">6.8</span> Optimization</a></li>
  <li><a href="#integration" id="toc-integration" class="nav-link" data-scroll-target="#integration"><span class="header-section-number">6.9</span> Integration</a></li>
  <li><a href="#utility-functions" id="toc-utility-functions" class="nav-link" data-scroll-target="#utility-functions"><span class="header-section-number">6.10</span> Utility functions</a></li>
  <li><a href="#re-encoding" id="toc-re-encoding" class="nav-link" data-scroll-target="#re-encoding"><span class="header-section-number">6.11</span> Re-encoding</a></li>
  <li><a href="#condition-handling-and-cleanup-code" id="toc-condition-handling-and-cleanup-code" class="nav-link" data-scroll-target="#condition-handling-and-cleanup-code"><span class="header-section-number">6.12</span> Condition handling and cleanup code</a></li>
  <li><a href="#allowing-interrupts" id="toc-allowing-interrupts" class="nav-link" data-scroll-target="#allowing-interrupts"><span class="header-section-number">6.13</span> Allowing interrupts</a></li>
  <li><a href="#platform-and-version-information" id="toc-platform-and-version-information" class="nav-link" data-scroll-target="#platform-and-version-information"><span class="header-section-number">6.14</span> Platform and version information</a></li>
  <li><a href="#inlining-c-functions" id="toc-inlining-c-functions" class="nav-link" data-scroll-target="#inlining-c-functions"><span class="header-section-number">6.15</span> Inlining C functions</a></li>
  <li><a href="#controlling-visibility" id="toc-controlling-visibility" class="nav-link" data-scroll-target="#controlling-visibility"><span class="header-section-number">6.16</span> Controlling visibility</a></li>
  <li><a href="#using-these-functions-in-your-own-c-code" id="toc-using-these-functions-in-your-own-c-code" class="nav-link" data-scroll-target="#using-these-functions-in-your-own-c-code"><span class="header-section-number">6.17</span> Using these functions in your own C code</a></li>
  <li><a href="#organization-of-header-files" id="toc-organization-of-header-files" class="nav-link" data-scroll-target="#organization-of-header-files"><span class="header-section-number">6.18</span> Organization of header files</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The R API: entry points for C code</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>There are a large number of entry points in the R executable/DLL that can be called from C code (and some that can be called from Fortran code). Only those documented here are stable enough that they will only be changed with considerable notice.</p>
<p>The recommended procedure to use these is to include the header file <code>R.h</code> in your C code by</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will include several other header files from the directory <code>R_INCLUDE_DIR/R_ext</code>, and there are other header files there that can be included too, but many of the features they contain should be regarded as undocumented and unstable.</p>
<p>Most of these header files, including all those included by <code>R.h</code>, can be used from C++ code.</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> Because R re-maps many of its external names to avoid clashes with system or user code, it is <em>essential</em> to include the appropriate header files when using these entry points.</p>
</blockquote>
<div class="page-columns page-full"><p>This remapping can cause problems<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, and can be eliminated by defining <code>R_NO_REMAP</code> (before including any R headers) and prepending <code>Rf_</code> to <em>all</em> the function names used from <code>Rinternals.h</code> and <code>R_ext/Error.h</code>. These problems can usually be avoided by including other headers (such as system headers and those for external software used by the package) before any R headers. (Headers from other packages may include R headers directly or <em>via</em> inclusion from further packages, and may define <code>R_NO_REMAP</code> with or without including <code>Rinternals.h</code>.)</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;Known problems have been defining <code>LENGTH</code>, <code>error</code>, <code>length</code>, <code>vector</code> and <code>warning</code>: whether these matter depends on the OS and toolchain, with many problem reports involving <code>clang++</code>. As from LLVM <code>clang</code> 13.0.0, the remapping of <code>match</code> breaks the subsequent inclusion of <code>omp.h</code>.</p></li></div></div>
<p>We can classify the entry points as</p>
<dl>
<dt><em>API</em></dt>
<dd>
<p>Entry points which are documented in this manual and declared in an installed header file. These can be used in distributed packages and will only be changed after deprecation.</p>
</dd>
<dt><em>public</em></dt>
<dd>
<p>Entry points declared in an installed header file that are exported on all R platforms but are not documented and subject to change without notice.</p>
</dd>
<dt><em>private</em></dt>
<dd>
<p>Entry points that are used when building R and exported on all R platforms but are not declared in the installed header files. Do not use these in distributed code.</p>
</dd>
<dt><em>hidden</em></dt>
<dd>
<p>Entry points that are where possible (Windows and some modern Unix-alike compilers/loaders when using R as a shared library) not exported.</p>
</dd>
</dl>
<section id="memory-allocation" class="level2 section page-columns page-full" data-number="6.1">
<h2 class="section anchored" data-number="6.1" data-anchor-id="memory-allocation"><span class="header-section-number">6.1</span> Memory allocation</h2>
<p>There are two types of memory allocation available to the C programmer, one in which R manages the clean-up and the other in which user has full control (and responsibility).</p>
<p>These functions are declared in header <code>R_exts/RS.h</code> which is included by <code>R.h</code>.</p>
<section id="transient-storage-allocation" class="level3 subsection" data-number="6.1.1">
<h3 class="subsection anchored" data-number="6.1.1" data-anchor-id="transient-storage-allocation"><span class="header-section-number">6.1.1</span> Transient storage allocation</h3>
<p>Here R will reclaim the memory at the end of the call to <code>.C</code>, <code>.Call</code> or <code>.External</code>. Use</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>R_alloc<span class="op">(</span><span class="dt">size_t</span> n<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which allocates <code>n</code> units of <code>size</code> bytes each. A typical usage (from package <strong>stats</strong>) is</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="op">(</span><span class="dt">int</span> <span class="op">*)</span> R_alloc<span class="op">(</span>nrows<span class="op">(</span>merge<span class="op">)+</span><span class="dv">2</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(<code>size_t</code> is defined in <code>stddef.h</code> which the header defining <code>R_alloc</code> includes.)</p>
<p>There is a similar call, <code>S_alloc</code> (named for compatibility with older versions of S) which zeroes the memory allocated,</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>S_alloc<span class="op">(</span><span class="dt">long</span> n<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>S_realloc<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>p<span class="op">,</span> <span class="dt">long</span> new<span class="op">,</span> <span class="dt">long</span> old<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which (for <code>new &gt; old</code>) changes the allocation size from <code>old</code> to <code>new</code> units, and zeroes the additional units. NB: these calls are best avoided as <code>long</code> is insufficient for large memory allocations on 64-bit Windows (where it is limited to 2^31-1 bytes).</p>
<p>This memory is taken from the heap, and released at the end of the <code>.C</code>, <code>.Call</code> or <code>.External</code> call. Users can also manage it, by noting the current position with a call to <code>vmaxget</code> and subsequently clearing memory allocated by a call to <code>vmaxset</code>. An example might be</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>vmax <span class="op">=</span> vmaxget<span class="op">()</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">// a loop involving the use of R_alloc at each iteration</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>vmaxset<span class="op">(</span>vmax<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is only recommended for experts.</p>
<p>Note that this memory will be freed on error or user interrupt (if allowed: see <a href="#allowing-interrupts">Allowing interrupts</a>).</p>
<p>The memory returned is only guaranteed to be aligned as required for <code>double</code> pointers: take precautions if casting to a pointer which needs more. There is also</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> <span class="dt">double</span> <span class="op">*</span>R_allocLD<span class="op">(</span><span class="dt">size_t</span> n<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which is guaranteed to have the 16-byte alignment needed for <code>long double</code> pointers on some platforms.</p>
<p>These functions should only be used in code called by <code>.C</code> etc, never from front-ends. They are not thread-safe.</p>
</section>
<section id="user-controlled-memory" class="level3 subsection page-columns page-full" data-number="6.1.2">
<h3 class="subsection anchored" data-number="6.1.2" data-anchor-id="user-controlled-memory"><span class="header-section-number">6.1.2</span> User-controlled memory</h3>
<p>The other form of memory allocation is an interface to <code>malloc</code>, the interface providing R error signaling. This memory lasts until freed by the user and is additional to the memory allocated for the R workspace.</p>
<p>The interface macros are</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>type<span class="op">*</span> R_Calloc<span class="op">(</span><span class="dt">size_t</span> n<span class="op">,</span> type<span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>type<span class="op">*</span> R_Realloc<span class="op">(</span>any <span class="op">*</span>p<span class="op">,</span> <span class="dt">size_t</span> n<span class="op">,</span> type<span class="op">)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_Free<span class="op">(</span>any <span class="op">*</span>p<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>providing analogues of <code>calloc</code>, <code>realloc</code> and <code>free</code>. If there is an error during allocation it is handled by R, so if these return the memory has been successfully allocated or freed. <code>R_Free</code> will set the pointer <code>p</code> to <code>NULL</code>. (Some but not all versions of S did so.)</p>
<p>Users should arrange to <code>R_Free</code> this memory when no longer needed, including on error or user interrupt. This can often be done most conveniently from an <code>on.exit</code> action in the calling R function – see <code>pwilcox</code> for an example.</p>
<div class="page-columns page-full"><p>Do not assume that memory allocated by <code>R_Calloc</code>/<code>R_Realloc</code> comes from the same pool as used by <code>malloc</code>:<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> in particular do not use <code>free</code> or <code>strdup</code> with it.</p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;That was not the case on Windows prior to R 4.2.0.</p></li></div></div>
<p>Memory obtained by these macros should be aligned in the same way as <code>malloc</code>, that is ‘suitably aligned for any kind of variable’.</p>
<p>Historically the macros <code>Calloc</code>, <code>Free</code> and <code>Realloc</code> were used, and these remain available unless <code>STRICT_R_HEADERS</code> was defined prior to the inclusion of the header.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span> CallocCharBuf<span class="op">(</span><span class="dt">size_t</span> n<span class="op">)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span> Memcpy<span class="op">(</span>p<span class="op">,</span> q<span class="op">,</span> n<span class="op">)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span> Memzero<span class="op">(</span>p<span class="op">,</span> m<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>CallocCharBuf</code> is shorthand for <code>R_Calloc(n+1, char)</code> to allow for the <code>nul</code> terminator. <code>Memcpy</code> and <code>Memzero</code> take <code>n</code> items from array <code>p</code> and copy them to array <code>p</code> or zero them respectively.</p>
</section>
</section>
<section id="error-signaling" class="level2 section" data-number="6.2">
<h2 class="section anchored" data-number="6.2" data-anchor-id="error-signaling"><span class="header-section-number">6.2</span> Error signaling</h2>
<p>The basic error signaling routines are the equivalents of <code>stop</code> and <code>warning</code> in R code, and use the same interface.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> error<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> warning<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> errorcall<span class="op">(</span>SEXP call<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> warningcall<span class="op">(</span>SEXP call<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> warningcall_immediate<span class="op">(</span>SEXP call<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> format<span class="op">,</span> <span class="op">...);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These have the same call sequences as calls to <code>printf</code>, but in the simplest case can be called with a single character string argument giving the error message. (Don’t do this if the string contains <code>%</code> or might otherwise be interpreted as a format.)</p>
<p>These are defined in header <code>R_ext/Error.h</code> included by <code>R.h</code>.</p>
<section id="error-signaling-from-fortran" class="level3 subsection" data-number="6.2.1">
<h3 class="subsection anchored" data-number="6.2.1" data-anchor-id="error-signaling-from-fortran"><span class="header-section-number">6.2.1</span> Error signaling from Fortran</h3>
<p>There are two interface function provided to call <code>error</code> and <code>warning</code> from Fortran code, in each case with a simple character string argument. They are defined as</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>subroutine <span class="fu">rexit</span>(message)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>subroutine <span class="fu">rwarn</span>(message)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Messages of more than 255 characters are truncated, with a warning.</p>
</section>
</section>
<section id="random-number-generation" class="level2 section" data-number="6.3">
<h2 class="section anchored" data-number="6.3" data-anchor-id="random-number-generation"><span class="header-section-number">6.3</span> Random number generation</h2>
<p>The interface to R’s internal random number generation routines is</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> unif_rand<span class="op">();</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> norm_rand<span class="op">();</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> exp_rand<span class="op">();</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> R_unif_index<span class="op">(</span><span class="dt">double</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>giving one uniform, normal or exponential pseudo-random variate. However, before these are used, the user must call</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>GetRNGstate<span class="op">();</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and after all the required variates have been generated, call</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>PutRNGstate<span class="op">();</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These essentially read in (or create) <code>.Random.seed</code> and write it out after use.</p>
<p>These are defined in header <code>R_ext/Random.h</code>.</p>
<p>The random number generator is private to R; there is no way to select the kind of RNG nor set the seed except by evaluating calls to the R functions.</p>
<p>The C code behind R’s <code>rxxx</code> functions can be accessed by including the header file <code>Rmath.h</code>; See <a href="#distribution-functions">Distribution functions</a>. Those calls should also be preceded and followed by calls to <code>GetRNGstate</code> and <code>PutRNGstate</code>.</p>
</section>
<section id="missing-and-ieee-special-values" class="level2 section" data-number="6.4">
<h2 class="section anchored" data-number="6.4" data-anchor-id="missing-and-ieee-special-values"><span class="header-section-number">6.4</span> Missing and IEEE special values</h2>
<p>A set of functions is provided to test for <code>NA</code>, <code>Inf</code>, <code>-Inf</code> and <code>NaN</code>. These functions are accessed <em>via</em> macros:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ISNA<span class="op">(</span>x<span class="op">)</span>        True <span class="cf">for</span> R’s NA only</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ISNAN<span class="op">(</span>x<span class="op">)</span>       True <span class="cf">for</span> R’s NA and IEEE NaN</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>R_FINITE<span class="op">(</span>x<span class="op">)</span>    False <span class="cf">for</span> Inf<span class="op">,</span> <span class="op">-</span>Inf<span class="op">,</span> NA<span class="op">,</span> NaN</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and <em>via</em> function <code>R_IsNaN</code> which is true for <code>NaN</code> but not <code>NA</code>.</p>
<p>Do use <code>R_FINITE</code> rather than <code>isfinite</code> or <code>finite</code>; the latter is often mendacious and <code>isfinite</code> is only available on a some platforms, on which <code>R_FINITE</code> is a macro expanding to <code>isfinite</code>.</p>
<p>Currently in C code <code>ISNAN</code> is a macro calling <code>isnan</code>. (Since this gives problems on some C++ systems, if the R headers is called from C++ code a function call is used.)</p>
<p>You can check for <code>Inf</code> or <code>-Inf</code> by testing equality to <code>R_PosInf</code> or <code>R_NegInf</code>, and set (but not test) an <code>NA</code> as <code>NA_REAL</code>.</p>
<p>All of the above apply to <em>double</em> variables only. For integer variables there is a variable accessed by the macro <code>NA_INTEGER</code> which can used to set or test for missingness.</p>
<p>These are defined in header <code>R_ext/Arith.h</code> included by <code>R.h</code>.</p>
</section>
<section id="printing" class="level2 section page-columns page-full" data-number="6.5">
<h2 class="section anchored" data-number="6.5" data-anchor-id="printing"><span class="header-section-number">6.5</span> Printing</h2>
<p>The most useful function for printing from a C routine compiled into R is <code>Rprintf</code>. This is used in exactly the same way as <code>printf</code>, but is guaranteed to write to R’s output (which might be a GUI console rather than a file, and can be re-directed by <code>sink</code>). It is wise to write complete lines (including the <code>"\n"</code>) before returning to R. It is defined in <code>R_ext/Print.h</code>.</p>
<p>The function <code>REprintf</code> is similar but writes on the error stream (<code>stderr</code>) which may or may not be different from the standard output stream.</p>
<div class="page-columns page-full"><p>Functions <code>Rvprintf</code> and <code>REvprintf</code> are analogues using the <code>vprintf</code> interface. Because that is a C99<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> interface, they are only defined by <code>R_ext/Print.h</code> in C++ code if the macro <code>R_USE_C99_IN_CXX</code> is defined before it is included or (as from R 4.0.0) a C++11 compiler is used.</p><div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;also part of C++11.</p></li></div></div>
<p>Another circumstance when it may be important to use these functions is when using parallel computation on a cluster of computational nodes, as their output will be re-directed/logged appropriately.</p>
<section id="printing-from-fortran" class="level3 subsection" data-number="6.5.1">
<h3 class="subsection anchored" data-number="6.5.1" data-anchor-id="printing-from-fortran"><span class="header-section-number">6.5.1</span> Printing from Fortran</h3>
<p>On many systems Fortran <code>write</code> and <code>print</code> statements can be used, but the output may not interleave well with that of C, and may be invisible on GUI interfaces. They are not portable and best avoided.</p>
<p>Some subroutines are provided to ease the output of information from Fortran code.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>subroutine dblepr<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> data<span class="op">,</span> ndata<span class="op">)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>subroutine realpr<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> data<span class="op">,</span> ndata<span class="op">)</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>subroutine intpr <span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> data<span class="op">,</span> ndata<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and from R&nbsp;4.0.0,</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>subroutine labelpr<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>subroutine dblepr1<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> var<span class="op">)</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>subroutine realpr1<span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> var<span class="op">)</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>subroutine intpr1 <span class="op">(</span>label<span class="op">,</span> nchar<span class="op">,</span> var<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here <code>label</code> is a character label of up to 255 characters, <code>nchar</code> is its length (which can be <code>-1</code> if the whole label is to be used), <code>data</code> is an array of length at least <code>ndata</code> of the appropriate type (<code>double precision</code>, <code>real</code> and <code>integer</code> respectively) and <code>var</code> is a (scalar) variable. These routines print the label on one line and then print <code>data</code> or <code>var</code> as if it were an R vector on subsequent line(s). Note that some compilers will give an error or warning unless <code>data</code> is an array: others will accept a scalar when <code>ndata</code> has value one or zero. <strong>NB:</strong> There is no check on the type of <code>data</code> or <code>var</code>, so using <code>real</code> (including a real constant) instead of <code>double precision</code> will give incorrect answers.</p>
<p><code>intpr</code> works with zero <code>ndata</code> so can be used to print a label in earlier versions of R.</p>
</section>
</section>
<section id="calling-c-from-fortran-and-vice-versa" class="level2 section page-columns page-full" data-number="6.6">
<h2 class="section anchored" data-number="6.6" data-anchor-id="calling-c-from-fortran-and-vice-versa"><span class="header-section-number">6.6</span> Calling C from Fortran and vice versa</h2>
<div class="page-columns page-full"><p>Naming conventions for symbols generated by Fortran differ by platform: it is not safe to assume that Fortran names appear to C with a trailing underscore. To help cover up the platform-specific differences there is a set of macros<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> that should be used.</p><div class="no-row-height column-margin column-container"><li id="fn4"><p><sup>4</sup>&nbsp;The <code>F77_</code> in the names is historical and dates back to usage in S.</p></li></div></div>
<dl>
<dt><code>F77_SUB(name)</code></dt>
<dd>
<p>to define a function in C to be called from Fortran</p>
</dd>
<dt><code>F77_NAME(name)</code></dt>
<dd>
<p>to declare a Fortran routine in C before use</p>
</dd>
<dt><code>F77_CALL(name)</code></dt>
<dd>
<p>to call a Fortran routine from C</p>
</dd>
<dt><code>F77_COMDECL(name)</code></dt>
<dd>
<p>to declare a Fortran common block in C</p>
</dd>
<dt><code>F77_COM(name)</code></dt>
<dd>
<p>to access a Fortran common block from C</p>
</dd>
</dl>
<p>On most current platforms these are all the same, but it is unwise to rely on this. Note that names containing underscores were not legal in Fortran 77, and are not portably handled by the above macros. (Also, all Fortran names for use by R are lower case, but this is not enforced by the macros.)</p>
<p>For example, suppose we want to call R’s normal random numbers from Fortran. We need a C wrapper along the lines of</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_SUB<span class="op">(</span>rndstart<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> GetRNGstate<span class="op">();</span> <span class="op">}</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_SUB<span class="op">(</span>rndend<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> PutRNGstate<span class="op">();</span> <span class="op">}</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> F77_SUB<span class="op">(</span>normrnd<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> norm_rand<span class="op">();</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to be called from Fortran as in</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>      subroutine testit<span class="op">()</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> precision normrnd<span class="op">,</span> x</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>      call rndstart<span class="op">()</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>      x <span class="op">=</span> normrnd<span class="op">()</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>      call dblepr<span class="op">(</span><span class="st">"X was"</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> x<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>      call rndend<span class="op">()</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>      end</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that this is not guaranteed to be portable, for the return conventions might not be compatible between the C and Fortran compilers used. (Passing values <em>via</em> arguments is safer.)</p>
<p>The standard packages, for example <strong>stats</strong>, are a rich source of further examples.</p>
<p>Where supported, <em>link time optimization</em> provides a reliable way to check the consistency of calls to C from Fortran or <em>vice versa</em>. See <a href="Debugging.html#using-link-time-optimization">Using Link-time Optimization</a>. One place where this occurs is the registration of <code>.Fortran</code> calls in C code (see <a href="System-and-foreign-language-interfaces.html#registering-native-routines">Registering native routines</a>). For example</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>init<span class="op">.</span>c<span class="op">:</span><span class="dv">10</span><span class="op">:</span><span class="dv">13</span><span class="op">:</span> warning<span class="op">:</span> type of <span class="ch">'v</span><span class="er">som_</span><span class="ch">'</span> does not match original</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a> declaration <span class="op">[-</span>Wlto<span class="op">-</span>type<span class="op">-</span>mismatch<span class="op">]</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">extern</span> <span class="dt">void</span> F77_NAME<span class="op">(</span>vsom<span class="op">)(</span><span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*,</span> <span class="dt">void</span> <span class="op">*);</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>vsom<span class="op">.</span>f90<span class="op">:</span><span class="dv">20</span><span class="op">:</span><span class="dv">33</span><span class="op">:</span> note<span class="op">:</span> type mismatch in parameter <span class="dv">9</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>   subroutine vsom<span class="op">(</span>neurons<span class="op">,</span>dt<span class="op">,</span>dtrows<span class="op">,</span>dtcols<span class="op">,</span>xdim<span class="op">,</span>ydim<span class="op">,</span>alpha<span class="op">,</span>train<span class="op">)</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>vsom<span class="op">.</span>f90<span class="op">:</span><span class="dv">20</span><span class="op">:</span><span class="dv">33</span><span class="op">:</span> note<span class="op">:</span> <span class="ch">'v</span><span class="er">som</span><span class="ch">'</span> was previously declared here</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>shows that a subroutine has been registered with 9 arguments (as that is what the <code>.Fortran</code> call used) but only has 8.</p>
<section id="fortran-character-strings" class="level3 subsection" data-number="6.6.1">
<h3 class="subsection anchored" data-number="6.6.1" data-anchor-id="fortran-character-strings"><span class="header-section-number">6.6.1</span> Fortran character strings</h3>
<p>Passing character strings from C to Fortran or <em>vice versa</em> is not portable, but can be done with care. The internal representations are different: a character array in C (or C++) is nul-terminated so its length can be computed by <code>strlen</code>. Fortran character arrays are typically stored as an array of bytes and a length. This matters when passing strings from C to Fortran or <em>vice versa</em>: in many cases one has been able to get away with passing the string but not the length. However, in 2019 this changed for <code>gfortran</code>, starting with version 9 but backported to versions 7 and 8. Several months later, <code>gfortran</code> 9.2 introduced an option</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span>ftail<span class="sc">-</span>call<span class="sc">-</span>workaround</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and made it the current default but said it might be withdrawn in future.</p>
<p>Suppose we want a function to report a message from Fortran to R’s console (one could use <code>labelpr</code>, or <code>intpr</code> with dummy data, but this might be the basis of a custom reporting function). Suppose the equivalent in Fortran would be</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>      subroutine rmsg<span class="op">(</span>msg<span class="op">)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>      character<span class="op">*(*)</span> msg</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>      print <span class="op">*.</span>msg</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>      end</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in file <code>rmsg.f</code>. Using <code>gfortran</code> 9.2 and later we can extract the C view by</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>gfortran <span class="sc">-</span>c <span class="sc">-</span>fc<span class="sc">-</span>prototypes<span class="sc">-</span>external rmsg.f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which gives</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> rmsg_ <span class="op">(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">,</span> <span class="dt">size_t</span> msg_len<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(where <code>size_t</code> applies to version 8 and later). We could re-write that portably in C as</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef USE_FC_LEN_T</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="pp"># define USE_FC_LEN_T</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rconfig.h&gt;</span><span class="pp"> </span><span class="co">// included by R.h, so define USE_FC_LEN_T early</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>rmsg<span class="op">)(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">,</span> FC_LEN_T msg_len<span class="op">)</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> cmsg<span class="op">[</span>msg_len<span class="op">+</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    strncpy<span class="op">(</span>cmsg<span class="op">,</span> msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    cmsg<span class="op">[</span>msg_len<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span> <span class="co">// nul-terminate the string, to be sure</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// do something with 'cmsg' </span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in code depending on <code>R(&gt;= 3.6.2)</code>. For earlier versions of R we could just assume that <code>msg</code> is nul-terminated (not guaranteed, but people have been getting away with it for many years), so the complete C side might be</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef USE_FC_LEN_T</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="pp"># define USE_FC_LEN_T</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rconfig.h&gt;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef FC_LEN_T</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>rmsg<span class="op">)(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">,</span> FC_LEN_T msg_len<span class="op">)</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> cmsg<span class="op">[</span>msg_len<span class="op">+</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    strncpy<span class="op">(</span>cmsg<span class="op">,</span> msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    cmsg<span class="op">[</span>msg_len<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// do something with 'cmsg' </span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>rmsg<span class="op">)(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">)</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// do something with 'msg' </span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(<code>USE_FC_LEN_T</code> is the default as from R 4.3.0.)</p>
<p>An alternative is to use Fortran 2003 features to set up the Fortran routine to pass a C-compatible character string. We could use something like</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>      module cfuncs</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>        use iso_c_binding<span class="op">,</span> only<span class="op">:</span> c_char<span class="op">,</span> c_null_char</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>        interface</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>          subroutine cmsg<span class="op">(</span>msg<span class="op">)</span> bind<span class="op">(</span>C<span class="op">,</span> name <span class="op">=</span> <span class="ch">'c</span><span class="er">msg</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>            use iso_c_binding<span class="op">,</span> only<span class="op">:</span> c_char</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>            character<span class="op">(</span>kind <span class="op">=</span> c_char<span class="op">)::</span> msg<span class="op">(*)</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>          end subroutine cmsg</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        end interface</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>      end module</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>      subroutine rmsg<span class="op">(</span>msg<span class="op">)</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        use cfuncs</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        character<span class="op">(*)</span> msg</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        call cmsg<span class="op">(</span>msg<span class="co">//c_null_char) ! need to concatenate a nul terminator</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>      end subroutine rmsg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the C side is simply</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cmsg<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>msg<span class="op">)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// do something with nul-terminated string 'msg'</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you use <code>bind</code> to a C function as here, the only way to check that the bound definition is correct is to compile the package with LTO (which requires compatible C and Fortran compilers, usually <code>gcc</code> and <code>gfortran</code>).</p>
<p>Passing a variable-length string from C to Fortran is trickier, but <a href="https://www.intel.com/content/www/us/en/docs/fortran-compiler/developer-guide-reference/2023-0/bind-c.html" class="uri">https://www.intel.com/content/www/us/en/docs/fortran-compiler/developer-guide-reference/2023-0/bind-c.html</a> provides a recipe. However, all the uses in BLAS and LAPACK are of a single character, and for these we can write a wrapper in Fortran along the lines of</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>      subroutine c_dgemm<span class="op">(</span>transa<span class="op">,</span> transb<span class="op">,</span> m<span class="op">,</span> n<span class="op">,</span> k<span class="op">,</span> alpha<span class="op">,</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>     <span class="op">+</span>     a<span class="op">,</span> lda<span class="op">,</span> b<span class="op">,</span> ldb<span class="op">,</span> beta<span class="op">,</span> c<span class="op">,</span> ldc<span class="op">)</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>     <span class="op">+</span>     bind<span class="op">(</span>C<span class="op">,</span> name <span class="op">=</span> <span class="ch">'C</span><span class="er">dgemm</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        use iso_c_binding<span class="op">,</span> only <span class="op">:</span> c_char<span class="op">,</span> c_int<span class="op">,</span> c_double</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        character<span class="op">(</span>c_char<span class="op">),</span> intent<span class="op">(</span>in<span class="op">)</span> <span class="op">::</span> transa<span class="op">,</span> transb</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        integer<span class="op">(</span>c_int<span class="op">),</span> intent<span class="op">(</span>in<span class="op">)</span> <span class="op">::</span> m<span class="op">,</span> n<span class="op">,</span> k<span class="op">,</span> lda<span class="op">,</span> ldb<span class="op">,</span> ldc</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        real<span class="op">(</span>c_double<span class="op">),</span> intent<span class="op">(</span>in<span class="op">)</span> <span class="op">::</span> alpha<span class="op">,</span> beta<span class="op">,</span> a<span class="op">(</span>lda<span class="op">,</span> <span class="op">*),</span> b<span class="op">(</span>ldb<span class="op">,</span> <span class="op">*)</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        real<span class="op">(</span>c_double<span class="op">),</span> intent<span class="op">(</span>out<span class="op">)</span> <span class="op">::</span>  c<span class="op">(</span>ldc<span class="op">,</span> <span class="op">*)</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        call dgemm<span class="op">(</span>transa<span class="op">,</span> transb<span class="op">,</span> m<span class="op">,</span> n<span class="op">,</span> k<span class="op">,</span> alpha<span class="op">,</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>     <span class="op">+</span>             a<span class="op">,</span> lda<span class="op">,</span> b<span class="op">,</span> ldb<span class="op">,</span> beta<span class="op">,</span> c<span class="op">,</span> ldc<span class="op">)</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>      end subroutine c_dgemm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which is then called from C with declaration</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>Cdgemm<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>transa<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>transb<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>m<span class="op">,</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>       <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>k<span class="op">,</span> <span class="dt">const</span> <span class="dt">double</span> <span class="op">*</span>alpha<span class="op">,</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>       <span class="dt">const</span> <span class="dt">double</span> <span class="op">*</span>a<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>lda<span class="op">,</span> <span class="dt">const</span> <span class="dt">double</span> <span class="op">*</span>b<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>ldb<span class="op">,</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>       <span class="dt">const</span> <span class="dt">double</span> <span class="op">*</span>beta<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>c<span class="op">,</span> <span class="dt">const</span> <span class="dt">int</span> <span class="op">*</span>ldc<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Alternatively, do as R does as from version 3.6.2 and pass the character length(s) from C to Fortran. A portable way to do this is</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// before any R headers, or define in PKG_CPPFLAGS</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef  USE_FC_LEN_T</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="pp"># define USE_FC_LEN_T</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rconfig.h&gt;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/BLAS.h&gt;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef FCONE</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="pp"># define FCONE</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        F77_CALL<span class="op">(</span>dgemm<span class="op">)(</span><span class="st">"N"</span><span class="op">,</span> <span class="st">"T"</span><span class="op">,</span> <span class="op">&amp;</span>nrx<span class="op">,</span> <span class="op">&amp;</span>ncy<span class="op">,</span> <span class="op">&amp;</span>ncx<span class="op">,</span> <span class="op">&amp;</span>one<span class="op">,</span> x<span class="op">,</span> </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>                        <span class="op">&amp;</span>nrx<span class="op">,</span> y<span class="op">,</span> <span class="op">&amp;</span>nry<span class="op">,</span> <span class="op">&amp;</span>zero<span class="op">,</span> z<span class="op">,</span> <span class="op">&amp;</span>nrx FCONE FCONE<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(Note there is no comma before or between the <code>FCONE</code> invocations.) It is strongly recommended that packages which call from C/C++ BLAS/LAPACK routines with character arguments adopt this approach: packages not using will fail to install as from R 4.3.0.</p>
</section>
<section id="fortran-logical" class="level3 subsection" data-number="6.6.2">
<h3 class="subsection anchored" data-number="6.6.2" data-anchor-id="fortran-logical"><span class="header-section-number">6.6.2</span> Fortran LOGICAL</h3>
<p>Passing Fortran LOGICAL variables to/from C/C++ is potentially compiler-dependent. Fortran compilers have long used a 32-bit integer type so it is pretty portable to use <code>int *</code> on the C/C++ side. However, recent versions of <code>gfortran</code> <em>via</em> the option <code>-fc-prototypes-external</code> say the C equivalent is <code>int_least32_t *</code>: ‘Link-Time Optimization’ will report <code>int *</code> as a mismatch. It is possible to use <code>iso_c_binding</code> in Fortran to map LOGICAL variables to the C99 type <code>_Bool</code>, but it is usually simpler to pass integers to and fro.</p>
</section>
<section id="passing-functions" class="level3 subsection" data-number="6.6.3">
<h3 class="subsection anchored" data-number="6.6.3" data-anchor-id="passing-functions"><span class="header-section-number">6.6.3</span> Passing functions</h3>
<p>A number of packages call C functions passed as arguments to Fortran code along the lines of</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>c         subroutine fcn<span class="op">(</span>m<span class="op">,</span>n<span class="op">,</span>x<span class="op">,</span>fvec<span class="op">,</span>iflag<span class="op">)</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>c         integer m<span class="op">,</span>n<span class="op">,</span>iflag</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>c         <span class="dt">double</span> precision x<span class="op">(</span>n<span class="op">),</span>fvec<span class="op">(</span>m<span class="op">)</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>      subroutine lmdif<span class="op">(</span>fcn<span class="op">,</span> <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the C declaration and call are</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> fcn_lmdif<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>m<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>par<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>fvec<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>iflag<span class="op">);</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>lmdif<span class="op">)(</span><span class="dt">void</span> <span class="op">(*</span>fcn_lmdif<span class="op">)(</span><span class="dt">int</span> <span class="op">*</span>m<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>par<span class="op">,</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="dt">double</span> <span class="op">*</span>fvec<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>iflag<span class="op">),</span> <span class="op">...</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>F77_CALL<span class="op">(</span>lmdif<span class="op">)(&amp;</span>fcn_lmdif<span class="op">,</span> <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This works on most platforms but depends on the C and Fortran compilers agreeing on calling conventions: this have been seen to fail. The most portable solution seems to be to convert the Fortran code to C, perhaps using <code>f2c</code>.</p>
</section>
</section>
<section id="numerical-analysis-subroutines" class="level2 section page-columns page-full" data-number="6.7">
<h2 class="section anchored" data-number="6.7" data-anchor-id="numerical-analysis-subroutines"><span class="header-section-number">6.7</span> Numerical analysis subroutines</h2>
<p>R contains a large number of mathematical functions for its own use, for example numerical linear algebra computations and special functions.</p>
<p>The header files <code>R_ext/BLAS.h</code>, <code>R_ext/Lapack.h</code> and <code>R_ext/Linpack.h</code> contains declarations of the BLAS, LAPACK and LINPACK linear algebra functions included in R. These are expressed as calls to Fortran subroutines, and they will also be usable from users’ Fortran code. Although not part of the official API, this set of subroutines is unlikely to change (but might be supplemented).</p>
<p>The header file <code>Rmath.h</code> lists many other functions that are available and documented in the following subsections. Many of these are C interfaces to the code behind R functions, so the R function documentation may give further details.</p>
<section id="distribution-functions" class="level3 subsection" data-number="6.7.1">
<h3 class="subsection anchored" data-number="6.7.1" data-anchor-id="distribution-functions"><span class="header-section-number">6.7.1</span> Distribution functions</h3>
<p>The routines used to calculate densities, cumulative distribution functions and quantile functions for the standard statistical distributions are available as entry points.</p>
<p>The arguments for the entry points follow the pattern of those for the normal distribution:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> dnorm<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> mu<span class="op">,</span> <span class="dt">double</span> sigma<span class="op">,</span> <span class="dt">int</span> give_log<span class="op">);</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> pnorm<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> mu<span class="op">,</span> <span class="dt">double</span> sigma<span class="op">,</span> <span class="dt">int</span> lower_tail<span class="op">,</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>             <span class="dt">int</span> give_log<span class="op">);</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> qnorm<span class="op">(</span><span class="dt">double</span> p<span class="op">,</span> <span class="dt">double</span> mu<span class="op">,</span> <span class="dt">double</span> sigma<span class="op">,</span> <span class="dt">int</span> lower_tail<span class="op">,</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>             <span class="dt">int</span> log_p<span class="op">);</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> rnorm<span class="op">(</span><span class="dt">double</span> mu<span class="op">,</span> <span class="dt">double</span> sigma<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That is, the first argument gives the position for the density and CDF and probability for the quantile function, followed by the distribution’s parameters. Argument <code>lower_tail</code> should be <code>TRUE</code> (or <code>1</code>) for normal use, but can be <code>FALSE</code> (or <code>0</code>) if the probability of the upper tail is desired or specified.</p>
<p>Finally, <code>give_log</code> should be non-zero if the result is required on log scale, and <code>log_p</code> should be non-zero if <code>p</code> has been specified on log scale.</p>
<p>Note that you directly get the cumulative (or “integrated”) <em>hazard</em> function, H(t) = - log(1 - F(t)), by using</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> <span class="fu">pdist</span>(t, ..., <span class="sc">/</span><span class="er">*</span><span class="at">lower_tail =</span> <span class="sc">*</span><span class="er">/</span> <span class="cn">FALSE</span>, <span class="sc">/</span><span class="er">*</span> <span class="at">give_log =</span> <span class="sc">*</span><span class="er">/</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or shorter (and more cryptic) <code>- pdist(t, ..., 0, 1)</code>.</p>
<p>The random-variate generation routine <code>rnorm</code> returns one normal variate. See <a href="#random-numbers">Random number generation</a>, for the protocol in using the random-variate routines.</p>
<p>Note that these argument sequences are (apart from the names and that <code>rnorm</code> has no <code>n</code>) mainly the same as the corresponding R functions of the same name, so the documentation of the R functions can be used. Note that the exponential and gamma distributions are parametrized by <code>scale</code> rather than <code>rate</code>.</p>
<p>For reference, the following table gives the basic name (to be prefixed by <code>d</code>, <code>p</code>, <code>q</code> or <code>r</code> apart from the exceptions noted) and distribution-specific arguments for the complete set of distributions.</p>
<blockquote class="blockquote">
<table class="table">
<tbody>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: left;"><code>beta</code></td>
<td style="text-align: left;"><code>a</code>, <code>b</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">non-central beta</td>
<td style="text-align: left;"><code>nbeta</code></td>
<td style="text-align: left;"><code>a</code>, <code>b</code>, <code>ncp</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">binomial</td>
<td style="text-align: left;"><code>binom</code></td>
<td style="text-align: left;"><code>n</code>, <code>p</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Cauchy</td>
<td style="text-align: left;"><code>cauchy</code></td>
<td style="text-align: left;"><code>location</code>, <code>scale</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">chi-squared</td>
<td style="text-align: left;"><code>chisq</code></td>
<td style="text-align: left;"><code>df</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">non-central chi-squared</td>
<td style="text-align: left;"><code>nchisq</code></td>
<td style="text-align: left;"><code>df</code>, <code>ncp</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">exponential</td>
<td style="text-align: left;"><code>exp</code></td>
<td style="text-align: left;"><code>scale</code> (and <strong>not</strong> <code>rate</code>)</td>
</tr>
<tr class="even">
<td style="text-align: left;">F</td>
<td style="text-align: left;"><code>f</code></td>
<td style="text-align: left;"><code>n1</code>, <code>n2</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">non-central F</td>
<td style="text-align: left;"><code>nf</code></td>
<td style="text-align: left;"><code>n1</code>, <code>n2</code>, <code>ncp</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: left;"><code>gamma</code></td>
<td style="text-align: left;"><code>shape</code>, <code>scale</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">geometric</td>
<td style="text-align: left;"><code>geom</code></td>
<td style="text-align: left;"><code>p</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">hypergeometric</td>
<td style="text-align: left;"><code>hyper</code></td>
<td style="text-align: left;"><code>NR</code>, <code>NB</code>, <code>n</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">logistic</td>
<td style="text-align: left;"><code>logis</code></td>
<td style="text-align: left;"><code>location</code>, <code>scale</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">lognormal</td>
<td style="text-align: left;"><code>lnorm</code></td>
<td style="text-align: left;"><code>logmean</code>, <code>logsd</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">negative binomial</td>
<td style="text-align: left;"><code>nbinom</code></td>
<td style="text-align: left;"><code>size</code>, <code>prob</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">normal</td>
<td style="text-align: left;"><code>norm</code></td>
<td style="text-align: left;"><code>mu</code>, <code>sigma</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Poisson</td>
<td style="text-align: left;"><code>pois</code></td>
<td style="text-align: left;"><code>lambda</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Student’s t</td>
<td style="text-align: left;"><code>t</code></td>
<td style="text-align: left;"><code>n</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">non-central t</td>
<td style="text-align: left;"><code>nt</code></td>
<td style="text-align: left;"><code>df</code>, <code>delta</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Studentized range</td>
<td style="text-align: left;"><code>tukey</code> (*)</td>
<td style="text-align: left;"><code>rr</code>, <code>cc</code>, <code>df</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">uniform</td>
<td style="text-align: left;"><code>unif</code></td>
<td style="text-align: left;"><code>a</code>, <code>b</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Weibull</td>
<td style="text-align: left;"><code>weibull</code></td>
<td style="text-align: left;"><code>shape</code>, <code>scale</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wilcoxon rank sum</td>
<td style="text-align: left;"><code>wilcox</code></td>
<td style="text-align: left;"><code>m</code>, <code>n</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Wilcoxon signed rank</td>
<td style="text-align: left;"><code>signrank</code></td>
<td style="text-align: left;"><code>n</code></td>
</tr>
</tbody>
</table>
</blockquote>
<p>Entries marked with an asterisk only have <code>p</code> and <code>q</code> functions available, and none of the non-central distributions have <code>r</code> functions.</p>
<p>(If remapping is suppressed, the Normal distribution names are <code>Rf_dnorm4</code>, <code>Rf_pnorm5</code> and <code>Rf_qnorm5</code>.)</p>
<p>Additionally, a <em>multivariate</em> RNG for the multinomial distribution is</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> rmultinom<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span><span class="op">*</span> prob<span class="op">,</span> <span class="dt">int</span> K<span class="op">,</span> <span class="dt">int</span><span class="op">*</span> rN<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>K = length(prob)</code>, sum(prob[.]) == 1 and <code>rN</code> must point to a length-<code>K</code> integer vector n1 n2 .. nK where each entry nj=<code>rN[j]</code> is “filled” by a random binomial from Bin(n; prob[j]), constrained to sum(rN[.]) == n.</p>
<p>After calls to <code>dwilcox</code>, <code>pwilcox</code> or <code>qwilcox</code> the function <code>wilcox_free()</code> should be called, and similarly <code>signrank_free()</code> for the signed rank functions. Since <code>wilcox_free()</code> and <code>signrank_free()</code> were only added to <code>Rmath.h</code> in R&nbsp; 4.2.0, their use requires something like</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"Rmath.h"</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"Rversion.h"</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#if R_VERSION &lt; R_Version(4, 2, 0)</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">void</span> wilcox_free<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">void</span> signrank_free<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For the negative binomial distribution (<code>nbinom</code>), in addition to the <code>(size, prob)</code> parametrization, the alternative <code>(size, mu)</code> parametrization is provided as well by functions <code>[dpqr]nbinom_mu()</code>, see <kbd>?NegBinomial</kbd> in R.</p>
<p>Functions <code>dpois_raw(x, *)</code> and <code>dbinom_raw(x, *)</code> are versions of the Poisson and binomial probability mass functions which work continuously in <code>x</code>, whereas <code>dbinom(x,*)</code> and <code>dpois(x,*)</code> only return non zero values for integer <code>x</code>.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> dbinom_raw<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> n<span class="op">,</span> <span class="dt">double</span> p<span class="op">,</span> <span class="dt">double</span> q<span class="op">,</span> <span class="dt">int</span> give_log<span class="op">)</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> dpois_raw <span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> lambda<span class="op">,</span> <span class="dt">int</span> give_log<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that <code>dbinom_raw()</code> returns both p and q = 1-p which may be advantageous when one of them is close to 1.</p>
</section>
<section id="mathematical-functions" class="level3 subsection" data-number="6.7.2">
<h3 class="subsection anchored" data-number="6.7.2" data-anchor-id="mathematical-functions"><span class="header-section-number">6.7.2</span> Mathematical functions</h3>
<p><span class="category">Function:</span><em>double</em> <strong>gammafn</strong> <em>(double <code>x</code>)</em> <a href="#index-gammafn" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>lgammafn</strong> <em>(double <code>x</code>)</em> <a href="#index-lgammafn" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>digamma</strong> <em>(double <code>x</code>)</em> <a href="#index-digamma" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>trigamma</strong> <em>(double <code>x</code>)</em> <a href="#index-trigamma" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>tetragamma</strong> <em>(double <code>x</code>)</em> <a href="#index-tetragamma" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>pentagamma</strong> <em>(double <code>x</code>)</em> <a href="#index-pentagamma" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>psigamma</strong> <em>(double <code>x</code>, double <code>deriv</code>)</em> <a href="#index-psigamma" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>dpsifn</strong> <em>(double <code>x</code>, int <code>n</code>, int <code>kode</code>, int <code>m</code>, double* <code>ans</code>, int* <code>nz</code>, int* <code>ierr</code>)</em> <a href="#index-dpsifn" class="copiable-anchor">¶</a></p>
<p>: The Gamma function, the natural logarithm of its absolute value and first four derivatives and the n-th derivative of Psi, the digamma function, which is the derivative of <code>lgammafn</code>. In other words, <code>digamma(x)</code> is the same as <code>psigamma(x,0)</code>, <code>trigamma(x) == psigamma(x,1)</code>, etc. The underlying workhorse, <code>dpsifn()</code>, is useful, e.g., when several derivatives of log Gamma=<code>lgammafn</code> are desired. It computes and returns in <code>ans[]</code> the length-<code>m</code> sequence (-1)^(k+1) / gamma(k+1) * psi(k;x) for k = n ... n+m-1, where psi(k;x) is the k-th derivative of Psi(x), i.e., <code>psigamma(x,k)</code>. For more details, see the comments in <code>src/nmath/polygamma.c</code>.</p>
<!-- -->
<p><span class="category">Function:</span><em>double</em> <strong>beta</strong> <em>(double <code>a</code>, double <code>b</code>)</em> <a href="#index-beta" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>lbeta</strong> <em>(double <code>a</code>, double <code>b</code>)</em> <a href="#index-lbeta" class="copiable-anchor">¶</a></p>
<p>: The (complete) Beta function and its natural logarithm.</p>
<!-- -->
<p><span class="category">Function:</span><em>double</em> <strong>choose</strong> <em>(double <code>n</code>, double <code>k</code>)</em> <a href="#index-choose" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>lchoose</strong> <em>(double <code>n</code>, double <code>k</code>)</em> <a href="#index-lchoose" class="copiable-anchor">¶</a></p>
<p>: The number of combinations of <code>k</code> items chosen from <code>n</code> and the natural logarithm of its absolute value, generalized to arbitrary real <code>n</code>. <code>k</code> is rounded to the nearest integer (with a warning if needed).</p>
<!-- -->
<p><span class="category">Function:</span><em>double</em> <strong>bessel_i</strong> <em>(double <code>x</code>, double <code>nu</code>, double <code>expo</code>)</em> <a href="#index-bessel_i" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>bessel_j</strong> <em>(double <code>x</code>, double <code>nu</code>)</em> <a href="#index-bessel_j" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>bessel_k</strong> <em>(double <code>x</code>, double <code>nu</code>, double <code>expo</code>)</em> <a href="#index-bessel_k" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>bessel_y</strong> <em>(double <code>x</code>, double <code>nu</code>)</em> <a href="#index-bessel_y" class="copiable-anchor">¶</a></p>
<p>: Bessel functions of types I, J, K and Y with index <code>nu</code>. For <code>bessel_i</code> and <code>bessel_k</code> there is the option to return <span class="nolinebreak">exp(-</span><code>x</code>)&nbsp;I(<code>x</code>;&nbsp;<code>nu</code>) or exp(<code>x</code>)&nbsp;K(<code>x</code>;&nbsp;<code>nu</code>) if <code>expo</code> is 2. (Use <code>expo == 1</code> for unscaled values.)</p>
</section>
<section id="numerical-utilities" class="level3 subsection page-columns page-full" data-number="6.7.3">
<h3 class="subsection anchored" data-number="6.7.3" data-anchor-id="numerical-utilities"><span class="header-section-number">6.7.3</span> Numerical Utilities</h3>
<p>There are a few other numerical utility functions available as entry points.</p>
<p><span class="category">Function:</span><em>double</em> <strong>R_pow</strong> <em>(double <code>x</code>, double <code>y</code>)</em> <a href="#index-r_pow" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>R_pow_di</strong> <em>(double <code>x</code>, int <code>i</code>)</em> <a href="#index-r_pow_di" class="copiable-anchor">¶</a></p>
<p>: <code>R_pow(x, y)</code> and <code>R_pow_di(x, i)</code> compute <code>x^y</code> and <code>x^i</code>, respectively using <code>R_FINITE</code> checks and returning the proper result (the same as R) for the cases where <code>x</code>, <code>y</code> or <code>i</code> are 0 or missing or infinite or <code>NaN</code>.</p>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>log1p</strong> <em>(double <code>x</code>)</em> <a href="#index-log1p" class="copiable-anchor">¶</a></dt>
<dd>
<p>Computes <code>log(1 + x)</code> (<em>log 1 <strong>p</strong>lus x</em>), accurately even for small <code>x</code>, i.e., |x| &lt;&lt; 1.</p>
<p>This should be provided by your platform, in which case it is not included in <code>Rmath.h</code>, but is (probably) in <code>math.h</code> which <code>Rmath.h</code> includes (except under C++, so it may not be declared for C++98).</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>log1pmx</strong> <em>(double <code>x</code>)</em> <a href="#index-log1pmx" class="copiable-anchor">¶</a></dt>
<dd>
<p>Computes <code>log(1 + x) - x</code> (<em>log 1 <strong>p</strong>lus x <strong>m</strong>inus <strong>x</strong></em>), accurately even for small <code>x</code>, i.e., |x| &lt;&lt; 1.</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>log1pexp</strong> <em>(double <code>x</code>)</em> <a href="#index-log1pexp" class="copiable-anchor">¶</a></dt>
<dd>
<p>Computes <code>log(1 + exp(x))</code> (<em>log 1 <strong>p</strong>lus <strong>exp</strong></em>), accurately, notably for large <code>x</code>, e.g., x &gt; 720.</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>log1mexp</strong> <em>(double <code>x</code>)</em> <a href="#index-log1mexp" class="copiable-anchor">¶</a></dt>
<dd>
<p>Computes <code>log(1 - exp(-x))</code> (<em>log 1 <strong>m</strong>inus <strong>exp</strong></em>), accurately, carefully for two regions of <code>x</code>, optimally cutting off at log 2 (= 0.693147..), using <code>((-x) &gt; -M_LN2 ? log(-expm1(-x)) : log1p(-exp(-x)))</code>.</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>expm1</strong> <em>(double <code>x</code>)</em> <a href="#index-expm1" class="copiable-anchor">¶</a></dt>
<dd>
<p>Computes <code>exp(x) - 1</code> (<em>exp x <strong>m</strong>inus 1</em>), accurately even for small <code>x</code>, i.e., |x| &lt;&lt; 1.</p>
<p>This should be provided by your platform, in which case it is not included in <code>Rmath.h</code>, but is (probably) in <code>math.h</code> which <code>Rmath.h</code> includes (except under C++, so it may not be declared for C++98).</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>lgamma1p</strong> <em>(double <code>x</code>)</em> <a href="#index-lgamma1p" class="copiable-anchor">¶</a></dt>
<dd>
<p>Computes <code>log(gamma(x + 1))</code> (<em>log(gamma(1 <strong>p</strong>lus x))</em>), accurately even for small <code>x</code>, i.e., 0 &lt; x &lt; 0.5.</p>
</dd>
</dl>
<!-- -->
<dl class="page-columns page-full">
<dt><span class="category">Function:</span><em>double</em> <strong>cospi</strong> <em>(double <code>x</code>)</em> <a href="#index-cospi" class="copiable-anchor">¶</a></dt>
<dd class="page-columns page-full">
<p>Computes <code>cos(pi * x)</code> (where <code>pi</code> is 3.14159...), accurately, notably for half integer <code>x</code>.</p>
<div class="page-columns page-full"><p>This might be provided by your platform<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>, in which case it is not included in <code>Rmath.h</code>, but is in <code>math.h</code> which <code>Rmath.h</code> includes. (Ensure that neither <code>math.h</code> nor <code>cmath</code> is included before <code>Rmath.h</code> or define</p><div class="no-row-height column-margin column-container"><li id="fn5"><p><sup>5</sup>&nbsp;It is an optional C11 extension.</p></li></div></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define __STDC_WANT_IEC_60559_FUNCS_EXT__ </span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>before the first inclusion.)</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>sinpi</strong> <em>(double <code>x</code>)</em> <a href="#index-sinpi" class="copiable-anchor">¶</a></dt>
<dd>
<p>Computes <code>sin(pi * x)</code> accurately, notably for (half) integer <code>x</code>.</p>
<p>This might be provided by your platform, in which case it is not included in <code>Rmath.h</code>, but is in <code>math.h</code> which <code>Rmath.h</code> includes (but see the comments for <code>cospi</code>).</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>Rtanpi</strong> <em>(double <code>x</code>)</em> <a href="#index-rtanpi" class="copiable-anchor">¶</a></dt>
<dd>
<p>Computes <code>tan(pi * x)</code> accurately, notably for integer <code>x</code>, giving <code>NaN</code> for half integer <code>x</code> and exactly +1 or -1 for (non half) quarter integers.</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>tanpi</strong> <em>(double <code>x</code>)</em> <a href="#index-tanpi" class="copiable-anchor">¶</a></dt>
<dd>
<p>Computes <code>tan(pi * x)</code> accurately for integer <code>x</code> with possibly platform dependent behavior for half (and quarter) integers. This might be provided by your platform, in which case it is not included in <code>Rmath.h</code>, but is in <code>math.h</code> which <code>Rmath.h</code> includes (but see the comments for <code>cospi</code>).</p>
</dd>
</dl>
<!-- -->
<p><span class="category">Function:</span><em>double</em> <strong>logspace_add</strong> <em>(double <code>logx</code>, double <code>logy</code>)</em> <a href="#index-logspace_add" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>logspace_sub</strong> <em>(double <code>logx</code>, double <code>logy</code>)</em> <a href="#index-logspace_sub" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>logspace_sum</strong> <em>(const double* <code>logx</code>, int <code>n</code>)</em> <a href="#index-logspace_sum" class="copiable-anchor">¶</a></p>
<p>: Compute the log of a sum or difference from logs of terms, i.e., “x + y” as <code>log (exp(logx) + exp(logy))</code> and “x - y” as <code>log (exp(logx) - exp(logy))</code>, and “sum_i x[i]” as <code>log (sum[i = 1:n exp(logx[i])] )</code> without causing unnecessary overflows or throwing away too much accuracy.</p>
<!-- -->
<p><span class="category">Function:</span><em>int</em> <strong>imax2</strong> <em>(int <code>x</code>, int <code>y</code>)</em> <a href="#index-imax2" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>int</em> <strong>imin2</strong> <em>(int <code>x</code>, int <code>y</code>)</em> <a href="#index-imin2" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>fmax2</strong> <em>(double <code>x</code>, double <code>y</code>)</em> <a href="#index-fmax2" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>double</em> <strong>fmin2</strong> <em>(double <code>x</code>, double <code>y</code>)</em> <a href="#index-fmin2" class="copiable-anchor">¶</a></p>
<p>: Return the larger (<code>max</code>) or smaller (<code>min</code>) of two integer or double numbers, respectively. Note that <code>fmax2</code> and <code>fmin2</code> differ from C99/C++11’s <code>fmax</code> and <code>fmin</code> when one of the arguments is a <code>NaN</code>: these versions return <code>NaN</code>.</p>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>sign</strong> <em>(double <code>x</code>)</em> <a href="#index-sign" class="copiable-anchor">¶</a></dt>
<dd>
<p>Compute the <em>signum</em> function, where sign(<code>x</code>) is 1, 0, or <em>-1</em>, when <code>x</code> is positive, 0, or negative, respectively, and <code>NaN</code> if <code>x</code> is a <code>NaN</code>.</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>fsign</strong> <em>(double <code>x</code>, double <code>y</code>)</em> <a href="#index-fsign" class="copiable-anchor">¶</a></dt>
<dd>
<p>Performs “transfer of sign” and is defined as |x| * sign(y).</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>fprec</strong> <em>(double <code>x</code>, double <code>digits</code>)</em> <a href="#index-fprec" class="copiable-anchor">¶</a></dt>
<dd>
<p>Returns the value of <code>x</code> rounded to <code>digits</code> decimal digits (after the decimal point).</p>
<p>This is the function used by R’s <code>signif()</code>.</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>fround</strong> <em>(double <code>x</code>, double <code>digits</code>)</em> <a href="#index-fround" class="copiable-anchor">¶</a></dt>
<dd>
<p>Returns the value of <code>x</code> rounded to <code>digits</code> <em>significant</em> decimal digits.</p>
<p>This is the function used by R’s <code>round()</code>. (Note that C99/C++11 provide a <code>round</code> function but C++98 need not.)</p>
</dd>
</dl>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>double</em> <strong>ftrunc</strong> <em>(double <code>x</code>)</em> <a href="#index-ftrunc" class="copiable-anchor">¶</a></dt>
<dd>
<p>Returns the value of <code>x</code> truncated (to an integer value) towards zero.</p>
</dd>
</dl>
</section>
<section id="mathematical-constants" class="level3 subsection" data-number="6.7.4">
<h3 class="subsection anchored" data-number="6.7.4" data-anchor-id="mathematical-constants"><span class="header-section-number">6.7.4</span> Mathematical constants</h3>
<p>R has a set of commonly used mathematical constants encompassing constants defined by POSIX and usually found in headers <code>math.h</code> and <code>cmath</code>, as well as further ones that are used in statistical computations. These are defined to (at least) 30 digits accuracy in <code>Rmath.h</code>. The following definitions use <code>ln(x)</code> for the natural logarithm (<code>log(x)</code> in R).</p>
<blockquote class="blockquote">
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Definition (<code>ln = log</code>)</th>
<th style="text-align: left;">round(<em>value</em>, 7)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>M_E</code></td>
<td style="text-align: left;"><em>e</em></td>
<td style="text-align: left;">2.7182818</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_LOG2E</code></td>
<td style="text-align: left;">log2(<em>e</em>)</td>
<td style="text-align: left;">1.4426950</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_LOG10E</code></td>
<td style="text-align: left;">log10(<em>e</em>)</td>
<td style="text-align: left;">0.4342945</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_LN2</code></td>
<td style="text-align: left;">ln(2)</td>
<td style="text-align: left;">0.6931472</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_LN10</code></td>
<td style="text-align: left;">ln(10)</td>
<td style="text-align: left;">2.3025851</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_PI</code></td>
<td style="text-align: left;">pi</td>
<td style="text-align: left;">3.1415927</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_PI_2</code></td>
<td style="text-align: left;">pi/2</td>
<td style="text-align: left;">1.5707963</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_PI_4</code></td>
<td style="text-align: left;">pi/4</td>
<td style="text-align: left;">0.7853982</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_1_PI</code></td>
<td style="text-align: left;">1/pi</td>
<td style="text-align: left;">0.3183099</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_2_PI</code></td>
<td style="text-align: left;">2/pi</td>
<td style="text-align: left;">0.6366198</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_2_SQRTPI</code></td>
<td style="text-align: left;">2/sqrt(pi)</td>
<td style="text-align: left;">1.1283792</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_SQRT2</code></td>
<td style="text-align: left;">sqrt(2)</td>
<td style="text-align: left;">1.4142136</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_SQRT1_2</code></td>
<td style="text-align: left;">1/sqrt(2)</td>
<td style="text-align: left;">0.7071068</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_SQRT_3</code></td>
<td style="text-align: left;">sqrt(3)</td>
<td style="text-align: left;">1.7320508</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_SQRT_32</code></td>
<td style="text-align: left;">sqrt(32)</td>
<td style="text-align: left;">5.6568542</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_LOG10_2</code></td>
<td style="text-align: left;">log10(2)</td>
<td style="text-align: left;">0.3010300</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_2PI</code></td>
<td style="text-align: left;">2*pi</td>
<td style="text-align: left;">6.2831853</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_SQRT_PI</code></td>
<td style="text-align: left;">sqrt(pi)</td>
<td style="text-align: left;">1.7724539</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_1_SQRT_2PI</code></td>
<td style="text-align: left;">1/sqrt(2*pi)</td>
<td style="text-align: left;">0.3989423</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_SQRT_2dPI</code></td>
<td style="text-align: left;">sqrt(2/pi)</td>
<td style="text-align: left;">0.7978846</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_LN_SQRT_PI</code></td>
<td style="text-align: left;">ln(sqrt(pi))</td>
<td style="text-align: left;">0.5723649</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>M_LN_SQRT_2PI</code></td>
<td style="text-align: left;">ln(sqrt(2*pi))</td>
<td style="text-align: left;">0.9189385</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>M_LN_SQRT_PId2</code></td>
<td style="text-align: left;">ln(sqrt(pi/2))</td>
<td style="text-align: left;">0.2257914</td>
</tr>
</tbody>
</table>
</blockquote>
<p>There are a set of constants (<code>PI</code>, <code>DOUBLE_EPS</code>) (and so on) defined (unless <code>STRICT_R_HEADERS</code> is defined) in the included header <code>R_ext/Constants.h</code>, mainly for compatibility with S. All but <code>PI</code> are deprecated and should be replaced by the C99/C++11 versions used in that file.</p>
<p>Further, the included header <code>R_ext/Boolean.h</code> has enumeration constants <code>TRUE</code> and <code>FALSE</code> of type <code>Rboolean</code> in order to provide a way of using “logical” variables in C consistently. This can conflict with other software: for example it conflicts with the headers in IJG’s <code>jpeg-9</code> (but not earlier versions).</p>
</section>
</section>
<section id="optimization" class="level2 section" data-number="6.8">
<h2 class="section anchored" data-number="6.8" data-anchor-id="optimization"><span class="header-section-number">6.8</span> Optimization</h2>
<p>The C code underlying <code>optim</code> can be accessed directly. The user needs to supply a function to compute the function to be minimized, of the type</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">double</span> optimfn<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>par<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the first argument is the number of parameters in the second argument. The third argument is a pointer passed down from the calling routine, normally used to carry auxiliary information.</p>
<p>Some of the methods also require a gradient function</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> optimgr<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>par<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>gr<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which passes back the gradient in the <code>gr</code> argument. No function is provided for finite-differencing, nor for approximating the Hessian at the result.</p>
<p>The interfaces (defined in header <code>R_ext/Applic.h</code>) are</p>
<ul>
<li><p>Nelder Mead:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> nmmin<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>xin<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span> optimfn fn<span class="op">,</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> <span class="op">*</span>fail<span class="op">,</span> <span class="dt">double</span> abstol<span class="op">,</span> <span class="dt">double</span> intol<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>           <span class="dt">double</span> alpha<span class="op">,</span> <span class="dt">double</span> beta<span class="op">,</span> <span class="dt">double</span> gamma<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> <span class="op">*</span>fncount<span class="op">,</span> <span class="dt">int</span> maxit<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>BFGS:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vmmin<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>           optimfn fn<span class="op">,</span> optimgr gr<span class="op">,</span> <span class="dt">int</span> maxit<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> <span class="op">*</span>mask<span class="op">,</span> <span class="dt">double</span> abstol<span class="op">,</span> <span class="dt">double</span> reltol<span class="op">,</span> <span class="dt">int</span> nREPORT<span class="op">,</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fncount<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>grcount<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fail<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Conjugate gradients:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cgmin<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>xin<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>           optimfn fn<span class="op">,</span> optimgr gr<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fail<span class="op">,</span> <span class="dt">double</span> abstol<span class="op">,</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>           <span class="dt">double</span> intol<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">int</span> type<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> <span class="op">*</span>fncount<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>grcount<span class="op">,</span> <span class="dt">int</span> maxit<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Limited-memory BFGS with bounds:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> lbfgsb<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">int</span> lmm<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>lower<span class="op">,</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>upper<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>nbd<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span> optimfn fn<span class="op">,</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>            optimgr gr<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fail<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">double</span> factr<span class="op">,</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> pgtol<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fncount<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>grcount<span class="op">,</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> maxit<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>msg<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span> <span class="dt">int</span> nREPORT<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Simulated annealing:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> samin<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>Fmin<span class="op">,</span> optimfn fn<span class="op">,</span> <span class="dt">int</span> maxit<span class="op">,</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>           <span class="dt">int</span> tmax<span class="op">,</span> <span class="dt">double</span> temp<span class="op">,</span> <span class="dt">int</span> trace<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<p>Many of the arguments are common to the various methods. <code>n</code> is the number of parameters, <code>x</code> or <code>xin</code> is the starting parameters on entry and <code>x</code> the final parameters on exit, with final value returned in <code>Fmin</code>. Most of the other parameters can be found from the help page for <code>optim</code>: see the source code <code>src/appl/lbfgsb.c</code> for the values of <code>nbd</code>, which specifies which bounds are to be used.</p>
</section>
<section id="integration" class="level2 section" data-number="6.9">
<h2 class="section anchored" data-number="6.9" data-anchor-id="integration"><span class="header-section-number">6.9</span> Integration</h2>
<p>The C code underlying <code>integrate</code> can be accessed directly. The user needs to supply a <em>vectorizing</em> C function to compute the function to be integrated, of the type</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> integr_fn<span class="op">(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> n<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>x[]</code> is both input and output and has length <code>n</code>, i.e., a C function, say <code>fn</code>, of type <code>integr_fn</code> must basically do <code>for(i in 1:n) x[i] := f(x[i], ex)</code>. The vectorization requirement can be used to speed up the integrand instead of calling it <code>n</code> times. Note that in the current implementation built on QUADPACK, <code>n</code> will be either 15 or 21. The <code>ex</code> argument is a pointer passed down from the calling routine, normally used to carry auxiliary information.</p>
<p>There are interfaces (defined in header <code>R_ext/Applic.h</code>) for integrals over finite and infinite intervals (or “ranges” or “integration boundaries”).</p>
<ul>
<li><p>Finite:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rdqags<span class="op">(</span>integr_fn f<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>a<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>b<span class="op">,</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>epsabs<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>epsrel<span class="op">,</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>result<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>abserr<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>neval<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ier<span class="op">,</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> <span class="op">*</span>limit<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>lenw<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>last<span class="op">,</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> <span class="op">*</span>iwork<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>work<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Infinite:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Rdqagi<span class="op">(</span>integr_fn f<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ex<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>bound<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>inf<span class="op">,</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>epsabs<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>epsrel<span class="op">,</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> <span class="op">*</span>result<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>abserr<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>neval<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ier<span class="op">,</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> <span class="op">*</span>limit<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>lenw<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>last<span class="op">,</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> <span class="op">*</span>iwork<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>work<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<p>Only the 3rd and 4th argument differ for the two integrators; for the finite range integral using <code>Rdqags</code>, <code>a</code> and <code>b</code> are the integration interval bounds, whereas for an infinite range integral using <code>Rdqagi</code>, <code>bound</code> is the finite bound of the integration (if the integral is not doubly-infinite) and <code>inf</code> is a code indicating the kind of integration range,</p>
<dl>
<dt><code>inf = 1</code></dt>
<dd>
<p>corresponds to (bound, +Inf),</p>
</dd>
<dt><code>inf = -1</code></dt>
<dd>
<p>corresponds to (-Inf, bound),</p>
</dd>
<dt><code>inf = 2</code></dt>
<dd>
<p>corresponds to (-Inf, +Inf),</p>
</dd>
</dl>
<p><code>f</code> and <code>ex</code> define the integrand function, see above; <code>epsabs</code> and <code>epsrel</code> specify the absolute and relative accuracy requested, <code>result</code>, <code>abserr</code> and <code>last</code> are the output components <code>value</code>, <code>abs.err</code> and <code>subdivisions</code> of the R function integrate, where <code>neval</code> gives the number of integrand function evaluations, and the error code <code>ier</code> is translated to R’s <code>integrate() $ message</code>, look at that function definition. <code>limit</code> corresponds to <code>integrate(..., subdivisions = *)</code>. It seems you should always define the two work arrays and the length of the second one as</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>    lenw <span class="op">=</span> <span class="dv">4</span> <span class="op">*</span> limit<span class="op">;</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    iwork <span class="op">=</span>   <span class="op">(</span><span class="dt">int</span> <span class="op">*)</span> R_alloc<span class="op">(</span>limit<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    work <span class="op">=</span> <span class="op">(</span><span class="dt">double</span> <span class="op">*)</span> R_alloc<span class="op">(</span>lenw<span class="op">,</span>  <span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The comments in the source code in <code>src/appl/integrate.c</code> give more details, particularly about reasons for failure (<code>ier &gt;= 1</code>).</p>
</section>
<section id="utility-functions" class="level2 section" data-number="6.10">
<h2 class="section anchored" data-number="6.10" data-anchor-id="utility-functions"><span class="header-section-number">6.10</span> Utility functions</h2>
<p>R has a fairly comprehensive set of sort routines which are made available to users’ C code. The following is declared in header file <code>Rinternals.h</code>.</p>
<p><span class="category">Function:</span><em>void</em> <strong>R_orderVector</strong> <em>(int* <code>indx</code>, int <code>n</code>, SEXP <code>arglist</code>, Rboolean <code>nalast</code>, Rboolean <code>decreasing</code>)</em> <a href="#index-r_ordervector" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>R_orderVector1</strong> <em>(int* <code>indx</code>, int <code>n</code>, SEXP <code>x</code>, Rboolean <code>nalast</code>, Rboolean <code>decreasing</code>)</em> <a href="#index-r_ordervector1" class="copiable-anchor">¶</a></p>
<p>: <code>R_orderVector()</code> corresponds to R’s <code>order(..., na.last, decreasing)</code>. More specifically, <code>indx &lt;- order(x, y, na.last, decreasing)</code> corresponds to <code>R_orderVector(indx, n, Rf_lang2(x, y), nalast, decreasing)</code> and for three vectors, <code>Rf_lang3(x,y,z)</code> is used as <code>arglist</code>.</p>
<pre><code>Both `R_orderVector` and `R_orderVector1` assume the vector `indx`
to be allocated to length \&gt;= n. On return, `indx[]` contains a
permutation of `0:(n-1)`, i.e., 0-based C indices (and not 1-based R
indices, as R's `order()`).

When ordering only one vector, `R_orderVector1` is faster and
corresponds (but is 0-based) to R's
`indx &lt;- order(x, na.last, decreasing)`. It was added in R 3.3.0.</code></pre>
<p>All other sort routines are declared in header file <code>R_ext/Utils.h</code> (included by <code>R.h</code>) and include the following.</p>
<p><span class="category">Function:</span><em>void</em> <strong>R_isort</strong> <em>(int* <code>x</code>, int <code>n</code>)</em> <a href="#index-r_isort" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>R_rsort</strong> <em>(double* <code>x</code>, int <code>n</code>)</em> <a href="#index-r_rsort" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>R_csort</strong> <em>(Rcomplex* <code>x</code>, int <code>n</code>)</em> <a href="#index-r_csort" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>rsort_with_index</strong> <em>(double* <code>x</code>, int* <code>index</code>, int <code>n</code>)</em> <a href="#index-rsort_with_index" class="copiable-anchor">¶</a></p>
<p>: The first three sort integer, real (double) and complex data respectively. (Complex numbers are sorted by the real part first then the imaginary part.) <code>NA</code>s are sorted last.</p>
<pre><code>`rsort_with_index` sorts on `x`, and applies the same
permutation to `index`. `NA`s are sorted last.</code></pre>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>void</em> <strong>revsort</strong> <em>(double* <code>x</code>, int* <code>index</code>, int <code>n</code>)</em> <a href="#index-revsort" class="copiable-anchor">¶</a></dt>
<dd>
<p>Is similar to <code>rsort_with_index</code> but sorts into decreasing order, and <code>NA</code>s are not handled.</p>
</dd>
</dl>
<!-- -->
<p><span class="category">Function:</span><em>void</em> <strong>iPsort</strong> <em>(int* <code>x</code>, int <code>n</code>, int <code>k</code>)</em> <a href="#index-ipsort" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>rPsort</strong> <em>(double* <code>x</code>, int <code>n</code>, int <code>k</code>)</em> <a href="#index-rpsort" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>cPsort</strong> <em>(Rcomplex* <code>x</code>, int <code>n</code>, int <code>k</code>)</em> <a href="#index-cpsort" class="copiable-anchor">¶</a></p>
<p>: These all provide (very) partial sorting: they permute <code>x</code> so that <code>x[k]</code> is in the correct place with smaller values to the left, larger ones to the right.</p>
<!-- -->
<p><span class="category">Function:</span><em>void</em> <strong>R_qsort</strong> <em>(double *<code>v</code>, size_t <code>i</code>, size_t <code>j</code>)</em> <a href="#index-r_qsort" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>R_qsort_I</strong> <em>(double *<code>v</code>, int *<code>I</code>, int <code>i</code>, int <code>j</code>)</em> <a href="#index-r_qsort_i" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>R_qsort_int</strong> <em>(int *<code>iv</code>, size_t <code>i</code>, size_t <code>j</code>)</em> <a href="#index-r_qsort_int" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>R_qsort_int_I</strong> <em>(int *<code>iv</code>, int *<code>I</code>, int <code>i</code>, int <code>j</code>)</em> <a href="#index-r_qsort_int_i" class="copiable-anchor">¶</a></p>
<p>: These routines sort <code>v[i:j]</code> or <code>iv[i:j]</code> (using 1-indexing, i.e., <code>v[1]</code> is the first element) calling the quicksort algorithm as used by R’s <code>sort(v, method = "quick")</code> and documented on the help page for the R function <code>sort</code>. The <code>..._I()</code> versions also return the <code>sort.index()</code> vector in <code>I</code>. Note that the ordering is <em>not</em> stable, so tied values may be permuted.</p>
<pre><code>Note that `NA`s are not handled (explicitly) and you should use
different sorting functions if `NA`s can be present.</code></pre>
<!-- -->
<p><span class="category">Function:</span><em>subroutine</em> <strong>qsort4</strong> <em>(double precision <code>v</code>, integer <code>indx</code>, integer <code>ii</code>, integer <code>jj</code>)</em> <a href="#index-qsort4" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>subroutine</em> <strong>qsort3</strong> <em>(double precision <code>v</code>, integer <code>ii</code>, integer <code>jj</code>)</em> <a href="#index-qsort3" class="copiable-anchor">¶</a></p>
<p>: The Fortran interface routines for sorting double precision vectors are <code>qsort3</code> and <code>qsort4</code>, equivalent to <code>R_qsort</code> and <code>R_qsort_I</code>, respectively.</p>
<!-- -->
<dl>
<dt><span class="category">Function:</span><em>void</em> <strong>R_max_col</strong> <em>(double* <code>matrix</code>, int* <code>nr</code>, int* <code>nc</code>, int* <code>maxes</code>, int* <code>ties_meth</code>)</em> <a href="#index-r_max_col" class="copiable-anchor">¶</a></dt>
<dd>
<p>Given the <code>nr</code> by <code>nc</code> matrix <code>matrix</code> in column-major (“Fortran”) order, <code>R_max_col()</code> returns in <code>maxes[i-1]</code> the column number of the maximal element in the <code>i</code>-th row (the same as R’s <code>max.col()</code> function). In the case of ties (multiple maxima), <code>*ties_meth</code> is an integer code in <code>1:3</code> determining the method: 1 = “random”, 2 = “first” and 3 = “last”. See R’s help page <code>?max.col</code>.</p>
</dd>
</dl>
<!-- -->
<p><span class="category">Function:</span><em>int</em> <strong>findInterval</strong> <em>(double* <code>xt</code>, int <code>n</code>, double <code>x</code>, Rboolean <code>rightmost_closed</code>, Rboolean <code>all_inside</code>, int <code>ilo</code>, int* <code>mflag</code>)</em> <a href="#index-findinterval" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>int</em> <strong>findInterval2(double*</strong> <em><code>xt</code>, int <code>n</code>, double <code>x</code>, Rboolean <code>rightmost_closed</code>, Rboolean <code>all_inside</code>, Rboolean <code>left_open</code>, int <code>ilo</code>, int* <code>mflag</code>)</em> <a href="#index-findinterval2_0028double_002a" class="copiable-anchor">¶</a></p>
<p>: Given the ordered vector <code>xt</code> of length <code>n</code>, return the interval or index of <code>x</code> in <code>xt[]</code>, typically max(<em>i</em>; 1 &lt;= i &lt;= <code>n</code> &amp; <em><code>xt</code>[i]</em> &lt;= <code>x</code>) where we use 1-indexing as in R and Fortran (but not C). If <code>rightmost_closed</code> is true, also returns <em><code>n</code>-1</em> if <code>x</code> equals <em><code>xt</code>[<code>n</code>]</em>. If <code>all_inside</code> is not 0, the result is coerced to lie in <code>1:(n-1)</code> even when <code>x</code> is outside the <code>xt</code>[] range. On return, <code>*mflag</code> equals <em>-1</em> if <code>x</code> &lt; <code>xt</code>[1], <em>+1</em> if <code>x</code> &gt;= <code>xt</code>[<code>n</code>], and 0 otherwise.</p>
<pre><code>The algorithm is particularly fast when `ilo` is set to
the last result of `findInterval()` and `x` is a value of
a sequence which is increasing or decreasing for subsequent calls.

`findInterval2()` is a generalization of `findInterval()`, with an
extra `Rboolean` argument `left_open`. Setting
`left_open = TRUE` basically replaces all left-closed right-open
intervals t) by left-open ones t\], see the help page of R function
`findInterval` for details.

There is also an `F77_CALL(interv)()` version of `findInterval()`
with the same arguments, but all pointers.</code></pre>
<p>A system-independent interface to produce the name of a temporary file is provided as</p>
<p><span class="category">Function:</span><em>char *</em> <strong>R_tmpnam</strong> <em>(const char *<code>prefix</code>, const char *<code>tmpdir</code>)</em> <a href="#index-r_tmpnam" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>char *</em> <strong>R_tmpnam2</strong> <em>(const char *<code>prefix</code>, const char *<code>tmpdir</code>, const char *<code>fileext</code>)</em> <a href="#index-r_tmpnam2" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>void</em> <strong>R_free_tmpnam</strong> <em>(char *<code>name</code>)</em> <a href="#index-r_free_tmpnam" class="copiable-anchor">¶</a></p>
<p>: Return a pathname for a temporary file with name beginning with <code>prefix</code> and ending with <code>fileext</code> in directory <code>tmpdir</code>. A <code>NULL</code> prefix or extension is replaced by <code>""</code>. Note that the return value is dynamically allocated and should be freed using <code>R_free_tmpnam</code> when no longer needed (unlike the system call <code>tmpnam</code>). Freeing the result using <code>free</code> is no longer recommended.</p>
<p>There is also the internal function used to expand file names in several R functions, and called directly by <code>path.expand</code>.</p>
<dl>
<dt><span class="category">Function:</span><em>const char *</em> <strong>R_ExpandFileName</strong> <em>(const char *<code>fn</code>)</em> <a href="#index-r_expandfilename" class="copiable-anchor">¶</a></dt>
<dd>
<p>Expand a path name <code>fn</code> by replacing a leading tilde by the user’s home directory (if defined). The precise meaning is platform-specific; it will usually be taken from the environment variable <code>HOME</code> if this is defined.</p>
</dd>
</dl>
<p>For historical reasons there are Fortran interfaces to functions <code>D1MACH</code> and <code>I1MACH</code>. These can be called from C code as e.g. <code>F77_CALL(d1mach)(4)</code>. Note that these are emulations of the original functions by Fox, Hall and Schryer on NetLib at <a href="https://netlib.org/slatec/src/" class="uri">https://netlib.org/slatec/src/</a> for IEC 60559 arithmetic (required by R).</p>
</section>
<section id="re-encoding" class="level2 section" data-number="6.11">
<h2 class="section anchored" data-number="6.11" data-anchor-id="re-encoding"><span class="header-section-number">6.11</span> Re-encoding</h2>
<p>R has its own C-level interface to the encoding conversion capabilities provided by <code>iconv</code> because there are incompatibilities between the declarations in different implementations of <code>iconv</code>.</p>
<p>These are declared in header file <code>R_ext/Riconv.h</code>.</p>
<p><span class="category">Function:</span><em>void *</em> <strong>Riconv_open</strong> <em>(const char *<code>to</code>, const char *<code>from</code>)</em> <a href="#index-riconv_open" class="copiable-anchor">¶</a></p>
<p>Set up a pointer to an encoding object to be used to convert between two encodings: <code>""</code> indicates the current locale.</p>
<p><span class="category">Function:</span><em>size_t</em> <strong>Riconv</strong> <em>(void *<code>cd</code>, const char **<code>inbuf</code>, size_t *<code>inbytesleft</code>, char **<code>outbuf</code>, size_t *<code>outbytesleft</code>)</em> <a href="#index-riconv" class="copiable-anchor">¶</a></p>
<p>Convert as much as possible of <code>inbuf</code> to <code>outbuf</code>. Initially the <code>size_t</code> variables indicate the number of bytes available in the buffers, and they are updated (and the <code>char</code> pointers are updated to point to the next free byte in the buffer). The return value is the number of characters converted, or <code>(size_t)-1</code> (beware: <code>size_t</code> is usually an unsigned type). It should be safe to assume that an error condition sets <code>errno</code> to one of <code>E2BIG</code> (the output buffer is full), <code>EILSEQ</code> (the input cannot be converted, and might be invalid in the encoding specified) or <code>EINVAL</code> (the input does not end with a complete multi-byte character).</p>
<p><span class="category">Function:</span><em>int</em> <strong>Riconv_close</strong> <em>(void * <code>cd</code>)</em> <a href="#index-riconv_close" class="copiable-anchor">¶</a></p>
<p>Free the resources of an encoding object.</p>
</section>
<section id="condition-handling-and-cleanup-code" class="level2 section" data-number="6.12">
<h2 class="section anchored" data-number="6.12" data-anchor-id="condition-handling-and-cleanup-code"><span class="header-section-number">6.12</span> Condition handling and cleanup code</h2>
<p>Three functions are available for establishing condition handlers from within C code:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>SEXP R_tryCatchError<span class="op">(</span>SEXP <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>             SEXP <span class="op">(*</span>hndlr<span class="op">)(</span>SEXP cond<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">);</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>SEXP R_tryCatch<span class="op">(</span>SEXP <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        SEXP<span class="op">,</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        SEXP <span class="op">(*</span>hndlr<span class="op">)(</span>SEXP cond<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">,</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">(*</span>clean<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>cdata<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>cdata<span class="op">);</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>SEXP R_withCallingErrorHandler<span class="op">(</span>SEXP <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>                   SEXP <span class="op">(*</span>hndlr<span class="op">)(</span>SEXP cond<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>hdata<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>R_tryCatchError</code> establishes an exiting handler for conditions inheriting form class <code>error</code>.</p>
<p><code>R_tryCatch</code> can be used to establish a handler for other conditions and to register a cleanup action. The conditions to be handled are specified as a character vector (<code>STRSXP</code>). A <code>NULL</code> pointer can be passed as <code>fun</code> or <code>clean</code> if condition handling or cleanup are not needed.</p>
<p>These are currently implemented using the R-level <code>tryCatch</code> mechanism so are subject to some overhead.</p>
<p><code>R_withCallingErrorHandler</code> establishes a calling handler for conditions inheriting form class <code>error</code>. It establishes the handler without calling back into R and will therefore be more efficient.</p>
<p>The function <code>R_UnwindProtect</code> can be used to ensure that a cleanup action takes place on ordinary return as well as on a non-local transfer of control, which R implements as a <code>longjmp</code>.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>SEXP R_UnwindProtect<span class="op">(</span>SEXP <span class="op">(*</span>fun<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">void</span> <span class="op">(*</span>clean<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span> Rboolean jump<span class="op">),</span> <span class="dt">void</span> <span class="op">*</span>cdata<span class="op">,</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                     SEXP cont<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>R_UnwindProtect</code> can be used in two ways. The simper usage, suitable for use in C code, passes <code>NULL</code> for the <code>cont</code> argument. <code>R_UnwindProtect</code> will call <code>fun(data)</code>. If <code>fun</code> returns a value, then <code>R_UnwindProtect</code> calls <code>clean(cleandata, FALSE)</code> before returning the value returned by <code>fun</code>. If <code>fun</code> executes a non-local transfer of control, then <code>clean(cleandata, TRUE)</code> is called, and the non-local transfer of control is resumed.</p>
<p>The second use pattern, suitable to support C++ stack unwinding, uses two additional functions:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>SEXP R_MakeUnwindCont<span class="op">();</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>NORET <span class="dt">void</span> R_ContinueUnwind<span class="op">(</span>SEXP cont<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>R_MakeUnwindCont</code> allocates a <em>continuation token</em> <code>cont</code> to pass to <code>R_UnwindProtect</code>. This token should be protected with <code>PROTECT</code> before calling <code>R_UnwindProtect</code>. When the <code>clean</code> function is called with <code>jump == TRUE</code>, indicating that R is executing a non-local transfer of control, it can throw a C++ exception to a C++ <code>catch</code> outside the C++ code to be unwound, and then use the continuation token in the a call <code>R_ContinueUnwind(cont)</code> to resume the non-local transfer of control within R.</p>
</section>
<section id="allowing-interrupts" class="level2 section" data-number="6.13">
<h2 class="section anchored" data-number="6.13" data-anchor-id="allowing-interrupts"><span class="header-section-number">6.13</span> Allowing interrupts</h2>
<p>No part of R can be interrupted whilst running long computations in compiled code, so programmers should make provision for the code to be interrupted at suitable points by calling from C</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Utils.h&gt;</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_CheckUserInterrupt<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and from Fortran</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>subroutine <span class="fu">rchkusr</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These check if the user has requested an interrupt, and if so branch to R’s error signaling functions.</p>
<p>Note that it is possible that the code behind one of the entry points defined here if called from your C or Fortran code could be interruptible or generate an error and so not return to your code.</p>
</section>
<section id="platform-and-version-information" class="level2 section page-columns page-full" data-number="6.14">
<h2 class="section anchored" data-number="6.14" data-anchor-id="platform-and-version-information"><span class="header-section-number">6.14</span> Platform and version information</h2>
<p>The header files define <code>USING_R</code>, which can be used to test if the code is indeed being used with R.</p>
<div class="page-columns page-full"><p>Header file <code>Rconfig.h</code> (included by <code>R.h</code>) is used to define platform-specific macros that are mainly for use in other header files. The macro <code>WORDS_BIGENDIAN</code> is defined on big-endian<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> systems (e.g.&nbsp;most OSes on Sparc and PowerPC hardware) and not on little-endian systems (nowadays all the commoner R platforms). It can be useful when manipulating binary files. NB: these macros apply only to the C compiler used to build R, not necessarily to another C or C++ compiler.</p><div class="no-row-height column-margin column-container"><li id="fn6"><p><sup>6</sup>&nbsp;<a href="https://en.wikipedia.org/wiki/Endianness" class="uri">https://en.wikipedia.org/wiki/Endianness</a>.</p></li></div></div>
<p>Header file <code>Rversion.h</code> (<strong>not</strong> included by <code>R.h</code>) defines a macro <code>R_VERSION</code> giving the version number encoded as an integer, plus a macro <code>R_Version</code> to do the encoding. This can be used to test if the version of R is late enough, or to include back-compatibility features. For protection against very old versions of R which did not have this macro, use a construction such as</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined(R_VERSION) &amp;&amp; R_VERSION &gt;= R_Version(3, 1, 0)</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>More detailed information is available in the macros <code>R_MAJOR</code>, <code>R_MINOR</code>, <code>R_YEAR</code>, <code>R_MONTH</code> and <code>R_DAY</code>: see the header file <code>Rversion.h</code> for their format. Note that the minor version includes the patchlevel (as in <code>2.2</code>).</p>
<p>Packages which use <code>alloca</code> need to ensure it is defined: as it is part of neither C nor POSIX there is no standard way to do so. One can use</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rconfig.h&gt;</span><span class="pp"> </span><span class="co">// for HAVE_ALLOCA_H</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef __GNUC__</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co">// this covers gcc, clang, icc</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="pp"># undef alloca</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="pp"># define alloca</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> __builtin_alloca</span><span class="op">((</span><span class="pp">x</span><span class="op">))</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(HAVE_ALLOCA_H)</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co">// needed for native compilers on Solaris and AIX</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="pp"># include </span><span class="im">&lt;alloca.h&gt;</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(and this should be included before standard C headers such as <code>stdlib.h</code>, since on some platforms these include <code>malloc.h</code> which may have a conflicting definition), which suffices for known R platforms.</p>
</section>
<section id="inlining-c-functions" class="level2 section" data-number="6.15">
<h2 class="section anchored" data-number="6.15" data-anchor-id="inlining-c-functions"><span class="header-section-number">6.15</span> Inlining C functions</h2>
<p>The C99 keyword <code>inline</code> should be recognized by all compilers nowadays used to build R. Portable code which might be used with earlier versions of R can be written using the macro <code>R_INLINE</code> (defined in file <code>Rconfig.h</code> included by <code>R.h</code>), as for example from package <a href="https://CRAN.R-project.org/package=cluster"><strong>cluster</strong></a></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> R_INLINE <span class="dt">int</span> ind_2<span class="op">(</span><span class="dt">int</span> l<span class="op">,</span> <span class="dt">int</span> j<span class="op">)</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Be aware that using inlining with functions in more than one compilation unit is almost impossible to do portably, see <a href="https://www.greenend.org.uk/rjk/tech/inline.html" class="uri">https://www.greenend.org.uk/rjk/tech/inline.html</a>, so this usage is for <code>static</code> functions as in the example. All the R configure code has checked is that <code>R_INLINE</code> can be used in a single C file with the compiler used to build R. We recommend that packages making extensive use of inlining include their own configure code.</p>
</section>
<section id="controlling-visibility" class="level2 section page-columns page-full" data-number="6.16">
<h2 class="section anchored" data-number="6.16" data-anchor-id="controlling-visibility"><span class="header-section-number">6.16</span> Controlling visibility</h2>
<div class="page-columns page-full"><p>Header <code>R_ext/Visibility.h</code> has some definitions for controlling the visibility of entry points. These are only effective when <code>HAVE_VISIBILITY_ATTRIBUTE</code> is defined – this is checked when R is configured and recorded in header <code>Rconfig.h</code> (included by <code>R_ext/Visibility.h</code>). It is often defined on modern Unix-alikes with a recent compiler<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>, but not supported on macOS nor Windows. Minimizing the visibility of symbols in a shared library will both speed up its loading (unlikely to be significant) and reduce the possibility of linking to other entry points of the same name.</p><div class="no-row-height column-margin column-container"><li id="fn7"><p><sup>7</sup>&nbsp;It is defined by the Intel compilers, but also hides unsatisfied references and so cannot be used with R. It was not supported by the AIX nor Solaris compilers.</p></li></div></div>
<div class="page-columns page-full"><p>C/C++ entry points prefixed by <code>attribute_hidden</code> will not be visible in the shared object. There is no comparable mechanism for Fortran entry points, but there is a more comprehensive scheme used by, for example package <strong>stats</strong>. Most compilers which allow control of visibility will allow control of visibility for all symbols <em>via</em> a flag, and where known the flag is encapsulated in the macros <code>C_VISIBILITY</code>, <code>CXX_VISIBILITY</code><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> and <code>F_VISIBILITY</code> for C, C++ and Fortran compilers.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> These are defined in <code>etc/Makeconf</code> and so available for normal compilation of package code. For example, <code>src/Makevars</code> could include some of</p><div class="no-row-height column-margin column-container"><li id="fn8"><p><sup>8</sup>&nbsp;This applies to the compiler for the default C++ dialect (currently C++11) and not necessarily to other dialects.</p></li><li id="fn9"><p><sup>9</sup>&nbsp;In some cases Fortran compilers accept the flag but do not actually hide their symbols.</p></li></div></div>
<div class="sourceCode" id="cb63"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>PKG_CFLAGS<span class="op">=</span>$<span class="op">(</span>C_VISIBILITY<span class="op">)</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>PKG_CXXFLAGS<span class="op">=</span>$<span class="op">(</span>CXX_VISIBILITY<span class="op">)</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>PKG_FFLAGS<span class="op">=</span>$<span class="op">(</span>F_VISIBILITY<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This would end up with <strong>no</strong> visible entry points, which would be pointless. However, the effect of the flags can be overridden by using the <code>attribute_visible</code> prefix. A shared object which registers its entry points needs only for have one visible entry point, its initializer, so for example package <strong>stats</strong> has</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> attribute_visible R_init_stats<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    R_registerRoutines<span class="op">(</span>dll<span class="op">,</span> CEntries<span class="op">,</span> CallEntries<span class="op">,</span> FortEntries<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    R_useDynamicSymbols<span class="op">(</span>dll<span class="op">,</span> FALSE<span class="op">);</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Because the <code>C_VISIBILITY</code> mechanism is only useful in conjunction with <code>attribute_visible</code>, it is not enabled unless <code>HAVE_VISIBILITY_ATTRIBUTE</code> is defined. The usual visibility flag is <code>-fvisibility=hidden</code>: some compilers also support <code>-fvisibility-inlines-hidden</code> which can be used by overriding <code>C_VISIBILITY</code> and <code>CXX_VISIBILITY</code> in <code>config.site</code> when building R, or editing <code>etc/Makeconf</code> in the R installation.</p>
<p>Note that <code>configure</code> only checks that visibility attributes and flags are accepted, not that they actually hide symbols.</p>
<p>The visibility mechanism is not available on Windows, but there is an equally effective way to control which entry points are visible, by supplying a definitions file <code>pkgnme/src/pkgname-win.def</code>: only entry points listed in that file will be visible. Again using <strong>stats</strong> as an example, it has</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>LIBRARY stats<span class="op">.</span>dll</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>EXPORTS</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a> R_init_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="using-these-functions-in-your-own-c-code" class="level2 section" data-number="6.17">
<h2 class="section anchored" data-number="6.17" data-anchor-id="using-these-functions-in-your-own-c-code"><span class="header-section-number">6.17</span> Using these functions in your own C code</h2>
<p>It is possible to build <code>Mathlib</code>, the R set of mathematical functions documented in <code>Rmath.h</code>, as a standalone library <code>libRmath</code> under both Unix-alikes and Windows. (This includes the functions documented in <a href="#numerical-analysis-subroutines">Numerical analysis subroutines</a> as from that header file.)</p>
<p>The library is not built automatically when R is installed, but can be built in the directory <code>src/nmath/standalone</code> in the R sources: see the file <code>README</code> there. To use the code in your own C program include</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MATHLIB_STANDALONE</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rmath.h&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and link against <code>-lRmath</code> (and perhaps <code>-lm</code>). There is an example file <code>test.c</code>.</p>
<p>A little care is needed to use the random-number routines. You will need to supply the uniform random number generator</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> unif_rand<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or use the one supplied (and with a dynamic library or DLL you will have to use the one supplied, which is the Marsaglia-multicarry with an entry points</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>set_seed<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span><span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to set its seeds and</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>get_seed<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> <span class="op">*,</span> <span class="dt">unsigned</span> <span class="dt">int</span> <span class="op">*)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to read the seeds).</p>
</section>
<section id="organization-of-header-files" class="level2 section" data-number="6.18">
<h2 class="section anchored" data-number="6.18" data-anchor-id="organization-of-header-files"><span class="header-section-number">6.18</span> Organization of header files</h2>
<p>The header files which R installs are in directory <code>R_INCLUDE_DIR</code> (default <code>R_HOME/include</code>). This currently includes</p>
<blockquote class="blockquote">
<table class="table">
<tbody>
<tr class="odd">
<td><code>R.h</code> includes</td>
<td style="text-align: left;">many other files</td>
</tr>
<tr class="even">
<td><code>Rinternals.h</code> definitio</td>
<td style="text-align: left;">ns for using R’s internal structures</td>
</tr>
<tr class="odd">
<td><code>Rdefines.h</code> macros fo</td>
<td style="text-align: left;">r an S-like interface to the above (no longer maintained)</td>
</tr>
<tr class="even">
<td><code>Rmath.h</code> standalon</td>
<td style="text-align: left;">e math library</td>
</tr>
<tr class="odd">
<td><code>Rversion.h</code> R version</td>
<td style="text-align: left;">information</td>
</tr>
<tr class="even">
<td><code>Rinterface.h</code> for add-o</td>
<td style="text-align: left;">n front-ends (Unix-alikes only)</td>
</tr>
<tr class="odd">
<td><code>Rembedded.h</code> for add-o</td>
<td style="text-align: left;">n front-ends</td>
</tr>
<tr class="even">
<td><code>R_ext/Applic.h</code> optimizat</td>
<td style="text-align: left;">ion and integration</td>
</tr>
<tr class="odd">
<td><code>R_ext/BLAS.h</code> C definit</td>
<td style="text-align: left;">ions for BLAS routines</td>
</tr>
<tr class="even">
<td><code>R_ext/Callbacks.h</code> C (and R</td>
<td style="text-align: left;">function) top-level task handlers</td>
</tr>
<tr class="odd">
<td><code>R_ext/GetX11Image.h</code> X11Image</td>
<td style="text-align: left;">interface used by package <strong>trkplot</strong></td>
</tr>
<tr class="even">
<td><code>R_ext/Lapack.h</code> C definit</td>
<td style="text-align: left;">ions for some LAPACK routines</td>
</tr>
<tr class="odd">
<td><code>R_ext/Linpack.h</code> C definit</td>
<td style="text-align: left;">ions for some LINPACK routines, not all of which are included in R</td>
</tr>
<tr class="even">
<td><code>R_ext/Parse.h</code> a small p</td>
<td style="text-align: left;">art of R’s parse interface: not part of the stable API.</td>
</tr>
<tr class="odd">
<td><code>R_ext/RStartup.h</code> for add-o</td>
<td style="text-align: left;">n front-ends</td>
</tr>
<tr class="even">
<td><code>R_ext/Rdynload.h</code> needed to</td>
<td style="text-align: left;">register compiled code in packages</td>
</tr>
<tr class="odd">
<td><code>R_ext/Riconv.h</code> interface</td>
<td style="text-align: left;">to <code>iconv</code></td>
</tr>
<tr class="even">
<td><code>R_ext/Visibility.h</code> definitio</td>
<td style="text-align: left;">ns controlling visibility</td>
</tr>
<tr class="odd">
<td><code>R_ext/eventloop.h</code> for add-o</td>
<td style="text-align: left;">n front-ends and for packages that need to share in the R event loops (not Windows)</td>
</tr>
</tbody>
</table>
</blockquote>
<p>The following headers are included by <code>R.h</code>:</p>
<blockquote class="blockquote">
<table class="table">
<tbody>
<tr class="odd">
<td><code>Rconfig.h</code> configura</td>
<td style="text-align: left;">tion info that is made available</td>
</tr>
<tr class="even">
<td><code>R_ext/Arith.h</code> handling</td>
<td style="text-align: left;">for <code>NA</code>s, <code>NaN</code>s, <code>Inf</code>/<code>-Inf</code></td>
</tr>
<tr class="odd">
<td><code>R_ext/Boolean.h</code> <code>TRUE</code>/`F</td>
<td style="text-align: left;">ALSE` type</td>
</tr>
<tr class="even">
<td><code>R_ext/Complex.h</code> C typedef</td>
<td style="text-align: left;">s for R’s <code>complex</code></td>
</tr>
<tr class="odd">
<td><code>R_ext/Constants.h</code> constants</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td><code>R_ext/Error.h</code> error sig</td>
<td style="text-align: left;">naling</td>
</tr>
<tr class="odd">
<td><code>R_ext/Memory.h</code> memory al</td>
<td style="text-align: left;">location</td>
</tr>
<tr class="even">
<td><code>R_ext/Print.h</code> <code>Rprintf</code></td>
<td style="text-align: left;">and variations.</td>
</tr>
<tr class="odd">
<td><code>R_ext/RS.h</code> definitio</td>
<td style="text-align: left;">ns common to <code>R.h</code> and the former <code>S.h</code>, including <code>F77_CALL</code> etc.</td>
</tr>
<tr class="even">
<td><code>R_ext/Random.h</code> random nu</td>
<td style="text-align: left;">mber generation</td>
</tr>
<tr class="odd">
<td><code>R_ext/Utils.h</code> sorting a</td>
<td style="text-align: left;">nd other utilities</td>
</tr>
<tr class="even">
<td><code>R_ext/libextern.h</code> definitio</td>
<td style="text-align: left;">ns for exports from <code>R.dll</code> on Windows.</td>
</tr>
</tbody>
</table>
</blockquote>
<p>The graphics systems are exposed in headers <code>R_ext/GraphicsEngine.h</code>, <code>R_ext/GraphicsDevice.h</code> (which it includes) and <code>R_ext/QuartzDevice.h</code>. Facilities for defining custom connection implementations are provided in <code>R_ext/Connections.h</code>, but make sure you consult the file before use.</p>
<p>Let us re-iterate the advice to include system headers before the R header files, especially <code>Rinternals.h</code> (included by <code>Rdefines.h</code>) and <code>Rmath.h</code>, which redefine names which may be used in system headers (fewer if <code>R_NO_REMAP</code> is defined before inclusion, or <code>R_NO_REMAP_RMATH</code> for <code>Rmath.h</code>).</p>
<p>Footnotes</p>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./System-and-foreign-language-interfaces.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">System and foreign language interfaces</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Generic-functions-and-methods.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Generic functions and methods</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">A re-styled version of the original R manuals at <a href="https://cran.r-project.org/manuals.html" class="uri">https://cran.r-project.org/manuals.html</a></div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Built using <a href="https://quarto.org">Quarto</a></div>
  </div>
</footer>



</body></html>