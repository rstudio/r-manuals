<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5&nbsp; System and foreign language interfaces – R Manuals :: Writing R Extensions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./The-R-API.html" rel="next">
<link href="./Debugging.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">R Manuals :: Writing R Extensions</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-manuals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Manuals</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-manuals">    
        <li>
    <a class="dropdown-item" href="./../r-intro/index.html">
 <span class="dropdown-text">An Introduction to R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-data/index.html">
 <span class="dropdown-text">R Data Import/Export</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-admin/index.html">
 <span class="dropdown-text">R Installation and Administration</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-exts/index.html">
 <span class="dropdown-text">Writing R Extensions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-lang/index.html">
 <span class="dropdown-text">R Language Definition</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./../r-ints/index.html">
 <span class="dropdown-text">R Internals</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./System-and-foreign-language-interfaces.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">System and foreign language interfaces</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Writing R Extensions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Creating-R-packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Creating R packages</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Writing-R-documentation-files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Writing R documentation files</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Tidying-and-profiling-R-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Tidying and profiling R code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Debugging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Debugging</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./System-and-foreign-language-interfaces.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">System and foreign language interfaces</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./The-R-API.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The R API: entry points for C code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Generic-functions-and-methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Generic functions and methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Linking-GUIs-and-other-front-ends-to-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Linking GUIs and other front-ends to R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Function-and-variable-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Function and variable index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Concept-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Concept index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">API index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Experimental-API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Experimental API index</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Embedding-API-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Embedding API index</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#operating-system-access" id="toc-operating-system-access" class="nav-link active" data-scroll-target="#operating-system-access"><span class="header-section-number">5.1</span> Operating system access</a></li>
  <li><a href="#interface-functions-.c-and-.fortran" id="toc-interface-functions-.c-and-.fortran" class="nav-link" data-scroll-target="#interface-functions-.c-and-.fortran"><span class="header-section-number">5.2</span> Interface functions <code>.C</code> and <code>.Fortran</code></a></li>
  <li><a href="#dyn.load-and-dyn.unload" id="toc-dyn.load-and-dyn.unload" class="nav-link" data-scroll-target="#dyn.load-and-dyn.unload"><span class="header-section-number">5.3</span> <code>dyn.load</code> and <code>dyn.unload</code></a></li>
  <li><a href="#registering-native-routines" id="toc-registering-native-routines" class="nav-link" data-scroll-target="#registering-native-routines"><span class="header-section-number">5.4</span> Registering native routines</a>
  <ul class="collapse">
  <li><a href="#speed-considerations" id="toc-speed-considerations" class="nav-link" data-scroll-target="#speed-considerations"><span class="header-section-number">5.4.1</span> Speed considerations</a></li>
  <li><a href="#example-converting-a-package-to-use-registration" id="toc-example-converting-a-package-to-use-registration" class="nav-link" data-scroll-target="#example-converting-a-package-to-use-registration"><span class="header-section-number">5.4.2</span> Example: converting a package to use registration</a></li>
  <li><a href="#linking-to-native-routines-in-other-packages" id="toc-linking-to-native-routines-in-other-packages" class="nav-link" data-scroll-target="#linking-to-native-routines-in-other-packages"><span class="header-section-number">5.4.3</span> Linking to native routines in other packages</a></li>
  </ul></li>
  <li><a href="#creating-shared-objects" id="toc-creating-shared-objects" class="nav-link" data-scroll-target="#creating-shared-objects"><span class="header-section-number">5.5</span> Creating shared objects</a></li>
  <li><a href="#interfacing-c-code" id="toc-interfacing-c-code" class="nav-link" data-scroll-target="#interfacing-c-code"><span class="header-section-number">5.6</span> Interfacing C++ code</a>
  <ul class="collapse">
  <li><a href="#external-c-code" id="toc-external-c-code" class="nav-link" data-scroll-target="#external-c-code"><span class="header-section-number">5.6.1</span> External C++ code</a></li>
  </ul></li>
  <li><a href="#fortran-io" id="toc-fortran-io" class="nav-link" data-scroll-target="#fortran-io"><span class="header-section-number">5.7</span> Fortran I/O</a></li>
  <li><a href="#linking-to-other-packages" id="toc-linking-to-other-packages" class="nav-link" data-scroll-target="#linking-to-other-packages"><span class="header-section-number">5.8</span> Linking to other packages</a>
  <ul class="collapse">
  <li><a href="#unix-alikes" id="toc-unix-alikes" class="nav-link" data-scroll-target="#unix-alikes"><span class="header-section-number">5.8.1</span> Unix-alikes</a></li>
  <li><a href="#windows" id="toc-windows" class="nav-link" data-scroll-target="#windows"><span class="header-section-number">5.8.2</span> Windows</a></li>
  </ul></li>
  <li><a href="#handling-r-objects-in-c" id="toc-handling-r-objects-in-c" class="nav-link" data-scroll-target="#handling-r-objects-in-c"><span class="header-section-number">5.9</span> Handling R objects in C</a>
  <ul class="collapse">
  <li><a href="#handling-the-effects-of-garbage-collection" id="toc-handling-the-effects-of-garbage-collection" class="nav-link" data-scroll-target="#handling-the-effects-of-garbage-collection"><span class="header-section-number">5.9.1</span> Handling the effects of garbage collection</a></li>
  <li><a href="#allocating-storage" id="toc-allocating-storage" class="nav-link" data-scroll-target="#allocating-storage"><span class="header-section-number">5.9.2</span> Allocating storage</a></li>
  <li><a href="#details-of-r-types" id="toc-details-of-r-types" class="nav-link" data-scroll-target="#details-of-r-types"><span class="header-section-number">5.9.3</span> Details of R types</a></li>
  <li><a href="#attributes" id="toc-attributes" class="nav-link" data-scroll-target="#attributes"><span class="header-section-number">5.9.4</span> Attributes</a></li>
  <li><a href="#classes" id="toc-classes" class="nav-link" data-scroll-target="#classes"><span class="header-section-number">5.9.5</span> Classes</a></li>
  <li><a href="#s4-objects" id="toc-s4-objects" class="nav-link" data-scroll-target="#s4-objects"><span class="header-section-number">5.9.6</span> S4 objects</a></li>
  <li><a href="#handling-lists" id="toc-handling-lists" class="nav-link" data-scroll-target="#handling-lists"><span class="header-section-number">5.9.7</span> Handling lists</a></li>
  <li><a href="#handling-character-data" id="toc-handling-character-data" class="nav-link" data-scroll-target="#handling-character-data"><span class="header-section-number">5.9.8</span> Handling character data</a></li>
  <li><a href="#working-with-closures" id="toc-working-with-closures" class="nav-link" data-scroll-target="#working-with-closures"><span class="header-section-number">5.9.9</span> Working with closures</a></li>
  <li><a href="#finding-and-setting-variables" id="toc-finding-and-setting-variables" class="nav-link" data-scroll-target="#finding-and-setting-variables"><span class="header-section-number">5.9.10</span> Finding and setting variables</a></li>
  <li><a href="#some-convenience-functions" id="toc-some-convenience-functions" class="nav-link" data-scroll-target="#some-convenience-functions"><span class="header-section-number">5.9.11</span> Some convenience functions</a></li>
  <li><a href="#semi-internal-convenience-functions" id="toc-semi-internal-convenience-functions" class="nav-link" data-scroll-target="#semi-internal-convenience-functions"><span class="header-section-number">5.9.12</span> Semi-internal convenience functions</a></li>
  <li><a href="#named-objects-and-copying" id="toc-named-objects-and-copying" class="nav-link" data-scroll-target="#named-objects-and-copying"><span class="header-section-number">5.9.13</span> Named objects and copying</a></li>
  </ul></li>
  <li><a href="#interface-functions-.call-and-.external" id="toc-interface-functions-.call-and-.external" class="nav-link" data-scroll-target="#interface-functions-.call-and-.external"><span class="header-section-number">5.10</span> Interface functions <code>.Call</code> and <code>.External</code></a>
  <ul class="collapse">
  <li><a href="#calling-.call" id="toc-calling-.call" class="nav-link" data-scroll-target="#calling-.call"><span class="header-section-number">5.10.1</span> Calling <code>.Call</code></a></li>
  <li><a href="#calling-.external" id="toc-calling-.external" class="nav-link" data-scroll-target="#calling-.external"><span class="header-section-number">5.10.2</span> Calling <code>.External</code></a></li>
  <li><a href="#missing-and-special-values" id="toc-missing-and-special-values" class="nav-link" data-scroll-target="#missing-and-special-values"><span class="header-section-number">5.10.3</span> Missing and special values</a></li>
  </ul></li>
  <li><a href="#evaluating-r-expressions-from-c" id="toc-evaluating-r-expressions-from-c" class="nav-link" data-scroll-target="#evaluating-r-expressions-from-c"><span class="header-section-number">5.11</span> Evaluating R expressions from C</a>
  <ul class="collapse">
  <li><a href="#zero-finding" id="toc-zero-finding" class="nav-link" data-scroll-target="#zero-finding"><span class="header-section-number">5.11.1</span> Zero-finding</a></li>
  <li><a href="#calculating-numerical-derivatives" id="toc-calculating-numerical-derivatives" class="nav-link" data-scroll-target="#calculating-numerical-derivatives"><span class="header-section-number">5.11.2</span> Calculating numerical derivatives</a></li>
  </ul></li>
  <li><a href="#parsing-r-code-from-c" id="toc-parsing-r-code-from-c" class="nav-link" data-scroll-target="#parsing-r-code-from-c"><span class="header-section-number">5.12</span> Parsing R code from C</a>
  <ul class="collapse">
  <li><a href="#accessing-source-references" id="toc-accessing-source-references" class="nav-link" data-scroll-target="#accessing-source-references"><span class="header-section-number">5.12.1</span> Accessing source references</a></li>
  </ul></li>
  <li><a href="#external-pointers-and-weak-references" id="toc-external-pointers-and-weak-references" class="nav-link" data-scroll-target="#external-pointers-and-weak-references"><span class="header-section-number">5.13</span> External pointers and weak references</a>
  <ul class="collapse">
  <li><a href="#an-example" id="toc-an-example" class="nav-link" data-scroll-target="#an-example"><span class="header-section-number">5.13.1</span> An example</a></li>
  </ul></li>
  <li><a href="#vector-accessor-functions" id="toc-vector-accessor-functions" class="nav-link" data-scroll-target="#vector-accessor-functions"><span class="header-section-number">5.14</span> Vector accessor functions</a></li>
  <li><a href="#character-encoding-issues" id="toc-character-encoding-issues" class="nav-link" data-scroll-target="#character-encoding-issues"><span class="header-section-number">5.15</span> Character encoding issues</a></li>
  <li><a href="#writing-compact-representation-friendly-code" id="toc-writing-compact-representation-friendly-code" class="nav-link" data-scroll-target="#writing-compact-representation-friendly-code"><span class="header-section-number">5.16</span> Writing compact-representation-friendly code</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">System and foreign language interfaces</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="operating-system-access" class="level2 section" data-number="5.1">
<h2 class="section anchored" data-number="5.1" data-anchor-id="operating-system-access"><span class="header-section-number">5.1</span> Operating system access</h2>
<p>Access to operating system functions is <em>via</em> the R functions <code>system</code> and <code>system2</code>. The details will differ by platform (see the on-line help), and about all that can safely be assumed is that the first argument will be a string <code>command</code> that will be passed for execution (not necessarily by a shell) and the second argument to <code>system</code> will be <code>internal</code> which if true will collect the output of the command into an R character vector.</p>
<p>On POSIX-compliant OSes these commands pass a command-line to a shell: Windows is not POSIX-compliant and there is a separate function <code>shell</code> to do so.</p>
<p>The function <code>system.time</code> is available for timing. Timing on child processes is only available on Unix-alikes, and may not be reliable there.</p>
</section>
<section id="interface-functions-.c-and-.fortran" class="level2 section page-columns page-full" data-number="5.2">
<h2 class="section anchored" data-number="5.2" data-anchor-id="interface-functions-.c-and-.fortran"><span class="header-section-number">5.2</span> Interface functions <code>.C</code> and <code>.Fortran</code></h2>
<p>These two functions provide an interface to compiled code that has been linked into R, either at build time or <em>via</em> <code>dyn.load</code> (see <a href="#dyn.load-and-dyn.unload"><code>dyn.load</code> and <code>dyn.unload</code></a>). They are primarily intended for compiled C and Fortran code respectively, but the <code>.C</code> function can be used with other languages which can generate C interfaces, for example C++ (see <a href="#interfacing-c-code">Interfacing C++ code</a>).</p>
<p>The first argument to each function is a character string specifying the symbol name as known<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> to C or Fortran, that is the function or subroutine name. (That the symbol is loaded can be tested by, for example, <code>is.loaded("cg")</code>. Use the name you pass to <code>.C</code> or <code>.Fortran</code> rather than the translated symbol name.)</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;possibly after some platform-specific translation, e.g.&nbsp;adding leading or trailing underscores.</p></div></div><p>There can be up to 65 further arguments giving R objects to be passed to compiled code. Normally these are copied before being passed in, and copied again to an R list object when the compiled code returns. If the arguments are given names, these are used as names for the components in the returned list object (but not passed to the compiled code).</p>
<p>The following table gives the mapping between the modes of R atomic vectors and the types of arguments to a C function or Fortran subroutine.</p>
<blockquote class="blockquote">
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">R storage mode</th>
<th style="text-align: left;">C type</th>
<th style="text-align: left;">Fortran type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>logical</code></td>
<td style="text-align: left;"><code>int *</code></td>
<td style="text-align: left;"><code>INTEGER</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>integer</code></td>
<td style="text-align: left;"><code>int *</code></td>
<td style="text-align: left;"><code>INTEGER</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>double</code></td>
<td style="text-align: left;"><code>double *</code></td>
<td style="text-align: left;"><code>DOUBLE PRECISION</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>complex</code></td>
<td style="text-align: left;"><code>Rcomplex *</code></td>
<td style="text-align: left;"><code>DOUBLE COMPLEX</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>character</code></td>
<td style="text-align: left;"><code>char **</code></td>
<td style="text-align: left;"><code>CHARACTER(255)</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>raw</code></td>
<td style="text-align: left;"><code>unsigned char *</code></td>
<td style="text-align: left;">none</td>
</tr>
</tbody>
</table>
</blockquote>
<p>On all R platforms <code>int</code> and <code>INTEGER</code> are 32-bit. Code ported from S-PLUS (which uses <code>long *</code> for <code>logical</code> and <code>integer</code>) will not work on all 64-bit platforms (although it may appear to work on some, including <code>x86_64</code> Windows). Note also that if your compiled code is a mixture of C functions and Fortran subprograms the argument types must match as given in the table above.</p>
<p>C type <code>Rcomplex</code> is a structure with <code>double</code> members <code>r</code> and <code>i</code> defined in the header file <code>R_ext/Complex.h</code>.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> (On most platforms this is stored in a way compatible with the C99 <code>double complex</code> type: however, it may not be possible to pass <code>Rcomplex</code> to a C99 function expecting a <code>double complex</code> argument. Nor need it be compatible with a C++ <code>complex</code> type. Moreover, the compatibility can depend on the optimization level set for the compiler.)</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;This is currently included by <code>R.h</code> but may not be in future, so it should be included by code needing the type.</p></div></div><p>Only a single character string of fixed length can be passed to or from Fortran (the length is not passed), and the success of this is compiler-dependent: its use was formally deprecated in 2019. Other R objects can be passed to <code>.C</code>, but it is much better to use one of the other interfaces.</p>
<p>It is possible to pass numeric vectors of storage mode <code>double</code> to C as <code>float *</code> or to Fortran as <code>REAL</code> by setting the attribute <code>Csingle</code>, most conveniently by using the R functions <code>as.single</code>, <code>single</code> or <code>mode</code>. This is intended only to be used to aid interfacing existing C or Fortran code.</p>
<p>Logical values are sent as <code>0</code> (<code>FALSE</code>), <code>1</code> (<code>TRUE</code>) or <code>INT_MIN = -2147483648</code> (<code>NA</code>, but only if <code>NAOK</code> is true), and the compiled code should return one of these three values. (Non-zero values other than <code>INT_MIN</code> are mapped to <code>TRUE</code>.) Note that the use of <code>int *</code> for Fortran logical is not guaranteed to be portable (although people have gotten away with it for many years): it is better to pass integers and convert to/from Fortran logical in a Fortran wrapper.</p>
<p>Unless formal argument <code>NAOK</code> is true, all the other arguments are checked for missing values <code>NA</code> and for the IEEE special values <code>NaN</code>, <code>Inf</code> and <code>-Inf</code>, and the presence of any of these generates an error. If it is true, these values are passed unchecked.</p>
<p>Argument <code>PACKAGE</code> confines the search for the symbol name to a specific shared object (or use <code>"base"</code> for code compiled into R). Its use is highly desirable, as there is no way to avoid two package writers using the same symbol name, and such name clashes are normally sufficient to cause R to crash. (If it is not present and the call is from the body of a function defined in a package namespace, the shared object loaded by the first (if any) <code>useDynLib</code> directive will be used.)</p>
<p>Note that the compiled code should not return anything except through its arguments: C functions should be of type <code>void</code> and Fortran subprograms should be subroutines.</p>
<p>To fix ideas, let us consider a very simple example which convolves two finite sequences. (This is hard to do fast in interpreted R code, but easy in C code.) We could do this using <code>.C</code> by</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> convolve<span class="op">(</span><span class="dt">double</span> <span class="op">*</span>a<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>na<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>b<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>nb<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>ab<span class="op">)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> nab <span class="op">=</span> <span class="op">*</span>na <span class="op">+</span> <span class="op">*</span>nb <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nab<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        ab<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="op">*</span>na<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="op">*</span>nb<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>            ab<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">+=</span> a<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> b<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>called from R by</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>conv <span class="op">&lt;-</span> function<span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>C<span class="op">(</span><span class="st">"convolve"</span><span class="op">,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>       as<span class="op">.</span><span class="dt">double</span><span class="op">(</span>a<span class="op">),</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>       as<span class="op">.</span>integer<span class="op">(</span>length<span class="op">(</span>a<span class="op">)),</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>       as<span class="op">.</span><span class="dt">double</span><span class="op">(</span>b<span class="op">),</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>       as<span class="op">.</span>integer<span class="op">(</span>length<span class="op">(</span>b<span class="op">)),</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>       ab <span class="op">=</span> <span class="dt">double</span><span class="op">(</span>length<span class="op">(</span>a<span class="op">)</span> <span class="op">+</span> length<span class="op">(</span>b<span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="op">))</span>$ab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that we take care to coerce all the arguments to the correct R storage mode before calling <code>.C</code>; mistakes in matching the types can lead to wrong results or hard-to-catch errors.</p>
<p>Special care is needed in handling <code>character</code> vector arguments in C (or C++). On entry the contents of the elements are duplicated and assigned to the elements of a <code>char **</code> array, and on exit the elements of the C array are copied to create new elements of a character vector. This means that the contents of the character strings of the <code>char **</code> array can be changed, including to <code>\0</code> to shorten the string, but the strings cannot be lengthened. It is possible<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> to allocate a new string <em>via</em> <code>R_alloc</code> and replace an entry in the <code>char **</code> array by the new string. However, when character vectors are used other than in a read-only way, the <code>.Call</code> interface is much to be preferred.</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;Note that this is then not checked for over-runs by option <code>CBoundsCheck = TRUE</code>.</p></div></div><p>Passing character strings to Fortran code needs even more care, is deprecated and should be avoided where possible. Only the first element of the character vector is passed in, as a fixed-length (255) character array. Up to 255 characters are passed back to a length-one character vector. How well this works (or even if it works at all) depends on the C and Fortran compilers on each platform (including on their options). Often what is being passed to Fortran is one of a small set of possible values (a factor in R terms) which could alternatively be passed as an integer code: similarly Fortran code that wants to generate diagnostic messages could pass an integer code to a C or R wrapper which would convert it to a character string.</p>
<p>It is possible to pass some R objects other than atomic vectors <em>via</em> <code>.C</code>, but this is only supported for historical compatibility: use the <code>.Call</code> or <code>.External</code> interfaces for such objects. Any C/C++ code that includes <code>Rinternals.h</code> should be called <em>via</em> <code>.Call</code> or <code>.External</code>.</p>
<p><code>.Fortran</code> is primarily intended for Fortran 77 code, and long precedes any support for ‘modern’ Fortran. Nowadays implementations of Fortran support the Fortran 2003 module <code>iso_c_binding</code>, a better way to interface modern Fortran code to R is to use <code>.C</code> and write a C interface using <code>use iso_c_binding</code>.</p>
</section>
<section id="dyn.load-and-dyn.unload" class="level2 section page-columns page-full" data-number="5.3">
<h2 class="section anchored" data-number="5.3" data-anchor-id="dyn.load-and-dyn.unload"><span class="header-section-number">5.3</span> <code>dyn.load</code> and <code>dyn.unload</code></h2>
<p>Compiled code to be used with R is loaded as a shared object (Unix-alikes including macOS, see <a href="#creating-shared-objects">Creating shared objects</a> for more information) or DLL (Windows).</p>
<p>The shared object/DLL is loaded by <code>dyn.load</code> and unloaded by <code>dyn.unload</code>. Unloading is not normally necessary and is not safe in general, but it is needed to allow the DLL to be re-built on some platforms, including Windows. Unloading a DLL and then re-loading a DLL of the same name may not work: Solaris used the first version loaded. A DLL that registers C finalizers, but fails to unregister them when unloaded, may cause R to crash after unloading.</p>
<p>The first argument to both functions is a character string giving the path to the object. Programmers should not assume a specific file extension for the object/DLL (such as <code>.so</code>) but use a construction like</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file.path</span>(path1, path2, <span class="fu">paste0</span>(<span class="st">"mylib"</span>, .Platform<span class="sc">$</span>dynlib.ext))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>for platform independence. On Unix-alike systems the path supplied to <code>dyn.load</code> can be an absolute path, one relative to the current directory or, if it starts with <code>~</code>, relative to the user’s home directory.</p>
<p>Loading is most often done automatically based on the <code>useDynLib()</code> declaration in the <code>NAMESPACE</code> file, but may be done explicitly <em>via</em> a call to <code>library.dynam</code>. This has the form</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library.dynam</span>(<span class="st">"libname"</span>, package, lib.loc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>libname</code> is the object/DLL name <em>with the extension omitted</em>. Note that the first argument, <code>chname</code>, should <strong>not</strong> be <code>package</code> since this will not work if the package is installed under another name.</p>
<p>Under some Unix-alike systems there is a choice of how the symbols are resolved when the object is loaded, governed by the arguments <code>local</code> and <code>now</code>. Only use these if really necessary: in particular using <code>now=FALSE</code> and then calling an unresolved symbol will terminate R unceremoniously.</p>
<p>R provides a way of executing some code automatically when a object/DLL is either loaded or unloaded. This can be used, for example, to register native routines with R’s dynamic symbol mechanism, initialize some data in the native code, or initialize a third party library. On loading a DLL, R will look for a routine within that DLL named <code>R_init_lib</code> where <code>lib</code> is the name of the DLL file with the extension removed. For example, in the command</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library.dynam</span>(<span class="st">"mylib"</span>, package, lib.loc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>R looks for the symbol named <code>R_init_mylib</code>. Similarly, when unloading the object, R looks for a routine named <code>R_unload_lib</code>, e.g., <code>R_unload_mylib</code>. In either case, if the routine is present, R will invoke it and pass it a single argument describing the DLL. This is a value of type <code>DllInfo</code> which is defined in the <code>Rdynload.h</code> file in the <code>R_ext</code> directory.</p>
<p>Note that there are some implicit restrictions on this mechanism as the basename of the DLL needs to be both a valid file name and valid as part of a C entry point (e.g.&nbsp;it cannot contain <code>.</code>): for portable code it is best to confine DLL names to be ASCII alphanumeric plus underscore. If entry point <code>R_init_lib</code> is not found it is also looked for with <code>.</code> replaced by <code>_</code>.</p>
<p>The following example shows templates for the initialization and unload routines for the <code>mylib</code> DLL.</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Rdynload.h&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>R_init_mylib<span class="op">(</span>DllInfo <span class="op">*</span>info<span class="op">)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Register routines,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">     allocate resources. */</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>R_unload_mylib<span class="op">(</span>DllInfo <span class="op">*</span>info<span class="op">)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Release resources. */</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>If a shared object/DLL is loaded more than once the most recent version is used.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> More generally, if the same symbol name appears in several shared objects, the most recently loaded occurrence is used. The <code>PACKAGE</code> argument and registration (see the next section) provide good ways to avoid any ambiguity in which occurrence is meant.</p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;Strictly this is OS-specific, but no exceptions have been seen for many years.</p></div></div><p>On Unix-alikes the paths used to resolve dynamically linked dependent libraries are fixed (for security reasons) when the process is launched, so <code>dyn.load</code> will only look for such libraries in the locations set by the <code>R</code> shell script (<em>via</em> <code>etc/ldpaths</code>) and in the OS-specific defaults.</p>
<p>Windows allows more control (and less security) over where dependent DLLs are looked for. On all versions this includes the <code>PATH</code> environment variable, but with lowest priority: note that it does not include the directory from which the DLL was loaded. It is possible to add a single path with quite high priority <em>via</em> the <code>DLLpath</code> argument to <code>dyn.load</code>. This is (by default) used by <code>library.dynam</code> to include the package’s <code>libs/x64</code> directory (on Intel) in the DLL search path.</p>
</section>
<section id="registering-native-routines" class="level2 section page-columns page-full" data-number="5.4">
<h2 class="section anchored" data-number="5.4" data-anchor-id="registering-native-routines"><span class="header-section-number">5.4</span> Registering native routines</h2>
<p>By ‘native’ routine, we mean an entry point in compiled code.</p>
<p>In calls to <code>.C</code>, <code>.Call</code>, <code>.Fortran</code> and <code>.External</code>, R must locate the specified native routine by looking in the appropriate shared object/DLL. By default, R uses the operating-system-specific dynamic loader to lookup the symbol in all<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> loaded DLLs and the R executable or libraries it is linked to. Alternatively, the author of the DLL can explicitly register routines with R and use a single, platform-independent mechanism for finding the routines in the DLL. One can use this registration mechanism to provide additional information about a routine, including the number and type of the arguments, and also make it available to R programmers under a different name.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;For calls from within a namespace the search is confined to the DLL loaded for that package.</p></div><div id="fn6"><p><sup>6</sup>&nbsp;For unregistered entry points the OS’s <code>dlsym</code> routine is used to find addresses. Its performance varies considerably by OS and even in the best case it will need to search a much larger symbol table than, say, the table of <code>.Call</code> entry points.</p></div></div><p>Registering routines has two main advantages: it provides a faster<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> way to find the address of the entry point <em>via</em> tables stored in the DLL at compilation time, and it provides a run-time check that the entry point is called with the right number of arguments and, optionally, the right argument types.</p>
<p>To register routines with R, one calls the C routine <code>R_registerRoutines</code>. This is typically done when the DLL is first loaded within the initialization routine <code>R_init_dll name</code> described in <a href="#dyn.load-and-dyn.unload"><code>dyn.load</code> and <code>dyn.unload</code></a>. <code>R_registerRoutines</code> takes 5 arguments. The first is the <code>DllInfo</code> object passed by R to the initialization routine. This is where R stores the information about the methods. The remaining 4 arguments are arrays describing the routines for each of the 4 different interfaces: <code>.C</code>, <code>.Call</code>, <code>.Fortran</code> and <code>.External</code>. Each argument is a <code>NULL</code>-terminated array of the element types given in the following table:</p>
<blockquote class="blockquote">
<table class="caption-top table">
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>.C</code></td>
<td style="text-align: left;"><code>R_CMethodDef</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>.Call</code></td>
<td style="text-align: left;"><code>R_CallMethodDef</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>.Fortran</code></td>
<td style="text-align: left;"><code>R_FortranMethodDef</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>.External</code></td>
<td style="text-align: left;"><code>R_ExternalMethodDef</code></td>
</tr>
</tbody>
</table>
</blockquote>
<p>Currently, the <code>R_ExternalMethodDef</code> type is the same as <code>R_CallMethodDef</code> type and contains fields for the name of the routine by which it can be accessed in R, a pointer to the actual native symbol (i.e., the routine itself), and the number of arguments the routine expects to be passed from R. For example, if we had a routine named <code>myCall</code> defined as</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>SEXP myCall<span class="op">(</span>SEXP a<span class="op">,</span> SEXP b<span class="op">,</span> SEXP c<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>we would describe this as</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> R_CallMethodDef callMethods<span class="op">[]</span>  <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span><span class="st">"myCall"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>myCall<span class="op">,</span> <span class="dv">3</span><span class="op">},</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>NULL<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">}</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>along with any other routines for the <code>.Call</code> interface. For routines with a variable number of arguments invoked <em>via</em> the <code>.External</code> interface, one specifies <code>-1</code> for the number of arguments which tells R not to check the actual number passed.</p>
<p>Routines for use with the <code>.C</code> and <code>.Fortran</code> interfaces are described with similar data structures, which have one optional additional field for describing the type of each argument. If specified, this field should be an array with the <code>SEXP</code> types describing the expected type of each argument of the routine. (Technically, the elements of the types array are of type <code>R_NativePrimitiveArgType</code> which is just an unsigned integer.) The R types and corresponding type identifiers are provided in the following table:</p>
<blockquote class="blockquote">
<table class="caption-top table">
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>numeric</code></td>
<td style="text-align: left;"><code>REALSXP</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>integer</code></td>
<td style="text-align: left;"><code>INTSXP</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>logical</code></td>
<td style="text-align: left;"><code>LGLSXP</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>single</code></td>
<td style="text-align: left;"><code>SINGLESXP</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>character</code></td>
<td style="text-align: left;"><code>STRSXP</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>list</code></td>
<td style="text-align: left;"><code>VECSXP</code></td>
</tr>
</tbody>
</table>
</blockquote>
<p>Consider a C routine, <code>myC</code>, declared as</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> myC<span class="op">(</span><span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>names<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>status<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We would register it as</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> R_NativePrimitiveArgType myC_type<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    REALSXP<span class="op">,</span> INTSXP<span class="op">,</span> STRSXP<span class="op">,</span> LGLSXP</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> R_CMethodDef cMethods<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span><span class="st">"myC"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>myC<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> myC_type<span class="op">},</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span>NULL<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> NULL<span class="op">}</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If registering types, check carefully that the number of types matches the number of arguments: as the type array (here <code>myC_type</code>) is passed as a pointer in C, the registration mechanism cannot check this for you.</p>
<p>Note that <code>.Fortran</code> entry points are mapped to lowercase, so registration should use lowercase only.</p>
<p>Having created the arrays describing each routine, the last step is to actually register them with R. We do this by calling <code>R_registerRoutines</code>. For example, if we have the descriptions above for the routines accessed by the <code>.C</code> and <code>.Call</code> we would use the following code:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>void</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">R_init_myLib</span>(DllInfo <span class="sc">*</span>info)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">R_registerRoutines</span>(info, cMethods, callMethods, <span class="cn">NULL</span>, <span class="cn">NULL</span>);</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This routine will be invoked when R loads the shared object/DLL named <code>myLib</code>. The last two arguments in the call to <code>R_registerRoutines</code> are for the routines accessed by <code>.Fortran</code> and <code>.External</code> interfaces. In our example, these are given as <code>NULL</code> since we have no routines of these types.</p>
<p>When R unloads a shared object/DLL, its registrations are removed. There is no other facility for unregistering a symbol.</p>
<p>Examples of registering routines can be found in the different packages in the R source tree (e.g., <strong>stats</strong> and <strong>graphics</strong>). Also, there is a brief, high-level introduction in <em>R News</em> (volume 1/3, September 2001, pages 20–23, <a href="https://www.r-project.org/doc/Rnews/Rnews_2001-3.pdf" class="uri">https://www.r-project.org/doc/Rnews/Rnews_2001-3.pdf</a>).</p>
<p>Once routines are registered, they can be referred to as R objects if this is arranged in the <code>useDynLib</code> call in the package’s <code>NAMESPACE</code> file (see <a href="Creating-R-packages.html#usedynlib"><code>useDynLib</code></a>). So for example the <strong>stats</strong> package has</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Refer to all C/Fortran routines by their name prefixed by C_</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">useDynLib</span>(stats, <span class="at">.registration =</span> <span class="cn">TRUE</span>, <span class="at">.fixes =</span> <span class="st">"C_"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in its <code>NAMESPACE</code> file, and then <code>ansari.test</code>s default methods can contain</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>        pansari <span class="op">&lt;-</span> function<span class="op">(</span>q<span class="op">,</span> m<span class="op">,</span> n<span class="op">)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>C<span class="op">(</span>C_pansari<span class="op">,</span> as<span class="op">.</span>integer<span class="op">(</span>length<span class="op">(</span>q<span class="op">)),</span> p <span class="op">=</span> as<span class="op">.</span><span class="dt">double</span><span class="op">(</span>q<span class="op">),</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                as<span class="op">.</span>integer<span class="op">(</span>m<span class="op">),</span> as<span class="op">.</span>integer<span class="op">(</span>n<span class="op">))</span>$p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This avoids the overhead of looking up an entry point each time it is used, and ensures that the entry point in the package is the one used (without a <code>PACKAGE = "pkg"</code> argument).</p>
<p><code>R_init_</code> routines are often of the form</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> attribute_visible R_init_mypkg<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    R_registerRoutines<span class="op">(</span>dll<span class="op">,</span> CEntries<span class="op">,</span> CallEntries<span class="op">,</span> FortEntries<span class="op">,</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                       ExternalEntries<span class="op">);</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    R_useDynamicSymbols<span class="op">(</span>dll<span class="op">,</span> FALSE<span class="op">);</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    R_forceSymbols<span class="op">(</span>dll<span class="op">,</span> TRUE<span class="op">);</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span id="index-R_005fuseDynamicSymbols"></span> The <code>R_useDynamicSymbols</code> call says the DLL is not to be searched for entry points specified by character strings so <code>.C</code> etc calls will only find registered symbols: the <code>R_forceSymbols</code> call only allows <code>.C</code> etc calls which specify entry points by R objects such as <code>C_pansari</code> (and not by character strings). Each provides some protection against accidentally finding your entry points when people supply a character string without a package, and avoids slowing down such searches. (For the visibility attribute see <a href="The-R-API.html#controlling-visibility">Controlling visibility</a>.)</p>
<p>In more detail, if a package <code>mypkg</code> contains entry points <code>reg</code> and <code>unreg</code> and the first is registered as a 0-argument <code>.Call</code> routine, we could use (from code in the package)</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Call</span>(<span class="st">"reg"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.Call</span>(<span class="st">"unreg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Without or with registration, these will both work. If <code>R_init_mypkg</code> calls <code>R_useDynamicSymbols(dll, FALSE)</code>, only the first will work. If in addition to registration the <code>NAMESPACE</code> file contains</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">useDynLib</span>(mypkg, <span class="at">.registration =</span> <span class="cn">TRUE</span>, <span class="at">.fixes =</span> <span class="st">"C_"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>then we can call <code>.Call(C_reg)</code>. Finally, if <code>R_init_mypkg</code> also calls <code>R_forceSymbols(dll, TRUE)</code>, only <code>.Call(C_reg)</code> will work (and not <code>.Call("reg")</code>). This is usually what we want: it ensures that all of our own <code>.Call</code> calls go directly to the intended code in our package and that no one else accidentally finds our entry points. (Should someone need to call our code from outside the package, for example for debugging, they can use <code>.Call(mypkg:::C_reg)</code>.)</p>
<section id="speed-considerations" class="level3 subsection" data-number="5.4.1">
<h3 class="subsection anchored" data-number="5.4.1" data-anchor-id="speed-considerations"><span class="header-section-number">5.4.1</span> Speed considerations</h3>
<p>Sometimes registering native routines or using a <code>PACKAGE</code> argument can make a large difference. The results can depend quite markedly on the OS (and even if it is 32- or 64-bit), on the version of R and what else is loaded into R at the time.</p>
<p>To fix ideas, first consider <code>x86_64</code> OS 10.7 and R 2.15.2. A simple <code>.Call</code> function might be</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">.Call</span>(<span class="st">"foo"</span>, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>with C code</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>SEXP foo<span class="op">(</span>SEXP x<span class="op">)</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we compile with by <code>R CMD SHLIB foo.c</code>, load the code by <code>dyn.load("foo.so")</code> and run <code>foo(pi)</code> it took around 22 microseconds (us). Specifying the DLL by</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>foo2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">.Call</span>(<span class="st">"foo"</span>, x, <span class="at">PACKAGE =</span> <span class="st">"foo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>reduced the time to 1.7 us.</p>
<p>Now consider making these functions part of a package whose <code>NAMESPACE</code> file uses <code>useDynlib(foo)</code>. This immediately reduces the running time as <code>"foo"</code> will be preferentially looked for <code>foo.dll</code>. Without specifying <code>PACKAGE</code> it took about 5 us (it needs to fathom out the appropriate DLL each time it is invoked but it does not need to search all DLLs), and with the <code>PACKAGE</code> argument it is again about 1.7 us.</p>
<p>Next suppose the package has registered the native routine <code>foo</code>. Then <code>foo()</code> still has to find the appropriate DLL but can get to the entry point in the DLL faster, in about 4.2 us. And <code>foo2()</code> now takes about 1 us. If we register the symbols in the <code>NAMESPACE</code> file and use</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>foo3 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">.Call</span>(C_foo, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>then the address for the native routine is looked up just once when the package is loaded, and <code>foo3(pi)</code> takes about 0.8 us.</p>
<p>Versions using <code>.C()</code> rather than <code>.Call()</code> took about 0.2 us longer.</p>
<p>These are all quite small differences, but C routines are not uncommonly invoked millions of times for run times of a few microseconds each, and those doing such things may wish to be aware of the differences.</p>
<p>On Linux and Solaris there is a smaller overhead in looking up symbols.</p>
<p>Symbol lookup on Windows used to be far slower, so R maintains a small cache. If the cache is currently empty enough that the symbol can be stored in the cache then the performance is similar to Linux and Solaris: if not it may be slower. R’s own code always uses registered symbols and so these never contribute to the cache: however many other packages do rely on symbol lookup.</p>
<p>In more recent versions of R all the standard packages register native symbols and do not allow symbol search, so in a new session <code>foo()</code> can only look in <code>foo.so</code> and may be as fast as <code>foo2()</code>. This will no longer apply when many contributed packages are loaded, and generally those last loaded are searched first. For example, consider R 3.3.2 on x86_64 Linux. In an empty R session, both <code>foo()</code> and <code>foo2()</code> took about 0.75 us; however after packages <a href="https://CRAN.R-project.org/package=igraph"><strong>igraph</strong></a> and <a href="https://CRAN.R-project.org/package=spatstat"><strong>spatstat</strong></a> had been loaded (which loaded another 12 DLLs), <code>foo()</code> took 3.6 us but <code>foo2()</code> still took about 0.80 us. Using registration in a package reduced this to 0.55 us and <code>foo3()</code> took 0.40 us, times which were unchanged when further packages were loaded.</p>
</section>
<section id="example-converting-a-package-to-use-registration" class="level3 subsection page-columns page-full" data-number="5.4.2">
<h3 class="subsection anchored" data-number="5.4.2" data-anchor-id="example-converting-a-package-to-use-registration"><span class="header-section-number">5.4.2</span> Example: converting a package to use registration</h3>
<p>The <strong>splines</strong> package was converted to use symbol registration in 2001, but we can use it as an example<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> of what needs to be done for a small package.</p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;Because it is a standard package, one would need to rename it before attempting to reproduce the account here.</p></div></div><ul>
<li><p>Find the relevant entry points. This is somewhat OS-specific, but something like the following should be possible at the OS command-line</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>nm <span class="sc">-</span>g <span class="sc">/</span>path<span class="sc">/</span>to<span class="sc">/</span>splines.so <span class="sc">|</span> grep <span class="st">" T "</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="dv">0000000000002670</span> T _spline_basis</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="dv">0000000000001</span>ec0 T _spline_value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This indicates that there are two relevant entry points. (They may or may not have a leading underscore, as here. Fortran entry points will have a trailing underscore.) Check in the R code that they are called by the package and how: in this case they are used by <code>.Call</code>.</p>
<p>Alternatively, examine the package’s R code for all <code>.C</code>, <code>.Fortran</code>, <code>.Call</code> and <code>.External</code> calls.</p></li>
<li><p>Construct the registration table. First write skeleton registration code, conventionally in file <code>src/init.c</code> (or at the end of the only C source file in the package: if included in a C++ file the <code>R_init</code> function would need to be declared <code>extern "C"</code>):</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span><span class="pp"> </span><span class="co">// for NULL</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Rdynload.h&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CALLDEF</span><span class="op">(</span><span class="pp">name</span><span class="op">,</span><span class="pp"> n</span><span class="op">)</span><span class="pp">  </span><span class="op">{#</span><span class="pp">name</span><span class="op">,</span><span class="pp"> </span><span class="op">(</span><span class="pp">DL_FUNC</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp">name</span><span class="op">,</span><span class="pp"> n</span><span class="op">}</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> R_CallMethodDef R_CallDef<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>   CALLDEF<span class="op">(</span>spline_basis<span class="op">,</span> <span class="op">?),</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>   CALLDEF<span class="op">(</span>spline_value<span class="op">,</span> <span class="op">?),</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span>NULL<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">}</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_init_splines<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    R_registerRoutines<span class="op">(</span>dll<span class="op">,</span> NULL<span class="op">,</span> R_CallDef<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and then replace the <code>?</code> in the skeleton with the actual numbers of arguments. You will need to add declarations (also known as ‘prototypes’) of the functions unless appending to the only C source file. Some packages will already have these in a header file, or you could create one and include it in <code>init.c</code>, for example <code>splines.h</code> containing</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span><span class="pp"> </span><span class="co">// for SEXP</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> SEXP spline_basis<span class="op">(</span>SEXP knots<span class="op">,</span> SEXP order<span class="op">,</span> SEXP xvals<span class="op">,</span> SEXP derivs<span class="op">);</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> SEXP spline_value<span class="op">(</span>SEXP knots<span class="op">,</span> SEXP coeff<span class="op">,</span> SEXP order<span class="op">,</span> SEXP x<span class="op">,</span> SEXP deriv<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Tools are available to extract declarations, at least for C and C++ code: see the help file for <code>package_native_routine_registration_skeleton</code> in package <strong>tools</strong>. Here we could have used</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>cproto <span class="sc">-</span>I<span class="sc">/</span>path<span class="sc">/</span>to<span class="sc">/</span>R<span class="sc">/</span>include <span class="sc">-</span>e splines.c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For examples of registering other types of calls, see packages <strong>graphics</strong> and <strong>stats</strong>. In particular, when registering entry points for <code>.Fortran</code> one needs declarations as if called from C, such as</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/RS.h&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> F77_NAME<span class="op">(</span>supsmu<span class="op">)(</span><span class="dt">int</span> <span class="op">*</span>n<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>y<span class="op">,</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">double</span> <span class="op">*</span>w<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>iper<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>span<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>alpha<span class="op">,</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">double</span> <span class="op">*</span>smo<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>sc<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>edf<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>gfortran</code> 8.4, 9.2 and later can help generate such prototypes with its flag <code>-fc-prototypes-external</code> (although one will need to replace the hard-coded trailing underscore with the <code>F77_NAME</code> macro).</p>
<p>One can get away with inaccurate argument lists in the declarations: it is easy to specify the arguments for <code>.Call</code> (all <code>SEXP</code>) and <code>.External</code> (one <code>SEXP</code>) and as the arguments for <code>.C</code> and <code>.Fortran</code> are all pointers, specifying them as <code>void *</code> suffices. (For most platforms one can omit all the arguments, although link-time optimization will warn, as will compilers set up to warn on strict prototypes – and C23 will require correct arguments.)</p>
<p>Using <code>-fc-prototypes-external</code> will give a prototype using <code>int_least32_t *lgl</code> for Fortran <code>LOGICAL LGL</code>, but this is not portable and traditionally it has been assumed that the C/C++ equivalent was <code>int *lgl</code>. If adding a declaration just to register a <code>.Fortran</code> call, the most portable version is <code>void *lgl</code>.</p></li>
<li><p>(Optional but highly recommended.) Restrict <code>.Call</code> etc to use the symbols you chose to register by editing <code>src/init.c</code> to contain</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_init_splines<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    R_registerRoutines<span class="op">(</span>dll<span class="op">,</span> NULL<span class="op">,</span> R_CallDef<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    R_useDynamicSymbols<span class="op">(</span>dll<span class="op">,</span> FALSE<span class="op">);</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<p>A skeleton for the steps so far can be made using <code>package_native_routine_registration_skeleton</code> in package <strong>tools</strong>. This will optionally create declarations based on the usage in the R code.</p>
<p>The remaining steps are optional but recommended.</p>
<ul>
<li><p>Edit the <code>NAMESPACE</code> file to create R objects for the registered symbols: <code>r     useDynLib(splines, .registration = TRUE, .fixes = "C_")</code></p></li>
<li><p>Find all the relevant calls in the R code and edit them to use the R objects. This entailed changing the lines</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">"spline_basis"</span>, knots, ord, x, derivs, <span class="at">PACKAGE =</span> <span class="st">"splines"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>y[accept] <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">"spline_value"</span>, knots, coeff, ord, x[accept], deriv, <span class="at">PACKAGE =</span> <span class="st">"splines"</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">.Call</span>(<span class="st">"spline_value"</span>, knots, <span class="fu">coef</span>(object), ord, x, deriv, <span class="at">PACKAGE =</span> <span class="st">"splines"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">.Call</span>(C_spline_basis, knots, ord, x, derivs)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>y[accept] <span class="ot">&lt;-</span> <span class="fu">.Call</span>(C_spline_value, knots, coeff, ord, x[accept], deriv)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">.Call</span>(C_spline_value, knots, <span class="fu">coef</span>(object), ord, x, deriv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Check that there is no <code>exportPattern</code> directive which unintentionally exports the newly created R objects.</p></li>
<li><p>Restrict <code>.Call</code> to use the R symbols by editing <code>src/init.c</code> to contain</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_init_splines<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    R_registerRoutines<span class="op">(</span>dll<span class="op">,</span> NULL<span class="op">,</span> R_CallDef<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    R_useDynamicSymbols<span class="op">(</span>dll<span class="op">,</span> FALSE<span class="op">);</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    R_forceSymbols<span class="op">(</span>dll<span class="op">,</span> TRUE<span class="op">);</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Consider visibility. On some OSes we can hide entry points from the loader, which precludes any possible name clashes and calling them accidentally (usually with incorrect arguments and crashing the R process). If we repeat the first step we now see</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>nm <span class="sc">-</span>g <span class="sc">/</span>path<span class="sc">/</span>to<span class="sc">/</span>splines.so <span class="sc">|</span> grep <span class="st">" T "</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fl">0000000000002e00</span> T _R_init_splines</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fl">00000000000025e0</span> T _spline_basis</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fl">0000000000001e20</span> T _spline_value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If there were any entry points not intended to be used by the package we should try to avoid exporting them, for example by making them <code>static</code>. Now that the two relevant entry points are only accessed <em>via</em> the registration table, we can hide them. There are two ways to do so on some Unix-alikes. We can hide individual entry points <em>via</em></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Visibility.h&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>SEXP attribute_hidden</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>spline_basis<span class="op">(</span>SEXP knots<span class="op">,</span> SEXP order<span class="op">,</span> SEXP xvals<span class="op">,</span> SEXP derivs<span class="op">)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>SEXP attribute_hidden</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>spline_value<span class="op">(</span>SEXP knots<span class="op">,</span> SEXP coeff<span class="op">,</span> SEXP order<span class="op">,</span> SEXP x<span class="op">,</span> SEXP deriv<span class="op">)</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Alternatively, we can change the default visibility for all C symbols by including</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>PKG_CFLAGS <span class="op">=</span> $<span class="op">(</span>C_VISIBILITY<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in <code>src/Makevars</code>, and then we need to allow registration by declaring <code>R_init_splines</code> to be visible:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Visibility.h&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> attribute_visible</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>R_init_splines<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>See <a href="The-R-API.html#controlling-visibility">Controlling visibility</a> for more details, including using Fortran code and ways to restrict visibility on Windows.</p></li>
<li><p>We end up with a file <code>src/init.c</code> containing</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb34"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Rdynload.h&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Visibility.h&gt;</span><span class="pp">  </span><span class="co">// optional</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"splines.h"</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CALLDEF</span><span class="op">(</span><span class="pp">name</span><span class="op">,</span><span class="pp"> n</span><span class="op">)</span><span class="pp">  </span><span class="op">{#</span><span class="pp">name</span><span class="op">,</span><span class="pp"> </span><span class="op">(</span><span class="pp">DL_FUNC</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp">name</span><span class="op">,</span><span class="pp"> n</span><span class="op">}</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> R_CallMethodDef R_CallDef<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    CALLDEF<span class="op">(</span>spline_basis<span class="op">,</span> <span class="dv">4</span><span class="op">),</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    CALLDEF<span class="op">(</span>spline_value<span class="op">,</span> <span class="dv">5</span><span class="op">),</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>NULL<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">}</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>attribute_visible  <span class="co">// optional</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>R_init_splines<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    R_registerRoutines<span class="op">(</span>dll<span class="op">,</span> NULL<span class="op">,</span> R_CallDef<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    R_useDynamicSymbols<span class="op">(</span>dll<span class="op">,</span> FALSE<span class="op">);</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    R_forceSymbols<span class="op">(</span>dll<span class="op">,</span> TRUE<span class="op">);</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote></li>
</ul>
</section>
<section id="linking-to-native-routines-in-other-packages" class="level3 subsection page-columns page-full" data-number="5.4.3">
<h3 class="subsection anchored" data-number="5.4.3" data-anchor-id="linking-to-native-routines-in-other-packages"><span class="header-section-number">5.4.3</span> Linking to native routines in other packages</h3>
<p>In addition to registering C routines to be called by R, it can at times be useful for one package to make some of its C routines available to be called by C code in another package. The interface consists of two routines declared in header <code>R_ext/Rdynload.h</code> as</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_RegisterCCallable<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>package<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">,</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                         DL_FUNC fptr<span class="op">);</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>DL_FUNC R_GetCCallable<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>package<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A package <strong>packA</strong> that wants to make a C routine <code>myCfun</code> available to C code in other packages would include the call</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">R_RegisterCCallable</span>(<span class="st">"packA"</span>, <span class="st">"myCfun"</span>, myCfun);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in its initialization function <code>R_init_packA</code>. A package <strong>packB</strong> that wants to use this routine would retrieve the function pointer with a call of the form</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>p_myCfun <span class="ot">=</span> <span class="fu">R_GetCCallable</span>(<span class="st">"packA"</span>, <span class="st">"myCfun"</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As the type <code>DL_FUNC</code> is only appropriate for functions with no arguments, other users will need to cast to an appropriate type. For example</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> SEXP <span class="op">(*</span>na_omit_xts_func<span class="op">)</span> <span class="op">(</span>SEXP x<span class="op">);</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  na_omit_xts_func fun <span class="op">=</span> <span class="op">(</span>na_omit_xts_func<span class="op">)</span> R_GetCCallable<span class="op">(</span><span class="st">"xts"</span><span class="op">,</span> <span class="st">"na_omit_xts"</span><span class="op">);</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> fun<span class="op">(</span>x<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The author of <strong>packB</strong> is responsible for ensuring that <code>p_myCfun</code> has an appropriate declaration. In the future R may provide some automated tools to simplify exporting larger numbers of routines.</p>
<p>A package that wishes to make use of header files in other packages needs to declare them as a comma-separated list in the field <code>LinkingTo</code> in the <code>DESCRIPTION</code> file. This then arranges for the <code>include</code> directories in the installed linked-to packages to be added to the include paths for C and C++ code.</p>
<p>It must specify<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> <code>Imports</code> or <code>Depends</code> of those packages, for they have to be loaded<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> prior to this one (so the path to their compiled code has been registered).</p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;whether or not <code>LinkingTo</code> is used.</p></div><div id="fn9"><p><sup>9</sup>&nbsp;so there needs to be a corresponding <code>import</code> or <code>importFrom</code> entry in the <code>NAMESPACE</code> file.</p></div></div><p>CRAN examples of the use of this mechanism include <a href="https://CRAN.R-project.org/package=coxme"><strong>coxme</strong></a> linking to <a href="https://CRAN.R-project.org/package=bdsmatrix"><strong>bdsmatrix</strong></a> and <a href="https://CRAN.R-project.org/package=xts"><strong>xts</strong></a> linking to <a href="https://CRAN.R-project.org/package=zoo"><strong>zoo</strong></a>.</p>
<p><strong>NB</strong>: this mechanism is fragile, as changes to the interface provided by <strong>packA</strong> have to be recognised by <strong>packB</strong>. The consequences of not doing so have included serious corruption to the memory pool of the R session. Either <strong>packB</strong> has to depend on the exact version of <strong>packA</strong> or there needs to be a mechanism for <strong>packB</strong> to test at runtime the version of <strong>packA</strong> it is linked to matches that it was compiled against.</p>
<p>On rare occasions in can be useful for C code in one package to dynamically look up the address in another package. This can be done using <code>R_FindSymbol</code>:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>DL_FUNC <span class="fu">R_FindSymbol</span>(char const <span class="sc">*</span>name, char const <span class="sc">*</span>pkg,</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>             R_RegisteredNativeSymbol <span class="sc">*</span>symbol);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="creating-shared-objects" class="level2 section" data-number="5.5">
<h2 class="section anchored" data-number="5.5" data-anchor-id="creating-shared-objects"><span class="header-section-number">5.5</span> Creating shared objects</h2>
<p>Shared objects for loading into R can be created using <code>R CMD SHLIB</code>. This accepts as arguments a list of files which must be object files (with extension <code>.o</code>) or sources for C, C++, Fortran, Objective C or Objective C++ (with extensions <code>.c</code>, <code>.cc</code> or <code>.cpp</code>, <code>.f</code> (fixed-form Fortran), <code>.f90</code> or <code>.f95</code> (free-form), <code>.m</code>, and <code>.mm</code> or <code>.M</code>, respectively), or commands to be passed to the linker. See <kbd>R CMD SHLIB --help</kbd> (or the R help for <code>SHLIB</code>) for usage information. Note that files intended for the Fortran pre-processor with extension <code>.F</code> are not accepted.</p>
<p>If compiling the source files does not work “out of the box”, you can specify additional flags by setting some of the variables <code>PKG_CPPFLAGS</code> (for the C/C++ preprocessor, mainly <code>-I</code>, <code>-D</code> and <code>-U</code> flags), <code>PKG_CFLAGS</code>, <code>PKG_CXXFLAGS</code>, <code>PKG_FFLAGS</code>, <code>PKG_OBJCFLAGS</code>, and <code>PKG_OBJCXXFLAGS</code> (for the C, C++, Fortran, Objective C, and Objective C++ compilers, respectively) in the file <code>Makevars</code> in the compilation directory (or, of course, create the object files directly from the command line). Similarly, variable <code>PKG_LIBS</code> in <code>Makevars</code> can be used for additional <code>-l</code> and <code>-L</code> flags to be passed to the linker when building the shared object. (Supplying linker commands as arguments to <code>R CMD SHLIB</code> will take precedence over <code>PKG_LIBS</code> in <code>Makevars</code>.)</p>
<p>It is possible to arrange to include compiled code from other languages by setting the macro <code>OBJECTS</code> in file <code>Makevars</code>, together with suitable rules to make the objects.</p>
<p>Flags that are already set (for example in file <code>etcR_ARCH/Makeconf</code>) can be overridden by the environment variable <code>MAKEFLAGS</code> (at least for systems using a POSIX-compliant <code>make</code>), as in (Bourne shell syntax)</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="va">MAKEFLAGS</span><span class="op">=</span><span class="st">"CFLAGS=-O3"</span> <span class="ex">R</span> CMD SHLIB <span class="pp">*</span>.c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It is also possible to set such variables in personal <code>Makevars</code> files, which are read after the local <code>Makevars</code> and the system makefiles or in a site-wide <code>Makevars.site</code> file. See <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Customizing-package-compilation" data-manual="R-admin">Customizing package compilation</a> in R Installation and Administration for more information.</p>
<p>Note that as <code>R CMD SHLIB</code> uses Make, it will not remake a shared object just because the flags have changed, and if <code>test.c</code> and <code>test.f</code> both exist in the current directory</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD SHLIB test.f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>will compile <code>test.c</code>!</p>
<p>If the <code>src</code> subdirectory of an add-on package contains source code with one of the extensions listed above or a file <code>Makevars</code> but <strong>not</strong> a file <code>Makefile</code>, <code>R CMD INSTALL</code> creates a shared object (for loading into R through <code>useDynlib</code> in the <code>NAMESPACE</code>, or in the <code>.onLoad</code> function of the package) using the <code>R CMD SHLIB</code> mechanism. If file <code>Makevars</code> exists it is read first, then the system makefile and then any personal <code>Makevars</code> files.</p>
<p>If the <code>src</code> subdirectory of package contains a file <code>Makefile</code>, this is used by <code>R CMD INSTALL</code> in place of the <code>R CMD SHLIB</code> mechanism. <code>make</code> is called with makefiles <code>R_HOME/etcR_ARCH/Makeconf</code>, <code>src/Makefile</code> and any personal <code>Makevars</code> files (in that order). The first target found in <code>src/Makefile</code> is used.</p>
<p>It is better to make use of a <code>Makevars</code> file rather than a <code>Makefile</code>: the latter should be needed only exceptionally.</p>
<p>Under Windows the same commands work, but <code>Makevars.win</code> will be used in preference to <code>Makevars</code>, and only <code>src/Makefile.win</code> will be used by <code>R CMD INSTALL</code> with <code>src/Makefile</code> being ignored. Since R 4.2.0, <code>Makevars.ucrt</code> will be used in preference to <code>Makevars.win</code> and <code>src/Makefile.ucrt</code> will be used in preference to <code>src/Makefile.win</code>. For past experiences of building DLLs with a variety of compilers, see file <code>README.packages</code>. Under Windows you can supply an exports definitions file called <code>dllname-win.def</code>: otherwise all entry points in objects (but not libraries) supplied to <code>R CMD SHLIB</code> will be exported from the DLL. An example is <code>stats-win.def</code> for the <strong>stats</strong> package: a CRAN example in package <a href="https://CRAN.R-project.org/package=fastICA"><strong>fastICA</strong></a>.</p>
<p>If you feel tempted to read the source code and subvert these mechanisms, please resist. Far too much developer time has been wasted in chasing down errors caused by failures to follow this documentation, and even more by package authors demanding explanations as to why their packages no longer work. In particular, undocumented environment or <code>make</code> variables are not for use by package writers and are subject to change without notice.</p>
</section>
<section id="interfacing-c-code" class="level2 section page-columns page-full" data-number="5.6">
<h2 class="section anchored" data-number="5.6" data-anchor-id="interfacing-c-code"><span class="header-section-number">5.6</span> Interfacing C++ code</h2>
<p>Suppose we have the following hypothetical C++ library, consisting of the two files <code>X.h</code> and <code>X.cpp</code>, and implementing the two classes <code>X</code> and <code>Y</code> which we want to use in R.</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="sc">/</span><span class="er">/</span> X.h</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>class X {</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>public<span class="sc">:</span> <span class="fu">X</span> (); <span class="sc">~</span><span class="fu">X</span> ();</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>};</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>class Y {</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>public<span class="sc">:</span> <span class="fu">Y</span> (); <span class="sc">~</span><span class="fu">Y</span> ();</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>};</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb43"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// X.cpp</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"X.h"</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Y y<span class="op">;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>X<span class="op">::</span>X<span class="op">()</span>  <span class="op">{</span> REprintf<span class="op">(</span><span class="st">"constructor X</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span> <span class="op">}</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>X<span class="op">::~</span>X<span class="op">()</span> <span class="op">{</span> REprintf<span class="op">(</span><span class="st">"destructor X</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span>  <span class="op">}</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>Y<span class="op">::</span>Y<span class="op">()</span>  <span class="op">{</span> REprintf<span class="op">(</span><span class="st">"constructor Y</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span> <span class="op">}</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>Y<span class="op">::~</span>Y<span class="op">()</span> <span class="op">{</span> REprintf<span class="op">(</span><span class="st">"destructor Y</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>To use with R, the only thing we have to do is writing a wrapper function and ensuring that the function is enclosed in</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>extern <span class="st">"C"</span> {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For example,</p>
<blockquote class="blockquote">
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><div class="sourceCode" id="cb45"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">// X_main.cpp:</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"X.h"</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="st">"C"</span> <span class="op">{</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> X_main <span class="op">()</span> <span class="op">{</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  X x<span class="op">;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// extern "C"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</blockquote>
<p>Compiling and linking should be done with the C++ compiler-linker (rather than the C compiler-linker or the linker itself); otherwise, the C++ initialization code (and hence the constructor of the static variable <code>Y</code>) are not called. On a properly configured system, one can simply use</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD SHLIB X.cpp X_main.cpp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to create the shared object, typically <code>X.so</code> (the file name extension may be different on your platform). Now starting R yields</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>R version <span class="dv">2</span>.<span class="fl">14.1</span> <span class="fu">Patched</span> (<span class="dv">2012-01-16</span> r58124)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Copyright</span> (C) <span class="dv">2012</span> The R Foundation <span class="cf">for</span> Statistical Computing</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>Type    <span class="st">"q()"</span> to quit R.</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>R<span class="sc">&gt;</span> <span class="fu">dyn.load</span>(<span class="fu">paste</span>(<span class="st">"X"</span>, .Platform<span class="sc">$</span>dynlib.ext, <span class="at">sep =</span> <span class="st">""</span>))</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>constructor Y</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>R<span class="sc">&gt;</span> <span class="fu">.C</span>(<span class="st">"X_main"</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>constructor X</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>destructor X</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>()</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>R<span class="sc">&gt;</span> <span class="fu">q</span>()</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>Save workspace image? [y<span class="sc">/</span>n<span class="sc">/</span>c]<span class="sc">:</span> y</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>destructor Y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The R for Windows FAQ (<code>rw-FAQ</code>) contains details of how to compile this example under Windows.</p>
<p>Earlier versions of this example used C++ iostreams: this is best avoided. There is no guarantee that the output will appear in the R console, and indeed it will not on the R for Windows console. Use R code or the C entry points (see <a href="The-R-API.html#printing">Printing</a>) for all I/O if at all possible. Examples have been seen where merely loading a DLL that contained calls to C++ I/O upset R’s own C I/O (for example by resetting buffers on open files).</p>
<p>Most R header files can be included within C++ programs but they should <strong>not</strong> be included within an <code>extern "C"</code> block (as they include system headers<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>).</p>
<div class="no-row-height column-margin column-container"><div id="fn10"><p><sup>10</sup>&nbsp;Even including C system headers in such a block has caused compilation errors.</p></div></div><section id="external-c-code" class="level3 subsection page-columns page-full" data-number="5.6.1">
<h3 class="subsection anchored" data-number="5.6.1" data-anchor-id="external-c-code"><span class="header-section-number">5.6.1</span> External C++ code</h3>
<p>Quite a lot of external C++ software is header-only (e.g.&nbsp;most of the Boost ‘libraries’ including all those supplied by package <a href="https://CRAN.R-project.org/package=BH"><strong>BH</strong></a>, and most of Armadillo as supplied by package <a href="https://CRAN.R-project.org/package=RcppArmadillo"><strong>RcppArmadillo</strong></a>) and so is compiled when an R package which uses it is installed. This causes few problems.</p>
<p>A small number of external libraries used in R packages have a C++ interface to a library of compiled code, e.g.&nbsp;packages <a href="https://CRAN.R-project.org/package=sf"><strong>sf</strong></a> and <a href="https://CRAN.R-project.org/package=rjags"><strong>rjags</strong></a>. This raises many more problems! The C++ interface uses name-mangling and the ABI<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> may depend on the compiler, version and even C++ defines<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>, so requires the package C++ code to be compiled in exactly the same way as the library (and what that was is often undocumented).</p>
<div class="no-row-height column-margin column-container"><div id="fn11"><p><sup>11</sup>&nbsp;<a href="https://en.wikipedia.org/wiki/Application_binary_interface" class="uri">https://en.wikipedia.org/wiki/Application_binary_interface</a>.</p></div><div id="fn12"><p><sup>12</sup>&nbsp;For example, <code>_GLIBCXX_USE_CXX11_ABI</code> in <code>g++</code> 5.1 and later: <a href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_dual_abi.html" class="uri">https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_dual_abi.html</a>.</p></div></div><p>Even fewer external libraries use C++ internally but present a C interface, such as <a href="https://CRAN.R-project.org/package=rgeos"><strong>rgeos</strong></a>. These require the C++ runtime library to be linked into the package’s shared object/DLL, and this is best done by including a dummy C++ file in the package sources.</p>
<p>There is a trend to link to the C++ interfaces offered by C software such as <strong>hdf5</strong>, <strong>pcre</strong> and <strong>ImageMagick</strong>. Their C interfaces are much preferred for portability (and can be used from C++ code). Also, the C++ interfaces are often optional in the software build or packaged separately and so users installing from package sources are less likely to already have them installed.</p>
</section>
</section>
<section id="fortran-io" class="level2 section" data-number="5.7">
<h2 class="section anchored" data-number="5.7" data-anchor-id="fortran-io"><span class="header-section-number">5.7</span> Fortran I/O</h2>
<p>We have already warned against the use of C++ iostreams not least because output is not guaranteed to appear on the R console, and this warning applies equally to Fortran output to units <code>*</code> and <code>6</code>. See <a href="The-R-API.html#printing-from-fortran">Printing from Fortran</a>, which describes workarounds.</p>
<p>In the past most Fortran compilers implemented I/O on top of the C I/O system and so the two interworked successfully. This was true of <code>g77</code>, but it is less true of <code>gfortran</code> as used in <code>gcc</code> 4 and later. In particular, any package that makes use of Fortran I/O will when compiled on Windows interfere with C I/O: when the Fortran I/O support code is initialized (typically when the package is loaded) the C <code>stdout</code> and <code>stderr</code> are switched to LF line endings. (Function <code>init</code> in file <code>src/modules/lapack/init_win.c</code> shows how to mitigate this. In a package this would look something like</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef _WIN32</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="pp"># include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_init_mypkgname<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Native symbol registration calls</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef _WIN32</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// gfortran I/O initialization sets these to _O_BINARY</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    setmode<span class="op">(</span><span class="dv">1</span><span class="op">,</span> _O_TEXT<span class="op">);</span> <span class="co">/* stdout */</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    setmode<span class="op">(</span><span class="dv">2</span><span class="op">,</span> _O_TEXT<span class="op">);</span> <span class="co">/* stderr */</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>in the file used for native symbol registration.)</p>
</section>
<section id="linking-to-other-packages" class="level2 section page-columns page-full" data-number="5.8">
<h2 class="section anchored" data-number="5.8" data-anchor-id="linking-to-other-packages"><span class="header-section-number">5.8</span> Linking to other packages</h2>
<p>It is not in general possible to link a DLL in package <strong>packA</strong> to a DLL provided by package <strong>packB</strong> (for the security reasons mentioned in <a href="#dyn.load-and-dyn.unload"><code>dyn.load</code> and <code>dyn.unload</code></a>, and also because some platforms distinguish between shared objects and dynamic libraries), but it is on Windows.</p>
<p>Note that there can be tricky versioning issues here, as package <strong>packB</strong> could be re-installed after package <strong>packA</strong> — it is desirable that the API provided by package <strong>packB</strong> remains backwards-compatible.</p>
<p>Shipping a static library in package <strong>packB</strong> for other packages to link to avoids most of the difficulties.</p>
<section id="unix-alikes" class="level3 subsection page-columns page-full" data-number="5.8.1">
<h3 class="subsection anchored" data-number="5.8.1" data-anchor-id="unix-alikes"><span class="header-section-number">5.8.1</span> Unix-alikes</h3>
<p>It is possible to link a shared object in package <strong>packA</strong> to a library provided by package <strong>packB</strong> under limited circumstances on a Unix-alike OS. There are severe portability issues, so this is not recommended for a distributed package.</p>
<p>This is easiest if <strong>packB</strong> provides a static library <code>packB/lib/libpackB.a</code>. (Note using directory <code>lib</code> rather than <code>libs</code> is conventional, and architecture-specific sub-directories may be needed and are assumed in the sample code below. The code in the static library will need to be compiled with <code>PIC</code> flags on platforms where it matters.) Then as the code from package <strong>packB</strong> is incorporated when package <strong>packA</strong> is installed, we only need to find the static library at install time for package <strong>packA</strong>. The only issue is to find package <strong>packB</strong>, and for that we can ask R by something like (long lines broken for display here)</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>PKGB_PATH<span class="op">=</span>`echo <span class="ch">'l</span><span class="er">ibrary(packB);</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  cat<span class="op">(</span>system<span class="op">.</span>file<span class="op">(</span><span class="st">"lib"</span><span class="op">,</span>  package<span class="op">=</span><span class="st">"packB"</span><span class="op">,</span> mustWork<span class="op">=</span>TRUE<span class="op">))</span><span class="ch">' </span><span class="er">\</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a> <span class="op">|</span> <span class="st">"${R_HOME}/bin/R"</span> <span class="op">--</span>vanilla <span class="op">--</span>no<span class="op">-</span>echo`</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>PKG_LIBS<span class="op">=</span><span class="st">"$(PKGB_PATH)$(R_ARCH)/libpackB.a"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For a dynamic library <code>packB/lib/libpackB.so</code> (<code>packB/lib/libpackB.dylib</code> on macOS: note that you cannot link to a shared object, <code>.so</code>, on that platform) we could use</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>PKGB_PATH<span class="op">=</span>`echo <span class="ch">'l</span><span class="er">ibrary(packB);</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  cat<span class="op">(</span>system<span class="op">.</span>file<span class="op">(</span><span class="st">"lib"</span><span class="op">,</span> package<span class="op">=</span><span class="st">"packB"</span><span class="op">,</span> mustWork<span class="op">=</span>TRUE<span class="op">))</span><span class="ch">' </span><span class="er">\</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a> <span class="op">|</span> <span class="st">"${R_HOME}/bin/R"</span> <span class="op">--</span>vanilla <span class="op">--</span>no<span class="op">-</span>echo`</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>PKG_LIBS<span class="op">=-</span><span class="st">L"$(PKGB_PATH)$(R_ARCH)"</span> <span class="op">-</span>lpackB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will work for installation, but very likely not when package <code>packB</code> is loaded, as the path to package <strong>packB</strong>’s <code>lib</code> directory is not in the <code>ld.so</code><a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> search path. You can arrange to put it there <strong>before</strong> R is launched by setting (on some platforms) <code>LD_RUN_PATH</code> or <code>LD_LIBRARY_PATH</code> or adding to the <code>ld.so</code> cache (see <code>man ldconfig</code>). On platforms that support it, the path to the directory containing the dynamic library can be hardcoded at install time (which assumes that the location of package <strong>packB</strong> will not be changed nor the package updated to a changed API). On systems with the <code>gcc</code> or <code>clang</code> and the GNU linker (e.g.&nbsp;Linux) and some others this can be done by e.g.</p>
<div class="no-row-height column-margin column-container"><div id="fn13"><p><sup>13</sup>&nbsp;<code>dyld</code> on macOS, and <code>DYLD_LIBRARY_PATHS</code> below.</p></div></div><div class="sourceCode" id="cb51"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>PKGB_PATH<span class="op">=</span>`echo <span class="ch">'l</span><span class="er">ibrary(packB);</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  cat<span class="op">(</span>system<span class="op">.</span>file<span class="op">(</span><span class="st">"lib"</span><span class="op">,</span> package<span class="op">=</span><span class="st">"packB"</span><span class="op">,</span> mustWork<span class="op">=</span>TRUE<span class="op">)))</span><span class="ch">' </span><span class="er">\</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a> <span class="op">|</span> <span class="st">"${R_HOME}/bin/R"</span> <span class="op">--</span>vanilla <span class="op">--</span>no<span class="op">-</span>echo`</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>PKG_LIBS<span class="op">=-</span><span class="st">L"$(PKGB_PATH)$(R_ARCH)"</span> <span class="op">-</span>Wl<span class="op">,-</span>rpath<span class="op">,</span><span class="st">"$(PKGB_PATH)$(R_ARCH)"</span> <span class="op">-</span>lpackB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Some other systems (e.g.&nbsp;Solaris with its native linker) use <code>-Rdir</code> rather than <code>-rpath,dir</code> (and this is accepted by the compiler as well as the linker).</p>
<p>It may be possible to figure out what is required semi-automatically from the result of <code>R CMD libtool --config</code> (look for <code>hardcode</code>).</p>
<p>Making headers provided by package <strong>packB</strong> available to the code to be compiled in package <strong>packA</strong> can be done by the <code>LinkingTo</code> mechanism (see <a href="#registering-native-routines">Registering native routines</a>).</p>
</section>
<section id="windows" class="level3 subsection" data-number="5.8.2">
<h3 class="subsection anchored" data-number="5.8.2" data-anchor-id="windows"><span class="header-section-number">5.8.2</span> Windows</h3>
<p>Suppose package <strong>packA</strong> wants to make use of compiled code provided by <strong>packB</strong> in DLL <code>packB/libs/exB.dll</code>, possibly the package’s DLL <code>packB/libs/packB.dll</code>. (This can be extended to linking to more than one package in a similar way.) There are three issues to be addressed:</p>
<ul>
<li><p>Making headers provided by package <strong>packB</strong> available to the code to be compiled in package <strong>packA</strong>.</p>
<p>This is done by the <code>LinkingTo</code> mechanism (see <a href="#registering-native-routines">Registering native routines</a>).</p></li>
<li><p>preparing <code>packA.dll</code> to link to <code>packB/libs/exB.dll</code>.</p>
<p>This needs an entry in <code>Makevars.win</code> or <code>Makevars.ucrt</code> of the form</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>PKG_LIBS<span class="op">=</span> <span class="op">-</span>L<span class="op">&lt;</span>something<span class="op">&gt;</span> <span class="op">-</span>lexB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and one possibility is that <code>&lt;something&gt;</code> is the path to the installed <code>pkgB/libs</code> directory. To find that we need to ask R where it is by something like</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>PKGB_PATH<span class="op">=</span>`echo <span class="ch">'l</span><span class="er">ibrary(packB);</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  cat<span class="op">(</span>system<span class="op">.</span>file<span class="op">(</span><span class="st">"libs"</span><span class="op">,</span> package<span class="op">=</span><span class="st">"packB"</span><span class="op">,</span> mustWork<span class="op">=</span>TRUE<span class="op">))</span><span class="ch">' </span><span class="er">\</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a> <span class="op">|</span> rterm <span class="op">--</span>vanilla <span class="op">--</span>no<span class="op">-</span>echo`</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>PKG_LIBS<span class="op">=</span> <span class="op">-</span><span class="st">L"$(PKGB_PATH)$(R_ARCH)"</span> <span class="op">-</span>lexB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Another possibility is to use an import library, shipping with package <strong>packA</strong> an exports file <code>exB.def</code>. Then <code>Makevars.win</code> (or <code>Makevars.ucrt</code>) could contain</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>PKG_LIBS<span class="op">=</span> <span class="op">-</span>L<span class="op">.</span> <span class="op">-</span>lexB</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>all<span class="op">:</span> $<span class="op">(</span>SHLIB<span class="op">)</span> before</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>before<span class="op">:</span> libexB<span class="op">.</span>dll<span class="op">.</span>a</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>libexB<span class="op">.</span>dll<span class="op">.</span>a<span class="op">:</span> exB<span class="op">.</span>def</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and then installing package <strong>packA</strong> will make and use the import library for <code>exB.dll</code>. (One way to prepare the exports file is to use <code>pexports.exe</code>.)</p></li>
<li><p>loading <code>packA.dll</code> which depends on <code>exB.dll</code>.</p>
<p>If <code>exB.dll</code> was used by package <strong>packB</strong> (because it is in fact <code>packB.dll</code> or <code>packB.dll</code> depends on it) and <strong>packB</strong> has been loaded before <strong>packA</strong>, then nothing more needs to be done as <code>exB.dll</code> will already be loaded into the R executable. (This is the most common scenario.)</p>
<p>More generally, we can use the <code>DLLpath</code> argument to <code>library.dynam</code> to ensure that <code>exB.dll</code> is found, for example by setting</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library.dynam</span>(<span class="st">"packA"</span>, pkg, lib,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">DLLpath =</span> <span class="fu">system.file</span>(<span class="st">"libs"</span>, <span class="at">package=</span><span class="st">"packB"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that <code>DLLpath</code> can only set one path, and so for linking to two or more packages you would need to resort to setting environment variable <code>PATH</code>.</p></li>
</ul>
</section>
</section>
<section id="handling-r-objects-in-c" class="level2 section page-columns page-full" data-number="5.9">
<h2 class="section anchored" data-number="5.9" data-anchor-id="handling-r-objects-in-c"><span class="header-section-number">5.9</span> Handling R objects in C</h2>
<p>Using C code to speed up the execution of an R function is often very fruitful. Traditionally this has been done <em>via</em> the <code>.C</code> function in R. However, if a user wants to write C code using internal R data structures, then that can be done using the <code>.Call</code> and <code>.External</code> functions. The syntax for the calling function in R in each case is similar to that of <code>.C</code>, but the two functions have different C interfaces. Generally the <code>.Call</code> interface is simpler to use, but <code>.External</code> is a little more general.</p>
<p>A call to <code>.Call</code> is very similar to <code>.C</code>, for example</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Call</span>(<span class="st">"convolve2"</span>, a, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The first argument should be a character string giving a C symbol name of code that has already been loaded into R. Up to 65 R objects can passed as arguments. The C side of the interface is</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>SEXP convolve2<span class="op">(</span>SEXP a<span class="op">,</span> SEXP b<span class="op">)</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a> <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A call to <code>.External</code> is almost identical</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.External</span>(<span class="st">"convolveE"</span>, a, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>but the C side of the interface is different, having only one argument</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>SEXP convolveE<span class="op">(</span>SEXP args<span class="op">)</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a> <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here <code>args</code> is a <code>LISTSXP</code>, a Lisp-style pairlist from which the arguments can be extracted.</p>
<p>In each case the R objects are available for manipulation <em>via</em> a set of functions and macros defined in the header file <code>Rinternals.h</code> or some S-compatibility macros<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> See <a href="#interface-functions-.call-and-.external">Interface functions <code>.Call</code> and <code>.External</code></a> for details on <code>.Call</code> and <code>.External</code>.</p>
<div class="no-row-height column-margin column-container"><div id="fn14"><p><sup>14</sup>&nbsp;That is, similar to those defined in S version 4 from the 1990s: these are not kept up to date and are not recommended for new projects.</p></div></div><p>Before you decide to use <code>.Call</code> or <code>.External</code>, you should look at other alternatives. First, consider working in interpreted R code; if this is fast enough, this is normally the best option. You should also see if using <code>.C</code> is enough. If the task to be performed in C is simple enough involving only atomic vectors and requiring no call to R, <code>.C</code> suffices. A great deal of useful code was written using just <code>.C</code> before <code>.Call</code> and <code>.External</code> were available. These interfaces allow much more control, but they also impose much greater responsibilities so need to be used with care. Neither <code>.Call</code> nor <code>.External</code> copy their arguments: you should treat arguments you receive through these interfaces as read-only.</p>
<p>To handle R objects from within C code we use the macros and functions that have been used to implement the core parts of R. A public<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a> subset of these is defined in the header file <code>Rinternals.h</code> in the directory <code>R_INCLUDE_DIR</code> (default <code>R_HOME/include</code>) that should be available on any R installation.</p>
<div class="no-row-height column-margin column-container"><div id="fn15"><p><sup>15</sup>&nbsp;see <a href="The-R-API.html#the-r-api">The R API: entry points for C code</a>: note that these are not all part of the API.</p></div></div><p>A substantial amount of R, including the standard packages, is implemented using the functions and macros described here, so the R source code provides a rich source of examples and “how to do it”: do make use of the source code for inspirational examples.</p>
<p>It is necessary to know something about how R objects are handled in C code. All the R objects you will deal with will be handled with the type <em>SEXP</em><a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a>, which is a pointer to a structure with typedef <code>SEXPREC</code>. Think of this structure as a <em>variant type</em> that can handle all the usual types of R objects, that is vectors of various modes, functions, environments, language objects and so on. The details are given later in this section and in <a href="https://cran.r-project.org/doc/manuals/R-ints.html#R-Internal-Structures" data-manual="R-ints">R Internal Structures</a> in R Internals, but for most purposes the programmer does not need to know them. Think rather of a model such as that used by Visual Basic, in which R objects are handed around in C code (as they are in interpreted R code) as the variant type, and the appropriate part is extracted for, for example, numerical calculations, only when it is needed. As in interpreted R code, much use is made of coercion to force the variant object to the right type.</p>
<div class="no-row-height column-margin column-container"><div id="fn16"><p><sup>16</sup>&nbsp;SEXP is an acronym for <em>S</em>imple <em>EXP</em>ression, common in LISP-like language syntaxes.</p></div></div><section id="handling-the-effects-of-garbage-collection" class="level3 subsection" data-number="5.9.1">
<h3 class="subsection anchored" data-number="5.9.1" data-anchor-id="handling-the-effects-of-garbage-collection"><span class="header-section-number">5.9.1</span> Handling the effects of garbage collection</h3>
<p>We need to know a little about the way R handles memory allocation. The memory allocated for R objects is not freed by the user; instead, the memory is from time to time <em>garbage collected</em>. That is, some or all of the allocated memory not being used is freed or marked as re-usable.</p>
<p>The R object types are represented by a C structure defined by a typedef <code>SEXPREC</code> in <code>Rinternals.h</code>. It contains several things among which are pointers to data blocks and to other <code>SEXPREC</code>s. A <code>SEXP</code> is simply a pointer to a <code>SEXPREC</code>.</p>
<p>If you create an R object in your C code, you must tell R that you are using the object by using the <code>PROTECT</code> macro on a pointer to the object. This tells R that the object is in use so it is not destroyed during garbage collection. Notice that it is the object which is protected, not the pointer variable. It is a common mistake to believe that if you invoked <code>PROTECT(p)</code> at some point then <code>p</code> is protected from then on, but that is not true once a new object is assigned to <code>p</code>.</p>
<p>Protecting an R object automatically protects all the R objects pointed to in the corresponding <code>SEXPREC</code>, for example all elements of a protected list are automatically protected.</p>
<p>The programmer is solely responsible for housekeeping the calls to <code>PROTECT</code>. There is a corresponding macro <code>UNPROTECT</code> that takes as argument an <code>int</code> giving the number of objects to unprotect when they are no longer needed. The protection mechanism is stack-based, so <code>UNPROTECT(n)</code> unprotects the last <code>n</code> objects which were protected. The calls to <code>PROTECT</code> and <code>UNPROTECT</code> must balance when the user’s code returns and should balance in all functions. R will warn about <code>"stack imbalance in .Call"</code> (or <code>.External</code>) if the housekeeping is wrong.</p>
<p>Here is a small example of creating an R numeric vector in C code:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    SEXP ab<span class="op">;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">....</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    ab <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>REALSXP<span class="op">,</span> <span class="dv">2</span><span class="op">));</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    REAL<span class="op">(</span>ab<span class="op">)[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">123.45</span><span class="op">;</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    REAL<span class="op">(</span>ab<span class="op">)[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">67.89</span><span class="op">;</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, the reader may ask how the R object could possibly get removed during those manipulations, as it is just our C code that is running. As it happens, we can do without the protection in this example, but in general we do not know (nor want to know) what is hiding behind the R macros and functions we use, and any of them might cause memory to be allocated, hence garbage collection and hence our object <code>ab</code> to be removed. It is usually wise to err on the side of caution and assume that any of the R macros and functions might remove the object.</p>
<p>In some cases it is necessary to keep better track of whether protection is really needed. Be particularly aware of situations where a large number of objects are generated. The pointer protection stack has a fixed size (default 10,000) and can become full. It is not a good idea then to just <code>PROTECT</code> everything in sight and <code>UNPROTECT</code> several thousand objects at the end. It will almost invariably be possible to either assign the objects as part of another object (which automatically protects them) or unprotect them immediately after use.</p>
<p>There is a less-used macro <code>UNPROTECT_PTR(s)</code> that unprotects the object pointed to by the <code>SEXP</code> <code>s</code>, even if it is not the top item on the pointer protection stack. This macro was introduced for use in the parser, where the code interfacing with the R heap is generated and the generator cannot be configured to insert proper calls to <code>PROTECT</code> and <code>UNPROTECT</code>. However, <code>UNPROTECT_PTR</code> is dangerous to use in combination with <code>UNPROTECT</code> when the same object has been protected multiple times. It has been superseded by multi-set based functions <code>R_PreserveInMSet</code> and <code>R_ReleaseFromMSet</code>, which protect objects in a multi-set created by <code>R_NewPreciousMSet</code> and typically itself protected using <code>PROTECT</code>. These functions should not be needed outside parsers.</p>
<p>Sometimes an object is changed (for example duplicated, coerced or grown) yet the current value needs to be protected. For these cases <code>PROTECT_WITH_INDEX</code> saves an index of the protection location that can be used to replace the protected value using <code>REPROTECT</code>. For example (from the internal code for <code>optim</code>)</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>    PROTECT_INDEX ipx;</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    ....</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">PROTECT_WITH_INDEX</span>(<span class="at">s =</span> <span class="fu">eval</span>(OS<span class="ot">-&gt;</span>R_fcall, OS<span class="ot">-&gt;</span>R_env), <span class="sc">&amp;</span>ipx);</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">REPROTECT</span>(<span class="at">s =</span> <span class="fu">coerceVector</span>(s, REALSXP), ipx);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that it is dangerous to mix <code>UNPROTECT_PTR</code> also with <code>PROTECT_WITH_INDEX</code>, as the former changes the protection locations of objects that were protected after the one being unprotected.</p>
<p>There is another way to avoid the effects of garbage collection: a call to <code>R_PreserveObject</code> adds an object to an internal list of objects not to be collected, and a subsequent call to <code>R_ReleaseObject</code> removes it from that list. This provides a way for objects which are not returned as part of R objects to be protected across calls to compiled code: on the other hand it becomes the user’s responsibility to release them when they are no longer needed (and this often requires the use of a finalizer). It is less efficient than the normal protection mechanism, and should be used sparingly.</p>
<p>For functions from packages as well as R to safely co-operate in protecting objects, certain rules have to be followed:</p>
<ul>
<li>Pointer-protection balance. Calls to <code>PROTECT</code> and <code>UNPROTECT</code> should balance in each function. A function may only call <code>UNPROTECT</code> or <code>REPROTECT</code> on objects it has itself protected. Note that the pointer protection stack balance is restored automatically on non-local transfer of control (See <a href="The-R-API.html#condition-handling-and-cleanup-code">Condition handling and cleanup code</a>.), as if a call to <code>UNPROTECT</code> was invoked with the right argument.</li>
<li>Caller protection. It is the responsibility of the caller that all arguments passed to a function are protected and will stay protected for the whole execution of the callee. Typically this is achieved by <code>PROTECT</code> and <code>UNPROTECT</code> calls.</li>
<li>Protecting return values. Any R objects returned from a function are unprotected (the callee must maintain pointer-protection balance), and hence should be protected immediately by the caller. To be safe against future code changes, assume that any R object returned from any function may need protection. Note that even when conceptually returning an existing protected object, that object may be duplicated.</li>
<li>All functions/macros allocate. To be safe against future code changes, assume that any function or macro may allocate and hence garbage collector may run and destroy unprotected objects.</li>
</ul>
<p>It is always safe and recommended to follow those rules. In fact, several R functions and macros protect their own arguments and some functions do not allocate or do not allocate when used in a certain way, but that is subject to change, so relying on that may be fragile. <code>PROTECT</code> and <code>PROTECT_WITH_INDEX</code> can be safely called with unprotected arguments and <code>UNPROTECT</code> does not allocate.</p>
</section>
<section id="allocating-storage" class="level3 subsection" data-number="5.9.2">
<h3 class="subsection anchored" data-number="5.9.2" data-anchor-id="allocating-storage"><span class="header-section-number">5.9.2</span> Allocating storage</h3>
<p>For many purposes it is sufficient to allocate R objects and manipulate those. There are quite a few <code>allocXxx</code> functions defined in <code>Rinternals.h</code>—you may want to explore them.</p>
<p>One that is commonly used is <code>allocVector</code>, the C-level equivalent of R-level <code>vector()</code> and its wrappers such as <code>integer()</code> and <code>character()</code>. One distinction is that whereas the R functions always initialize the elements of the vector, <code>allocVector</code> only does so for lists, expressions and character vectors (the cases where the elements are themselves R objects). Other useful allocation functions are <code>alloc3DArray</code>, <code>allocArray</code>, and <code>allocMatrix</code>.</p>
<p>At times it can be useful to allocate a larger initial result vector and resize it to a shorter length if that is sufficient. The functions <code>lengthgets</code> and <code>xlengthgets</code> accomplish this; they are analogous to using <code>length(x) &lt;- n</code> in R. Typically these functions return a freshly allocated object, but in some cases they may re-use the supplied object.</p>
<p>When creating new result objects it can be useful to fill them in with values from an existing object. The functions <code>copyVector</code> and <code>copyMatrix</code> can be used for this. <code>copyMostAttributes</code> can also simplify setting up a result object; it is used internally for results of arithmetic operations.</p>
<p>If storage is required for C objects during the calculations this is best allocating by calling <code>R_alloc</code>; see <a href="The-R-API.html#memory-allocation">Memory allocation</a>. All of these memory allocation routines do their own error-checking, so the programmer may assume that they will raise an error and not return if the memory cannot be allocated.</p>
</section>
<section id="details-of-r-types" class="level3 subsection page-columns page-full" data-number="5.9.3">
<h3 class="subsection anchored" data-number="5.9.3" data-anchor-id="details-of-r-types"><span class="header-section-number">5.9.3</span> Details of R types</h3>
<p>Users of the <code>Rinternals.h</code> macros will need to know how the R types are known internally. The different R data types are represented in C by <em>SEXPTYPE</em>. Some of these are familiar from R and some are internal data types. The usual R object modes are given in the table.</p>
<blockquote class="blockquote">
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">SEXPTYPE</th>
<th style="text-align: left;">R equivalent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>REALSXP</code></td>
<td style="text-align: left;">numeric with storage mode <code>double</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>INTSXP</code></td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>CPLXSXP</code></td>
<td style="text-align: left;">complex</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>LGLSXP</code></td>
<td style="text-align: left;">logical</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>STRSXP</code></td>
<td style="text-align: left;">character</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>VECSXP</code></td>
<td style="text-align: left;">list (generic vector)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>LISTSXP</code></td>
<td style="text-align: left;">pairlist</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>DOTSXP</code></td>
<td style="text-align: left;">a <code>...</code> object</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>NILSXP</code></td>
<td style="text-align: left;">NULL</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>SYMSXP</code></td>
<td style="text-align: left;">name/symbol</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>CLOSXP</code></td>
<td style="text-align: left;">function or function closure</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ENVSXP</code></td>
<td style="text-align: left;">environment</td>
</tr>
</tbody>
</table>
</blockquote>
<p>Among the important internal <code>SEXPTYPE</code>s are <code>LANGSXP</code>, <code>CHARSXP</code>, <code>PROMSXP</code>, etc. (<strong>N.B.</strong>: although it is possible to return objects of internal types, it is unsafe to do so as assumptions are made about how they are handled which may be violated at user-level evaluation.) More details are given in <a href="https://cran.r-project.org/doc/manuals/R-ints.html#R-Internal-Structures" data-manual="R-ints">R Internal Structures</a> in R Internals.</p>
<p>Unless you are very sure about the type of the arguments, the code should check the data types. Sometimes it may also be necessary to check data types of objects created by evaluating an R expression in the C code. You can use functions like <code>isReal</code>, <code>isInteger</code> and <code>isString</code> to do type checking. Other such functions declared in the header file <code>Rinternals.h</code> include <code>isNull</code>, <code>isSymbol</code>, <code>isLogical</code>, <code>isComplex</code>, <code>isExpression</code>, and <code>isEnvironment</code>. All of these take a <code>SEXP</code> as argument and return 1 or 0 to indicate <code>TRUE</code> or <code>FALSE</code>.</p>
<p>What happens if the <code>SEXP</code> is not of the correct type? Sometimes you have no other option except to generate an error. You can use the function <code>Rf_error</code> for this. It is usually better to coerce the object to the correct type. For example, if you find that an <code>SEXP</code> is of the type <code>INTEGER</code>, but you need a <code>REAL</code> object, you can change the type by using</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>newSexp <span class="ot">=</span> <span class="fu">PROTECT</span>(<span class="fu">coerceVector</span>(oldSexp, REALSXP));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Protection is needed as a new <em>object</em> is created; the object formerly pointed to by the <code>SEXP</code> is still protected but now unused.<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn17"><p><sup>17</sup>&nbsp;If no coercion was required, <code>coerceVector</code> would have passed the old object through unchanged.</p></div></div><p>All the coercion functions do their own error-checking, and generate <code>NA</code>s with a warning or stop with an error as appropriate.</p>
<p>Note that these coercion functions are <em>not</em> the same as calling <code>as.numeric</code> (and so on) in R code, as they do not dispatch on the class of the object. Thus it is normally preferable to do the coercion in the calling R code.</p>
<p>So far we have only seen how to create and coerce R objects from C code, and how to extract the numeric data from numeric R vectors. These can suffice to take us a long way in interfacing R objects to numerical algorithms, but we may need to know a little more to create useful return objects.</p>
</section>
<section id="attributes" class="level3 subsection" data-number="5.9.4">
<h3 class="subsection anchored" data-number="5.9.4" data-anchor-id="attributes"><span class="header-section-number">5.9.4</span> Attributes</h3>
<p>Many R objects have attributes: some of the most useful are classes and the <code>dim</code> and <code>dimnames</code> that mark objects as matrices or arrays. It can also be helpful to work with the <code>names</code> attribute of vectors.</p>
<p>To illustrate this, let us write code to take the outer product of two vectors (which <code>outer</code> and <code>%o%</code> already do). As usual the R code is simple</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">storage.mode</span>(x) <span class="ot">&lt;-</span> <span class="fu">storage.mode</span>(y) <span class="ot">&lt;-</span> <span class="st">"double"</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Call</span>(<span class="st">"out"</span>, x, y)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where we expect <code>x</code> and <code>y</code> to be numeric vectors (possibly integer), possibly with names. This time we do the coercion in the calling R code.</p>
<p>C code to do the computations is</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>SEXP out<span class="op">(</span>SEXP x<span class="op">,</span> SEXP y<span class="op">)</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> nx <span class="op">=</span> length<span class="op">(</span>x<span class="op">),</span> ny <span class="op">=</span> length<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    SEXP ans <span class="op">=</span> PROTECT<span class="op">(</span>allocMatrix<span class="op">(</span>REALSXP<span class="op">,</span> nx<span class="op">,</span> ny<span class="op">));</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="op">*</span>rx <span class="op">=</span> REAL<span class="op">(</span>x<span class="op">),</span> <span class="op">*</span>ry <span class="op">=</span> REAL<span class="op">(</span>y<span class="op">),</span> <span class="op">*</span>rans <span class="op">=</span> REAL<span class="op">(</span>ans<span class="op">);</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nx<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> tmp <span class="op">=</span> rx<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> ny<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>            rans<span class="op">[</span>i <span class="op">+</span> nx<span class="op">*</span>j<span class="op">]</span> <span class="op">=</span> tmp <span class="op">*</span> ry<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note the way <code>REAL</code> is used: as it is a function call it can be considerably faster to store the result and index that.</p>
<p>However, we would like to set the <code>dimnames</code> of the result. We can use</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>SEXP out<span class="op">(</span>SEXP x<span class="op">,</span> SEXP y<span class="op">)</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> nx <span class="op">=</span> length<span class="op">(</span>x<span class="op">),</span> ny <span class="op">=</span> length<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    SEXP ans <span class="op">=</span> PROTECT<span class="op">(</span>allocMatrix<span class="op">(</span>REALSXP<span class="op">,</span> nx<span class="op">,</span> ny<span class="op">));</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="op">*</span>rx <span class="op">=</span> REAL<span class="op">(</span>x<span class="op">),</span> <span class="op">*</span>ry <span class="op">=</span> REAL<span class="op">(</span>y<span class="op">),</span> <span class="op">*</span>rans <span class="op">=</span> REAL<span class="op">(</span>ans<span class="op">);</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nx<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> tmp <span class="op">=</span> rx<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> ny<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>        rans<span class="op">[</span>i <span class="op">+</span> nx<span class="op">*</span>j<span class="op">]</span> <span class="op">=</span> tmp <span class="op">*</span> ry<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    SEXP dimnames <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>VECSXP<span class="op">,</span> <span class="dv">2</span><span class="op">));</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    SET_VECTOR_ELT<span class="op">(</span>dimnames<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> getAttrib<span class="op">(</span>x<span class="op">,</span> R_NamesSymbol<span class="op">));</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    SET_VECTOR_ELT<span class="op">(</span>dimnames<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> getAttrib<span class="op">(</span>y<span class="op">,</span> R_NamesSymbol<span class="op">));</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    setAttrib<span class="op">(</span>ans<span class="op">,</span> R_DimNamesSymbol<span class="op">,</span> dimnames<span class="op">);</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This example introduces several new features. The <code>getAttrib</code> and <code>setAttrib</code> functions get and set individual attributes. Their second argument is a <code>SEXP</code> defining the name in the symbol table of the attribute we want; these and many such symbols are defined in the header file <code>Rinternals.h</code>.</p>
<p>There are shortcuts here too: the functions <code>namesgets</code>, <code>dimgets</code> and <code>dimnamesgets</code> are the internal versions of the default methods of <code>names&lt;-</code>, <code>dim&lt;-</code> and <code>dimnames&lt;-</code> (for vectors and arrays), and there are functions such as <code>GetColNames</code>, <code>GetRowNames</code>, <code>GetMatrixDimnames</code> and <code>GetArrayDimnames</code>.</p>
<p>What happens if we want to add an attribute that is not pre-defined? We need to add a symbol for it <em>via</em> a call to <code>install</code>. Suppose for illustration we wanted to add an attribute <code>"version"</code> with value <code>3.0</code>. We could use</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>SEXP version<span class="op">;</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>version <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>REALSXP<span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>REAL<span class="op">(</span>version<span class="op">)[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">3.0</span><span class="op">;</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>setAttrib<span class="op">(</span>ans<span class="op">,</span> install<span class="op">(</span><span class="st">"version"</span><span class="op">),</span> version<span class="op">);</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>UNPROTECT<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using <code>install</code> when it is not needed is harmless and provides a simple way to retrieve the symbol from the symbol table if it is already installed. However, the lookup takes a non-trivial amount of time, so consider code such as</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> SEXP VerSymbol <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>VerSymbol <span class="op">==</span> NULL<span class="op">)</span> VerSymbol <span class="op">=</span> install<span class="op">(</span><span class="st">"version"</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>if it is to be done frequently.</p>
<p>This example can be simplified by another convenience function:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>SEXP version <span class="op">=</span> PROTECT<span class="op">(</span>ScalarReal<span class="op">(</span><span class="fl">3.0</span><span class="op">));</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>setAttrib<span class="op">(</span>ans<span class="op">,</span> install<span class="op">(</span><span class="st">"version"</span><span class="op">),</span> version<span class="op">);</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>UNPROTECT<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If a result is to be a vector with all elements named, then <code>mkNamed</code> can be used to allocate a vector of a specified type. Names are provided as a C vector of strings terminated by an empty string:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>nms<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">"xi"</span><span class="op">,</span> <span class="st">"yi"</span><span class="op">,</span> <span class="st">"zi"</span><span class="op">,</span> <span class="st">""</span><span class="op">};</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>mkNamed<span class="op">(</span>VECSXP<span class="op">,</span> nms<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Symbols can also be installed or retrieved based on a name in a <code>CHARSXP</code> object using either <code>Rf_installChar</code> or <code>Rf_installTrChar</code>. These used to differ in handling character encoding but have been identical since R 4.0.0.</p>
</section>
<section id="classes" class="level3 subsection" data-number="5.9.5">
<h3 class="subsection anchored" data-number="5.9.5" data-anchor-id="classes"><span class="header-section-number">5.9.5</span> Classes</h3>
<p>In R the class is just the attribute named <code>"class"</code> so it can be handled as such, but there is a shortcut <code>classgets</code>. Suppose we want to give the return value in our example the class <code>"mat"</code>. We can use</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">....</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    SEXP ans<span class="op">,</span> dim<span class="op">,</span> dimnames<span class="op">,</span> class<span class="op">;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">....</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    class <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>STRSXP<span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    SET_STRING_ELT<span class="op">(</span>class<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> mkChar<span class="op">(</span><span class="st">"mat"</span><span class="op">));</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    classgets<span class="op">(</span>ans<span class="op">,</span> class<span class="op">);</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As the value is a character vector, we have to know how to create that from a C character array, which we do using the function <code>mkChar</code>.</p>
</section>
<section id="s4-objects" class="level3 subsection" data-number="5.9.6">
<h3 class="subsection anchored" data-number="5.9.6" data-anchor-id="s4-objects"><span class="header-section-number">5.9.6</span> S4 objects</h3>
<p>Several functions are available for working with S4 objects and classes in C, including:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>SEXP allocS4Object<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>SEXP asS4<span class="op">(</span>SEXP<span class="op">,</span> Rboolean<span class="op">,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> R_check_class_etc<span class="op">(</span>SEXP x<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">**</span>valid<span class="op">);</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>SEXP R_do_MAKE_CLASS<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>what<span class="op">);</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>SEXP R_do_new_object<span class="op">(</span>SEXP class_def<span class="op">);</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>SEXP R_do_slot<span class="op">(</span>SEXP obj<span class="op">,</span> SEXP name<span class="op">);</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>SEXP R_do_slot_assign<span class="op">(</span>SEXP obj<span class="op">,</span> SEXP name<span class="op">,</span> SEXP value<span class="op">);</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>SEXP R_getClassDef  <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>what<span class="op">);</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> R_has_slot<span class="op">(</span>SEXP obj<span class="op">,</span> SEXP name<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="handling-lists" class="level3 subsection" data-number="5.9.7">
<h3 class="subsection anchored" data-number="5.9.7" data-anchor-id="handling-lists"><span class="header-section-number">5.9.7</span> Handling lists</h3>
<p>Some care is needed with lists, as R moved early on from using LISP-like lists (now called “pairlists”) to S-like generic vectors. As a result, the appropriate test for an object of mode <code>list</code> is <code>isNewList</code>, and we need <code>allocVector(VECSXP, n</code>) and <em>not</em> <code>allocList(n)</code>.</p>
<p>List elements can be retrieved or set by direct access to the elements of the generic vector. Suppose we have a list object</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="dv">1</span>, <span class="at">g =</span> <span class="dv">2</span>, <span class="at">h =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we can access <code>a$g</code> as <code>a[[2]]</code> by</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> g<span class="op">;</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">....</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> REAL<span class="op">(</span>VECTOR_ELT<span class="op">(</span>a<span class="op">,</span> <span class="dv">1</span><span class="op">))[</span><span class="dv">0</span><span class="op">];</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This can rapidly become tedious, and the following function (based on one in package <strong>stats</strong>) is very useful:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* get the list element named str (ASCII), or return NULL */</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>SEXP getListElement<span class="op">(</span>SEXP list<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>str<span class="op">)</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    SEXP elmt <span class="op">=</span> R_NilValue<span class="op">,</span> names <span class="op">=</span> getAttrib<span class="op">(</span>list<span class="op">,</span> R_NamesSymbol<span class="op">);</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> length<span class="op">(</span>list<span class="op">);</span> i<span class="op">++)</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>strcmp<span class="op">(</span>CHAR<span class="op">(</span>STRING_ELT<span class="op">(</span>names<span class="op">,</span> i<span class="op">)),</span> str<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>           <span class="co">/* ASCII only */</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>           elmt <span class="op">=</span> VECTOR_ELT<span class="op">(</span>list<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>           <span class="cf">break</span><span class="op">;</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> elmt<span class="op">;</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and enables us to say</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> g<span class="op">;</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  g <span class="op">=</span> REAL<span class="op">(</span>getListElement<span class="op">(</span>a<span class="op">,</span> <span class="st">"g"</span><span class="op">))[</span><span class="dv">0</span><span class="op">];</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code only works for names that are ASCII (see <a href="#character-encoding-issues">Character encoding issues</a>).</p>
</section>
<section id="handling-character-data" class="level3 subsection" data-number="5.9.8">
<h3 class="subsection anchored" data-number="5.9.8" data-anchor-id="handling-character-data"><span class="header-section-number">5.9.8</span> Handling character data</h3>
<p>R character vectors are stored as <code>STRSXP</code>s, a vector type like <code>VECSXP</code> where every element is of type <code>CHARSXP</code>. The <code>CHARSXP</code> elements of <code>STRSXP</code>s are accessed using <code>STRING_ELT</code> and <code>SET_STRING_ELT</code>.</p>
<p><code>CHARSXP</code>s are read-only objects and must never be modified. In particular, the C-style string contained in a <code>CHARSXP</code> should be treated as read-only and for this reason the <code>CHAR</code> function used to access the character data of a <code>CHARSXP</code> returns <code>(const char *)</code> (this also allows compilers to issue warnings about improper use). Since <code>CHARSXP</code>s are immutable, the same <code>CHARSXP</code> can be shared by any <code>STRSXP</code> needing an element representing the same string. R maintains a global cache of <code>CHARSXP</code>s so that there is only ever one <code>CHARSXP</code> representing a given string in memory. It most cases it is easier to use <code>translateChar</code> or <code>translateCharUTF8</code> to obtain the C string and it is safer against potential future changes in R (see <a href="#character-encoding-issues">Character encoding issues</a>).</p>
<p>You can obtain a <code>CHARSXP</code> by calling <code>mkChar</code> and providing a NUL-terminated C-style string. This function will return a pre-existing <code>CHARSXP</code> if one with a matching string already exists, otherwise it will create a new one and add it to the cache before returning it to you. The variant <code>mkCharLen</code> can be used to create a <code>CHARSXP</code> from part of a buffer and will ensure null-termination.</p>
<p>Note that R character strings are restricted to <code>2^31 - 1</code> bytes, and hence so should the input to <code>mkChar</code> be (C allows longer strings on 64-bit platforms).</p>
</section>
<section id="working-with-closures" class="level3 subsection" data-number="5.9.9">
<h3 class="subsection anchored" data-number="5.9.9" data-anchor-id="working-with-closures"><span class="header-section-number">5.9.9</span> Working with closures</h3>
<p>New function closure objects can be created with <code>R_mkClosure</code>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>SEXP R_mkClosure<span class="op">(</span>SEXP formals<span class="op">,</span> SEXP body<span class="op">,</span> SEXP rho<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The components of a closure can be extracted with <code>R_ClosureFormals</code>, <code>R_ClosureBody</code>, and <code>R_ClosureEnv</code>. For a byte compiled closure <code>R_ClosureBody</code> returns the compiled body. <code>R_ClosureExpr</code> returns the body expression for both compiled and uncompiled closures. The expression for a compiled object can be obtained with <code>R_BytecodeExpr</code>.</p>
</section>
<section id="finding-and-setting-variables" class="level3 subsection page-columns page-full" data-number="5.9.10">
<h3 class="subsection anchored" data-number="5.9.10" data-anchor-id="finding-and-setting-variables"><span class="header-section-number">5.9.10</span> Finding and setting variables</h3>
<p>It will be usual that all the R objects needed in our C computations are passed as arguments to <code>.Call</code> or <code>.External</code>, but it is possible to find the values of R objects from within the C given their names. The following code is the equivalent of <code>get(name, envir = rho)</code>.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>SEXP getvar<span class="op">(</span>SEXP name<span class="op">,</span> SEXP rho<span class="op">)</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    SEXP ans<span class="op">;</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>isString<span class="op">(</span>name<span class="op">)</span> <span class="op">||</span> length<span class="op">(</span>name<span class="op">)</span> <span class="op">!=</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">"name is not a single string"</span><span class="op">);</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>isEnvironment<span class="op">(</span>rho<span class="op">))</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">"rho should be an environment"</span><span class="op">);</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>    ans <span class="op">=</span> R_getVar<span class="op">(</span>installChar<span class="op">(</span>STRING_ELT<span class="op">(</span>name<span class="op">,</span> <span class="dv">0</span><span class="op">)),</span> rho<span class="op">,</span> TRUE<span class="op">);</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>TYPEOF<span class="op">(</span>ans<span class="op">)</span> <span class="op">!=</span> REALSXP <span class="op">||</span> length<span class="op">(</span>ans<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">"value is not a numeric vector with at least one element"</span><span class="op">);</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    Rprintf<span class="op">(</span><span class="st">"first value is </span><span class="sc">%f\n</span><span class="st">"</span><span class="op">,</span> REAL<span class="op">(</span>ans<span class="op">)[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> R_NilValue<span class="op">;</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The main work is done by <code>R_getVar</code>, but to use it we need to install <code>name</code> as a name in the symbol table. As we wanted the value for internal use, we return <code>NULL</code>.</p>
<p><code>R_getVar</code> is similar to the R function <code>get</code>. It signals an error if there is no binding for the variable in the environment. <code>R_getVarEx</code> can be used to return a default value if no binding is found; this corresponds to the R function <code>get0</code>. The third argument to <code>R_getVar</code> and <code>R_getVarEx</code> corresponds to the <code>inherits</code> argument to the R function <code>get</code>.</p>
<p>Functions with syntax</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> defineVar<span class="op">(</span>SEXP symbol<span class="op">,</span> SEXP value<span class="op">,</span> SEXP rho<span class="op">)</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setVar<span class="op">(</span>SEXP symbol<span class="op">,</span> SEXP value<span class="op">,</span> SEXP rho<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>can be used to assign values to R variables. <code>defineVar</code> creates a new binding or changes the value of an existing binding in the specified environment frame; it is the analogue of <code>assign(symbol, value, envir = rho, inherits = FALSE)</code>, but unlike <code>assign</code>, <code>defineVar</code> does not make a copy of the object <code>value</code>.<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a> <code>setVar</code> searches for an existing binding for <code>symbol</code> in <code>rho</code> or its enclosing environments. If a binding is found, its value is changed to <code>value</code>. Otherwise, a new binding with the specified value is created in the global environment. This corresponds to <code>assign(symbol, value, envir = rho, inherits = TRUE)</code>.</p>
<div class="no-row-height column-margin column-container"><div id="fn18"><p><sup>18</sup>&nbsp;You can assign a <em>copy</em> of the object in the environment frame <code>rho</code> using <code>defineVar(symbol, duplicate(value), rho)</code>).</p></div></div><p>At times it may also be useful to create a new environment frame in C code. <code>R_NewEnv</code> is a C version of the R function <code>new.env</code>:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>SEXP R_NewEnv<span class="op">(</span>SEXP enclos<span class="op">,</span> <span class="dt">int</span> hash<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="some-convenience-functions" class="level3 subsection" data-number="5.9.11">
<h3 class="subsection anchored" data-number="5.9.11" data-anchor-id="some-convenience-functions"><span class="header-section-number">5.9.11</span> Some convenience functions</h3>
<p>Some operations are done so frequently that there are convenience functions to handle them. (All these are provided <em>via</em> the header file <code>Rinternals.h</code>.)</p>
<p>Suppose we wanted to pass a single logical argument <code>ignore_quotes</code>: we could use</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ign <span class="op">=</span> asLogical<span class="op">(</span>ignore_quotes<span class="op">);</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>ign <span class="op">==</span> NA_LOGICAL<span class="op">)</span> error<span class="op">(</span><span class="st">"'ignore_quotes' must be TRUE or FALSE"</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which will do any coercion needed (at least from a vector argument), and return <code>NA_LOGICAL</code> if the value passed was <code>NA</code> or coercion failed. There are also <code>asInteger</code>, <code>asReal</code> and <code>asComplex</code>. The function <code>asChar</code> returns a <code>CHARSXP</code>. All of these functions ignore any elements of an input vector after the first. The function <code>asCharacterFactor</code> converts a factor to a character vector.</p>
<p>To return a length-one real vector we can use</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> x<span class="op">;</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ScalarReal<span class="op">(</span>x<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and there are versions of this for all the atomic vector types (those for a length-one character vector being <code>ScalarString</code> with argument a <code>CHARSXP</code> and <code>mkString</code> with argument <code>const char *</code>).</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>SEXP ScalarReal<span class="op">(</span><span class="dt">double</span><span class="op">);</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>SEXP ScalarInteger<span class="op">(</span><span class="dt">int</span><span class="op">);</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>SEXP ScalarLogical<span class="op">(</span><span class="dt">int</span><span class="op">)</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>SEXP ScalarRaw<span class="op">(</span>Rbyte<span class="op">);</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>SEXP ScalarComplex<span class="op">(</span>Rcomplex<span class="op">);</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>SEXP ScalarString<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>SEXP mkString<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Some of the <code>isXXXX</code> functions differ from their apparent R-level counterparts: for example <code>isVector</code> is true for any atomic vector type (<code>isVectorAtomic</code>) and for lists and expressions (<code>isVectorList</code>) (with no check on attributes). <code>isMatrix</code> is a test of a length-2 <code>"dim"</code> attribute.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>Rboolean isVector<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>Rboolean isVectorAtomic<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>Rboolean isVectorList<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>Rboolean isMatrix<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>Rboolean isPairList<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>Rboolean isPrimitive<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>Rboolean isTs<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>Rboolean isNumeric<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>Rboolean isArray<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>Rboolean isFactor<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>Rboolean isObject<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>Rboolean isFunction<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>Rboolean isLanguage<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>Rboolean isNewList<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>Rboolean isList<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>Rboolean isOrdered<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>Rboolean isUnordered<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>Rboolean isS4<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>Rboolean isNumber<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>Rboolean isDataFrame <span class="op">(</span>SEXP<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Some additional predicates:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>Rboolean isBlankString<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*);</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>Rboolean Rf_StringBlank<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>Rboolean StringFalse<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*);</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>Rboolean StringTrue<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*);</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> IS_LONG_VEC<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> IS_SCALAR<span class="op">(</span>SEXP<span class="op">,</span> <span class="dt">int</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are a series of small macros/functions to help construct pairlists and language objects (whose internal structures just differ by <code>SEXPTYPE</code>). Function <code>CONS(u, v)</code> is the basic building block: it constructs a pairlist from <code>u</code> followed by <code>v</code> (which is a pairlist or <code>R_NilValue</code>). <code>LCONS</code> is a variant that constructs a language object. Functions <code>list1</code> to <code>list6</code> construct a pairlist from one to six items, and <code>lang1</code> to <code>lang6</code> do the same for a language object (a function to call plus zero to five arguments). Functions <code>elt</code> and <code>lastElt</code> find the <code>i</code>-th element and the last element of a pairlist, and <code>nthcdr</code> returns a pointer to the <code>n</code>-th position in the pairlist (whose <code>CAR</code> is the <code>n</code>-th item).</p>
<p>Functions <code>str2type</code> and <code>type2str</code> map R length-one character strings to and from <code>SEXPTYPE</code> numbers, and <code>type2char</code> maps numbers to C character strings. <code>type2str_nowarn</code> does not issue a warning if the <code>SEXPTYPE</code> is invalid.</p>
</section>
<section id="semi-internal-convenience-functions" class="level3 subsubsection" data-number="5.9.12">
<h3 class="subsubsection anchored" data-number="5.9.12" data-anchor-id="semi-internal-convenience-functions"><span class="header-section-number">5.9.12</span> Semi-internal convenience functions</h3>
<p>There is quite a collection of functions that may be used in your C code <em>if</em> you are willing to adapt to rare “API” changes. These typically contain “workhorses” of their R counterparts.</p>
<p>Functions <code>any_duplicated</code> and <code>any_duplicated3</code> are fast versions of R’s <code>any(duplicated(.))</code>.</p>
<p>Function <code>R_compute_identical</code> corresponds to R’s <code>identical</code> function. Function <code>R_BindingIsLocked</code> corresponds to R’s <code>bindingIsLocked</code> function. Function <code>R_ParentEnv</code> corresponds to R’1 <code>parent.env</code>.</p>
<p>The C functions <code>inherits</code> and <code>topenv</code> correspond to the R functions of the same name. The C function <code>GetOption1</code> corresponds to the R function <code>getOption</code> without specifying a default. <code>GetOptionWidth</code> returns the value of the <code>width</code> option as an <code>int</code>. The C function <code>nlevels</code> returns the number of levels of a factor. Unlike its R counterpart it always returns zero for non-factors.</p>
<p>For vectors the C function <code>duplicated</code> returns a logical vector indicating for each element whether it is duplicated or not. A second argument specifies the direction of the search.</p>
<p>The C function <code>R_lsInternal3</code> returns a character vector of the names of variables in an environment. The second and third arguments specify whether all names are desired and whether the result should be sorted.</p>
<p>Some convenience functions for working with pairlist objects include <code>copyListMatrix</code>, <code>listAppend</code>, <code>isVectorizable</code>, <code>VectorToPairList</code>, and <code>PairToVectorList</code></p>
<p>Some convenience functions for working with name spaces and environments include <code>R_existsVarInFrame</code>, <code>R_removeVarFromFrame</code>, <code>R_PackageEnvName</code>, <code>R_IsPackageEnv</code>, <code>R_FindNamespace</code>, <code>R_IsNamespaceEnv</code>, and <code>R_NamespaceEnvSpec</code>.</p>
<p>The C functions <code>match</code> and <code>pmatch</code> correspond to the R functions by the same name. The C-level workhorse for partial matching is provided by <code>psmatch</code>.</p>
<p>The C functions <code>R_forceAndCall</code> and <code>isUnsorted</code> correspond to the R functions <code>forceAndCall</code> and <code>is.unsorted</code>.</p>
</section>
<section id="named-objects-and-copying" class="level3 subsection" data-number="5.9.13">
<h3 class="subsection anchored" data-number="5.9.13" data-anchor-id="named-objects-and-copying"><span class="header-section-number">5.9.13</span> Named objects and copying</h3>
<p>[The <code>NAMED</code> mechanism has been replaced by reference counting.]</p>
<p>When assignments are done in R such as</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>the named object is not necessarily copied, so after those two assignments <code>y</code> and <code>x</code> are bound to the same <code>SEXPREC</code> (the structure a <code>SEXP</code> points to). This means that any code which alters one of them has to make a copy before modifying the copy if the usual R semantics are to apply. Note that whereas <code>.C</code> and <code>.Fortran</code> do copy their arguments, <code>.Call</code> and <code>.External</code> do not. So <code>duplicate</code> is commonly called on arguments to <code>.Call</code> before modifying them. If only the top level is modified it may suffice to call <code>shallow_duplicate</code>.</p>
<p>At times it may be necessary to copy attributes from one object to another. This can be done using <code>DUPLICATE_ATTRIB</code> or <code>SHALLOW_DUPLICATE_ATTRIB</code> <code>ANY_ATTRIB</code> checks whether there are any attributes and <code>CLEAR_ATTRIB</code> removes all attributes.</p>
<p>However, at least some of this copying is unneeded. In the first assignment shown, <code>x &lt;- 1:10</code>, R first creates an object with value <code>1:10</code> and then assigns it to <code>x</code> but if <code>x</code> is modified no copy is necessary as the temporary object with value <code>1:10</code> cannot be referred to again. R distinguishes between named and unnamed objects <em>via</em> a field in a <code>SEXPREC</code> that can be accessed <em>via</em> the macros <code>NAMED</code> and <code>SET_NAMED</code>. This can take values</p>
<dl>
<dt><code>0</code></dt>
<dd>
<p>The object is not bound to any symbol</p>
</dd>
<dt><code>1</code></dt>
<dd>
<p>The object has been bound to exactly one symbol</p>
</dd>
<dt><code>&gt;= 2</code></dt>
<dd>
<p>The object has potentially been bound to two or more symbols, and one should act as if another variable is currently bound to this value. The maximal value is <code>NAMEDMAX</code>.</p>
</dd>
</dl>
<p>Note the past tenses: R does not do currently do full reference counting and there may currently be fewer bindings.</p>
<p>It is safe to modify the value of any <code>SEXP</code> for which <code>NAMED(foo)</code> is zero, and if <code>NAMED(foo)</code> is two or more, the value should be duplicated (<em>via</em> a call to <code>duplicate</code>) before any modification. Note that it is the responsibility of the author of the code making the modification to do the duplication, even if it is <code>x</code> whose value is being modified after <code>y &lt;- x</code>.</p>
<p>The case <code>NAMED(foo) == 1</code> allows some optimization, but it can be ignored (and duplication done whenever <code>NAMED(foo) &gt; 0</code>). (This optimization is not currently usable in user code.) It is intended for use within replacement functions. Suppose we used</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foo</span>(x) <span class="ot">&lt;-</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which is computed as</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">"foo&lt;-"</span>(x, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then inside <code>"foo&lt;-"</code> the object pointing to the current value of <code>x</code> will have <code>NAMED(foo)</code> as one, and it would be safe to modify it as the only symbol bound to it is <code>x</code> and that will be rebound immediately. (Provided the remaining code in <code>"foo&lt;-"</code> make no reference to <code>x</code>, and no one is going to attempt a direct call such as <code>y &lt;- "foo&lt;-"(x)</code>.)</p>
<p>This mechanism was replaced in R 4.0.0. To support future changes, package code should use <code>NO_REFERENCES</code>, <code>MAYBE_REFERENCED</code>, <code>NOT_SHARED</code>, <code>MAYBE_SHARED</code>, and <code>MARK_NOT_MUTABLE</code>.</p>
</section>
</section>
<section id="interface-functions-.call-and-.external" class="level2 section" data-number="5.10">
<h2 class="section anchored" data-number="5.10" data-anchor-id="interface-functions-.call-and-.external"><span class="header-section-number">5.10</span> Interface functions <code>.Call</code> and <code>.External</code></h2>
<p>In this section we consider the details of the R/C interfaces.</p>
<p>These two interfaces have almost the same functionality. <code>.Call</code> is based on the interface of the same name in S version 4, and <code>.External</code> is based on R’s <code>.Internal</code>. <code>.External</code> is more complex but allows a variable number of arguments.</p>
<section id="calling-.call" class="level3 subsection" data-number="5.10.1">
<h3 class="subsection anchored" data-number="5.10.1" data-anchor-id="calling-.call"><span class="header-section-number">5.10.1</span> Calling <code>.Call</code></h3>
<p>Let us convert our finite convolution example to use <code>.Call</code>. The calling function in R is</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>conv <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) <span class="fu">.Call</span>(<span class="st">"convolve2"</span>, a, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which could hardly be simpler, but as we shall see all the type coercion is transferred to the C code, which is</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>SEXP convolve2<span class="op">(</span>SEXP a<span class="op">,</span> SEXP b<span class="op">)</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> na<span class="op">,</span> nb<span class="op">,</span> nab<span class="op">;</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="op">*</span>xa<span class="op">,</span> <span class="op">*</span>xb<span class="op">,</span> <span class="op">*</span>xab<span class="op">;</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    SEXP ab<span class="op">;</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> PROTECT<span class="op">(</span>coerceVector<span class="op">(</span>a<span class="op">,</span> REALSXP<span class="op">));</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> PROTECT<span class="op">(</span>coerceVector<span class="op">(</span>b<span class="op">,</span> REALSXP<span class="op">));</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    na <span class="op">=</span> length<span class="op">(</span>a<span class="op">);</span> nb <span class="op">=</span> length<span class="op">(</span>b<span class="op">);</span> nab <span class="op">=</span> na <span class="op">+</span> nb <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    ab <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>REALSXP<span class="op">,</span> nab<span class="op">));</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    xa <span class="op">=</span> REAL<span class="op">(</span>a<span class="op">);</span> xb <span class="op">=</span> REAL<span class="op">(</span>b<span class="op">);</span> xab <span class="op">=</span> REAL<span class="op">(</span>ab<span class="op">);</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nab<span class="op">;</span> i<span class="op">++)</span> xab<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> na<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> nb<span class="op">;</span> j<span class="op">++)</span> xab<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">+=</span> xa<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> xb<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ab<span class="op">;</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="calling-.external" class="level3 subsection" data-number="5.10.2">
<h3 class="subsection anchored" data-number="5.10.2" data-anchor-id="calling-.external"><span class="header-section-number">5.10.2</span> Calling <code>.External</code></h3>
<p>We can use the same example to illustrate <code>.External</code>. The R code changes only by replacing <code>.Call</code> by <code>.External</code></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>conv <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) <span class="fu">.External</span>(<span class="st">"convolveE"</span>, a, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>but the main change is how the arguments are passed to the C code, this time as a single SEXP. The only change to the C code is how we handle the arguments.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>SEXP convolveE<span class="op">(</span>SEXP args<span class="op">)</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">,</span> j<span class="op">,</span> na<span class="op">,</span> nb<span class="op">,</span> nab<span class="op">;</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="op">*</span>xa<span class="op">,</span> <span class="op">*</span>xb<span class="op">,</span> <span class="op">*</span>xab<span class="op">;</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>    SEXP a<span class="op">,</span> b<span class="op">,</span> ab<span class="op">;</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> PROTECT<span class="op">(</span>coerceVector<span class="op">(</span>CADR<span class="op">(</span>args<span class="op">),</span> REALSXP<span class="op">));</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> PROTECT<span class="op">(</span>coerceVector<span class="op">(</span>CADDR<span class="op">(</span>args<span class="op">),</span> REALSXP<span class="op">));</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once again we do not need to protect the arguments, as in the R side of the interface they are objects that are already in use. The macros</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">=</span> <span class="fu">CADR</span>(args);</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  second <span class="ot">=</span> <span class="fu">CADDR</span>(args);</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  third <span class="ot">=</span> <span class="fu">CADDDR</span>(args);</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  fourth <span class="ot">=</span> <span class="fu">CAD4R</span>(args);</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  fifth  <span class="ot">=</span> <span class="fu">CAD5R</span>(args);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>provide convenient ways to access the first four arguments. More generally we can use the <code>CDR</code> and <code>CAR</code> macros as in</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>  args <span class="ot">=</span> <span class="fu">CDR</span>(args); a <span class="ot">=</span> <span class="fu">CAR</span>(args);</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  args <span class="ot">=</span> <span class="fu">CDR</span>(args); b <span class="ot">=</span> <span class="fu">CAR</span>(args);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which clearly allows us to extract an unlimited number of arguments (whereas <code>.Call</code> has a limit, albeit at 65 not a small one).</p>
<p>More usefully, the <code>.External</code> interface provides an easy way to handle calls with a variable number of arguments, as <code>length(args)</code> will give the number of arguments supplied (of which the first is ignored). We may need to know the names (‘tags’) given to the actual arguments, which we can by using the <code>TAG</code> macro and using something like the following example, that prints the names and the first value of its arguments if they are vector types.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>SEXP showArgs<span class="op">(</span>SEXP args<span class="op">)</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>vmax <span class="op">=</span> vmaxget<span class="op">();</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> CDR<span class="op">(</span>args<span class="op">);</span> <span class="co">/* skip 'name' */</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> args <span class="op">!=</span> R_NilValue<span class="op">;</span> i<span class="op">++,</span> args <span class="op">=</span> CDR<span class="op">(</span>args<span class="op">))</span> <span class="op">{</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name <span class="op">=</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>            isNull<span class="op">(</span>TAG<span class="op">(</span>args<span class="op">))</span> <span class="op">?</span> <span class="st">""</span> <span class="op">:</span> translateChar<span class="op">(</span>PRINTNAME<span class="op">(</span>TAG<span class="op">(</span>args<span class="op">)));</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>        SEXP el <span class="op">=</span> CAR<span class="op">(</span>args<span class="op">);</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>length<span class="op">(</span>el<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>            Rprintf<span class="op">(</span><span class="st">"[</span><span class="sc">%d</span><span class="st">] '</span><span class="sc">%s</span><span class="st">' R type, length 0</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> name<span class="op">);</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>           <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span><span class="op">(</span>TYPEOF<span class="op">(</span>el<span class="op">))</span> <span class="op">{</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> REALSXP<span class="op">:</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>            Rprintf<span class="op">(</span><span class="st">"[</span><span class="sc">%d</span><span class="st">] '</span><span class="sc">%s</span><span class="st">' </span><span class="sc">%f\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> name<span class="op">,</span> REAL<span class="op">(</span>el<span class="op">)[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> LGLSXP<span class="op">:</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INTSXP<span class="op">:</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>            Rprintf<span class="op">(</span><span class="st">"[</span><span class="sc">%d</span><span class="st">] '</span><span class="sc">%s</span><span class="st">' </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> name<span class="op">,</span> INTEGER<span class="op">(</span>el<span class="op">)[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> CPLXSXP<span class="op">:</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>            Rcomplex cpl <span class="op">=</span> COMPLEX<span class="op">(</span>el<span class="op">)[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>            Rprintf<span class="op">(</span><span class="st">"[</span><span class="sc">%d</span><span class="st">] '</span><span class="sc">%s</span><span class="st">' </span><span class="sc">%f</span><span class="st"> + </span><span class="sc">%f</span><span class="st">i</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> name<span class="op">,</span> cpl<span class="op">.</span>r<span class="op">,</span> cpl<span class="op">.</span>i<span class="op">);</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> STRSXP<span class="op">:</span></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>            Rprintf<span class="op">(</span><span class="st">"[</span><span class="sc">%d</span><span class="st">] '</span><span class="sc">%s</span><span class="st">' </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> name<span class="op">,</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>                   translateChar<span class="op">(</span>STRING_ELT<span class="op">(</span>el<span class="op">,</span> <span class="dv">0</span><span class="op">)));</span></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>           <span class="cf">break</span><span class="op">;</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>            Rprintf<span class="op">(</span><span class="st">"[</span><span class="sc">%d</span><span class="st">] '</span><span class="sc">%s</span><span class="st">' R type</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> name<span class="op">);</span></span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>       <span class="op">}</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a>    vmaxset<span class="op">(</span>vmax<span class="op">);</span></span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> R_NilValue<span class="op">;</span></span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This can be called by the wrapper function</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>showArgs <span class="ot">&lt;-</span> <span class="cf">function</span>(...) <span class="fu">invisible</span>(<span class="fu">.External</span>(<span class="st">"showArgs"</span>, ...))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that this style of programming is convenient but not necessary, as an alternative style is</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>showArgs1 <span class="ot">&lt;-</span> <span class="cf">function</span>(...) <span class="fu">invisible</span>(<span class="fu">.Call</span>(<span class="st">"showArgs1"</span>, <span class="fu">list</span>(...)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The (very similar) C code is in the scripts.</p>
<p>Additional functions for accessing pairlist components are <code>CAAR</code>, <code>CDAR</code>, <code>CDDR</code>, and <code>CDDDR</code>. These components can be modified with <code>SETCAR</code>, <code>SETCDR</code>, <code>SETCADR</code>, <code>SETCADDR</code>, <code>SETCADDDR</code>, and <code>SETCAD4R</code>.</p>
</section>
<section id="missing-and-special-values" class="level3 subsection" data-number="5.10.3">
<h3 class="subsection anchored" data-number="5.10.3" data-anchor-id="missing-and-special-values"><span class="header-section-number">5.10.3</span> Missing and special values</h3>
<p>One piece of error-checking the <code>.C</code> call does (unless <code>NAOK</code> is true) is to check for missing (<code>NA</code>) and IEEE special values (<code>Inf</code>, <code>-Inf</code> and <code>NaN</code>) and give an error if any are found. With the <code>.Call</code> interface these will be passed to our code. In this example the special values are no problem, as IEC&nbsp;60559 arithmetic will handle them correctly. In the current implementation this is also true of <code>NA</code> as it is a type of <code>NaN</code>, but it is unwise to rely on such details. Thus we will re-write the code to handle <code>NA</code>s using macros defined in <code>R_ext/Arith.h</code> included by <code>R.h</code>.</p>
<p>The code changes are the same in any of the versions of <code>convolve2</code> or <code>convolveE</code>:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> na<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> nb<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>ISNA<span class="op">(</span>xa<span class="op">[</span>i<span class="op">])</span> <span class="op">||</span> ISNA<span class="op">(</span>xb<span class="op">[</span>j<span class="op">])</span> <span class="op">||</span> ISNA<span class="op">(</span>xab<span class="op">[</span>i <span class="op">+</span> j<span class="op">]))</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>            xab<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">=</span> NA_REAL<span class="op">;</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>            xab<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">+=</span> xa<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> xb<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that the <code>ISNA</code> macro, and the similar macros <code>ISNAN</code> (which checks for <code>NaN</code> or <code>NA</code>) and <code>R_FINITE</code> (which is false for <code>NA</code> and all the special values), only apply to numeric values of type <code>double</code>. Missingness of integers, logicals and character strings can be tested by equality to the constants <code>NA_INTEGER</code>, <code>NA_LOGICAL</code> and <code>NA_STRING</code>. These and <code>NA_REAL</code> can be used to set elements of R vectors to <code>NA</code>.</p>
<p>The constants <code>R_NaN</code>, <code>R_PosInf</code> and <code>R_NegInf</code> can be used to set <code>double</code>s to the special values.</p>
</section>
</section>
<section id="evaluating-r-expressions-from-c" class="level2 section" data-number="5.11">
<h2 class="section anchored" data-number="5.11" data-anchor-id="evaluating-r-expressions-from-c"><span class="header-section-number">5.11</span> Evaluating R expressions from C</h2>
<p>The main function we will use is</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>SEXP eval<span class="op">(</span>SEXP expr<span class="op">,</span> SEXP rho<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>the equivalent of the interpreted R code <code>eval(expr, envir = rho)</code> (so <code>rho</code> must be an environment), although we can also make use of <code>findVar</code>, <code>defineVar</code> and <code>findFun</code> (which restricts the search to functions).</p>
<p>To see how this might be applied, here is a simplified internal version of <code>lapply</code> for expressions, used as</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">b =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>), <span class="at">test =</span> <span class="fu">runif</span>(<span class="dv">100</span>))</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.Call</span>(<span class="st">"lapply"</span>, a, <span class="fu">quote</span>(<span class="fu">sum</span>(x)), <span class="fu">new.env</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>with C code</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>SEXP lapply<span class="op">(</span>SEXP list<span class="op">,</span> SEXP expr<span class="op">,</span> SEXP rho<span class="op">)</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> length<span class="op">(</span>list<span class="op">);</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    SEXP ans<span class="op">;</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>isNewList<span class="op">(</span>list<span class="op">))</span> error<span class="op">(</span><span class="st">"'list' must be a list"</span><span class="op">);</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>isEnvironment<span class="op">(</span>rho<span class="op">))</span> error<span class="op">(</span><span class="st">"'rho' should be an environment"</span><span class="op">);</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    ans <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>VECSXP<span class="op">,</span> n<span class="op">));</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>        defineVar<span class="op">(</span>install<span class="op">(</span><span class="st">"x"</span><span class="op">),</span> VECTOR_ELT<span class="op">(</span>list<span class="op">,</span> i<span class="op">),</span> rho<span class="op">);</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>        SET_VECTOR_ELT<span class="op">(</span>ans<span class="op">,</span> i<span class="op">,</span> eval<span class="op">(</span>expr<span class="op">,</span> rho<span class="op">));</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>    setAttrib<span class="op">(</span>ans<span class="op">,</span> R_NamesSymbol<span class="op">,</span> getAttrib<span class="op">(</span>list<span class="op">,</span> R_NamesSymbol<span class="op">));</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It would be closer to <code>lapply</code> if we could pass in a function rather than an expression. One way to do this is <em>via</em> interpreted R code as in the next example, but it is possible (if somewhat obscure) to do this in C code. The following is based on the code in <code>src/main/optimize.c</code>.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>SEXP lapply2<span class="op">(</span>SEXP list<span class="op">,</span> SEXP fn<span class="op">,</span> SEXP rho<span class="op">)</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> length<span class="op">(</span>list<span class="op">);</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    SEXP R_fcall<span class="op">,</span> ans<span class="op">;</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>isNewList<span class="op">(</span>list<span class="op">))</span> error<span class="op">(</span><span class="st">"'list' must be a list"</span><span class="op">);</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>isFunction<span class="op">(</span>fn<span class="op">))</span> error<span class="op">(</span><span class="st">"'fn' must be a function"</span><span class="op">);</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>isEnvironment<span class="op">(</span>rho<span class="op">))</span> error<span class="op">(</span><span class="st">"'rho' should be an environment"</span><span class="op">);</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    R_fcall <span class="op">=</span> PROTECT<span class="op">(</span>lang2<span class="op">(</span>fn<span class="op">,</span> R_NilValue<span class="op">));</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    ans <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>VECSXP<span class="op">,</span> n<span class="op">));</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>        SETCADR<span class="op">(</span>R_fcall<span class="op">,</span> VECTOR_ELT<span class="op">(</span>list<span class="op">,</span> i<span class="op">));</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>        SET_VECTOR_ELT<span class="op">(</span>ans<span class="op">,</span> i<span class="op">,</span> eval<span class="op">(</span>R_fcall<span class="op">,</span> rho<span class="op">));</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>    setAttrib<span class="op">(</span>ans<span class="op">,</span> R_NamesSymbol<span class="op">,</span> getAttrib<span class="op">(</span>list<span class="op">,</span> R_NamesSymbol<span class="op">));</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>used by</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Call</span>(<span class="st">"lapply2"</span>, a, sum, <span class="fu">new.env</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Function <code>lang2</code> creates an executable pairlist of two elements, but this will only be clear to those with a knowledge of a LISP-like language.</p>
<p>As a more comprehensive example of constructing an R call in C code and evaluating, consider the following fragment. Similar code appears in the definition of <code>do_docall</code> in <code>src/main/coerce.c</code>.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>    SEXP s<span class="op">,</span> t<span class="op">;</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> s <span class="op">=</span> PROTECT<span class="op">(</span>allocLang<span class="op">(</span><span class="dv">3</span><span class="op">));</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    SETCAR<span class="op">(</span>t<span class="op">,</span> install<span class="op">(</span><span class="st">"print"</span><span class="op">));</span> t <span class="op">=</span> CDR<span class="op">(</span>t<span class="op">);</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    SETCAR<span class="op">(</span>t<span class="op">,</span>  CAR<span class="op">(</span>a<span class="op">));</span> t <span class="op">=</span> CDR<span class="op">(</span>t<span class="op">);</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    SETCAR<span class="op">(</span>t<span class="op">,</span> ScalarInteger<span class="op">(</span>digits<span class="op">));</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    SET_TAG<span class="op">(</span>t<span class="op">,</span> install<span class="op">(</span><span class="st">"digits"</span><span class="op">));</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    eval<span class="op">(</span>s<span class="op">,</span> env<span class="op">);</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The function <code>allocLang</code> is available as of R 4.4.1; for older versions replace <code>allocLang(3)</code> with</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">LCONS</span>(R_NilValue, <span class="fu">allocList</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>At this point <code>CAR(a)</code> is the R object to be printed, the current attribute. There are three steps: the call is constructed as a pairlist of length 3, the list is filled in, and the expression represented by the pairlist is evaluated.</p>
<p>A pairlist is quite distinct from a generic vector list, the only user-visible form of list in R. A pairlist is a linked list (with <code>CDR(t)</code> computing the next entry), with items (accessed by <code>CAR(t)</code>) and names or tags (set by <code>SET_TAG</code>). In this call there are to be three items, a symbol (pointing to the function to be called) and two argument values, the first unnamed and the second named. Setting the type to <code>LANGSXP</code> makes this a call which can be evaluated.</p>
<p>Customarily, the evaluation environment is passed from the calling R code (see <code>rho</code> above). In special cases it is possible that the C code may need to obtain the current evaluation environment which can be done via <code>R_GetCurrentEnv()</code> function.</p>
<section id="zero-finding" class="level3 subsection" data-number="5.11.1">
<h3 class="subsection anchored" data-number="5.11.1" data-anchor-id="zero-finding"><span class="header-section-number">5.11.1</span> Zero-finding</h3>
<p>In this section we re-work the example of Becker, Chambers &amp; Wilks (1988, pp.~205–10) on finding a zero of a univariate function. The R code and an example are</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>zero <span class="ot">&lt;-</span> <span class="cf">function</span>(f, guesses, <span class="at">tol =</span> <span class="fl">1e-7</span>) {</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    f.check <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>        x <span class="ot">&lt;-</span> <span class="fu">f</span>(x)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(x)) <span class="fu">stop</span>(<span class="st">"Need a numeric result"</span>)</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.double</span>(x)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Call</span>(<span class="st">"zero"</span>, <span class="fu">body</span>(f.check), <span class="fu">as.double</span>(guesses), <span class="fu">as.double</span>(tol),</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">new.env</span>())</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>cube1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) (x<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> (x <span class="sc">-</span> <span class="fl">1.5</span>)</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="fu">zero</span>(cube1, <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where this time we do the coercion and error-checking in the R code. The C code is</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>SEXP mkans<span class="op">(</span><span class="dt">double</span> x<span class="op">)</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// no need for PROTECT() here, as REAL(.) does not allocate:</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    SEXP ans <span class="op">=</span> allocVector<span class="op">(</span>REALSXP<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    REAL<span class="op">(</span>ans<span class="op">)[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> x<span class="op">;</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> feval<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> SEXP f<span class="op">,</span> SEXP rho<span class="op">)</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// a version with (too) much PROTECT()ion .. "better safe than sorry"</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    SEXP symbol<span class="op">,</span> value<span class="op">;</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    PROTECT<span class="op">(</span>symbol <span class="op">=</span> install<span class="op">(</span><span class="st">"x"</span><span class="op">));</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    PROTECT<span class="op">(</span>value <span class="op">=</span> mkans<span class="op">(</span>x<span class="op">));</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    defineVar<span class="op">(</span>symbol<span class="op">,</span> value<span class="op">,</span> rho<span class="op">);</span></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">(</span>REAL<span class="op">(</span>eval<span class="op">(</span>f<span class="op">,</span> rho<span class="op">))[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>SEXP zero<span class="op">(</span>SEXP f<span class="op">,</span> SEXP guesses<span class="op">,</span> SEXP stol<span class="op">,</span> SEXP rho<span class="op">)</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> x0 <span class="op">=</span> REAL<span class="op">(</span>guesses<span class="op">)[</span><span class="dv">0</span><span class="op">],</span> x1 <span class="op">=</span> REAL<span class="op">(</span>guesses<span class="op">)[</span><span class="dv">1</span><span class="op">],</span></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>           tol <span class="op">=</span> REAL<span class="op">(</span>stol<span class="op">)[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> f0<span class="op">,</span> f1<span class="op">,</span> fc<span class="op">,</span> xc<span class="op">;</span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>tol <span class="op">&lt;=</span> <span class="fl">0.0</span><span class="op">)</span> error<span class="op">(</span><span class="st">"non-positive tol value"</span><span class="op">);</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>    f0 <span class="op">=</span> feval<span class="op">(</span>x0<span class="op">,</span> f<span class="op">,</span> rho<span class="op">);</span> f1 <span class="op">=</span> feval<span class="op">(</span>x1<span class="op">,</span> f<span class="op">,</span> rho<span class="op">);</span></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>f0 <span class="op">==</span> <span class="fl">0.0</span><span class="op">)</span> <span class="cf">return</span> mkans<span class="op">(</span>x0<span class="op">);</span></span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>f1 <span class="op">==</span> <span class="fl">0.0</span><span class="op">)</span> <span class="cf">return</span> mkans<span class="op">(</span>x1<span class="op">);</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>f0<span class="op">*</span>f1 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> error<span class="op">(</span><span class="st">"x[0] and x[1] have the same sign"</span><span class="op">);</span></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>        xc <span class="op">=</span> <span class="fl">0.5</span><span class="op">*(</span>x0<span class="op">+</span>x1<span class="op">);</span></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>fabs<span class="op">(</span>x0<span class="op">-</span>x1<span class="op">)</span> <span class="op">&lt;</span> tol<span class="op">)</span> <span class="cf">return</span>  mkans<span class="op">(</span>xc<span class="op">);</span></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>        fc <span class="op">=</span> feval<span class="op">(</span>xc<span class="op">,</span> f<span class="op">,</span> rho<span class="op">);</span></span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>fc <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span>  mkans<span class="op">(</span>xc<span class="op">);</span></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>f0<span class="op">*</span>fc <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>            x0 <span class="op">=</span> xc<span class="op">;</span> f0 <span class="op">=</span> fc<span class="op">;</span></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>            x1 <span class="op">=</span> xc<span class="op">;</span> f1 <span class="op">=</span> fc<span class="op">;</span></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="calculating-numerical-derivatives" class="level3 subsection" data-number="5.11.2">
<h3 class="subsection anchored" data-number="5.11.2" data-anchor-id="calculating-numerical-derivatives"><span class="header-section-number">5.11.2</span> Calculating numerical derivatives</h3>
<p>We will use a longer example (by Saikat DebRoy) to illustrate the use of evaluation and <code>.External</code>. This calculates numerical derivatives, something that could be done as effectively in interpreted R code but may be needed as part of a larger C calculation.</p>
<p>An interpreted R version and an example are</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>numeric.deriv <span class="ot">&lt;-</span> <span class="cf">function</span>(expr, theta, <span class="at">rho=</span><span class="fu">sys.frame</span>(<span class="fu">sys.parent</span>()))</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(.Machine<span class="sc">$</span>double.eps)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    ans <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">substitute</span>(expr), rho)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    grad <span class="ot">&lt;-</span> <span class="fu">matrix</span>(, <span class="fu">length</span>(ans), <span class="fu">length</span>(theta),</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dimnames=</span><span class="fu">list</span>(<span class="cn">NULL</span>, theta))</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(theta)) {</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>        old <span class="ot">&lt;-</span> <span class="fu">get</span>(theta[i], <span class="at">envir=</span>rho)</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>        delta <span class="ot">&lt;-</span> eps <span class="sc">*</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">abs</span>(old))</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assign</span>(theta[i], old<span class="sc">+</span>delta, <span class="at">envir=</span>rho)</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>        ans1 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">substitute</span>(expr), rho)</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assign</span>(theta[i], old, <span class="at">envir=</span>rho)</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>        grad[, i] <span class="ot">&lt;-</span> (ans1 <span class="sc">-</span> ans)<span class="sc">/</span>delta</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(ans, <span class="st">"gradient"</span>) <span class="ot">&lt;-</span> grad</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>    ans</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>omega <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>; x <span class="ot">&lt;-</span> <span class="dv">1</span>; y <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a><span class="fu">numeric.deriv</span>(<span class="fu">sin</span>(omega<span class="sc">*</span>x<span class="sc">*</span>y), <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>expr</code> is an expression, <code>theta</code> a character vector of variable names and <code>rho</code> the environment to be used.</p>
<p>For the compiled version the call from R will be</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.External</span>(<span class="st">"numeric_deriv"</span>, expr, theta, rho)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>with example usage</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.External</span>(<span class="st">"numeric_deriv"</span>, <span class="fu">quote</span>(<span class="fu">sin</span>(omega<span class="sc">*</span>x<span class="sc">*</span>y)),</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>          <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), .GlobalEnv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note the need to quote the expression to stop it being evaluated in the caller.</p>
<p>Here is the complete C code which we will explain section by section.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;float.h&gt;</span><span class="pp"> </span><span class="co">/* for DBL_EPSILON */</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>SEXP numeric_deriv<span class="op">(</span>SEXP args<span class="op">)</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    SEXP theta<span class="op">,</span> expr<span class="op">,</span> rho<span class="op">,</span> ans<span class="op">,</span> ans1<span class="op">,</span> gradient<span class="op">,</span> par<span class="op">,</span> dimnames<span class="op">;</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> tt<span class="op">,</span> xx<span class="op">,</span> delta<span class="op">,</span> eps <span class="op">=</span> sqrt<span class="op">(</span>DBL_EPSILON<span class="op">),</span> <span class="op">*</span>rgr<span class="op">,</span> <span class="op">*</span>rans<span class="op">;</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">,</span> start<span class="op">;</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>    expr <span class="op">=</span> CADR<span class="op">(</span>args<span class="op">);</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>isString<span class="op">(</span>theta <span class="op">=</span> CADDR<span class="op">(</span>args<span class="op">)))</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">"theta should be of type character"</span><span class="op">);</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>isEnvironment<span class="op">(</span>rho <span class="op">=</span> CADDDR<span class="op">(</span>args<span class="op">)))</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">"rho should be an environment"</span><span class="op">);</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>    ans <span class="op">=</span> PROTECT<span class="op">(</span>coerceVector<span class="op">(</span>eval<span class="op">(</span>expr<span class="op">,</span> rho<span class="op">),</span> REALSXP<span class="op">));</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>    gradient <span class="op">=</span> PROTECT<span class="op">(</span>allocMatrix<span class="op">(</span>REALSXP<span class="op">,</span> LENGTH<span class="op">(</span>ans<span class="op">),</span> LENGTH<span class="op">(</span>theta<span class="op">)));</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>    rgr <span class="op">=</span> REAL<span class="op">(</span>gradient<span class="op">);</span> rans <span class="op">=</span> REAL<span class="op">(</span>ans<span class="op">);</span></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> start <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> LENGTH<span class="op">(</span>theta<span class="op">);</span> i<span class="op">++,</span> start <span class="op">+=</span> LENGTH<span class="op">(</span>ans<span class="op">))</span> <span class="op">{</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>        par <span class="op">=</span> PROTECT<span class="op">(</span>findVar<span class="op">(</span>installChar<span class="op">(</span>STRING_ELT<span class="op">(</span>theta<span class="op">,</span> i<span class="op">)),</span> rho<span class="op">));</span></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>        tt <span class="op">=</span> REAL<span class="op">(</span>par<span class="op">)[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>        xx <span class="op">=</span> fabs<span class="op">(</span>tt<span class="op">);</span></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>        delta <span class="op">=</span> <span class="op">(</span>xx <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">?</span> eps <span class="op">:</span> xx<span class="op">*</span>eps<span class="op">;</span></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>        REAL<span class="op">(</span>par<span class="op">)[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+=</span> delta<span class="op">;</span></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>        ans1 <span class="op">=</span> PROTECT<span class="op">(</span>coerceVector<span class="op">(</span>eval<span class="op">(</span>expr<span class="op">,</span> rho<span class="op">),</span> REALSXP<span class="op">));</span></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> LENGTH<span class="op">(</span>ans<span class="op">);</span> j<span class="op">++)</span></span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>            rgr<span class="op">[</span>j <span class="op">+</span> start<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>REAL<span class="op">(</span>ans1<span class="op">)[</span>j<span class="op">]</span> <span class="op">-</span> rans<span class="op">[</span>j<span class="op">])/</span>delta<span class="op">;</span></span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a>        REAL<span class="op">(</span>par<span class="op">)[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> tt<span class="op">;</span></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a>        UNPROTECT<span class="op">(</span><span class="dv">2</span><span class="op">);</span> <span class="co">/* par, ans1 */</span></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>    dimnames <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>VECSXP<span class="op">,</span> <span class="dv">2</span><span class="op">));</span></span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a>    SET_VECTOR_ELT<span class="op">(</span>dimnames<span class="op">,</span> <span class="dv">1</span><span class="op">,</span>  theta<span class="op">);</span></span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a>    dimnamesgets<span class="op">(</span>gradient<span class="op">,</span> dimnames<span class="op">);</span></span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a>    setAttrib<span class="op">(</span>ans<span class="op">,</span> install<span class="op">(</span><span class="st">"gradient"</span><span class="op">),</span> gradient<span class="op">);</span></span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">3</span><span class="op">);</span> <span class="co">/* ans  gradient  dimnames */</span></span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb110-40"><a href="#cb110-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The code to handle the arguments is</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>    expr <span class="ot">=</span> <span class="fu">CADR</span>(args);</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">isString</span>(<span class="at">theta =</span> <span class="fu">CADDR</span>(args)))</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">error</span>(<span class="st">"theta should be of type character"</span>);</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">isEnvironment</span>(<span class="at">rho =</span> <span class="fu">CADDDR</span>(args)))</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">error</span>(<span class="st">"rho should be an environment"</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that we check for correct types of <code>theta</code> and <code>rho</code> but do not check the type of <code>expr</code>. That is because <code>eval</code> can handle many types of R objects other than <code>EXPRSXP</code>. There is no useful coercion we can do, so we stop with an error message if the arguments are not of the correct mode.</p>
<p>The first step in the code is to evaluate the expression in the environment <code>rho</code>, by</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>    ans <span class="ot">=</span> <span class="fu">PROTECT</span>(<span class="fu">coerceVector</span>(<span class="fu">eval</span>(expr, rho), REALSXP));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We then allocate space for the calculated derivative by</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>    gradient <span class="ot">=</span> <span class="fu">PROTECT</span>(<span class="fu">allocMatrix</span>(REALSXP, <span class="fu">LENGTH</span>(ans), <span class="fu">LENGTH</span>(theta)));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The first argument to <code>allocMatrix</code> gives the <code>SEXPTYPE</code> of the matrix: here we want it to be <code>REALSXP</code>. The other two arguments are the numbers of rows and columns. (Note that <code>LENGTH</code> is intended to be used for vectors: <code>length</code> is more generally applicable.)</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(<span class="at">i =</span> <span class="dv">0</span>, <span class="at">start =</span> <span class="dv">0</span>; i <span class="sc">&lt;</span> <span class="fu">LENGTH</span>(theta); i<span class="sc">++</span>, start <span class="sc">+</span><span class="er">=</span> <span class="fu">LENGTH</span>(ans)) {</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>        par <span class="ot">=</span> <span class="fu">PROTECT</span>(<span class="fu">findVar</span>(<span class="fu">installChar</span>(<span class="fu">STRING_ELT</span>(theta, i)), rho));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, we are entering a for loop. We loop through each of the variables. In the <code>for</code> loop, we first create a symbol corresponding to the <code>i</code>-th element of the <code>STRSXP</code> <code>theta</code>. Here, <code>STRING_ELT(theta, i)</code> accesses the <code>i</code>-th element of the <code>STRSXP</code> <code>theta</code>. <code>installChar()</code> installs the element as a name and <code>findVar</code> finds its value.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>        tt <span class="ot">=</span> <span class="fu">REAL</span>(par)[<span class="dv">0</span>];</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>        xx <span class="ot">=</span> <span class="fu">fabs</span>(tt);</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>        delta <span class="ot">=</span> (xx <span class="sc">&lt;</span> <span class="dv">1</span>) ? eps <span class="sc">:</span> xx<span class="sc">*</span>eps;</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">REAL</span>(par)[<span class="dv">0</span>] <span class="sc">+</span><span class="er">=</span> delta;</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>        ans1 <span class="ot">=</span> <span class="fu">PROTECT</span>(<span class="fu">coerceVector</span>(<span class="fu">eval</span>(expr, rho), REALSXP));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We first extract the real value of the parameter, then calculate <code>delta</code>, the increment to be used for approximating the numerical derivative. Then we change the value stored in <code>par</code> (in environment <code>rho</code>) by <code>delta</code> and evaluate <code>expr</code> in environment <code>rho</code> again. Because we are directly dealing with original R memory locations here, R does the evaluation for the changed parameter value.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> LENGTH<span class="op">(</span>ans<span class="op">);</span> j<span class="op">++)</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>            rgr<span class="op">[</span>j <span class="op">+</span> start<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>REAL<span class="op">(</span>ans1<span class="op">)[</span>j<span class="op">]</span> <span class="op">-</span> rans<span class="op">[</span>j<span class="op">])/</span>delta<span class="op">;</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>        REAL<span class="op">(</span>par<span class="op">)[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> tt<span class="op">;</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>        UNPROTECT<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, we compute the <code>i</code>-th column of the gradient matrix. Note how it is accessed: R stores matrices by column (like Fortran).</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>    dimnames <span class="ot">=</span> <span class="fu">PROTECT</span>(<span class="fu">allocVector</span>(VECSXP, <span class="dv">2</span>));</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SET_VECTOR_ELT</span>(dimnames, <span class="dv">1</span>, theta);</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dimnamesgets</span>(gradient, dimnames);</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setAttrib</span>(ans, <span class="fu">install</span>(<span class="st">"gradient"</span>), gradient);</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">UNPROTECT</span>(<span class="dv">3</span>);</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    return ans;</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>First we add column names to the gradient matrix. This is done by allocating a list (a <code>VECSXP</code>) whose first element, the row names, is <code>NULL</code> (the default) and the second element, the column names, is set as <code>theta</code>. This list is then assigned as the attribute having the symbol <code>R_DimNamesSymbol</code>. Finally we set the gradient matrix as the gradient attribute of <code>ans</code>, unprotect the remaining protected locations and return the answer <code>ans</code>.</p>
</section>
</section>
<section id="parsing-r-code-from-c" class="level2 section page-columns page-full" data-number="5.12">
<h2 class="section anchored" data-number="5.12" data-anchor-id="parsing-r-code-from-c"><span class="header-section-number">5.12</span> Parsing R code from C</h2>
<p>Suppose an R extension wants to accept an R expression from the user and evaluate it. The previous section covered evaluation, but the expression will be entered as text and needs to be parsed first. A small part of R’s parse interface is declared in header file <code>R_ext/Parse.h</code><a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn19"><p><sup>19</sup>&nbsp;This is only guaranteed to show the current interface: it is liable to change.</p></div></div><p>An example of the usage can be found in the (example) Windows package <strong>windlgs</strong> included in the R source tree. The essential part is</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Parse.h&gt;</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>SEXP menu_ttest3<span class="op">()</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> cmd<span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    SEXP cmdSexp<span class="op">,</span> cmdexpr<span class="op">,</span> ans <span class="op">=</span> R_NilValue<span class="op">;</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    ParseStatus status<span class="op">;</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>   <span class="op">...</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>done <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>        cmdSexp <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>STRSXP<span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>        SET_STRING_ELT<span class="op">(</span>cmdSexp<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> mkChar<span class="op">(</span>cmd<span class="op">));</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>        cmdexpr <span class="op">=</span> PROTECT<span class="op">(</span>R_ParseVector<span class="op">(</span>cmdSexp<span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>status<span class="op">,</span> R_NilValue<span class="op">));</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>status <span class="op">!=</span> PARSE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>            UNPROTECT<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>            error<span class="op">(</span><span class="st">"invalid call </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> cmd<span class="op">);</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Loop is needed here as EXPSEXP will be of length &gt; 1 */</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> length<span class="op">(</span>cmdexpr<span class="op">);</span> i<span class="op">++)</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>            ans <span class="op">=</span> eval<span class="op">(</span>VECTOR_ELT<span class="op">(</span>cmdexpr<span class="op">,</span> i<span class="op">),</span> R_GlobalEnv<span class="op">);</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>        UNPROTECT<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that a single line of text may give rise to more than one R expression.</p>
<p><code>R_ParseVector</code> is essentially the code used to implement <code>parse(text=)</code> at R level. The first argument is a character vector (corresponding to <code>text</code>) and the second the maximal number of expressions to parse (corresponding to <code>n</code>). The third argument is a pointer to a variable of an enumeration type, and it is normal (as <code>parse</code> does) to regard all values other than <code>PARSE_OK</code> as an error. Other values which might be returned are <code>PARSE_INCOMPLETE</code> (an incomplete expression was found) and <code>PARSE_ERROR</code> (a syntax error), in both cases the value returned being <code>R_NilValue</code>. The fourth argument is a length one character vector to be used as a filename in error messages, a <code>srcfile</code> object or the R <code>NULL</code> object (as in the example above). If a <code>srcfile</code> object was used, a <code>srcref</code> attribute would be attached to the result, containing a list of <code>srcref</code> objects of the same length as the expression, to allow it to be echoed with its original formatting.</p>
<p>Two higher-level alternatives are <code>R_ParseString</code> and <code>R_ParseEvalString</code>:</p>
<p><span class="category">Function:</span><em>SEXP</em> <strong>R_ParseString</strong> <em>(const char *<code>str</code>)</em> <a href="#index-r_parsestring-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>SEXP</em> <strong>R_ParseEvalString</strong> <em>(const char *<code>str</code>, SEXP <code>env</code>)</em> <a href="#index-r_parseevalstring-1" class="copiable-anchor">¶</a></p>
<p>: <code>R_ParseString</code> Parses the code in <code>str</code> and returns the resulting expression. An error is signaled if parsing <code>str</code> produces more than one R expression. <code>R_ParseEvalString</code> first parses <code>str</code>, then evaluates the expression in the environment <code>env</code>, and returns the result.</p>
<p>An example from <code>src/main/objects.c</code>:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>call <span class="ot">=</span> <span class="fu">R_ParseString</span>(<span class="st">"base::nameOfClass(X)"</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="accessing-source-references" class="level3 subsection" data-number="5.12.1">
<h3 class="subsection anchored" data-number="5.12.1" data-anchor-id="accessing-source-references"><span class="header-section-number">5.12.1</span> Accessing source references</h3>
<p>The source references added by the parser are recorded by R’s evaluator as it evaluates code. Two functions make these available to debuggers running C code:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>SEXP R_GetCurrentSrcref<span class="op">(</span><span class="dt">int</span> skip<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This function checks <code>R_Srcref</code> and the current evaluation stack for entries that contain source reference information. The <code>skip</code> argument tells how many source references to skip before returning the <code>SEXP</code> of the <code>srcref</code> object, counting from the top of the stack. If <code>skip &lt; 0</code>, <code>abs(skip)</code> locations are counted up from the bottom of the stack. If too few or no source references are found, <code>NULL</code> is returned.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>SEXP R_GetSrcFilename<span class="op">(</span>SEXP srcref<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This function extracts the filename from the source reference for display, returning a length 1 character vector containing the filename. If no name is found, <code>""</code> is returned.</p>
</section>
</section>
<section id="external-pointers-and-weak-references" class="level2 section" data-number="5.13">
<h2 class="section anchored" data-number="5.13" data-anchor-id="external-pointers-and-weak-references"><span class="header-section-number">5.13</span> External pointers and weak references</h2>
<p>The <code>SEXPTYPE</code>s <code>EXTPTRSXP</code> and <code>WEAKREFSXP</code> can be encountered at R level, but are created in C code.</p>
<p>External pointer <code>SEXP</code>s are intended to handle references to C structures such as ‘handles’, and are used for this purpose in package <a href="https://CRAN.R-project.org/package=RODBC"><strong>RODBC</strong></a> for example. They are unusual in their copying semantics in that when an R object is copied, the external pointer object is not duplicated. (For this reason external pointers should only be used as part of an object with normal semantics, for example an attribute or an element of a list.)</p>
<p>An external pointer is created by</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>SEXP R_MakeExternalPtr<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>p<span class="op">,</span> SEXP tag<span class="op">,</span> SEXP prot<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>p</code> is the pointer (and hence this cannot portably be a function pointer), and <code>tag</code> and <code>prot</code> are references to ordinary R objects which will remain in existence (be protected from garbage collection) for the lifetime of the external pointer object. A useful convention is to use the <code>tag</code> field for some form of type identification and the <code>prot</code> field for protecting the memory that the external pointer represents, if that memory is allocated from the R heap. Both <code>tag</code> and <code>prot</code> can be <code>R_NilValue</code>, and often are.</p>
<p>An alternative way to create an external pointer from a function pointer is</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">*</span> <span class="op">(*</span>R_DL_FUNC<span class="op">)();</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>SEXP R_MakeExternalPtrFn<span class="op">(</span>R_DL_FUNC p<span class="op">,</span> SEXP tag<span class="op">,</span> SEXP prot<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The elements of an external pointer can be accessed and set <em>via</em></p>
<div class="sourceCode" id="cb124"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>R_ExternalPtrAddr<span class="op">(</span>SEXP s<span class="op">);</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>DL_FUNC R_ExternalPtrAddrFn<span class="op">(</span>SEXP s<span class="op">);</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>SEXP R_ExternalPtrTag<span class="op">(</span>SEXP s<span class="op">);</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>SEXP R_ExternalPtrProtected<span class="op">(</span>SEXP s<span class="op">);</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_ClearExternalPtr<span class="op">(</span>SEXP s<span class="op">);</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_SetExternalPtrAddr<span class="op">(</span>SEXP s<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>p<span class="op">);</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_SetExternalPtrTag<span class="op">(</span>SEXP s<span class="op">,</span> SEXP tag<span class="op">);</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_SetExternalPtrProtected<span class="op">(</span>SEXP s<span class="op">,</span> SEXP p<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Clearing a pointer sets its value to the C <code>NULL</code> pointer.</p>
<p>An external pointer object can have a <em>finalizer</em>, a piece of code to be run when the object is garbage collected. This can be R code or C code, and the various interfaces are, respectively.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_RegisterFinalizer<span class="op">(</span>SEXP s<span class="op">,</span> SEXP fun<span class="op">);</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_RegisterFinalizerEx<span class="op">(</span>SEXP s<span class="op">,</span> SEXP fun<span class="op">,</span> Rboolean onexit<span class="op">);</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>R_CFinalizer_t<span class="op">)(</span>SEXP<span class="op">);</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_RegisterCFinalizer<span class="op">(</span>SEXP s<span class="op">,</span> R_CFinalizer_t fun<span class="op">);</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_RegisterCFinalizerEx<span class="op">(</span>SEXP s<span class="op">,</span> R_CFinalizer_t fun<span class="op">,</span> Rboolean onexit<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The R function indicated by <code>fun</code> should be a function of a single argument, the object to be finalized. R does not perform a garbage collection when shutting down, and the <code>onexit</code> argument of the extended forms can be used to ask that the finalizer be run during a normal shutdown of the R session. It is suggested that it is good practice to clear the pointer on finalization.</p>
<p>The only R level function for interacting with external pointers is <code>reg.finalizer</code> which can be used to set a finalizer.</p>
<p>It is probably not a good idea to allow an external pointer to be <code>save</code>d and then reloaded, but if this happens the pointer will be set to the C <code>NULL</code> pointer.</p>
<p>Finalizers can be run at many places in the code base and much of it, including the R interpreter, is not re-entrant. So great care is needed in choosing the code to be run in a finalizer. Finalizers are marked to be run at garbage collection but only run at a somewhat safe point thereafter.</p>
<p>Weak references are used to allow the programmer to maintain information on entities without preventing the garbage collection of the entities once they become unreachable.</p>
<p>A weak reference contains a key and a value. The value is reachable if it is either reachable directly or <em>via</em> weak references with reachable keys. Once a value is determined to be unreachable during garbage collection, the key and value are set to <code>R_NilValue</code> and the finalizer will be run later in the garbage collection.</p>
<p>Weak reference objects are created by one of</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>SEXP R_MakeWeakRef<span class="op">(</span>SEXP key<span class="op">,</span> SEXP val<span class="op">,</span> SEXP fin<span class="op">,</span> Rboolean onexit<span class="op">);</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>SEXP R_MakeWeakRefC<span class="op">(</span>SEXP key<span class="op">,</span> SEXP val<span class="op">,</span> R_CFinalizer_t fin<span class="op">,</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>                    Rboolean onexit<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the R or C finalizer are specified in exactly the same way as for an external pointer object (whose finalization interface is implemented <em>via</em> weak references).</p>
<p>The parts can be accessed <em>via</em></p>
<div class="sourceCode" id="cb127"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>SEXP R_WeakRefKey<span class="op">(</span>SEXP w<span class="op">);</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>SEXP R_WeakRefValue<span class="op">(</span>SEXP w<span class="op">);</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> R_RunWeakRefFinalizer<span class="op">(</span>SEXP w<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A toy example of the use of weak references can be found at <a href="https://homepage.stat.uiowa.edu/~luke/R/references/weakfinex.html" class="uri">https://homepage.stat.uiowa.edu/~luke/R/references/weakfinex.html</a>, but that is used to add finalizers to external pointers which can now be done more directly. At the time of writing no CRAN or Bioconductor package uses weak references.</p>
<section id="an-example" class="level3 subsection" data-number="5.13.1">
<h3 class="subsection anchored" data-number="5.13.1" data-anchor-id="an-example"><span class="header-section-number">5.13.1</span> An example</h3>
<p>Package <a href="https://CRAN.R-project.org/package=RODBC"><strong>RODBC</strong></a> uses external pointers to maintain its <em>channels</em>, connections to databases. There can be several connections open at once, and the status information for each is stored in a C structure (pointed to by <code>thisHandle</code> in the code extract below) that is returned <em>via</em> an external pointer as part of the <strong>RODBC</strong> ‘channel’ (as the <code>"handle_ptr"</code> attribute). The external pointer is created by</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>    SEXP ans<span class="op">,</span> ptr<span class="op">;</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    ans <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>INTSXP<span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    ptr <span class="op">=</span> R_MakeExternalPtr<span class="op">(</span>thisHandle<span class="op">,</span> install<span class="op">(</span><span class="st">"RODBC_channel"</span><span class="op">),</span> R_NilValue<span class="op">);</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    PROTECT<span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    R_RegisterCFinalizerEx<span class="op">(</span>ptr<span class="op">,</span> chanFinalizer<span class="op">,</span> TRUE<span class="op">);</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">...</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* return the channel no */</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    INTEGER<span class="op">(</span>ans<span class="op">)[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> nChannels<span class="op">;</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* and the connection string as an attribute */</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>    setAttrib<span class="op">(</span>ans<span class="op">,</span> install<span class="op">(</span><span class="st">"connection.string"</span><span class="op">),</span> constr<span class="op">);</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>    setAttrib<span class="op">(</span>ans<span class="op">,</span> install<span class="op">(</span><span class="st">"handle_ptr"</span><span class="op">),</span> ptr<span class="op">);</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note the symbol given to identify the usage of the external pointer, and the use of the finalizer. Since the final argument when registering the finalizer is <code>TRUE</code>, the finalizer will be run at the end of the R session (unless it crashes). This is used to close and clean up the connection to the database. The finalizer code is simply</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> chanFinalizer<span class="op">(</span>SEXP ptr<span class="op">)</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>R_ExternalPtrAddr<span class="op">(</span>ptr<span class="op">))</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    inRODBCClose<span class="op">(</span>R_ExternalPtrAddr<span class="op">(</span>ptr<span class="op">));</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    R_ClearExternalPtr<span class="op">(</span>ptr<span class="op">);</span> <span class="co">/* not really needed */</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Clearing the pointer and checking for a <code>NULL</code> pointer avoids any possibility of attempting to close an already-closed channel.</p>
<p>R’s connections provide another example of using external pointers, in that case purely to be able to use a finalizer to close and destroy the connection if it is no longer is use.</p>
</section>
</section>
<section id="vector-accessor-functions" class="level2 section" data-number="5.14">
<h2 class="section anchored" data-number="5.14" data-anchor-id="vector-accessor-functions"><span class="header-section-number">5.14</span> Vector accessor functions</h2>
<p>The vector accessors like <code>REAL</code>, <code>INTEGER</code>, <code>LOGICAL</code>, <code>RAW</code>, <code>COMPLEX</code>, and <code>VECTOR_ELT</code> are <em>functions</em> when used in R extensions. (For efficiency they may be macros or inline functions when used in the R source code, apart from <code>SET_STRING_ELT</code> and <code>SET_VECTOR_ELT</code> which are always functions. When used outside the R source code all vector accessors are functions.) There are also read-only versions that return a <code>const</code> data pointer. For example, the return type of <code>REAL_RO</code> is <code>const double *</code> These accessor functions check that they are being used on an appropriate type of <code>SEXP</code>. For <code>VECSXP</code> and <code>STRSXP</code> objects only read-only pointers are available as modifying their data directly would violate assumptions the memory manager depends on. <code>DATAPTR_RO</code> returns a generic read-only data pointer for any vector object.</p>
<p>Formerly it was possible for packages to obtain internal versions of some accessors by defining <code>USE_RINTERNALS</code> before including <code>Rinternals.h</code>. This is no longer the case. Defining <code>USE_RINTERNALS</code> now has no effect.</p>
<p>Atomic vector elements can also be accessed and set using element-wise operations like <code>INTEGER_ELT</code> and <code>SET_INTEGER_ELT</code>. For objects with a compact representation using these may avoid fully materializing the object. In contrast, obtaining a data pointer will have to fully materialize the object.</p>
</section>
<section id="character-encoding-issues" class="level2 section" data-number="5.15">
<h2 class="section anchored" data-number="5.15" data-anchor-id="character-encoding-issues"><span class="header-section-number">5.15</span> Character encoding issues</h2>
<p><code>CHARSXP</code>s can be marked as coming from a known encoding (Latin-1 or UTF-8). This is mainly intended for human-readable output, and most packages can just treat such <code>CHARSXP</code>s as a whole. However, if they need to be interpreted as characters or output at C level then it would normally be correct to ensure that they are converted to the encoding of the current locale: this can be done by accessing the data in the <code>CHARSXP</code> by <code>translateChar</code> rather than by <code>CHAR</code>. If re-encoding is needed this allocates memory with <code>R_alloc</code> which thus persists to the end of the <code>.Call</code>/<code>.External</code> call unless <code>vmaxset</code> is used (see <a href="The-R-API.html#transient-storage-allocation">Transient storage allocation</a>).</p>
<p>There is a similar function <code>translateCharUTF8</code> which converts to UTF-8: this has the advantage that a faithful translation is almost always possible (whereas only a few languages can be represented in the encoding of the current locale unless that is UTF-8).</p>
<p>Both <code>translateChar</code> and <code>translateCharUTF8</code> will translate any input, using escapes such as <code>&lt;A9&gt;</code> and <code>&lt;U+0093&gt;</code> to represent untranslatable parts of the input.</p>
<p>There is a public interface to the encoding marked on <code>CHARSXPs</code> <em>via</em></p>
<div class="sourceCode" id="cb130"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span>CE_NATIVE<span class="op">,</span> CE_UTF8<span class="op">,</span> CE_LATIN1<span class="op">,</span> CE_BYTES<span class="op">,</span> CE_SYMBOL<span class="op">,</span> CE_ANY<span class="op">}</span> cetype_t<span class="op">;</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>cetype_t getCharCE<span class="op">(</span>SEXP<span class="op">);</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>SEXP mkCharCE<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*,</span> cetype_t<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Only <code>CE_UTF8</code> and <code>CE_LATIN1</code> are marked on <code>CHARSXPs</code> (and so <code>Rf_getCharCE</code> will only return one of the first three), and these should only be used on non-ASCII strings. Value <code>CE_BYTES</code> is used to make <code>CHARSXP</code>s which should be regarded as a set of bytes and not translated. Value <code>CE_SYMBOL</code> is used internally to indicate Adobe Symbol encoding. Value <code>CE_ANY</code> is used to indicate a character string that will not need re-encoding – this is used for character strings known to be in ASCII, and can also be used as an input parameter where the intention is that the string is treated as a series of bytes. (See the comments under <code>mkChar</code> about the length of input allowed.)</p>
<p>Function</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>Rboolean charIsASCII<span class="op">(</span>SEXP<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>can be used to detect whether a given <code>CHARSXP</code> represents an ASCII string. The implementation is equivalent to checking individual characters, but may be faster.</p>
<p>Function</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>Rboolean charIsUTF8<span class="op">(</span>SEXP<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>can be used to detect whether the internal representation of a given <code>CHARSXP</code> accessed via <code>CHAR</code> is UTF-8 (including ASCII). This function is rarely needed and specifically is not needed with <code>translateCharUTF8</code>, because such check is already included. However, when needed, it is better to use it in preference of <code>getCharCE</code>, as it is safer against future changes in the semantics of encoding marks and covers strings internally represented in the native encoding. Note that <code>charIsUTF8()</code> is not equivalent to <code>getCharCE() == CE_UTF8</code>.</p>
<p>Similarly, function</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>Rboolean charIsLatin1<span class="op">(</span>SEXP<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>can be used to detect whether the internal representation of a given <code>CHARSXP</code> accessed via <code>CHAR</code> is latin1 (including ASCII). It is not equivalent to <code>getCharCE() == CE_LATIN1</code>.</p>
<p>Function</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>reEnc<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>x<span class="op">,</span> cetype_t ce_in<span class="op">,</span> cetype_t ce_out<span class="op">,</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">int</span> subst<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>can be used to re-encode character strings: like <code>translateChar</code> it returns a string allocated by <code>R_alloc</code>. This can translate from <code>CE_SYMBOL</code> to <code>CE_UTF8</code>, but not conversely. Argument <code>subst</code> controls what to do with untranslatable characters or invalid input: this is done byte-by-byte with <code>1</code> indicates to output hex of the form <code>&lt;a0&gt;</code>, and <code>2</code> to replace by <code>.</code>, with any other value causing the byte to produce no output.</p>
<p>There is also</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>SEXP mkCharLenCE<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*,</span> <span class="dt">int</span><span class="op">,</span> cetype_t<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to create marked character strings of a given length.</p>
</section>
<section id="writing-compact-representation-friendly-code" class="level2 section" data-number="5.16">
<h2 class="section anchored" data-number="5.16" data-anchor-id="writing-compact-representation-friendly-code"><span class="header-section-number">5.16</span> Writing compact-representation-friendly code</h2>
<p>A simple way to iterate in C over the elements of an atomic vector is to obtain a data pointer and index into that pointer with standard C indexing. However, if the object has a compact representation, then obtaining the data pointer will force the object to be fully materialized. An alternative is to use one of the following functions to query whether a data pointer is available.</p>
<p><span class="category">Function:</span><em>const int *</em> <strong>LOGICAL_OR_NULL</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-logical_or_null-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>const int *</em> <strong>INTEGER_OR_NULL</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-integer_or_null-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>const double *</em> <strong>REAL_OR_NULL</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-real_or_null-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>const Rcomplex *</em> <strong>COMPLEX_OR_NULL</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-complex_or_null-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>const Rbyte *</em> <strong>RAW_OR_NULL</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-raw_or_null-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>const void *</em> <strong>DATAPTR_OR_NULL</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-dataptr_or_null-1" class="copiable-anchor">¶</a></p>
<p>: These functions will return a data pointer if one is available. For vectors with a compact representation these functions will return <code>NULL</code>.</p>
<p>If a data pointer is not available, then code can access elements one at a time with functions like <code>REAL_ELT</code>. This is often sufficient, but in some cases can be inefficient. An alternative is to request data for contiguous blocks of elements. For a good choice of block size this can be nearly as efficient as direct pointer access.</p>
<p><span class="category">Function:</span><em>R_xlen_t</em> <strong>INTEGER_GET_REGION</strong> <em>(SEXP <code>sx</code>, R_xlen_t <code>i</code>, R_xlen_t <code>n</code>, int *<code>buf</code>)</em> <a href="#index-integer_get_region-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>R_xlen_t</em> <strong>LOGICAL_GET_REGION</strong> <em>(SEXP <code>sx</code>, R_xlen_t <code>i</code>, R_xlen_t <code>n</code>, int *<code>buf</code>)</em> <a href="#index-logical_get_region-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>R_xlen_t</em> <strong>REAL_GET_REGION</strong> <em>(SEXP <code>sx</code>, R_xlen_t <code>i</code>, R_xlen_t <code>n</code>, double *<code>buf</code>)</em> <a href="#index-real_get_region-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>R_xlen_t</em> <strong>COMPLEX_GET_REGION</strong> <em>(SEXP <code>sx</code>, R_xlen_t <code>i</code>, R_xlen_t <code>n</code>, Rcomplex *<code>buf</code>)</em> <a href="#index-complex_get_region-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>R_xlen_t</em> <strong>RAW_GET_REGION</strong> <em>(SEXP <code>sx</code>, R_xlen_t <code>i</code>, R_xlen_t <code>n</code>, Rbyte *<code>buf</code>)</em> <a href="#index-raw_get_region-1" class="copiable-anchor">¶</a></p>
<p>: These functions copy a contiguous set of up to <code>n</code> elements starting with element <code>i</code> into a buffer <code>buf</code>. The return value is the actual number of elements copied, which may be less than <code>n</code>.</p>
<p>Macros in <code>R_ext/Itermacros.h</code> may help in implementing an iteration strategy.</p>
<p>Some functions useful in implementing new alternate representation classes, beyond those defined in <code>R_ext/Altrep.h</code>, include <code>ALTREP</code>, <code>ALTREP_CLASS</code>, <code>R_altrep_data1</code>, <code>R_set_altrep_data1</code>, <code>R_altrep_data2</code>, and <code>R_set_altrep_data2</code>.</p>
<p>For some objects it may be possible to very efficiently determine whether the object is sorted or contains no <code>NA</code> values. These functions can be used to query this information:</p>
<p><span class="category">Function:</span><em>int</em> <strong>LOGICAL_NO_NA</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-logical_no_na-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>int</em> <strong>INTEGER_NO_NA</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-integer_no_na-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>int</em> <strong>REAL_NO_NA</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-real_no_na-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>int</em> <strong>STRING_NO_NA</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-string_no_na-1" class="copiable-anchor">¶</a></p>
<p>: A <code>TRUE</code> result means it is known that there are no <code>NA</code> values. A <code>FALSE</code> result means it is not known whether there are any <code>NA</code> values.</p>
<!-- -->
<p><span class="category">Function:</span><em>int</em> <strong>INTEGER_IS_SORTED</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-integer_is_sorted-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>int</em> <strong>REAL_IS_SORTED</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-real_is_sorted-1" class="copiable-anchor">¶</a><br>
<span class="category">Function:</span><em>int</em> <strong>STRING_IS_SORTED</strong> <em>(SEXP <code>x</code>)</em> <a href="#index-string_is_sorted-1" class="copiable-anchor">¶</a></p>
<p>: These functions return one of <code>SORTED_DECR</code>, <code>SORTED_INCR</code>, or <code>UNKNOWN_SORTEDNESS</code>.</p>
<p>Footnotes</p>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Debugging.html" class="pagination-link" aria-label="Debugging">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Debugging</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./The-R-API.html" class="pagination-link" aria-label="The R API: entry points for C code">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The R API: entry points for C code</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>A re-styled version of the original R manuals at <a href="https://cran.r-project.org/manuals.html" class="uri">https://cran.r-project.org/manuals.html</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built using <a href="https://quarto.org">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>